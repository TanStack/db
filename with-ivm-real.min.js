var Ke=class extends Map{constructor(r,n){super(n);this.defaultValue=r}get(r){return this.has(r)?super.get(r):this.defaultValue()}update(r,n){let i=this.get(r),s=n(i);return this.set(r,s),s}},It=3e4;function Me(t,e){if(e.length<=It)t.push(...e);else for(let r=0;r<e.length;r+=It){let n=e.slice(r,r+It);t.push(...n)}}function pr(t,e,r){let n=0,i=t.length;for(;n<i;){let s=Math.floor((n+i)/2),o=r(t[s],e);if(o<0)n=s+1;else if(o>0)i=s;else return s}return n}var bt=class{constructor(){this.objectIds=new WeakMap;this.nextId=0}getId(e){if(typeof e!="object"||e===null){let r=String(e),n=0;for(let i=0;i<r.length;i++){let s=r.charCodeAt(i);n=(n<<5)-n+s,n=n&n}return n}return this.objectIds.has(e)||this.objectIds.set(e,this.nextId++),this.objectIds.get(e)}getStringId(e){return e===null?"null":e===void 0?"undefined":typeof e!="object"?`str_${String(e)}`:`obj_${this.getId(e)}`}},re=new bt;function fr(t,e){let[r,n]=t,[i,s]=e,o=[...Pe(r,Math.min(n,i)),...Pe(Math.max(r,s),n)],a=[...Pe(i,Math.min(s,r)),...Pe(Math.max(i,n),s)];return{onlyInA:o,onlyInB:a}}function Pe(t,e){let r=[];for(let n=t;n<e;n++)r.push(n);return r}var hn=K(),mn=K(),gn=K(),Tn=K(),yn=K();function K(){return Math.random()*(2**31-1)>>>0}var dr=new ArrayBuffer(8),xn=new DataView(dr),J=new Uint8Array(dr),ne=class{constructor(){this.hash=hn;this.length=0;this.carry=0;this.carryBytes=0}_mix(e){e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e,this.hash=this.hash<<13|this.hash>>>19,this.hash=Math.imul(this.hash,5)+3864292196}_writeByte(e){this.carry|=(e&255)<<8*this.carryBytes,this.carryBytes++,this.length++,this.carryBytes===4&&(this._mix(this.carry>>>0),this.carry=0,this.carryBytes=0)}update(e){switch(typeof e){case"symbol":{this.update(yn);let r=e.description;if(!r)return;for(let n=0;n<r.length;n++){let i=r.charCodeAt(n);this._writeByte(i&255),this._writeByte(i>>>8&255)}return}case"string":this.update(mn);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);this._writeByte(n&255),this._writeByte(n>>>8&255)}return;case"number":xn.setFloat64(0,e,!0),this._writeByte(J[0]),this._writeByte(J[1]),this._writeByte(J[2]),this._writeByte(J[3]),this._writeByte(J[4]),this._writeByte(J[5]),this._writeByte(J[6]),this._writeByte(J[7]);return;case"bigint":{let r=e;for(r<0n?(r=-r,this.update(Tn)):this.update(gn);r>0n;)this._writeByte(Number(r&0xffn)),r>>=8n;e===0n&&this._writeByte(0);return}default:throw new TypeError(`Unsupported input type: ${typeof e}`)}}digest(){if(this.carryBytes>0){let e=this.carry>>>0;e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e}return this.hash^=this.length,this.hash^=this.hash>>>16,this.hash=Math.imul(this.hash,2246822507),this.hash^=this.hash>>>13,this.hash=Math.imul(this.hash,3266489909),this.hash^=this.hash>>>16,this.hash>>>0}};var On=K(),wn=K(),Vn=K(),vn=K(),Sn=K(),In=K(),bn=K(),Pn=K(),Kn=K(),Mn=K(),_n=K(),ge=new WeakMap;function S(t){let e=new ne;return mr(e,t),e.digest()}function An(t){let e=ge.get(t);if(e!==void 0)return e;let r;if(t instanceof Date)r=Rn(t);else{let n=t,i=Pn;if(t instanceof Array&&(i=Kn),t instanceof Map&&(i=Mn,n=[...t.entries()]),t instanceof Set&&(i=_n,n=[...t.entries()]),typeof Buffer<"u"&&t instanceof Buffer||t instanceof Uint8Array||t instanceof File)return gr(t);r=kn(n,i)}return ge.set(t,r),r}function Rn(t){let e=new ne;return e.update(bn),e.update(t.getTime()),e.digest()}function kn(t,e){let r=new ne;r.update(e);let n=Object.keys(t);n.sort(En);for(let i of n)r.update(Sn),r.update(i),mr(r,t[i]);return r.digest()}function mr(t,e){if(e===null){t.update(Vn);return}switch(typeof e){case"undefined":t.update(vn);return;case"boolean":t.update(e?On:wn);return;case"number":t.update(isNaN(e)?NaN:e===0?0:e);return;case"bigint":case"string":case"symbol":t.update(e);return;case"object":t.update(Bn(e));return;case"function":t.update(gr(e));return;default:console.warn(`Ignored input during hashing because it is of type ${typeof e} which is not supported`)}}function Bn(t){let e=ge.get(t);return e===void 0&&(e=An(t)),e}var hr=1;function gr(t){let e=ge.get(t);return e===void 0&&(e=hr^In,hr++,ge.set(t,e)),e}function En(t,e){return t.localeCompare(e)}var I=class t{#e;constructor(e=[]){this.#e=e}toString(e=!1){return`MultiSet(${JSON.stringify(this.#e,null,e?2:void 0)})`}toJSON(){return JSON.stringify(Array.from(this.getInner()))}static fromJSON(e){return new t(JSON.parse(e))}map(e){return new t(this.#e.map(([r,n])=>[e(r),n]))}filter(e){return new t(this.#e.filter(([r,n])=>e(r)))}negate(){return new t(this.#e.map(([e,r])=>[e,-r]))}concat(e){let r=[];return Me(r,this.#e),Me(r,e.getInner()),new t(r)}consolidate(){if(this.#e.length>0){let e=this.#e[0]?.[0];if(Array.isArray(e)&&e.length===2)return this.#t()}return this.#r()}#t(){let e=new Map,r=new Map,n=s=>{if(s.length!==2)throw new Error("Expected tuple of length 2");let[o,a]=s;return`${re.getStringId(o)}|${re.getStringId(a)}`};for(let[s,o]of this.#e){if(!Array.isArray(s)||s.length!==2)return this.#r();let[a,u]=s;if(typeof a!="string"&&typeof a!="number")return this.#r();let c;Array.isArray(u)&&u.length===2?c=n(u):c=re.getStringId(u);let p=a+"|"+c;e.set(p,(e.get(p)||0)+o),r.has(p)||r.set(p,s)}let i=[];for(let[s,o]of e)o!==0&&i.push([r.get(s),o]);return new t(i)}#r(){let e=new Ke(()=>0),r=new Map,n=!1,i=!1,s=!1;for(let[u,c]of this.#e)if(typeof u=="string")n=!0;else if(typeof u=="number")i=!0;else{s=!0;break}let o=s||n&&i;for(let[u,c]of this.#e){let p=o?S(u):u;o&&!r.has(p)&&r.set(p,u),e.update(p,l=>l+c)}let a=[];for(let[u,c]of e.entries())if(c!==0){let p=o?r.get(u):u;a.push([p,c])}return new t(a)}extend(e){let r=e instanceof t?e.getInner():e;Me(this.#e,r)}add(e,r){r!==0&&this.#e.push([e,r])}getInner(){return this.#e}};var Pt=class{#e;constructor(e){this.#e=e}drain(){let e=[...this.#e].reverse();return this.#e.length=0,e}isEmpty(){return this.#e.length===0}},b=class{#e=[];sendData(e){e instanceof I||(e=new I(e));for(let r of this.#e)r.unshift(e)}newReader(){let e=[];return this.#e.push(e),new Pt(e)}},_e=class{constructor(e,r,n){this.id=e;this.inputs=r,this.output=n}hasPendingWork(){return this.inputs.some(e=>!e.isEmpty())}},D=class extends _e{constructor(r,n,i){super(r,[n],i);this.id=r}inputMessages(){return this.inputs[0].drain()}},Ae=class extends _e{constructor(r,n,i,s){super(r,[n,i],s);this.id=r}inputAMessages(){return this.inputs[0].drain()}inputBMessages(){return this.inputs[1].drain()}},G=class extends D{run(){for(let e of this.inputMessages())this.output.sendData(this.inner(e))}};var P=class{#e;#t;constructor(e,r){this.#e=e,this.#t=r}connectReader(){return this.#t.newReader()}get writer(){return this.#t}get graph(){return this.#e}pipe(...e){return e.reduce((r,n)=>n(r),this)}};var Kt=class extends G{#e;constructor(e,r,n,i){super(e,r,n),this.#e=i}inner(e){return e.map(this.#e)}};function v(t){return e=>{let r=new P(e.graph,new b),n=new Kt(e.graph.getNextOperatorId(),e.connectReader(),r.writer,t);return e.graph.addOperator(n),r}}var Mt=class extends G{#e;constructor(e,r,n,i){super(e,r,n),this.#e=i}inner(e){return this.#e(e),e}};function Tr(t){return e=>{let r=new P(e.graph,new b),n=new Mt(e.graph.getNextOperatorId(),e.connectReader(),r.writer,t);return e.graph.addOperator(n),r}}var _t=class extends G{#e;constructor(e,r,n,i){super(e,r,n),this.#e=i}inner(e){return e.filter(this.#e)}};function F(t){return e=>{let r=new P(e.graph,new b),n=new _t(e.graph.getNextOperatorId(),e.connectReader(),r.writer,t);return e.graph.addOperator(n),r}}var At=class extends D{run(){let e=this.inputMessages();if(e.length===0)return;let r=new I;for(let i of e)r.extend(i);let n=r.consolidate();n.getInner().length>0&&this.output.sendData(n)}};function yr(){return t=>{let e=new P(t.graph,new b),r=new At(t.graph.getNextOperatorId(),t.connectReader(),e.writer);return t.graph.addOperator(r),e}}var Te=Symbol("NO_PREFIX"),ke=class extends Map{addValue(e,r){if(r===0)return this.size===0;let n=ye(e),i=this.get(n);if(Re(i)){let[s,o]=i;if(ye(s)!==n)throw new Error("Mismatching prefixes, this should never happen");if(s===e||S(s)===S(e)){let u=o+r;u===0?this.delete(n):this.set(n,[e,u])}else{let u=new ee;u.set(S(s),i),u.set(S(e),[e,r]),this.set(n,u)}}else i===void 0?this.set(n,[e,r]):i.addValue(e,r)&&this.delete(n);return this.size===0}},ee=class extends Map{addValue(e,r){if(r===0)return this.size===0;let n=S(e),i=this.get(n);if(i){let[,s]=i,o=s+r;o===0?this.delete(n):this.set(n,[e,o])}else this.set(n,[e,r]);return this.size===0}},W=class t{#e;#t=new Map;constructor(){this.#e=new Map}static fromMultiSets(e){let r=new t;for(let n of e)for(let[i,s]of n.getInner()){let[o,a]=i;r.addValue(o,[a,s])}return r}toString(e=!1){return`Index(${JSON.stringify([...this.entries()],void 0,e?2:void 0)})`}get size(){return this.#e.size}has(e){return this.#e.has(e)}hasPresence(e){return(this.#t.get(e)||0)!==0}getConsolidatedMultiplicity(e){return this.#t.get(e)||0}getPresenceKeys(){return this.#t.keys()}get(e){return[...this.getIterator(e)]}*getIterator(e){let r=this.#e.get(e);if(Re(r))yield r;else{if(r===void 0)return;if(r instanceof ee)for(let n of r.values())yield n;else for(let n of r.values())if(Re(n))yield n;else for(let i of n.values())yield i}}*entries(){for(let e of this.#e.keys())for(let r of this.getIterator(e))yield[e,r]}*entriesIterators(){for(let e of this.#e.keys())yield[e,this.getIterator(e)]}addValue(e,r){let[n,i]=r;if(i===0)return;let s=(this.#t.get(e)||0)+i;s===0?this.#t.delete(e):this.#t.set(e,s);let o=this.#e.get(e);if(o===void 0){this.#e.set(e,r);return}if(Re(o)){this.#r(e,o,n,i);return}if(o instanceof ee){let a=ye(n);if(a!==Te){let u=new ke;u.set(Te,o),u.set(a,r),this.#e.set(e,u)}else o.addValue(n,i)&&this.#e.delete(e)}else o.addValue(n,i)&&this.#e.delete(e)}#r(e,r,n,i){let[s,o]=r;if(s===n){let c=o+i;c===0?this.#e.delete(e):this.#e.set(e,[n,c]);return}let a=ye(n),u=ye(s);if(u===a&&(s===n||S(s)===S(n))){let c=o+i;c===0?this.#e.delete(e):this.#e.set(e,[n,c]);return}if(u===Te&&a===Te){let c=new ee;c.set(S(s),r),c.set(S(n),[n,i]),this.#e.set(e,c)}else{let c=new ke;if(u===a){let p=new ee;p.set(S(s),r),p.set(S(n),[n,i]),c.set(u,p)}else c.set(u,r),c.set(a,[n,i]);this.#e.set(e,c)}}append(e){for(let[r,n]of e.entries())this.addValue(r,n)}join(e){let r=[];if(this.size<=e.size)for(let[n,i]of this.entriesIterators()){if(!e.has(n))continue;let s=e.get(n);for(let[o,a]of i)for(let[u,c]of s)a!==0&&c!==0&&r.push([[n,[o,u]],a*c])}else for(let[n,i]of e.entriesIterators()){if(!this.has(n))continue;let s=this.get(n);for(let[o,a]of i)for(let[u,c]of s)c!==0&&a!==0&&r.push([[n,[u,o]],c*a])}return new I(r)}};function ye(t){return Array.isArray(t)&&(typeof t[0]=="string"||typeof t[0]=="number"||typeof t[0]=="bigint")?t[0]:Te}function Re(t){return Array.isArray(t)}var Rt=class extends Ae{#e=new W;#t=new W;#r;constructor(e,r,n,i,s="inner"){super(e,r,n,i),this.#r=s}run(){let e=W.fromMultiSets(this.inputAMessages()),r=W.fromMultiSets(this.inputBMessages());if(e.size===0&&r.size===0)return;let n=new I;this.#r!=="anti"&&this.emitInnerResults(e,r,n),(this.#r==="left"||this.#r==="full"||this.#r==="anti")&&this.emitLeftOuterResults(e,r,n),(this.#r==="right"||this.#r==="full")&&this.emitRightOuterResults(e,r,n),this.#e.append(e),this.#t.append(r),n.getInner().length>0&&this.output.sendData(n)}emitInnerResults(e,r,n){e.size>0&&n.extend(e.join(this.#t)),r.size>0&&n.extend(this.#e.join(r)),e.size>0&&r.size>0&&n.extend(e.join(r))}emitLeftOuterResults(e,r,n){if(e.size>0)for(let[i,s]of e.entriesIterators()){let o=this.#t.getConsolidatedMultiplicity(i),a=r.getConsolidatedMultiplicity(i);if(o+a===0)for(let[c,p]of s)p!==0&&n.add([i,[c,null]],p)}if(r.size>0)for(let i of r.getPresenceKeys()){let s=this.#t.getConsolidatedMultiplicity(i),o=r.getConsolidatedMultiplicity(i);if(o===0)continue;let a=s+o;if(s===0==(a===0))continue;let u=s===0;for(let[c,p]of this.#e.getIterator(i))p!==0&&n.add([i,[c,null]],u?-p:+p)}}emitRightOuterResults(e,r,n){if(r.size>0)for(let[i,s]of r.entriesIterators()){let o=this.#e.getConsolidatedMultiplicity(i),a=e.getConsolidatedMultiplicity(i);if(o+a===0)for(let[c,p]of s)p!==0&&n.add([i,[null,c]],p)}if(e.size>0)for(let i of e.getPresenceKeys()){let s=this.#e.getConsolidatedMultiplicity(i),o=e.getConsolidatedMultiplicity(i);if(o===0)continue;let a=s+o;if(s===0==(a===0))continue;let u=s===0;for(let[c,p]of this.#t.getIterator(i))p!==0&&n.add([i,[null,c]],u?-p:+p)}}};function xr(t,e="inner"){return r=>{if(r.graph!==t.graph)throw new Error("Cannot join streams from different graphs");let n=new P(r.graph,new b),i=new Rt(r.graph.getNextOperatorId(),r.connectReader(),t.connectReader(),n.writer,e);return r.graph.addOperator(i),n}}var kt=class extends D{#e=new W;#t=new W;#r;constructor(e,r,n,i){super(e,r,n),this.#r=i}run(){let e=new Set;for(let n of this.inputMessages())for(let[i,s]of n.getInner()){let[o,a]=i;this.#e.addValue(o,[a,s]),e.add(o)}let r=[];for(let n of e){let i=this.#e.get(n),s=this.#t.get(n),o=this.#r(i),a=new Map,u=new Map;for(let[c,p]of o){let l=a.get(c)??0;a.set(c,l+p)}for(let[c,p]of s){let l=u.get(c)??0;u.set(c,l+p)}for(let[c,p]of u)a.has(c)||(r.push([[n,c],-p]),this.#t.addValue(n,[c,-p]));for(let[c,p]of a)u.has(c)||p!==0&&(r.push([[n,c],p]),this.#t.addValue(n,[c,p]));for(let[c,p]of a){let l=u.get(c);if(l!==void 0){let f=p-l;f!==0&&(r.push([[n,c],f]),this.#t.addValue(n,[c,f]))}}}r.length>0&&this.output.sendData(new I(r))}};function Or(t){return e=>{let r=new P(e.graph,new b),n=new kt(e.graph.getNextOperatorId(),e.connectReader(),r.writer,t);return e.graph.addOperator(n),r}}var Bt=class extends D{#e;#t;constructor(e,r,n,i=s=>s){super(e,r,n),this.#e=i,this.#t=new Map}run(){let e=new Map;for(let n of this.inputMessages())for(let[i,s]of n.getInner()){let o=S(this.#e(i)),u=(e.get(o)?.[0]??this.#t.get(o)??0)+s;e.set(o,[u,i])}let r=[];for(let[n,[i,s]]of e.entries()){let o=this.#t.get(n)??0;i===0?this.#t.delete(n):this.#t.set(n,i),o<=0&&i>0?r.push([[S(this.#e(s)),s[1]],1]):o>0&&i<=0&&r.push([[S(this.#e(s)),s[1]],-1])}r.length>0&&this.output.sendData(new I(r))}};function wr(t=e=>e){return e=>{let r=new P(e.graph,new b),n=new Bt(e.graph.getNextOperatorId(),e.connectReader(),r.writer,t);return e.graph.addOperator(n),r}}var jn="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function ie(t,e,r){let n=r[0];if(e!=null&&t>=e)throw new Error(t+" >= "+e);if(t.slice(-1)===n||e&&e.slice(-1)===n)throw new Error("trailing zero");if(e){let o=0;for(;(t[o]||n)===e[o];)o++;if(o>0)return e.slice(0,o)+ie(t.slice(o),e.slice(o),r)}let i=t?r.indexOf(t[0]):0,s=e!=null?r.indexOf(e[0]):r.length;if(s-i>1){let o=Math.round(.5*(i+s));return r[o]}else return e&&e.length>1?e.slice(0,1):r[i]+ie(t.slice(1),null,r)}function Sr(t){if(t.length!==Ir(t[0]))throw new Error("invalid integer part of order key: "+t)}function Ir(t){if(t>="a"&&t<="z")return t.charCodeAt(0)-97+2;if(t>="A"&&t<="Z")return 90-t.charCodeAt(0)+2;throw new Error("invalid order key head: "+t)}function xe(t){let e=Ir(t[0]);if(e>t.length)throw new Error("invalid order key: "+t);return t.slice(0,e)}function Vr(t,e){if(t==="A"+e[0].repeat(26))throw new Error("invalid order key: "+t);let r=xe(t);if(t.slice(r.length).slice(-1)===e[0])throw new Error("invalid order key: "+t)}function vr(t,e){Sr(t);let[r,...n]=t.split(""),i=!0;for(let s=n.length-1;i&&s>=0;s--){let o=e.indexOf(n[s])+1;o===e.length?n[s]=e[0]:(n[s]=e[o],i=!1)}if(i){if(r==="Z")return"a"+e[0];if(r==="z")return null;let s=String.fromCharCode(r.charCodeAt(0)+1);return s>"a"?n.push(e[0]):n.pop(),s+n.join("")}else return r+n.join("")}function zn(t,e){Sr(t);let[r,...n]=t.split(""),i=!0;for(let s=n.length-1;i&&s>=0;s--){let o=e.indexOf(n[s])-1;o===-1?n[s]=e.slice(-1):(n[s]=e[o],i=!1)}if(i){if(r==="a")return"Z"+e.slice(-1);if(r==="A")return null;let s=String.fromCharCode(r.charCodeAt(0)-1);return s<"Z"?n.push(e.slice(-1)):n.pop(),s+n.join("")}else return r+n.join("")}function br(t,e,r=jn){if(t!=null&&Vr(t,r),e!=null&&Vr(e,r),t!=null&&e!=null&&t>=e)throw new Error(t+" >= "+e);if(t==null){if(e==null)return"a"+r[0];let u=xe(e),c=e.slice(u.length);if(u==="A"+r[0].repeat(26))return u+ie("",c,r);if(u<e)return u;let p=zn(u,r);if(p==null)throw new Error("cannot decrement any more");return p}if(e==null){let u=xe(t),c=t.slice(u.length),p=vr(u,r);return p??u+ie(c,null,r)}let n=xe(t),i=t.slice(n.length),s=xe(e),o=e.slice(s.length);if(n===s)return n+ie(i,o,r);let a=vr(n,r);if(a==null)throw new Error("cannot increment any more");return a<e?a:n+ie(i,null,r)}var Ee=class{#e=[];#t;#r;#n;constructor(e,r,n){this.#r=e,this.#n=e+r,this.#t=n}get size(){let e=this.#r,r=this.#n-this.#r,n=this.#e.length-e;return Math.max(0,Math.min(r,n))}move({offset:e,limit:r}){let n=this.#r,i=this.#n-this.#r,s=[this.#r,this.#n===1/0?this.#r+this.size:this.#n];this.#r=e??n,this.#n=this.#r+(r??i);let o=[this.#r,this.#n===1/0?Math.max(this.#r+this.size,s[1]):this.#n],{onlyInA:a,onlyInB:u}=fr(s,o),c=[];u.forEach(l=>{let f=this.#e[l];f&&c.push(f)});let p=[];return a.forEach(l=>{let f=this.#e[l];f&&p.push(f)}),{moveIns:c,moveOuts:p,changes:a.length+u.length>0}}insert(e){let r={moveIn:null,moveOut:null},n=this.#i(e),i=n===0?null:ze(this.#e[n-1]),s=n===this.#e.length?null:ze(this.#e[n]),o=br(i,s),a=Pr(e,o);if(this.#e.splice(n,0,a),n<this.#n){let u=Math.max(n,this.#r);u<this.#e.length&&(r.moveIn=this.#e[u],this.#n<this.#e.length&&(r.moveOut=this.#e[this.#n]))}return r}delete(e){let r={moveIn:null,moveOut:null},n=this.#i(e),[i]=this.#e.splice(n,1);if(n<this.#n){if(r.moveOut=i,n<this.#r){let o=this.#r-1;o<this.#e.length?r.moveOut=this.#e[o]:r.moveOut=null}let s=this.#n-1;s<this.#e.length&&(r.moveIn=this.#e[s])}return r}#i(e){return pr(this.#e,Pr(e,""),(r,n)=>this.#t(je(r),je(n)))}},Et=class extends D{#e=new Map;#t;constructor(e,r,n,i,s){super(e,r,n);let o=s.limit??1/0,a=s.offset??0,u=(c,p)=>{let l=i(Be(c),Be(p));if(l!==0)return l;let f=_r(c),d=_r(p);return f-d};this.#t=this.createTopK(a,o,u),s.setSizeCallback?.(()=>this.#t.size),s.setWindowFn?.(this.moveTopK.bind(this))}createTopK(e,r,n){return new Ee(e,r,n)}moveTopK({offset:e,limit:r}){if(!(this.#t instanceof Ee))throw new Error("Cannot move B+-tree implementation of TopK with fractional index");let n=[],i=this.#t.move({offset:e,limit:r});i.moveIns.forEach(s=>this.handleMoveIn(s,n)),i.moveOuts.forEach(s=>this.handleMoveOut(s,n)),i.changes&&this.output.sendData(new I(n))}run(){let e=[];for(let r of this.inputMessages())for(let[n,i]of r.getInner()){let[s,o]=n;this.processElement(s,o,i,e)}e.length>0&&this.output.sendData(new I(e))}processElement(e,r,n,i){let{oldMultiplicity:s,newMultiplicity:o}=this.addKey(e,n),a={moveIn:null,moveOut:null};if(s<=0&&o>0){let u=Kr(e,r);a=this.#t.insert(u)}else if(s>0&&o<=0){let u=Kr(e,r);a=this.#t.delete(u)}this.handleMoveIn(a.moveIn,i),this.handleMoveOut(a.moveOut,i)}handleMoveIn(e,r){if(e){let n=ze(e),i=je(e),s=Mr(i),o=Be(i);r.push([[s,[o,n]],1])}}handleMoveOut(e,r){if(e){let n=ze(e),i=je(e),s=Mr(i),o=Be(i);r.push([[s,[o,n]],-1])}}getMultiplicity(e){return this.#e.get(e)??0}addKey(e,r){let n=this.getMultiplicity(e),i=n+r;return i===0?this.#e.delete(e):this.#e.set(e,i),{oldMultiplicity:n,newMultiplicity:i}}};function Ar(t,e){let r=e||{};return n=>{let i=new P(n.graph,new b),s=new Et(n.graph.getNextOperatorId(),n.connectReader(),i.writer,t,r);return n.graph.addOperator(s),i}}function Pr(t,e){return[t,e]}function je(t){return t[0]}function ze(t){return t[1]}function Kr(t,e){return[t,e,re.getId(t)]}function Mr(t){return t[0]}function Be(t){return t[1]}function _r(t){return t[2]}function Dn(t,e,r){let n=r?.limit??1/0,i=r?.offset??0,s=r?.setSizeCallback,o=r?.setWindowFn,a=r?.comparator??((u,c)=>u===c?0:u<c?-1:1);return u=>u.pipe(t((c,p)=>a(e(c),e(p)),{limit:n,offset:i,setSizeCallback:s,setWindowFn:o}),yr())}function Rr(t,e){return Dn(Ar,t,e)}function kr(t){return"pipe"in t}function De(t,e={}){let r=Object.fromEntries(Object.entries(e).filter(([i,s])=>!kr(s))),n=Object.fromEntries(Object.entries(e).filter(([i,s])=>kr(s)));return i=>{let s="__original_key__";return i.pipe(v(u=>{let c=t(u),p=JSON.stringify(c),l={};l[s]=c;for(let[f,d]of Object.entries(r))l[f]=d.preMap(u);return[p,l]})).pipe(Or(u=>{let c=0;for(let[f,d]of u)c+=d;if(c<=0)return[];let p={},l=u[0]?.[0]?.[s];p[s]=l;for(let[f,d]of Object.entries(r)){let h=u.map(([m,T])=>[m[f],T]);p[f]=d.reduce(h)}return[[p,1]]})).pipe(v(([u,c])=>{let p=c[s],l={};Object.assign(l,p);for(let[f,d]of Object.entries(r))d.postMap?l[f]=d.postMap(c[f]):l[f]=c[f];return[u,l]}))}}function Fn(t=e=>e){return{preMap:e=>t(e),reduce:e=>{let r=0;for(let[n,i]of e)r+=n*i;return r}}}function Nn(t=e=>e){return{preMap:e=>t(e)==null?0:1,reduce:e=>{let r=0;for(let[n,i]of e)r+=n*i;return r}}}function Wn(t=e=>e){return{preMap:e=>({sum:t(e),count:0}),reduce:e=>{let r=0,n=0;for(let[i,s]of e)r+=i.sum*s,n+=s;return{sum:r,count:n}},postMap:e=>e.sum/e.count}}function $n(t){let e=t??(r=>r);return{preMap:r=>e(r),reduce:r=>{let n;for(let[i,s]of r)(!n||i&&i<n)&&(n=i);return n}}}function Cn(t){let e=t??(r=>r);return{preMap:r=>e(r),reduce:r=>{let n;for(let[i,s]of r)(!n||i&&i>n)&&(n=i);return n}}}function Ln(t=e=>e){return{preMap:e=>[t(e)],reduce:e=>{let r=[];for(let[n,i]of e)for(let s of n)for(let o=0;o<i;o++)r.push(s);return r.length===0?[]:(r.sort((n,i)=>n-i),r)},postMap:e=>{if(e.length===0)return 0;let r=Math.floor(e.length/2);return e.length%2===0?(e[r-1]+e[r])/2:e[r]}}}function Hn(t=e=>e){return{preMap:e=>{let r=t(e),n=new Map;return n.set(r,1),n},reduce:e=>{let r=new Map;for(let[n,i]of e)for(let[s,o]of n.entries()){let a=r.get(s)||0;r.set(s,a+o*i)}return r},postMap:e=>{if(e.size===0)return 0;let r=0,n=0;for(let[i,s]of e.entries())s>n&&(n=s,r=i);return r}}}var jt={sum:Fn,count:Nn,avg:Wn,min:$n,max:Cn,median:Ln,mode:Hn};function Ne(t,e){return Fe(t,e,new Map)}function Fe(t,e,r){if(t===e)return!0;if(t==null||e==null||typeof t!=typeof e)return!1;if(t instanceof Date)return e instanceof Date?t.getTime()===e.getTime():!1;if(t instanceof RegExp)return e instanceof RegExp?t.source===e.source&&t.flags===e.flags:!1;if(t instanceof Map){if(!(e instanceof Map)||t.size!==e.size)return!1;if(r.has(t))return r.get(t)===e;r.set(t,e);let i=Array.from(t.entries()).every(([s,o])=>e.has(s)&&Fe(o,e.get(s),r));return r.delete(t),i}if(t instanceof Set){if(!(e instanceof Set)||t.size!==e.size)return!1;if(r.has(t))return r.get(t)===e;r.set(t,e);let n=Array.from(t),i=Array.from(e);if(n.every(o=>typeof o!="object"))return r.delete(t),n.every(o=>e.has(o));let s=n.length===i.length;return r.delete(t),s}if(ArrayBuffer.isView(t)&&ArrayBuffer.isView(e)&&!(t instanceof DataView)&&!(e instanceof DataView)){let n=t,i=e;if(n.length!==i.length)return!1;for(let s=0;s<n.length;s++)if(n[s]!==i[s])return!1;return!0}if(Br(t)&&Br(e)){let n=zt(t),i=zt(e);return n!==i?!1:typeof t.equals=="function"?t.equals(e):t.toString()===e.toString()}if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;if(r.has(t))return r.get(t)===e;r.set(t,e);let n=t.every((i,s)=>Fe(i,e[s],r));return r.delete(t),n}if(typeof t=="object"){if(r.has(t))return r.get(t)===e;r.set(t,e);let n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return r.delete(t),!1;let s=n.every(o=>o in e&&Fe(t[o],e[o],r));return r.delete(t),s}return!1}var Un=["Temporal.Duration","Temporal.Instant","Temporal.PlainDate","Temporal.PlainDateTime","Temporal.PlainMonthDay","Temporal.PlainTime","Temporal.PlainYearMonth","Temporal.ZonedDateTime"];function zt(t){return t[Symbol.toStringTag]}function Br(t){let e=zt(t);return typeof e=="string"&&Un.includes(e)}var se={direction:"asc",nulls:"first",stringSort:"locale"};var oe=class extends Error{constructor(e){super(e),this.name="TanStackDBError"}};var j=class extends oe{constructor(e){super(e),this.name="QueryCompilationError"}},We=class extends j{constructor(){super("DISTINCT requires a SELECT clause.")}},$e=class extends j{constructor(){super("HAVING clause requires GROUP BY clause")}},Ce=class extends j{constructor(){super("LIMIT and OFFSET require an ORDER BY clause to ensure deterministic results")}},ae=class extends j{constructor(e,r,n){let i=r?`alias "${e}" (collection "${r}")`:`collection "${e}"`,s=n?.length?`. Available keys: ${n.join(", ")}`:"";super(`Input for ${i} not found in inputs map${s}`)}},Le=class extends j{constructor(e){super(`Unsupported FROM type: ${e}`)}},He=class extends j{constructor(e){super(`Unknown expression type: ${e}`)}},Ue=class extends j{constructor(){super("Reference path cannot be empty")}},Je=class extends j{constructor(e){super(`Unknown function: ${e}`)}},Oe=class extends j{constructor(e){super(`Collection "${e}" not found during compilation of join`)}},H=class extends oe{constructor(e){super(e),this.name="JoinError"}},Ge=class extends H{constructor(e){super(`Unsupported join type: ${e}`)}},Qe=class extends H{constructor(e){super(`Invalid join condition: both expressions refer to the same source "${e}"`)}},Ye=class extends H{constructor(){super("Invalid join condition: expressions must reference source aliases")}},Xe=class extends H{constructor(e){super(`Invalid join condition: left expression refers to an unavailable source "${e}"`)}},Ze=class extends H{constructor(e){super(`Invalid join condition: right expression does not refer to the joined source "${e}"`)}},qe=class extends H{constructor(){super("Invalid join condition")}},et=class extends H{constructor(e){super(`Unsupported join source type: ${e}`)}},ue=class extends oe{constructor(e){super(e),this.name="GroupByError"}},tt=class extends ue{constructor(e){super(`Non-aggregate expression '${e}' in SELECT must also appear in GROUP BY clause`)}},rt=class extends ue{constructor(e){super(`Unsupported aggregate function: ${e}`)}},nt=class extends ue{constructor(e){super(`Aggregate function in HAVING clause must also be in SELECT clause: ${e}`)}},it=class extends ue{constructor(e){super(`Unknown expression type in HAVING clause: ${e}`)}};var Dt=class extends oe{constructor(e){super(e),this.name="QueryOptimizerError"}},st=class extends Dt{constructor(){super("Cannot combine empty expression list")}};var ot=class extends j{constructor(e,r,n,i){super(`Internal error: subscription for alias '${e}' (remapped from '${r}', collection '${n}') is missing in join pipeline. Available aliases: ${i.join(", ")}. This indicates a bug in alias tracking.`)}};var Q=class{},Y=class extends Q{constructor(e,r){super(),this.collection=e,this.alias=r,this.type="collectionRef"}},E=class extends Q{constructor(e,r){super(),this.query=e,this.alias=r,this.type="queryRef"}},M=class extends Q{constructor(e){super(),this.path=e,this.type="ref"}},$=class extends Q{constructor(e){super(),this.value=e,this.type="val"}},U=class extends Q{constructor(e,r){super(),this.name=e,this.args=r,this.type="func"}},at=class extends Q{constructor(e,r){super(),this.name=e,this.args=r,this.type="agg"}};function Ft(t){return t instanceof at||t instanceof U||t instanceof M||t instanceof $}function ut(t){return typeof t=="object"&&"expression"in t?t.expression:t}function Nt(t){return typeof t=="object"&&"expression"in t?t.expression:t}function Wt(t){return typeof t=="object"&&"expression"in t&&t.residual===!0}function Er(t){return{expression:t,residual:!0}}function Jn(t,e){if(t.from.alias===e)return t.from;for(let r of t.join||[])if(r.from.alias===e)return r.from}function ce(t,e,r){if(e.path.length!==0){if(e.path.length===1){let n=e.path[0];if(t.select){let i=t.select[n];if(i&&i.type==="ref")return ce(t,i,r)}return{collection:r,path:[n]}}if(e.path.length>1){let[n,...i]=e.path,s=Jn(t,n);return s?s.type==="queryRef"?ce(s.query,new M(i),r):{collection:s.collection,path:i}:void 0}}}var Gn=new Set(["eq","gt","lt","gte","lte","and","or","in"]);function $t(t){let e=t.type;return e==="func"?Gn.has(t.name)?t.args.every(r=>$t(r)):!1:["val","ref"].includes(e)}function Dr(t){let e=Qn(t),r=t,n,i=0,s=10;for(;i<s&&!Ne(r,n);)n=r,r=Ct(r),i++;return{optimizedQuery:Fr(r),sourceWhereClauses:e}}function Qn(t){let e=new Map;if(!t.where||t.where.length===0)return e;let n=Nr(t.where).map(s=>$r(s)),i=Cr(n);for(let[s,o]of i.singleSource)Yn(t,s)&&$t(o)&&e.set(s,o);return e}function Yn(t,e){if(t.from.alias===e)return t.from.type==="collectionRef";if(t.join){for(let r of t.join)if(r.from.alias===e)return r.from.type==="collectionRef"}return!1}function Ct(t){let e={...t,from:t.from.type==="queryRef"?new E(Ct(t.from.query),t.from.alias):t.from,join:t.join?.map(r=>({...r,from:r.from.type==="queryRef"?new E(Ct(r.from.query),r.from.alias):r.from}))};return Xn(e)}function Xn(t){if(!t.where||t.where.length===0||!t.join||t.join.length===0)return t;let e=t.where.filter(a=>!Wt(a)),n=Nr(e).map(a=>$r(a)),i=Cr(n),s=qn(t,i),o=t.where.filter(a=>Wt(a));return o.length>0&&(s.where=[...s.where||[],...o]),s}function Fr(t){return{...t,from:Lt(t.from),join:t.join?.map(e=>({...e,from:Lt(e.from)}))}}function Lt(t){if(t.type==="collectionRef")return t;let e=Fr(t.query);if(Zn(e)){let r=Lt(e.from);return r.type==="collectionRef"?new Y(r.collection,t.alias):new E(r.query,t.alias)}return new E(e,t.alias)}function Zn(t){return(!t.where||t.where.length===0)&&!t.select&&(!t.groupBy||t.groupBy.length===0)&&(!t.having||t.having.length===0)&&(!t.orderBy||t.orderBy.length===0)&&(!t.join||t.join.length===0)&&t.limit===void 0&&t.offset===void 0&&!t.fnSelect&&(!t.fnWhere||t.fnWhere.length===0)&&(!t.fnHaving||t.fnHaving.length===0)}function Nr(t){let e=[];for(let r of t){let n=ut(r);e.push(...Wr(n))}return e}function Wr(t){if(t.type==="func"&&t.name==="and"){let e=[];for(let r of t.args)e.push(...Wr(r));return e}else return[t]}function $r(t){let e=new Set,r=!1;function n(i){switch(i.type){case"ref":if(i.path&&i.path.length>0){let s=i.path[0];s&&(e.add(s),i.path.length===1&&(r=!0))}break;case"func":i.args&&i.args.forEach(n);break;case"val":break;case"agg":i.args&&i.args.forEach(n);break}}return n(t),{expression:t,touchedSources:e,hasNamespaceOnlyRef:r}}function Cr(t){let e=new Map,r=[];for(let s of t)if(s.touchedSources.size===1&&!s.hasNamespaceOnlyRef){let o=Array.from(s.touchedSources)[0];e.has(o)||e.set(o,[]),e.get(o).push(s.expression)}else(s.touchedSources.size>1||s.hasNamespaceOnlyRef)&&r.push(s.expression);let n=new Map;for(let[s,o]of e)n.set(s,zr(o));let i=r.length>0?zr(r):void 0;return{singleSource:n,multiSource:i}}function qn(t,e){let r=new Set,n=jr(t.from,e.singleSource,r),i=t.join?t.join.map(u=>({...u,from:jr(u.from,e.singleSource,r)})):void 0,s=[];e.multiSource&&s.push(e.multiSource);let o=t.join&&t.join.some(u=>u.type==="left"||u.type==="right"||u.type==="full");for(let[u,c]of e.singleSource)r.has(u)?o&&s.push(Er(c)):s.push(c);return{select:t.select,groupBy:t.groupBy?[...t.groupBy]:void 0,having:t.having?[...t.having]:void 0,orderBy:t.orderBy?[...t.orderBy]:void 0,limit:t.limit,offset:t.offset,distinct:t.distinct,fnSelect:t.fnSelect,fnWhere:t.fnWhere?[...t.fnWhere]:void 0,fnHaving:t.fnHaving?[...t.fnHaving]:void 0,from:n,join:i,where:s.length>0?s:[]}}function le(t){return{from:t.from.type==="collectionRef"?new Y(t.from.collection,t.from.alias):new E(le(t.from.query),t.from.alias),select:t.select,join:t.join?t.join.map(e=>({type:e.type,left:e.left,right:e.right,from:e.from.type==="collectionRef"?new Y(e.from.collection,e.from.alias):new E(le(e.from.query),e.from.alias)})):void 0,where:t.where?[...t.where]:void 0,groupBy:t.groupBy?[...t.groupBy]:void 0,having:t.having?[...t.having]:void 0,orderBy:t.orderBy?[...t.orderBy]:void 0,limit:t.limit,offset:t.offset,fnSelect:t.fnSelect,fnWhere:t.fnWhere?[...t.fnWhere]:void 0,fnHaving:t.fnHaving?[...t.fnHaving]:void 0}}function jr(t,e,r){let n=e.get(t.alias);if(!n)return t.type==="collectionRef"?new Y(t.collection,t.alias):new E(le(t.query),t.alias);if(t.type==="collectionRef"){let o={from:new Y(t.collection,t.alias),where:[n]};return r.add(t.alias),new E(o,t.alias)}if(!si(t.query,n,t.alias))return new E(le(t.query),t.alias);if(ai(t.query,n,t.alias))return new E(le(t.query),t.alias);let i=t.query.where||[],s={...le(t.query),where:[...i,n]};return r.add(t.alias),new E(s,t.alias)}function ei(t,e,r){return t.select?Lr(t.select)||oi(t.select,e,r):!1}function ti(t){return t.groupBy&&t.groupBy.length>0}function ri(t){return t.having&&t.having.length>0}function ni(t){return t.orderBy&&t.orderBy.length>0&&(t.limit!==void 0||t.offset!==void 0)}function ii(t){return t.fnSelect||t.fnWhere&&t.fnWhere.length>0||t.fnHaving&&t.fnHaving.length>0}function si(t,e,r){return!(ei(t,e,r)||ti(t)||ri(t)||ni(t)||ii(t))}function Lr(t){for(let e of Object.values(t))if(typeof e=="object"){let r=e;if(r.type==="agg"||!("type"in r)&&Lr(r))return!0}return!1}function Ht(t){let e=[];if(t==null||typeof t!="object")return e;switch(t.type){case"ref":e.push(t);break;case"func":case"agg":for(let r of t.args??[])e.push(...Ht(r));break}return e}function oi(t,e,r){let n=new Set;for(let[s,o]of Object.entries(t))s.startsWith("__SPREAD_SENTINEL__")||o instanceof M||n.add(s);let i=Ht(e);for(let s of i){let o=s.path;if(!Array.isArray(o)||o.length<2)continue;let a=o[0],u=o[1];if(a===r&&n.has(u))return!0}return!1}function ai(t,e,r){let n=Ht(e);if(n.every(s=>s.path[0]!==r))return!1;if(t.fnSelect)return!0;let i=t.select;if(!i)return!1;for(let s of n){let o=s.path;if(o.length<2||o[0]!==r)continue;let a=i[o[1]];if(!a)continue;if(!(a instanceof M)||a.path.length<2)return!0;let[u,c]=a.path;if(u!==r&&u!==t.from.alias||c!==o[1])return!0}return!1}function zr(t){if(t.length===0)throw new st;return t.length===1?t[0]:new U("and",t)}var Ut=new WeakMap,ui=1;function Hr(t){if(Ut.has(t))return Ut.get(t);let e=ui++;return Ut.set(t,e),e}var Jt=(t,e,r)=>{let{nulls:n}=r;if(t==null&&e==null)return 0;if(t==null)return n==="first"?-1:1;if(e==null)return n==="first"?1:-1;if(typeof t=="string"&&typeof e=="string"&&r.stringSort==="locale")return t.localeCompare(e,r.locale,r.localeOptions);if(Array.isArray(t)&&Array.isArray(e)){for(let o=0;o<Math.min(t.length,e.length);o++){let a=Jt(t[o],e[o],r);if(a!==0)return a}return t.length-e.length}if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let i=typeof t=="object",s=typeof e=="object";if(i||s){if(i&&s){let o=Hr(t),a=Hr(e);return o-a}if(i)return 1;if(s)return-1}return t<e?-1:t>e?1:0},ci=(t,e,r)=>Jt(e,t,{...r,nulls:r.nulls==="first"?"last":"first"});function ct(t){return(e,r)=>t.direction==="asc"?Jt(e,r,t):ci(e,r,t)}var we=ct({direction:"asc",nulls:"first",stringSort:"locale"});function N(t){return t instanceof Date?t.getTime():t}function R(t,e=!1){return Gt(t,e)}function Jr(t){return Gt(t,!0)}function Gt(t,e){switch(t.type){case"val":{let r=t.value;return()=>r}case"ref":return e?pi(t):li(t);case"func":return fi(t,e);default:throw new He(t.type)}}function li(t){let[e,...r]=t.path;if(!e)throw new Ue;if(r.length===0)return n=>n[e];if(r.length===1){let n=r[0];return i=>i[e]?.[n]}else return n=>{let i=n[e];if(i===void 0)return;let s=i;for(let o of r){if(s==null)return s;s=s[o]}return s}}function pi(t){let e=t.path;return r=>{let n=r;for(let i of e){if(n==null)return n;n=n[i]}return n}}function fi(t,e){let r=t.args.map(n=>Gt(n,e));switch(t.name){case"eq":{let n=r[0],i=r[1];return s=>{let o=N(n(s)),a=N(i(s));return o===a}}case"gt":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return o>a}}case"gte":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return o>=a}}case"lt":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return o<a}}case"lte":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return o<=a}}case"and":return n=>{for(let i of r)if(!i(n))return!1;return!0};case"or":return n=>{for(let i of r)if(i(n))return!0;return!1};case"not":{let n=r[0];return i=>!n(i)}case"in":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return Array.isArray(a)?a.includes(o):!1}}case"like":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return Ur(o,a,!1)}}case"ilike":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return Ur(o,a,!0)}}case"upper":{let n=r[0];return i=>{let s=n(i);return typeof s=="string"?s.toUpperCase():s}}case"lower":{let n=r[0];return i=>{let s=n(i);return typeof s=="string"?s.toLowerCase():s}}case"length":{let n=r[0];return i=>{let s=n(i);return typeof s=="string"||Array.isArray(s)?s.length:0}}case"concat":return n=>r.map(i=>{let s=i(n);try{return String(s??"")}catch{try{return JSON.stringify(s)||""}catch{return"[object]"}}}).join("");case"coalesce":return n=>{for(let i of r){let s=i(n);if(s!=null)return s}return null};case"add":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return(o??0)+(a??0)}}case"subtract":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return(o??0)-(a??0)}}case"multiply":{let n=r[0],i=r[1];return s=>{let o=n(s),a=i(s);return(o??0)*(a??0)}}case"divide":{let n=r[0],i=r[1];return s=>{let o=n(s),u=i(s)??0;return u!==0?(o??0)/u:null}}case"isUndefined":{let n=r[0];return i=>n(i)===void 0}case"isNull":{let n=r[0];return i=>n(i)===null}default:throw new Je(t.name)}}function Ur(t,e,r){if(typeof t!="string"||typeof e!="string")return!1;let n=r?t.toLowerCase():t,s=(r?e.toLowerCase():e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return s=s.replace(/%/g,".*"),s=s.replace(/_/g,"."),new RegExp(`^${s}$`).test(n)}var lt=class{constructor(e,r,n){this._root=Qt,this._size=0,this._maxNodeSize=n>=4?Math.min(n,256):32,this._compare=e,r&&this.setPairs(r)}get size(){return this._size}get length(){return this._size}get isEmpty(){return this._size===0}clear(){this._root=Qt,this._size=0}get(e,r){return this._root.get(e,r,this)}set(e,r,n){this._root.isShared&&(this._root=this._root.clone());let i=this._root.set(e,r,n,this);return i===!0||i===!1?i:(this._root=new Yt([this._root,i]),!0)}has(e){return this.forRange(e,e,!0,void 0)!==0}delete(e){return this.editRange(e,e,!0,hi)!==0}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}keysArray(){let e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(r,n)=>{e.push(r)}),e}nextHigherPair(e,r){return r=r||[],e===void 0?this._root.minPair(r):this._root.getPairOrNextHigher(e,this._compare,!1,r)}nextHigherKey(e){let r=this.nextHigherPair(e,Gr);return r&&r[0]}nextLowerPair(e,r){return r=r||[],e===void 0?this._root.maxPair(r):this._root.getPairOrNextLower(e,this._compare,!1,r)}nextLowerKey(e){let r=this.nextLowerPair(e,Gr);return r&&r[0]}setPairs(e,r){let n=0;for(let i of e)this.set(i[0],i[1],r)&&n++;return n}forRange(e,r,n,i,s){let o=this._root.forRange(e,r,n,!1,this,s||0,i);return typeof o=="number"?o:o.break}editRange(e,r,n,i,s){let o=this._root;o.isShared&&(this._root=o=o.clone());try{let a=o.forRange(e,r,n,!0,this,s||0,i);return typeof a=="number"?a:a.break}finally{let a;for(;o.keys.length<=1&&!o.isLeaf;)a||=o.isShared,this._root=o=o.keys.length===0?Qt:o.children[0];a&&(o.isShared=!0)}}},pt=class t{get isLeaf(){return this.children===void 0}constructor(e=[],r){this.keys=e,this.values=r||k,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,r,n){let i=this.keys,s=0,o=i.length,a=o>>1;for(;s<o;){let u=n(i[a],e);if(u<0)s=a+1;else if(u>0)o=a;else{if(u===0)return a;if(e===e)return i.length;throw new Error("BTree: NaN was used as a key")}a=s+o>>1}return a^r}minKey(){return this.keys[0]}minPair(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(this.keys.length===0)return;let r=this.keys.length-1;return e[0]=this.keys[r],e[1]=this.values[r],e}clone(){let e=this.values;return new t(this.keys.slice(0),e===k?e:e.slice(0))}get(e,r,n){let i=this.indexOf(e,-1,n._compare);return i<0?r:this.values[i]}getPairOrNextLower(e,r,n,i){let s=this.indexOf(e,-1,r),o=s<0?~s-1:n?s:s-1;if(o>=0)return i[0]=this.keys[o],i[1]=this.values[o],i}getPairOrNextHigher(e,r,n,i){let s=this.indexOf(e,-1,r),o=s<0?~s:n?s:s+1,a=this.keys;if(o<a.length)return i[0]=a[o],i[1]=this.values[o],i}set(e,r,n,i){let s=this.indexOf(e,-1,i._compare);if(s<0){if(s=~s,i._size++,this.keys.length<i._maxNodeSize)return this.insertInLeaf(s,e,r,i);{let o=this.splitOffRightSide(),a=this;return s>this.keys.length&&(s-=this.keys.length,a=o),a.insertInLeaf(s,e,r,i),o}}else return n!==!1&&(r!==void 0&&this.reifyValues(),this.keys[s]=e,this.values[s]=r),!1}reifyValues(){return this.values===k?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,r,n,i){if(this.keys.splice(e,0,r),this.values===k){for(;k.length<i._maxNodeSize;)k.push(void 0);if(n===void 0)return!0;this.values=k.slice(0,this.keys.length-1)}return this.values.splice(e,0,n),!0}takeFromRight(e){let r=this.values;e.values===k?r!==k&&r.push(void 0):(r=this.reifyValues(),r.push(e.values.shift())),this.keys.push(e.keys.shift())}takeFromLeft(e){let r=this.values;e.values===k?r!==k&&r.unshift(void 0):(r=this.reifyValues(),r.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())}splitOffRightSide(){let e=this.keys.length>>1,r=this.keys.splice(e),n=this.values===k?k:this.values.splice(e);return new t(r,n)}forRange(e,r,n,i,s,o,a){let u=s._compare,c,p;if(r===e){if(!n||(p=(c=this.indexOf(e,-1,u))+1,c<0))return o}else c=this.indexOf(e,0,u),p=this.indexOf(r,-1,u),p<0?p=~p:n===!0&&p++;let l=this.keys,f=this.values;if(a!==void 0)for(let d=c;d<p;d++){let h=l[d],m=a(h,f[d],o++);if(m!==void 0){if(i===!0){if(h!==l[d]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");m.delete?(this.keys.splice(d,1),this.values!==k&&this.values.splice(d,1),s._size--,d--,p--):m.hasOwnProperty("value")&&(f[d]=m.value)}if(m.break!==void 0)return m}}else o+=p-c;return o}mergeSibling(e,r){if(this.keys.push.apply(this.keys,e.keys),this.values===k){if(e.values===k)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}},Yt=class t extends pt{constructor(e,r){if(!r){r=[];for(let n=0;n<e.length;n++)r[n]=e[n].maxKey()}super(r),this.children=e}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,r,n){let i=this.indexOf(e,0,n._compare),s=this.children;return i<s.length?s[i].get(e,r,n):void 0}getPairOrNextLower(e,r,n,i){let s=this.indexOf(e,0,r),o=this.children;if(s>=o.length)return this.maxPair(i);let a=o[s].getPairOrNextLower(e,r,n,i);return a===void 0&&s>0?o[s-1].maxPair(i):a}getPairOrNextHigher(e,r,n,i){let s=this.indexOf(e,0,r),o=this.children,a=o.length;if(s>=a)return;let u=o[s].getPairOrNextHigher(e,r,n,i);return u===void 0&&s<a-1?o[s+1].minPair(i):u}set(e,r,n,i){let s=this.children,o=i._maxNodeSize,a=i._compare,u=Math.min(this.indexOf(e,0,a),s.length-1),c=s[u];if(c.isShared&&(s[u]=c=c.clone()),c.keys.length>=o){let l;u>0&&(l=s[u-1]).keys.length<o&&a(c.keys[0],e)<0?(l.isShared&&(s[u-1]=l=l.clone()),l.takeFromRight(c),this.keys[u-1]=l.maxKey()):(l=s[u+1])!==void 0&&l.keys.length<o&&a(c.maxKey(),e)<0&&(l.isShared&&(s[u+1]=l=l.clone()),l.takeFromLeft(c),this.keys[u]=s[u].maxKey())}let p=c.set(e,r,n,i);if(p===!1)return!1;if(this.keys[u]=c.maxKey(),p===!0)return!0;if(this.keys.length<o)return this.insert(u+1,p),!0;{let l=this.splitOffRightSide(),f=this;return a(p.maxKey(),this.maxKey())>0&&(f=l,u-=this.keys.length),f.insert(u+1,p),l}}insert(e,r){this.children.splice(e,0,r),this.keys.splice(e,0,r.maxKey())}splitOffRightSide(){let e=this.children.length>>1;return new t(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,r,n,i,s,o,a){let u=s._compare,c=this.keys,p=this.children,l=this.indexOf(e,0,u),f=l,d=Math.min(r===e?l:this.indexOf(r,0,u),c.length-1);if(i){if(f<=d)try{for(;f<=d;f++){p[f].isShared&&(p[f]=p[f].clone());let h=p[f].forRange(e,r,n,i,s,o,a);if(c[f]=p[f].maxKey(),typeof h!="number")return h;o=h}}finally{let h=s._maxNodeSize>>1;for(l>0&&l--,f=d;f>=l;f--)p[f].keys.length<=h&&(p[f].keys.length!==0?this.tryMerge(f,s._maxNodeSize):(c.splice(f,1),p.splice(f,1)));p.length!==0&&p[0].keys.length===0&&mi(!1,"emptiness bug")}}else for(;f<=d;f++){let h=p[f].forRange(e,r,n,i,s,o,a);if(typeof h!="number")return h;o=h}return o}tryMerge(e,r){let n=this.children;return e>=0&&e+1<n.length&&n[e].keys.length+n[e+1].keys.length<=r?(n[e].isShared&&(n[e]=n[e].clone()),n[e].mergeSibling(n[e+1],r),n.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=n[e].maxKey(),!0):!1}mergeSibling(e,r){let n=this.keys.length;this.keys.push.apply(this.keys,e.keys);let i=e.children;if(this.children.push.apply(this.children,i),e.isShared&&!this.isShared)for(let s of i)s.isShared=!0;this.tryMerge(n-1,r)}},k=[],di={delete:!0},hi=()=>di,Qt=(function(){let t=new pt;return t.isShared=!0,t})(),Gr=[];function mi(t,...e){throw e.unshift("B+ tree"),new Error(e.join(" "))}function Xt(t){return gi(t)?new M(t.__path):t&&typeof t=="object"&&"type"in t&&(t.type==="func"||t.type==="ref"||t.type==="val"||t.type==="agg")?t:new $(t)}function gi(t){return t&&typeof t=="object"&&t.__refProxy===!0}function Qr(t,e){return new U("in",[Xt(t),Xt(e)])}var ft=class{constructor(e,r,n,i){this.lookupCount=0,this.totalLookupTime=0,this.lastUpdated=new Date,this.id=e,this.expression=r,this.compareOptions=se,this.name=n,this.initialize(i)}supports(e){return this.supportedOperations.has(e)}matchesField(e){return this.expression.type==="ref"&&this.expression.path.length===e.length&&this.expression.path.every((r,n)=>r===e[n])}matchesCompareOptions(e){let r={...this.compareOptions,direction:void 0},n={...e,direction:void 0};return Ne(r,n)}matchesDirection(e){return this.compareOptions.direction===e}getStats(){return{entryCount:this.keyCount,lookupCount:this.lookupCount,averageLookupTime:this.lookupCount>0?this.totalLookupTime/this.lookupCount:0,lastUpdated:this.lastUpdated}}evaluateIndexExpression(e){return Jr(this.expression)(e)}trackLookup(e){let r=performance.now()-e;this.lookupCount++,this.totalLookupTime+=r}updateTimestamp(){this.lastUpdated=new Date}};var dt=class extends ft{constructor(e,r,n,i){super(e,r,n,i),this.supportedOperations=new Set(["eq","gt","gte","lt","lte","in"]),this.valueMap=new Map,this.indexedKeys=new Set,this.compareFn=we,this.compareFn=i?.compareFn??we,i?.compareOptions&&(this.compareOptions=i.compareOptions),this.orderedEntries=new lt(this.compareFn)}initialize(e){}add(e,r){let n;try{n=this.evaluateIndexExpression(r)}catch(s){throw new Error(`Failed to evaluate index expression for key ${e}: ${s}`)}let i=N(n);if(this.valueMap.has(i))this.valueMap.get(i).add(e);else{let s=new Set([e]);this.valueMap.set(i,s),this.orderedEntries.set(i,void 0)}this.indexedKeys.add(e),this.updateTimestamp()}remove(e,r){let n;try{n=this.evaluateIndexExpression(r)}catch(s){console.warn(`Failed to evaluate index expression for key ${e} during removal:`,s);return}let i=N(n);if(this.valueMap.has(i)){let s=this.valueMap.get(i);s.delete(e),s.size===0&&(this.valueMap.delete(i),this.orderedEntries.delete(i))}this.indexedKeys.delete(e),this.updateTimestamp()}update(e,r,n){this.remove(e,r),this.add(e,n)}build(e){this.clear();for(let[r,n]of e)this.add(r,n)}clear(){this.orderedEntries.clear(),this.valueMap.clear(),this.indexedKeys.clear(),this.updateTimestamp()}lookup(e,r){let n=performance.now(),i;switch(e){case"eq":i=this.equalityLookup(r);break;case"gt":i=this.rangeQuery({from:r,fromInclusive:!1});break;case"gte":i=this.rangeQuery({from:r,fromInclusive:!0});break;case"lt":i=this.rangeQuery({to:r,toInclusive:!1});break;case"lte":i=this.rangeQuery({to:r,toInclusive:!0});break;case"in":i=this.inArrayLookup(r);break;default:throw new Error(`Operation ${e} not supported by BTreeIndex`)}return this.trackLookup(n),i}get keyCount(){return this.indexedKeys.size}equalityLookup(e){let r=N(e);return new Set(this.valueMap.get(r)??[])}rangeQuery(e={}){let{from:r,to:n,fromInclusive:i=!0,toInclusive:s=!0}=e,o=new Set,a=N(r),u=N(n),c=a??this.orderedEntries.minKey(),p=u??this.orderedEntries.maxKey();return this.orderedEntries.forRange(c,p,s,(l,f)=>{if(!i&&this.compareFn(l,r)===0)return;let d=this.valueMap.get(l);d&&d.forEach(h=>o.add(h))}),o}rangeQueryReversed(e={}){let{from:r,to:n,fromInclusive:i=!0,toInclusive:s=!0}=e;return this.rangeQuery({from:n??this.orderedEntries.maxKey(),to:r??this.orderedEntries.minKey(),fromInclusive:s,toInclusive:i})}takeInternal(e,r,n,i){let s=new Set,o=[],a,u=N(n);for(;(a=r(u))!==void 0&&o.length<e;){u=a[0];let c=this.valueMap.get(u);if(c){let p=c.values(),l;for(;o.length<e&&(l=p.next().value);)!s.has(l)&&(i?.(l)??!0)&&(o.push(l),s.add(l))}}return o}take(e,r,n){let i=s=>this.orderedEntries.nextHigherPair(s);return this.takeInternal(e,i,r,n)}takeReversed(e,r,n){let i=s=>this.orderedEntries.nextLowerPair(s);return this.takeInternal(e,i,r,n)}inArrayLookup(e){let r=new Set;for(let n of e){let i=N(n),s=this.valueMap.get(i);s&&s.forEach(o=>r.add(o))}return r}get indexedKeysSet(){return this.indexedKeys}get orderedEntriesArray(){return this.orderedEntries.keysArray().map(e=>[e,this.valueMap.get(e)??new Set])}get orderedEntriesArrayReversed(){return this.takeReversed(this.orderedEntries.size).map(e=>[e,this.valueMap.get(e)??new Set])}get valueMapData(){return this.valueMap}};function Ti(t){return t.config.autoIndex==="eager"}function ht(t,e,r,n=se,i){if(!(!Ti(r)||Array.from(r.indexes.values()).find(o=>o.matchesField(e)&&o.matchesCompareOptions(n))))try{r.createIndex(o=>o[t],{name:`auto_${t}`,indexType:dt,options:i?{compareFn:i,compareOptions:n}:{}})}catch(o){console.warn(`${r.id?`[${r.id}] `:""}Failed to create auto-index for field "${t}":`,o)}}function Yr(t,e,r,n,i,s,o,a,u,c,p,l,f,d,h,m,T,O){let w=t;for(let V of e)w=yi(w,V,r,n,i,s,o,a,u,c,p,l,f,d,h,m,T,O);return w}function yi(t,e,r,n,i,s,o,a,u,c,p,l,f,d,h,m,T,O){let w=e.from.type==="collectionRef",{alias:V,input:g,collectionId:B}=Oi(e.from,s,u,c,p,l,f,d,o,a,m,T,O);r[V]=g,w&&(T[V]=B);let C=u[n],z=u[B];if(!C)throw new Oe(n);if(!z)throw new Oe(B);let{activeSource:y,lazySource:x}=Vi(e.type,C,z),A=Object.keys(r),{mainExpr:L,joinedExpr:Z}=xi(e.left,e.right,A,V),vt=R(L),St=R(Z),fe=t.pipe(v(([q,te])=>[vt(te),[q,te]])),de=g.pipe(v(([q,te])=>{let he={[V]:te};return[St(he),[q,he]]}));if(!["inner","left","right","full"].includes(e.type))throw new Ge(e.type);if(y){let q=y==="main"?e.from:h.from,te=q.type==="queryRef"&&(q.query.limit||q.query.offset),he=L.type==="func"||Z.type==="func";if(!te&&!he){let me=y==="main"?V:i;l.add(me);let un=y==="main"?fe:de,Ie=ce(h,y==="main"?Z:L,x),cn=Ie.collection,ur=Ie.path[0];ur&&ht(ur,Ie.path,cn);let cr=un.pipe(Tr(ln=>{let lr=O[me]||me,be=c[lr];if(!be)throw new ot(lr,me,x.id,Object.keys(c));if(be.hasLoadedInitialState())return;let pn=ln.getInner().map(([[dn]])=>dn),fn=new M(Ie.path);be.requestSnapshot({where:Qr(fn,pn),optimizedOnly:!0})||be.requestSnapshot()}));y==="main"?fe=cr:de=cr}}return fe.pipe(xr(de,e.type),wi(e.type))}function xi(t,e,r,n){let i=r.filter(a=>a!==n),s=Zt(t),o=Zt(e);if(s&&i.includes(s)&&o===n)return{mainExpr:t,joinedExpr:e};if(s===n&&o&&i.includes(o))return{mainExpr:e,joinedExpr:t};throw!s||!o?new Ye:s===o?new Qe(s):i.includes(s)?o!==n?new Ze(n):new qe:new Xe(s)}function Zt(t){switch(t.type){case"ref":return t.path[0]||null;case"func":{let e=new Set;for(let r of t.args){let n=Zt(r);n&&e.add(n)}return e.size===1?Array.from(e)[0]:null}default:return null}}function Oi(t,e,r,n,i,s,o,a,u,c,p,l,f){switch(t.type){case"collectionRef":{let d=e[t.alias];if(!d)throw new ae(t.alias,t.collection.id,Object.keys(e));return l[t.alias]=t.collection.id,{alias:t.alias,input:d,collectionId:t.collection.id}}case"queryRef":{let d=c.get(t.query)||t.query,h=p(d,e,r,n,i,s,o,a,u,c);Object.assign(l,h.aliasToCollectionId),Object.assign(f,h.aliasRemapping);let m=Object.keys(h.aliasToCollectionId).find(w=>h.aliasToCollectionId[w]===h.collectionId);m&&m!==t.alias&&(f[t.alias]=m);let O=h.pipeline.pipe(v(w=>{let[V,[g,B]]=w;return[V,g]}));return{alias:t.alias,input:O,collectionId:h.collectionId}}default:throw new et(t.type)}}function wi(t){return function(e){return e.pipe(F(r=>{let[n,[i,s]]=r,o=i?.[1],a=s?.[1];return t==="inner"?!!(o&&a):t==="left"?!!o:t==="right"?!!a:!0}),v(r=>{let[n,[i,s]]=r,o=i?.[0],a=i?.[1],u=s?.[0],c=s?.[1],p={};return a&&Object.assign(p,a),c&&Object.assign(p,c),[`[${o},${u}]`,p]}))}}function Vi(t,e,r){switch(t){case"left":return{activeSource:"main",lazySource:r};case"right":return{activeSource:"joined",lazySource:e};case"inner":return e.size<r.size?{activeSource:"main",lazySource:r}:{activeSource:"joined",lazySource:e};default:return{activeSource:void 0,lazySource:void 0}}}var{sum:vi,count:Si,avg:Ii,min:bi,max:Pi}=jt;function Ki(t,e){let r=new Map,n=[...t];if(!e)return{selectToGroupByIndex:r,groupByExpressions:n};for(let[i,s]of Object.entries(e)){if(s.type==="agg")continue;let o=n.findIndex(a=>mt(s,a));if(o===-1)throw new tt(i);r.set(i,o)}return{selectToGroupByIndex:r,groupByExpressions:n}}function qt(t,e,r,n,i){if(e.length===0){let c={};if(n){for(let[l,f]of Object.entries(n))if(f.type==="agg"){let d=f;c[l]=Xr(d)}}let p=()=>({__singleGroup:!0});if(t=t.pipe(De(p,c)),t=t.pipe(v(([,l])=>{let d={...l.__select_results||{}};if(n)for(let[h,m]of Object.entries(n))m.type==="agg"&&(d[h]=l[h]);return["single_group",{...l,__select_results:d}]})),r&&r.length>0)for(let l of r){let f=Nt(l),d=Ve(f,n||{}),h=R(d);t=t.pipe(F(([,m])=>{let T={result:m.__select_results};return h(T)}))}if(i&&i.length>0)for(let l of i)t=t.pipe(F(([,f])=>{let d={result:f.__select_results};return l(d)}));return t}let s=Ki(e,n),o=e.map(c=>R(c)),a=([,c])=>{let p={...c};delete p.__select_results;let l={};for(let f=0;f<e.length;f++){let d=o[f],h=d(p);l[`__key_${f}`]=h}return l},u={};if(n){for(let[c,p]of Object.entries(n))if(p.type==="agg"){let l=p;u[c]=Xr(l)}}if(t=t.pipe(De(a,u)),t=t.pipe(v(([,c])=>{let p=c.__select_results||{},l={};if(n)for(let[d,h]of Object.entries(n))if(h.type!=="agg"){let m=s.selectToGroupByIndex.get(d);m!==void 0?l[d]=c[`__key_${m}`]:l[d]=p[d]}else l[d]=c[d];else for(let d=0;d<e.length;d++)l[`__key_${d}`]=c[`__key_${d}`];let f;if(e.length===1)f=c.__key_0;else{let d=[];for(let h=0;h<e.length;h++)d.push(c[`__key_${h}`]);f=JSON.stringify(d)}return[f,{...c,__select_results:l}]})),r&&r.length>0)for(let c of r){let p=Nt(c),l=Ve(p,n||{}),f=R(l);t=t.pipe(F(([,d])=>{let h={result:d.__select_results};return f(h)}))}if(i&&i.length>0)for(let c of i)t=t.pipe(F(([,p])=>{let l={result:p.__select_results};return c(l)}));return t}function mt(t,e){if(!t||!e||t.type!==e.type)return!1;switch(t.type){case"ref":return!t.path||!e.path||t.path.length!==e.path.length?!1:t.path.every((r,n)=>r===e.path[n]);case"val":return t.value===e.value;case"func":return t.name===e.name&&t.args?.length===e.args?.length&&(t.args||[]).every((r,n)=>mt(r,e.args[n]));case"agg":return t.name===e.name&&t.args?.length===e.args?.length&&(t.args||[]).every((r,n)=>mt(r,e.args[n]));default:return!1}}function Xr(t){let e=R(t.args[0]),r=([,s])=>{let o=e(s);return typeof o=="number"?o:o!=null?Number(o):0},n=([,s])=>{let o=e(s);return typeof o=="number"||o instanceof Date?o:o!=null?Number(o):0},i=([,s])=>e(s);switch(t.name.toLowerCase()){case"sum":return vi(r);case"count":return Si(i);case"avg":return Ii(r);case"min":return bi(n);case"max":return Pi(n);default:throw new rt(t.name)}}function Ve(t,e,r="result"){switch(t.type){case"agg":{let n=t;for(let[i,s]of Object.entries(e))if(s.type==="agg"&&Mi(n,s))return new M([r,i]);throw new nt(n.name)}case"func":{let n=t,i=n.args.map(s=>Ve(s,e));return new U(n.name,i)}case"ref":return t;case"val":return t;default:throw new it(t.type)}}function Mi(t,e){return t.name===e.name&&t.args.length===e.args.length&&t.args.every((r,n)=>mt(r,e.args[n]))}var gt=class{constructor(e){this.originalIndex=e}lookup(e,r){let n=e==="gt"?"lt":e==="gte"?"lte":e==="lt"?"gt":e==="lte"?"gte":e;return this.originalIndex.lookup(n,r)}rangeQuery(e={}){return this.originalIndex.rangeQueryReversed(e)}rangeQueryReversed(e={}){return this.originalIndex.rangeQuery(e)}take(e,r,n){return this.originalIndex.takeReversed(e,r,n)}takeReversed(e,r,n){return this.originalIndex.take(e,r,n)}get orderedEntriesArray(){return this.originalIndex.orderedEntriesArrayReversed}get orderedEntriesArrayReversed(){return this.originalIndex.orderedEntriesArray}supports(e){return this.originalIndex.supports(e)}matchesField(e){return this.originalIndex.matchesField(e)}matchesCompareOptions(e){return this.originalIndex.matchesCompareOptions(e)}matchesDirection(e){return this.originalIndex.matchesDirection(e)}getStats(){return this.originalIndex.getStats()}add(e,r){this.originalIndex.add(e,r)}remove(e,r){this.originalIndex.remove(e,r)}update(e,r,n){this.originalIndex.update(e,r,n)}build(e){this.originalIndex.build(e)}clear(){this.originalIndex.clear()}get keyCount(){return this.originalIndex.keyCount}equalityLookup(e){return this.originalIndex.equalityLookup(e)}inArrayLookup(e){return this.originalIndex.inArrayLookup(e)}get indexedKeysSet(){return this.originalIndex.indexedKeysSet}get valueMapData(){return this.originalIndex.valueMapData}};function Zr(t,e,r=se){for(let n of t.values())if(n.matchesField(e)&&n.matchesCompareOptions(r))return n.matchesDirection(r.direction)?n:new gt(n)}function qr(t,e,r,n,i,s,o,a,u){let c=r.map(h=>{let m=Ve(h.expression,n,"__select_results");return{compiledExpression:R(m),compareOptions:h.compareOptions}}),p=h=>{let m=h;return r.length>1?c.map(T=>T.compiledExpression(m)):r.length===1?c[0].compiledExpression(m):null},l=(h,m)=>{if(r.length>1){let T=h,O=m;for(let w=0;w<r.length;w++){let V=r[w],B=ct(V.compareOptions)(T[w],O[w]);if(B!==0)return B}return T.length-O.length}if(r.length===1){let T=r[0];return ct(T.compareOptions)(h,m)}return we(h,m)},f,d;if(a&&r.length===1){let h=r[0],m=h.expression;if(m.type==="ref"){let T=ce(t,m,i),O=T.collection,w=T.path[0];w&&ht(w,T.path,O,h.compareOptions,l);let V=R(new M(T.path),!0),g=(C,z)=>{let y=C&&V(C),x=z&&V(z);return l(y,x)},B=Zr(O.indexes,T.path,h.compareOptions);B&&B.supports("gt")&&(d={alias:m.path.length>1?String(m.path[0]):t.from.alias,offset:u??0,limit:a,comparator:g,valueExtractorForRawRow:V,index:B,orderBy:r},s[O.id]=d,f=z=>{s[O.id]={...s[O.id],dataNeeded:()=>{let y=z();return Math.max(0,d.limit-y)}}})}}return e.pipe(Rr(p,{limit:a,offset:u,comparator:l,setSizeCallback:f,setWindowFn:h=>{o(m=>{h(m),d&&(d.offset=m.offset??d.offset,d.limit=m.limit??d.limit)})}}))}function er(t){return t instanceof $?t.value:t}function _i(t,e,r){let n=t.source(e);if(n&&typeof n=="object"){let i=r,s=t.targetPath;if(s.length===0)for(let[o,a]of Object.entries(n))r[o]=er(a);else for(let o=0;o<s.length;o++){let a=s[o];if(o===s.length-1){let u=i[a]??={};if(typeof u=="object")for(let[c,p]of Object.entries(n))u[c]=er(p)}else{let u=i[a];(u==null||typeof u!="object")&&(i[a]={}),i=i[a]}}}}function Ai(t,e,r){let n=t.alias.split(".");if(n.length===1)r[t.alias]=t.compiled(e);else{let i=r;for(let s=0;s<n.length-1;s++){let o=n[s],a=i[o];(a==null||typeof a!="object")&&(i[o]={}),i=i[o]}i[n[n.length-1]]=er(t.compiled(e))}}function Ri([t,e],r){let n={};for(let i of r)i.kind==="merge"?_i(i,e,n):Ai(i,e,n);return[t,{...e,__select_results:n}]}function en(t,e,r){let n=[];return tn([],e,n),t.pipe(v(i=>Ri(i,n)))}function ki(t){return t.type==="agg"}function Bi(t){return t&&typeof t=="object"&&!Ft(t)}function tn(t,e,r){for(let[n,i]of Object.entries(e)){if(n.startsWith("__SPREAD_SENTINEL__")){let o=n.slice(19),a=o.lastIndexOf("__"),u=a>=0?o.slice(0,a):o,c=i&&typeof i=="object"&&"type"in i&&i.type==="ref";if(u.includes(".")||c){let p=[...t],l=c?i:new M(u.split(".")),f=R(l);r.push({kind:"merge",targetPath:p,source:f})}else{let p=u,l=[...t];r.push({kind:"merge",targetPath:l,source:f=>f[p]})}continue}let s=i;if(Bi(s)){tn([...t,n],s,r);continue}if(ki(s))r.push({kind:"field",alias:[...t,n].join("."),compiled:()=>null});else{if(s===void 0||!Ft(s)){r.push({kind:"field",alias:[...t,n].join("."),compiled:()=>s});continue}if(s instanceof $){let o=s.value;r.push({kind:"field",alias:[...t,n].join("."),compiled:()=>o})}else r.push({kind:"field",alias:[...t,n].join("."),compiled:R(s)})}}}function Tt(t,e,r,n,i,s,o,a,u=new WeakMap,c=new WeakMap){let p=u.get(t);if(p)return p;let{optimizedQuery:l,sourceWhereClauses:f}=Dr(t);c.set(l,t),rr(l,t,c);let d={...e},h={},m={},T={},{alias:O,input:w,collectionId:V}=Ei(l.from,d,r,n,i,s,o,a,u,c,h,m);T[O]=w;let g=w.pipe(v(([y,x])=>[y,{[O]:x}]));if(l.join&&l.join.length>0&&(g=Yr(g,l.join,T,V,O,d,u,c,r,n,i,s,o,a,t,Tt,h,m)),l.where&&l.where.length>0)for(let y of l.where){let x=ut(y),A=R(x);g=g.pipe(F(([L,Z])=>A(Z)))}if(l.fnWhere&&l.fnWhere.length>0)for(let y of l.fnWhere)g=g.pipe(F(([x,A])=>y(A)));if(l.distinct&&!l.fnSelect&&!l.select)throw new We;if(l.fnSelect?g=g.pipe(v(([y,x])=>{let A=l.fnSelect(x);return[y,{...x,__select_results:A}]})):l.select?g=en(g,l.select):g=g.pipe(v(([y,x])=>{let A=!l.join&&!l.groupBy?x[O]:x;return[y,{...x,__select_results:A}]})),l.groupBy&&l.groupBy.length>0?g=qt(g,l.groupBy,l.having,l.select,l.fnHaving):l.select&&Object.values(l.select).some(x=>x.type==="agg")&&(g=qt(g,[],l.having,l.select,l.fnHaving)),l.having&&(!l.groupBy||l.groupBy.length===0)&&!(l.select?Object.values(l.select).some(x=>x.type==="agg"):!1))throw new $e;if(l.fnHaving&&l.fnHaving.length>0&&(!l.groupBy||l.groupBy.length===0))for(let y of l.fnHaving)g=g.pipe(F(([x,A])=>y(A)));if(l.distinct&&(g=g.pipe(wr(([y,x])=>x.__select_results))),l.orderBy&&l.orderBy.length>0){let A=qr(t,g,l.orderBy,l.select||{},r[V],o,a,l.limit,l.offset).pipe(v(([Z,[vt,St]])=>{let fe=vt.__select_results,de=tr(fe);return[Z,[de,St]]})),L={collectionId:V,pipeline:A,sourceWhereClauses:f,aliasToCollectionId:h,aliasRemapping:m};return u.set(t,L),L}else if(l.limit!==void 0||l.offset!==void 0)throw new Ce;let C=g.pipe(v(([y,x])=>{let A=x.__select_results,L=tr(A);return[y,[L,void 0]]})),z={collectionId:V,pipeline:C,sourceWhereClauses:f,aliasToCollectionId:h,aliasRemapping:m};return u.set(t,z),z}function Ei(t,e,r,n,i,s,o,a,u,c,p,l){switch(t.type){case"collectionRef":{let f=e[t.alias];if(!f)throw new ae(t.alias,t.collection.id,Object.keys(e));return p[t.alias]=t.collection.id,{alias:t.alias,input:f,collectionId:t.collection.id}}case"queryRef":{let f=c.get(t.query)||t.query,d=Tt(f,e,r,n,i,s,o,a,u,c);Object.assign(p,d.aliasToCollectionId),Object.assign(l,d.aliasRemapping);let h=Object.keys(d.aliasToCollectionId).find(O=>d.aliasToCollectionId[O]===d.collectionId);h&&h!==t.alias&&(l[t.alias]=h);let T=d.pipeline.pipe(v(O=>{let[w,[V,g]]=O,B=tr(V);return[w,B]}));return{alias:t.alias,input:T,collectionId:d.collectionId}}default:throw new Le(t.type)}}function ji(t){return t instanceof $||t&&typeof t=="object"&&"type"in t&&t.type==="val"}function tr(t){return ji(t)?t.value:t}function rr(t,e,r){if(t.from.type==="queryRef"&&e.from.type==="queryRef"&&(r.set(t.from.query,e.from.query),rr(t.from.query,e.from.query,r)),t.join&&e.join)for(let n=0;n<t.join.length&&n<e.join.length;n++){let i=t.join[n],s=e.join[n];i.from.type==="queryRef"&&s.from.type==="queryRef"&&(r.set(i.from.query,s.from.query),rr(i.from.query,s.from.query,r))}}var yt=class extends Map{constructor(e,r){super(r),this.defaultValue=e}get(e){return this.has(e)?super.get(e):this.defaultValue()}update(e,r){let n=this.get(e),i=r(n);return this.set(e,i),i}},nr=3e4;function xt(t,e){if(e.length<=nr)t.push(...e);else for(let r=0;r<e.length;r+=nr){let n=e.slice(r,r+nr);t.push(...n)}}var ir=class{constructor(){this.objectIds=new WeakMap,this.nextId=0}getId(e){if(typeof e!="object"||e===null){let r=String(e),n=0;for(let i=0;i<r.length;i++){let s=r.charCodeAt(i);n=(n<<5)-n+s,n=n&n}return n}return this.objectIds.has(e)||this.objectIds.set(e,this.nextId++),this.objectIds.get(e)}getStringId(e){return e===null?"null":e===void 0?"undefined":typeof e!="object"?`str_${String(e)}`:`obj_${this.getId(e)}`}},Ot=new ir;var zi=_(),Di=_(),Fi=_(),Ni=_(),Wi=_();function _(){return Math.random()*(2**31-1)>>>0}var rn=new ArrayBuffer(8),$i=new DataView(rn),X=new Uint8Array(rn),pe=class{constructor(){this.hash=zi,this.length=0,this.carry=0,this.carryBytes=0}_mix(e){e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e,this.hash=this.hash<<13|this.hash>>>19,this.hash=Math.imul(this.hash,5)+3864292196}_writeByte(e){this.carry|=(e&255)<<8*this.carryBytes,this.carryBytes++,this.length++,this.carryBytes===4&&(this._mix(this.carry>>>0),this.carry=0,this.carryBytes=0)}update(e){switch(typeof e){case"symbol":{this.update(Wi);let r=e.description;if(!r)return;for(let n=0;n<r.length;n++){let i=r.charCodeAt(n);this._writeByte(i&255),this._writeByte(i>>>8&255)}return}case"string":this.update(Di);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);this._writeByte(n&255),this._writeByte(n>>>8&255)}return;case"number":$i.setFloat64(0,e,!0),this._writeByte(X[0]),this._writeByte(X[1]),this._writeByte(X[2]),this._writeByte(X[3]),this._writeByte(X[4]),this._writeByte(X[5]),this._writeByte(X[6]),this._writeByte(X[7]);return;case"bigint":{let r=e;for(r<0n?(r=-r,this.update(Ni)):this.update(Fi);r>0n;)this._writeByte(Number(r&0xffn)),r>>=8n;e===0n&&this._writeByte(0);return}default:throw new TypeError(`Unsupported input type: ${typeof e}`)}}digest(){if(this.carryBytes>0){let e=this.carry>>>0;e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e}return this.hash^=this.length,this.hash^=this.hash>>>16,this.hash=Math.imul(this.hash,2246822507),this.hash^=this.hash>>>13,this.hash=Math.imul(this.hash,3266489909),this.hash^=this.hash>>>16,this.hash>>>0}};var Ci=_(),Li=_(),Hi=_(),Ui=_(),Ji=_(),Gi=_(),Qi=_(),Yi=_(),Xi=_(),Zi=_(),qi=_(),ve=new WeakMap;function sn(t){let e=new pe;return on(e,t),e.digest()}function es(t){let e=ve.get(t);if(e!==void 0)return e;let r;if(t instanceof Date)r=ts(t);else{let n=t,i=Yi;if(t instanceof Array&&(i=Xi),t instanceof Map&&(i=Zi,n=[...t.entries()]),t instanceof Set&&(i=qi,n=[...t.entries()]),typeof Buffer<"u"&&t instanceof Buffer||t instanceof Uint8Array||t instanceof File)return an(t);r=rs(n,i)}return ve.set(t,r),r}function ts(t){let e=new pe;return e.update(Qi),e.update(t.getTime()),e.digest()}function rs(t,e){let r=new pe;r.update(e);let n=Object.keys(t);n.sort(is);for(let i of n)r.update(Ji),r.update(i),on(r,t[i]);return r.digest()}function on(t,e){if(e===null){t.update(Hi);return}switch(typeof e){case"undefined":t.update(Ui);return;case"boolean":t.update(e?Ci:Li);return;case"number":t.update(isNaN(e)?NaN:e===0?0:e);return;case"bigint":case"string":case"symbol":t.update(e);return;case"object":t.update(ns(e));return;case"function":t.update(an(e));return;default:console.warn(`Ignored input during hashing because it is of type ${typeof e} which is not supported`)}}function ns(t){let e=ve.get(t);return e===void 0&&(e=es(t)),e}var nn=1;function an(t){let e=ve.get(t);return e===void 0&&(e=nn^Gi,nn++,ve.set(t,e)),e}function is(t,e){return t.localeCompare(e)}var Se=class t{#e;constructor(e=[]){this.#e=e}toString(e=!1){return`MultiSet(${JSON.stringify(this.#e,null,e?2:void 0)})`}toJSON(){return JSON.stringify(Array.from(this.getInner()))}static fromJSON(e){return new t(JSON.parse(e))}map(e){return new t(this.#e.map(([r,n])=>[e(r),n]))}filter(e){return new t(this.#e.filter(([r,n])=>e(r)))}negate(){return new t(this.#e.map(([e,r])=>[e,-r]))}concat(e){let r=[];return xt(r,this.#e),xt(r,e.getInner()),new t(r)}consolidate(){if(this.#e.length>0){let e=this.#e[0]?.[0];if(Array.isArray(e)&&e.length===2)return this.#t()}return this.#r()}#t(){let e=new Map,r=new Map,n=s=>{if(s.length!==2)throw new Error("Expected tuple of length 2");let[o,a]=s;return`${Ot.getStringId(o)}|${Ot.getStringId(a)}`};for(let[s,o]of this.#e){if(!Array.isArray(s)||s.length!==2)return this.#r();let[a,u]=s;if(typeof a!="string"&&typeof a!="number")return this.#r();let c;Array.isArray(u)&&u.length===2?c=n(u):c=Ot.getStringId(u);let p=a+"|"+c;e.set(p,(e.get(p)||0)+o),r.has(p)||r.set(p,s)}let i=[];for(let[s,o]of e)o!==0&&i.push([r.get(s),o]);return new t(i)}#r(){let e=new yt(()=>0),r=new Map,n=!1,i=!1,s=!1;for(let[u,c]of this.#e)if(typeof u=="string")n=!0;else if(typeof u=="number")i=!0;else{s=!0;break}let o=s||n&&i;for(let[u,c]of this.#e){let p=o?sn(u):u;o&&!r.has(p)&&r.set(p,u),e.update(p,l=>l+c)}let a=[];for(let[u,c]of e.entries())if(c!==0){let p=o?r.get(u):u;a.push([p,c])}return new t(a)}extend(e){let r=e instanceof t?e.getInner():e;xt(this.#e,r)}add(e,r){r!==0&&this.#e.push([e,r])}getInner(){return this.#e}};var sr=class{#e;constructor(e){this.#e=e}drain(){let e=[...this.#e].reverse();return this.#e.length=0,e}isEmpty(){return this.#e.length===0}},wt=class{#e=[];sendData(e){e instanceof Se||(e=new Se(e));for(let r of this.#e)r.unshift(e)}newReader(){let e=[];return this.#e.push(e),new sr(e)}};var Vt=class{#e=[];#t=0;#r=!1;constructor(){}#n(){if(this.#r)throw new Error("Graph already finalized")}getNextOperatorId(){return this.#n(),this.#t++}newInput(){this.#n();let e=new wt;return new ar(this,e)}addOperator(e){this.#n(),this.#e.push(e)}finalize(){this.#n(),this.#r=!0}step(){if(!this.#r)throw new Error("Graph not finalized");for(let e of this.#e)e.run()}pendingWork(){return this.#e.some(e=>e.hasPendingWork())}run(){for(;this.pendingWork();)this.step()}},or=class{#e;#t;constructor(e,r){this.#e=e,this.#t=r}connectReader(){return this.#t.newReader()}get writer(){return this.#t}get graph(){return this.#e}pipe(...e){return e.reduce((r,n)=>n(r),this)}},ar=class extends or{sendData(e){this.writer.sendData(e)}};console.log(Tt,Vt);

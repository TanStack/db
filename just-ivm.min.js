var re=Object.defineProperty;var ne=(n,t)=>{for(var e in t)re(n,e,{get:t[e],enumerable:!0})};var gt={};ne(gt,{ConcatOperator:()=>P,ConsolidateOperator:()=>H,CountOperator:()=>G,D2:()=>rt,DebugOperator:()=>U,DistinctOperator:()=>$,FilterOperator:()=>J,JoinOperator:()=>q,MapOperator:()=>j,MultiSet:()=>d,NegateOperator:()=>F,OutputOperator:()=>L,ReduceOperator:()=>B,RootStreamBuilder:()=>W,StreamBuilder:()=>l,TapOperator:()=>k,TopKWithFractionalIndexOperator:()=>Y,antiJoin:()=>Ct,concat:()=>Kt,consolidate:()=>S,count:()=>jt,debug:()=>Nt,distinct:()=>bt,filter:()=>Rt,filterBy:()=>Qt,fullJoin:()=>Wt,getIndex:()=>z,getValue:()=>C,groupBy:()=>vt,groupByOperators:()=>Bt,indexedValue:()=>at,innerJoin:()=>R,join:()=>A,keyBy:()=>Tt,leftJoin:()=>zt,map:()=>g,negate:()=>_t,orderBy:()=>Zt,orderByWithFractionalIndex:()=>Xt,orderByWithFractionalIndexBase:()=>mt,orderByWithIndex:()=>Yt,output:()=>Vt,pipe:()=>Et,reduce:()=>E,rekey:()=>Jt,rightJoin:()=>Dt,tap:()=>At,topK:()=>ot,topKWithFractionalIndex:()=>ft,topKWithIndex:()=>st,unkey:()=>kt});var Q=class extends Map{constructor(t,e){super(e),this.defaultValue=t}get(t){return this.has(t)?super.get(t):this.defaultValue()}update(t,e){let r=this.get(t),i=e(r);return this.set(t,i),i}},ht=3e4;function tt(n,t){if(t.length<=ht)n.push(...t);else for(let e=0;e<t.length;e+=ht){let r=t.slice(e,e+ht);n.push(...r)}}function yt(n,t,e){let r=0,i=n.length;for(;r<i;){let o=Math.floor((r+i)/2),s=e(n[o],t);if(s<0)r=o+1;else if(s>0)i=o;else return o}return r}var pt=class{constructor(){this.objectIds=new WeakMap,this.nextId=0}getId(t){if(typeof t!="object"||t===null){let e=String(t),r=0;for(let i=0;i<e.length;i++){let o=e.charCodeAt(i);r=(r<<5)-r+o,r=r&r}return r}return this.objectIds.has(t)||this.objectIds.set(t,this.nextId++),this.objectIds.get(t)}getStringId(t){return t===null?"null":t===void 0?"undefined":typeof t!="object"?`str_${String(t)}`:`obj_${this.getId(t)}`}},_=new pt;function wt(n,t){let[e,r]=n,[i,o]=t,s=[...X(e,Math.min(r,i)),...X(Math.max(e,o),r)],u=[...X(i,Math.min(o,e)),...X(Math.max(i,r),o)];return{onlyInA:s,onlyInB:u}}function X(n,t){let e=[];for(let r=n;r<t;r++)e.push(r);return e}var ie=w(),oe=w(),se=w(),ce=w(),ue=w();function w(){return Math.random()*(2**31-1)>>>0}var Mt=new ArrayBuffer(8),ae=new DataView(Mt),O=new Uint8Array(Mt),K=class{constructor(){this.hash=ie,this.length=0,this.carry=0,this.carryBytes=0}_mix(t){t=Math.imul(t,3432918353),t=t<<15|t>>>17,t=Math.imul(t,461845907),this.hash^=t,this.hash=this.hash<<13|this.hash>>>19,this.hash=Math.imul(this.hash,5)+3864292196}_writeByte(t){this.carry|=(t&255)<<8*this.carryBytes,this.carryBytes++,this.length++,this.carryBytes===4&&(this._mix(this.carry>>>0),this.carry=0,this.carryBytes=0)}update(t){switch(typeof t){case"symbol":{this.update(ue);let e=t.description;if(!e)return;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);this._writeByte(i&255),this._writeByte(i>>>8&255)}return}case"string":this.update(oe);for(let e=0;e<t.length;e++){let r=t.charCodeAt(e);this._writeByte(r&255),this._writeByte(r>>>8&255)}return;case"number":ae.setFloat64(0,t,!0),this._writeByte(O[0]),this._writeByte(O[1]),this._writeByte(O[2]),this._writeByte(O[3]),this._writeByte(O[4]),this._writeByte(O[5]),this._writeByte(O[6]),this._writeByte(O[7]);return;case"bigint":{let e=t;for(e<0n?(e=-e,this.update(ce)):this.update(se);e>0n;)this._writeByte(Number(e&0xffn)),e>>=8n;t===0n&&this._writeByte(0);return}default:throw new TypeError(`Unsupported input type: ${typeof t}`)}}digest(){if(this.carryBytes>0){let t=this.carry>>>0;t=Math.imul(t,3432918353),t=t<<15|t>>>17,t=Math.imul(t,461845907),this.hash^=t}return this.hash^=this.length,this.hash^=this.hash>>>16,this.hash=Math.imul(this.hash,2246822507),this.hash^=this.hash>>>13,this.hash=Math.imul(this.hash,3266489909),this.hash^=this.hash>>>16,this.hash>>>0}};var fe=w(),le=w(),he=w(),pe=w(),de=w(),me=w(),ge=w(),ye=w(),we=w(),Me=w(),xe=w(),D=new WeakMap;function y(n){let t=new K;return It(t,n),t.digest()}function Ie(n){let t=D.get(n);if(t!==void 0)return t;let e;if(n instanceof Date)e=Oe(n);else{let r=n,i=ye;if(n instanceof Array&&(i=we),n instanceof Map&&(i=Me,r=[...n.entries()]),n instanceof Set&&(i=xe,r=[...n.entries()]),typeof Buffer<"u"&&n instanceof Buffer||n instanceof Uint8Array||n instanceof File)return Ot(n);e=Se(r,i)}return D.set(n,e),e}function Oe(n){let t=new K;return t.update(ge),t.update(n.getTime()),t.digest()}function Se(n,t){let e=new K;e.update(t);let r=Object.keys(n);r.sort(Be);for(let i of r)e.update(de),e.update(i),It(e,n[i]);return e.digest()}function It(n,t){if(t===null){n.update(he);return}switch(typeof t){case"undefined":n.update(pe);return;case"boolean":n.update(t?fe:le);return;case"number":n.update(isNaN(t)?NaN:t===0?0:t);return;case"bigint":case"string":case"symbol":n.update(t);return;case"object":n.update(ve(t));return;case"function":n.update(Ot(t));return;default:console.warn(`Ignored input during hashing because it is of type ${typeof t} which is not supported`)}}function ve(n){let t=D.get(n);return t===void 0&&(t=Ie(n)),t}var xt=1;function Ot(n){let t=D.get(n);return t===void 0&&(t=xt^me,xt++,D.set(n,t)),t}function Be(n,t){return n.localeCompare(t)}var d=class n{#t;constructor(t=[]){this.#t=t}toString(t=!1){return`MultiSet(${JSON.stringify(this.#t,null,t?2:void 0)})`}toJSON(){return JSON.stringify(Array.from(this.getInner()))}static fromJSON(t){return new n(JSON.parse(t))}map(t){return new n(this.#t.map(([e,r])=>[t(e),r]))}filter(t){return new n(this.#t.filter(([e,r])=>t(e)))}negate(){return new n(this.#t.map(([t,e])=>[t,-e]))}concat(t){let e=[];return tt(e,this.#t),tt(e,t.getInner()),new n(e)}consolidate(){if(this.#t.length>0){let t=this.#t[0]?.[0];if(Array.isArray(t)&&t.length===2)return this.#e()}return this.#r()}#e(){let t=new Map,e=new Map,r=o=>{if(o.length!==2)throw new Error("Expected tuple of length 2");let[s,u]=o;return`${_.getStringId(s)}|${_.getStringId(u)}`};for(let[o,s]of this.#t){if(!Array.isArray(o)||o.length!==2)return this.#r();let[u,c]=o;if(typeof u!="string"&&typeof u!="number")return this.#r();let a;Array.isArray(c)&&c.length===2?a=r(c):a=_.getStringId(c);let f=u+"|"+a;t.set(f,(t.get(f)||0)+s),e.has(f)||e.set(f,o)}let i=[];for(let[o,s]of t)s!==0&&i.push([e.get(o),s]);return new n(i)}#r(){let t=new Q(()=>0),e=new Map,r=!1,i=!1,o=!1;for(let[c,a]of this.#t)if(typeof c=="string")r=!0;else if(typeof c=="number")i=!0;else{o=!0;break}let s=o||r&&i;for(let[c,a]of this.#t){let f=s?y(c):c;s&&!e.has(f)&&e.set(f,c),t.update(f,h=>h+a)}let u=[];for(let[c,a]of t.entries())if(a!==0){let f=s?e.get(c):c;u.push([f,a])}return new n(u)}extend(t){let e=t instanceof n?t.getInner():t;tt(this.#t,e)}add(t,e){e!==0&&this.#t.push([t,e])}getInner(){return this.#t}};var dt=class{#t;constructor(t){this.#t=t}drain(){let t=[...this.#t].reverse();return this.#t.length=0,t}isEmpty(){return this.#t.length===0}},p=class{#t=[];sendData(t){t instanceof d||(t=new d(t));for(let e of this.#t)e.unshift(t)}newReader(){let t=[];return this.#t.push(t),new dt(t)}},et=class{constructor(t,e,r){this.id=t,this.inputs=e,this.output=r}hasPendingWork(){return this.inputs.some(t=>!t.isEmpty())}},M=class extends et{constructor(t,e,r){super(t,[e],r),this.id=t}inputMessages(){return this.inputs[0].drain()}},N=class extends et{constructor(t,e,r,i){super(t,[e,r],i),this.id=t}inputAMessages(){return this.inputs[0].drain()}inputBMessages(){return this.inputs[1].drain()}},x=class extends M{run(){for(let t of this.inputMessages())this.output.sendData(this.inner(t))}};var rt=class{#t=[];#e=0;#r=!1;constructor(){}#n(){if(this.#r)throw new Error("Graph already finalized")}getNextOperatorId(){return this.#n(),this.#e++}newInput(){this.#n();let t=new p;return new W(this,t)}addOperator(t){this.#n(),this.#t.push(t)}finalize(){this.#n(),this.#r=!0}step(){if(!this.#r)throw new Error("Graph not finalized");for(let t of this.#t)t.run()}pendingWork(){return this.#t.some(t=>t.hasPendingWork())}run(){for(;this.pendingWork();)this.step()}},l=class{#t;#e;constructor(t,e){this.#t=t,this.#e=e}connectReader(){return this.#e.newReader()}get writer(){return this.#e}get graph(){return this.#t}pipe(...t){return t.reduce((e,r)=>r(e),this)}},W=class extends l{sendData(t){this.writer.sendData(t)}};var j=class extends x{#t;constructor(t,e,r,i){super(t,e,r),this.#t=i}inner(t){return t.map(this.#t)}};function g(n){return t=>{let e=new l(t.graph,new p),r=new j(t.graph.getNextOperatorId(),t.connectReader(),e.writer,n);return t.graph.addOperator(r),e}}var b=Symbol("NO_PREFIX"),it=class extends Map{addValue(t,e){if(e===0)return this.size===0;let r=T(t),i=this.get(r);if(nt(i)){let[o,s]=i;if(T(o)!==r)throw new Error("Mismatching prefixes, this should never happen");if(o===t||y(o)===y(t)){let c=s+e;c===0?this.delete(r):this.set(r,[t,c])}else{let c=new v;c.set(y(o),i),c.set(y(t),[t,e]),this.set(r,c)}}else i===void 0?this.set(r,[t,e]):i.addValue(t,e)&&this.delete(r);return this.size===0}},v=class extends Map{addValue(t,e){if(e===0)return this.size===0;let r=y(t),i=this.get(r);if(i){let[,o]=i,s=o+e;s===0?this.delete(r):this.set(r,[t,s])}else this.set(r,[t,e]);return this.size===0}},I=class n{#t;#e=new Map;constructor(){this.#t=new Map}static fromMultiSets(t){let e=new n;for(let r of t)for(let[i,o]of r.getInner()){let[s,u]=i;e.addValue(s,[u,o])}return e}toString(t=!1){return`Index(${JSON.stringify([...this.entries()],void 0,t?2:void 0)})`}get size(){return this.#t.size}has(t){return this.#t.has(t)}hasPresence(t){return(this.#e.get(t)||0)!==0}getConsolidatedMultiplicity(t){return this.#e.get(t)||0}getPresenceKeys(){return this.#e.keys()}get(t){return[...this.getIterator(t)]}*getIterator(t){let e=this.#t.get(t);if(nt(e))yield e;else{if(e===void 0)return;if(e instanceof v)for(let r of e.values())yield r;else for(let r of e.values())if(nt(r))yield r;else for(let i of r.values())yield i}}*entries(){for(let t of this.#t.keys())for(let e of this.getIterator(t))yield[t,e]}*entriesIterators(){for(let t of this.#t.keys())yield[t,this.getIterator(t)]}addValue(t,e){let[r,i]=e;if(i===0)return;let o=(this.#e.get(t)||0)+i;o===0?this.#e.delete(t):this.#e.set(t,o);let s=this.#t.get(t);if(s===void 0){this.#t.set(t,e);return}if(nt(s)){this.#r(t,s,r,i);return}if(s instanceof v){let u=T(r);if(u!==b){let c=new it;c.set(b,s),c.set(u,e),this.#t.set(t,c)}else s.addValue(r,i)&&this.#t.delete(t)}else s.addValue(r,i)&&this.#t.delete(t)}#r(t,e,r,i){let[o,s]=e;if(o===r){let a=s+i;a===0?this.#t.delete(t):this.#t.set(t,[r,a]);return}let u=T(r),c=T(o);if(c===u&&(o===r||y(o)===y(r))){let a=s+i;a===0?this.#t.delete(t):this.#t.set(t,[r,a]);return}if(c===b&&u===b){let a=new v;a.set(y(o),e),a.set(y(r),[r,i]),this.#t.set(t,a)}else{let a=new it;if(c===u){let f=new v;f.set(y(o),e),f.set(y(r),[r,i]),a.set(c,f)}else a.set(c,e),a.set(u,[r,i]);this.#t.set(t,a)}}append(t){for(let[e,r]of t.entries())this.addValue(e,r)}join(t){let e=[];if(this.size<=t.size)for(let[r,i]of this.entriesIterators()){if(!t.has(r))continue;let o=t.get(r);for(let[s,u]of i)for(let[c,a]of o)u!==0&&a!==0&&e.push([[r,[s,c]],u*a])}else for(let[r,i]of t.entriesIterators()){if(!this.has(r))continue;let o=this.get(r);for(let[s,u]of i)for(let[c,a]of o)a!==0&&u!==0&&e.push([[r,[c,s]],a*u])}return new d(e)}};function T(n){return Array.isArray(n)&&(typeof n[0]=="string"||typeof n[0]=="number"||typeof n[0]=="bigint")?n[0]:b}function nt(n){return Array.isArray(n)}var B=class extends M{#t=new I;#e=new I;#r;constructor(t,e,r,i){super(t,e,r),this.#r=i}run(){let t=new Set;for(let r of this.inputMessages())for(let[i,o]of r.getInner()){let[s,u]=i;this.#t.addValue(s,[u,o]),t.add(s)}let e=[];for(let r of t){let i=this.#t.get(r),o=this.#e.get(r),s=this.#r(i),u=new Map,c=new Map;for(let[a,f]of s){let h=u.get(a)??0;u.set(a,h+f)}for(let[a,f]of o){let h=c.get(a)??0;c.set(a,h+f)}for(let[a,f]of c)u.has(a)||(e.push([[r,a],-f]),this.#e.addValue(r,[a,-f]));for(let[a,f]of u)c.has(a)||f!==0&&(e.push([[r,a],f]),this.#e.addValue(r,[a,f]));for(let[a,f]of u){let h=c.get(a);if(h!==void 0){let m=f-h;m!==0&&(e.push([[r,a],m]),this.#e.addValue(r,[a,m]))}}}e.length>0&&this.output.sendData(new d(e))}};function E(n){return t=>{let e=new l(t.graph,new p),r=new B(t.graph.getNextOperatorId(),t.connectReader(),e.writer,n);return t.graph.addOperator(r),e}}function St(n){return"pipe"in n}function vt(n,t={}){let e=Object.fromEntries(Object.entries(t).filter(([r,i])=>!St(i)));return Object.fromEntries(Object.entries(t).filter(([r,i])=>St(i))),r=>{let i="__original_key__";return r.pipe(g(u=>{let c=n(u),a=JSON.stringify(c),f={};f[i]=c;for(let[h,m]of Object.entries(e))f[h]=m.preMap(u);return[a,f]})).pipe(E(u=>{let c=0;for(let[h,m]of u)c+=m;if(c<=0)return[];let a={},f=u[0]?.[0]?.[i];a[i]=f;for(let[h,m]of Object.entries(e)){let lt=u.map(([te,ee])=>[te[h],ee]);a[h]=m.reduce(lt)}return[[a,1]]})).pipe(g(([u,c])=>{let a=c[i],f={};Object.assign(f,a);for(let[h,m]of Object.entries(e))m.postMap?f[h]=m.postMap(c[h]):f[h]=c[h];return[u,f]}))}}function Ee(n=t=>t){return{preMap:t=>n(t),reduce:t=>{let e=0;for(let[r,i]of t)e+=r*i;return e}}}function Ae(n=t=>t){return{preMap:t=>n(t)==null?0:1,reduce:t=>{let e=0;for(let[r,i]of t)e+=r*i;return e}}}function Re(n=t=>t){return{preMap:t=>({sum:n(t),count:0}),reduce:t=>{let e=0,r=0;for(let[i,o]of t)e+=i.sum*o,r+=o;return{sum:e,count:r}},postMap:t=>t.sum/t.count}}function _e(n){let t=n??(e=>e);return{preMap:e=>t(e),reduce:e=>{let r;for(let[i,o]of e)(!r||i&&i<r)&&(r=i);return r}}}function Ke(n){let t=n??(e=>e);return{preMap:e=>t(e),reduce:e=>{let r;for(let[i,o]of e)(!r||i&&i>r)&&(r=i);return r}}}function Ne(n=t=>t){return{preMap:t=>[n(t)],reduce:t=>{let e=[];for(let[r,i]of t)for(let o of r)for(let s=0;s<i;s++)e.push(o);return e.length===0?[]:(e.sort((r,i)=>r-i),e)},postMap:t=>{if(t.length===0)return 0;let e=Math.floor(t.length/2);return t.length%2===0?(t[e-1]+t[e])/2:t[e]}}}function Ve(n=t=>t){return{preMap:t=>{let e=n(t),r=new Map;return r.set(e,1),r},reduce:t=>{let e=new Map;for(let[r,i]of t)for(let[o,s]of r.entries()){let u=e.get(o)||0;e.set(o,u+s*i)}return e},postMap:t=>{if(t.size===0)return 0;let e=0,r=0;for(let[i,o]of t.entries())o>r&&(r=o,e=i);return e}}}var Bt={sum:Ee,count:Ae,avg:Re,min:_e,max:Ke,median:Ne,mode:Ve};function Et(...n){return t=>t.pipe(...n)}var k=class extends x{#t;constructor(t,e,r,i){super(t,e,r),this.#t=i}inner(t){return this.#t(t),t}};function At(n){return t=>{let e=new l(t.graph,new p),r=new k(t.graph.getNextOperatorId(),t.connectReader(),e.writer,n);return t.graph.addOperator(r),e}}var J=class extends x{#t;constructor(t,e,r,i){super(t,e,r),this.#t=i}inner(t){return t.filter(this.#t)}};function Rt(n){return t=>{let e=new l(t.graph,new p),r=new J(t.graph.getNextOperatorId(),t.connectReader(),e.writer,n);return t.graph.addOperator(r),e}}var F=class extends x{inner(t){return t.negate()}};function _t(){return n=>{let t=new l(n.graph,new p),e=new F(n.graph.getNextOperatorId(),n.connectReader(),t.writer);return n.graph.addOperator(e),t}}var P=class extends N{run(){for(let t of this.inputAMessages())this.output.sendData(t);for(let t of this.inputBMessages())this.output.sendData(t)}};function Kt(n){return t=>{if(t.graph!==n.graph)throw new Error("Cannot concat streams from different graphs");let e=new l(t.graph,new p),r=new P(t.graph.getNextOperatorId(),t.connectReader(),n.connectReader(),e.writer);return t.graph.addOperator(r),e}}var U=class extends M{#t;#e;constructor(t,e,r,i,o=!1){super(t,e,r),this.#t=i,this.#e=o}run(){for(let t of this.inputMessages())console.log(`debug ${this.#t} data: ${t.toString(this.#e)}`),this.output.sendData(t)}};function Nt(n,t=!1){return e=>{let r=new l(e.graph,new p),i=new U(e.graph.getNextOperatorId(),e.connectReader(),r.writer,n,t);return e.graph.addOperator(i),r}}var L=class extends M{#t;constructor(t,e,r,i){super(t,e,r),this.#t=i}run(){for(let t of this.inputMessages())this.#t(t),this.output.sendData(t)}};function Vt(n){return t=>{let e=new l(t.graph,new p),r=new L(t.graph.getNextOperatorId(),t.connectReader(),e.writer,n);return t.graph.addOperator(r),e}}var H=class extends M{run(){let t=this.inputMessages();if(t.length===0)return;let e=new d;for(let i of t)e.extend(i);let r=e.consolidate();r.getInner().length>0&&this.output.sendData(r)}};function S(){return n=>{let t=new l(n.graph,new p),e=new H(n.graph.getNextOperatorId(),n.connectReader(),t.writer);return n.graph.addOperator(e),t}}var q=class extends N{#t=new I;#e=new I;#r;constructor(t,e,r,i,o="inner"){super(t,e,r,i),this.#r=o}run(){let t=I.fromMultiSets(this.inputAMessages()),e=I.fromMultiSets(this.inputBMessages());if(t.size===0&&e.size===0)return;let r=new d;this.#r!=="anti"&&this.emitInnerResults(t,e,r),(this.#r==="left"||this.#r==="full"||this.#r==="anti")&&this.emitLeftOuterResults(t,e,r),(this.#r==="right"||this.#r==="full")&&this.emitRightOuterResults(t,e,r),this.#t.append(t),this.#e.append(e),r.getInner().length>0&&this.output.sendData(r)}emitInnerResults(t,e,r){t.size>0&&r.extend(t.join(this.#e)),e.size>0&&r.extend(this.#t.join(e)),t.size>0&&e.size>0&&r.extend(t.join(e))}emitLeftOuterResults(t,e,r){if(t.size>0)for(let[i,o]of t.entriesIterators()){let s=this.#e.getConsolidatedMultiplicity(i),u=e.getConsolidatedMultiplicity(i);if(s+u===0)for(let[a,f]of o)f!==0&&r.add([i,[a,null]],f)}if(e.size>0)for(let i of e.getPresenceKeys()){let o=this.#e.getConsolidatedMultiplicity(i),s=e.getConsolidatedMultiplicity(i);if(s===0)continue;let u=o+s;if(o===0==(u===0))continue;let c=o===0;for(let[a,f]of this.#t.getIterator(i))f!==0&&r.add([i,[a,null]],c?-f:+f)}}emitRightOuterResults(t,e,r){if(e.size>0)for(let[i,o]of e.entriesIterators()){let s=this.#t.getConsolidatedMultiplicity(i),u=t.getConsolidatedMultiplicity(i);if(s+u===0)for(let[a,f]of o)f!==0&&r.add([i,[null,a]],f)}if(t.size>0)for(let i of t.getPresenceKeys()){let o=this.#t.getConsolidatedMultiplicity(i),s=t.getConsolidatedMultiplicity(i);if(s===0)continue;let u=o+s;if(o===0==(u===0))continue;let c=o===0;for(let[a,f]of this.#e.getIterator(i))f!==0&&r.add([i,[null,a]],c?-f:+f)}}};function A(n,t="inner"){return e=>{if(e.graph!==n.graph)throw new Error("Cannot join streams from different graphs");let r=new l(e.graph,new p),i=new q(e.graph.getNextOperatorId(),e.connectReader(),n.connectReader(),r.writer,t);return e.graph.addOperator(i),r}}function R(n){return A(n,"inner")}function Ct(n){return A(n,"anti")}function zt(n){return A(n,"left")}function Dt(n){return A(n,"right")}function Wt(n){return A(n,"full")}var G=class extends B{constructor(t,e,r){let i=o=>{let s=0;for(let[u,c]of o)s+=c;return[[s,1]]};super(t,e,r,i)}};function jt(){return n=>{let t=new l(n.graph,new p),e=new G(n.graph.getNextOperatorId(),n.connectReader(),t.writer);return n.graph.addOperator(e),t}}var $=class extends M{#t;#e;constructor(t,e,r,i=o=>o){super(t,e,r),this.#t=i,this.#e=new Map}run(){let t=new Map;for(let r of this.inputMessages())for(let[i,o]of r.getInner()){let s=y(this.#t(i)),c=(t.get(s)?.[0]??this.#e.get(s)??0)+o;t.set(s,[c,i])}let e=[];for(let[r,[i,o]]of t.entries()){let s=this.#e.get(r)??0;i===0?this.#e.delete(r):this.#e.set(r,i),s<=0&&i>0?e.push([[y(this.#t(o)),o[1]],1]):s>0&&i<=0&&e.push([[y(this.#t(o)),o[1]],-1])}e.length>0&&this.output.sendData(new d(e))}};function bt(n=t=>t){return t=>{let e=new l(t.graph,new p),r=new $(t.graph.getNextOperatorId(),t.connectReader(),e.writer,n);return t.graph.addOperator(r),e}}function Tt(n){return g(t=>[n(t),t])}function kt(){return g(([n,t])=>t)}function Jt(n){return g(([t,e])=>[n(e),e])}function ot(n,t){let e=t?.limit??1/0,r=t?.offset??0;return i=>i.pipe(E(s=>new d(s).consolidate().getInner().sort((a,f)=>n(a[0],f[0])).slice(r,r+e)))}function st(n,t){let e=t?.limit??1/0,r=t?.offset??0;return i=>i.pipe(E(s=>{let u=new d(s).consolidate(),c=r;return u.getInner().sort((f,h)=>n(f[0],h[0])).slice(r,r+e).map(([f,h])=>[[f,c++],h])}))}var Ce="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function V(n,t,e){let r=e[0];if(t!=null&&n>=t)throw new Error(n+" >= "+t);if(n.slice(-1)===r||t&&t.slice(-1)===r)throw new Error("trailing zero");if(t){let s=0;for(;(n[s]||r)===t[s];)s++;if(s>0)return t.slice(0,s)+V(n.slice(s),t.slice(s),e)}let i=n?e.indexOf(n[0]):0,o=t!=null?e.indexOf(t[0]):e.length;if(o-i>1){let s=Math.round(.5*(i+o));return e[s]}else return t&&t.length>1?t.slice(0,1):e[i]+V(n.slice(1),null,e)}function Ut(n){if(n.length!==Lt(n[0]))throw new Error("invalid integer part of order key: "+n)}function Lt(n){if(n>="a"&&n<="z")return n.charCodeAt(0)-97+2;if(n>="A"&&n<="Z")return 90-n.charCodeAt(0)+2;throw new Error("invalid order key head: "+n)}function Z(n){let t=Lt(n[0]);if(t>n.length)throw new Error("invalid order key: "+n);return n.slice(0,t)}function Ft(n,t){if(n==="A"+t[0].repeat(26))throw new Error("invalid order key: "+n);let e=Z(n);if(n.slice(e.length).slice(-1)===t[0])throw new Error("invalid order key: "+n)}function Pt(n,t){Ut(n);let[e,...r]=n.split(""),i=!0;for(let o=r.length-1;i&&o>=0;o--){let s=t.indexOf(r[o])+1;s===t.length?r[o]=t[0]:(r[o]=t[s],i=!1)}if(i){if(e==="Z")return"a"+t[0];if(e==="z")return null;let o=String.fromCharCode(e.charCodeAt(0)+1);return o>"a"?r.push(t[0]):r.pop(),o+r.join("")}else return e+r.join("")}function ze(n,t){Ut(n);let[e,...r]=n.split(""),i=!0;for(let o=r.length-1;i&&o>=0;o--){let s=t.indexOf(r[o])-1;s===-1?r[o]=t.slice(-1):(r[o]=t[s],i=!1)}if(i){if(e==="a")return"Z"+t.slice(-1);if(e==="A")return null;let o=String.fromCharCode(e.charCodeAt(0)-1);return o<"Z"?r.push(t.slice(-1)):r.pop(),o+r.join("")}else return e+r.join("")}function Ht(n,t,e=Ce){if(n!=null&&Ft(n,e),t!=null&&Ft(t,e),n!=null&&t!=null&&n>=t)throw new Error(n+" >= "+t);if(n==null){if(t==null)return"a"+e[0];let c=Z(t),a=t.slice(c.length);if(c==="A"+e[0].repeat(26))return c+V("",a,e);if(c<t)return c;let f=ze(c,e);if(f==null)throw new Error("cannot decrement any more");return f}if(t==null){let c=Z(n),a=n.slice(c.length),f=Pt(c,e);return f??c+V(a,null,e)}let r=Z(n),i=n.slice(r.length),o=Z(t),s=t.slice(o.length);if(r===o)return r+V(i,s,e);let u=Pt(r,e);if(u==null)throw new Error("cannot increment any more");return u<t?u:r+V(i,null,e)}var ut=class{#t=[];#e;#r;#n;constructor(t,e,r){this.#r=t,this.#n=t+e,this.#e=r}get size(){let t=this.#r,e=this.#n-this.#r,r=this.#t.length-t;return Math.max(0,Math.min(e,r))}move({offset:t,limit:e}){let r=this.#r,i=this.#n-this.#r,o=[this.#r,this.#n===1/0?this.#r+this.size:this.#n];this.#r=t??r,this.#n=this.#r+(e??i);let s=[this.#r,this.#n===1/0?Math.max(this.#r+this.size,o[1]):this.#n],{onlyInA:u,onlyInB:c}=wt(o,s),a=[];c.forEach(h=>{let m=this.#t[h];m&&a.push(m)});let f=[];return u.forEach(h=>{let m=this.#t[h];m&&f.push(m)}),{moveIns:a,moveOuts:f,changes:u.length+c.length>0}}insert(t){let e={moveIn:null,moveOut:null},r=this.#i(t),i=r===0?null:z(this.#t[r-1]),o=r===this.#t.length?null:z(this.#t[r]),s=Ht(i,o),u=at(t,s);if(this.#t.splice(r,0,u),r<this.#n){let c=Math.max(r,this.#r);c<this.#t.length&&(e.moveIn=this.#t[c],this.#n<this.#t.length&&(e.moveOut=this.#t[this.#n]))}return e}delete(t){let e={moveIn:null,moveOut:null},r=this.#i(t),[i]=this.#t.splice(r,1);if(r<this.#n){if(e.moveOut=i,r<this.#r){let s=this.#r-1;s<this.#t.length?e.moveOut=this.#t[s]:e.moveOut=null}let o=this.#n-1;o<this.#t.length&&(e.moveIn=this.#t[o])}return e}#i(t){return yt(this.#t,at(t,""),(e,r)=>this.#e(C(e),C(r)))}},Y=class extends M{#t=new Map;#e;constructor(t,e,r,i,o){super(t,e,r);let s=o.limit??1/0,u=o.offset??0,c=(a,f)=>{let h=i(ct(a),ct(f));if(h!==0)return h;let m=$t(a),lt=$t(f);return m-lt};this.#e=this.createTopK(u,s,c),o.setSizeCallback?.(()=>this.#e.size),o.setWindowFn?.(this.moveTopK.bind(this))}createTopK(t,e,r){return new ut(t,e,r)}moveTopK({offset:t,limit:e}){if(!(this.#e instanceof ut))throw new Error("Cannot move B+-tree implementation of TopK with fractional index");let r=[],i=this.#e.move({offset:t,limit:e});i.moveIns.forEach(o=>this.handleMoveIn(o,r)),i.moveOuts.forEach(o=>this.handleMoveOut(o,r)),i.changes&&this.output.sendData(new d(r))}run(){let t=[];for(let e of this.inputMessages())for(let[r,i]of e.getInner()){let[o,s]=r;this.processElement(o,s,i,t)}t.length>0&&this.output.sendData(new d(t))}processElement(t,e,r,i){let{oldMultiplicity:o,newMultiplicity:s}=this.addKey(t,r),u={moveIn:null,moveOut:null};if(o<=0&&s>0){let c=qt(t,e);u=this.#e.insert(c)}else if(o>0&&s<=0){let c=qt(t,e);u=this.#e.delete(c)}this.handleMoveIn(u.moveIn,i),this.handleMoveOut(u.moveOut,i)}handleMoveIn(t,e){if(t){let r=z(t),i=C(t),o=Gt(i),s=ct(i);e.push([[o,[s,r]],1])}}handleMoveOut(t,e){if(t){let r=z(t),i=C(t),o=Gt(i),s=ct(i);e.push([[o,[s,r]],-1])}}getMultiplicity(t){return this.#t.get(t)??0}addKey(t,e){let r=this.getMultiplicity(t),i=r+e;return i===0?this.#t.delete(t):this.#t.set(t,i),{oldMultiplicity:r,newMultiplicity:i}}};function ft(n,t){let e=t||{};return r=>{let i=new l(r.graph,new p),o=new Y(r.graph.getNextOperatorId(),r.connectReader(),i.writer,n,e);return r.graph.addOperator(o),i}}function at(n,t){return[n,t]}function C(n){return n[0]}function z(n){return n[1]}function qt(n,t){return[n,t,_.getId(n)]}function Gt(n){return n[0]}function ct(n){return n[1]}function $t(n){return n[2]}function Zt(n,t){let e=t?.limit??1/0,r=t?.offset??0,i=t?.comparator??((o,s)=>o===s?0:o<s?-1:1);return o=>o.pipe(g(([s,u])=>[null,[s,n(u)]]),ot((s,u)=>i(s[1],u[1]),{limit:e,offset:r}),g(([s,[u]])=>[u,null]),R(o),g(([s,u])=>[s,u[1]]),S())}function Yt(n,t){let e=t?.limit??1/0,r=t?.offset??0,i=t?.comparator??((o,s)=>o===s?0:o<s?-1:1);return o=>o.pipe(g(([s,u])=>[null,[s,n(u)]]),st((s,u)=>i(s[1],u[1]),{limit:e,offset:r}),g(([s,[[u],c]])=>[u,c]),R(o),g(([s,[u,c]])=>[s,[c,u]]),S())}function mt(n,t,e){let r=e?.limit??1/0,i=e?.offset??0,o=e?.setSizeCallback,s=e?.setWindowFn,u=e?.comparator??((c,a)=>c===a?0:c<a?-1:1);return c=>c.pipe(n((a,f)=>u(t(a),t(f)),{limit:r,offset:i,setSizeCallback:o,setWindowFn:s}),S())}function Xt(n,t){return mt(ft,n,t)}function Qt(n){return t=>{let e=n.pipe(g(([r,i])=>[r,null]));return t.pipe(R(e),g(([r,[i,o]])=>[r,i]),S())}}console.log(gt);

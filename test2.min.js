var Q=class{};var ce=class extends Q{constructor(e){super(),this.path=e,this.type="ref"}},$=class extends Q{constructor(e){super(),this.value=e,this.type="val"}},U=class extends Q{constructor(e,t){super(),this.name=e,this.args=t,this.type="func"}};var P=class extends Error{constructor(e){super(e),this.name="TanStackDBError"}};var W=class extends P{constructor(e,t,s){let i=`${e==="insert"?"Insert":"Update"} validation failed: ${t.map(n=>`
- ${n.message} - path: ${n.path}`).join("")}`;super(s||i),this.name="SchemaValidationError",this.type=e,this.issues=t}},K=class extends P{constructor(e){super(e),this.name="CollectionConfigurationError"}},le=class extends K{constructor(){super("Collection requires a config")}},ue=class extends K{constructor(){super("Collection requires a sync config")}},he=class extends K{constructor(){super("Schema must implement the standard-schema interface")}},G=class extends K{constructor(){super("Schema validation must be synchronous")}},A=class extends P{constructor(e){super(e),this.name="CollectionStateError"}},de=class extends A{constructor(e,t){super(`Cannot perform ${e} on collection "${t}" - collection is in error state. Try calling cleanup() and restarting the collection.`)}},fe=class extends A{constructor(e,t,s){super(`Invalid collection status transition from "${e}" to "${t}" for collection "${s}"`)}},pe=class extends A{constructor(){super("Collection is in error state")}},ye=class extends A{constructor(){super("Active subscribers count is negative - this should never happen")}},I=class extends P{constructor(e){super(e),this.name="CollectionOperationError"}},me=class extends I{constructor(e){super(`An object was created without a defined key: ${JSON.stringify(e)}`)}},ge=class extends I{constructor(e){super(`Cannot insert document with ID "${e}" because it already exists in the collection`)}},xe=class extends I{constructor(e,t){super(`Cannot insert document with key "${e}" from sync because it already exists in the collection "${t}"`)}},ve=class extends I{constructor(){super("The first argument to update is missing")}},we=class extends I{constructor(){super("No keys were passed to update")}},Se=class extends I{constructor(e){super(`The key "${e}" was passed to update but an object for this key was not found in the collection`)}},be=class extends I{constructor(e,t){super(`Updating the key of an item is not allowed. Original key: "${e}", Attempted new key: "${t}". Please delete the old item and create a new one if a key change is necessary.`)}},ke=class extends I{constructor(){super("No keys were passed to delete")}},Ce=class extends I{constructor(e){super(`Collection.delete was called with key '${e}' but there is no item in the collection with this key`)}},H=class extends P{constructor(e){super(e),this.name="MissingHandlerError"}},_e=class extends H{constructor(){super("Collection.insert called directly (not within an explicit transaction) but no 'onInsert' handler is configured.")}},Ie=class extends H{constructor(){super("Collection.update called directly (not within an explicit transaction) but no 'onUpdate' handler is configured.")}},Ee=class extends H{constructor(){super("Collection.delete called directly (not within an explicit transaction) but no 'onDelete' handler is configured.")}},O=class extends P{constructor(e){super(e),this.name="TransactionError"}},Pe=class extends O{constructor(){super("mutationFn is required when creating a transaction")}},Oe=class extends O{constructor(){super("You can no longer call .mutate() as the transaction is no longer pending")}},Te=class extends O{constructor(){super("You can no longer call .rollback() as the transaction is already completed")}},Re=class extends O{constructor(){super("You can no longer call .commit() as the transaction is no longer pending")}},Y=class extends O{constructor(){super("No pending sync transaction to write to")}},J=class extends O{constructor(){super("The pending sync transaction is already committed, you can't still write to it.")}},Ke=class extends O{constructor(){super("No pending sync transaction to commit")}},Ae=class extends O{constructor(){super("The pending sync transaction is already committed, you can't commit it again.")}};var Z=class extends P{constructor(e){super(e),this.name="QueryCompilationError"}};var Me=class extends Z{constructor(e){super(`Unknown expression type: ${e}`)}},De=class extends Z{constructor(){super("Reference path cannot be empty")}},Fe=class extends Z{constructor(e){super(`Unknown function: ${e}`)}};var X=class extends P{constructor(e,t){let s=t instanceof Error?t.message:String(t);super(`Collection "${e}" sync cleanup function threw an error: ${s}`),this.name="SyncCleanupError"}};var st=new WeakMap,Ft=1;function gt(r){if(st.has(r))return st.get(r);let e=Ft++;return st.set(r,e),e}var nt=(r,e,t)=>{let{nulls:s}=t;if(r==null&&e==null)return 0;if(r==null)return s==="first"?-1:1;if(e==null)return s==="first"?1:-1;if(typeof r=="string"&&typeof e=="string"&&t.stringSort==="locale")return r.localeCompare(e,t.locale,t.localeOptions);if(Array.isArray(r)&&Array.isArray(e)){for(let o=0;o<Math.min(r.length,e.length);o++){let a=nt(r[o],e[o],t);if(a!==0)return a}return r.length-e.length}if(r instanceof Date&&e instanceof Date)return r.getTime()-e.getTime();let i=typeof r=="object",n=typeof e=="object";if(i||n){if(i&&n){let o=gt(r),a=gt(e);return o-a}if(i)return 1;if(n)return-1}return r<e?-1:r>e?1:0},zt=(r,e,t)=>nt(e,r,{...t,nulls:t.nulls==="first"?"last":"first"});function rt(r){return(e,t)=>r.direction==="asc"?nt(e,t,r):zt(e,t,r)}var it=rt({direction:"asc",nulls:"first",stringSort:"locale"});function E(r){return r instanceof Date?r.getTime():r}function ee(r){return vt(r,!0)}function vt(r,e){switch(r.type){case"val":{let t=r.value;return()=>t}case"ref":return e?$t(r):Lt(r);case"func":return Ut(r,e);default:throw new Me(r.type)}}function Lt(r){let[e,...t]=r.path;if(!e)throw new De;if(t.length===0)return s=>s[e];if(t.length===1){let s=t[0];return i=>i[e]?.[s]}else return s=>{let i=s[e];if(i===void 0)return;let n=i;for(let o of t){if(n==null)return n;n=n[o]}return n}}function $t(r){let e=r.path;return t=>{let s=t;for(let i of e){if(s==null)return s;s=s[i]}return s}}function Ut(r,e){let t=r.args.map(s=>vt(s,e));switch(r.name){case"eq":{let s=t[0],i=t[1];return n=>{let o=E(s(n)),a=E(i(n));return o===a}}case"gt":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return o>a}}case"gte":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return o>=a}}case"lt":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return o<a}}case"lte":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return o<=a}}case"and":return s=>{for(let i of t)if(!i(s))return!1;return!0};case"or":return s=>{for(let i of t)if(i(s))return!0;return!1};case"not":{let s=t[0];return i=>!s(i)}case"in":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return Array.isArray(a)?a.includes(o):!1}}case"like":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return xt(o,a,!1)}}case"ilike":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return xt(o,a,!0)}}case"upper":{let s=t[0];return i=>{let n=s(i);return typeof n=="string"?n.toUpperCase():n}}case"lower":{let s=t[0];return i=>{let n=s(i);return typeof n=="string"?n.toLowerCase():n}}case"length":{let s=t[0];return i=>{let n=s(i);return typeof n=="string"||Array.isArray(n)?n.length:0}}case"concat":return s=>t.map(i=>{let n=i(s);try{return String(n??"")}catch{try{return JSON.stringify(n)||""}catch{return"[object]"}}}).join("");case"coalesce":return s=>{for(let i of t){let n=i(s);if(n!=null)return n}return null};case"add":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return(o??0)+(a??0)}}case"subtract":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return(o??0)-(a??0)}}case"multiply":{let s=t[0],i=t[1];return n=>{let o=s(n),a=i(n);return(o??0)*(a??0)}}case"divide":{let s=t[0],i=t[1];return n=>{let o=s(n),l=i(n)??0;return l!==0?(o??0)/l:null}}case"isUndefined":{let s=t[0];return i=>s(i)===void 0}case"isNull":{let s=t[0];return i=>s(i)===null}default:throw new Fe(r.name)}}function xt(r,e,t){if(typeof r!="string"||typeof e!="string")return!1;let s=t?r.toLowerCase():r,n=(t?e.toLowerCase():e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return n=n.replace(/%/g,".*"),n=n.replace(/_/g,"."),new RegExp(`^${n}$`).test(s)}function k(r,e){return ze(r,e,new Map)}function ze(r,e,t){if(r===e)return!0;if(r==null||e==null||typeof r!=typeof e)return!1;if(r instanceof Date)return e instanceof Date?r.getTime()===e.getTime():!1;if(r instanceof RegExp)return e instanceof RegExp?r.source===e.source&&r.flags===e.flags:!1;if(r instanceof Map){if(!(e instanceof Map)||r.size!==e.size)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let i=Array.from(r.entries()).every(([n,o])=>e.has(n)&&ze(o,e.get(n),t));return t.delete(r),i}if(r instanceof Set){if(!(e instanceof Set)||r.size!==e.size)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let s=Array.from(r),i=Array.from(e);if(s.every(o=>typeof o!="object"))return t.delete(r),s.every(o=>e.has(o));let n=s.length===i.length;return t.delete(r),n}if(ArrayBuffer.isView(r)&&ArrayBuffer.isView(e)&&!(r instanceof DataView)&&!(e instanceof DataView)){let s=r,i=e;if(s.length!==i.length)return!1;for(let n=0;n<s.length;n++)if(s[n]!==i[n])return!1;return!0}if(te(r)&&te(e)){let s=ot(r),i=ot(e);return s!==i?!1:typeof r.equals=="function"?r.equals(e):r.toString()===e.toString()}if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let s=r.every((i,n)=>ze(i,e[n],t));return t.delete(r),s}if(typeof r=="object"){if(t.has(r))return t.get(r)===e;t.set(r,e);let s=Object.keys(r),i=Object.keys(e);if(s.length!==i.length)return t.delete(r),!1;let n=s.every(o=>o in e&&ze(r[o],e[o],t));return t.delete(r),n}return!1}var Vt=["Temporal.Duration","Temporal.Instant","Temporal.PlainDate","Temporal.PlainDateTime","Temporal.PlainMonthDay","Temporal.PlainTime","Temporal.PlainYearMonth","Temporal.ZonedDateTime"];function ot(r){return r[Symbol.toStringTag]}function te(r){let e=ot(r);return typeof e=="string"&&Vt.includes(e)}var V={direction:"asc",nulls:"first",stringSort:"locale"};var Le=class{constructor(e){this.originalIndex=e}lookup(e,t){let s=e==="gt"?"lt":e==="gte"?"lte":e==="lt"?"gt":e==="lte"?"gte":e;return this.originalIndex.lookup(s,t)}rangeQuery(e={}){return this.originalIndex.rangeQueryReversed(e)}rangeQueryReversed(e={}){return this.originalIndex.rangeQuery(e)}take(e,t,s){return this.originalIndex.takeReversed(e,t,s)}takeReversed(e,t,s){return this.originalIndex.take(e,t,s)}get orderedEntriesArray(){return this.originalIndex.orderedEntriesArrayReversed}get orderedEntriesArrayReversed(){return this.originalIndex.orderedEntriesArray}supports(e){return this.originalIndex.supports(e)}matchesField(e){return this.originalIndex.matchesField(e)}matchesCompareOptions(e){return this.originalIndex.matchesCompareOptions(e)}matchesDirection(e){return this.originalIndex.matchesDirection(e)}getStats(){return this.originalIndex.getStats()}add(e,t){this.originalIndex.add(e,t)}remove(e,t){this.originalIndex.remove(e,t)}update(e,t,s){this.originalIndex.update(e,t,s)}build(e){this.originalIndex.build(e)}clear(){this.originalIndex.clear()}get keyCount(){return this.originalIndex.keyCount}equalityLookup(e){return this.originalIndex.equalityLookup(e)}inArrayLookup(e){return this.originalIndex.inArrayLookup(e)}get indexedKeysSet(){return this.originalIndex.indexedKeysSet}get valueMapData(){return this.originalIndex.valueMapData}};function se(r,e,t=V){for(let s of r.values())if(s.matchesField(e)&&s.matchesCompareOptions(t))return s.matchesDirection(t.direction)?s:new Le(s)}function qt(r){if(r.length===0)return new Set;if(r.length===1)return new Set(r[0]);let e=new Set(r[0]);for(let t=1;t<r.length;t++){let s=new Set;for(let i of e)r[t].has(i)&&s.add(i);e=s}return e}function Nt(r){let e=new Set;for(let t of r)for(let s of t)e.add(s);return e}function wt(r,e){return at(r,e)}function at(r,e){if(r.type==="func")switch(r.name){case"eq":case"gt":case"gte":case"lt":case"lte":return jt(r,e);case"and":return Qt(r,e);case"or":return Wt(r,e);case"in":return Gt(r,e)}return{canOptimize:!1,matchingKeys:new Set}}function Bt(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=new Map;for(let s of r.args)if(s.type==="func"&&["gt","gte","lt","lte"].includes(s.name)){let i=s;if(i.args.length===2){let n=i.args[0],o=i.args[1],a=null,l=null,h=i.name;if(n.type==="ref"&&o.type==="val")a=n,l=o;else if(n.type==="val"&&o.type==="ref")switch(a=o,l=n,h){case"gt":h="lt";break;case"gte":h="lte";break;case"lt":h="gt";break;case"lte":h="gte";break}if(a&&l){let u=a.path.join("."),f=l.value;t.has(u)||t.set(u,[]),t.get(u).push({operation:h,value:f})}}}for(let[s,i]of t)if(i.length>=2){let n=s.split("."),o=se(e,n);if(o&&o.supports("gt")&&o.supports("lt")){let a,l,h=!0,p=!0;for(let{operation:f,value:c}of i)switch(f){case"gt":(a===void 0||c>a)&&(a=c,h=!1);break;case"gte":(a===void 0||c>a)&&(a=c,h=!0);break;case"lt":(l===void 0||c<l)&&(l=c,p=!1);break;case"lte":(l===void 0||c<l)&&(l=c,p=!0);break}return{canOptimize:!0,matchingKeys:o.rangeQuery({from:a,to:l,fromInclusive:h,toInclusive:p})}}}return{canOptimize:!1,matchingKeys:new Set}}function jt(r,e){if(r.type!=="func"||r.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let t=r.args[0],s=r.args[1],i=null,n=null,o=r.name;if(t.type==="ref"&&s.type==="val")i=t,n=s;else if(t.type==="val"&&s.type==="ref")switch(i=s,n=t,o){case"gt":o="lt";break;case"gte":o="lte";break;case"lt":o="gt";break;case"lte":o="gte";break}if(i&&n){let a=i.path,l=se(e,a);if(l){let h=n.value,p=o;return l.supports(p)?{canOptimize:!0,matchingKeys:l.lookup(p,h)}:{canOptimize:!1,matchingKeys:new Set}}}return{canOptimize:!1,matchingKeys:new Set}}function Qt(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=Bt(r,e);if(t.canOptimize)return t;let s=[];for(let i of r.args){let n=at(i,e);n.canOptimize&&s.push(n)}if(s.length>0){let i=s.map(o=>o.matchingKeys);return{canOptimize:!0,matchingKeys:qt(i)}}return{canOptimize:!1,matchingKeys:new Set}}function Wt(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=[];for(let s of r.args){let i=at(s,e);i.canOptimize&&t.push(i)}if(t.length>0){let s=t.map(n=>n.matchingKeys);return{canOptimize:!0,matchingKeys:Nt(s)}}return{canOptimize:!1,matchingKeys:new Set}}function Gt(r,e){if(r.type!=="func"||r.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let t=r.args[0],s=r.args[1];if(t.type==="ref"&&s.type==="val"&&Array.isArray(s.value)){let i=t.path,n=s.value,o=se(e,i);if(o){if(o.supports("in"))return{canOptimize:!0,matchingKeys:o.lookup("in",n)};if(o.supports("eq")){let a=new Set;for(let l of n){let h=o.lookup("eq",l);for(let p of h)a.add(p)}return{canOptimize:!0,matchingKeys:a}}}}return{canOptimize:!1,matchingKeys:new Set}}var $e=class{constructor(e,t,s){this._root=ct,this._size=0,this._maxNodeSize=s>=4?Math.min(s,256):32,this._compare=e,t&&this.setPairs(t)}get size(){return this._size}get length(){return this._size}get isEmpty(){return this._size===0}clear(){this._root=ct,this._size=0}get(e,t){return this._root.get(e,t,this)}set(e,t,s){this._root.isShared&&(this._root=this._root.clone());let i=this._root.set(e,t,s,this);return i===!0||i===!1?i:(this._root=new lt([this._root,i]),!0)}has(e){return this.forRange(e,e,!0,void 0)!==0}delete(e){return this.editRange(e,e,!0,Yt)!==0}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}keysArray(){let e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(t,s)=>{e.push(t)}),e}nextHigherPair(e,t){return t=t||[],e===void 0?this._root.minPair(t):this._root.getPairOrNextHigher(e,this._compare,!1,t)}nextHigherKey(e){let t=this.nextHigherPair(e,St);return t&&t[0]}nextLowerPair(e,t){return t=t||[],e===void 0?this._root.maxPair(t):this._root.getPairOrNextLower(e,this._compare,!1,t)}nextLowerKey(e){let t=this.nextLowerPair(e,St);return t&&t[0]}setPairs(e,t){let s=0;for(let i of e)this.set(i[0],i[1],t)&&s++;return s}forRange(e,t,s,i,n){let o=this._root.forRange(e,t,s,!1,this,n||0,i);return typeof o=="number"?o:o.break}editRange(e,t,s,i,n){let o=this._root;o.isShared&&(this._root=o=o.clone());try{let a=o.forRange(e,t,s,!0,this,n||0,i);return typeof a=="number"?a:a.break}finally{let a;for(;o.keys.length<=1&&!o.isLeaf;)a||=o.isShared,this._root=o=o.keys.length===0?ct:o.children[0];a&&(o.isShared=!0)}}},Ue=class r{get isLeaf(){return this.children===void 0}constructor(e=[],t){this.keys=e,this.values=t||b,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,t,s){let i=this.keys,n=0,o=i.length,a=o>>1;for(;n<o;){let l=s(i[a],e);if(l<0)n=a+1;else if(l>0)o=a;else{if(l===0)return a;if(e===e)return i.length;throw new Error("BTree: NaN was used as a key")}a=n+o>>1}return a^t}minKey(){return this.keys[0]}minPair(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(this.keys.length===0)return;let t=this.keys.length-1;return e[0]=this.keys[t],e[1]=this.values[t],e}clone(){let e=this.values;return new r(this.keys.slice(0),e===b?e:e.slice(0))}get(e,t,s){let i=this.indexOf(e,-1,s._compare);return i<0?t:this.values[i]}getPairOrNextLower(e,t,s,i){let n=this.indexOf(e,-1,t),o=n<0?~n-1:s?n:n-1;if(o>=0)return i[0]=this.keys[o],i[1]=this.values[o],i}getPairOrNextHigher(e,t,s,i){let n=this.indexOf(e,-1,t),o=n<0?~n:s?n:n+1,a=this.keys;if(o<a.length)return i[0]=a[o],i[1]=this.values[o],i}set(e,t,s,i){let n=this.indexOf(e,-1,i._compare);if(n<0){if(n=~n,i._size++,this.keys.length<i._maxNodeSize)return this.insertInLeaf(n,e,t,i);{let o=this.splitOffRightSide(),a=this;return n>this.keys.length&&(n-=this.keys.length,a=o),a.insertInLeaf(n,e,t,i),o}}else return s!==!1&&(t!==void 0&&this.reifyValues(),this.keys[n]=e,this.values[n]=t),!1}reifyValues(){return this.values===b?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,t,s,i){if(this.keys.splice(e,0,t),this.values===b){for(;b.length<i._maxNodeSize;)b.push(void 0);if(s===void 0)return!0;this.values=b.slice(0,this.keys.length-1)}return this.values.splice(e,0,s),!0}takeFromRight(e){let t=this.values;e.values===b?t!==b&&t.push(void 0):(t=this.reifyValues(),t.push(e.values.shift())),this.keys.push(e.keys.shift())}takeFromLeft(e){let t=this.values;e.values===b?t!==b&&t.unshift(void 0):(t=this.reifyValues(),t.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())}splitOffRightSide(){let e=this.keys.length>>1,t=this.keys.splice(e),s=this.values===b?b:this.values.splice(e);return new r(t,s)}forRange(e,t,s,i,n,o,a){let l=n._compare,h,p;if(t===e){if(!s||(p=(h=this.indexOf(e,-1,l))+1,h<0))return o}else h=this.indexOf(e,0,l),p=this.indexOf(t,-1,l),p<0?p=~p:s===!0&&p++;let u=this.keys,f=this.values;if(a!==void 0)for(let c=h;c<p;c++){let d=u[c],y=a(d,f[c],o++);if(y!==void 0){if(i===!0){if(d!==u[c]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");y.delete?(this.keys.splice(c,1),this.values!==b&&this.values.splice(c,1),n._size--,c--,p--):y.hasOwnProperty("value")&&(f[c]=y.value)}if(y.break!==void 0)return y}}else o+=p-h;return o}mergeSibling(e,t){if(this.keys.push.apply(this.keys,e.keys),this.values===b){if(e.values===b)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}},lt=class r extends Ue{constructor(e,t){if(!t){t=[];for(let s=0;s<e.length;s++)t[s]=e[s].maxKey()}super(t),this.children=e}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,t,s){let i=this.indexOf(e,0,s._compare),n=this.children;return i<n.length?n[i].get(e,t,s):void 0}getPairOrNextLower(e,t,s,i){let n=this.indexOf(e,0,t),o=this.children;if(n>=o.length)return this.maxPair(i);let a=o[n].getPairOrNextLower(e,t,s,i);return a===void 0&&n>0?o[n-1].maxPair(i):a}getPairOrNextHigher(e,t,s,i){let n=this.indexOf(e,0,t),o=this.children,a=o.length;if(n>=a)return;let l=o[n].getPairOrNextHigher(e,t,s,i);return l===void 0&&n<a-1?o[n+1].minPair(i):l}set(e,t,s,i){let n=this.children,o=i._maxNodeSize,a=i._compare,l=Math.min(this.indexOf(e,0,a),n.length-1),h=n[l];if(h.isShared&&(n[l]=h=h.clone()),h.keys.length>=o){let u;l>0&&(u=n[l-1]).keys.length<o&&a(h.keys[0],e)<0?(u.isShared&&(n[l-1]=u=u.clone()),u.takeFromRight(h),this.keys[l-1]=u.maxKey()):(u=n[l+1])!==void 0&&u.keys.length<o&&a(h.maxKey(),e)<0&&(u.isShared&&(n[l+1]=u=u.clone()),u.takeFromLeft(h),this.keys[l]=n[l].maxKey())}let p=h.set(e,t,s,i);if(p===!1)return!1;if(this.keys[l]=h.maxKey(),p===!0)return!0;if(this.keys.length<o)return this.insert(l+1,p),!0;{let u=this.splitOffRightSide(),f=this;return a(p.maxKey(),this.maxKey())>0&&(f=u,l-=this.keys.length),f.insert(l+1,p),u}}insert(e,t){this.children.splice(e,0,t),this.keys.splice(e,0,t.maxKey())}splitOffRightSide(){let e=this.children.length>>1;return new r(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,t,s,i,n,o,a){let l=n._compare,h=this.keys,p=this.children,u=this.indexOf(e,0,l),f=u,c=Math.min(t===e?u:this.indexOf(t,0,l),h.length-1);if(i){if(f<=c)try{for(;f<=c;f++){p[f].isShared&&(p[f]=p[f].clone());let d=p[f].forRange(e,t,s,i,n,o,a);if(h[f]=p[f].maxKey(),typeof d!="number")return d;o=d}}finally{let d=n._maxNodeSize>>1;for(u>0&&u--,f=c;f>=u;f--)p[f].keys.length<=d&&(p[f].keys.length!==0?this.tryMerge(f,n._maxNodeSize):(h.splice(f,1),p.splice(f,1)));p.length!==0&&p[0].keys.length===0&&Jt(!1,"emptiness bug")}}else for(;f<=c;f++){let d=p[f].forRange(e,t,s,i,n,o,a);if(typeof d!="number")return d;o=d}return o}tryMerge(e,t){let s=this.children;return e>=0&&e+1<s.length&&s[e].keys.length+s[e+1].keys.length<=t?(s[e].isShared&&(s[e]=s[e].clone()),s[e].mergeSibling(s[e+1],t),s.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=s[e].maxKey(),!0):!1}mergeSibling(e,t){let s=this.keys.length;this.keys.push.apply(this.keys,e.keys);let i=e.children;if(this.children.push.apply(this.children,i),e.isShared&&!this.isShared)for(let n of i)n.isShared=!0;this.tryMerge(s-1,t)}},b=[],Ht={delete:!0},Yt=()=>Ht,ct=(function(){let r=new Ue;return r.isShared=!0,r})(),St=[];function Jt(r,...e){throw e.unshift("B+ tree"),new Error(e.join(" "))}function bt(){let r=new Map;function e(t){let s=t.join(".");if(r.has(s))return r.get(s);let i=new Proxy({},{get(n,o,a){if(o==="__refProxy")return!0;if(o==="__path")return t;if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(n,o,a);let l=[...t,String(o)];return e(l)},has(n,o){return o==="__refProxy"||o==="__path"||o==="__type"?!0:Reflect.has(n,o)},ownKeys(n){return Reflect.ownKeys(n)},getOwnPropertyDescriptor(n,o){return o==="__refProxy"||o==="__path"||o==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(n,o)}});return r.set(s,i),i}return e([])}function M(r){return Zt(r)?new ce(r.__path):r&&typeof r=="object"&&"type"in r&&(r.type==="func"||r.type==="ref"||r.type==="val"||r.type==="agg")?r:new $(r)}function Zt(r){return r&&typeof r=="object"&&r.__refProxy===!0}function kt(r,e){return new U("gt",[M(r),M(e)])}function Ct(r,e){return new U("lt",[M(r),M(e)])}function ut(r,e,...t){let s=[r,e,...t];return new U("and",s.map(i=>M(i)))}var Ve=class{constructor(e,t,s,i){this.lookupCount=0,this.totalLookupTime=0,this.lastUpdated=new Date,this.id=e,this.expression=t,this.compareOptions=V,this.name=s,this.initialize(i)}supports(e){return this.supportedOperations.has(e)}matchesField(e){return this.expression.type==="ref"&&this.expression.path.length===e.length&&this.expression.path.every((t,s)=>t===e[s])}matchesCompareOptions(e){let t={...this.compareOptions,direction:void 0},s={...e,direction:void 0};return k(t,s)}matchesDirection(e){return this.compareOptions.direction===e}getStats(){return{entryCount:this.keyCount,lookupCount:this.lookupCount,averageLookupTime:this.lookupCount>0?this.totalLookupTime/this.lookupCount:0,lastUpdated:this.lastUpdated}}evaluateIndexExpression(e){return ee(this.expression)(e)}trackLookup(e){let t=performance.now()-e;this.lookupCount++,this.totalLookupTime+=t}updateTimestamp(){this.lastUpdated=new Date}};var F=class extends Ve{constructor(e,t,s,i){super(e,t,s,i),this.supportedOperations=new Set(["eq","gt","gte","lt","lte","in"]),this.valueMap=new Map,this.indexedKeys=new Set,this.compareFn=it,this.compareFn=i?.compareFn??it,i?.compareOptions&&(this.compareOptions=i.compareOptions),this.orderedEntries=new $e(this.compareFn)}initialize(e){}add(e,t){let s;try{s=this.evaluateIndexExpression(t)}catch(n){throw new Error(`Failed to evaluate index expression for key ${e}: ${n}`)}let i=E(s);if(this.valueMap.has(i))this.valueMap.get(i).add(e);else{let n=new Set([e]);this.valueMap.set(i,n),this.orderedEntries.set(i,void 0)}this.indexedKeys.add(e),this.updateTimestamp()}remove(e,t){let s;try{s=this.evaluateIndexExpression(t)}catch(n){console.warn(`Failed to evaluate index expression for key ${e} during removal:`,n);return}let i=E(s);if(this.valueMap.has(i)){let n=this.valueMap.get(i);n.delete(e),n.size===0&&(this.valueMap.delete(i),this.orderedEntries.delete(i))}this.indexedKeys.delete(e),this.updateTimestamp()}update(e,t,s){this.remove(e,t),this.add(e,s)}build(e){this.clear();for(let[t,s]of e)this.add(t,s)}clear(){this.orderedEntries.clear(),this.valueMap.clear(),this.indexedKeys.clear(),this.updateTimestamp()}lookup(e,t){let s=performance.now(),i;switch(e){case"eq":i=this.equalityLookup(t);break;case"gt":i=this.rangeQuery({from:t,fromInclusive:!1});break;case"gte":i=this.rangeQuery({from:t,fromInclusive:!0});break;case"lt":i=this.rangeQuery({to:t,toInclusive:!1});break;case"lte":i=this.rangeQuery({to:t,toInclusive:!0});break;case"in":i=this.inArrayLookup(t);break;default:throw new Error(`Operation ${e} not supported by BTreeIndex`)}return this.trackLookup(s),i}get keyCount(){return this.indexedKeys.size}equalityLookup(e){let t=E(e);return new Set(this.valueMap.get(t)??[])}rangeQuery(e={}){let{from:t,to:s,fromInclusive:i=!0,toInclusive:n=!0}=e,o=new Set,a=E(t),l=E(s),h=a??this.orderedEntries.minKey(),p=l??this.orderedEntries.maxKey();return this.orderedEntries.forRange(h,p,n,(u,f)=>{if(!i&&this.compareFn(u,t)===0)return;let c=this.valueMap.get(u);c&&c.forEach(d=>o.add(d))}),o}rangeQueryReversed(e={}){let{from:t,to:s,fromInclusive:i=!0,toInclusive:n=!0}=e;return this.rangeQuery({from:s??this.orderedEntries.maxKey(),to:t??this.orderedEntries.minKey(),fromInclusive:n,toInclusive:i})}takeInternal(e,t,s,i){let n=new Set,o=[],a,l=E(s);for(;(a=t(l))!==void 0&&o.length<e;){l=a[0];let h=this.valueMap.get(l);if(h){let p=h.values(),u;for(;o.length<e&&(u=p.next().value);)!n.has(u)&&(i?.(u)??!0)&&(o.push(u),n.add(u))}}return o}take(e,t,s){let i=n=>this.orderedEntries.nextHigherPair(n);return this.takeInternal(e,i,t,s)}takeReversed(e,t,s){let i=n=>this.orderedEntries.nextLowerPair(n);return this.takeInternal(e,i,t,s)}inArrayLookup(e){let t=new Set;for(let s of e){let i=E(s),n=this.valueMap.get(i);n&&n.forEach(o=>t.add(o))}return t}get indexedKeysSet(){return this.indexedKeys}get orderedEntriesArray(){return this.orderedEntries.keysArray().map(e=>[e,this.valueMap.get(e)??new Set])}get orderedEntriesArrayReversed(){return this.takeReversed(this.orderedEntries.size).map(e=>[e,this.valueMap.get(e)??new Set])}get valueMapData(){return this.valueMap}};function _t(r){return r.config.autoIndex==="eager"}function ht(r,e,t,s=V,i){if(!(!_t(t)||Array.from(t.indexes.values()).find(o=>o.matchesField(e)&&o.matchesCompareOptions(s))))try{t.createIndex(o=>o[r],{name:`auto_${r}`,indexType:F,options:i?{compareFn:i,compareOptions:s}:{}})}catch(o){console.warn(`${t.id?`[${t.id}] `:""}Failed to create auto-index for field "${r}":`,o)}}function It(r,e){if(!_t(e))return;let t=Xt(r);for(let{fieldName:s,fieldPath:i}of t)ht(s,i,e)}function Xt(r){let e=[];function t(s){if(s.type!=="func")return;let i=s;if(i.name==="and"){for(let h of i.args)t(h);return}if(!["eq","gt","gte","lt","lte","in"].includes(i.name)||i.args.length<1||i.args[0].type!=="ref")return;let a=i.args[0].path;if(a.length!==1)return;let l=a[0];e.push({fieldName:l,fieldPath:a})}return t(r),e}function Pt(r,e={}){let t=s=>{let i=[];for(let[n,o]of r.entries())(s?.(o)??!0)&&i.push({type:"insert",key:n,value:o});return i};if(e.limit!==void 0&&!e.orderBy)throw new Error("limit cannot be used without orderBy");if(e.orderBy){let s=e.where?q(e.where):void 0,i=es(r,e.orderBy,e.limit,s,e.optimizedOnly);if(i===void 0)return;let n=[];for(let o of i){let a=r.get(o);a!==void 0&&n.push({type:"insert",key:o,value:a})}return n}if(!e.where)return t();try{let s=e.where,i=wt(s,r.indexes);if(i.canOptimize){let n=[];for(let o of i.matchingKeys){let a=r.get(o);a!==void 0&&n.push({type:"insert",key:o,value:a})}return n}else{if(e.optimizedOnly)return;let n=q(s);return t(n)}}catch(s){console.warn(`${r.id?`[${r.id}] `:""}Error processing where clause, falling back to full scan:`,s);let i=q(e.where);return e.optimizedOnly?void 0:t(i)}}function q(r){return e=>{try{return!!ee(r)(e)}catch{return!1}}}function Ot(r,e){let t=q(e.whereExpression);return s=>{let i=[];for(let n of s)if(n.type==="insert")t(n.value)&&i.push(n);else if(n.type==="update"){let o=t(n.value),a=n.previousValue?t(n.previousValue):!1;o&&a?i.push(n):o&&!a?i.push({...n,type:"insert"}):!o&&a&&i.push({...n,type:"delete",value:n.previousValue})}else t(n.value)&&i.push(n);(i.length>0||s.length===0)&&r(i)}}function es(r,e,t,s,i){if(e.length===1){let l=e[0],h=l.expression;if(h.type==="ref"){let u=h.path;ht(u[0],u,r,l.compareOptions);let f=se(r.indexes,u,l.compareOptions);if(f&&f.supports("gt")){let c=d=>{let y=r.get(d);return y===void 0?!1:s?.(y)??!0};return f.take(t??f.keyCount,void 0,c)}}}if(i)return;let n=[];for(let[l,h]of r.entries())(s?.(h)??!0)&&n.push({key:l,value:h});let o=(l,h)=>{for(let p of e){let u=rt(p.compareOptions),f=Et(l.value,p.expression),c=Et(h.value,p.expression),d=u(f,c);if(d!==0)return d}return 0};n.sort(o);let a=n.map(l=>l.key);return t!==void 0?a.slice(0,t):a}function Et(r,e){if(e.type==="ref"){let t=e,s=r;for(let i of t.path)s=s?.[i];return s}else return e.type==="val"?e.value:ee(e)(r)}var ne=class{constructor(e){this.map=new Map,this.sortedKeys=[],this.comparator=e||this.defaultComparator}defaultComparator(e,t){return e<t?-1:e>t?1:0}indexOf(e){let t=0,s=this.sortedKeys.length;for(;t<s;){let i=Math.floor((t+s)/2),n=this.sortedKeys[i],o=this.map.get(n),a=this.comparator(e,o);if(a<0)s=i;else if(a>0)t=i+1;else return i}return t}set(e,t){if(this.map.has(e)){let i=this.map.get(e),n=this.indexOf(i);this.sortedKeys.splice(n,1)}let s=this.indexOf(t);return this.sortedKeys.splice(s,0,e),this.map.set(e,t),this}get(e){return this.map.get(e)}delete(e){if(this.map.has(e)){let t=this.map.get(e),s=this.indexOf(t);return this.sortedKeys.splice(s,1),this.map.delete(e)}return!1}has(e){return this.map.has(e)}clear(){this.map.clear(),this.sortedKeys=[]}get size(){return this.map.size}*[Symbol.iterator](){for(let e of this.sortedKeys)yield[e,this.map.get(e)]}entries(){return this[Symbol.iterator]()}keys(){return this.sortedKeys[Symbol.iterator]()}values(){return(function*(){for(let e of this.sortedKeys)yield this.map.get(e)}).call(this)}forEach(e){for(let t of this.sortedKeys)e(this.map.get(t),t,this.map)}};var qe=class{constructor(e){this.pendingSyncedTransactions=[],this.syncedMetadata=new Map,this.optimisticUpserts=new Map,this.optimisticDeletes=new Set,this.size=0,this.syncedKeys=new Set,this.preSyncVisibleState=new Map,this.recentlySyncedKeys=new Set,this.hasReceivedFirstCommit=!1,this.isCommittingSyncTransactions=!1,this.commitPendingTransactions=()=>{let t=!1;for(let o of this.transactions.values())if(o.state==="persisting"){t=!0;break}let{committedSyncedTransactions:s,uncommittedSyncedTransactions:i,hasTruncateSync:n}=this.pendingSyncedTransactions.reduce((o,a)=>(a.committed?(o.committedSyncedTransactions.push(a),a.truncate===!0&&(o.hasTruncateSync=!0)):o.uncommittedSyncedTransactions.push(a),o),{committedSyncedTransactions:[],uncommittedSyncedTransactions:[],hasTruncateSync:!1});if(!t||n){this.isCommittingSyncTransactions=!0;let o=n?s.find(f=>f.truncate)?.optimisticSnapshot:null,a=new Set;for(let f of s)for(let c of f.operations)a.add(c.key);let l=this.preSyncVisibleState;if(l.size===0){l=new Map;for(let f of a){let c=this.get(f);c!==void 0&&l.set(f,c)}}let h=[],p=this.config.sync.rowUpdateMode||"partial";for(let f of s){if(f.truncate){let c=new Set([...this.syncedData.keys(),...o?.upserts.keys()||[]]);for(let d of c){if(o?.deletes.has(d))continue;let y=o?.upserts.get(d)||this.syncedData.get(d);y!==void 0&&h.push({type:"delete",key:d,value:y})}this.syncedData.clear(),this.syncedMetadata.clear(),this.syncedKeys.clear();for(let d of a)l.delete(d)}for(let c of f.operations){let d=c.key;switch(this.syncedKeys.add(d),c.type){case"insert":this.syncedMetadata.set(d,c.metadata);break;case"update":this.syncedMetadata.set(d,Object.assign({},this.syncedMetadata.get(d),c.metadata));break;case"delete":this.syncedMetadata.delete(d);break}switch(c.type){case"insert":this.syncedData.set(d,c.value);break;case"update":{if(p==="partial"){let y=Object.assign({},this.syncedData.get(d),c.value);this.syncedData.set(d,y)}else this.syncedData.set(d,c.value);break}case"delete":this.syncedData.delete(d);break}}}if(n){let f=new Set;for(let y of s)for(let g of y.operations)(g.type==="insert"||g.type==="update")&&f.add(g.key);let c=new Map(o.upserts),d=new Set(o.deletes);for(let[y,g]of c)if(!d.has(y))if(f.has(y)){let C=!1;for(let v=h.length-1;v>=0;v--){let w=h[v];if(w.key===y&&w.type==="insert"){w.value=g,C=!0;break}}C||h.push({type:"insert",key:y,value:g})}else h.push({type:"insert",key:y,value:g});if(h.length>0&&d.size>0){let y=[];for(let g of h)g.type==="insert"&&d.has(g.key)||y.push(g);h.length=0,h.push(...y)}this.lifecycle.status!=="ready"&&this.lifecycle.markReady()}if(this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.isCommittingSyncTransactions=!1,n&&o){for(let[f,c]of o.upserts)this.optimisticUpserts.set(f,c);for(let f of o.deletes)this.optimisticDeletes.add(f)}for(let f of this.transactions.values())if(!["completed","failed"].includes(f.state)){for(let c of f.mutations)if(this.isThisCollection(c.collection)&&c.optimistic)switch(c.type){case"insert":case"update":this.optimisticUpserts.set(c.key,c.modified),this.optimisticDeletes.delete(c.key);break;case"delete":this.optimisticUpserts.delete(c.key),this.optimisticDeletes.add(c.key);break}}let u=new Map;for(let f of this.transactions.values())if(f.state==="completed")for(let c of f.mutations)c.optimistic&&this.isThisCollection(c.collection)&&a.has(c.key)&&u.set(c.key,{type:c.type,value:c.modified});for(let f of a){let c=l.get(f),d=this.get(f),y=u.get(f),g=!1;y&&(y.type==="delete"&&c!==void 0&&d===void 0&&k(y.value,c)||d!==void 0&&k(y.value,d))&&(g=!0),g||(c===void 0&&d!==void 0?h.push({type:"insert",key:f,value:d}):c!==void 0&&d===void 0?h.push({type:"delete",key:f,value:c}):c!==void 0&&d!==void 0&&!k(c,d)&&h.push({type:"update",key:f,value:d,previousValue:c}))}this.size=this.calculateSize(),h.length>0&&this.indexes.updateIndexes(h),this.changes.emitEvents(h,!0),this.pendingSyncedTransactions=i,this.preSyncVisibleState.clear(),Promise.resolve().then(()=>{this.recentlySyncedKeys.clear()}),this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0)}},this.config=e,this.transactions=new ne((t,s)=>t.compareCreatedAt(s)),e.compare?this.syncedData=new ne(e.compare):this.syncedData=new Map}setDeps(e){this.collection=e.collection,this.lifecycle=e.lifecycle,this.changes=e.changes,this.indexes=e.indexes}get(e){let{optimisticDeletes:t,optimisticUpserts:s,syncedData:i}=this;if(!t.has(e))return s.has(e)?s.get(e):i.get(e)}has(e){let{optimisticDeletes:t,optimisticUpserts:s,syncedData:i}=this;return t.has(e)?!1:s.has(e)?!0:i.has(e)}*keys(){let{syncedData:e,optimisticDeletes:t,optimisticUpserts:s}=this;for(let i of e.keys())t.has(i)||(yield i);for(let i of s.keys())!e.has(i)&&!t.has(i)&&(yield i)}*values(){for(let e of this.keys()){let t=this.get(e);t!==void 0&&(yield t)}}*entries(){for(let e of this.keys()){let t=this.get(e);t!==void 0&&(yield[e,t])}}*[Symbol.iterator](){for(let[e,t]of this.entries())yield[e,t]}forEach(e){let t=0;for(let[s,i]of this.entries())e(i,s,t++)}map(e){let t=[],s=0;for(let[i,n]of this.entries())t.push(e(n,i,s++));return t}isThisCollection(e){return e===this.collection}recomputeOptimisticState(e=!1){if(this.isCommittingSyncTransactions&&!e)return;let t=new Map(this.optimisticUpserts),s=new Set(this.optimisticDeletes);this.optimisticUpserts.clear(),this.optimisticDeletes.clear();let i=[];for(let a of this.transactions.values())["completed","failed"].includes(a.state)||i.push(a);for(let a of i)for(let l of a.mutations)if(this.isThisCollection(l.collection)&&l.optimistic)switch(l.type){case"insert":case"update":this.optimisticUpserts.set(l.key,l.modified),this.optimisticDeletes.delete(l.key);break;case"delete":this.optimisticUpserts.delete(l.key),this.optimisticDeletes.add(l.key);break}this.size=this.calculateSize();let n=[];this.collectOptimisticChanges(t,s,n);let o=n.filter(a=>!!(!this.recentlySyncedKeys.has(a.key)||e));if(this.pendingSyncedTransactions.length>0&&!e){let a=new Set;for(let h of this.pendingSyncedTransactions)for(let p of h.operations)a.add(p.key);let l=o.filter(h=>!(h.type==="delete"&&a.has(h.key)&&!i.some(u=>u.mutations.some(f=>this.isThisCollection(f.collection)&&f.key===h.key))));l.length>0&&this.indexes.updateIndexes(l),this.changes.emitEvents(l,e)}else o.length>0&&this.indexes.updateIndexes(o),this.changes.emitEvents(o,e)}calculateSize(){let e=this.syncedData.size,t=Array.from(this.optimisticDeletes).filter(i=>this.syncedData.has(i)&&!this.optimisticUpserts.has(i)).length,s=Array.from(this.optimisticUpserts.keys()).filter(i=>!this.syncedData.has(i)).length;return e-t+s}collectOptimisticChanges(e,t,s){let i=new Set([...e.keys(),...this.optimisticUpserts.keys(),...t,...this.optimisticDeletes]);for(let n of i){let o=this.get(n),a=this.getPreviousValue(n,e,t);a!==void 0&&o===void 0?s.push({type:"delete",key:n,value:a}):a===void 0&&o!==void 0?s.push({type:"insert",key:n,value:o}):a!==void 0&&o!==void 0&&a!==o&&s.push({type:"update",key:n,value:o,previousValue:a})}}getPreviousValue(e,t,s){if(!s.has(e))return t.has(e)?t.get(e):this.syncedData.get(e)}scheduleTransactionCleanup(e){if(e.state==="completed"){this.transactions.delete(e.id);return}e.isPersisted.promise.then(()=>{this.transactions.delete(e.id)}).catch(()=>{})}capturePreSyncVisibleState(){if(this.pendingSyncedTransactions.length===0)return;let e=new Set;for(let t of this.pendingSyncedTransactions)for(let s of t.operations)e.add(s.key);for(let t of e)this.recentlySyncedKeys.add(t);for(let t of e)if(!this.preSyncVisibleState.has(t)){let s=this.get(t);s!==void 0&&this.preSyncVisibleState.set(t,s)}}onTransactionStateChange(){this.changes.shouldBatchEvents=this.pendingSyncedTransactions.length>0,this.capturePreSyncVisibleState(),this.recomputeOptimisticState(!1)}cleanup(){this.syncedData.clear(),this.syncedMetadata.clear(),this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.size=0,this.pendingSyncedTransactions=[],this.syncedKeys.clear(),this.hasReceivedFirstCommit=!1}};var N=class{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{this.listeners.get(e)?.delete(t)}}once(e,t){let s=this.on(e,i=>{t(i),s()});return s}off(e,t){this.listeners.get(e)?.delete(t)}waitFor(e,t){return new Promise((s,i)=>{let n,o=this.on(e,a=>{n&&(clearTimeout(n),n=void 0),s(a),o()});t&&(n=setTimeout(()=>{n=void 0,o(),i(new Error(`Timeout waiting for event ${String(e)}`))},t))})}emitInner(e,t){this.listeners.get(e)?.forEach(s=>{try{s(t)}catch(i){queueMicrotask(()=>{throw i})}})}clearListeners(){this.listeners.clear()}};var Ne=class extends N{constructor(e,t,s){super(),this.collection=e,this.callback=t,this.options=s,this.loadedInitialState=!1,this.snapshotSent=!1,this.sentKeys=new Set,this._status="ready",this.pendingLoadSubsetPromises=new Set,s.onUnsubscribe&&this.on("unsubscribed",n=>s.onUnsubscribe(n)),s.whereExpression&&It(s.whereExpression,this.collection);let i=n=>{t(n),this.trackSentKeys(n)};this.callback=i,this.filteredCallback=s.whereExpression?Ot(this.callback,s):this.callback}get status(){return this._status}setOrderByIndex(e){this.orderByIndex=e}setStatus(e){if(this._status===e)return;let t=this._status;this._status=e,this.emitInner("status:change",{type:"status:change",subscription:this,previousStatus:t,status:e});let s=`status:${e}`;this.emitInner(s,{type:s,subscription:this,previousStatus:t,status:e})}trackLoadSubsetPromise(e){e instanceof Promise&&(this.pendingLoadSubsetPromises.add(e),this.setStatus("loadingSubset"),e.finally(()=>{this.pendingLoadSubsetPromises.delete(e),this.pendingLoadSubsetPromises.size===0&&this.setStatus("ready")}))}hasLoadedInitialState(){return this.loadedInitialState}hasSentAtLeastOneSnapshot(){return this.snapshotSent}emitEvents(e){let t=this.filterAndFlipChanges(e);this.filteredCallback(t)}requestSnapshot(e){if(this.loadedInitialState)return!1;let t={where:this.options.whereExpression,optimizedOnly:e?.optimizedOnly??!1};if(e){if("where"in e){let o=e.where;if(t.where){let a=t.where,l=ut(a,o);t.where=l}else t.where=o}}else this.loadedInitialState=!0;let s=this.collection._sync.loadSubset({where:t.where,subscription:this});this.trackLoadSubsetPromise(s);let i=this.collection.currentStateAsChanges(t);if(i===void 0)return!1;let n=i.filter(o=>!this.sentKeys.has(o.key));return this.snapshotSent=!0,this.callback(n),!0}requestLimitedSnapshot({orderBy:e,limit:t,minValue:s}){if(!t)throw new Error("limit is required");if(!this.orderByIndex)throw new Error("Ordered snapshot was requested but no index was found. You have to call setOrderByIndex before requesting an ordered snapshot.");let i=this.orderByIndex,n=this.options.whereExpression,o=n?q(n):void 0,a=y=>{if(this.sentKeys.has(y))return!1;let g=this.collection.get(y);return g===void 0?!1:o?.(g)??!0},l=s,h=[],p=i.take(t,s,a),u=()=>Math.max(t-h.length,0),f=()=>p.length===0;for(;u()>0&&!f();){for(let y of p){let g=this.collection.get(y);h.push({type:"insert",key:y,value:g}),l=g}p=i.take(u(),l,a)}this.callback(h);let c=n;if(typeof s<"u"){let{expression:y,compareOptions:g}=e[0],v=(g.direction==="asc"?kt:Ct)(y,new $(s));c=n?ut(n,v):v}let d=this.collection._sync.loadSubset({where:c,limit:t,orderBy:e,subscription:this});this.trackLoadSubsetPromise(d)}filterAndFlipChanges(e){if(this.loadedInitialState)return e;let t=[];for(let s of e){let i=s;if(!this.sentKeys.has(s.key)){if(s.type==="update")i={...s,type:"insert",previousValue:void 0};else if(s.type==="delete")continue;this.sentKeys.add(s.key)}t.push(i)}return t}trackSentKeys(e){if(!this.loadedInitialState)for(let t of e)this.sentKeys.add(t.key)}unsubscribe(){this.emitInner("unsubscribed",{type:"unsubscribed",subscription:this}),this.clearListeners()}};var Be=class{constructor(){this.activeSubscribersCount=0,this.changeSubscriptions=new Set,this.batchedEvents=[],this.shouldBatchEvents=!1}setDeps(e){this.lifecycle=e.lifecycle,this.sync=e.sync,this.events=e.events,this.collection=e.collection}emitEmptyReadyEvent(){for(let e of this.changeSubscriptions)e.emitEvents([])}emitEvents(e,t=!1){if(this.shouldBatchEvents&&!t){this.batchedEvents.push(...e);return}let s=e;if(t&&(this.batchedEvents.length>0&&(s=[...this.batchedEvents,...e]),this.batchedEvents=[],this.shouldBatchEvents=!1),s.length!==0)for(let i of this.changeSubscriptions)i.emitEvents(s)}subscribeChanges(e,t={}){this.addSubscriber();let s=new Ne(this.collection,e,{...t,onUnsubscribe:()=>{this.removeSubscriber(),this.changeSubscriptions.delete(s)}});return t.includeInitialState&&s.requestSnapshot(),this.changeSubscriptions.add(s),s}addSubscriber(){let e=this.activeSubscribersCount;this.activeSubscribersCount++,this.lifecycle.cancelGCTimer(),(this.lifecycle.status==="cleaned-up"||this.lifecycle.status==="idle")&&this.sync.startSync(),this.events.emitSubscribersChange(this.activeSubscribersCount,e)}removeSubscriber(){let e=this.activeSubscribersCount;if(this.activeSubscribersCount--,this.activeSubscribersCount===0)this.lifecycle.startGCTimer();else if(this.activeSubscribersCount<0)throw new ye;this.events.emitSubscribersChange(this.activeSubscribersCount,e)}cleanup(){this.batchedEvents=[],this.shouldBatchEvents=!1}};var ts=r=>setTimeout(()=>{r({didTimeout:!0,timeRemaining:()=>50})},0),ss=r=>{clearTimeout(r)},Tt=typeof window<"u"&&"requestIdleCallback"in window?(r,e)=>window.requestIdleCallback(r,e):(r,e)=>ts(r),je=typeof window<"u"&&"cancelIdleCallback"in window?r=>window.cancelIdleCallback(r):ss;var Qe=class{constructor(e,t){this.status="idle",this.hasBeenReady=!1,this.hasReceivedFirstCommit=!1,this.onFirstReadyCallbacks=[],this.gcTimeoutId=null,this.idleCallbackId=null,this.config=e,this.id=t}setDeps(e){this.indexes=e.indexes,this.events=e.events,this.changes=e.changes,this.sync=e.sync,this.state=e.state}validateStatusTransition(e,t){if(e===t)return;if(!{idle:["loading","error","cleaned-up"],loading:["ready","error","cleaned-up"],ready:["cleaned-up","error"],error:["cleaned-up","idle"],"cleaned-up":["loading","error"]}[e].includes(t))throw new fe(e,t,this.id)}setStatus(e,t=!1){if(e==="ready"&&!t)throw new A(`You can't directly call "setStatus('ready'). You must use markReady instead.`);this.validateStatusTransition(this.status,e);let s=this.status;this.status=e,e==="ready"&&!this.indexes.isIndexesResolved&&this.indexes.resolveAllIndexes().catch(i=>{console.warn(`${this.config.id?`[${this.config.id}] `:""}Failed to resolve indexes:`,i)}),this.events.emitStatusChange(e,s)}validateCollectionUsable(e){switch(this.status){case"error":throw new de(e,this.id);case"cleaned-up":this.sync.startSync();break}}markReady(){if(this.validateStatusTransition(this.status,"ready"),this.status==="loading"){if(this.setStatus("ready",!0),!this.hasBeenReady){this.hasBeenReady=!0,this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0);let e=[...this.onFirstReadyCallbacks];this.onFirstReadyCallbacks=[],e.forEach(t=>t())}this.changes.changeSubscriptions.size>0&&this.changes.emitEmptyReadyEvent()}}startGCTimer(){this.gcTimeoutId&&clearTimeout(this.gcTimeoutId);let e=this.config.gcTime??3e5;e!==0&&(this.gcTimeoutId=setTimeout(()=>{this.changes.activeSubscribersCount===0&&this.scheduleIdleCleanup()},e))}cancelGCTimer(){this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.idleCallbackId!==null&&(je(this.idleCallbackId),this.idleCallbackId=null)}scheduleIdleCleanup(){this.idleCallbackId!==null&&je(this.idleCallbackId),this.idleCallbackId=Tt(e=>{this.changes.activeSubscribersCount===0?this.performCleanup(e)&&(this.idleCallbackId=null):this.idleCallbackId=null},{timeout:1e3})}performCleanup(e){return!e||e.timeRemaining()>0||e.didTimeout?(this.sync.cleanup(),this.state.cleanup(),this.changes.cleanup(),this.indexes.cleanup(),this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.hasBeenReady=!1,this.onFirstReadyCallbacks=[],this.setStatus("cleaned-up"),this.events.cleanup(),!0):(this.scheduleIdleCleanup(),!1)}onFirstReady(e){if(this.hasBeenReady){e();return}this.onFirstReadyCallbacks.push(e)}cleanup(){this.idleCallbackId!==null&&(je(this.idleCallbackId),this.idleCallbackId=null),this.performCleanup()}};var We=class{constructor(e,t){this.preloadPromise=null,this.syncCleanupFn=null,this.syncLoadSubsetFn=null,this.pendingLoadSubsetPromises=new Set,this.config=e,this.id=t,this.syncMode=e.syncMode??"eager"}setDeps(e){this.collection=e.collection,this.state=e.state,this.lifecycle=e.lifecycle,this._events=e.events}startSync(){if(!(this.lifecycle.status!=="idle"&&this.lifecycle.status!=="cleaned-up")){this.lifecycle.setStatus("loading");try{let e=ns(this.config.sync.sync({collection:this.collection,begin:()=>{this.state.pendingSyncedTransactions.push({committed:!1,operations:[],deletedKeys:new Set})},write:t=>{let s=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!s)throw new Y;if(s.committed)throw new J;let i=this.config.getKey(t.value),n=t.type;if(t.type==="insert"){let a=this.state.syncedData.has(i),l=s.deletedKeys.has(i),h=s.truncate===!0;if(a&&!l&&!h){let p=this.state.syncedData.get(i);if(p!==void 0&&k(p,t.value))n="update";else throw new xe(i,this.id)}}let o={...t,type:n,key:i};s.operations.push(o),n==="delete"&&s.deletedKeys.add(i)},commit:()=>{let t=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!t)throw new Ke;if(t.committed)throw new Ae;t.committed=!0,this.state.commitPendingTransactions()},markReady:()=>{this.lifecycle.markReady()},truncate:()=>{let t=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!t)throw new Y;if(t.committed)throw new J;t.operations=[],t.deletedKeys.clear(),t.truncate=!0,t.optimisticSnapshot={upserts:new Map(this.state.optimisticUpserts),deletes:new Set(this.state.optimisticDeletes)}}}));if(this.syncCleanupFn=e?.cleanup??null,this.syncLoadSubsetFn=e?.loadSubset??null,this.syncMode==="on-demand"&&!this.syncLoadSubsetFn)throw new K(`Collection "${this.id}" is configured with syncMode "on-demand" but the sync function did not return a loadSubset handler. Either provide a loadSubset handler or use syncMode "eager".`)}catch(e){throw this.lifecycle.setStatus("error"),e}}}preload(){return this.preloadPromise?this.preloadPromise:(this.preloadPromise=new Promise((e,t)=>{if(this.lifecycle.status==="ready"){e();return}if(this.lifecycle.status==="error"){t(new pe);return}if(this.lifecycle.onFirstReady(()=>{e()}),this.lifecycle.status==="idle"||this.lifecycle.status==="cleaned-up")try{this.startSync()}catch(s){t(s);return}}),this.preloadPromise)}get isLoadingSubset(){return this.pendingLoadSubsetPromises.size>0}trackLoadPromise(e){let t=!this.isLoadingSubset;this.pendingLoadSubsetPromises.add(e),t&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!0,previousIsLoadingSubset:!1,loadingSubsetTransition:"start"}),e.finally(()=>{let s=this.pendingLoadSubsetPromises.size===1&&this.pendingLoadSubsetPromises.has(e);this.pendingLoadSubsetPromises.delete(e),s&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!1,previousIsLoadingSubset:!0,loadingSubsetTransition:"end"})})}loadSubset(e){if(this.syncMode==="eager")return!0;if(this.syncLoadSubsetFn){let t=this.syncLoadSubsetFn(e);if(t instanceof Promise)return this.trackLoadPromise(t),t}return!0}cleanup(){try{this.syncCleanupFn&&(this.syncCleanupFn(),this.syncCleanupFn=null)}catch(e){queueMicrotask(()=>{if(e instanceof Error){let t=new X(this.id,e);throw t.cause=e,t.stack=e.stack,t}else throw new X(this.id,e)})}this.preloadPromise=null}};function ns(r){if(typeof r=="function")return{cleanup:r};if(typeof r=="object")return r}function Rt(r){return typeof r=="function"&&r.prototype!==void 0&&r.prototype.constructor===r}async function rs(r){return Rt(r)?r:await r()}var Ge=class{constructor(e,t,s,i,n,o){this.id=e,this.expression=t,this.name=s,this.resolver=i,this.options=n,this.collectionEntries=o,this.indexPromise=null,this.resolvedIndex=null,Rt(this.resolver)&&(this.resolvedIndex=new this.resolver(this.id,this.expression,this.name,this.options),this.collectionEntries&&this.resolvedIndex.build(this.collectionEntries))}async resolve(){return this.resolvedIndex?this.resolvedIndex:(this.indexPromise||(this.indexPromise=this.createIndex()),this.resolvedIndex=await this.indexPromise,this.resolvedIndex)}isResolved(){return this.resolvedIndex!==null}getResolved(){if(!this.resolvedIndex)throw new Error(`Index ${this.id} has not been resolved yet. Ensure collection is synced.`);return this.resolvedIndex}getId(){return this.id}getName(){return this.name}getExpression(){return this.expression}async createIndex(){let e=await rs(this.resolver);return new e(this.id,this.expression,this.name,this.options)}},He=class{constructor(e,t){this.indexId=e,this.lazyIndex=t}get index(){return this.lazyIndex.getResolved()}get isReady(){return this.lazyIndex.isResolved()}async whenReady(){return await this.lazyIndex.resolve()}get id(){return this.indexId}get name(){return this.isReady?this.index.name:this.lazyIndex.getName()}get expression(){return this.lazyIndex.getExpression()}supports(e){return this.index.supports(e)}getStats(){return this.index.getStats()}matchesField(e){let t=this.expression;return t.type==="ref"&&t.path.length===e.length&&t.path.every((s,i)=>s===e[i])}get keyCount(){return this.index.keyCount}get indexedKeysSet(){return this.index.indexedKeysSet}get orderedEntriesArray(){return this.index.orderedEntriesArray}get valueMapData(){return this.index.valueMapData}equalityLookup(e){return this.index.equalityLookup?.(e)??new Set}rangeQuery(e){return this.index.rangeQuery?.(e)??new Set}inArrayLookup(e){return this.index.inArrayLookup?.(e)??new Set}_getLazyWrapper(){return this.lazyIndex}};var Ye=class{constructor(){this.lazyIndexes=new Map,this.resolvedIndexes=new Map,this.isIndexesResolved=!1,this.indexCounter=0}setDeps(e){this.state=e.state,this.lifecycle=e.lifecycle}createIndex(e,t={}){this.lifecycle.validateCollectionUsable("createIndex");let s=++this.indexCounter,i=bt(),n=e(i),o=M(n),a=t.indexType??F,l=new Ge(s,o,t.name,a,t.options,this.state.entries());if(this.lazyIndexes.set(s,l),a===F)try{let h=l.getResolved();this.resolvedIndexes.set(s,h)}catch(h){console.warn("Failed to resolve BTreeIndex:",h)}else if(typeof a=="function"&&a.prototype)try{let h=l.getResolved();this.resolvedIndexes.set(s,h)}catch{this.resolveSingleIndex(s,l).catch(h=>{console.warn("Failed to resolve single index:",h)})}else this.isIndexesResolved&&this.resolveSingleIndex(s,l).catch(h=>{console.warn("Failed to resolve single index:",h)});return new He(s,l)}async resolveAllIndexes(){if(this.isIndexesResolved)return;let e=Array.from(this.lazyIndexes.entries()).map(async([t,s])=>{let i=await s.resolve();return i.build(this.state.entries()),this.resolvedIndexes.set(t,i),{indexId:t,resolvedIndex:i}});await Promise.all(e),this.isIndexesResolved=!0}async resolveSingleIndex(e,t){let s=await t.resolve();return s.build(this.state.entries()),this.resolvedIndexes.set(e,s),s}get indexes(){return this.resolvedIndexes}updateIndexes(e){for(let t of this.resolvedIndexes.values())for(let s of e)switch(s.type){case"insert":t.add(s.key,s.value);break;case"update":s.previousValue?t.update(s.key,s.previousValue,s.value):t.add(s.key,s.value);break;case"delete":t.remove(s.key,s.value);break}}cleanup(){this.lazyIndexes.clear(),this.resolvedIndexes.clear()}};function m(...r){let e=typeof window<"u"&&typeof localStorage<"u";e&&localStorage.getItem("DEBUG")==="true"?console.log("[proxy]",...r):!e&&typeof process<"u"&&process.env.DEBUG==="true"&&console.log("[proxy]",...r)}function R(r,e=new WeakMap){if(r==null||typeof r!="object")return r;if(e.has(r))return e.get(r);if(r instanceof Date)return new Date(r.getTime());if(r instanceof RegExp)return new RegExp(r.source,r.flags);if(Array.isArray(r)){let i=[];return e.set(r,i),r.forEach((n,o)=>{i[o]=R(n,e)}),i}if(ArrayBuffer.isView(r)&&!(r instanceof DataView)){let i=Object.getPrototypeOf(r).constructor,n=new i(r.length);e.set(r,n);for(let o=0;o<r.length;o++)n[o]=r[o];return n}if(r instanceof Map){let i=new Map;return e.set(r,i),r.forEach((n,o)=>{i.set(o,R(n,e))}),i}if(r instanceof Set){let i=new Set;return e.set(r,i),r.forEach(n=>{i.add(R(n,e))}),i}if(te(r))return r;let t={};e.set(r,t);for(let i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=R(r[i],e));let s=Object.getOwnPropertySymbols(r);for(let i of s)t[i]=R(r[i],e);return t}var Kt=0;function is(){return Kt+=1,Kt}function dt(r,e){let t=new Map;function s(u,f){if(m("Object ID:",u.constructor.name),t.has(u))return t.get(u);{let c=dt(u,f);return t.set(u,c),c}}let i=new Map,n={copy_:R(r),originalObject:R(r),proxyCount:is(),modified:!1,assigned_:{},parent:e,target:r};m("createChangeProxy called for target",r,n.proxyCount);function o(u){u.modified||(u.modified=!0),u.parent&&(m("propagating change to parent"),"updateMap"in u.parent?u.parent.updateMap(u.copy_):"updateSet"in u.parent?u.parent.updateSet(u.copy_):(u.parent.tracker.copy_[u.parent.prop]=u.copy_,u.parent.tracker.assigned_[u.parent.prop]=!0),o(u.parent.tracker))}function a(u){if(m("checkIfReverted called with assigned keys:",Object.keys(u.assigned_)),Object.keys(u.assigned_).length===0&&Object.getOwnPropertySymbols(u.assigned_).length===0)return m("No assigned properties, returning true"),!0;for(let c in u.assigned_)if(u.assigned_[c]===!0){let d=u.copy_[c],y=u.originalObject[c];if(m(`Checking property ${String(c)}, current:`,d,"original:",y),!k(d,y))return m(`Property ${String(c)} is different, returning false`),!1}else if(u.assigned_[c]===!1)return m(`Property ${String(c)} was deleted, returning false`),!1;let f=Object.getOwnPropertySymbols(u.assigned_);for(let c of f)if(u.assigned_[c]===!0){let d=u.copy_[c],y=u.originalObject[c];if(!k(d,y))return m("Symbol property is different, returning false"),!1}else if(u.assigned_[c]===!1)return m("Symbol property was deleted, returning false"),!1;return m("All properties match original values, returning true"),!0}function l(u,f){m("checkParentStatus called for child prop:",f);let c=a(u);m("Parent checkIfReverted returned:",c),c&&(m("Parent is fully reverted, clearing tracking"),u.modified=!1,u.assigned_={},u.parent&&(m("Continuing up the parent chain"),l(u.parent.tracker,u.parent.prop)))}function h(u){if(m("createObjectProxy",u),i.has(u))return m("proxyCache found match"),i.get(u);let f=new Proxy(u,{get(c,d){m("get",c,d);let y=n.copy_[d]??n.originalObject[d],g=n.originalObject[d];if(m("value (at top of proxy get)",y),Object.getOwnPropertyDescriptor(c,d)?.get)return y;if(typeof y=="function"){if(Array.isArray(c)){let v=d.toString();if(new Set(["pop","push","shift","unshift","splice","sort","reverse","fill","copyWithin"]).has(v))return function(...B){let _=y.apply(n.copy_,B);return o(n),_}}if(c instanceof Map||c instanceof Set){let v=d.toString();if(new Set(["set","delete","clear","add","pop","push","shift","unshift","splice","sort","reverse"]).has(v))return function(..._){let z=y.apply(n.copy_,_);return o(n),z};if(new Set(["entries","keys","values","forEach",Symbol.iterator]).has(v)||d===Symbol.iterator)return function(..._){let z=y.apply(n.copy_,_);if(v==="forEach"){let D=_[0];if(typeof D=="function"){let oe=function(ae,x,S){let T=D.call(this,ae,x,S);return o(n),T};return y.apply(c,[oe,..._.slice(1)])}}if(v==="entries"||v==="values"||v===Symbol.iterator.toString()||d===Symbol.iterator){let D=z,oe=new Map;if(v==="values"&&c instanceof Map)for(let[x,S]of n.copy_.entries())oe.set(S,x);let ae=new Map;if(c instanceof Set)for(let x of n.copy_.values())ae.set(x,x);return{next(){let x=D.next();if(!x.done&&x.value&&typeof x.value=="object"){if(v==="entries"&&Array.isArray(x.value)&&x.value.length===2){if(x.value[1]&&typeof x.value[1]=="object"){let S=x.value[0],T={tracker:n,prop:S,updateMap:L=>{n.copy_ instanceof Map&&n.copy_.set(S,L)}},{proxy:j}=s(x.value[1],T);x.value[1]=j}}else if((v==="values"||v===Symbol.iterator.toString()||d===Symbol.iterator)&&typeof x.value=="object"&&x.value!==null)if(v==="values"&&c instanceof Map){let S=oe.get(x.value);if(S!==void 0){let T={tracker:n,prop:S,updateMap:L=>{n.copy_ instanceof Map&&n.copy_.set(S,L)}},{proxy:j}=s(x.value,T);x.value=j}}else if(c instanceof Set){let S=x.value,T={tracker:n,prop:S,updateSet:L=>{n.copy_ instanceof Set&&(n.copy_.delete(S),n.copy_.add(L),ae.set(S,L))}},{proxy:j}=s(x.value,T);x.value=j}else{let S=Symbol("iterator-value"),{proxy:T}=s(x.value,{tracker:n,prop:S});x.value=T}}return x},[Symbol.iterator](){return this}}}return z}}return y.bind(c)}if(y&&typeof y=="object"&&!(y instanceof Date)&&!(y instanceof RegExp)&&!te(y)){let v={tracker:n,prop:String(d)},{proxy:w}=s(g,v);return i.set(y,w),w}return y},set(c,d,y){let g=n.copy_[d];if(m(`set called for property ${String(d)}, current:`,g,"new:",y),k(g,y))m("Value unchanged, not tracking");else{let C=n.originalObject[d],v=k(y,C);if(m("value:",y,"original:",C,"isRevertToOriginal:",v),v){m(`Reverting property ${String(d)} to original value`),delete n.assigned_[d.toString()],m(`Updating copy with original value for ${String(d)}`),n.copy_[d]=R(C),m("Checking if all properties reverted");let w=a(n);m("All reverted:",w),w?(m("All properties reverted, clearing tracking"),n.modified=!1,n.assigned_={},e&&(m("Updating parent for property:",e.prop),l(e.tracker,e.prop))):(m("Some properties still changed, keeping modified flag"),n.modified=!0)}else m(`Setting new value for property ${String(d)}`),n.copy_[d]=y,n.assigned_[d.toString()]=!0,m("Marking object and ancestors as modified",n),o(n)}return!0},defineProperty(c,d,y){return"value"in y&&(n.copy_[d]=R(y.value),n.assigned_[d.toString()]=!0,o(n)),!0},deleteProperty(c,d){m("deleteProperty",c,d);let y=typeof d=="symbol"?d.toString():d;if(y in c){let g=y in n.originalObject;delete n.copy_[d],g?(n.assigned_[y]=!1,n.copy_[y]=void 0,o(n)):(delete n.copy_[y],delete n.assigned_[y],Object.keys(n.assigned_).length===0&&Object.getOwnPropertySymbols(n.assigned_).length===0?n.modified=!1:n.modified=!0)}return!0}});return i.set(u,f),f}return{proxy:h(r),getChanges:()=>{if(m("getChanges called, modified:",n.modified),m(n),!n.modified)return m("Object not modified, returning empty object"),{};if(typeof n.copy_!="object"||Array.isArray(n.copy_)||Object.keys(n.assigned_).length===0)return n.copy_;let u={};for(let f in n.copy_)n.assigned_[f]===!0&&f in n.copy_&&(u[f]=n.copy_[f]);return m("Returning copy:",u),u}}}function os(r){let e=r.map(t=>dt(t));return{proxies:e.map(t=>t.proxy),getChanges:()=>e.map(t=>t.getChanges())}}function At(r,e){let{proxy:t,getChanges:s}=dt(r);return e(t),s()}function Mt(r,e){let{proxies:t,getChanges:s}=os(r);return e(t),s()}function Dt(){let r,e,t=!0;return{promise:new Promise((i,n)=>{r=o=>{t=!1,i(o)},e=o=>{t=!1,n(o)}}),resolve:r,reject:e,isPending:()=>t}}var ft=class{constructor(){this.contexts=new Map,this.clearListeners=new Set}getOrCreateContext(e){let t=this.contexts.get(e);return t||(t={queue:[],jobs:new Map,dependencies:new Map,completed:new Set},this.contexts.set(e,t)),t}schedule({contextId:e,jobId:t,dependencies:s,run:i}){if(typeof e>"u"){i();return}let n=this.getOrCreateContext(e);if(n.jobs.has(t)||n.queue.push(t),n.jobs.set(t,i),s){let o=new Set(s);o.delete(t),n.dependencies.set(t,o)}else n.dependencies.has(t)||n.dependencies.set(t,new Set);n.completed.delete(t)}flush(e){let t=this.contexts.get(e);if(!t)return;let{queue:s,jobs:i,dependencies:n,completed:o}=t;for(;s.length>0;){let a=!1,l=s.length;for(let h=0;h<l;h++){let p=s.shift(),u=i.get(p);if(!u){n.delete(p),o.delete(p);continue}let f=n.get(p),c=!f;if(f){c=!0;for(let d of f)if(d!==p&&!o.has(d)){c=!1;break}}c?(i.delete(p),n.delete(p),u(),o.add(p),a=!0):s.push(p)}if(!a)throw new Error(`Scheduler detected unresolved dependencies for context ${String(e)}.`)}this.contexts.delete(e)}flushAll(){for(let e of Array.from(this.contexts.keys()))this.flush(e)}clear(e){this.contexts.delete(e),this.clearListeners.forEach(t=>t(e))}onClear(e){return this.clearListeners.add(e),()=>this.clearListeners.delete(e)}hasPendingJobs(e){let t=this.contexts.get(e);return!!t&&t.jobs.size>0}clearJob(e,t){let s=this.contexts.get(e);s&&(s.jobs.delete(t),s.dependencies.delete(t),s.completed.delete(t),s.queue=s.queue.filter(i=>i!==t),s.jobs.size===0&&this.contexts.delete(e))}},pt=new ft;var Je=[],re=[],as=0;function cs(r,e){switch(`${r.type}-${e.type}`){case"insert-update":return{...r,type:"insert",original:{},modified:e.modified,changes:{...r.changes,...e.changes},key:r.key,globalKey:r.globalKey,metadata:e.metadata??r.metadata,syncMetadata:{...r.syncMetadata,...e.syncMetadata},mutationId:e.mutationId,updatedAt:e.updatedAt};case"insert-delete":return null;case"update-delete":return e;case"update-update":return{...e,original:r.original,changes:{...r.changes,...e.changes},metadata:e.metadata??r.metadata,syncMetadata:{...r.syncMetadata,...e.syncMetadata}};case"delete-delete":case"insert-insert":return e;default:{let t=`${r.type}-${e.type}`;throw new Error(`Unhandled mutation combination: ${t}`)}}}function ie(r){let e=new yt(r);return Je.push(e),e}function Ze(){if(re.length>0)return re.slice(-1)[0]}function ls(r){pt.clear(r.id),re.push(r)}function us(r){try{pt.flush(r.id)}finally{re=re.filter(e=>e.id!==r.id)}}function hs(r){let e=Je.findIndex(t=>t.id===r.id);e!==-1&&Je.splice(e,1)}var yt=class{constructor(e){if(typeof e.mutationFn>"u")throw new Pe;this.id=e.id??crypto.randomUUID(),this.mutationFn=e.mutationFn,this.state="pending",this.mutations=[],this.isPersisted=Dt(),this.autoCommit=e.autoCommit??!0,this.createdAt=new Date,this.sequenceNumber=as++,this.metadata=e.metadata??{}}setState(e){this.state=e,(e==="completed"||e==="failed")&&hs(this)}mutate(e){if(this.state!=="pending")throw new Oe;ls(this);try{e()}finally{us(this)}return this.autoCommit&&this.commit().catch(()=>{}),this}applyMutations(e){for(let t of e){let s=this.mutations.findIndex(i=>i.globalKey===t.globalKey);if(s>=0){let i=this.mutations[s],n=cs(i,t);n===null?this.mutations.splice(s,1):this.mutations[s]=n}else this.mutations.push(t)}}rollback(e){let t=e?.isSecondaryRollback??!1;if(this.state==="completed")throw new Te;if(this.setState("failed"),!t){let s=new Set;this.mutations.forEach(i=>s.add(i.globalKey));for(let i of Je)i.state==="pending"&&i.mutations.some(n=>s.has(n.globalKey))&&i.rollback({isSecondaryRollback:!0})}return this.isPersisted.reject(this.error?.error),this.touchCollection(),this}touchCollection(){let e=new Set;for(let t of this.mutations)e.has(t.collection.id)||(t.collection._state.onTransactionStateChange(),t.collection._state.pendingSyncedTransactions.length>0&&t.collection._state.commitPendingTransactions(),e.add(t.collection.id))}async commit(){if(this.state!=="pending")throw new Re;if(this.setState("persisting"),this.mutations.length===0)return this.setState("completed"),this.isPersisted.resolve(this),this;try{await this.mutationFn({transaction:this}),this.setState("completed"),this.touchCollection(),this.isPersisted.resolve(this)}catch(e){let t=e instanceof Error?e:new Error(String(e));throw this.error={message:t.message,error:t},this.rollback(),t}return this}compareCreatedAt(e){let t=this.createdAt.getTime()-e.createdAt.getTime();return t!==0?t:this.sequenceNumber-e.sequenceNumber}};var Xe=class{constructor(e,t){this.insert=(s,i)=>{this.lifecycle.validateCollectionUsable("insert");let n=this.state,o=Ze();if(!o&&!this.config.onInsert)throw new _e;let a=Array.isArray(s)?s:[s],l=[];if(a.forEach(h=>{let p=this.validateData(h,"insert"),u=this.config.getKey(p);if(this.state.has(u))throw new ge(u);let f=this.generateGlobalKey(u,h),c={mutationId:crypto.randomUUID(),original:{},modified:p,changes:Object.fromEntries(Object.keys(h).map(d=>[d,p[d]])),globalKey:f,key:u,metadata:i?.metadata,syncMetadata:this.config.sync.getSyncMetadata?.()||{},optimistic:i?.optimistic??!0,type:"insert",createdAt:new Date,updatedAt:new Date,collection:this.collection};l.push(c)}),o)return o.applyMutations(l),n.transactions.set(o.id,o),n.scheduleTransactionCleanup(o),n.recomputeOptimisticState(!0),o;{let h=ie({mutationFn:async p=>await this.config.onInsert({transaction:p.transaction,collection:this.collection})});return h.applyMutations(l),h.commit().catch(()=>{}),n.transactions.set(h.id,h),n.scheduleTransactionCleanup(h),n.recomputeOptimisticState(!0),h}},this.delete=(s,i)=>{let n=this.state;this.lifecycle.validateCollectionUsable("delete");let o=Ze();if(!o&&!this.config.onDelete)throw new Ee;if(Array.isArray(s)&&s.length===0)throw new ke;let a=Array.isArray(s)?s:[s],l=[];for(let p of a){if(!this.state.has(p))throw new Ce(p);let u=this.generateGlobalKey(p,this.state.get(p)),f={mutationId:crypto.randomUUID(),original:this.state.get(p),modified:this.state.get(p),changes:this.state.get(p),globalKey:u,key:p,metadata:i?.metadata,syncMetadata:n.syncedMetadata.get(p)||{},optimistic:i?.optimistic??!0,type:"delete",createdAt:new Date,updatedAt:new Date,collection:this.collection};l.push(f)}if(o)return o.applyMutations(l),n.transactions.set(o.id,o),n.scheduleTransactionCleanup(o),n.recomputeOptimisticState(!0),o;let h=ie({autoCommit:!0,mutationFn:async p=>this.config.onDelete({transaction:p.transaction,collection:this.collection})});return h.applyMutations(l),h.commit().catch(()=>{}),n.transactions.set(h.id,h),n.scheduleTransactionCleanup(h),n.recomputeOptimisticState(!0),h},this.id=t,this.config=e}setDeps(e){this.lifecycle=e.lifecycle,this.state=e.state,this.collection=e.collection}ensureStandardSchema(e){if(e&&"~standard"in e)return e;throw new he}validateData(e,t,s){if(!this.config.schema)return e;let i=this.ensureStandardSchema(this.config.schema);if(t==="update"&&s){let o=this.state.get(s);if(o&&e&&typeof e=="object"&&typeof o=="object"){let a=Object.assign({},o,e),l=i["~standard"].validate(a);if(l instanceof Promise)throw new G;if("issues"in l&&l.issues){let f=l.issues.map(c=>({message:c.message,path:c.path?.map(d=>String(d))}));throw new W(t,f)}let h=l.value,p=Object.keys(e);return Object.fromEntries(p.map(f=>[f,h[f]]))}}let n=i["~standard"].validate(e);if(n instanceof Promise)throw new G;if("issues"in n&&n.issues){let o=n.issues.map(a=>({message:a.message,path:a.path?.map(l=>String(l))}));throw new W(t,o)}return n.value}generateGlobalKey(e,t){if(typeof e>"u")throw new me(t);return`KEY::${this.id}/${e}`}update(e,t,s){if(typeof e>"u")throw new ve;let i=this.state;this.lifecycle.validateCollectionUsable("update");let n=Ze();if(!n&&!this.config.onUpdate)throw new Ie;let o=Array.isArray(e),a=o?e:[e];if(o&&a.length===0)throw new we;let l=typeof t=="function"?t:s,h=typeof t=="function"?{}:t,p=a.map(d=>{let y=this.state.get(d);if(!y)throw new Se(d);return y}),u;o?u=Mt(p,l):u=[At(p[0],l)];let f=a.map((d,y)=>{let g=u[y];if(!g||Object.keys(g).length===0)return null;let C=p[y],v=this.validateData(g,"update",d),w=Object.assign({},C,v),B=this.config.getKey(C),_=this.config.getKey(w);if(B!==_)throw new be(B,_);let z=this.generateGlobalKey(_,w);return{mutationId:crypto.randomUUID(),original:C,modified:w,changes:Object.fromEntries(Object.keys(g).map(D=>[D,w[D]])),globalKey:z,key:d,metadata:h.metadata,syncMetadata:i.syncedMetadata.get(d)||{},optimistic:h.optimistic??!0,type:"update",createdAt:new Date,updatedAt:new Date,collection:this.collection}}).filter(Boolean);if(f.length===0){let d=ie({mutationFn:async()=>{}});return d.commit().catch(()=>{}),i.scheduleTransactionCleanup(d),d}if(n)return n.applyMutations(f),i.transactions.set(n.id,n),i.scheduleTransactionCleanup(n),i.recomputeOptimisticState(!0),n;let c=ie({mutationFn:async d=>this.config.onUpdate({transaction:d.transaction,collection:this.collection})});return c.applyMutations(f),c.commit().catch(()=>{}),i.transactions.set(c.id,c),i.scheduleTransactionCleanup(c),i.recomputeOptimisticState(!0),c}};var et=class extends N{constructor(){super()}setDeps(e){this.collection=e.collection}emit(e,t){this.emitInner(e,t)}emitStatusChange(e,t){this.emit("status:change",{type:"status:change",collection:this.collection,previousStatus:t,status:e});let s=`status:${e}`;this.emit(s,{type:s,collection:this.collection,previousStatus:t,status:e})}emitSubscribersChange(e,t){this.emit("subscribers:change",{type:"subscribers:change",collection:this.collection,previousSubscriberCount:t,subscriberCount:e})}cleanup(){this.clearListeners()}};function mt(r){let e=new tt(r);return r.utils?e.utils={...r.utils}:e.utils={},e}var tt=class{constructor(e){if(this.utils={},this.insert=(t,s)=>this._mutations.insert(t,s),this.delete=(t,s)=>this._mutations.delete(t,s),!e)throw new le;if(!e.sync)throw new ue;e.id?this.id=e.id:this.id=crypto.randomUUID(),this.config={...e,autoIndex:e.autoIndex??"eager"},this._changes=new Be,this._events=new et,this._indexes=new Ye,this._lifecycle=new Qe(e,this.id),this._mutations=new Xe(e,this.id),this._state=new qe(e),this._sync=new We(e,this.id),this._changes.setDeps({collection:this,lifecycle:this._lifecycle,sync:this._sync,events:this._events}),this._events.setDeps({collection:this}),this._indexes.setDeps({state:this._state,lifecycle:this._lifecycle}),this._lifecycle.setDeps({changes:this._changes,events:this._events,indexes:this._indexes,state:this._state,sync:this._sync}),this._mutations.setDeps({collection:this,lifecycle:this._lifecycle,state:this._state}),this._state.setDeps({collection:this,lifecycle:this._lifecycle,changes:this._changes,indexes:this._indexes}),this._sync.setDeps({collection:this,state:this._state,lifecycle:this._lifecycle,events:this._events}),e.startSync===!0&&this._sync.startSync()}get status(){return this._lifecycle.status}get subscriberCount(){return this._changes.activeSubscribersCount}onFirstReady(e){return this._lifecycle.onFirstReady(e)}isReady(){return this._lifecycle.status==="ready"}get isLoadingSubset(){return this._sync.isLoadingSubset}startSyncImmediate(){this._sync.startSync()}preload(){return this._sync.preload()}get(e){return this._state.get(e)}has(e){return this._state.has(e)}get size(){return this._state.size}*keys(){yield*this._state.keys()}*values(){yield*this._state.values()}*entries(){yield*this._state.entries()}*[Symbol.iterator](){yield*this._state[Symbol.iterator]()}forEach(e){return this._state.forEach(e)}map(e){return this._state.map(e)}getKeyFromItem(e){return this.config.getKey(e)}createIndex(e,t={}){return this._indexes.createIndex(e,t)}get indexes(){return this._indexes.indexes}validateData(e,t,s){return this._mutations.validateData(e,t,s)}update(e,t,s){return this._mutations.update(e,t,s)}get state(){let e=new Map;for(let[t,s]of this.entries())e.set(t,s);return e}stateWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.state):this.preload().then(()=>this.state)}get toArray(){return Array.from(this.values())}toArrayWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.toArray):this.preload().then(()=>this.toArray)}currentStateAsChanges(e={}){return Pt(this,e)}subscribeChanges(e,t={}){return this._changes.subscribeChanges(e,t)}on(e,t){return this._events.on(e,t)}once(e,t){return this._events.once(e,t)}off(e,t){this._events.off(e,t)}waitFor(e,t){return this._events.waitFor(e,t)}async cleanup(){return this._lifecycle.cleanup(),Promise.resolve()}};console.log(mt);

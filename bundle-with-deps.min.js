var Bi=Object.defineProperty;var Jn=(r,e)=>{for(var t in e)Bi(r,t,{get:e[t],enumerable:!0})};var $n={};Jn($n,{AggregateFunctionNotInSelectError:()=>It,AggregateNotSupportedError:()=>vr,BTreeIndex:()=>oe,BaseIndex:()=>zt,BaseQueryBuilder:()=>Gt,CannotCombineEmptyExpressionListError:()=>Mt,CollectionConfigurationError:()=>te,CollectionImpl:()=>Ce,CollectionInErrorStateError:()=>Be,CollectionInputNotFoundError:()=>ue,CollectionIsInErrorStateError:()=>Fe,CollectionOperationError:()=>H,CollectionRequiresConfigError:()=>Me,CollectionRequiresSyncConfigError:()=>_e,CollectionStateError:()=>re,DeleteKeyNotFoundError:()=>Ge,DistinctRequiresSelectError:()=>lt,DuplicateKeyError:()=>Le,DuplicateKeySyncError:()=>Ne,EmptyReferencePathError:()=>ht,GroupByError:()=>de,HavingRequiresGroupByError:()=>ut,IR:()=>cn,IndexOperation:()=>Ss,IndexProxy:()=>Ut,InvalidCollectionStatusTransitionError:()=>De,InvalidJoinCondition:()=>vt,InvalidJoinConditionLeftSourceError:()=>xt,InvalidJoinConditionRightSourceError:()=>wt,InvalidJoinConditionSameSourceError:()=>gt,InvalidJoinConditionSourceMismatchError:()=>Tt,InvalidSchemaError:()=>Ae,InvalidSourceError:()=>ot,InvalidStorageDataFormatError:()=>Kt,InvalidStorageObjectFormatError:()=>Et,JoinCollectionNotFoundError:()=>Se,JoinConditionMustBeEqualityError:()=>at,JoinError:()=>Y,KeyUpdateNotAllowedError:()=>He,LazyIndexWrapper:()=>Wt,LimitOffsetRequireOrderByError:()=>dt,LocalStorageCollectionError:()=>be,MissingAliasInputsError:()=>Bt,MissingDeleteHandlerError:()=>Ye,MissingHandlerError:()=>xe,MissingInsertHandlerError:()=>Je,MissingMutationFunctionError:()=>Xe,MissingUpdateArgumentError:()=>We,MissingUpdateHandlerError:()=>Qe,NegativeActiveSubscribersError:()=>je,NoKeysPassedToDeleteError:()=>qe,NoKeysPassedToUpdateError:()=>Ue,NoPendingSyncTransactionCommitError:()=>rt,NoPendingSyncTransactionWriteError:()=>we,NonAggregateExpressionNotInGroupByError:()=>bt,NonRetriableError:()=>wr,OnlyOneSourceAllowedError:()=>st,Query:()=>Ds,QueryBuilderError:()=>ie,QueryCompilationError:()=>L,QueryMustHaveFromClauseError:()=>ct,QueryOptimizerError:()=>Rt,SchemaMustBeSynchronousError:()=>Te,SchemaValidationError:()=>ge,SerializationError:()=>kt,SetWindowRequiresOrderByError:()=>Dt,SortedMap:()=>ke,StorageError:()=>Vt,StorageKeyRequiredError:()=>Ct,SubQueryMustHaveFromClauseError:()=>it,SubscriptionNotFoundError:()=>At,SyncCleanupError:()=>Oe,SyncTransactionAlreadyCommittedError:()=>nt,SyncTransactionAlreadyCommittedWriteError:()=>ve,TanStackDBError:()=>D,TransactionAlreadyCompletedRollbackError:()=>et,TransactionError:()=>J,TransactionNotPendingCommitError:()=>tt,TransactionNotPendingMutateError:()=>Ze,UndefinedKeyError:()=>ze,UnknownExpressionTypeError:()=>ft,UnknownFunctionError:()=>mt,UnknownHavingExpressionTypeError:()=>Pt,UnsupportedAggregateFunctionError:()=>Ot,UnsupportedFromTypeError:()=>pt,UnsupportedJoinSourceTypeError:()=>St,UnsupportedJoinTypeError:()=>yt,UpdateKeyNotFoundError:()=>$e,WhereClauseConversionError:()=>_t,add:()=>ms,and:()=>cr,avg:()=>gs,coalesce:()=>hs,compileQuery:()=>Zt,concat:()=>fs,count:()=>ys,createArrayChangeProxy:()=>yn,createChangeProxy:()=>lr,createCollection:()=>Lr,createLiveQueryCollection:()=>Ci,createOptimisticAction:()=>Rs,createTransaction:()=>ce,eq:()=>ts,getActiveTransaction:()=>pe,gt:()=>Pr,gte:()=>rs,ilike:()=>ls,inArray:()=>kr,isNull:()=>as,isUndefined:()=>os,length:()=>ps,like:()=>cs,liveQueryCollectionOptions:()=>on,localOnlyCollectionOptions:()=>Ms,localStorageCollectionOptions:()=>_s,lower:()=>ds,lt:()=>Vr,lte:()=>ns,max:()=>ws,min:()=>xs,not:()=>is,or:()=>ss,sum:()=>Ts,upper:()=>us,withArrayChangeTracking:()=>Dr,withChangeTracking:()=>Br});var cn={};Jn(cn,{Aggregate:()=>G,CollectionRef:()=>Q,Func:()=>C,PropRef:()=>E,QueryRef:()=>j,Value:()=>z,createResidualWhere:()=>an,followRef:()=>ye,getHavingExpression:()=>Tr,getWhereExpression:()=>sr,isExpressionLike:()=>Re,isResidualWhere:()=>xr});var le=class{},Q=class extends le{constructor(e,t){super(),this.collection=e,this.alias=t,this.type="collectionRef"}},j=class extends le{constructor(e,t){super(),this.query=e,this.alias=t,this.type="queryRef"}},E=class extends le{constructor(e){super(),this.path=e,this.type="ref"}},z=class extends le{constructor(e){super(),this.value=e,this.type="val"}},C=class extends le{constructor(e,t){super(),this.name=e,this.args=t,this.type="func"}},G=class extends le{constructor(e,t){super(),this.name=e,this.args=t,this.type="agg"}};function Re(r){return r instanceof G||r instanceof C||r instanceof E||r instanceof z}function sr(r){return typeof r=="object"&&"expression"in r?r.expression:r}function Tr(r){return typeof r=="object"&&"expression"in r?r.expression:r}function xr(r){return typeof r=="object"&&"expression"in r&&r.residual===!0}function an(r){return{expression:r,residual:!0}}function Di(r,e){if(r.from.alias===e)return r.from;for(let t of r.join||[])if(t.from.alias===e)return t.from}function ye(r,e,t){if(e.path.length!==0){if(e.path.length===1){let n=e.path[0];if(r.select){let s=r.select[n];if(s&&s.type==="ref")return ye(r,s,t)}return{collection:t,path:[n]}}if(e.path.length>1){let[n,...s]=e.path,i=Di(r,n);return i?i.type==="queryRef"?ye(i.query,new E(s),t):{collection:i.collection,path:s}:void 0}}}var D=class extends Error{constructor(e){super(e),this.name="TanStackDBError"}},wr=class extends D{constructor(e){super(e),this.name="NonRetriableError"}},ge=class extends D{constructor(e,t,n){let s=`${e==="insert"?"Insert":"Update"} validation failed: ${t.map(i=>`
- ${i.message} - path: ${i.path}`).join("")}`;super(n||s),this.name="SchemaValidationError",this.type=e,this.issues=t}},te=class extends D{constructor(e){super(e),this.name="CollectionConfigurationError"}},Me=class extends te{constructor(){super("Collection requires a config")}},_e=class extends te{constructor(){super("Collection requires a sync config")}},Ae=class extends te{constructor(){super("Schema must implement the standard-schema interface")}},Te=class extends te{constructor(){super("Schema validation must be synchronous")}},re=class extends D{constructor(e){super(e),this.name="CollectionStateError"}},Be=class extends re{constructor(e,t){super(`Cannot perform ${e} on collection "${t}" - collection is in error state. Try calling cleanup() and restarting the collection.`)}},De=class extends re{constructor(e,t,n){super(`Invalid collection status transition from "${e}" to "${t}" for collection "${n}"`)}},Fe=class extends re{constructor(){super("Collection is in error state")}},je=class extends re{constructor(){super("Active subscribers count is negative - this should never happen")}},H=class extends D{constructor(e){super(e),this.name="CollectionOperationError"}},ze=class extends H{constructor(e){super(`An object was created without a defined key: ${JSON.stringify(e)}`)}},Le=class extends H{constructor(e){super(`Cannot insert document with ID "${e}" because it already exists in the collection`)}},Ne=class extends H{constructor(e,t){super(`Cannot insert document with key "${e}" from sync because it already exists in the collection "${t}"`)}},We=class extends H{constructor(){super("The first argument to update is missing")}},Ue=class extends H{constructor(){super("No keys were passed to update")}},$e=class extends H{constructor(e){super(`The key "${e}" was passed to update but an object for this key was not found in the collection`)}},He=class extends H{constructor(e,t){super(`Updating the key of an item is not allowed. Original key: "${e}", Attempted new key: "${t}". Please delete the old item and create a new one if a key change is necessary.`)}},qe=class extends H{constructor(){super("No keys were passed to delete")}},Ge=class extends H{constructor(e){super(`Collection.delete was called with key '${e}' but there is no item in the collection with this key`)}},xe=class extends D{constructor(e){super(e),this.name="MissingHandlerError"}},Je=class extends xe{constructor(){super("Collection.insert called directly (not within an explicit transaction) but no 'onInsert' handler is configured.")}},Qe=class extends xe{constructor(){super("Collection.update called directly (not within an explicit transaction) but no 'onUpdate' handler is configured.")}},Ye=class extends xe{constructor(){super("Collection.delete called directly (not within an explicit transaction) but no 'onDelete' handler is configured.")}},J=class extends D{constructor(e){super(e),this.name="TransactionError"}},Xe=class extends J{constructor(){super("mutationFn is required when creating a transaction")}},Ze=class extends J{constructor(){super("You can no longer call .mutate() as the transaction is no longer pending")}},et=class extends J{constructor(){super("You can no longer call .rollback() as the transaction is already completed")}},tt=class extends J{constructor(){super("You can no longer call .commit() as the transaction is no longer pending")}},we=class extends J{constructor(){super("No pending sync transaction to write to")}},ve=class extends J{constructor(){super("The pending sync transaction is already committed, you can't still write to it.")}},rt=class extends J{constructor(){super("No pending sync transaction to commit")}},nt=class extends J{constructor(){super("The pending sync transaction is already committed, you can't commit it again.")}},ie=class extends D{constructor(e){super(e),this.name="QueryBuilderError"}},st=class extends ie{constructor(e){super(`Only one source is allowed in the ${e}`)}},it=class extends ie{constructor(e){super(`A sub query passed to a ${e} must have a from clause itself`)}},ot=class extends ie{constructor(e){super(`Invalid source for live query: The value provided for alias "${e}" is not a Collection or subquery. Live queries only accept Collection instances or subqueries. Please ensure you're passing a valid Collection or QueryBuilder, not a plain array or other data type.`)}},at=class extends ie{constructor(){super("Join condition must be an equality expression")}},ct=class extends ie{constructor(){super("Query must have a from clause")}},L=class extends D{constructor(e){super(e),this.name="QueryCompilationError"}},lt=class extends L{constructor(){super("DISTINCT requires a SELECT clause.")}},ut=class extends L{constructor(){super("HAVING clause requires GROUP BY clause")}},dt=class extends L{constructor(){super("LIMIT and OFFSET require an ORDER BY clause to ensure deterministic results")}},ue=class extends L{constructor(e,t,n){let s=t?`alias "${e}" (collection "${t}")`:`collection "${e}"`,i=n?.length?`. Available keys: ${n.join(", ")}`:"";super(`Input for ${s} not found in inputs map${i}`)}},pt=class extends L{constructor(e){super(`Unsupported FROM type: ${e}`)}},ft=class extends L{constructor(e){super(`Unknown expression type: ${e}`)}},ht=class extends L{constructor(){super("Reference path cannot be empty")}},mt=class extends L{constructor(e){super(`Unknown function: ${e}`)}},Se=class extends L{constructor(e){super(`Collection "${e}" not found during compilation of join`)}},Y=class extends D{constructor(e){super(e),this.name="JoinError"}},yt=class extends Y{constructor(e){super(`Unsupported join type: ${e}`)}},gt=class extends Y{constructor(e){super(`Invalid join condition: both expressions refer to the same source "${e}"`)}},Tt=class extends Y{constructor(){super("Invalid join condition: expressions must reference source aliases")}},xt=class extends Y{constructor(e){super(`Invalid join condition: left expression refers to an unavailable source "${e}"`)}},wt=class extends Y{constructor(e){super(`Invalid join condition: right expression does not refer to the joined source "${e}"`)}},vt=class extends Y{constructor(){super("Invalid join condition")}},St=class extends Y{constructor(e){super(`Unsupported join source type: ${e}`)}},de=class extends D{constructor(e){super(e),this.name="GroupByError"}},bt=class extends de{constructor(e){super(`Non-aggregate expression '${e}' in SELECT must also appear in GROUP BY clause`)}},Ot=class extends de{constructor(e){super(`Unsupported aggregate function: ${e}`)}},It=class extends de{constructor(e){super(`Aggregate function in HAVING clause must also be in SELECT clause: ${e}`)}},Pt=class extends de{constructor(e){super(`Unknown expression type in HAVING clause: ${e}`)}},Vt=class extends D{constructor(e){super(e),this.name="StorageError"}},kt=class extends Vt{constructor(e,t){super(`Cannot ${e} item because it cannot be JSON serialized: ${t}`)}},be=class extends Vt{constructor(e){super(e),this.name="LocalStorageCollectionError"}},Ct=class extends be{constructor(){super("[LocalStorageCollection] storageKey must be provided.")}},Kt=class extends be{constructor(e,t){super(`[LocalStorageCollection] Invalid data format in storage key "${e}" for key "${t}".`)}},Et=class extends be{constructor(e){super(`[LocalStorageCollection] Invalid data format in storage key "${e}". Expected object format.`)}},Oe=class extends D{constructor(e,t){let n=t instanceof Error?t.message:String(t);super(`Collection "${e}" sync cleanup function threw an error: ${n}`),this.name="SyncCleanupError"}},Rt=class extends D{constructor(e){super(e),this.name="QueryOptimizerError"}},Mt=class extends Rt{constructor(){super("Cannot combine empty expression list")}},_t=class extends Rt{constructor(e,t){super(`Failed to convert WHERE clause to collection filter for collection '${e}' alias '${t}'. This indicates a bug in the query optimization logic.`)}},At=class extends L{constructor(e,t,n,s){super(`Internal error: subscription for alias '${e}' (remapped from '${t}', collection '${n}') is missing in join pipeline. Available aliases: ${s.join(", ")}. This indicates a bug in alias tracking.`)}},vr=class extends L{constructor(){super("Aggregate expressions are not supported in this context. Use GROUP BY clause for aggregates.")}},Bt=class extends L{constructor(e){super(`Internal error: compiler returned aliases without inputs: ${e.join(", ")}. This indicates a bug in query compilation. Please report this issue.`)}},Dt=class extends L{constructor(){super("setWindow() can only be called on collections with an ORDER BY clause. Add .orderBy() to your query to enable window movement.")}};var ln=new WeakMap,Fi=1;function Qn(r){if(ln.has(r))return ln.get(r);let e=Fi++;return ln.set(r,e),e}var un=(r,e,t)=>{let{nulls:n}=t;if(r==null&&e==null)return 0;if(r==null)return n==="first"?-1:1;if(e==null)return n==="first"?1:-1;if(typeof r=="string"&&typeof e=="string"&&t.stringSort==="locale")return r.localeCompare(e,t.locale,t.localeOptions);if(Array.isArray(r)&&Array.isArray(e)){for(let o=0;o<Math.min(r.length,e.length);o++){let a=un(r[o],e[o],t);if(a!==0)return a}return r.length-e.length}if(r instanceof Date&&e instanceof Date)return r.getTime()-e.getTime();let s=typeof r=="object",i=typeof e=="object";if(s||i){if(s&&i){let o=Qn(r),a=Qn(e);return o-a}if(s)return 1;if(i)return-1}return r<e?-1:r>e?1:0},ji=(r,e,t)=>un(e,r,{...t,nulls:t.nulls==="first"?"last":"first"});function Ft(r){return(e,t)=>r.direction==="asc"?un(e,t,r):ji(e,t,r)}var ir=Ft({direction:"asc",nulls:"first",stringSort:"locale"});function X(r){return r instanceof Date?r.getTime():r}function W(r,e=!1){return dn(r,e)}function or(r){return dn(r,!0)}function dn(r,e){switch(r.type){case"val":{let t=r.value;return()=>t}case"ref":return e?Li(r):zi(r);case"func":return Ni(r,e);default:throw new ft(r.type)}}function zi(r){let[e,...t]=r.path;if(!e)throw new ht;if(t.length===0)return n=>n[e];if(t.length===1){let n=t[0];return s=>s[e]?.[n]}else return n=>{let s=n[e];if(s===void 0)return;let i=s;for(let o of t){if(i==null)return i;i=i[o]}return i}}function Li(r){let e=r.path;return t=>{let n=t;for(let s of e){if(n==null)return n;n=n[s]}return n}}function Ni(r,e){let t=r.args.map(n=>dn(n,e));switch(r.name){case"eq":{let n=t[0],s=t[1];return i=>{let o=X(n(i)),a=X(s(i));return o===a}}case"gt":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return o>a}}case"gte":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return o>=a}}case"lt":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return o<a}}case"lte":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return o<=a}}case"and":return n=>{for(let s of t)if(!s(n))return!1;return!0};case"or":return n=>{for(let s of t)if(s(n))return!0;return!1};case"not":{let n=t[0];return s=>!n(s)}case"in":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return Array.isArray(a)?a.includes(o):!1}}case"like":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return Yn(o,a,!1)}}case"ilike":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return Yn(o,a,!0)}}case"upper":{let n=t[0];return s=>{let i=n(s);return typeof i=="string"?i.toUpperCase():i}}case"lower":{let n=t[0];return s=>{let i=n(s);return typeof i=="string"?i.toLowerCase():i}}case"length":{let n=t[0];return s=>{let i=n(s);return typeof i=="string"||Array.isArray(i)?i.length:0}}case"concat":return n=>t.map(s=>{let i=s(n);try{return String(i??"")}catch{try{return JSON.stringify(i)||""}catch{return"[object]"}}}).join("");case"coalesce":return n=>{for(let s of t){let i=s(n);if(i!=null)return i}return null};case"add":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return(o??0)+(a??0)}}case"subtract":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return(o??0)-(a??0)}}case"multiply":{let n=t[0],s=t[1];return i=>{let o=n(i),a=s(i);return(o??0)*(a??0)}}case"divide":{let n=t[0],s=t[1];return i=>{let o=n(i),c=s(i)??0;return c!==0?(o??0)/c:null}}case"isUndefined":{let n=t[0];return s=>n(s)===void 0}case"isNull":{let n=t[0];return s=>n(s)===null}default:throw new mt(r.name)}}function Yn(r,e,t){if(typeof r!="string"||typeof e!="string")return!1;let n=t?r.toLowerCase():r,i=(t?e.toLowerCase():e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return i=i.replace(/%/g,".*"),i=i.replace(/_/g,"."),new RegExp(`^${i}$`).test(n)}function $(r,e){return Sr(r,e,new Map)}function Sr(r,e,t){if(r===e)return!0;if(r==null||e==null||typeof r!=typeof e)return!1;if(r instanceof Date)return e instanceof Date?r.getTime()===e.getTime():!1;if(r instanceof RegExp)return e instanceof RegExp?r.source===e.source&&r.flags===e.flags:!1;if(r instanceof Map){if(!(e instanceof Map)||r.size!==e.size)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let s=Array.from(r.entries()).every(([i,o])=>e.has(i)&&Sr(o,e.get(i),t));return t.delete(r),s}if(r instanceof Set){if(!(e instanceof Set)||r.size!==e.size)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let n=Array.from(r),s=Array.from(e);if(n.every(o=>typeof o!="object"))return t.delete(r),n.every(o=>e.has(o));let i=n.length===s.length;return t.delete(r),i}if(ArrayBuffer.isView(r)&&ArrayBuffer.isView(e)&&!(r instanceof DataView)&&!(e instanceof DataView)){let n=r,s=e;if(n.length!==s.length)return!1;for(let i=0;i<n.length;i++)if(n[i]!==s[i])return!1;return!0}if(ar(r)&&ar(e)){let n=pn(r),s=pn(e);return n!==s?!1:typeof r.equals=="function"?r.equals(e):r.toString()===e.toString()}if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let n=r.every((s,i)=>Sr(s,e[i],t));return t.delete(r),n}if(typeof r=="object"){if(t.has(r))return t.get(r)===e;t.set(r,e);let n=Object.keys(r),s=Object.keys(e);if(n.length!==s.length)return t.delete(r),!1;let i=n.every(o=>o in e&&Sr(r[o],e[o],t));return t.delete(r),i}return!1}var Wi=["Temporal.Duration","Temporal.Instant","Temporal.PlainDate","Temporal.PlainDateTime","Temporal.PlainMonthDay","Temporal.PlainTime","Temporal.PlainYearMonth","Temporal.ZonedDateTime"];function pn(r){return r[Symbol.toStringTag]}function ar(r){let e=pn(r);return typeof e=="string"&&Wi.includes(e)}var jt={direction:"asc",nulls:"first",stringSort:"locale"};var br=class{constructor(e){this.originalIndex=e}lookup(e,t){let n=e==="gt"?"lt":e==="gte"?"lte":e==="lt"?"gt":e==="lte"?"gte":e;return this.originalIndex.lookup(n,t)}rangeQuery(e={}){return this.originalIndex.rangeQueryReversed(e)}rangeQueryReversed(e={}){return this.originalIndex.rangeQuery(e)}take(e,t,n){return this.originalIndex.takeReversed(e,t,n)}takeReversed(e,t,n){return this.originalIndex.take(e,t,n)}get orderedEntriesArray(){return this.originalIndex.orderedEntriesArrayReversed}get orderedEntriesArrayReversed(){return this.originalIndex.orderedEntriesArray}supports(e){return this.originalIndex.supports(e)}matchesField(e){return this.originalIndex.matchesField(e)}matchesCompareOptions(e){return this.originalIndex.matchesCompareOptions(e)}matchesDirection(e){return this.originalIndex.matchesDirection(e)}getStats(){return this.originalIndex.getStats()}add(e,t){this.originalIndex.add(e,t)}remove(e,t){this.originalIndex.remove(e,t)}update(e,t,n){this.originalIndex.update(e,t,n)}build(e){this.originalIndex.build(e)}clear(){this.originalIndex.clear()}get keyCount(){return this.originalIndex.keyCount}equalityLookup(e){return this.originalIndex.equalityLookup(e)}inArrayLookup(e){return this.originalIndex.inArrayLookup(e)}get indexedKeysSet(){return this.originalIndex.indexedKeysSet}get valueMapData(){return this.originalIndex.valueMapData}};function Ie(r,e,t=jt){for(let n of r.values())if(n.matchesField(e)&&n.matchesCompareOptions(t))return n.matchesDirection(t.direction)?n:new br(n)}function Ui(r){if(r.length===0)return new Set;if(r.length===1)return new Set(r[0]);let e=new Set(r[0]);for(let t=1;t<r.length;t++){let n=new Set;for(let s of e)r[t].has(s)&&n.add(s);e=n}return e}function $i(r){let e=new Set;for(let t of r)for(let n of t)e.add(n);return e}function Xn(r,e){return fn(r,e)}function fn(r,e){if(r.type==="func")switch(r.name){case"eq":case"gt":case"gte":case"lt":case"lte":return qi(r,e);case"and":return Gi(r,e);case"or":return Ji(r,e);case"in":return Qi(r,e)}return{canOptimize:!1,matchingKeys:new Set}}function Hi(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=new Map;for(let n of r.args)if(n.type==="func"&&["gt","gte","lt","lte"].includes(n.name)){let s=n;if(s.args.length===2){let i=s.args[0],o=s.args[1],a=null,c=null,l=s.name;if(i.type==="ref"&&o.type==="val")a=i,c=o;else if(i.type==="val"&&o.type==="ref")switch(a=o,c=i,l){case"gt":l="lt";break;case"gte":l="lte";break;case"lt":l="gt";break;case"lte":l="gte";break}if(a&&c){let u=a.path.join("."),f=c.value;t.has(u)||t.set(u,[]),t.get(u).push({operation:l,value:f})}}}for(let[n,s]of t)if(s.length>=2){let i=n.split("."),o=Ie(e,i);if(o&&o.supports("gt")&&o.supports("lt")){let a,c,l=!0,d=!0;for(let{operation:f,value:p}of s)switch(f){case"gt":(a===void 0||p>a)&&(a=p,l=!1);break;case"gte":(a===void 0||p>a)&&(a=p,l=!0);break;case"lt":(c===void 0||p<c)&&(c=p,d=!1);break;case"lte":(c===void 0||p<c)&&(c=p,d=!0);break}return{canOptimize:!0,matchingKeys:o.rangeQuery({from:a,to:c,fromInclusive:l,toInclusive:d})}}}return{canOptimize:!1,matchingKeys:new Set}}function qi(r,e){if(r.type!=="func"||r.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let t=r.args[0],n=r.args[1],s=null,i=null,o=r.name;if(t.type==="ref"&&n.type==="val")s=t,i=n;else if(t.type==="val"&&n.type==="ref")switch(s=n,i=t,o){case"gt":o="lt";break;case"gte":o="lte";break;case"lt":o="gt";break;case"lte":o="gte";break}if(s&&i){let a=s.path,c=Ie(e,a);if(c){let l=i.value,d=o;return c.supports(d)?{canOptimize:!0,matchingKeys:c.lookup(d,l)}:{canOptimize:!1,matchingKeys:new Set}}}return{canOptimize:!1,matchingKeys:new Set}}function Gi(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=Hi(r,e);if(t.canOptimize)return t;let n=[];for(let s of r.args){let i=fn(s,e);i.canOptimize&&n.push(i)}if(n.length>0){let s=n.map(o=>o.matchingKeys);return{canOptimize:!0,matchingKeys:Ui(s)}}return{canOptimize:!1,matchingKeys:new Set}}function Ji(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=[];for(let n of r.args){let s=fn(n,e);s.canOptimize&&t.push(s)}if(t.length>0){let n=t.map(i=>i.matchingKeys);return{canOptimize:!0,matchingKeys:$i(n)}}return{canOptimize:!1,matchingKeys:new Set}}function Qi(r,e){if(r.type!=="func"||r.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let t=r.args[0],n=r.args[1];if(t.type==="ref"&&n.type==="val"&&Array.isArray(n.value)){let s=t.path,i=n.value,o=Ie(e,s);if(o){if(o.supports("in"))return{canOptimize:!0,matchingKeys:o.lookup("in",i)};if(o.supports("eq")){let a=new Set;for(let c of i){let l=o.lookup("eq",c);for(let d of l)a.add(d)}return{canOptimize:!0,matchingKeys:a}}}}return{canOptimize:!1,matchingKeys:new Set}}var Or=class{constructor(e,t,n){this._root=hn,this._size=0,this._maxNodeSize=n>=4?Math.min(n,256):32,this._compare=e,t&&this.setPairs(t)}get size(){return this._size}get length(){return this._size}get isEmpty(){return this._size===0}clear(){this._root=hn,this._size=0}get(e,t){return this._root.get(e,t,this)}set(e,t,n){this._root.isShared&&(this._root=this._root.clone());let s=this._root.set(e,t,n,this);return s===!0||s===!1?s:(this._root=new mn([this._root,s]),!0)}has(e){return this.forRange(e,e,!0,void 0)!==0}delete(e){return this.editRange(e,e,!0,Xi)!==0}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}keysArray(){let e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(t,n)=>{e.push(t)}),e}nextHigherPair(e,t){return t=t||[],e===void 0?this._root.minPair(t):this._root.getPairOrNextHigher(e,this._compare,!1,t)}nextHigherKey(e){let t=this.nextHigherPair(e,Zn);return t&&t[0]}nextLowerPair(e,t){return t=t||[],e===void 0?this._root.maxPair(t):this._root.getPairOrNextLower(e,this._compare,!1,t)}nextLowerKey(e){let t=this.nextLowerPair(e,Zn);return t&&t[0]}setPairs(e,t){let n=0;for(let s of e)this.set(s[0],s[1],t)&&n++;return n}forRange(e,t,n,s,i){let o=this._root.forRange(e,t,n,!1,this,i||0,s);return typeof o=="number"?o:o.break}editRange(e,t,n,s,i){let o=this._root;o.isShared&&(this._root=o=o.clone());try{let a=o.forRange(e,t,n,!0,this,i||0,s);return typeof a=="number"?a:a.break}finally{let a;for(;o.keys.length<=1&&!o.isLeaf;)a||=o.isShared,this._root=o=o.keys.length===0?hn:o.children[0];a&&(o.isShared=!0)}}},Ir=class r{get isLeaf(){return this.children===void 0}constructor(e=[],t){this.keys=e,this.values=t||U,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,t,n){let s=this.keys,i=0,o=s.length,a=o>>1;for(;i<o;){let c=n(s[a],e);if(c<0)i=a+1;else if(c>0)o=a;else{if(c===0)return a;if(e===e)return s.length;throw new Error("BTree: NaN was used as a key")}a=i+o>>1}return a^t}minKey(){return this.keys[0]}minPair(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(this.keys.length===0)return;let t=this.keys.length-1;return e[0]=this.keys[t],e[1]=this.values[t],e}clone(){let e=this.values;return new r(this.keys.slice(0),e===U?e:e.slice(0))}get(e,t,n){let s=this.indexOf(e,-1,n._compare);return s<0?t:this.values[s]}getPairOrNextLower(e,t,n,s){let i=this.indexOf(e,-1,t),o=i<0?~i-1:n?i:i-1;if(o>=0)return s[0]=this.keys[o],s[1]=this.values[o],s}getPairOrNextHigher(e,t,n,s){let i=this.indexOf(e,-1,t),o=i<0?~i:n?i:i+1,a=this.keys;if(o<a.length)return s[0]=a[o],s[1]=this.values[o],s}set(e,t,n,s){let i=this.indexOf(e,-1,s._compare);if(i<0){if(i=~i,s._size++,this.keys.length<s._maxNodeSize)return this.insertInLeaf(i,e,t,s);{let o=this.splitOffRightSide(),a=this;return i>this.keys.length&&(i-=this.keys.length,a=o),a.insertInLeaf(i,e,t,s),o}}else return n!==!1&&(t!==void 0&&this.reifyValues(),this.keys[i]=e,this.values[i]=t),!1}reifyValues(){return this.values===U?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,t,n,s){if(this.keys.splice(e,0,t),this.values===U){for(;U.length<s._maxNodeSize;)U.push(void 0);if(n===void 0)return!0;this.values=U.slice(0,this.keys.length-1)}return this.values.splice(e,0,n),!0}takeFromRight(e){let t=this.values;e.values===U?t!==U&&t.push(void 0):(t=this.reifyValues(),t.push(e.values.shift())),this.keys.push(e.keys.shift())}takeFromLeft(e){let t=this.values;e.values===U?t!==U&&t.unshift(void 0):(t=this.reifyValues(),t.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())}splitOffRightSide(){let e=this.keys.length>>1,t=this.keys.splice(e),n=this.values===U?U:this.values.splice(e);return new r(t,n)}forRange(e,t,n,s,i,o,a){let c=i._compare,l,d;if(t===e){if(!n||(d=(l=this.indexOf(e,-1,c))+1,l<0))return o}else l=this.indexOf(e,0,c),d=this.indexOf(t,-1,c),d<0?d=~d:n===!0&&d++;let u=this.keys,f=this.values;if(a!==void 0)for(let p=l;p<d;p++){let h=u[p],m=a(h,f[p],o++);if(m!==void 0){if(s===!0){if(h!==u[p]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");m.delete?(this.keys.splice(p,1),this.values!==U&&this.values.splice(p,1),i._size--,p--,d--):m.hasOwnProperty("value")&&(f[p]=m.value)}if(m.break!==void 0)return m}}else o+=d-l;return o}mergeSibling(e,t){if(this.keys.push.apply(this.keys,e.keys),this.values===U){if(e.values===U)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}},mn=class r extends Ir{constructor(e,t){if(!t){t=[];for(let n=0;n<e.length;n++)t[n]=e[n].maxKey()}super(t),this.children=e}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,t,n){let s=this.indexOf(e,0,n._compare),i=this.children;return s<i.length?i[s].get(e,t,n):void 0}getPairOrNextLower(e,t,n,s){let i=this.indexOf(e,0,t),o=this.children;if(i>=o.length)return this.maxPair(s);let a=o[i].getPairOrNextLower(e,t,n,s);return a===void 0&&i>0?o[i-1].maxPair(s):a}getPairOrNextHigher(e,t,n,s){let i=this.indexOf(e,0,t),o=this.children,a=o.length;if(i>=a)return;let c=o[i].getPairOrNextHigher(e,t,n,s);return c===void 0&&i<a-1?o[i+1].minPair(s):c}set(e,t,n,s){let i=this.children,o=s._maxNodeSize,a=s._compare,c=Math.min(this.indexOf(e,0,a),i.length-1),l=i[c];if(l.isShared&&(i[c]=l=l.clone()),l.keys.length>=o){let u;c>0&&(u=i[c-1]).keys.length<o&&a(l.keys[0],e)<0?(u.isShared&&(i[c-1]=u=u.clone()),u.takeFromRight(l),this.keys[c-1]=u.maxKey()):(u=i[c+1])!==void 0&&u.keys.length<o&&a(l.maxKey(),e)<0&&(u.isShared&&(i[c+1]=u=u.clone()),u.takeFromLeft(l),this.keys[c]=i[c].maxKey())}let d=l.set(e,t,n,s);if(d===!1)return!1;if(this.keys[c]=l.maxKey(),d===!0)return!0;if(this.keys.length<o)return this.insert(c+1,d),!0;{let u=this.splitOffRightSide(),f=this;return a(d.maxKey(),this.maxKey())>0&&(f=u,c-=this.keys.length),f.insert(c+1,d),u}}insert(e,t){this.children.splice(e,0,t),this.keys.splice(e,0,t.maxKey())}splitOffRightSide(){let e=this.children.length>>1;return new r(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,t,n,s,i,o,a){let c=i._compare,l=this.keys,d=this.children,u=this.indexOf(e,0,c),f=u,p=Math.min(t===e?u:this.indexOf(t,0,c),l.length-1);if(s){if(f<=p)try{for(;f<=p;f++){d[f].isShared&&(d[f]=d[f].clone());let h=d[f].forRange(e,t,n,s,i,o,a);if(l[f]=d[f].maxKey(),typeof h!="number")return h;o=h}}finally{let h=i._maxNodeSize>>1;for(u>0&&u--,f=p;f>=u;f--)d[f].keys.length<=h&&(d[f].keys.length!==0?this.tryMerge(f,i._maxNodeSize):(l.splice(f,1),d.splice(f,1)));d.length!==0&&d[0].keys.length===0&&Zi(!1,"emptiness bug")}}else for(;f<=p;f++){let h=d[f].forRange(e,t,n,s,i,o,a);if(typeof h!="number")return h;o=h}return o}tryMerge(e,t){let n=this.children;return e>=0&&e+1<n.length&&n[e].keys.length+n[e+1].keys.length<=t?(n[e].isShared&&(n[e]=n[e].clone()),n[e].mergeSibling(n[e+1],t),n.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=n[e].maxKey(),!0):!1}mergeSibling(e,t){let n=this.keys.length;this.keys.push.apply(this.keys,e.keys);let s=e.children;if(this.children.push.apply(this.children,s),e.isShared&&!this.isShared)for(let i of s)i.isShared=!0;this.tryMerge(n-1,t)}},U=[],Yi={delete:!0},Xi=()=>Yi,hn=(function(){let r=new Ir;return r.isShared=!0,r})(),Zn=[];function Zi(r,...e){throw e.unshift("B+ tree"),new Error(e.join(" "))}function es(){let r=new Map;function e(t){let n=t.join(".");if(r.has(n))return r.get(n);let s=new Proxy({},{get(i,o,a){if(o==="__refProxy")return!0;if(o==="__path")return t;if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(i,o,a);let c=[...t,String(o)];return e(c)},has(i,o){return o==="__refProxy"||o==="__path"||o==="__type"?!0:Reflect.has(i,o)},ownKeys(i){return Reflect.ownKeys(i)},getOwnPropertyDescriptor(i,o){return o==="__refProxy"||o==="__path"||o==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(i,o)}});return r.set(n,s),s}return e([])}function Pe(r){let e=new Map,t=0;function n(i){let o=i.join(".");if(e.has(o))return e.get(o);let a=new Proxy({},{get(c,l,d){if(l==="__refProxy")return!0;if(l==="__path")return i;if(l==="__type")return;if(typeof l=="symbol")return Reflect.get(c,l,d);let u=[...i,String(l)];return n(u)},has(c,l){return l==="__refProxy"||l==="__path"||l==="__type"?!0:Reflect.has(c,l)},ownKeys(c){let l=++t,d=`__SPREAD_SENTINEL__${i.join(".")}__${l}`;return Object.prototype.hasOwnProperty.call(c,d)||Object.defineProperty(c,d,{enumerable:!0,configurable:!0,value:!0}),Reflect.ownKeys(c)},getOwnPropertyDescriptor(c,l){return l==="__refProxy"||l==="__path"||l==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(c,l)}});return e.set(o,a),a}return new Proxy({},{get(i,o,a){if(o==="__refProxy")return!0;if(o==="__path")return[];if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(i,o,a);let c=String(o);if(r.includes(c))return n([c])},has(i,o){return o==="__refProxy"||o==="__path"||o==="__type"||typeof o=="string"&&r.includes(o)?!0:Reflect.has(i,o)},ownKeys(i){return[...r,"__refProxy","__path","__type"]},getOwnPropertyDescriptor(i,o){if(o==="__refProxy"||o==="__path"||o==="__type")return{enumerable:!1,configurable:!0};if(typeof o=="string"&&r.includes(o))return{enumerable:!0,configurable:!0}}})}function b(r){return eo(r)?new E(r.__path):r&&typeof r=="object"&&"type"in r&&(r.type==="func"||r.type==="ref"||r.type==="val"||r.type==="agg")?r:new z(r)}function eo(r){return r&&typeof r=="object"&&r.__refProxy===!0}function ts(r,e){return new C("eq",[b(r),b(e)])}function Pr(r,e){return new C("gt",[b(r),b(e)])}function rs(r,e){return new C("gte",[b(r),b(e)])}function Vr(r,e){return new C("lt",[b(r),b(e)])}function ns(r,e){return new C("lte",[b(r),b(e)])}function cr(r,e,...t){let n=[r,e,...t];return new C("and",n.map(s=>b(s)))}function ss(r,e,...t){let n=[r,e,...t];return new C("or",n.map(s=>b(s)))}function is(r){return new C("not",[b(r)])}function os(r){return new C("isUndefined",[b(r)])}function as(r){return new C("isNull",[b(r)])}function kr(r,e){return new C("in",[b(r),b(e)])}function cs(r,e){return new C("like",[b(r),b(e)])}function ls(r,e){return new C("ilike",[b(r),b(e)])}function us(r){return new C("upper",[b(r)])}function ds(r){return new C("lower",[b(r)])}function ps(r){return new C("length",[b(r)])}function fs(...r){return new C("concat",r.map(e=>b(e)))}function hs(...r){return new C("coalesce",r.map(e=>b(e)))}function ms(r,e){return new C("add",[b(r),b(e)])}function ys(r){return new G("count",[b(r)])}function gs(r){return new G("avg",[b(r)])}function Ts(r){return new G("sum",[b(r)])}function xs(r){return new G("min",[b(r)])}function ws(r){return new G("max",[b(r)])}var vs=["eq","gt","gte","lt","lte","in","like","ilike"];var Ss=vs,zt=class{constructor(e,t,n,s){this.lookupCount=0,this.totalLookupTime=0,this.lastUpdated=new Date,this.id=e,this.expression=t,this.compareOptions=jt,this.name=n,this.initialize(s)}supports(e){return this.supportedOperations.has(e)}matchesField(e){return this.expression.type==="ref"&&this.expression.path.length===e.length&&this.expression.path.every((t,n)=>t===e[n])}matchesCompareOptions(e){let t={...this.compareOptions,direction:void 0},n={...e,direction:void 0};return $(t,n)}matchesDirection(e){return this.compareOptions.direction===e}getStats(){return{entryCount:this.keyCount,lookupCount:this.lookupCount,averageLookupTime:this.lookupCount>0?this.totalLookupTime/this.lookupCount:0,lastUpdated:this.lastUpdated}}evaluateIndexExpression(e){return or(this.expression)(e)}trackLookup(e){let t=performance.now()-e;this.lookupCount++,this.totalLookupTime+=t}updateTimestamp(){this.lastUpdated=new Date}};var oe=class extends zt{constructor(e,t,n,s){super(e,t,n,s),this.supportedOperations=new Set(["eq","gt","gte","lt","lte","in"]),this.valueMap=new Map,this.indexedKeys=new Set,this.compareFn=ir,this.compareFn=s?.compareFn??ir,s?.compareOptions&&(this.compareOptions=s.compareOptions),this.orderedEntries=new Or(this.compareFn)}initialize(e){}add(e,t){let n;try{n=this.evaluateIndexExpression(t)}catch(i){throw new Error(`Failed to evaluate index expression for key ${e}: ${i}`)}let s=X(n);if(this.valueMap.has(s))this.valueMap.get(s).add(e);else{let i=new Set([e]);this.valueMap.set(s,i),this.orderedEntries.set(s,void 0)}this.indexedKeys.add(e),this.updateTimestamp()}remove(e,t){let n;try{n=this.evaluateIndexExpression(t)}catch(i){console.warn(`Failed to evaluate index expression for key ${e} during removal:`,i);return}let s=X(n);if(this.valueMap.has(s)){let i=this.valueMap.get(s);i.delete(e),i.size===0&&(this.valueMap.delete(s),this.orderedEntries.delete(s))}this.indexedKeys.delete(e),this.updateTimestamp()}update(e,t,n){this.remove(e,t),this.add(e,n)}build(e){this.clear();for(let[t,n]of e)this.add(t,n)}clear(){this.orderedEntries.clear(),this.valueMap.clear(),this.indexedKeys.clear(),this.updateTimestamp()}lookup(e,t){let n=performance.now(),s;switch(e){case"eq":s=this.equalityLookup(t);break;case"gt":s=this.rangeQuery({from:t,fromInclusive:!1});break;case"gte":s=this.rangeQuery({from:t,fromInclusive:!0});break;case"lt":s=this.rangeQuery({to:t,toInclusive:!1});break;case"lte":s=this.rangeQuery({to:t,toInclusive:!0});break;case"in":s=this.inArrayLookup(t);break;default:throw new Error(`Operation ${e} not supported by BTreeIndex`)}return this.trackLookup(n),s}get keyCount(){return this.indexedKeys.size}equalityLookup(e){let t=X(e);return new Set(this.valueMap.get(t)??[])}rangeQuery(e={}){let{from:t,to:n,fromInclusive:s=!0,toInclusive:i=!0}=e,o=new Set,a=X(t),c=X(n),l=a??this.orderedEntries.minKey(),d=c??this.orderedEntries.maxKey();return this.orderedEntries.forRange(l,d,i,(u,f)=>{if(!s&&this.compareFn(u,t)===0)return;let p=this.valueMap.get(u);p&&p.forEach(h=>o.add(h))}),o}rangeQueryReversed(e={}){let{from:t,to:n,fromInclusive:s=!0,toInclusive:i=!0}=e;return this.rangeQuery({from:n??this.orderedEntries.maxKey(),to:t??this.orderedEntries.minKey(),fromInclusive:i,toInclusive:s})}takeInternal(e,t,n,s){let i=new Set,o=[],a,c=X(n);for(;(a=t(c))!==void 0&&o.length<e;){c=a[0];let l=this.valueMap.get(c);if(l){let d=l.values(),u;for(;o.length<e&&(u=d.next().value);)!i.has(u)&&(s?.(u)??!0)&&(o.push(u),i.add(u))}}return o}take(e,t,n){let s=i=>this.orderedEntries.nextHigherPair(i);return this.takeInternal(e,s,t,n)}takeReversed(e,t,n){let s=i=>this.orderedEntries.nextLowerPair(i);return this.takeInternal(e,s,t,n)}inArrayLookup(e){let t=new Set;for(let n of e){let s=X(n),i=this.valueMap.get(s);i&&i.forEach(o=>t.add(o))}return t}get indexedKeysSet(){return this.indexedKeys}get orderedEntriesArray(){return this.orderedEntries.keysArray().map(e=>[e,this.valueMap.get(e)??new Set])}get orderedEntriesArrayReversed(){return this.takeReversed(this.orderedEntries.size).map(e=>[e,this.valueMap.get(e)??new Set])}get valueMapData(){return this.valueMap}};function bs(r){return r.config.autoIndex==="eager"}function Ve(r,e,t,n=jt,s){if(!(!bs(t)||Array.from(t.indexes.values()).find(o=>o.matchesField(e)&&o.matchesCompareOptions(n))))try{t.createIndex(o=>o[r],{name:`auto_${r}`,indexType:oe,options:s?{compareFn:s,compareOptions:n}:{}})}catch(o){console.warn(`${t.id?`[${t.id}] `:""}Failed to create auto-index for field "${r}":`,o)}}function Os(r,e){if(!bs(e))return;let t=to(r);for(let{fieldName:n,fieldPath:s}of t)Ve(n,s,e)}function to(r){let e=[];function t(n){if(n.type!=="func")return;let s=n;if(s.name==="and"){for(let l of s.args)t(l);return}if(!["eq","gt","gte","lt","lte","in"].includes(s.name)||s.args.length<1||s.args[0].type!=="ref")return;let a=s.args[0].path;if(a.length!==1)return;let c=a[0];e.push({fieldName:c,fieldPath:a})}return t(r),e}function Ps(r,e={}){let t=n=>{let s=[];for(let[i,o]of r.entries())(n?.(o)??!0)&&s.push({type:"insert",key:i,value:o});return s};if(e.limit!==void 0&&!e.orderBy)throw new Error("limit cannot be used without orderBy");if(e.orderBy){let n=e.where?Lt(e.where):void 0,s=ro(r,e.orderBy,e.limit,n,e.optimizedOnly);if(s===void 0)return;let i=[];for(let o of s){let a=r.get(o);a!==void 0&&i.push({type:"insert",key:o,value:a})}return i}if(!e.where)return t();try{let n=e.where,s=Xn(n,r.indexes);if(s.canOptimize){let i=[];for(let o of s.matchingKeys){let a=r.get(o);a!==void 0&&i.push({type:"insert",key:o,value:a})}return i}else{if(e.optimizedOnly)return;let i=Lt(n);return t(i)}}catch(n){console.warn(`${r.id?`[${r.id}] `:""}Error processing where clause, falling back to full scan:`,n);let s=Lt(e.where);return e.optimizedOnly?void 0:t(s)}}function Lt(r){return e=>{try{return!!or(r)(e)}catch{return!1}}}function Vs(r,e){let t=Lt(e.whereExpression);return n=>{let s=[];for(let i of n)if(i.type==="insert")t(i.value)&&s.push(i);else if(i.type==="update"){let o=t(i.value),a=i.previousValue?t(i.previousValue):!1;o&&a?s.push(i):o&&!a?s.push({...i,type:"insert"}):!o&&a&&s.push({...i,type:"delete",value:i.previousValue})}else t(i.value)&&s.push(i);(s.length>0||n.length===0)&&r(s)}}function ro(r,e,t,n,s){if(e.length===1){let c=e[0],l=c.expression;if(l.type==="ref"){let u=l.path;Ve(u[0],u,r,c.compareOptions);let f=Ie(r.indexes,u,c.compareOptions);if(f&&f.supports("gt")){let p=h=>{let m=r.get(h);return m===void 0?!1:n?.(m)??!0};return f.take(t??f.keyCount,void 0,p)}}}if(s)return;let i=[];for(let[c,l]of r.entries())(n?.(l)??!0)&&i.push({key:c,value:l});let o=(c,l)=>{for(let d of e){let u=Ft(d.compareOptions),f=Is(c.value,d.expression),p=Is(l.value,d.expression),h=u(f,p);if(h!==0)return h}return 0};i.sort(o);let a=i.map(c=>c.key);return t!==void 0?a.slice(0,t):a}function Is(r,e){if(e.type==="ref"){let t=e,n=r;for(let s of t.path)n=n?.[s];return n}else return e.type==="val"?e.value:or(e)(r)}var ke=class{constructor(e){this.map=new Map,this.sortedKeys=[],this.comparator=e||this.defaultComparator}defaultComparator(e,t){return e<t?-1:e>t?1:0}indexOf(e){let t=0,n=this.sortedKeys.length;for(;t<n;){let s=Math.floor((t+n)/2),i=this.sortedKeys[s],o=this.map.get(i),a=this.comparator(e,o);if(a<0)n=s;else if(a>0)t=s+1;else return s}return t}set(e,t){if(this.map.has(e)){let s=this.map.get(e),i=this.indexOf(s);this.sortedKeys.splice(i,1)}let n=this.indexOf(t);return this.sortedKeys.splice(n,0,e),this.map.set(e,t),this}get(e){return this.map.get(e)}delete(e){if(this.map.has(e)){let t=this.map.get(e),n=this.indexOf(t);return this.sortedKeys.splice(n,1),this.map.delete(e)}return!1}has(e){return this.map.has(e)}clear(){this.map.clear(),this.sortedKeys=[]}get size(){return this.map.size}*[Symbol.iterator](){for(let e of this.sortedKeys)yield[e,this.map.get(e)]}entries(){return this[Symbol.iterator]()}keys(){return this.sortedKeys[Symbol.iterator]()}values(){return(function*(){for(let e of this.sortedKeys)yield this.map.get(e)}).call(this)}forEach(e){for(let t of this.sortedKeys)e(this.map.get(t),t,this.map)}};var Cr=class{constructor(e){this.pendingSyncedTransactions=[],this.syncedMetadata=new Map,this.optimisticUpserts=new Map,this.optimisticDeletes=new Set,this.size=0,this.syncedKeys=new Set,this.preSyncVisibleState=new Map,this.recentlySyncedKeys=new Set,this.hasReceivedFirstCommit=!1,this.isCommittingSyncTransactions=!1,this.commitPendingTransactions=()=>{let t=!1;for(let o of this.transactions.values())if(o.state==="persisting"){t=!0;break}let{committedSyncedTransactions:n,uncommittedSyncedTransactions:s,hasTruncateSync:i}=this.pendingSyncedTransactions.reduce((o,a)=>(a.committed?(o.committedSyncedTransactions.push(a),a.truncate===!0&&(o.hasTruncateSync=!0)):o.uncommittedSyncedTransactions.push(a),o),{committedSyncedTransactions:[],uncommittedSyncedTransactions:[],hasTruncateSync:!1});if(!t||i){this.isCommittingSyncTransactions=!0;let o=i?n.find(f=>f.truncate)?.optimisticSnapshot:null,a=new Set;for(let f of n)for(let p of f.operations)a.add(p.key);let c=this.preSyncVisibleState;if(c.size===0){c=new Map;for(let f of a){let p=this.get(f);p!==void 0&&c.set(f,p)}}let l=[],d=this.config.sync.rowUpdateMode||"partial";for(let f of n){if(f.truncate){let p=new Set([...this.syncedData.keys(),...o?.upserts.keys()||[]]);for(let h of p){if(o?.deletes.has(h))continue;let m=o?.upserts.get(h)||this.syncedData.get(h);m!==void 0&&l.push({type:"delete",key:h,value:m})}this.syncedData.clear(),this.syncedMetadata.clear(),this.syncedKeys.clear();for(let h of a)c.delete(h)}for(let p of f.operations){let h=p.key;switch(this.syncedKeys.add(h),p.type){case"insert":this.syncedMetadata.set(h,p.metadata);break;case"update":this.syncedMetadata.set(h,Object.assign({},this.syncedMetadata.get(h),p.metadata));break;case"delete":this.syncedMetadata.delete(h);break}switch(p.type){case"insert":this.syncedData.set(h,p.value);break;case"update":{if(d==="partial"){let m=Object.assign({},this.syncedData.get(h),p.value);this.syncedData.set(h,m)}else this.syncedData.set(h,p.value);break}case"delete":this.syncedData.delete(h);break}}}if(i){let f=new Set;for(let m of n)for(let y of m.operations)(y.type==="insert"||y.type==="update")&&f.add(y.key);let p=new Map(o.upserts),h=new Set(o.deletes);for(let[m,y]of p)if(!h.has(m))if(f.has(m)){let v=!1;for(let g=l.length-1;g>=0;g--){let S=l[g];if(S.key===m&&S.type==="insert"){S.value=y,v=!0;break}}v||l.push({type:"insert",key:m,value:y})}else l.push({type:"insert",key:m,value:y});if(l.length>0&&h.size>0){let m=[];for(let y of l)y.type==="insert"&&h.has(y.key)||m.push(y);l.length=0,l.push(...m)}this.lifecycle.status!=="ready"&&this.lifecycle.markReady()}if(this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.isCommittingSyncTransactions=!1,i&&o){for(let[f,p]of o.upserts)this.optimisticUpserts.set(f,p);for(let f of o.deletes)this.optimisticDeletes.add(f)}for(let f of this.transactions.values())if(!["completed","failed"].includes(f.state)){for(let p of f.mutations)if(this.isThisCollection(p.collection)&&p.optimistic)switch(p.type){case"insert":case"update":this.optimisticUpserts.set(p.key,p.modified),this.optimisticDeletes.delete(p.key);break;case"delete":this.optimisticUpserts.delete(p.key),this.optimisticDeletes.add(p.key);break}}let u=new Map;for(let f of this.transactions.values())if(f.state==="completed")for(let p of f.mutations)p.optimistic&&this.isThisCollection(p.collection)&&a.has(p.key)&&u.set(p.key,{type:p.type,value:p.modified});for(let f of a){let p=c.get(f),h=this.get(f),m=u.get(f),y=!1;m&&(m.type==="delete"&&p!==void 0&&h===void 0&&$(m.value,p)||h!==void 0&&$(m.value,h))&&(y=!0),y||(p===void 0&&h!==void 0?l.push({type:"insert",key:f,value:h}):p!==void 0&&h===void 0?l.push({type:"delete",key:f,value:p}):p!==void 0&&h!==void 0&&!$(p,h)&&l.push({type:"update",key:f,value:h,previousValue:p}))}this.size=this.calculateSize(),l.length>0&&this.indexes.updateIndexes(l),this.changes.emitEvents(l,!0),this.pendingSyncedTransactions=s,this.preSyncVisibleState.clear(),Promise.resolve().then(()=>{this.recentlySyncedKeys.clear()}),this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0)}},this.config=e,this.transactions=new ke((t,n)=>t.compareCreatedAt(n)),e.compare?this.syncedData=new ke(e.compare):this.syncedData=new Map}setDeps(e){this.collection=e.collection,this.lifecycle=e.lifecycle,this.changes=e.changes,this.indexes=e.indexes}get(e){let{optimisticDeletes:t,optimisticUpserts:n,syncedData:s}=this;if(!t.has(e))return n.has(e)?n.get(e):s.get(e)}has(e){let{optimisticDeletes:t,optimisticUpserts:n,syncedData:s}=this;return t.has(e)?!1:n.has(e)?!0:s.has(e)}*keys(){let{syncedData:e,optimisticDeletes:t,optimisticUpserts:n}=this;for(let s of e.keys())t.has(s)||(yield s);for(let s of n.keys())!e.has(s)&&!t.has(s)&&(yield s)}*values(){for(let e of this.keys()){let t=this.get(e);t!==void 0&&(yield t)}}*entries(){for(let e of this.keys()){let t=this.get(e);t!==void 0&&(yield[e,t])}}*[Symbol.iterator](){for(let[e,t]of this.entries())yield[e,t]}forEach(e){let t=0;for(let[n,s]of this.entries())e(s,n,t++)}map(e){let t=[],n=0;for(let[s,i]of this.entries())t.push(e(i,s,n++));return t}isThisCollection(e){return e===this.collection}recomputeOptimisticState(e=!1){if(this.isCommittingSyncTransactions&&!e)return;let t=new Map(this.optimisticUpserts),n=new Set(this.optimisticDeletes);this.optimisticUpserts.clear(),this.optimisticDeletes.clear();let s=[];for(let a of this.transactions.values())["completed","failed"].includes(a.state)||s.push(a);for(let a of s)for(let c of a.mutations)if(this.isThisCollection(c.collection)&&c.optimistic)switch(c.type){case"insert":case"update":this.optimisticUpserts.set(c.key,c.modified),this.optimisticDeletes.delete(c.key);break;case"delete":this.optimisticUpserts.delete(c.key),this.optimisticDeletes.add(c.key);break}this.size=this.calculateSize();let i=[];this.collectOptimisticChanges(t,n,i);let o=i.filter(a=>!!(!this.recentlySyncedKeys.has(a.key)||e));if(this.pendingSyncedTransactions.length>0&&!e){let a=new Set;for(let l of this.pendingSyncedTransactions)for(let d of l.operations)a.add(d.key);let c=o.filter(l=>!(l.type==="delete"&&a.has(l.key)&&!s.some(u=>u.mutations.some(f=>this.isThisCollection(f.collection)&&f.key===l.key))));c.length>0&&this.indexes.updateIndexes(c),this.changes.emitEvents(c,e)}else o.length>0&&this.indexes.updateIndexes(o),this.changes.emitEvents(o,e)}calculateSize(){let e=this.syncedData.size,t=Array.from(this.optimisticDeletes).filter(s=>this.syncedData.has(s)&&!this.optimisticUpserts.has(s)).length,n=Array.from(this.optimisticUpserts.keys()).filter(s=>!this.syncedData.has(s)).length;return e-t+n}collectOptimisticChanges(e,t,n){let s=new Set([...e.keys(),...this.optimisticUpserts.keys(),...t,...this.optimisticDeletes]);for(let i of s){let o=this.get(i),a=this.getPreviousValue(i,e,t);a!==void 0&&o===void 0?n.push({type:"delete",key:i,value:a}):a===void 0&&o!==void 0?n.push({type:"insert",key:i,value:o}):a!==void 0&&o!==void 0&&a!==o&&n.push({type:"update",key:i,value:o,previousValue:a})}}getPreviousValue(e,t,n){if(!n.has(e))return t.has(e)?t.get(e):this.syncedData.get(e)}scheduleTransactionCleanup(e){if(e.state==="completed"){this.transactions.delete(e.id);return}e.isPersisted.promise.then(()=>{this.transactions.delete(e.id)}).catch(()=>{})}capturePreSyncVisibleState(){if(this.pendingSyncedTransactions.length===0)return;let e=new Set;for(let t of this.pendingSyncedTransactions)for(let n of t.operations)e.add(n.key);for(let t of e)this.recentlySyncedKeys.add(t);for(let t of e)if(!this.preSyncVisibleState.has(t)){let n=this.get(t);n!==void 0&&this.preSyncVisibleState.set(t,n)}}onTransactionStateChange(){this.changes.shouldBatchEvents=this.pendingSyncedTransactions.length>0,this.capturePreSyncVisibleState(),this.recomputeOptimisticState(!1)}cleanup(){this.syncedData.clear(),this.syncedMetadata.clear(),this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.size=0,this.pendingSyncedTransactions=[],this.syncedKeys.clear(),this.hasReceivedFirstCommit=!1}};var Nt=class{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{this.listeners.get(e)?.delete(t)}}once(e,t){let n=this.on(e,s=>{t(s),n()});return n}off(e,t){this.listeners.get(e)?.delete(t)}waitFor(e,t){return new Promise((n,s)=>{let i,o=this.on(e,a=>{i&&(clearTimeout(i),i=void 0),n(a),o()});t&&(i=setTimeout(()=>{i=void 0,o(),s(new Error(`Timeout waiting for event ${String(e)}`))},t))})}emitInner(e,t){this.listeners.get(e)?.forEach(n=>{try{n(t)}catch(s){queueMicrotask(()=>{throw s})}})}clearListeners(){this.listeners.clear()}};var Kr=class extends Nt{constructor(e,t,n){super(),this.collection=e,this.callback=t,this.options=n,this.loadedInitialState=!1,this.snapshotSent=!1,this.sentKeys=new Set,this._status="ready",this.pendingLoadSubsetPromises=new Set,n.onUnsubscribe&&this.on("unsubscribed",i=>n.onUnsubscribe(i)),n.whereExpression&&Os(n.whereExpression,this.collection);let s=i=>{t(i),this.trackSentKeys(i)};this.callback=s,this.filteredCallback=n.whereExpression?Vs(this.callback,n):this.callback}get status(){return this._status}setOrderByIndex(e){this.orderByIndex=e}setStatus(e){if(this._status===e)return;let t=this._status;this._status=e,this.emitInner("status:change",{type:"status:change",subscription:this,previousStatus:t,status:e});let n=`status:${e}`;this.emitInner(n,{type:n,subscription:this,previousStatus:t,status:e})}trackLoadSubsetPromise(e){e instanceof Promise&&(this.pendingLoadSubsetPromises.add(e),this.setStatus("loadingSubset"),e.finally(()=>{this.pendingLoadSubsetPromises.delete(e),this.pendingLoadSubsetPromises.size===0&&this.setStatus("ready")}))}hasLoadedInitialState(){return this.loadedInitialState}hasSentAtLeastOneSnapshot(){return this.snapshotSent}emitEvents(e){let t=this.filterAndFlipChanges(e);this.filteredCallback(t)}requestSnapshot(e){if(this.loadedInitialState)return!1;let t={where:this.options.whereExpression,optimizedOnly:e?.optimizedOnly??!1};if(e){if("where"in e){let o=e.where;if(t.where){let a=t.where,c=cr(a,o);t.where=c}else t.where=o}}else this.loadedInitialState=!0;let n=this.collection._sync.loadSubset({where:t.where,subscription:this});this.trackLoadSubsetPromise(n);let s=this.collection.currentStateAsChanges(t);if(s===void 0)return!1;let i=s.filter(o=>!this.sentKeys.has(o.key));return this.snapshotSent=!0,this.callback(i),!0}requestLimitedSnapshot({orderBy:e,limit:t,minValue:n}){if(!t)throw new Error("limit is required");if(!this.orderByIndex)throw new Error("Ordered snapshot was requested but no index was found. You have to call setOrderByIndex before requesting an ordered snapshot.");let s=this.orderByIndex,i=this.options.whereExpression,o=i?Lt(i):void 0,a=m=>{if(this.sentKeys.has(m))return!1;let y=this.collection.get(m);return y===void 0?!1:o?.(y)??!0},c=n,l=[],d=s.take(t,n,a),u=()=>Math.max(t-l.length,0),f=()=>d.length===0;for(;u()>0&&!f();){for(let m of d){let y=this.collection.get(m);l.push({type:"insert",key:m,value:y}),c=y}d=s.take(u(),c,a)}this.callback(l);let p=i;if(typeof n<"u"){let{expression:m,compareOptions:y}=e[0],g=(y.direction==="asc"?Pr:Vr)(m,new z(n));p=i?cr(i,g):g}let h=this.collection._sync.loadSubset({where:p,limit:t,orderBy:e,subscription:this});this.trackLoadSubsetPromise(h)}filterAndFlipChanges(e){if(this.loadedInitialState)return e;let t=[];for(let n of e){let s=n;if(!this.sentKeys.has(n.key)){if(n.type==="update")s={...n,type:"insert",previousValue:void 0};else if(n.type==="delete")continue;this.sentKeys.add(n.key)}t.push(s)}return t}trackSentKeys(e){if(!this.loadedInitialState)for(let t of e)this.sentKeys.add(t.key)}unsubscribe(){this.emitInner("unsubscribed",{type:"unsubscribed",subscription:this}),this.clearListeners()}};var Er=class{constructor(){this.activeSubscribersCount=0,this.changeSubscriptions=new Set,this.batchedEvents=[],this.shouldBatchEvents=!1}setDeps(e){this.lifecycle=e.lifecycle,this.sync=e.sync,this.events=e.events,this.collection=e.collection}emitEmptyReadyEvent(){for(let e of this.changeSubscriptions)e.emitEvents([])}emitEvents(e,t=!1){if(this.shouldBatchEvents&&!t){this.batchedEvents.push(...e);return}let n=e;if(t&&(this.batchedEvents.length>0&&(n=[...this.batchedEvents,...e]),this.batchedEvents=[],this.shouldBatchEvents=!1),n.length!==0)for(let s of this.changeSubscriptions)s.emitEvents(n)}subscribeChanges(e,t={}){this.addSubscriber();let n=new Kr(this.collection,e,{...t,onUnsubscribe:()=>{this.removeSubscriber(),this.changeSubscriptions.delete(n)}});return t.includeInitialState&&n.requestSnapshot(),this.changeSubscriptions.add(n),n}addSubscriber(){let e=this.activeSubscribersCount;this.activeSubscribersCount++,this.lifecycle.cancelGCTimer(),(this.lifecycle.status==="cleaned-up"||this.lifecycle.status==="idle")&&this.sync.startSync(),this.events.emitSubscribersChange(this.activeSubscribersCount,e)}removeSubscriber(){let e=this.activeSubscribersCount;if(this.activeSubscribersCount--,this.activeSubscribersCount===0)this.lifecycle.startGCTimer();else if(this.activeSubscribersCount<0)throw new je;this.events.emitSubscribersChange(this.activeSubscribersCount,e)}cleanup(){this.batchedEvents=[],this.shouldBatchEvents=!1}};var no=r=>setTimeout(()=>{r({didTimeout:!0,timeRemaining:()=>50})},0),so=r=>{clearTimeout(r)},ks=typeof window<"u"&&"requestIdleCallback"in window?(r,e)=>window.requestIdleCallback(r,e):(r,e)=>no(r),Rr=typeof window<"u"&&"cancelIdleCallback"in window?r=>window.cancelIdleCallback(r):so;var Mr=class{constructor(e,t){this.status="idle",this.hasBeenReady=!1,this.hasReceivedFirstCommit=!1,this.onFirstReadyCallbacks=[],this.gcTimeoutId=null,this.idleCallbackId=null,this.config=e,this.id=t}setDeps(e){this.indexes=e.indexes,this.events=e.events,this.changes=e.changes,this.sync=e.sync,this.state=e.state}validateStatusTransition(e,t){if(e===t)return;if(!{idle:["loading","error","cleaned-up"],loading:["ready","error","cleaned-up"],ready:["cleaned-up","error"],error:["cleaned-up","idle"],"cleaned-up":["loading","error"]}[e].includes(t))throw new De(e,t,this.id)}setStatus(e,t=!1){if(e==="ready"&&!t)throw new re(`You can't directly call "setStatus('ready'). You must use markReady instead.`);this.validateStatusTransition(this.status,e);let n=this.status;this.status=e,e==="ready"&&!this.indexes.isIndexesResolved&&this.indexes.resolveAllIndexes().catch(s=>{console.warn(`${this.config.id?`[${this.config.id}] `:""}Failed to resolve indexes:`,s)}),this.events.emitStatusChange(e,n)}validateCollectionUsable(e){switch(this.status){case"error":throw new Be(e,this.id);case"cleaned-up":this.sync.startSync();break}}markReady(){if(this.validateStatusTransition(this.status,"ready"),this.status==="loading"){if(this.setStatus("ready",!0),!this.hasBeenReady){this.hasBeenReady=!0,this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0);let e=[...this.onFirstReadyCallbacks];this.onFirstReadyCallbacks=[],e.forEach(t=>t())}this.changes.changeSubscriptions.size>0&&this.changes.emitEmptyReadyEvent()}}startGCTimer(){this.gcTimeoutId&&clearTimeout(this.gcTimeoutId);let e=this.config.gcTime??3e5;e!==0&&(this.gcTimeoutId=setTimeout(()=>{this.changes.activeSubscribersCount===0&&this.scheduleIdleCleanup()},e))}cancelGCTimer(){this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.idleCallbackId!==null&&(Rr(this.idleCallbackId),this.idleCallbackId=null)}scheduleIdleCleanup(){this.idleCallbackId!==null&&Rr(this.idleCallbackId),this.idleCallbackId=ks(e=>{this.changes.activeSubscribersCount===0?this.performCleanup(e)&&(this.idleCallbackId=null):this.idleCallbackId=null},{timeout:1e3})}performCleanup(e){return!e||e.timeRemaining()>0||e.didTimeout?(this.sync.cleanup(),this.state.cleanup(),this.changes.cleanup(),this.indexes.cleanup(),this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.hasBeenReady=!1,this.onFirstReadyCallbacks=[],this.setStatus("cleaned-up"),this.events.cleanup(),!0):(this.scheduleIdleCleanup(),!1)}onFirstReady(e){if(this.hasBeenReady){e();return}this.onFirstReadyCallbacks.push(e)}cleanup(){this.idleCallbackId!==null&&(Rr(this.idleCallbackId),this.idleCallbackId=null),this.performCleanup()}};var _r=class{constructor(e,t){this.preloadPromise=null,this.syncCleanupFn=null,this.syncLoadSubsetFn=null,this.pendingLoadSubsetPromises=new Set,this.config=e,this.id=t,this.syncMode=e.syncMode??"eager"}setDeps(e){this.collection=e.collection,this.state=e.state,this.lifecycle=e.lifecycle,this._events=e.events}startSync(){if(!(this.lifecycle.status!=="idle"&&this.lifecycle.status!=="cleaned-up")){this.lifecycle.setStatus("loading");try{let e=io(this.config.sync.sync({collection:this.collection,begin:()=>{this.state.pendingSyncedTransactions.push({committed:!1,operations:[],deletedKeys:new Set})},write:t=>{let n=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!n)throw new we;if(n.committed)throw new ve;let s=this.config.getKey(t.value),i=t.type;if(t.type==="insert"){let a=this.state.syncedData.has(s),c=n.deletedKeys.has(s),l=n.truncate===!0;if(a&&!c&&!l){let d=this.state.syncedData.get(s);if(d!==void 0&&$(d,t.value))i="update";else throw new Ne(s,this.id)}}let o={...t,type:i,key:s};n.operations.push(o),i==="delete"&&n.deletedKeys.add(s)},commit:()=>{let t=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!t)throw new rt;if(t.committed)throw new nt;t.committed=!0,this.state.commitPendingTransactions()},markReady:()=>{this.lifecycle.markReady()},truncate:()=>{let t=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!t)throw new we;if(t.committed)throw new ve;t.operations=[],t.deletedKeys.clear(),t.truncate=!0,t.optimisticSnapshot={upserts:new Map(this.state.optimisticUpserts),deletes:new Set(this.state.optimisticDeletes)}}}));if(this.syncCleanupFn=e?.cleanup??null,this.syncLoadSubsetFn=e?.loadSubset??null,this.syncMode==="on-demand"&&!this.syncLoadSubsetFn)throw new te(`Collection "${this.id}" is configured with syncMode "on-demand" but the sync function did not return a loadSubset handler. Either provide a loadSubset handler or use syncMode "eager".`)}catch(e){throw this.lifecycle.setStatus("error"),e}}}preload(){return this.preloadPromise?this.preloadPromise:(this.preloadPromise=new Promise((e,t)=>{if(this.lifecycle.status==="ready"){e();return}if(this.lifecycle.status==="error"){t(new Fe);return}if(this.lifecycle.onFirstReady(()=>{e()}),this.lifecycle.status==="idle"||this.lifecycle.status==="cleaned-up")try{this.startSync()}catch(n){t(n);return}}),this.preloadPromise)}get isLoadingSubset(){return this.pendingLoadSubsetPromises.size>0}trackLoadPromise(e){let t=!this.isLoadingSubset;this.pendingLoadSubsetPromises.add(e),t&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!0,previousIsLoadingSubset:!1,loadingSubsetTransition:"start"}),e.finally(()=>{let n=this.pendingLoadSubsetPromises.size===1&&this.pendingLoadSubsetPromises.has(e);this.pendingLoadSubsetPromises.delete(e),n&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!1,previousIsLoadingSubset:!0,loadingSubsetTransition:"end"})})}loadSubset(e){if(this.syncMode==="eager")return!0;if(this.syncLoadSubsetFn){let t=this.syncLoadSubsetFn(e);if(t instanceof Promise)return this.trackLoadPromise(t),t}return!0}cleanup(){try{this.syncCleanupFn&&(this.syncCleanupFn(),this.syncCleanupFn=null)}catch(e){queueMicrotask(()=>{if(e instanceof Error){let t=new Oe(this.id,e);throw t.cause=e,t.stack=e.stack,t}else throw new Oe(this.id,e)})}this.preloadPromise=null}};function io(r){if(typeof r=="function")return{cleanup:r};if(typeof r=="object")return r}function Cs(r){return typeof r=="function"&&r.prototype!==void 0&&r.prototype.constructor===r}async function oo(r){return Cs(r)?r:await r()}var Wt=class{constructor(e,t,n,s,i,o){this.id=e,this.expression=t,this.name=n,this.resolver=s,this.options=i,this.collectionEntries=o,this.indexPromise=null,this.resolvedIndex=null,Cs(this.resolver)&&(this.resolvedIndex=new this.resolver(this.id,this.expression,this.name,this.options),this.collectionEntries&&this.resolvedIndex.build(this.collectionEntries))}async resolve(){return this.resolvedIndex?this.resolvedIndex:(this.indexPromise||(this.indexPromise=this.createIndex()),this.resolvedIndex=await this.indexPromise,this.resolvedIndex)}isResolved(){return this.resolvedIndex!==null}getResolved(){if(!this.resolvedIndex)throw new Error(`Index ${this.id} has not been resolved yet. Ensure collection is synced.`);return this.resolvedIndex}getId(){return this.id}getName(){return this.name}getExpression(){return this.expression}async createIndex(){let e=await oo(this.resolver);return new e(this.id,this.expression,this.name,this.options)}},Ut=class{constructor(e,t){this.indexId=e,this.lazyIndex=t}get index(){return this.lazyIndex.getResolved()}get isReady(){return this.lazyIndex.isResolved()}async whenReady(){return await this.lazyIndex.resolve()}get id(){return this.indexId}get name(){return this.isReady?this.index.name:this.lazyIndex.getName()}get expression(){return this.lazyIndex.getExpression()}supports(e){return this.index.supports(e)}getStats(){return this.index.getStats()}matchesField(e){let t=this.expression;return t.type==="ref"&&t.path.length===e.length&&t.path.every((n,s)=>n===e[s])}get keyCount(){return this.index.keyCount}get indexedKeysSet(){return this.index.indexedKeysSet}get orderedEntriesArray(){return this.index.orderedEntriesArray}get valueMapData(){return this.index.valueMapData}equalityLookup(e){return this.index.equalityLookup?.(e)??new Set}rangeQuery(e){return this.index.rangeQuery?.(e)??new Set}inArrayLookup(e){return this.index.inArrayLookup?.(e)??new Set}_getLazyWrapper(){return this.lazyIndex}};var Ar=class{constructor(){this.lazyIndexes=new Map,this.resolvedIndexes=new Map,this.isIndexesResolved=!1,this.indexCounter=0}setDeps(e){this.state=e.state,this.lifecycle=e.lifecycle}createIndex(e,t={}){this.lifecycle.validateCollectionUsable("createIndex");let n=++this.indexCounter,s=es(),i=e(s),o=b(i),a=t.indexType??oe,c=new Wt(n,o,t.name,a,t.options,this.state.entries());if(this.lazyIndexes.set(n,c),a===oe)try{let l=c.getResolved();this.resolvedIndexes.set(n,l)}catch(l){console.warn("Failed to resolve BTreeIndex:",l)}else if(typeof a=="function"&&a.prototype)try{let l=c.getResolved();this.resolvedIndexes.set(n,l)}catch{this.resolveSingleIndex(n,c).catch(l=>{console.warn("Failed to resolve single index:",l)})}else this.isIndexesResolved&&this.resolveSingleIndex(n,c).catch(l=>{console.warn("Failed to resolve single index:",l)});return new Ut(n,c)}async resolveAllIndexes(){if(this.isIndexesResolved)return;let e=Array.from(this.lazyIndexes.entries()).map(async([t,n])=>{let s=await n.resolve();return s.build(this.state.entries()),this.resolvedIndexes.set(t,s),{indexId:t,resolvedIndex:s}});await Promise.all(e),this.isIndexesResolved=!0}async resolveSingleIndex(e,t){let n=await t.resolve();return n.build(this.state.entries()),this.resolvedIndexes.set(e,n),n}get indexes(){return this.resolvedIndexes}updateIndexes(e){for(let t of this.resolvedIndexes.values())for(let n of e)switch(n.type){case"insert":t.add(n.key,n.value);break;case"update":n.previousValue?t.update(n.key,n.previousValue,n.value):t.add(n.key,n.value);break;case"delete":t.remove(n.key,n.value);break}}cleanup(){this.lazyIndexes.clear(),this.resolvedIndexes.clear()}};function P(...r){let e=typeof window<"u"&&typeof localStorage<"u";e&&localStorage.getItem("DEBUG")==="true"?console.log("[proxy]",...r):!e&&typeof process<"u"&&process.env.DEBUG==="true"&&console.log("[proxy]",...r)}function ae(r,e=new WeakMap){if(r==null||typeof r!="object")return r;if(e.has(r))return e.get(r);if(r instanceof Date)return new Date(r.getTime());if(r instanceof RegExp)return new RegExp(r.source,r.flags);if(Array.isArray(r)){let s=[];return e.set(r,s),r.forEach((i,o)=>{s[o]=ae(i,e)}),s}if(ArrayBuffer.isView(r)&&!(r instanceof DataView)){let s=Object.getPrototypeOf(r).constructor,i=new s(r.length);e.set(r,i);for(let o=0;o<r.length;o++)i[o]=r[o];return i}if(r instanceof Map){let s=new Map;return e.set(r,s),r.forEach((i,o)=>{s.set(o,ae(i,e))}),s}if(r instanceof Set){let s=new Set;return e.set(r,s),r.forEach(i=>{s.add(ae(i,e))}),s}if(ar(r))return r;let t={};e.set(r,t);for(let s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=ae(r[s],e));let n=Object.getOwnPropertySymbols(r);for(let s of n)t[s]=ae(r[s],e);return t}var Ks=0;function ao(){return Ks+=1,Ks}function lr(r,e){let t=new Map;function n(u,f){if(P("Object ID:",u.constructor.name),t.has(u))return t.get(u);{let p=lr(u,f);return t.set(u,p),p}}let s=new Map,i={copy_:ae(r),originalObject:ae(r),proxyCount:ao(),modified:!1,assigned_:{},parent:e,target:r};P("createChangeProxy called for target",r,i.proxyCount);function o(u){u.modified||(u.modified=!0),u.parent&&(P("propagating change to parent"),"updateMap"in u.parent?u.parent.updateMap(u.copy_):"updateSet"in u.parent?u.parent.updateSet(u.copy_):(u.parent.tracker.copy_[u.parent.prop]=u.copy_,u.parent.tracker.assigned_[u.parent.prop]=!0),o(u.parent.tracker))}function a(u){if(P("checkIfReverted called with assigned keys:",Object.keys(u.assigned_)),Object.keys(u.assigned_).length===0&&Object.getOwnPropertySymbols(u.assigned_).length===0)return P("No assigned properties, returning true"),!0;for(let p in u.assigned_)if(u.assigned_[p]===!0){let h=u.copy_[p],m=u.originalObject[p];if(P(`Checking property ${String(p)}, current:`,h,"original:",m),!$(h,m))return P(`Property ${String(p)} is different, returning false`),!1}else if(u.assigned_[p]===!1)return P(`Property ${String(p)} was deleted, returning false`),!1;let f=Object.getOwnPropertySymbols(u.assigned_);for(let p of f)if(u.assigned_[p]===!0){let h=u.copy_[p],m=u.originalObject[p];if(!$(h,m))return P("Symbol property is different, returning false"),!1}else if(u.assigned_[p]===!1)return P("Symbol property was deleted, returning false"),!1;return P("All properties match original values, returning true"),!0}function c(u,f){P("checkParentStatus called for child prop:",f);let p=a(u);P("Parent checkIfReverted returned:",p),p&&(P("Parent is fully reverted, clearing tracking"),u.modified=!1,u.assigned_={},u.parent&&(P("Continuing up the parent chain"),c(u.parent.tracker,u.parent.prop)))}function l(u){if(P("createObjectProxy",u),s.has(u))return P("proxyCache found match"),s.get(u);let f=new Proxy(u,{get(p,h){P("get",p,h);let m=i.copy_[h]??i.originalObject[h],y=i.originalObject[h];if(P("value (at top of proxy get)",m),Object.getOwnPropertyDescriptor(p,h)?.get)return m;if(typeof m=="function"){if(Array.isArray(p)){let g=h.toString();if(new Set(["pop","push","shift","unshift","splice","sort","reverse","fill","copyWithin"]).has(g))return function(...O){let K=m.apply(i.copy_,O);return o(i),K}}if(p instanceof Map||p instanceof Set){let g=h.toString();if(new Set(["set","delete","clear","add","pop","push","shift","unshift","splice","sort","reverse"]).has(g))return function(...K){let V=m.apply(i.copy_,K);return o(i),V};if(new Set(["entries","keys","values","forEach",Symbol.iterator]).has(g)||h===Symbol.iterator)return function(...K){let V=m.apply(i.copy_,K);if(g==="forEach"){let I=K[0];if(typeof I=="function"){let w=function(T,x,k){let F=I.call(this,T,x,k);return o(i),F};return m.apply(p,[w,...K.slice(1)])}}if(g==="entries"||g==="values"||g===Symbol.iterator.toString()||h===Symbol.iterator){let I=V,w=new Map;if(g==="values"&&p instanceof Map)for(let[x,k]of i.copy_.entries())w.set(k,x);let T=new Map;if(p instanceof Set)for(let x of i.copy_.values())T.set(x,x);return{next(){let x=I.next();if(!x.done&&x.value&&typeof x.value=="object"){if(g==="entries"&&Array.isArray(x.value)&&x.value.length===2){if(x.value[1]&&typeof x.value[1]=="object"){let k=x.value[0],F={tracker:i,prop:k,updateMap:ee=>{i.copy_ instanceof Map&&i.copy_.set(k,ee)}},{proxy:se}=n(x.value[1],F);x.value[1]=se}}else if((g==="values"||g===Symbol.iterator.toString()||h===Symbol.iterator)&&typeof x.value=="object"&&x.value!==null)if(g==="values"&&p instanceof Map){let k=w.get(x.value);if(k!==void 0){let F={tracker:i,prop:k,updateMap:ee=>{i.copy_ instanceof Map&&i.copy_.set(k,ee)}},{proxy:se}=n(x.value,F);x.value=se}}else if(p instanceof Set){let k=x.value,F={tracker:i,prop:k,updateSet:ee=>{i.copy_ instanceof Set&&(i.copy_.delete(k),i.copy_.add(ee),T.set(k,ee))}},{proxy:se}=n(x.value,F);x.value=se}else{let k=Symbol("iterator-value"),{proxy:F}=n(x.value,{tracker:i,prop:k});x.value=F}}return x},[Symbol.iterator](){return this}}}return V}}return m.bind(p)}if(m&&typeof m=="object"&&!(m instanceof Date)&&!(m instanceof RegExp)&&!ar(m)){let g={tracker:i,prop:String(h)},{proxy:S}=n(y,g);return s.set(m,S),S}return m},set(p,h,m){let y=i.copy_[h];if(P(`set called for property ${String(h)}, current:`,y,"new:",m),$(y,m))P("Value unchanged, not tracking");else{let v=i.originalObject[h],g=$(m,v);if(P("value:",m,"original:",v,"isRevertToOriginal:",g),g){P(`Reverting property ${String(h)} to original value`),delete i.assigned_[h.toString()],P(`Updating copy with original value for ${String(h)}`),i.copy_[h]=ae(v),P("Checking if all properties reverted");let S=a(i);P("All reverted:",S),S?(P("All properties reverted, clearing tracking"),i.modified=!1,i.assigned_={},e&&(P("Updating parent for property:",e.prop),c(e.tracker,e.prop))):(P("Some properties still changed, keeping modified flag"),i.modified=!0)}else P(`Setting new value for property ${String(h)}`),i.copy_[h]=m,i.assigned_[h.toString()]=!0,P("Marking object and ancestors as modified",i),o(i)}return!0},defineProperty(p,h,m){return"value"in m&&(i.copy_[h]=ae(m.value),i.assigned_[h.toString()]=!0,o(i)),!0},deleteProperty(p,h){P("deleteProperty",p,h);let m=typeof h=="symbol"?h.toString():h;if(m in p){let y=m in i.originalObject;delete i.copy_[h],y?(i.assigned_[m]=!1,i.copy_[m]=void 0,o(i)):(delete i.copy_[m],delete i.assigned_[m],Object.keys(i.assigned_).length===0&&Object.getOwnPropertySymbols(i.assigned_).length===0?i.modified=!1:i.modified=!0)}return!0}});return s.set(u,f),f}return{proxy:l(r),getChanges:()=>{if(P("getChanges called, modified:",i.modified),P(i),!i.modified)return P("Object not modified, returning empty object"),{};if(typeof i.copy_!="object"||Array.isArray(i.copy_)||Object.keys(i.assigned_).length===0)return i.copy_;let u={};for(let f in i.copy_)i.assigned_[f]===!0&&f in i.copy_&&(u[f]=i.copy_[f]);return P("Returning copy:",u),u}}}function yn(r){let e=r.map(t=>lr(t));return{proxies:e.map(t=>t.proxy),getChanges:()=>e.map(t=>t.getChanges())}}function Br(r,e){let{proxy:t,getChanges:n}=lr(r);return e(t),n()}function Dr(r,e){let{proxies:t,getChanges:n}=yn(r);return e(t),n()}function Es(){let r,e,t=!0;return{promise:new Promise((s,i)=>{r=o=>{t=!1,s(o)},e=o=>{t=!1,i(o)}}),resolve:r,reject:e,isPending:()=>t}}var gn=class{constructor(){this.contexts=new Map,this.clearListeners=new Set}getOrCreateContext(e){let t=this.contexts.get(e);return t||(t={queue:[],jobs:new Map,dependencies:new Map,completed:new Set},this.contexts.set(e,t)),t}schedule({contextId:e,jobId:t,dependencies:n,run:s}){if(typeof e>"u"){s();return}let i=this.getOrCreateContext(e);if(i.jobs.has(t)||i.queue.push(t),i.jobs.set(t,s),n){let o=new Set(n);o.delete(t),i.dependencies.set(t,o)}else i.dependencies.has(t)||i.dependencies.set(t,new Set);i.completed.delete(t)}flush(e){let t=this.contexts.get(e);if(!t)return;let{queue:n,jobs:s,dependencies:i,completed:o}=t;for(;n.length>0;){let a=!1,c=n.length;for(let l=0;l<c;l++){let d=n.shift(),u=s.get(d);if(!u){i.delete(d),o.delete(d);continue}let f=i.get(d),p=!f;if(f){p=!0;for(let h of f)if(h!==d&&!o.has(h)){p=!1;break}}p?(s.delete(d),i.delete(d),u(),o.add(d),a=!0):n.push(d)}if(!a)throw new Error(`Scheduler detected unresolved dependencies for context ${String(e)}.`)}this.contexts.delete(e)}flushAll(){for(let e of Array.from(this.contexts.keys()))this.flush(e)}clear(e){this.contexts.delete(e),this.clearListeners.forEach(t=>t(e))}onClear(e){return this.clearListeners.add(e),()=>this.clearListeners.delete(e)}hasPendingJobs(e){let t=this.contexts.get(e);return!!t&&t.jobs.size>0}clearJob(e,t){let n=this.contexts.get(e);n&&(n.jobs.delete(t),n.dependencies.delete(t),n.completed.delete(t),n.queue=n.queue.filter(s=>s!==t),n.jobs.size===0&&this.contexts.delete(e))}},$t=new gn;var Fr=[],ur=[],co=0;function lo(r,e){switch(`${r.type}-${e.type}`){case"insert-update":return{...r,type:"insert",original:{},modified:e.modified,changes:{...r.changes,...e.changes},key:r.key,globalKey:r.globalKey,metadata:e.metadata??r.metadata,syncMetadata:{...r.syncMetadata,...e.syncMetadata},mutationId:e.mutationId,updatedAt:e.updatedAt};case"insert-delete":return null;case"update-delete":return e;case"update-update":return{...e,original:r.original,changes:{...r.changes,...e.changes},metadata:e.metadata??r.metadata,syncMetadata:{...r.syncMetadata,...e.syncMetadata}};case"delete-delete":case"insert-insert":return e;default:{let t=`${r.type}-${e.type}`;throw new Error(`Unhandled mutation combination: ${t}`)}}}function ce(r){let e=new Tn(r);return Fr.push(e),e}function pe(){if(ur.length>0)return ur.slice(-1)[0]}function uo(r){$t.clear(r.id),ur.push(r)}function po(r){try{$t.flush(r.id)}finally{ur=ur.filter(e=>e.id!==r.id)}}function fo(r){let e=Fr.findIndex(t=>t.id===r.id);e!==-1&&Fr.splice(e,1)}var Tn=class{constructor(e){if(typeof e.mutationFn>"u")throw new Xe;this.id=e.id??crypto.randomUUID(),this.mutationFn=e.mutationFn,this.state="pending",this.mutations=[],this.isPersisted=Es(),this.autoCommit=e.autoCommit??!0,this.createdAt=new Date,this.sequenceNumber=co++,this.metadata=e.metadata??{}}setState(e){this.state=e,(e==="completed"||e==="failed")&&fo(this)}mutate(e){if(this.state!=="pending")throw new Ze;uo(this);try{e()}finally{po(this)}return this.autoCommit&&this.commit().catch(()=>{}),this}applyMutations(e){for(let t of e){let n=this.mutations.findIndex(s=>s.globalKey===t.globalKey);if(n>=0){let s=this.mutations[n],i=lo(s,t);i===null?this.mutations.splice(n,1):this.mutations[n]=i}else this.mutations.push(t)}}rollback(e){let t=e?.isSecondaryRollback??!1;if(this.state==="completed")throw new et;if(this.setState("failed"),!t){let n=new Set;this.mutations.forEach(s=>n.add(s.globalKey));for(let s of Fr)s.state==="pending"&&s.mutations.some(i=>n.has(i.globalKey))&&s.rollback({isSecondaryRollback:!0})}return this.isPersisted.reject(this.error?.error),this.touchCollection(),this}touchCollection(){let e=new Set;for(let t of this.mutations)e.has(t.collection.id)||(t.collection._state.onTransactionStateChange(),t.collection._state.pendingSyncedTransactions.length>0&&t.collection._state.commitPendingTransactions(),e.add(t.collection.id))}async commit(){if(this.state!=="pending")throw new tt;if(this.setState("persisting"),this.mutations.length===0)return this.setState("completed"),this.isPersisted.resolve(this),this;try{await this.mutationFn({transaction:this}),this.setState("completed"),this.touchCollection(),this.isPersisted.resolve(this)}catch(e){let t=e instanceof Error?e:new Error(String(e));throw this.error={message:t.message,error:t},this.rollback(),t}return this}compareCreatedAt(e){let t=this.createdAt.getTime()-e.createdAt.getTime();return t!==0?t:this.sequenceNumber-e.sequenceNumber}};var jr=class{constructor(e,t){this.insert=(n,s)=>{this.lifecycle.validateCollectionUsable("insert");let i=this.state,o=pe();if(!o&&!this.config.onInsert)throw new Je;let a=Array.isArray(n)?n:[n],c=[];if(a.forEach(l=>{let d=this.validateData(l,"insert"),u=this.config.getKey(d);if(this.state.has(u))throw new Le(u);let f=this.generateGlobalKey(u,l),p={mutationId:crypto.randomUUID(),original:{},modified:d,changes:Object.fromEntries(Object.keys(l).map(h=>[h,d[h]])),globalKey:f,key:u,metadata:s?.metadata,syncMetadata:this.config.sync.getSyncMetadata?.()||{},optimistic:s?.optimistic??!0,type:"insert",createdAt:new Date,updatedAt:new Date,collection:this.collection};c.push(p)}),o)return o.applyMutations(c),i.transactions.set(o.id,o),i.scheduleTransactionCleanup(o),i.recomputeOptimisticState(!0),o;{let l=ce({mutationFn:async d=>await this.config.onInsert({transaction:d.transaction,collection:this.collection})});return l.applyMutations(c),l.commit().catch(()=>{}),i.transactions.set(l.id,l),i.scheduleTransactionCleanup(l),i.recomputeOptimisticState(!0),l}},this.delete=(n,s)=>{let i=this.state;this.lifecycle.validateCollectionUsable("delete");let o=pe();if(!o&&!this.config.onDelete)throw new Ye;if(Array.isArray(n)&&n.length===0)throw new qe;let a=Array.isArray(n)?n:[n],c=[];for(let d of a){if(!this.state.has(d))throw new Ge(d);let u=this.generateGlobalKey(d,this.state.get(d)),f={mutationId:crypto.randomUUID(),original:this.state.get(d),modified:this.state.get(d),changes:this.state.get(d),globalKey:u,key:d,metadata:s?.metadata,syncMetadata:i.syncedMetadata.get(d)||{},optimistic:s?.optimistic??!0,type:"delete",createdAt:new Date,updatedAt:new Date,collection:this.collection};c.push(f)}if(o)return o.applyMutations(c),i.transactions.set(o.id,o),i.scheduleTransactionCleanup(o),i.recomputeOptimisticState(!0),o;let l=ce({autoCommit:!0,mutationFn:async d=>this.config.onDelete({transaction:d.transaction,collection:this.collection})});return l.applyMutations(c),l.commit().catch(()=>{}),i.transactions.set(l.id,l),i.scheduleTransactionCleanup(l),i.recomputeOptimisticState(!0),l},this.id=t,this.config=e}setDeps(e){this.lifecycle=e.lifecycle,this.state=e.state,this.collection=e.collection}ensureStandardSchema(e){if(e&&"~standard"in e)return e;throw new Ae}validateData(e,t,n){if(!this.config.schema)return e;let s=this.ensureStandardSchema(this.config.schema);if(t==="update"&&n){let o=this.state.get(n);if(o&&e&&typeof e=="object"&&typeof o=="object"){let a=Object.assign({},o,e),c=s["~standard"].validate(a);if(c instanceof Promise)throw new Te;if("issues"in c&&c.issues){let f=c.issues.map(p=>({message:p.message,path:p.path?.map(h=>String(h))}));throw new ge(t,f)}let l=c.value,d=Object.keys(e);return Object.fromEntries(d.map(f=>[f,l[f]]))}}let i=s["~standard"].validate(e);if(i instanceof Promise)throw new Te;if("issues"in i&&i.issues){let o=i.issues.map(a=>({message:a.message,path:a.path?.map(c=>String(c))}));throw new ge(t,o)}return i.value}generateGlobalKey(e,t){if(typeof e>"u")throw new ze(t);return`KEY::${this.id}/${e}`}update(e,t,n){if(typeof e>"u")throw new We;let s=this.state;this.lifecycle.validateCollectionUsable("update");let i=pe();if(!i&&!this.config.onUpdate)throw new Qe;let o=Array.isArray(e),a=o?e:[e];if(o&&a.length===0)throw new Ue;let c=typeof t=="function"?t:n,l=typeof t=="function"?{}:t,d=a.map(h=>{let m=this.state.get(h);if(!m)throw new $e(h);return m}),u;o?u=Dr(d,c):u=[Br(d[0],c)];let f=a.map((h,m)=>{let y=u[m];if(!y||Object.keys(y).length===0)return null;let v=d[m],g=this.validateData(y,"update",h),S=Object.assign({},v,g),O=this.config.getKey(v),K=this.config.getKey(S);if(O!==K)throw new He(O,K);let V=this.generateGlobalKey(K,S);return{mutationId:crypto.randomUUID(),original:v,modified:S,changes:Object.fromEntries(Object.keys(y).map(I=>[I,S[I]])),globalKey:V,key:h,metadata:l.metadata,syncMetadata:s.syncedMetadata.get(h)||{},optimistic:l.optimistic??!0,type:"update",createdAt:new Date,updatedAt:new Date,collection:this.collection}}).filter(Boolean);if(f.length===0){let h=ce({mutationFn:async()=>{}});return h.commit().catch(()=>{}),s.scheduleTransactionCleanup(h),h}if(i)return i.applyMutations(f),s.transactions.set(i.id,i),s.scheduleTransactionCleanup(i),s.recomputeOptimisticState(!0),i;let p=ce({mutationFn:async h=>this.config.onUpdate({transaction:h.transaction,collection:this.collection})});return p.applyMutations(f),p.commit().catch(()=>{}),s.transactions.set(p.id,p),s.scheduleTransactionCleanup(p),s.recomputeOptimisticState(!0),p}};var zr=class extends Nt{constructor(){super()}setDeps(e){this.collection=e.collection}emit(e,t){this.emitInner(e,t)}emitStatusChange(e,t){this.emit("status:change",{type:"status:change",collection:this.collection,previousStatus:t,status:e});let n=`status:${e}`;this.emit(n,{type:n,collection:this.collection,previousStatus:t,status:e})}emitSubscribersChange(e,t){this.emit("subscribers:change",{type:"subscribers:change",collection:this.collection,previousSubscriberCount:t,subscriberCount:e})}cleanup(){this.clearListeners()}};function Lr(r){let e=new Ce(r);return r.utils?e.utils={...r.utils}:e.utils={},e}var Ce=class{constructor(e){if(this.utils={},this.insert=(t,n)=>this._mutations.insert(t,n),this.delete=(t,n)=>this._mutations.delete(t,n),!e)throw new Me;if(!e.sync)throw new _e;e.id?this.id=e.id:this.id=crypto.randomUUID(),this.config={...e,autoIndex:e.autoIndex??"eager"},this._changes=new Er,this._events=new zr,this._indexes=new Ar,this._lifecycle=new Mr(e,this.id),this._mutations=new jr(e,this.id),this._state=new Cr(e),this._sync=new _r(e,this.id),this._changes.setDeps({collection:this,lifecycle:this._lifecycle,sync:this._sync,events:this._events}),this._events.setDeps({collection:this}),this._indexes.setDeps({state:this._state,lifecycle:this._lifecycle}),this._lifecycle.setDeps({changes:this._changes,events:this._events,indexes:this._indexes,state:this._state,sync:this._sync}),this._mutations.setDeps({collection:this,lifecycle:this._lifecycle,state:this._state}),this._state.setDeps({collection:this,lifecycle:this._lifecycle,changes:this._changes,indexes:this._indexes}),this._sync.setDeps({collection:this,state:this._state,lifecycle:this._lifecycle,events:this._events}),e.startSync===!0&&this._sync.startSync()}get status(){return this._lifecycle.status}get subscriberCount(){return this._changes.activeSubscribersCount}onFirstReady(e){return this._lifecycle.onFirstReady(e)}isReady(){return this._lifecycle.status==="ready"}get isLoadingSubset(){return this._sync.isLoadingSubset}startSyncImmediate(){this._sync.startSync()}preload(){return this._sync.preload()}get(e){return this._state.get(e)}has(e){return this._state.has(e)}get size(){return this._state.size}*keys(){yield*this._state.keys()}*values(){yield*this._state.values()}*entries(){yield*this._state.entries()}*[Symbol.iterator](){yield*this._state[Symbol.iterator]()}forEach(e){return this._state.forEach(e)}map(e){return this._state.map(e)}getKeyFromItem(e){return this.config.getKey(e)}createIndex(e,t={}){return this._indexes.createIndex(e,t)}get indexes(){return this._indexes.indexes}validateData(e,t,n){return this._mutations.validateData(e,t,n)}update(e,t,n){return this._mutations.update(e,t,n)}get state(){let e=new Map;for(let[t,n]of this.entries())e.set(t,n);return e}stateWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.state):this.preload().then(()=>this.state)}get toArray(){return Array.from(this.values())}toArrayWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.toArray):this.preload().then(()=>this.toArray)}currentStateAsChanges(e={}){return Ps(this,e)}subscribeChanges(e,t={}){return this._changes.subscribeChanges(e,t)}on(e,t){return this._events.on(e,t)}once(e,t){return this._events.once(e,t)}off(e,t){this._events.off(e,t)}waitFor(e,t){return this._events.waitFor(e,t)}async cleanup(){return this._lifecycle.cleanup(),Promise.resolve()}};function Rs(r){let{mutationFn:e,onMutate:t,...n}=r;return s=>{let i=ce({...n,mutationFn:async o=>await e(s,o)});return i.mutate(()=>{t(s)}),i}}function Ms(r){let{initialData:e,onInsert:t,onUpdate:n,onDelete:s,...i}=r,o=ho(e),a=async u=>{let f;return t&&(f=await t(u)??{}),o.confirmOperationsSync(u.transaction.mutations),f},c=async u=>{let f;return n&&(f=await n(u)??{}),o.confirmOperationsSync(u.transaction.mutations),f},l=async u=>{let f;return s&&(f=await s(u)??{}),o.confirmOperationsSync(u.transaction.mutations),f},d=u=>{let f=u.mutations.filter(p=>p.collection===o.collection);f.length!==0&&o.confirmOperationsSync(f)};return{...i,sync:o.sync,onInsert:a,onUpdate:c,onDelete:l,utils:{acceptMutations:d},startSync:!0,gcTime:0}}function ho(r){let e=null,t=null,n=null,s=null;return{sync:{sync:a=>{let{begin:c,write:l,commit:d,markReady:u}=a;return e=c,t=l,n=d,s=a.collection,r&&r.length>0&&(c(),r.forEach(f=>{l({type:"insert",value:f})}),d()),u(),()=>{}},getSyncMetadata:()=>({})},confirmOperationsSync:a=>{!e||!t||!n||(e(),a.forEach(c=>{t&&t({type:c.type,value:c.modified})}),n())},collection:s}}function Ht(r,e){try{JSON.stringify(r)}catch(t){throw new kt(e,t instanceof Error?t.message:String(t))}}function xn(){return crypto.randomUUID()}function mo(){let r=new Map;return{getItem(e){return r.get(e)??null},setItem(e,t){r.set(e,t)},removeItem(e){r.delete(e)}}}function yo(){return{addEventListener:()=>{},removeEventListener:()=>{}}}function _s(r){if(!r.storageKey)throw new Ct;let e=r.storage||(typeof window<"u"?window.localStorage:null)||mo(),t=r.storageEventApi||(typeof window<"u"?window:null)||yo(),n=new Map,s=go(r.storageKey,e,t,r.getKey,n),i=()=>{s.manualTrigger&&s.manualTrigger()},o=V=>{try{let I={};V.forEach((T,x)=>{I[String(x)]=T});let w=JSON.stringify(I);e.setItem(r.storageKey,w)}catch(I){throw console.error(`[LocalStorageCollection] Error saving data to storage key "${r.storageKey}":`,I),I}},a=()=>{e.removeItem(r.storageKey)},c=()=>{let V=e.getItem(r.storageKey);return V?new Blob([V]).size:0},l=async V=>{V.transaction.mutations.forEach(T=>{Ht(T.modified,"insert")});let I={};r.onInsert&&(I=await r.onInsert(V)??{});let w=qt(r.storageKey,e);return V.transaction.mutations.forEach(T=>{let x=r.getKey(T.modified),k={versionKey:xn(),data:T.modified};w.set(x,k)}),o(w),i(),I},d=async V=>{V.transaction.mutations.forEach(T=>{Ht(T.modified,"update")});let I={};r.onUpdate&&(I=await r.onUpdate(V)??{});let w=qt(r.storageKey,e);return V.transaction.mutations.forEach(T=>{let x=r.getKey(T.modified),k={versionKey:xn(),data:T.modified};w.set(x,k)}),o(w),i(),I},u=async V=>{let I={};r.onDelete&&(I=await r.onDelete(V)??{});let w=qt(r.storageKey,e);return V.transaction.mutations.forEach(T=>{let x=r.getKey(T.original);w.delete(x)}),o(w),i(),I},{storageKey:f,storage:p,storageEventApi:h,onInsert:m,onUpdate:y,onDelete:v,id:g,...S}=r,O=g??`local-collection:${r.storageKey}`;return{...S,id:O,sync:s,onInsert:l,onUpdate:d,onDelete:u,utils:{clearStorage:a,getStorageSize:c,acceptMutations:V=>{let I=V.mutations.filter(T=>s.collection&&T.collection===s.collection?!0:T.collection.id===O);if(I.length===0)return;for(let T of I)switch(T.type){case"insert":case"update":Ht(T.modified,T.type);break;case"delete":Ht(T.original,T.type);break}let w=qt(r.storageKey,e);for(let T of I){let x=T.key;switch(T.type){case"insert":case"update":{let k={versionKey:xn(),data:T.modified};w.set(x,k);break}case"delete":{w.delete(x);break}}}o(w),s.confirmOperationsSync(I)}}}}function qt(r,e){try{let t=e.getItem(r);if(!t)return new Map;let n=JSON.parse(t),s=new Map;if(typeof n=="object"&&n!==null&&!Array.isArray(n))Object.entries(n).forEach(([i,o])=>{if(o&&typeof o=="object"&&"versionKey"in o&&"data"in o){let a=o;s.set(i,a)}else throw new Kt(r,i)});else throw new Et(r);return s}catch(t){return console.warn(`[LocalStorageCollection] Error loading data from storage key "${r}":`,t),new Map}}function go(r,e,t,n,s){let i=null,o=null,a=(u,f)=>{let p=[];return u.forEach((h,m)=>{let y=f.get(m);y?h.versionKey!==y.versionKey&&p.push({type:"update",key:m,value:y.data}):p.push({type:"delete",key:m,value:h.data})}),f.forEach((h,m)=>{u.has(m)||p.push({type:"insert",key:m,value:h.data})}),p},c=()=>{if(!i)return;let{begin:u,write:f,commit:p}=i,h=qt(r,e),m=a(s,h);m.length>0&&(u(),m.forEach(({type:y,value:v})=>{v&&(Ht(v,y),f({type:y,value:v}))}),p(),s.clear(),h.forEach((y,v)=>{s.set(v,y)}))};return{...{sync:u=>{let{begin:f,write:p,commit:h,markReady:m}=u;i=u,o=u.collection;let y=qt(r,e);y.size>0&&(f(),y.forEach(g=>{Ht(g.data,"load"),p({type:"insert",value:g.data})}),h()),s.clear(),y.forEach((g,S)=>{s.set(S,g)}),m();let v=g=>{g.key!==r||g.storageArea!==e||c()};t.addEventListener("storage",v)},getSyncMetadata:()=>({storageKey:r,storageType:e===(typeof window<"u"?window.localStorage:null)?"localStorage":"custom"}),manualTrigger:c,collection:o},confirmOperationsSync:u=>{if(!i)return;let{begin:f,write:p,commit:h}=i;f(),u.forEach(m=>{p({type:m.type,value:m.type==="delete"?m.original:m.modified})}),h()}}}var Gt=class r{constructor(e={}){this.query={},this.query={...e}}_createRefForSource(e,t){if(Object.keys(e).length!==1)throw new st(t);let n=Object.keys(e)[0],s=e[n],i;if(s instanceof Ce)i=new Q(s,n);else if(s instanceof r){let o=s._getQuery();if(!o.from)throw new it(t);i=new j(o,n)}else throw new ot(n);return[n,i]}from(e){let[,t]=this._createRefForSource(e,"from clause");return new r({...this.query,from:t})}join(e,t,n="left"){let[s,i]=this._createRefForSource(e,"join clause"),a=[...this._getCurrentAliases(),s],c=Pe(a),l=t(c),d,u;if(l.type==="func"&&l.name==="eq"&&l.args.length===2)d=l.args[0],u=l.args[1];else throw new at;let f={from:i,type:n,left:d,right:u},p=this.query.join||[];return new r({...this.query,join:[...p,f]})}leftJoin(e,t){return this.join(e,t,"left")}rightJoin(e,t){return this.join(e,t,"right")}innerJoin(e,t){return this.join(e,t,"inner")}fullJoin(e,t){return this.join(e,t,"full")}where(e){let t=this._getCurrentAliases(),n=Pe(t),s=e(n),i=this.query.where||[];return new r({...this.query,where:[...i,s]})}having(e){let t=this._getCurrentAliases(),n=Pe(t),s=e(n),i=this.query.having||[];return new r({...this.query,having:[...i,s]})}select(e){let t=this._getCurrentAliases(),n=Pe(t),s=e(n),i=As(s);return new r({...this.query,select:i,fnSelect:void 0})}orderBy(e,t="asc"){let n=this._getCurrentAliases(),s=Pe(n),i=e(s),o=typeof t=="string"?{direction:t,nulls:"first",stringSort:"locale"}:{direction:t.direction??"asc",nulls:t.nulls??"first",stringSort:t.stringSort??"locale",locale:t.stringSort==="locale"?t.locale:void 0,localeOptions:t.stringSort==="locale"?t.localeOptions:void 0},a=d=>({expression:b(d),compareOptions:o}),c=Array.isArray(i)?i.map(d=>a(d)):[a(i)],l=this.query.orderBy||[];return new r({...this.query,orderBy:[...l,...c]})}groupBy(e){let t=this._getCurrentAliases(),n=Pe(t),s=e(n),i=Array.isArray(s)?s.map(a=>b(a)):[b(s)],o=this.query.groupBy||[];return new r({...this.query,groupBy:[...o,...i]})}limit(e){return new r({...this.query,limit:e})}offset(e){return new r({...this.query,offset:e})}distinct(){return new r({...this.query,distinct:!0})}findOne(){return new r({...this.query,singleResult:!0})}_getCurrentAliases(){let e=[];if(this.query.from&&e.push(this.query.from.alias),this.query.join)for(let t of this.query.join)e.push(t.from.alias);return e}get fn(){let e=this;return{select(t){return new r({...e.query,select:void 0,fnSelect:t})},where(t){return new r({...e.query,fnWhere:[...e.query.fnWhere||[],t]})},having(t){return new r({...e.query,fnHaving:[...e.query.fnHaving||[],t]})}}}_getQuery(){if(!this.query.from)throw new ct;return this.query}};function To(r){return r===void 0?b(null):r instanceof G||r instanceof C||r instanceof E||r instanceof z?r:b(r)}function xo(r){return r!==null&&typeof r=="object"&&!Re(r)&&!r.__refProxy}function As(r){if(!xo(r))return To(r);let e={};for(let[t,n]of Object.entries(r)){if(typeof t=="string"&&t.startsWith("__SPREAD_SENTINEL__")){e[t]=n;continue}e[t]=As(n)}return e}function Bs(r){let e=r(new Gt);return wn(e)}function wn(r){return r._getQuery()}var Ds=Gt;var Wr=class extends Map{constructor(t,n){super(n);this.defaultValue=t}get(t){return this.has(t)?super.get(t):this.defaultValue()}update(t,n){let s=this.get(t),i=n(s);return this.set(t,i),i}},vn=3e4;function Ur(r,e){if(e.length<=vn)r.push(...e);else for(let t=0;t<e.length;t+=vn){let n=e.slice(t,t+vn);r.push(...n)}}function Fs(r,e,t){let n=0,s=r.length;for(;n<s;){let i=Math.floor((n+s)/2),o=t(r[i],e);if(o<0)n=i+1;else if(o>0)s=i;else return i}return n}var Sn=class{constructor(){this.objectIds=new WeakMap;this.nextId=0}getId(e){if(typeof e!="object"||e===null){let t=String(e),n=0;for(let s=0;s<t.length;s++){let i=t.charCodeAt(s);n=(n<<5)-n+i,n=n&n}return n}return this.objectIds.has(e)||this.objectIds.set(e,this.nextId++),this.objectIds.get(e)}getStringId(e){return e===null?"null":e===void 0?"undefined":typeof e!="object"?`str_${String(e)}`:`obj_${this.getId(e)}`}},Jt=new Sn;function js(r,e){let[t,n]=r,[s,i]=e,o=[...Nr(t,Math.min(n,s)),...Nr(Math.max(t,i),n)],a=[...Nr(s,Math.min(i,t)),...Nr(Math.max(s,n),i)];return{onlyInA:o,onlyInB:a}}function Nr(r,e){let t=[];for(let n=r;n<e;n++)t.push(n);return t}var wo=N(),vo=N(),So=N(),bo=N(),Oo=N();function N(){return Math.random()*(2**31-1)>>>0}var zs=new ArrayBuffer(8),Io=new DataView(zs),fe=new Uint8Array(zs),Qt=class{constructor(){this.hash=wo;this.length=0;this.carry=0;this.carryBytes=0}_mix(e){e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e,this.hash=this.hash<<13|this.hash>>>19,this.hash=Math.imul(this.hash,5)+3864292196}_writeByte(e){this.carry|=(e&255)<<8*this.carryBytes,this.carryBytes++,this.length++,this.carryBytes===4&&(this._mix(this.carry>>>0),this.carry=0,this.carryBytes=0)}update(e){switch(typeof e){case"symbol":{this.update(Oo);let t=e.description;if(!t)return;for(let n=0;n<t.length;n++){let s=t.charCodeAt(n);this._writeByte(s&255),this._writeByte(s>>>8&255)}return}case"string":this.update(vo);for(let t=0;t<e.length;t++){let n=e.charCodeAt(t);this._writeByte(n&255),this._writeByte(n>>>8&255)}return;case"number":Io.setFloat64(0,e,!0),this._writeByte(fe[0]),this._writeByte(fe[1]),this._writeByte(fe[2]),this._writeByte(fe[3]),this._writeByte(fe[4]),this._writeByte(fe[5]),this._writeByte(fe[6]),this._writeByte(fe[7]);return;case"bigint":{let t=e;for(t<0n?(t=-t,this.update(bo)):this.update(So);t>0n;)this._writeByte(Number(t&0xffn)),t>>=8n;e===0n&&this._writeByte(0);return}default:throw new TypeError(`Unsupported input type: ${typeof e}`)}}digest(){if(this.carryBytes>0){let e=this.carry>>>0;e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e}return this.hash^=this.length,this.hash^=this.hash>>>16,this.hash=Math.imul(this.hash,2246822507),this.hash^=this.hash>>>13,this.hash=Math.imul(this.hash,3266489909),this.hash^=this.hash>>>16,this.hash>>>0}};var Po=N(),Vo=N(),ko=N(),Co=N(),Ko=N(),Eo=N(),Ro=N(),Mo=N(),_o=N(),Ao=N(),Bo=N(),dr=new WeakMap;function B(r){let e=new Qt;return Ns(e,r),e.digest()}function Do(r){let e=dr.get(r);if(e!==void 0)return e;let t;if(r instanceof Date)t=Fo(r);else{let n=r,s=Mo;if(r instanceof Array&&(s=_o),r instanceof Map&&(s=Ao,n=[...r.entries()]),r instanceof Set&&(s=Bo,n=[...r.entries()]),typeof Buffer<"u"&&r instanceof Buffer||r instanceof Uint8Array||r instanceof File)return Ws(r);t=jo(n,s)}return dr.set(r,t),t}function Fo(r){let e=new Qt;return e.update(Ro),e.update(r.getTime()),e.digest()}function jo(r,e){let t=new Qt;t.update(e);let n=Object.keys(r);n.sort(Lo);for(let s of n)t.update(Ko),t.update(s),Ns(t,r[s]);return t.digest()}function Ns(r,e){if(e===null){r.update(ko);return}switch(typeof e){case"undefined":r.update(Co);return;case"boolean":r.update(e?Po:Vo);return;case"number":r.update(isNaN(e)?NaN:e===0?0:e);return;case"bigint":case"string":case"symbol":r.update(e);return;case"object":r.update(zo(e));return;case"function":r.update(Ws(e));return;default:console.warn(`Ignored input during hashing because it is of type ${typeof e} which is not supported`)}}function zo(r){let e=dr.get(r);return e===void 0&&(e=Do(r)),e}var Ls=1;function Ws(r){let e=dr.get(r);return e===void 0&&(e=Ls^Eo,Ls++,dr.set(r,e)),e}function Lo(r,e){return r.localeCompare(e)}var _=class r{#e;constructor(e=[]){this.#e=e}toString(e=!1){return`MultiSet(${JSON.stringify(this.#e,null,e?2:void 0)})`}toJSON(){return JSON.stringify(Array.from(this.getInner()))}static fromJSON(e){return new r(JSON.parse(e))}map(e){return new r(this.#e.map(([t,n])=>[e(t),n]))}filter(e){return new r(this.#e.filter(([t,n])=>e(t)))}negate(){return new r(this.#e.map(([e,t])=>[e,-t]))}concat(e){let t=[];return Ur(t,this.#e),Ur(t,e.getInner()),new r(t)}consolidate(){if(this.#e.length>0){let e=this.#e[0]?.[0];if(Array.isArray(e)&&e.length===2)return this.#t()}return this.#r()}#t(){let e=new Map,t=new Map,n=i=>{if(i.length!==2)throw new Error("Expected tuple of length 2");let[o,a]=i;return`${Jt.getStringId(o)}|${Jt.getStringId(a)}`};for(let[i,o]of this.#e){if(!Array.isArray(i)||i.length!==2)return this.#r();let[a,c]=i;if(typeof a!="string"&&typeof a!="number")return this.#r();let l;Array.isArray(c)&&c.length===2?l=n(c):l=Jt.getStringId(c);let d=a+"|"+l;e.set(d,(e.get(d)||0)+o),t.has(d)||t.set(d,i)}let s=[];for(let[i,o]of e)o!==0&&s.push([t.get(i),o]);return new r(s)}#r(){let e=new Wr(()=>0),t=new Map,n=!1,s=!1,i=!1;for(let[c,l]of this.#e)if(typeof c=="string")n=!0;else if(typeof c=="number")s=!0;else{i=!0;break}let o=i||n&&s;for(let[c,l]of this.#e){let d=o?B(c):c;o&&!t.has(d)&&t.set(d,c),e.update(d,u=>u+l)}let a=[];for(let[c,l]of e.entries())if(l!==0){let d=o?t.get(c):c;a.push([d,l])}return new r(a)}extend(e){let t=e instanceof r?e.getInner():e;Ur(this.#e,t)}add(e,t){t!==0&&this.#e.push([e,t])}getInner(){return this.#e}};var bn=class{#e;constructor(e){this.#e=e}drain(){let e=[...this.#e].reverse();return this.#e.length=0,e}isEmpty(){return this.#e.length===0}},R=class{#e=[];sendData(e){e instanceof _||(e=new _(e));for(let t of this.#e)t.unshift(e)}newReader(){let e=[];return this.#e.push(e),new bn(e)}},$r=class{constructor(e,t,n){this.id=e;this.inputs=t,this.output=n}hasPendingWork(){return this.inputs.some(e=>!e.isEmpty())}},q=class extends $r{constructor(t,n,s){super(t,[n],s);this.id=t}inputMessages(){return this.inputs[0].drain()}},Hr=class extends $r{constructor(t,n,s,i){super(t,[n,s],i);this.id=t}inputAMessages(){return this.inputs[0].drain()}inputBMessages(){return this.inputs[1].drain()}},he=class extends q{run(){for(let e of this.inputMessages())this.output.sendData(this.inner(e))}};var qr=class{#e=[];#t=0;#r=!1;constructor(){}#n(){if(this.#r)throw new Error("Graph already finalized")}getNextOperatorId(){return this.#n(),this.#t++}newInput(){this.#n();let e=new R;return new On(this,e)}addOperator(e){this.#n(),this.#e.push(e)}finalize(){this.#n(),this.#r=!0}step(){if(!this.#r)throw new Error("Graph not finalized");for(let e of this.#e)e.run()}pendingWork(){return this.#e.some(e=>e.hasPendingWork())}run(){for(;this.pendingWork();)this.step()}},M=class{#e;#t;constructor(e,t){this.#e=e,this.#t=t}connectReader(){return this.#t.newReader()}get writer(){return this.#t}get graph(){return this.#e}pipe(...e){return e.reduce((t,n)=>n(t),this)}},On=class extends M{sendData(e){this.writer.sendData(e)}};var In=class extends he{#e;constructor(e,t,n,s){super(e,t,n),this.#e=s}inner(e){return e.map(this.#e)}};function A(r){return e=>{let t=new M(e.graph,new R),n=new In(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Pn=class extends he{#e;constructor(e,t,n,s){super(e,t,n),this.#e=s}inner(e){return this.#e(e),e}};function Us(r){return e=>{let t=new M(e.graph,new R),n=new Pn(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Vn=class extends he{#e;constructor(e,t,n,s){super(e,t,n),this.#e=s}inner(e){return e.filter(this.#e)}};function Z(r){return e=>{let t=new M(e.graph,new R),n=new Vn(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var kn=class extends q{#e;constructor(e,t,n,s){super(e,t,n),this.#e=s}run(){for(let e of this.inputMessages())this.#e(e),this.output.sendData(e)}};function $s(r){return e=>{let t=new M(e.graph,new R),n=new kn(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Cn=class extends q{run(){let e=this.inputMessages();if(e.length===0)return;let t=new _;for(let s of e)t.extend(s);let n=t.consolidate();n.getInner().length>0&&this.output.sendData(n)}};function Hs(){return r=>{let e=new M(r.graph,new R),t=new Cn(r.graph.getNextOperatorId(),r.connectReader(),e.writer);return r.graph.addOperator(t),e}}var pr=Symbol("NO_PREFIX"),Jr=class extends Map{addValue(e,t){if(t===0)return this.size===0;let n=fr(e),s=this.get(n);if(Gr(s)){let[i,o]=s;if(fr(i)!==n)throw new Error("Mismatching prefixes, this should never happen");if(i===e||B(i)===B(e)){let c=o+t;c===0?this.delete(n):this.set(n,[e,c])}else{let c=new Ke;c.set(B(i),s),c.set(B(e),[e,t]),this.set(n,c)}}else s===void 0?this.set(n,[e,t]):s.addValue(e,t)&&this.delete(n);return this.size===0}},Ke=class extends Map{addValue(e,t){if(t===0)return this.size===0;let n=B(e),s=this.get(n);if(s){let[,i]=s,o=i+t;o===0?this.delete(n):this.set(n,[e,o])}else this.set(n,[e,t]);return this.size===0}},ne=class r{#e;#t=new Map;constructor(){this.#e=new Map}static fromMultiSets(e){let t=new r;for(let n of e)for(let[s,i]of n.getInner()){let[o,a]=s;t.addValue(o,[a,i])}return t}toString(e=!1){return`Index(${JSON.stringify([...this.entries()],void 0,e?2:void 0)})`}get size(){return this.#e.size}has(e){return this.#e.has(e)}hasPresence(e){return(this.#t.get(e)||0)!==0}getConsolidatedMultiplicity(e){return this.#t.get(e)||0}getPresenceKeys(){return this.#t.keys()}get(e){return[...this.getIterator(e)]}*getIterator(e){let t=this.#e.get(e);if(Gr(t))yield t;else{if(t===void 0)return;if(t instanceof Ke)for(let n of t.values())yield n;else for(let n of t.values())if(Gr(n))yield n;else for(let s of n.values())yield s}}*entries(){for(let e of this.#e.keys())for(let t of this.getIterator(e))yield[e,t]}*entriesIterators(){for(let e of this.#e.keys())yield[e,this.getIterator(e)]}addValue(e,t){let[n,s]=t;if(s===0)return;let i=(this.#t.get(e)||0)+s;i===0?this.#t.delete(e):this.#t.set(e,i);let o=this.#e.get(e);if(o===void 0){this.#e.set(e,t);return}if(Gr(o)){this.#r(e,o,n,s);return}if(o instanceof Ke){let a=fr(n);if(a!==pr){let c=new Jr;c.set(pr,o),c.set(a,t),this.#e.set(e,c)}else o.addValue(n,s)&&this.#e.delete(e)}else o.addValue(n,s)&&this.#e.delete(e)}#r(e,t,n,s){let[i,o]=t;if(i===n){let l=o+s;l===0?this.#e.delete(e):this.#e.set(e,[n,l]);return}let a=fr(n),c=fr(i);if(c===a&&(i===n||B(i)===B(n))){let l=o+s;l===0?this.#e.delete(e):this.#e.set(e,[n,l]);return}if(c===pr&&a===pr){let l=new Ke;l.set(B(i),t),l.set(B(n),[n,s]),this.#e.set(e,l)}else{let l=new Jr;if(c===a){let d=new Ke;d.set(B(i),t),d.set(B(n),[n,s]),l.set(c,d)}else l.set(c,t),l.set(a,[n,s]);this.#e.set(e,l)}}append(e){for(let[t,n]of e.entries())this.addValue(t,n)}join(e){let t=[];if(this.size<=e.size)for(let[n,s]of this.entriesIterators()){if(!e.has(n))continue;let i=e.get(n);for(let[o,a]of s)for(let[c,l]of i)a!==0&&l!==0&&t.push([[n,[o,c]],a*l])}else for(let[n,s]of e.entriesIterators()){if(!this.has(n))continue;let i=this.get(n);for(let[o,a]of s)for(let[c,l]of i)l!==0&&a!==0&&t.push([[n,[c,o]],l*a])}return new _(t)}};function fr(r){return Array.isArray(r)&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="bigint")?r[0]:pr}function Gr(r){return Array.isArray(r)}var Kn=class extends Hr{#e=new ne;#t=new ne;#r;constructor(e,t,n,s,i="inner"){super(e,t,n,s),this.#r=i}run(){let e=ne.fromMultiSets(this.inputAMessages()),t=ne.fromMultiSets(this.inputBMessages());if(e.size===0&&t.size===0)return;let n=new _;this.#r!=="anti"&&this.emitInnerResults(e,t,n),(this.#r==="left"||this.#r==="full"||this.#r==="anti")&&this.emitLeftOuterResults(e,t,n),(this.#r==="right"||this.#r==="full")&&this.emitRightOuterResults(e,t,n),this.#e.append(e),this.#t.append(t),n.getInner().length>0&&this.output.sendData(n)}emitInnerResults(e,t,n){e.size>0&&n.extend(e.join(this.#t)),t.size>0&&n.extend(this.#e.join(t)),e.size>0&&t.size>0&&n.extend(e.join(t))}emitLeftOuterResults(e,t,n){if(e.size>0)for(let[s,i]of e.entriesIterators()){let o=this.#t.getConsolidatedMultiplicity(s),a=t.getConsolidatedMultiplicity(s);if(o+a===0)for(let[l,d]of i)d!==0&&n.add([s,[l,null]],d)}if(t.size>0)for(let s of t.getPresenceKeys()){let i=this.#t.getConsolidatedMultiplicity(s),o=t.getConsolidatedMultiplicity(s);if(o===0)continue;let a=i+o;if(i===0==(a===0))continue;let c=i===0;for(let[l,d]of this.#e.getIterator(s))d!==0&&n.add([s,[l,null]],c?-d:+d)}}emitRightOuterResults(e,t,n){if(t.size>0)for(let[s,i]of t.entriesIterators()){let o=this.#e.getConsolidatedMultiplicity(s),a=e.getConsolidatedMultiplicity(s);if(o+a===0)for(let[l,d]of i)d!==0&&n.add([s,[null,l]],d)}if(e.size>0)for(let s of e.getPresenceKeys()){let i=this.#e.getConsolidatedMultiplicity(s),o=e.getConsolidatedMultiplicity(s);if(o===0)continue;let a=i+o;if(i===0==(a===0))continue;let c=i===0;for(let[l,d]of this.#t.getIterator(s))d!==0&&n.add([s,[null,l]],c?-d:+d)}}};function qs(r,e="inner"){return t=>{if(t.graph!==r.graph)throw new Error("Cannot join streams from different graphs");let n=new M(t.graph,new R),s=new Kn(t.graph.getNextOperatorId(),t.connectReader(),r.connectReader(),n.writer,e);return t.graph.addOperator(s),n}}var En=class extends q{#e=new ne;#t=new ne;#r;constructor(e,t,n,s){super(e,t,n),this.#r=s}run(){let e=new Set;for(let n of this.inputMessages())for(let[s,i]of n.getInner()){let[o,a]=s;this.#e.addValue(o,[a,i]),e.add(o)}let t=[];for(let n of e){let s=this.#e.get(n),i=this.#t.get(n),o=this.#r(s),a=new Map,c=new Map;for(let[l,d]of o){let u=a.get(l)??0;a.set(l,u+d)}for(let[l,d]of i){let u=c.get(l)??0;c.set(l,u+d)}for(let[l,d]of c)a.has(l)||(t.push([[n,l],-d]),this.#t.addValue(n,[l,-d]));for(let[l,d]of a)c.has(l)||d!==0&&(t.push([[n,l],d]),this.#t.addValue(n,[l,d]));for(let[l,d]of a){let u=c.get(l);if(u!==void 0){let f=d-u;f!==0&&(t.push([[n,l],f]),this.#t.addValue(n,[l,f]))}}}t.length>0&&this.output.sendData(new _(t))}};function Gs(r){return e=>{let t=new M(e.graph,new R),n=new En(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Rn=class extends q{#e;#t;constructor(e,t,n,s=i=>i){super(e,t,n),this.#e=s,this.#t=new Map}run(){let e=new Map;for(let n of this.inputMessages())for(let[s,i]of n.getInner()){let o=B(this.#e(s)),c=(e.get(o)?.[0]??this.#t.get(o)??0)+i;e.set(o,[c,s])}let t=[];for(let[n,[s,i]]of e.entries()){let o=this.#t.get(n)??0;s===0?this.#t.delete(n):this.#t.set(n,s),o<=0&&s>0?t.push([[B(this.#e(i)),i[1]],1]):o>0&&s<=0&&t.push([[B(this.#e(i)),i[1]],-1])}t.length>0&&this.output.sendData(new _(t))}};function Js(r=e=>e){return e=>{let t=new M(e.graph,new R),n=new Rn(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var No="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function Yt(r,e,t){let n=t[0];if(e!=null&&r>=e)throw new Error(r+" >= "+e);if(r.slice(-1)===n||e&&e.slice(-1)===n)throw new Error("trailing zero");if(e){let o=0;for(;(r[o]||n)===e[o];)o++;if(o>0)return e.slice(0,o)+Yt(r.slice(o),e.slice(o),t)}let s=r?t.indexOf(r[0]):0,i=e!=null?t.indexOf(e[0]):t.length;if(i-s>1){let o=Math.round(.5*(s+i));return t[o]}else return e&&e.length>1?e.slice(0,1):t[s]+Yt(r.slice(1),null,t)}function Xs(r){if(r.length!==Zs(r[0]))throw new Error("invalid integer part of order key: "+r)}function Zs(r){if(r>="a"&&r<="z")return r.charCodeAt(0)-97+2;if(r>="A"&&r<="Z")return 90-r.charCodeAt(0)+2;throw new Error("invalid order key head: "+r)}function hr(r){let e=Zs(r[0]);if(e>r.length)throw new Error("invalid order key: "+r);return r.slice(0,e)}function Qs(r,e){if(r==="A"+e[0].repeat(26))throw new Error("invalid order key: "+r);let t=hr(r);if(r.slice(t.length).slice(-1)===e[0])throw new Error("invalid order key: "+r)}function Ys(r,e){Xs(r);let[t,...n]=r.split(""),s=!0;for(let i=n.length-1;s&&i>=0;i--){let o=e.indexOf(n[i])+1;o===e.length?n[i]=e[0]:(n[i]=e[o],s=!1)}if(s){if(t==="Z")return"a"+e[0];if(t==="z")return null;let i=String.fromCharCode(t.charCodeAt(0)+1);return i>"a"?n.push(e[0]):n.pop(),i+n.join("")}else return t+n.join("")}function Wo(r,e){Xs(r);let[t,...n]=r.split(""),s=!0;for(let i=n.length-1;s&&i>=0;i--){let o=e.indexOf(n[i])-1;o===-1?n[i]=e.slice(-1):(n[i]=e[o],s=!1)}if(s){if(t==="a")return"Z"+e.slice(-1);if(t==="A")return null;let i=String.fromCharCode(t.charCodeAt(0)-1);return i<"Z"?n.push(e.slice(-1)):n.pop(),i+n.join("")}else return t+n.join("")}function ei(r,e,t=No){if(r!=null&&Qs(r,t),e!=null&&Qs(e,t),r!=null&&e!=null&&r>=e)throw new Error(r+" >= "+e);if(r==null){if(e==null)return"a"+t[0];let c=hr(e),l=e.slice(c.length);if(c==="A"+t[0].repeat(26))return c+Yt("",l,t);if(c<e)return c;let d=Wo(c,t);if(d==null)throw new Error("cannot decrement any more");return d}if(e==null){let c=hr(r),l=r.slice(c.length),d=Ys(c,t);return d??c+Yt(l,null,t)}let n=hr(r),s=r.slice(n.length),i=hr(e),o=e.slice(i.length);if(n===i)return n+Yt(s,o,t);let a=Ys(n,t);if(a==null)throw new Error("cannot increment any more");return a<e?a:n+Yt(s,null,t)}var Yr=class{#e=[];#t;#r;#n;constructor(e,t,n){this.#r=e,this.#n=e+t,this.#t=n}get size(){let e=this.#r,t=this.#n-this.#r,n=this.#e.length-e;return Math.max(0,Math.min(t,n))}move({offset:e,limit:t}){let n=this.#r,s=this.#n-this.#r,i=[this.#r,this.#n===1/0?this.#r+this.size:this.#n];this.#r=e??n,this.#n=this.#r+(t??s);let o=[this.#r,this.#n===1/0?Math.max(this.#r+this.size,i[1]):this.#n],{onlyInA:a,onlyInB:c}=js(i,o),l=[];c.forEach(u=>{let f=this.#e[u];f&&l.push(f)});let d=[];return a.forEach(u=>{let f=this.#e[u];f&&d.push(f)}),{moveIns:l,moveOuts:d,changes:a.length+c.length>0}}insert(e){let t={moveIn:null,moveOut:null},n=this.#s(e),s=n===0?null:Zr(this.#e[n-1]),i=n===this.#e.length?null:Zr(this.#e[n]),o=ei(s,i),a=ti(e,o);if(this.#e.splice(n,0,a),n<this.#n){let c=Math.max(n,this.#r);c<this.#e.length&&(t.moveIn=this.#e[c],this.#n<this.#e.length&&(t.moveOut=this.#e[this.#n]))}return t}delete(e){let t={moveIn:null,moveOut:null},n=this.#s(e),[s]=this.#e.splice(n,1);if(n<this.#n){if(t.moveOut=s,n<this.#r){let o=this.#r-1;o<this.#e.length?t.moveOut=this.#e[o]:t.moveOut=null}let i=this.#n-1;i<this.#e.length&&(t.moveIn=this.#e[i])}return t}#s(e){return Fs(this.#e,ti(e,""),(t,n)=>this.#t(Xr(t),Xr(n)))}},Mn=class extends q{#e=new Map;#t;constructor(e,t,n,s,i){super(e,t,n);let o=i.limit??1/0,a=i.offset??0,c=(l,d)=>{let u=s(Qr(l),Qr(d));if(u!==0)return u;let f=si(l),p=si(d);return f-p};this.#t=this.createTopK(a,o,c),i.setSizeCallback?.(()=>this.#t.size),i.setWindowFn?.(this.moveTopK.bind(this))}createTopK(e,t,n){return new Yr(e,t,n)}moveTopK({offset:e,limit:t}){if(!(this.#t instanceof Yr))throw new Error("Cannot move B+-tree implementation of TopK with fractional index");let n=[],s=this.#t.move({offset:e,limit:t});s.moveIns.forEach(i=>this.handleMoveIn(i,n)),s.moveOuts.forEach(i=>this.handleMoveOut(i,n)),s.changes&&this.output.sendData(new _(n))}run(){let e=[];for(let t of this.inputMessages())for(let[n,s]of t.getInner()){let[i,o]=n;this.processElement(i,o,s,e)}e.length>0&&this.output.sendData(new _(e))}processElement(e,t,n,s){let{oldMultiplicity:i,newMultiplicity:o}=this.addKey(e,n),a={moveIn:null,moveOut:null};if(i<=0&&o>0){let c=ri(e,t);a=this.#t.insert(c)}else if(i>0&&o<=0){let c=ri(e,t);a=this.#t.delete(c)}this.handleMoveIn(a.moveIn,s),this.handleMoveOut(a.moveOut,s)}handleMoveIn(e,t){if(e){let n=Zr(e),s=Xr(e),i=ni(s),o=Qr(s);t.push([[i,[o,n]],1])}}handleMoveOut(e,t){if(e){let n=Zr(e),s=Xr(e),i=ni(s),o=Qr(s);t.push([[i,[o,n]],-1])}}getMultiplicity(e){return this.#e.get(e)??0}addKey(e,t){let n=this.getMultiplicity(e),s=n+t;return s===0?this.#e.delete(e):this.#e.set(e,s),{oldMultiplicity:n,newMultiplicity:s}}};function ii(r,e){let t=e||{};return n=>{let s=new M(n.graph,new R),i=new Mn(n.graph.getNextOperatorId(),n.connectReader(),s.writer,r,t);return n.graph.addOperator(i),s}}function ti(r,e){return[r,e]}function Xr(r){return r[0]}function Zr(r){return r[1]}function ri(r,e){return[r,e,Jt.getId(r)]}function ni(r){return r[0]}function Qr(r){return r[1]}function si(r){return r[2]}function Uo(r,e,t){let n=t?.limit??1/0,s=t?.offset??0,i=t?.setSizeCallback,o=t?.setWindowFn,a=t?.comparator??((c,l)=>c===l?0:c<l?-1:1);return c=>c.pipe(r((l,d)=>a(e(l),e(d)),{limit:n,offset:s,setSizeCallback:i,setWindowFn:o}),Hs())}function oi(r,e){return Uo(ii,r,e)}function ai(r){return"pipe"in r}function en(r,e={}){let t=Object.fromEntries(Object.entries(e).filter(([s,i])=>!ai(i))),n=Object.fromEntries(Object.entries(e).filter(([s,i])=>ai(i)));return s=>{let i="__original_key__";return s.pipe(A(c=>{let l=r(c),d=JSON.stringify(l),u={};u[i]=l;for(let[f,p]of Object.entries(t))u[f]=p.preMap(c);return[d,u]})).pipe(Gs(c=>{let l=0;for(let[f,p]of c)l+=p;if(l<=0)return[];let d={},u=c[0]?.[0]?.[i];d[i]=u;for(let[f,p]of Object.entries(t)){let h=c.map(([m,y])=>[m[f],y]);d[f]=p.reduce(h)}return[[d,1]]})).pipe(A(([c,l])=>{let d=l[i],u={};Object.assign(u,d);for(let[f,p]of Object.entries(t))p.postMap?u[f]=p.postMap(l[f]):u[f]=l[f];return[c,u]}))}}function $o(r=e=>e){return{preMap:e=>r(e),reduce:e=>{let t=0;for(let[n,s]of e)t+=n*s;return t}}}function Ho(r=e=>e){return{preMap:e=>r(e)==null?0:1,reduce:e=>{let t=0;for(let[n,s]of e)t+=n*s;return t}}}function qo(r=e=>e){return{preMap:e=>({sum:r(e),count:0}),reduce:e=>{let t=0,n=0;for(let[s,i]of e)t+=s.sum*i,n+=i;return{sum:t,count:n}},postMap:e=>e.sum/e.count}}function Go(r){let e=r??(t=>t);return{preMap:t=>e(t),reduce:t=>{let n;for(let[s,i]of t)(!n||s&&s<n)&&(n=s);return n}}}function Jo(r){let e=r??(t=>t);return{preMap:t=>e(t),reduce:t=>{let n;for(let[s,i]of t)(!n||s&&s>n)&&(n=s);return n}}}function Qo(r=e=>e){return{preMap:e=>[r(e)],reduce:e=>{let t=[];for(let[n,s]of e)for(let i of n)for(let o=0;o<s;o++)t.push(i);return t.length===0?[]:(t.sort((n,s)=>n-s),t)},postMap:e=>{if(e.length===0)return 0;let t=Math.floor(e.length/2);return e.length%2===0?(e[t-1]+e[t])/2:e[t]}}}function Yo(r=e=>e){return{preMap:e=>{let t=r(e),n=new Map;return n.set(t,1),n},reduce:e=>{let t=new Map;for(let[n,s]of e)for(let[i,o]of n.entries()){let a=t.get(i)||0;t.set(i,a+o*s)}return t},postMap:e=>{if(e.size===0)return 0;let t=0,n=0;for(let[s,i]of e.entries())i>n&&(n=i,t=s);return t}}}var _n={sum:$o,count:Ho,avg:qo,min:Go,max:Jo,median:Qo,mode:Yo};var ci=new Set(["eq","gt","lt","gte","lte","and","or","in"]);function An(r){let e=r.type;return e==="func"?ci.has(r.name)?r.args.every(t=>An(t)):!1:["val","ref"].includes(e)}function tn(r,e){let t=r.type;if(t==="val")return new z(r.value);if(t==="ref"){let n=r.path;if(Array.isArray(n)){if(n[0]===e&&n.length>1)return new E(n.slice(1));if(n.length===1&&n[0]!==void 0)return new E([n[0]])}return new E(Array.isArray(n)?n:[String(n)])}else{if(!ci.has(r.name))return null;let n=[];for(let s of r.args){let i=tn(s,e);if(i==null)return null;n.push(i)}return new C(r.name,n)}}function Bn(r,e){return r.map(n=>{let s=tn(n.expression,e);if(!s)throw new Error(`Failed to convert orderBy expression to a basic expression: ${n.expression}`);return{...n,expression:s}})}function di(r){let e=Xo(r),t=r,n,s=0,i=10;for(;s<i&&!$(t,n);)n=t,t=Dn(t),s++;return{optimizedQuery:pi(t),sourceWhereClauses:e}}function Xo(r){let e=new Map;if(!r.where||r.where.length===0)return e;let n=fi(r.where).map(i=>mi(i)),s=yi(n);for(let[i,o]of s.singleSource)Zo(r,i)&&An(o)&&e.set(i,o);return e}function Zo(r,e){if(r.from.alias===e)return r.from.type==="collectionRef";if(r.join){for(let t of r.join)if(t.from.alias===e)return t.from.type==="collectionRef"}return!1}function Dn(r){let e={...r,from:r.from.type==="queryRef"?new j(Dn(r.from.query),r.from.alias):r.from,join:r.join?.map(t=>({...t,from:t.from.type==="queryRef"?new j(Dn(t.from.query),t.from.alias):t.from}))};return ea(e)}function ea(r){if(!r.where||r.where.length===0||!r.join||r.join.length===0)return r;let e=r.where.filter(a=>!xr(a)),n=fi(e).map(a=>mi(a)),s=yi(n),i=ra(r,s),o=r.where.filter(a=>xr(a));return o.length>0&&(i.where=[...i.where||[],...o]),i}function pi(r){return{...r,from:Fn(r.from),join:r.join?.map(e=>({...e,from:Fn(e.from)}))}}function Fn(r){if(r.type==="collectionRef")return r;let e=pi(r.query);if(ta(e)){let t=Fn(e.from);return t.type==="collectionRef"?new Q(t.collection,r.alias):new j(t.query,r.alias)}return new j(e,r.alias)}function ta(r){return(!r.where||r.where.length===0)&&!r.select&&(!r.groupBy||r.groupBy.length===0)&&(!r.having||r.having.length===0)&&(!r.orderBy||r.orderBy.length===0)&&(!r.join||r.join.length===0)&&r.limit===void 0&&r.offset===void 0&&!r.fnSelect&&(!r.fnWhere||r.fnWhere.length===0)&&(!r.fnHaving||r.fnHaving.length===0)}function fi(r){let e=[];for(let t of r){let n=sr(t);e.push(...hi(n))}return e}function hi(r){if(r.type==="func"&&r.name==="and"){let e=[];for(let t of r.args)e.push(...hi(t));return e}else return[r]}function mi(r){let e=new Set,t=!1;function n(s){switch(s.type){case"ref":if(s.path&&s.path.length>0){let i=s.path[0];i&&(e.add(i),s.path.length===1&&(t=!0))}break;case"func":s.args&&s.args.forEach(n);break;case"val":break;case"agg":s.args&&s.args.forEach(n);break}}return n(r),{expression:r,touchedSources:e,hasNamespaceOnlyRef:t}}function yi(r){let e=new Map,t=[];for(let i of r)if(i.touchedSources.size===1&&!i.hasNamespaceOnlyRef){let o=Array.from(i.touchedSources)[0];e.has(o)||e.set(o,[]),e.get(o).push(i.expression)}else(i.touchedSources.size>1||i.hasNamespaceOnlyRef)&&t.push(i.expression);let n=new Map;for(let[i,o]of e)n.set(i,ui(o));let s=t.length>0?ui(t):void 0;return{singleSource:n,multiSource:s}}function ra(r,e){let t=new Set,n=li(r.from,e.singleSource,t),s=r.join?r.join.map(c=>({...c,from:li(c.from,e.singleSource,t)})):void 0,i=[];e.multiSource&&i.push(e.multiSource);let o=r.join&&r.join.some(c=>c.type==="left"||c.type==="right"||c.type==="full");for(let[c,l]of e.singleSource)t.has(c)?o&&i.push(an(l)):i.push(l);return{select:r.select,groupBy:r.groupBy?[...r.groupBy]:void 0,having:r.having?[...r.having]:void 0,orderBy:r.orderBy?[...r.orderBy]:void 0,limit:r.limit,offset:r.offset,distinct:r.distinct,fnSelect:r.fnSelect,fnWhere:r.fnWhere?[...r.fnWhere]:void 0,fnHaving:r.fnHaving?[...r.fnHaving]:void 0,from:n,join:s,where:i.length>0?i:[]}}function Xt(r){return{from:r.from.type==="collectionRef"?new Q(r.from.collection,r.from.alias):new j(Xt(r.from.query),r.from.alias),select:r.select,join:r.join?r.join.map(e=>({type:e.type,left:e.left,right:e.right,from:e.from.type==="collectionRef"?new Q(e.from.collection,e.from.alias):new j(Xt(e.from.query),e.from.alias)})):void 0,where:r.where?[...r.where]:void 0,groupBy:r.groupBy?[...r.groupBy]:void 0,having:r.having?[...r.having]:void 0,orderBy:r.orderBy?[...r.orderBy]:void 0,limit:r.limit,offset:r.offset,fnSelect:r.fnSelect,fnWhere:r.fnWhere?[...r.fnWhere]:void 0,fnHaving:r.fnHaving?[...r.fnHaving]:void 0}}function li(r,e,t){let n=e.get(r.alias);if(!n)return r.type==="collectionRef"?new Q(r.collection,r.alias):new j(Xt(r.query),r.alias);if(r.type==="collectionRef"){let o={from:new Q(r.collection,r.alias),where:[n]};return t.add(r.alias),new j(o,r.alias)}if(!ca(r.query,n,r.alias))return new j(Xt(r.query),r.alias);if(ua(r.query,n,r.alias))return new j(Xt(r.query),r.alias);let s=r.query.where||[],i={...Xt(r.query),where:[...s,n]};return t.add(r.alias),new j(i,r.alias)}function na(r,e,t){return r.select?gi(r.select)||la(r.select,e,t):!1}function sa(r){return r.groupBy&&r.groupBy.length>0}function ia(r){return r.having&&r.having.length>0}function oa(r){return r.orderBy&&r.orderBy.length>0&&(r.limit!==void 0||r.offset!==void 0)}function aa(r){return r.fnSelect||r.fnWhere&&r.fnWhere.length>0||r.fnHaving&&r.fnHaving.length>0}function ca(r,e,t){return!(na(r,e,t)||sa(r)||ia(r)||oa(r)||aa(r))}function gi(r){for(let e of Object.values(r))if(typeof e=="object"){let t=e;if(t.type==="agg"||!("type"in t)&&gi(t))return!0}return!1}function jn(r){let e=[];if(r==null||typeof r!="object")return e;switch(r.type){case"ref":e.push(r);break;case"func":case"agg":for(let t of r.args??[])e.push(...jn(t));break}return e}function la(r,e,t){let n=new Set;for(let[i,o]of Object.entries(r))i.startsWith("__SPREAD_SENTINEL__")||o instanceof E||n.add(i);let s=jn(e);for(let i of s){let o=i.path;if(!Array.isArray(o)||o.length<2)continue;let a=o[0],c=o[1];if(a===t&&n.has(c))return!0}return!1}function ua(r,e,t){let n=jn(e);if(n.every(i=>i.path[0]!==t))return!1;if(r.fnSelect)return!0;let s=r.select;if(!s)return!1;for(let i of n){let o=i.path;if(o.length<2||o[0]!==t)continue;let a=s[o[1]];if(!a)continue;if(!(a instanceof E)||a.path.length<2)return!0;let[c,l]=a.path;if(c!==t&&c!==r.from.alias||l!==o[1])return!0}return!1}function ui(r){if(r.length===0)throw new Mt;return r.length===1?r[0]:new C("and",r)}function Ti(r,e,t,n,s,i,o,a,c,l,d,u,f,p,h,m,y,v){let g=r;for(let S of e)g=da(g,S,t,n,s,i,o,a,c,l,d,u,f,p,h,m,y,v);return g}function da(r,e,t,n,s,i,o,a,c,l,d,u,f,p,h,m,y,v){let g=e.from.type==="collectionRef",{alias:S,input:O,collectionId:K}=fa(e.from,i,c,l,d,u,f,p,o,a,m,y,v);t[S]=O,g&&(y[S]=K);let V=c[n],I=c[K];if(!V)throw new Se(n);if(!I)throw new Se(K);let{activeSource:w,lazySource:T}=ma(e.type,V,I),x=Object.keys(t),{mainExpr:k,joinedExpr:F}=pa(e.left,e.right,x,S),se=W(k),ee=W(F),er=r.pipe(A(([me,Ee])=>[se(Ee),[me,Ee]])),tr=O.pipe(A(([me,Ee])=>{let rr={[S]:Ee};return[ee(rr),[me,rr]]}));if(!["inner","left","right","full"].includes(e.type))throw new yt(e.type);if(w){let me=w==="main"?e.from:h.from,Ee=me.type==="queryRef"&&(me.query.limit||me.query.offset),rr=k.type==="func"||F.type==="func";if(!Ee&&!rr){let nr=w==="main"?S:s;u.add(nr);let Ki=w==="main"?er:tr,yr=ye(h,w==="main"?F:k,T),Ei=yr.collection,Hn=yr.path[0];Hn&&Ve(Hn,yr.path,Ei);let qn=Ki.pipe(Us(Ri=>{let Gn=v[nr]||nr,gr=l[Gn];if(!gr)throw new At(Gn,nr,T.id,Object.keys(l));if(gr.hasLoadedInitialState())return;let Mi=Ri.getInner().map(([[Ai]])=>Ai),_i=new E(yr.path);gr.requestSnapshot({where:kr(_i,Mi),optimizedOnly:!0})||gr.requestSnapshot()}));w==="main"?er=qn:tr=qn}}return er.pipe(qs(tr,e.type),ha(e.type))}function pa(r,e,t,n){let s=t.filter(a=>a!==n),i=zn(r),o=zn(e);if(i&&s.includes(i)&&o===n)return{mainExpr:r,joinedExpr:e};if(i===n&&o&&s.includes(o))return{mainExpr:e,joinedExpr:r};throw!i||!o?new Tt:i===o?new gt(i):s.includes(i)?o!==n?new wt(n):new vt:new xt(i)}function zn(r){switch(r.type){case"ref":return r.path[0]||null;case"func":{let e=new Set;for(let t of r.args){let n=zn(t);n&&e.add(n)}return e.size===1?Array.from(e)[0]:null}default:return null}}function fa(r,e,t,n,s,i,o,a,c,l,d,u,f){switch(r.type){case"collectionRef":{let p=e[r.alias];if(!p)throw new ue(r.alias,r.collection.id,Object.keys(e));return u[r.alias]=r.collection.id,{alias:r.alias,input:p,collectionId:r.collection.id}}case"queryRef":{let p=l.get(r.query)||r.query,h=d(p,e,t,n,s,i,o,a,c,l);Object.assign(u,h.aliasToCollectionId),Object.assign(f,h.aliasRemapping);let m=Object.keys(h.aliasToCollectionId).find(g=>h.aliasToCollectionId[g]===h.collectionId);m&&m!==r.alias&&(f[r.alias]=m);let v=h.pipeline.pipe(A(g=>{let[S,[O,K]]=g;return[S,O]}));return{alias:r.alias,input:v,collectionId:h.collectionId}}default:throw new St(r.type)}}function ha(r){return function(e){return e.pipe(Z(t=>{let[n,[s,i]]=t,o=s?.[1],a=i?.[1];return r==="inner"?!!(o&&a):r==="left"?!!o:r==="right"?!!a:!0}),A(t=>{let[n,[s,i]]=t,o=s?.[0],a=s?.[1],c=i?.[0],l=i?.[1],d={};return a&&Object.assign(d,a),l&&Object.assign(d,l),[`[${o},${c}]`,d]}))}}function ma(r,e,t){switch(r){case"left":return{activeSource:"main",lazySource:t};case"right":return{activeSource:"joined",lazySource:e};case"inner":return e.size<t.size?{activeSource:"main",lazySource:t}:{activeSource:"joined",lazySource:e};default:return{activeSource:void 0,lazySource:void 0}}}var{sum:ya,count:ga,avg:Ta,min:xa,max:wa}=_n;function va(r,e){let t=new Map,n=[...r];if(!e)return{selectToGroupByIndex:t,groupByExpressions:n};for(let[s,i]of Object.entries(e)){if(i.type==="agg")continue;let o=n.findIndex(a=>rn(i,a));if(o===-1)throw new bt(s);t.set(s,o)}return{selectToGroupByIndex:t,groupByExpressions:n}}function Ln(r,e,t,n,s){if(e.length===0){let l={};if(n){for(let[u,f]of Object.entries(n))if(f.type==="agg"){let p=f;l[u]=xi(p)}}let d=()=>({__singleGroup:!0});if(r=r.pipe(en(d,l)),r=r.pipe(A(([,u])=>{let p={...u.__select_results||{}};if(n)for(let[h,m]of Object.entries(n))m.type==="agg"&&(p[h]=u[h]);return["single_group",{...u,__select_results:p}]})),t&&t.length>0)for(let u of t){let f=Tr(u),p=mr(f,n||{}),h=W(p);r=r.pipe(Z(([,m])=>{let y={result:m.__select_results};return h(y)}))}if(s&&s.length>0)for(let u of s)r=r.pipe(Z(([,f])=>{let p={result:f.__select_results};return u(p)}));return r}let i=va(e,n),o=e.map(l=>W(l)),a=([,l])=>{let d={...l};delete d.__select_results;let u={};for(let f=0;f<e.length;f++){let p=o[f],h=p(d);u[`__key_${f}`]=h}return u},c={};if(n){for(let[l,d]of Object.entries(n))if(d.type==="agg"){let u=d;c[l]=xi(u)}}if(r=r.pipe(en(a,c)),r=r.pipe(A(([,l])=>{let d=l.__select_results||{},u={};if(n)for(let[p,h]of Object.entries(n))if(h.type!=="agg"){let m=i.selectToGroupByIndex.get(p);m!==void 0?u[p]=l[`__key_${m}`]:u[p]=d[p]}else u[p]=l[p];else for(let p=0;p<e.length;p++)u[`__key_${p}`]=l[`__key_${p}`];let f;if(e.length===1)f=l.__key_0;else{let p=[];for(let h=0;h<e.length;h++)p.push(l[`__key_${h}`]);f=JSON.stringify(p)}return[f,{...l,__select_results:u}]})),t&&t.length>0)for(let l of t){let d=Tr(l),u=mr(d,n||{}),f=W(u);r=r.pipe(Z(([,p])=>{let h={result:p.__select_results};return f(h)}))}if(s&&s.length>0)for(let l of s)r=r.pipe(Z(([,d])=>{let u={result:d.__select_results};return l(u)}));return r}function rn(r,e){if(!r||!e||r.type!==e.type)return!1;switch(r.type){case"ref":return!r.path||!e.path||r.path.length!==e.path.length?!1:r.path.every((t,n)=>t===e.path[n]);case"val":return r.value===e.value;case"func":return r.name===e.name&&r.args?.length===e.args?.length&&(r.args||[]).every((t,n)=>rn(t,e.args[n]));case"agg":return r.name===e.name&&r.args?.length===e.args?.length&&(r.args||[]).every((t,n)=>rn(t,e.args[n]));default:return!1}}function xi(r){let e=W(r.args[0]),t=([,i])=>{let o=e(i);return typeof o=="number"?o:o!=null?Number(o):0},n=([,i])=>{let o=e(i);return typeof o=="number"||o instanceof Date?o:o!=null?Number(o):0},s=([,i])=>e(i);switch(r.name.toLowerCase()){case"sum":return ya(t);case"count":return ga(s);case"avg":return Ta(t);case"min":return xa(n);case"max":return wa(n);default:throw new Ot(r.name)}}function mr(r,e,t="result"){switch(r.type){case"agg":{let n=r;for(let[s,i]of Object.entries(e))if(i.type==="agg"&&Sa(n,i))return new E([t,s]);throw new It(n.name)}case"func":{let n=r,s=n.args.map(i=>mr(i,e));return new C(n.name,s)}case"ref":return r;case"val":return r;default:throw new Pt(r.type)}}function Sa(r,e){return r.name===e.name&&r.args.length===e.args.length&&r.args.every((t,n)=>rn(t,e.args[n]))}function wi(r,e,t,n,s,i,o,a,c){let l=t.map(h=>{let m=mr(h.expression,n,"__select_results");return{compiledExpression:W(m),compareOptions:h.compareOptions}}),d=h=>{let m=h;return t.length>1?l.map(y=>y.compiledExpression(m)):t.length===1?l[0].compiledExpression(m):null},u=(h,m)=>{if(t.length>1){let y=h,v=m;for(let g=0;g<t.length;g++){let S=t[g],K=Ft(S.compareOptions)(y[g],v[g]);if(K!==0)return K}return y.length-v.length}if(t.length===1){let y=t[0];return Ft(y.compareOptions)(h,m)}return ir(h,m)},f,p;if(a&&t.length===1){let h=t[0],m=h.expression;if(m.type==="ref"){let y=ye(r,m,s),v=y.collection,g=y.path[0];g&&Ve(g,y.path,v,h.compareOptions,u);let S=W(new E(y.path),!0),O=(V,I)=>{let w=V&&S(V),T=I&&S(I);return u(w,T)},K=Ie(v.indexes,y.path,h.compareOptions);K&&K.supports("gt")&&(p={alias:m.path.length>1?String(m.path[0]):r.from.alias,offset:c??0,limit:a,comparator:O,valueExtractorForRawRow:S,index:K,orderBy:t},i[v.id]=p,f=I=>{i[v.id]={...i[v.id],dataNeeded:()=>{let w=I();return Math.max(0,p.limit-w)}}})}}return e.pipe(oi(d,{limit:a,offset:c,comparator:u,setSizeCallback:f,setWindowFn:h=>{o(m=>{h(m),p&&(p.offset=m.offset??p.offset,p.limit=m.limit??p.limit)})}}))}function Nn(r){return r instanceof z?r.value:r}function ba(r,e,t){let n=r.source(e);if(n&&typeof n=="object"){let s=t,i=r.targetPath;if(i.length===0)for(let[o,a]of Object.entries(n))t[o]=Nn(a);else for(let o=0;o<i.length;o++){let a=i[o];if(o===i.length-1){let c=s[a]??={};if(typeof c=="object")for(let[l,d]of Object.entries(n))c[l]=Nn(d)}else{let c=s[a];(c==null||typeof c!="object")&&(s[a]={}),s=s[a]}}}}function Oa(r,e,t){let n=r.alias.split(".");if(n.length===1)t[r.alias]=r.compiled(e);else{let s=t;for(let i=0;i<n.length-1;i++){let o=n[i],a=s[o];(a==null||typeof a!="object")&&(s[o]={}),s=s[o]}s[n[n.length-1]]=Nn(r.compiled(e))}}function Ia([r,e],t){let n={};for(let s of t)s.kind==="merge"?ba(s,e,n):Oa(s,e,n);return[r,{...e,__select_results:n}]}function vi(r,e,t){let n=[];return Si([],e,n),r.pipe(A(s=>Ia(s,n)))}function Pa(r){return r.type==="agg"}function Va(r){return r&&typeof r=="object"&&!Re(r)}function Si(r,e,t){for(let[n,s]of Object.entries(e)){if(n.startsWith("__SPREAD_SENTINEL__")){let o=n.slice(19),a=o.lastIndexOf("__"),c=a>=0?o.slice(0,a):o,l=s&&typeof s=="object"&&"type"in s&&s.type==="ref";if(c.includes(".")||l){let d=[...r],u=l?s:new E(c.split(".")),f=W(u);t.push({kind:"merge",targetPath:d,source:f})}else{let d=c,u=[...r];t.push({kind:"merge",targetPath:u,source:f=>f[d]})}continue}let i=s;if(Va(i)){Si([...r,n],i,t);continue}if(Pa(i))t.push({kind:"field",alias:[...r,n].join("."),compiled:()=>null});else{if(i===void 0||!Re(i)){t.push({kind:"field",alias:[...r,n].join("."),compiled:()=>i});continue}if(i instanceof z){let o=i.value;t.push({kind:"field",alias:[...r,n].join("."),compiled:()=>o})}else t.push({kind:"field",alias:[...r,n].join("."),compiled:W(i)})}}}function Zt(r,e,t,n,s,i,o,a,c=new WeakMap,l=new WeakMap){let d=c.get(r);if(d)return d;let{optimizedQuery:u,sourceWhereClauses:f}=di(r);l.set(u,r),Un(u,r,l);let p={...e},h={},m={},y={},{alias:v,input:g,collectionId:S}=ka(u.from,p,t,n,s,i,o,a,c,l,h,m);y[v]=g;let O=g.pipe(A(([w,T])=>[w,{[v]:T}]));if(u.join&&u.join.length>0&&(O=Ti(O,u.join,y,S,v,p,c,l,t,n,s,i,o,a,r,Zt,h,m)),u.where&&u.where.length>0)for(let w of u.where){let T=sr(w),x=W(T);O=O.pipe(Z(([k,F])=>x(F)))}if(u.fnWhere&&u.fnWhere.length>0)for(let w of u.fnWhere)O=O.pipe(Z(([T,x])=>w(x)));if(u.distinct&&!u.fnSelect&&!u.select)throw new lt;if(u.fnSelect?O=O.pipe(A(([w,T])=>{let x=u.fnSelect(T);return[w,{...T,__select_results:x}]})):u.select?O=vi(O,u.select):O=O.pipe(A(([w,T])=>{let x=!u.join&&!u.groupBy?T[v]:T;return[w,{...T,__select_results:x}]})),u.groupBy&&u.groupBy.length>0?O=Ln(O,u.groupBy,u.having,u.select,u.fnHaving):u.select&&Object.values(u.select).some(T=>T.type==="agg")&&(O=Ln(O,[],u.having,u.select,u.fnHaving)),u.having&&(!u.groupBy||u.groupBy.length===0)&&!(u.select?Object.values(u.select).some(T=>T.type==="agg"):!1))throw new ut;if(u.fnHaving&&u.fnHaving.length>0&&(!u.groupBy||u.groupBy.length===0))for(let w of u.fnHaving)O=O.pipe(Z(([T,x])=>w(x)));if(u.distinct&&(O=O.pipe(Js(([w,T])=>T.__select_results))),u.orderBy&&u.orderBy.length>0){let x=wi(r,O,u.orderBy,u.select||{},t[S],o,a,u.limit,u.offset).pipe(A(([F,[se,ee]])=>{let er=se.__select_results,tr=Wn(er);return[F,[tr,ee]]})),k={collectionId:S,pipeline:x,sourceWhereClauses:f,aliasToCollectionId:h,aliasRemapping:m};return c.set(r,k),k}else if(u.limit!==void 0||u.offset!==void 0)throw new dt;let V=O.pipe(A(([w,T])=>{let x=T.__select_results,k=Wn(x);return[w,[k,void 0]]})),I={collectionId:S,pipeline:V,sourceWhereClauses:f,aliasToCollectionId:h,aliasRemapping:m};return c.set(r,I),I}function ka(r,e,t,n,s,i,o,a,c,l,d,u){switch(r.type){case"collectionRef":{let f=e[r.alias];if(!f)throw new ue(r.alias,r.collection.id,Object.keys(e));return d[r.alias]=r.collection.id,{alias:r.alias,input:f,collectionId:r.collection.id}}case"queryRef":{let f=l.get(r.query)||r.query,p=Zt(f,e,t,n,s,i,o,a,c,l);Object.assign(d,p.aliasToCollectionId),Object.assign(u,p.aliasRemapping);let h=Object.keys(p.aliasToCollectionId).find(v=>p.aliasToCollectionId[v]===p.collectionId);h&&h!==r.alias&&(u[r.alias]=h);let y=p.pipeline.pipe(A(v=>{let[g,[S,O]]=v,K=Wn(S);return[g,K]}));return{alias:r.alias,input:y,collectionId:p.collectionId}}default:throw new pt(r.type)}}function Ca(r){return r instanceof z||r&&typeof r=="object"&&"type"in r&&r.type==="val"}function Wn(r){return Ca(r)?r.value:r}function Un(r,e,t){if(r.from.type==="queryRef"&&e.from.type==="queryRef"&&(t.set(r.from.query,e.from.query),Un(r.from.query,e.from.query,t)),r.join&&e.join)for(let n=0;n<r.join.length&&n<e.join.length;n++){let s=r.join[n],i=e.join[n];s.from.type==="queryRef"&&i.from.type==="queryRef"&&(t.set(s.from.query,i.from.query),Un(s.from.query,i.from.query,t))}}var bi=Symbol.for("@tanstack/db.collection-config-builder"),nn=class{constructor(e,t,n,s){this.alias=e,this.collectionId=t,this.collection=n,this.collectionConfigBuilder=s,this.biggest=void 0,this.subscriptionLoadingPromises=new Map}subscribe(){let e=this.getWhereClauseForAlias();if(e){let t=tn(e,this.alias);if(t)return this.subscribeToChanges(t);throw new _t(this.collectionId,this.alias)}return this.subscribeToChanges()}subscribeToChanges(e){let t,n=this.getOrderByInfo();if(n)t=this.subscribeToOrderedChanges(e,n);else{let o=!this.collectionConfigBuilder.isLazyAlias(this.alias);t=this.subscribeToMatchingChanges(e,o)}let s=t.on("status:change",o=>{if(o.status==="loadingSubset"){if(!this.subscriptionLoadingPromises.has(t)){let a,c=new Promise(l=>{a=l});this.subscriptionLoadingPromises.set(t,{resolve:a}),this.collectionConfigBuilder.liveQueryCollection._sync.trackLoadPromise(c)}}else{let a=this.subscriptionLoadingPromises.get(t);a&&(this.subscriptionLoadingPromises.delete(t),a.resolve())}}),i=()=>{let o=this.subscriptionLoadingPromises.get(t);o&&(this.subscriptionLoadingPromises.delete(t),o.resolve()),s(),t.unsubscribe()};return this.collectionConfigBuilder.currentSyncState.unsubscribeCallbacks.add(i),t}sendChangesToPipeline(e,t){let n=this.collectionConfigBuilder.currentSyncState.inputs[this.alias],i=Ka(n,e,this.collection.config.getKey)>0?t:void 0;this.collectionConfigBuilder.scheduleGraphRun(i,{alias:this.alias})}subscribeToMatchingChanges(e,t=!1){let n=i=>{this.sendChangesToPipeline(i)};return this.collection.subscribeChanges(n,{includeInitialState:t,whereExpression:e})}subscribeToOrderedChanges(e,t){let{orderBy:n,offset:s,limit:i,comparator:o,dataNeeded:a,index:c}=t,l=f=>{let p=Ea(f),h=p;a&&a()===0&&(h=Ma(p,o,this.biggest)),this.sendChangesToPipelineWithTracking(h,d)},d=this.collection.subscribeChanges(l,{whereExpression:e});d.setOrderByIndex(c);let u=Bn(n,this.alias);return d.requestLimitedSnapshot({limit:s+i,orderBy:u}),d}loadMoreIfNeeded(e){let t=this.getOrderByInfo();if(!t)return!0;let{dataNeeded:n}=t;if(!n)throw new Error(`Missing dataNeeded callback for collection ${this.collectionId}`);let s=n();return s>0&&this.loadNextItems(s,e),!0}sendChangesToPipelineWithTracking(e,t){let n=this.getOrderByInfo();if(!n){this.sendChangesToPipeline(e);return}let s=this.trackSentValues(e,n.comparator),i=t;i[bi]??=this.loadMoreIfNeeded.bind(this,t),this.sendChangesToPipeline(s,i[bi])}loadNextItems(e,t){let n=this.getOrderByInfo();if(!n)return;let{orderBy:s,valueExtractorForRawRow:i}=n,o=this.biggest,a=o&&i(o),c=Bn(s,this.alias);t.requestLimitedSnapshot({orderBy:c,limit:e,minValue:a})}getWhereClauseForAlias(){let e=this.collectionConfigBuilder.sourceWhereClausesCache;if(e)return e.get(this.alias)}getOrderByInfo(){let e=this.collectionConfigBuilder.optimizableOrderByCollections[this.collectionId];if(e&&e.alias===this.alias)return e}*trackSentValues(e,t){for(let n of e)this.biggest?t(this.biggest,n.value)<0&&(this.biggest=n.value):this.biggest=n.value,yield n}};function Ka(r,e,t){let n=[];for(let s of e){let i=t(s.value);s.type==="insert"?n.push([[i,s.value],1]):s.type==="update"?(n.push([[i,s.previousValue],-1]),n.push([[i,s.value],1])):n.push([[i,s.value],-1])}return n.length!==0&&r.sendData(new _(n)),n.length}function*Ea(r){for(let e of r)e.type==="update"?(yield{type:"delete",key:e.key,value:e.previousValue},yield{type:"insert",key:e.key,value:e.value}):yield e}function*Ra(r,e){for(let t of r)e(t)&&(yield t)}function*Ma(r,e,t){yield*Ra(r,n=>!t||e(n.value,t)<=0)}var Oi=new WeakMap;function Ii(r){return r.utils?.getBuilder?.()}function Pi(r,e){Oi.set(r,e)}function Vi(r){return Oi.get(r)}var _a=0,sn=class{constructor(e){this.config=e,this.compiledAliasToCollectionId={},this.resultKeys=new WeakMap,this.orderByIndices=new WeakMap,this.isGraphRunning=!1,this.runCount=0,this.isInErrorState=!1,this.aliasDependencies={},this.builderDependencies=new Set,this.pendingGraphRuns=new Map,this.subscriptions={},this.lazySourcesCallbacks={},this.lazySources=new Set,this.optimizableOrderByCollections={},this.id=e.id||`live-query-${++_a}`,this.query=Aa(e),this.collections=Da(this.query);let t=Fa(this.query);this.collectionByAlias={};for(let[n,s]of t.entries()){let i=this.collections[n];if(i)for(let o of s)this.collectionByAlias[o]=i}this.query.orderBy&&this.query.orderBy.length>0&&(this.compare=Ba(this.orderByIndices)),this.compileBasePipeline()}getConfig(){return{id:this.id,getKey:this.config.getKey||(e=>this.resultKeys.get(e)),sync:this.getSyncConfig(),compare:this.compare,gcTime:this.config.gcTime||5e3,schema:this.config.schema,onInsert:this.config.onInsert,onUpdate:this.config.onUpdate,onDelete:this.config.onDelete,startSync:this.config.startSync,singleResult:this.query.singleResult,utils:{getRunCount:this.getRunCount.bind(this),getBuilder:()=>this,setWindow:this.setWindow.bind(this),getWindow:this.getWindow.bind(this)}}}setWindow(e){if(!this.windowFn)throw new Dt;return this.currentWindow=e,this.windowFn(e),this.maybeRunGraphFn?.(),this.liveQueryCollection?.isLoadingSubset?new Promise(t=>{let n=this.liveQueryCollection.on("loadingSubset:change",s=>{s.isLoadingSubset||(n(),t())})}):!0}getWindow(){if(!(!this.windowFn||!this.currentWindow))return{offset:this.currentWindow.offset??0,limit:this.currentWindow.limit??0}}getCollectionIdForAlias(e){let t=this.compiledAliasToCollectionId[e];if(t)return t;let n=this.collectionByAlias[e];if(n)return n.id;throw new Error(`Unknown source alias "${e}"`)}isLazyAlias(e){return this.lazySources.has(e)}maybeRunGraph(e){if(!this.isGraphRunning){if(!this.currentSyncConfig||!this.currentSyncState)throw new Error("maybeRunGraph called without active sync session. This should not happen.");this.isGraphRunning=!0;try{let{begin:t,commit:n}=this.currentSyncConfig,s=this.currentSyncState;if(this.isInErrorState)return;if(s.subscribedToAllCollections){for(;s.graph.pendingWork();)s.graph.run(),e?.();s.messagesCount===0&&(t(),n(),this.updateLiveQueryStatus(this.currentSyncConfig))}}finally{this.isGraphRunning=!1}}}scheduleGraphRun(e,t){let n=t?.contextId??pe()?.id,s=t?.jobId??this,i=(()=>{if(t?.dependencies)return t.dependencies;let c=new Set(this.builderDependencies);if(t?.alias){let l=this.aliasDependencies[t.alias];if(l)for(let d of l)c.add(d)}return c.delete(this),Array.from(c)})();if(!this.currentSyncConfig||!this.currentSyncState)throw new Error("scheduleGraphRun called without active sync session. This should not happen.");let o=n?this.pendingGraphRuns.get(n):void 0;o||(o={loadCallbacks:new Set},n&&this.pendingGraphRuns.set(n,o)),e&&o.loadCallbacks.add(e);let a=n?void 0:o;$t.schedule({contextId:n,jobId:s,dependencies:i,run:()=>this.executeGraphRun(n,a)})}clearPendingGraphRun(e){this.pendingGraphRuns.delete(e)}executeGraphRun(e,t){let n=t??(e?this.pendingGraphRuns.get(e):void 0);if(e&&this.pendingGraphRuns.delete(e),!n||!this.currentSyncConfig||!this.currentSyncState)return;this.incrementRunCount();let s=()=>{let i=!0,o;if(n.loadCallbacks.forEach(a=>{try{i=a()&&i}catch(c){i=!1,o??=c}}),o)throw o;return i};this.maybeRunGraph(s)}getSyncConfig(){return{rowUpdateMode:"full",sync:this.syncFn.bind(this)}}incrementRunCount(){this.runCount++}getRunCount(){return this.runCount}syncFn(e){this.liveQueryCollection=e.collection,this.currentSyncConfig=e;let t={messagesCount:0,subscribedToAllCollections:!1,unsubscribeCallbacks:new Set},n=this.extendPipelineWithChangeProcessing(e,t);this.currentSyncState=n,this.unsubscribeFromSchedulerClears=$t.onClear(i=>{this.clearPendingGraphRun(i)});let s=this.subscribeToAllCollections(e,n);return this.maybeRunGraphFn=()=>this.scheduleGraphRun(s),this.scheduleGraphRun(s),()=>{t.unsubscribeCallbacks.forEach(i=>i()),this.currentSyncConfig=void 0,this.currentSyncState=void 0,this.pendingGraphRuns.clear(),this.graphCache=void 0,this.inputsCache=void 0,this.pipelineCache=void 0,this.sourceWhereClausesCache=void 0,this.lazySources.clear(),this.optimizableOrderByCollections={},this.lazySourcesCallbacks={},Object.keys(this.subscriptions).forEach(i=>delete this.subscriptions[i]),this.compiledAliasToCollectionId={},this.unsubscribeFromSchedulerClears?.(),this.unsubscribeFromSchedulerClears=void 0}}compileBasePipeline(){this.graphCache=new qr,this.inputsCache=Object.fromEntries(Object.keys(this.collectionByAlias).map(n=>[n,this.graphCache.newInput()]));let e=Zt(this.query,this.inputsCache,this.collections,this.subscriptions,this.lazySourcesCallbacks,this.lazySources,this.optimizableOrderByCollections,n=>{this.windowFn=n});this.pipelineCache=e.pipeline,this.sourceWhereClausesCache=e.sourceWhereClauses,this.compiledAliasToCollectionId=e.aliasToCollectionId;let t=Object.keys(this.compiledAliasToCollectionId).filter(n=>!Object.hasOwn(this.inputsCache,n));if(t.length>0)throw new Bt(t)}maybeCompileBasePipeline(){return(!this.graphCache||!this.inputsCache||!this.pipelineCache)&&this.compileBasePipeline(),{graph:this.graphCache,inputs:this.inputsCache,pipeline:this.pipelineCache}}extendPipelineWithChangeProcessing(e,t){let{begin:n,commit:s}=e,{graph:i,inputs:o,pipeline:a}=this.maybeCompileBasePipeline();return a.pipe($s(c=>{let l=c.getInner();t.messagesCount+=l.length,n(),l.reduce(ja,new Map).forEach(this.applyChanges.bind(this,e)),s()})),i.finalize(),t.graph=i,t.inputs=o,t.pipeline=a,t}applyChanges(e,t,n){let{write:s,collection:i}=e,{deletes:o,inserts:a,value:c,orderByIndex:l}=t;if(this.resultKeys.set(c,n),l!==void 0&&this.orderByIndices.set(c,l),a&&o===0)s({value:c,type:"insert"});else if(a>o||a===o&&i.has(i.getKeyFromItem(c)))s({value:c,type:"update"});else if(o>0)s({value:c,type:"delete"});else throw new Error(`Could not apply changes: ${JSON.stringify(t)}. This should never happen.`)}handleSourceStatusChange(e,t,n){let{status:s}=n;if(s==="error"){this.transitionToError(`Source collection '${t}' entered error state`);return}if(s==="cleaned-up"){this.transitionToError(`Source collection '${t}' was manually cleaned up while live query '${this.id}' depends on it. Live queries prevent automatic GC, so this was likely a manual cleanup() call.`);return}this.updateLiveQueryStatus(e)}updateLiveQueryStatus(e){let{markReady:t}=e;this.isInErrorState||this.allCollectionsReady()&&t()}transitionToError(e){this.isInErrorState=!0,console.error(`[Live Query Error] ${e}`),this.liveQueryCollection?._lifecycle.setStatus("error")}allCollectionsReady(){return Object.values(this.collections).every(e=>e.isReady())}subscribeToAllCollections(e,t){let n=Object.entries(this.compiledAliasToCollectionId);if(n.length===0)throw new Error(`Compiler returned no alias metadata for query '${this.id}'. This should not happen; please report.`);let s=n.map(([o,a])=>{let c=this.collectionByAlias[o]??this.collections[a],l=Vi(c);l&&l!==this?(this.aliasDependencies[o]=[l],this.builderDependencies.add(l)):this.aliasDependencies[o]=[];let d=new nn(o,a,c,this),u=c.on("status:change",h=>{this.handleSourceStatusChange(e,a,h)});t.unsubscribeCallbacks.add(u);let f=d.subscribe();return this.subscriptions[o]=f,d.loadMoreIfNeeded.bind(d,f)}),i=()=>(s.map(o=>o()),!0);return t.subscribedToAllCollections=!0,this.updateLiveQueryStatus(e),i}};function Aa(r){return typeof r.query=="function"?Bs(r.query):wn(r.query)}function Ba(r){return(e,t)=>{let n=r.get(e),s=r.get(t);return n&&s?n<s?-1:n>s?1:0:0}}function Da(r){let e={};function t(s){s.type==="collectionRef"?e[s.collection.id]=s.collection:s.type==="queryRef"&&n(s.query)}function n(s){if(s.from&&t(s.from),s.join&&Array.isArray(s.join))for(let i of s.join)i.from&&t(i.from)}return n(r),e}function Fa(r){let e=new Map;function t(s){if(s)if(s.type==="collectionRef"){let{id:i}=s.collection,o=e.get(i);o?o.add(s.alias):e.set(i,new Set([s.alias]))}else s.type==="queryRef"&&n(s.query)}function n(s){if(s&&(t(s.from),s.join))for(let i of s.join)t(i.from)}return n(r),e}function ja(r,[[e,t],n]){let[s,i]=t,o=r.get(e)||{deletes:0,inserts:0,value:s,orderByIndex:i};return n<0?o.deletes+=Math.abs(n):n>0&&(o.inserts+=n,o.value=s,o.orderByIndex=i),r.set(e,o),r}function on(r){return new sn(r).getConfig()}function Ci(r){if(typeof r=="function"){let t=on({query:r});return ki(t)}else{let e=r,t=on(e);return e.utils&&(t.utils={...t.utils,...e.utils}),ki(t)}}function ki(r){let e=Lr(r),t=Ii(r);return t&&Pi(e,t),e}console.log(Object.keys($n).length);

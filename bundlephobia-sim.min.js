var ya=Object.defineProperty;var ii=(r,e)=>{for(var t in e)ya(r,t,{get:e[t],enumerable:!0})};var Li={};ii(Li,{AggregateFunctionNotInSelectError:()=>Nt,AggregateNotSupportedError:()=>sn,BTreeIndex:()=>me,BaseIndex:()=>rr,BaseQueryBuilder:()=>ur,CannotCombineEmptyExpressionListError:()=>Gt,CollectionConfigurationError:()=>ce,CollectionImpl:()=>ze,CollectionInErrorStateError:()=>Xe,CollectionInputNotFoundError:()=>we,CollectionIsInErrorStateError:()=>et,CollectionOperationError:()=>Z,CollectionRequiresConfigError:()=>Ge,CollectionRequiresSyncConfigError:()=>Qe,CollectionStateError:()=>le,DeleteKeyNotFoundError:()=>ut,DistinctRequiresSelectError:()=>It,DuplicateKeyError:()=>nt,DuplicateKeySyncError:()=>it,EmptyReferencePathError:()=>Ct,GroupByError:()=>xe,HavingRequiresGroupByError:()=>Mt,IR:()=>oi,IndexOperation:()=>Os,IndexProxy:()=>or,InvalidCollectionStatusTransitionError:()=>Ze,InvalidJoinCondition:()=>Dt,InvalidJoinConditionLeftSourceError:()=>At,InvalidJoinConditionRightSourceError:()=>Bt,InvalidJoinConditionSameSourceError:()=>Rt,InvalidJoinConditionSourceMismatchError:()=>_t,InvalidSchemaError:()=>Ye,InvalidSourceError:()=>St,InvalidStorageDataFormatError:()=>Ht,InvalidStorageObjectFormatError:()=>Jt,JoinCollectionNotFoundError:()=>Re,JoinConditionMustBeEqualityError:()=>bt,JoinError:()=>ie,KeyUpdateNotAllowedError:()=>ct,LazyIndexWrapper:()=>sr,LimitOffsetRequireOrderByError:()=>Vt,LocalStorageCollectionError:()=>_e,MissingAliasInputsError:()=>Xt,MissingDeleteHandlerError:()=>dt,MissingHandlerError:()=>Ce,MissingInsertHandlerError:()=>ft,MissingMutationFunctionError:()=>ht,MissingUpdateArgumentError:()=>st,MissingUpdateHandlerError:()=>pt,NegativeActiveSubscribersError:()=>tt,NoKeysPassedToDeleteError:()=>lt,NoKeysPassedToUpdateError:()=>ot,NoPendingSyncTransactionCommitError:()=>Tt,NoPendingSyncTransactionWriteError:()=>Ke,NonAggregateExpressionNotInGroupByError:()=>jt,NonRetriableError:()=>nn,OnlyOneSourceAllowedError:()=>xt,Query:()=>js,QueryBuilderError:()=>he,QueryCompilationError:()=>H,QueryMustHaveFromClauseError:()=>Ot,QueryOptimizerError:()=>qt,SchemaMustBeSynchronousError:()=>ke,SchemaValidationError:()=>Pe,SerializationError:()=>Ut,SetWindowRequiresOrderByError:()=>Zt,SortedMap:()=>je,StorageError:()=>Lt,StorageKeyRequiredError:()=>$t,SubQueryMustHaveFromClauseError:()=>vt,SubscriptionNotFoundError:()=>Yt,SyncCleanupError:()=>Ae,SyncTransactionAlreadyCommittedError:()=>wt,SyncTransactionAlreadyCommittedWriteError:()=>Ee,TanStackDBError:()=>N,TransactionAlreadyCompletedRollbackError:()=>yt,TransactionError:()=>re,TransactionNotPendingCommitError:()=>gt,TransactionNotPendingMutateError:()=>mt,UndefinedKeyError:()=>rt,UnknownExpressionTypeError:()=>kt,UnknownFunctionError:()=>Kt,UnknownHavingExpressionTypeError:()=>Wt,UnsupportedAggregateFunctionError:()=>zt,UnsupportedFromTypeError:()=>Pt,UnsupportedJoinSourceTypeError:()=>Ft,UnsupportedJoinTypeError:()=>Et,UpdateKeyNotFoundError:()=>at,WhereClauseConversionError:()=>Qt,add:()=>gs,and:()=>kr,avg:()=>ws,coalesce:()=>ys,compileQuery:()=>mr,concat:()=>ms,count:()=>Ts,createArrayChangeProxy:()=>hi,createChangeProxy:()=>Cr,createCollection:()=>In,createLiveQueryCollection:()=>Ko,createOptimisticAction:()=>_s,createTransaction:()=>ge,eq:()=>ns,getActiveTransaction:()=>ve,gt:()=>un,gte:()=>is,ilike:()=>fs,inArray:()=>pn,isNull:()=>ls,isUndefined:()=>cs,length:()=>hs,like:()=>us,liveQueryCollectionOptions:()=>Un,localOnlyCollectionOptions:()=>As,localStorageCollectionOptions:()=>Bs,lower:()=>ds,lt:()=>fn,lte:()=>ss,max:()=>Ss,min:()=>vs,not:()=>as,or:()=>os,sum:()=>xs,upper:()=>ps,withArrayChangeTracking:()=>vn,withChangeTracking:()=>xn});var oi={};ii(oi,{Aggregate:()=>te,CollectionRef:()=>ne,Func:()=>k,PropRef:()=>R,QueryRef:()=>U,Value:()=>$,createResidualWhere:()=>si,followRef:()=>Ve,getHavingExpression:()=>tn,getWhereExpression:()=>Ir,isExpressionLike:()=>qe,isResidualWhere:()=>rn});var Te=class{},ne=class extends Te{constructor(e,t){super(),this.collection=e,this.alias=t,this.type="collectionRef"}},U=class extends Te{constructor(e,t){super(),this.query=e,this.alias=t,this.type="queryRef"}},R=class extends Te{constructor(e){super(),this.path=e,this.type="ref"}},$=class extends Te{constructor(e){super(),this.value=e,this.type="val"}},k=class extends Te{constructor(e,t){super(),this.name=e,this.args=t,this.type="func"}},te=class extends Te{constructor(e,t){super(),this.name=e,this.args=t,this.type="agg"}};function qe(r){return r instanceof te||r instanceof k||r instanceof R||r instanceof $}function Ir(r){return typeof r=="object"&&"expression"in r?r.expression:r}function tn(r){return typeof r=="object"&&"expression"in r?r.expression:r}function rn(r){return typeof r=="object"&&"expression"in r&&r.residual===!0}function si(r){return{expression:r,residual:!0}}function ga(r,e){if(r.from.alias===e)return r.from;for(let t of r.join||[])if(t.from.alias===e)return t.from}function Ve(r,e,t){if(e.path.length!==0){if(e.path.length===1){let n=e.path[0];if(r.select){let i=r.select[n];if(i&&i.type==="ref")return Ve(r,i,t)}return{collection:t,path:[n]}}if(e.path.length>1){let[n,...i]=e.path,s=ga(r,n);return s?s.type==="queryRef"?Ve(s.query,new R(i),t):{collection:s.collection,path:i}:void 0}}}var N=class extends Error{constructor(e){super(e),this.name="TanStackDBError"}},nn=class extends N{constructor(e){super(e),this.name="NonRetriableError"}},Pe=class extends N{constructor(e,t,n){let i=`${e==="insert"?"Insert":"Update"} validation failed: ${t.map(s=>`
- ${s.message} - path: ${s.path}`).join("")}`;super(n||i),this.name="SchemaValidationError",this.type=e,this.issues=t}},ce=class extends N{constructor(e){super(e),this.name="CollectionConfigurationError"}},Ge=class extends ce{constructor(){super("Collection requires a config")}},Qe=class extends ce{constructor(){super("Collection requires a sync config")}},Ye=class extends ce{constructor(){super("Schema must implement the standard-schema interface")}},ke=class extends ce{constructor(){super("Schema validation must be synchronous")}},le=class extends N{constructor(e){super(e),this.name="CollectionStateError"}},Xe=class extends le{constructor(e,t){super(`Cannot perform ${e} on collection "${t}" - collection is in error state. Try calling cleanup() and restarting the collection.`)}},Ze=class extends le{constructor(e,t,n){super(`Invalid collection status transition from "${e}" to "${t}" for collection "${n}"`)}},et=class extends le{constructor(){super("Collection is in error state")}},tt=class extends le{constructor(){super("Active subscribers count is negative - this should never happen")}},Z=class extends N{constructor(e){super(e),this.name="CollectionOperationError"}},rt=class extends Z{constructor(e){super(`An object was created without a defined key: ${JSON.stringify(e)}`)}},nt=class extends Z{constructor(e){super(`Cannot insert document with ID "${e}" because it already exists in the collection`)}},it=class extends Z{constructor(e,t){super(`Cannot insert document with key "${e}" from sync because it already exists in the collection "${t}"`)}},st=class extends Z{constructor(){super("The first argument to update is missing")}},ot=class extends Z{constructor(){super("No keys were passed to update")}},at=class extends Z{constructor(e){super(`The key "${e}" was passed to update but an object for this key was not found in the collection`)}},ct=class extends Z{constructor(e,t){super(`Updating the key of an item is not allowed. Original key: "${e}", Attempted new key: "${t}". Please delete the old item and create a new one if a key change is necessary.`)}},lt=class extends Z{constructor(){super("No keys were passed to delete")}},ut=class extends Z{constructor(e){super(`Collection.delete was called with key '${e}' but there is no item in the collection with this key`)}},Ce=class extends N{constructor(e){super(e),this.name="MissingHandlerError"}},ft=class extends Ce{constructor(){super("Collection.insert called directly (not within an explicit transaction) but no 'onInsert' handler is configured.")}},pt=class extends Ce{constructor(){super("Collection.update called directly (not within an explicit transaction) but no 'onUpdate' handler is configured.")}},dt=class extends Ce{constructor(){super("Collection.delete called directly (not within an explicit transaction) but no 'onDelete' handler is configured.")}},re=class extends N{constructor(e){super(e),this.name="TransactionError"}},ht=class extends re{constructor(){super("mutationFn is required when creating a transaction")}},mt=class extends re{constructor(){super("You can no longer call .mutate() as the transaction is no longer pending")}},yt=class extends re{constructor(){super("You can no longer call .rollback() as the transaction is already completed")}},gt=class extends re{constructor(){super("You can no longer call .commit() as the transaction is no longer pending")}},Ke=class extends re{constructor(){super("No pending sync transaction to write to")}},Ee=class extends re{constructor(){super("The pending sync transaction is already committed, you can't still write to it.")}},Tt=class extends re{constructor(){super("No pending sync transaction to commit")}},wt=class extends re{constructor(){super("The pending sync transaction is already committed, you can't commit it again.")}},he=class extends N{constructor(e){super(e),this.name="QueryBuilderError"}},xt=class extends he{constructor(e){super(`Only one source is allowed in the ${e}`)}},vt=class extends he{constructor(e){super(`A sub query passed to a ${e} must have a from clause itself`)}},St=class extends he{constructor(e){super(`Invalid source for live query: The value provided for alias "${e}" is not a Collection or subquery. Live queries only accept Collection instances or subqueries. Please ensure you're passing a valid Collection or QueryBuilder, not a plain array or other data type.`)}},bt=class extends he{constructor(){super("Join condition must be an equality expression")}},Ot=class extends he{constructor(){super("Query must have a from clause")}},H=class extends N{constructor(e){super(e),this.name="QueryCompilationError"}},It=class extends H{constructor(){super("DISTINCT requires a SELECT clause.")}},Mt=class extends H{constructor(){super("HAVING clause requires GROUP BY clause")}},Vt=class extends H{constructor(){super("LIMIT and OFFSET require an ORDER BY clause to ensure deterministic results")}},we=class extends H{constructor(e,t,n){let i=t?`alias "${e}" (collection "${t}")`:`collection "${e}"`,s=n?.length?`. Available keys: ${n.join(", ")}`:"";super(`Input for ${i} not found in inputs map${s}`)}},Pt=class extends H{constructor(e){super(`Unsupported FROM type: ${e}`)}},kt=class extends H{constructor(e){super(`Unknown expression type: ${e}`)}},Ct=class extends H{constructor(){super("Reference path cannot be empty")}},Kt=class extends H{constructor(e){super(`Unknown function: ${e}`)}},Re=class extends H{constructor(e){super(`Collection "${e}" not found during compilation of join`)}},ie=class extends N{constructor(e){super(e),this.name="JoinError"}},Et=class extends ie{constructor(e){super(`Unsupported join type: ${e}`)}},Rt=class extends ie{constructor(e){super(`Invalid join condition: both expressions refer to the same source "${e}"`)}},_t=class extends ie{constructor(){super("Invalid join condition: expressions must reference source aliases")}},At=class extends ie{constructor(e){super(`Invalid join condition: left expression refers to an unavailable source "${e}"`)}},Bt=class extends ie{constructor(e){super(`Invalid join condition: right expression does not refer to the joined source "${e}"`)}},Dt=class extends ie{constructor(){super("Invalid join condition")}},Ft=class extends ie{constructor(e){super(`Unsupported join source type: ${e}`)}},xe=class extends N{constructor(e){super(e),this.name="GroupByError"}},jt=class extends xe{constructor(e){super(`Non-aggregate expression '${e}' in SELECT must also appear in GROUP BY clause`)}},zt=class extends xe{constructor(e){super(`Unsupported aggregate function: ${e}`)}},Nt=class extends xe{constructor(e){super(`Aggregate function in HAVING clause must also be in SELECT clause: ${e}`)}},Wt=class extends xe{constructor(e){super(`Unknown expression type in HAVING clause: ${e}`)}},Lt=class extends N{constructor(e){super(e),this.name="StorageError"}},Ut=class extends Lt{constructor(e,t){super(`Cannot ${e} item because it cannot be JSON serialized: ${t}`)}},_e=class extends Lt{constructor(e){super(e),this.name="LocalStorageCollectionError"}},$t=class extends _e{constructor(){super("[LocalStorageCollection] storageKey must be provided.")}},Ht=class extends _e{constructor(e,t){super(`[LocalStorageCollection] Invalid data format in storage key "${e}" for key "${t}".`)}},Jt=class extends _e{constructor(e){super(`[LocalStorageCollection] Invalid data format in storage key "${e}". Expected object format.`)}},Ae=class extends N{constructor(e,t){let n=t instanceof Error?t.message:String(t);super(`Collection "${e}" sync cleanup function threw an error: ${n}`),this.name="SyncCleanupError"}},qt=class extends N{constructor(e){super(e),this.name="QueryOptimizerError"}},Gt=class extends qt{constructor(){super("Cannot combine empty expression list")}},Qt=class extends qt{constructor(e,t){super(`Failed to convert WHERE clause to collection filter for collection '${e}' alias '${t}'. This indicates a bug in the query optimization logic.`)}},Yt=class extends H{constructor(e,t,n,i){super(`Internal error: subscription for alias '${e}' (remapped from '${t}', collection '${n}') is missing in join pipeline. Available aliases: ${i.join(", ")}. This indicates a bug in alias tracking.`)}},sn=class extends H{constructor(){super("Aggregate expressions are not supported in this context. Use GROUP BY clause for aggregates.")}},Xt=class extends H{constructor(e){super(`Internal error: compiler returned aliases without inputs: ${e.join(", ")}. This indicates a bug in query compilation. Please report this issue.`)}},Zt=class extends H{constructor(){super("setWindow() can only be called on collections with an ORDER BY clause. Add .orderBy() to your query to enable window movement.")}};var ai=new WeakMap,Ta=1;function Xi(r){if(ai.has(r))return ai.get(r);let e=Ta++;return ai.set(r,e),e}var ci=(r,e,t)=>{let{nulls:n}=t;if(r==null&&e==null)return 0;if(r==null)return n==="first"?-1:1;if(e==null)return n==="first"?1:-1;if(typeof r=="string"&&typeof e=="string"&&t.stringSort==="locale")return r.localeCompare(e,t.locale,t.localeOptions);if(Array.isArray(r)&&Array.isArray(e)){for(let o=0;o<Math.min(r.length,e.length);o++){let a=ci(r[o],e[o],t);if(a!==0)return a}return r.length-e.length}if(r instanceof Date&&e instanceof Date)return r.getTime()-e.getTime();let i=typeof r=="object",s=typeof e=="object";if(i||s){if(i&&s){let o=Xi(r),a=Xi(e);return o-a}if(i)return 1;if(s)return-1}return r<e?-1:r>e?1:0},wa=(r,e,t)=>ci(e,r,{...t,nulls:t.nulls==="first"?"last":"first"});function er(r){return(e,t)=>r.direction==="asc"?ci(e,t,r):wa(e,t,r)}var Mr=er({direction:"asc",nulls:"first",stringSort:"locale"});function se(r){return r instanceof Date?r.getTime():r}function G(r,e=!1){return li(r,e)}function Vr(r){return li(r,!0)}function li(r,e){switch(r.type){case"val":{let t=r.value;return()=>t}case"ref":return e?va(r):xa(r);case"func":return Sa(r,e);default:throw new kt(r.type)}}function xa(r){let[e,...t]=r.path;if(!e)throw new Ct;if(t.length===0)return n=>n[e];if(t.length===1){let n=t[0];return i=>i[e]?.[n]}else return n=>{let i=n[e];if(i===void 0)return;let s=i;for(let o of t){if(s==null)return s;s=s[o]}return s}}function va(r){let e=r.path;return t=>{let n=t;for(let i of e){if(n==null)return n;n=n[i]}return n}}function Sa(r,e){let t=r.args.map(n=>li(n,e));switch(r.name){case"eq":{let n=t[0],i=t[1];return s=>{let o=se(n(s)),a=se(i(s));return o===a}}case"gt":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return o>a}}case"gte":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return o>=a}}case"lt":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return o<a}}case"lte":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return o<=a}}case"and":return n=>{for(let i of t)if(!i(n))return!1;return!0};case"or":return n=>{for(let i of t)if(i(n))return!0;return!1};case"not":{let n=t[0];return i=>!n(i)}case"in":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return Array.isArray(a)?a.includes(o):!1}}case"like":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return Zi(o,a,!1)}}case"ilike":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return Zi(o,a,!0)}}case"upper":{let n=t[0];return i=>{let s=n(i);return typeof s=="string"?s.toUpperCase():s}}case"lower":{let n=t[0];return i=>{let s=n(i);return typeof s=="string"?s.toLowerCase():s}}case"length":{let n=t[0];return i=>{let s=n(i);return typeof s=="string"||Array.isArray(s)?s.length:0}}case"concat":return n=>t.map(i=>{let s=i(n);try{return String(s??"")}catch{try{return JSON.stringify(s)||""}catch{return"[object]"}}}).join("");case"coalesce":return n=>{for(let i of t){let s=i(n);if(s!=null)return s}return null};case"add":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return(o??0)+(a??0)}}case"subtract":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return(o??0)-(a??0)}}case"multiply":{let n=t[0],i=t[1];return s=>{let o=n(s),a=i(s);return(o??0)*(a??0)}}case"divide":{let n=t[0],i=t[1];return s=>{let o=n(s),c=i(s)??0;return c!==0?(o??0)/c:null}}case"isUndefined":{let n=t[0];return i=>n(i)===void 0}case"isNull":{let n=t[0];return i=>n(i)===null}default:throw new Kt(r.name)}}function Zi(r,e,t){if(typeof r!="string"||typeof e!="string")return!1;let n=t?r.toLowerCase():r,s=(t?e.toLowerCase():e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return s=s.replace(/%/g,".*"),s=s.replace(/_/g,"."),new RegExp(`^${s}$`).test(n)}function Y(r,e){return on(r,e,new Map)}function on(r,e,t){if(r===e)return!0;if(r==null||e==null||typeof r!=typeof e)return!1;if(r instanceof Date)return e instanceof Date?r.getTime()===e.getTime():!1;if(r instanceof RegExp)return e instanceof RegExp?r.source===e.source&&r.flags===e.flags:!1;if(r instanceof Map){if(!(e instanceof Map)||r.size!==e.size)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let i=Array.from(r.entries()).every(([s,o])=>e.has(s)&&on(o,e.get(s),t));return t.delete(r),i}if(r instanceof Set){if(!(e instanceof Set)||r.size!==e.size)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let n=Array.from(r),i=Array.from(e);if(n.every(o=>typeof o!="object"))return t.delete(r),n.every(o=>e.has(o));let s=n.length===i.length;return t.delete(r),s}if(ArrayBuffer.isView(r)&&ArrayBuffer.isView(e)&&!(r instanceof DataView)&&!(e instanceof DataView)){let n=r,i=e;if(n.length!==i.length)return!1;for(let s=0;s<n.length;s++)if(n[s]!==i[s])return!1;return!0}if(Pr(r)&&Pr(e)){let n=ui(r),i=ui(e);return n!==i?!1:typeof r.equals=="function"?r.equals(e):r.toString()===e.toString()}if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;if(t.has(r))return t.get(r)===e;t.set(r,e);let n=r.every((i,s)=>on(i,e[s],t));return t.delete(r),n}if(typeof r=="object"){if(t.has(r))return t.get(r)===e;t.set(r,e);let n=Object.keys(r),i=Object.keys(e);if(n.length!==i.length)return t.delete(r),!1;let s=n.every(o=>o in e&&on(r[o],e[o],t));return t.delete(r),s}return!1}var ba=["Temporal.Duration","Temporal.Instant","Temporal.PlainDate","Temporal.PlainDateTime","Temporal.PlainMonthDay","Temporal.PlainTime","Temporal.PlainYearMonth","Temporal.ZonedDateTime"];function ui(r){return r[Symbol.toStringTag]}function Pr(r){let e=ui(r);return typeof e=="string"&&ba.includes(e)}var tr={direction:"asc",nulls:"first",stringSort:"locale"};var an=class{constructor(e){this.originalIndex=e}lookup(e,t){let n=e==="gt"?"lt":e==="gte"?"lte":e==="lt"?"gt":e==="lte"?"gte":e;return this.originalIndex.lookup(n,t)}rangeQuery(e={}){return this.originalIndex.rangeQueryReversed(e)}rangeQueryReversed(e={}){return this.originalIndex.rangeQuery(e)}take(e,t,n){return this.originalIndex.takeReversed(e,t,n)}takeReversed(e,t,n){return this.originalIndex.take(e,t,n)}get orderedEntriesArray(){return this.originalIndex.orderedEntriesArrayReversed}get orderedEntriesArrayReversed(){return this.originalIndex.orderedEntriesArray}supports(e){return this.originalIndex.supports(e)}matchesField(e){return this.originalIndex.matchesField(e)}matchesCompareOptions(e){return this.originalIndex.matchesCompareOptions(e)}matchesDirection(e){return this.originalIndex.matchesDirection(e)}getStats(){return this.originalIndex.getStats()}add(e,t){this.originalIndex.add(e,t)}remove(e,t){this.originalIndex.remove(e,t)}update(e,t,n){this.originalIndex.update(e,t,n)}build(e){this.originalIndex.build(e)}clear(){this.originalIndex.clear()}get keyCount(){return this.originalIndex.keyCount}equalityLookup(e){return this.originalIndex.equalityLookup(e)}inArrayLookup(e){return this.originalIndex.inArrayLookup(e)}get indexedKeysSet(){return this.originalIndex.indexedKeysSet}get valueMapData(){return this.originalIndex.valueMapData}};function Be(r,e,t=tr){for(let n of r.values())if(n.matchesField(e)&&n.matchesCompareOptions(t))return n.matchesDirection(t.direction)?n:new an(n)}function Oa(r){if(r.length===0)return new Set;if(r.length===1)return new Set(r[0]);let e=new Set(r[0]);for(let t=1;t<r.length;t++){let n=new Set;for(let i of e)r[t].has(i)&&n.add(i);e=n}return e}function Ia(r){let e=new Set;for(let t of r)for(let n of t)e.add(n);return e}function es(r,e){return fi(r,e)}function fi(r,e){if(r.type==="func")switch(r.name){case"eq":case"gt":case"gte":case"lt":case"lte":return Va(r,e);case"and":return Pa(r,e);case"or":return ka(r,e);case"in":return Ca(r,e)}return{canOptimize:!1,matchingKeys:new Set}}function Ma(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=new Map;for(let n of r.args)if(n.type==="func"&&["gt","gte","lt","lte"].includes(n.name)){let i=n;if(i.args.length===2){let s=i.args[0],o=i.args[1],a=null,c=null,l=i.name;if(s.type==="ref"&&o.type==="val")a=s,c=o;else if(s.type==="val"&&o.type==="ref")switch(a=o,c=s,l){case"gt":l="lt";break;case"gte":l="lte";break;case"lt":l="gt";break;case"lte":l="gte";break}if(a&&c){let u=a.path.join("."),d=c.value;t.has(u)||t.set(u,[]),t.get(u).push({operation:l,value:d})}}}for(let[n,i]of t)if(i.length>=2){let s=n.split("."),o=Be(e,s);if(o&&o.supports("gt")&&o.supports("lt")){let a,c,l=!0,f=!0;for(let{operation:d,value:p}of i)switch(d){case"gt":(a===void 0||p>a)&&(a=p,l=!1);break;case"gte":(a===void 0||p>a)&&(a=p,l=!0);break;case"lt":(c===void 0||p<c)&&(c=p,f=!1);break;case"lte":(c===void 0||p<c)&&(c=p,f=!0);break}return{canOptimize:!0,matchingKeys:o.rangeQuery({from:a,to:c,fromInclusive:l,toInclusive:f})}}}return{canOptimize:!1,matchingKeys:new Set}}function Va(r,e){if(r.type!=="func"||r.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let t=r.args[0],n=r.args[1],i=null,s=null,o=r.name;if(t.type==="ref"&&n.type==="val")i=t,s=n;else if(t.type==="val"&&n.type==="ref")switch(i=n,s=t,o){case"gt":o="lt";break;case"gte":o="lte";break;case"lt":o="gt";break;case"lte":o="gte";break}if(i&&s){let a=i.path,c=Be(e,a);if(c){let l=s.value,f=o;return c.supports(f)?{canOptimize:!0,matchingKeys:c.lookup(f,l)}:{canOptimize:!1,matchingKeys:new Set}}}return{canOptimize:!1,matchingKeys:new Set}}function Pa(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=Ma(r,e);if(t.canOptimize)return t;let n=[];for(let i of r.args){let s=fi(i,e);s.canOptimize&&n.push(s)}if(n.length>0){let i=n.map(o=>o.matchingKeys);return{canOptimize:!0,matchingKeys:Oa(i)}}return{canOptimize:!1,matchingKeys:new Set}}function ka(r,e){if(r.type!=="func"||r.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=[];for(let n of r.args){let i=fi(n,e);i.canOptimize&&t.push(i)}if(t.length>0){let n=t.map(s=>s.matchingKeys);return{canOptimize:!0,matchingKeys:Ia(n)}}return{canOptimize:!1,matchingKeys:new Set}}function Ca(r,e){if(r.type!=="func"||r.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let t=r.args[0],n=r.args[1];if(t.type==="ref"&&n.type==="val"&&Array.isArray(n.value)){let i=t.path,s=n.value,o=Be(e,i);if(o){if(o.supports("in"))return{canOptimize:!0,matchingKeys:o.lookup("in",s)};if(o.supports("eq")){let a=new Set;for(let c of s){let l=o.lookup("eq",c);for(let f of l)a.add(f)}return{canOptimize:!0,matchingKeys:a}}}}return{canOptimize:!1,matchingKeys:new Set}}var cn=class{constructor(e,t,n){this._root=pi,this._size=0,this._maxNodeSize=n>=4?Math.min(n,256):32,this._compare=e,t&&this.setPairs(t)}get size(){return this._size}get length(){return this._size}get isEmpty(){return this._size===0}clear(){this._root=pi,this._size=0}get(e,t){return this._root.get(e,t,this)}set(e,t,n){this._root.isShared&&(this._root=this._root.clone());let i=this._root.set(e,t,n,this);return i===!0||i===!1?i:(this._root=new di([this._root,i]),!0)}has(e){return this.forRange(e,e,!0,void 0)!==0}delete(e){return this.editRange(e,e,!0,Ea)!==0}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}keysArray(){let e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(t,n)=>{e.push(t)}),e}nextHigherPair(e,t){return t=t||[],e===void 0?this._root.minPair(t):this._root.getPairOrNextHigher(e,this._compare,!1,t)}nextHigherKey(e){let t=this.nextHigherPair(e,ts);return t&&t[0]}nextLowerPair(e,t){return t=t||[],e===void 0?this._root.maxPair(t):this._root.getPairOrNextLower(e,this._compare,!1,t)}nextLowerKey(e){let t=this.nextLowerPair(e,ts);return t&&t[0]}setPairs(e,t){let n=0;for(let i of e)this.set(i[0],i[1],t)&&n++;return n}forRange(e,t,n,i,s){let o=this._root.forRange(e,t,n,!1,this,s||0,i);return typeof o=="number"?o:o.break}editRange(e,t,n,i,s){let o=this._root;o.isShared&&(this._root=o=o.clone());try{let a=o.forRange(e,t,n,!0,this,s||0,i);return typeof a=="number"?a:a.break}finally{let a;for(;o.keys.length<=1&&!o.isLeaf;)a||=o.isShared,this._root=o=o.keys.length===0?pi:o.children[0];a&&(o.isShared=!0)}}},ln=class r{get isLeaf(){return this.children===void 0}constructor(e=[],t){this.keys=e,this.values=t||Q,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,t,n){let i=this.keys,s=0,o=i.length,a=o>>1;for(;s<o;){let c=n(i[a],e);if(c<0)s=a+1;else if(c>0)o=a;else{if(c===0)return a;if(e===e)return i.length;throw new Error("BTree: NaN was used as a key")}a=s+o>>1}return a^t}minKey(){return this.keys[0]}minPair(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(this.keys.length===0)return;let t=this.keys.length-1;return e[0]=this.keys[t],e[1]=this.values[t],e}clone(){let e=this.values;return new r(this.keys.slice(0),e===Q?e:e.slice(0))}get(e,t,n){let i=this.indexOf(e,-1,n._compare);return i<0?t:this.values[i]}getPairOrNextLower(e,t,n,i){let s=this.indexOf(e,-1,t),o=s<0?~s-1:n?s:s-1;if(o>=0)return i[0]=this.keys[o],i[1]=this.values[o],i}getPairOrNextHigher(e,t,n,i){let s=this.indexOf(e,-1,t),o=s<0?~s:n?s:s+1,a=this.keys;if(o<a.length)return i[0]=a[o],i[1]=this.values[o],i}set(e,t,n,i){let s=this.indexOf(e,-1,i._compare);if(s<0){if(s=~s,i._size++,this.keys.length<i._maxNodeSize)return this.insertInLeaf(s,e,t,i);{let o=this.splitOffRightSide(),a=this;return s>this.keys.length&&(s-=this.keys.length,a=o),a.insertInLeaf(s,e,t,i),o}}else return n!==!1&&(t!==void 0&&this.reifyValues(),this.keys[s]=e,this.values[s]=t),!1}reifyValues(){return this.values===Q?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,t,n,i){if(this.keys.splice(e,0,t),this.values===Q){for(;Q.length<i._maxNodeSize;)Q.push(void 0);if(n===void 0)return!0;this.values=Q.slice(0,this.keys.length-1)}return this.values.splice(e,0,n),!0}takeFromRight(e){let t=this.values;e.values===Q?t!==Q&&t.push(void 0):(t=this.reifyValues(),t.push(e.values.shift())),this.keys.push(e.keys.shift())}takeFromLeft(e){let t=this.values;e.values===Q?t!==Q&&t.unshift(void 0):(t=this.reifyValues(),t.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())}splitOffRightSide(){let e=this.keys.length>>1,t=this.keys.splice(e),n=this.values===Q?Q:this.values.splice(e);return new r(t,n)}forRange(e,t,n,i,s,o,a){let c=s._compare,l,f;if(t===e){if(!n||(f=(l=this.indexOf(e,-1,c))+1,l<0))return o}else l=this.indexOf(e,0,c),f=this.indexOf(t,-1,c),f<0?f=~f:n===!0&&f++;let u=this.keys,d=this.values;if(a!==void 0)for(let p=l;p<f;p++){let h=u[p],m=a(h,d[p],o++);if(m!==void 0){if(i===!0){if(h!==u[p]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");m.delete?(this.keys.splice(p,1),this.values!==Q&&this.values.splice(p,1),s._size--,p--,f--):m.hasOwnProperty("value")&&(d[p]=m.value)}if(m.break!==void 0)return m}}else o+=f-l;return o}mergeSibling(e,t){if(this.keys.push.apply(this.keys,e.keys),this.values===Q){if(e.values===Q)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}},di=class r extends ln{constructor(e,t){if(!t){t=[];for(let n=0;n<e.length;n++)t[n]=e[n].maxKey()}super(t),this.children=e}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,t,n){let i=this.indexOf(e,0,n._compare),s=this.children;return i<s.length?s[i].get(e,t,n):void 0}getPairOrNextLower(e,t,n,i){let s=this.indexOf(e,0,t),o=this.children;if(s>=o.length)return this.maxPair(i);let a=o[s].getPairOrNextLower(e,t,n,i);return a===void 0&&s>0?o[s-1].maxPair(i):a}getPairOrNextHigher(e,t,n,i){let s=this.indexOf(e,0,t),o=this.children,a=o.length;if(s>=a)return;let c=o[s].getPairOrNextHigher(e,t,n,i);return c===void 0&&s<a-1?o[s+1].minPair(i):c}set(e,t,n,i){let s=this.children,o=i._maxNodeSize,a=i._compare,c=Math.min(this.indexOf(e,0,a),s.length-1),l=s[c];if(l.isShared&&(s[c]=l=l.clone()),l.keys.length>=o){let u;c>0&&(u=s[c-1]).keys.length<o&&a(l.keys[0],e)<0?(u.isShared&&(s[c-1]=u=u.clone()),u.takeFromRight(l),this.keys[c-1]=u.maxKey()):(u=s[c+1])!==void 0&&u.keys.length<o&&a(l.maxKey(),e)<0&&(u.isShared&&(s[c+1]=u=u.clone()),u.takeFromLeft(l),this.keys[c]=s[c].maxKey())}let f=l.set(e,t,n,i);if(f===!1)return!1;if(this.keys[c]=l.maxKey(),f===!0)return!0;if(this.keys.length<o)return this.insert(c+1,f),!0;{let u=this.splitOffRightSide(),d=this;return a(f.maxKey(),this.maxKey())>0&&(d=u,c-=this.keys.length),d.insert(c+1,f),u}}insert(e,t){this.children.splice(e,0,t),this.keys.splice(e,0,t.maxKey())}splitOffRightSide(){let e=this.children.length>>1;return new r(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,t,n,i,s,o,a){let c=s._compare,l=this.keys,f=this.children,u=this.indexOf(e,0,c),d=u,p=Math.min(t===e?u:this.indexOf(t,0,c),l.length-1);if(i){if(d<=p)try{for(;d<=p;d++){f[d].isShared&&(f[d]=f[d].clone());let h=f[d].forRange(e,t,n,i,s,o,a);if(l[d]=f[d].maxKey(),typeof h!="number")return h;o=h}}finally{let h=s._maxNodeSize>>1;for(u>0&&u--,d=p;d>=u;d--)f[d].keys.length<=h&&(f[d].keys.length!==0?this.tryMerge(d,s._maxNodeSize):(l.splice(d,1),f.splice(d,1)));f.length!==0&&f[0].keys.length===0&&Ra(!1,"emptiness bug")}}else for(;d<=p;d++){let h=f[d].forRange(e,t,n,i,s,o,a);if(typeof h!="number")return h;o=h}return o}tryMerge(e,t){let n=this.children;return e>=0&&e+1<n.length&&n[e].keys.length+n[e+1].keys.length<=t?(n[e].isShared&&(n[e]=n[e].clone()),n[e].mergeSibling(n[e+1],t),n.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=n[e].maxKey(),!0):!1}mergeSibling(e,t){let n=this.keys.length;this.keys.push.apply(this.keys,e.keys);let i=e.children;if(this.children.push.apply(this.children,i),e.isShared&&!this.isShared)for(let s of i)s.isShared=!0;this.tryMerge(n-1,t)}},Q=[],Ka={delete:!0},Ea=()=>Ka,pi=(function(){let r=new ln;return r.isShared=!0,r})(),ts=[];function Ra(r,...e){throw e.unshift("B+ tree"),new Error(e.join(" "))}function rs(){let r=new Map;function e(t){let n=t.join(".");if(r.has(n))return r.get(n);let i=new Proxy({},{get(s,o,a){if(o==="__refProxy")return!0;if(o==="__path")return t;if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(s,o,a);let c=[...t,String(o)];return e(c)},has(s,o){return o==="__refProxy"||o==="__path"||o==="__type"?!0:Reflect.has(s,o)},ownKeys(s){return Reflect.ownKeys(s)},getOwnPropertyDescriptor(s,o){return o==="__refProxy"||o==="__path"||o==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(s,o)}});return r.set(n,i),i}return e([])}function De(r){let e=new Map,t=0;function n(s){let o=s.join(".");if(e.has(o))return e.get(o);let a=new Proxy({},{get(c,l,f){if(l==="__refProxy")return!0;if(l==="__path")return s;if(l==="__type")return;if(typeof l=="symbol")return Reflect.get(c,l,f);let u=[...s,String(l)];return n(u)},has(c,l){return l==="__refProxy"||l==="__path"||l==="__type"?!0:Reflect.has(c,l)},ownKeys(c){let l=++t,f=`__SPREAD_SENTINEL__${s.join(".")}__${l}`;return Object.prototype.hasOwnProperty.call(c,f)||Object.defineProperty(c,f,{enumerable:!0,configurable:!0,value:!0}),Reflect.ownKeys(c)},getOwnPropertyDescriptor(c,l){return l==="__refProxy"||l==="__path"||l==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(c,l)}});return e.set(o,a),a}return new Proxy({},{get(s,o,a){if(o==="__refProxy")return!0;if(o==="__path")return[];if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(s,o,a);let c=String(o);if(r.includes(c))return n([c])},has(s,o){return o==="__refProxy"||o==="__path"||o==="__type"||typeof o=="string"&&r.includes(o)?!0:Reflect.has(s,o)},ownKeys(s){return[...r,"__refProxy","__path","__type"]},getOwnPropertyDescriptor(s,o){if(o==="__refProxy"||o==="__path"||o==="__type")return{enumerable:!1,configurable:!0};if(typeof o=="string"&&r.includes(o))return{enumerable:!0,configurable:!0}}})}function b(r){return _a(r)?new R(r.__path):r&&typeof r=="object"&&"type"in r&&(r.type==="func"||r.type==="ref"||r.type==="val"||r.type==="agg")?r:new $(r)}function _a(r){return r&&typeof r=="object"&&r.__refProxy===!0}function ns(r,e){return new k("eq",[b(r),b(e)])}function un(r,e){return new k("gt",[b(r),b(e)])}function is(r,e){return new k("gte",[b(r),b(e)])}function fn(r,e){return new k("lt",[b(r),b(e)])}function ss(r,e){return new k("lte",[b(r),b(e)])}function kr(r,e,...t){let n=[r,e,...t];return new k("and",n.map(i=>b(i)))}function os(r,e,...t){let n=[r,e,...t];return new k("or",n.map(i=>b(i)))}function as(r){return new k("not",[b(r)])}function cs(r){return new k("isUndefined",[b(r)])}function ls(r){return new k("isNull",[b(r)])}function pn(r,e){return new k("in",[b(r),b(e)])}function us(r,e){return new k("like",[b(r),b(e)])}function fs(r,e){return new k("ilike",[b(r),b(e)])}function ps(r){return new k("upper",[b(r)])}function ds(r){return new k("lower",[b(r)])}function hs(r){return new k("length",[b(r)])}function ms(...r){return new k("concat",r.map(e=>b(e)))}function ys(...r){return new k("coalesce",r.map(e=>b(e)))}function gs(r,e){return new k("add",[b(r),b(e)])}function Ts(r){return new te("count",[b(r)])}function ws(r){return new te("avg",[b(r)])}function xs(r){return new te("sum",[b(r)])}function vs(r){return new te("min",[b(r)])}function Ss(r){return new te("max",[b(r)])}var bs=["eq","gt","gte","lt","lte","in","like","ilike"];var Os=bs,rr=class{constructor(e,t,n,i){this.lookupCount=0,this.totalLookupTime=0,this.lastUpdated=new Date,this.id=e,this.expression=t,this.compareOptions=tr,this.name=n,this.initialize(i)}supports(e){return this.supportedOperations.has(e)}matchesField(e){return this.expression.type==="ref"&&this.expression.path.length===e.length&&this.expression.path.every((t,n)=>t===e[n])}matchesCompareOptions(e){let t={...this.compareOptions,direction:void 0},n={...e,direction:void 0};return Y(t,n)}matchesDirection(e){return this.compareOptions.direction===e}getStats(){return{entryCount:this.keyCount,lookupCount:this.lookupCount,averageLookupTime:this.lookupCount>0?this.totalLookupTime/this.lookupCount:0,lastUpdated:this.lastUpdated}}evaluateIndexExpression(e){return Vr(this.expression)(e)}trackLookup(e){let t=performance.now()-e;this.lookupCount++,this.totalLookupTime+=t}updateTimestamp(){this.lastUpdated=new Date}};var me=class extends rr{constructor(e,t,n,i){super(e,t,n,i),this.supportedOperations=new Set(["eq","gt","gte","lt","lte","in"]),this.valueMap=new Map,this.indexedKeys=new Set,this.compareFn=Mr,this.compareFn=i?.compareFn??Mr,i?.compareOptions&&(this.compareOptions=i.compareOptions),this.orderedEntries=new cn(this.compareFn)}initialize(e){}add(e,t){let n;try{n=this.evaluateIndexExpression(t)}catch(s){throw new Error(`Failed to evaluate index expression for key ${e}: ${s}`)}let i=se(n);if(this.valueMap.has(i))this.valueMap.get(i).add(e);else{let s=new Set([e]);this.valueMap.set(i,s),this.orderedEntries.set(i,void 0)}this.indexedKeys.add(e),this.updateTimestamp()}remove(e,t){let n;try{n=this.evaluateIndexExpression(t)}catch(s){console.warn(`Failed to evaluate index expression for key ${e} during removal:`,s);return}let i=se(n);if(this.valueMap.has(i)){let s=this.valueMap.get(i);s.delete(e),s.size===0&&(this.valueMap.delete(i),this.orderedEntries.delete(i))}this.indexedKeys.delete(e),this.updateTimestamp()}update(e,t,n){this.remove(e,t),this.add(e,n)}build(e){this.clear();for(let[t,n]of e)this.add(t,n)}clear(){this.orderedEntries.clear(),this.valueMap.clear(),this.indexedKeys.clear(),this.updateTimestamp()}lookup(e,t){let n=performance.now(),i;switch(e){case"eq":i=this.equalityLookup(t);break;case"gt":i=this.rangeQuery({from:t,fromInclusive:!1});break;case"gte":i=this.rangeQuery({from:t,fromInclusive:!0});break;case"lt":i=this.rangeQuery({to:t,toInclusive:!1});break;case"lte":i=this.rangeQuery({to:t,toInclusive:!0});break;case"in":i=this.inArrayLookup(t);break;default:throw new Error(`Operation ${e} not supported by BTreeIndex`)}return this.trackLookup(n),i}get keyCount(){return this.indexedKeys.size}equalityLookup(e){let t=se(e);return new Set(this.valueMap.get(t)??[])}rangeQuery(e={}){let{from:t,to:n,fromInclusive:i=!0,toInclusive:s=!0}=e,o=new Set,a=se(t),c=se(n),l=a??this.orderedEntries.minKey(),f=c??this.orderedEntries.maxKey();return this.orderedEntries.forRange(l,f,s,(u,d)=>{if(!i&&this.compareFn(u,t)===0)return;let p=this.valueMap.get(u);p&&p.forEach(h=>o.add(h))}),o}rangeQueryReversed(e={}){let{from:t,to:n,fromInclusive:i=!0,toInclusive:s=!0}=e;return this.rangeQuery({from:n??this.orderedEntries.maxKey(),to:t??this.orderedEntries.minKey(),fromInclusive:s,toInclusive:i})}takeInternal(e,t,n,i){let s=new Set,o=[],a,c=se(n);for(;(a=t(c))!==void 0&&o.length<e;){c=a[0];let l=this.valueMap.get(c);if(l){let f=l.values(),u;for(;o.length<e&&(u=f.next().value);)!s.has(u)&&(i?.(u)??!0)&&(o.push(u),s.add(u))}}return o}take(e,t,n){let i=s=>this.orderedEntries.nextHigherPair(s);return this.takeInternal(e,i,t,n)}takeReversed(e,t,n){let i=s=>this.orderedEntries.nextLowerPair(s);return this.takeInternal(e,i,t,n)}inArrayLookup(e){let t=new Set;for(let n of e){let i=se(n),s=this.valueMap.get(i);s&&s.forEach(o=>t.add(o))}return t}get indexedKeysSet(){return this.indexedKeys}get orderedEntriesArray(){return this.orderedEntries.keysArray().map(e=>[e,this.valueMap.get(e)??new Set])}get orderedEntriesArrayReversed(){return this.takeReversed(this.orderedEntries.size).map(e=>[e,this.valueMap.get(e)??new Set])}get valueMapData(){return this.valueMap}};function Is(r){return r.config.autoIndex==="eager"}function Fe(r,e,t,n=tr,i){if(!(!Is(t)||Array.from(t.indexes.values()).find(o=>o.matchesField(e)&&o.matchesCompareOptions(n))))try{t.createIndex(o=>o[r],{name:`auto_${r}`,indexType:me,options:i?{compareFn:i,compareOptions:n}:{}})}catch(o){console.warn(`${t.id?`[${t.id}] `:""}Failed to create auto-index for field "${r}":`,o)}}function Ms(r,e){if(!Is(e))return;let t=Aa(r);for(let{fieldName:n,fieldPath:i}of t)Fe(n,i,e)}function Aa(r){let e=[];function t(n){if(n.type!=="func")return;let i=n;if(i.name==="and"){for(let l of i.args)t(l);return}if(!["eq","gt","gte","lt","lte","in"].includes(i.name)||i.args.length<1||i.args[0].type!=="ref")return;let a=i.args[0].path;if(a.length!==1)return;let c=a[0];e.push({fieldName:c,fieldPath:a})}return t(r),e}function Ps(r,e={}){let t=n=>{let i=[];for(let[s,o]of r.entries())(n?.(o)??!0)&&i.push({type:"insert",key:s,value:o});return i};if(e.limit!==void 0&&!e.orderBy)throw new Error("limit cannot be used without orderBy");if(e.orderBy){let n=e.where?nr(e.where):void 0,i=Ba(r,e.orderBy,e.limit,n,e.optimizedOnly);if(i===void 0)return;let s=[];for(let o of i){let a=r.get(o);a!==void 0&&s.push({type:"insert",key:o,value:a})}return s}if(!e.where)return t();try{let n=e.where,i=es(n,r.indexes);if(i.canOptimize){let s=[];for(let o of i.matchingKeys){let a=r.get(o);a!==void 0&&s.push({type:"insert",key:o,value:a})}return s}else{if(e.optimizedOnly)return;let s=nr(n);return t(s)}}catch(n){console.warn(`${r.id?`[${r.id}] `:""}Error processing where clause, falling back to full scan:`,n);let i=nr(e.where);return e.optimizedOnly?void 0:t(i)}}function nr(r){return e=>{try{return!!Vr(r)(e)}catch{return!1}}}function ks(r,e){let t=nr(e.whereExpression);return n=>{let i=[];for(let s of n)if(s.type==="insert")t(s.value)&&i.push(s);else if(s.type==="update"){let o=t(s.value),a=s.previousValue?t(s.previousValue):!1;o&&a?i.push(s):o&&!a?i.push({...s,type:"insert"}):!o&&a&&i.push({...s,type:"delete",value:s.previousValue})}else t(s.value)&&i.push(s);(i.length>0||n.length===0)&&r(i)}}function Ba(r,e,t,n,i){if(e.length===1){let c=e[0],l=c.expression;if(l.type==="ref"){let u=l.path;Fe(u[0],u,r,c.compareOptions);let d=Be(r.indexes,u,c.compareOptions);if(d&&d.supports("gt")){let p=h=>{let m=r.get(h);return m===void 0?!1:n?.(m)??!0};return d.take(t??d.keyCount,void 0,p)}}}if(i)return;let s=[];for(let[c,l]of r.entries())(n?.(l)??!0)&&s.push({key:c,value:l});let o=(c,l)=>{for(let f of e){let u=er(f.compareOptions),d=Vs(c.value,f.expression),p=Vs(l.value,f.expression),h=u(d,p);if(h!==0)return h}return 0};s.sort(o);let a=s.map(c=>c.key);return t!==void 0?a.slice(0,t):a}function Vs(r,e){if(e.type==="ref"){let t=e,n=r;for(let i of t.path)n=n?.[i];return n}else return e.type==="val"?e.value:Vr(e)(r)}var je=class{constructor(e){this.map=new Map,this.sortedKeys=[],this.comparator=e||this.defaultComparator}defaultComparator(e,t){return e<t?-1:e>t?1:0}indexOf(e){let t=0,n=this.sortedKeys.length;for(;t<n;){let i=Math.floor((t+n)/2),s=this.sortedKeys[i],o=this.map.get(s),a=this.comparator(e,o);if(a<0)n=i;else if(a>0)t=i+1;else return i}return t}set(e,t){if(this.map.has(e)){let i=this.map.get(e),s=this.indexOf(i);this.sortedKeys.splice(s,1)}let n=this.indexOf(t);return this.sortedKeys.splice(n,0,e),this.map.set(e,t),this}get(e){return this.map.get(e)}delete(e){if(this.map.has(e)){let t=this.map.get(e),n=this.indexOf(t);return this.sortedKeys.splice(n,1),this.map.delete(e)}return!1}has(e){return this.map.has(e)}clear(){this.map.clear(),this.sortedKeys=[]}get size(){return this.map.size}*[Symbol.iterator](){for(let e of this.sortedKeys)yield[e,this.map.get(e)]}entries(){return this[Symbol.iterator]()}keys(){return this.sortedKeys[Symbol.iterator]()}values(){return(function*(){for(let e of this.sortedKeys)yield this.map.get(e)}).call(this)}forEach(e){for(let t of this.sortedKeys)e(this.map.get(t),t,this.map)}};var dn=class{constructor(e){this.pendingSyncedTransactions=[],this.syncedMetadata=new Map,this.optimisticUpserts=new Map,this.optimisticDeletes=new Set,this.size=0,this.syncedKeys=new Set,this.preSyncVisibleState=new Map,this.recentlySyncedKeys=new Set,this.hasReceivedFirstCommit=!1,this.isCommittingSyncTransactions=!1,this.commitPendingTransactions=()=>{let t=!1;for(let o of this.transactions.values())if(o.state==="persisting"){t=!0;break}let{committedSyncedTransactions:n,uncommittedSyncedTransactions:i,hasTruncateSync:s}=this.pendingSyncedTransactions.reduce((o,a)=>(a.committed?(o.committedSyncedTransactions.push(a),a.truncate===!0&&(o.hasTruncateSync=!0)):o.uncommittedSyncedTransactions.push(a),o),{committedSyncedTransactions:[],uncommittedSyncedTransactions:[],hasTruncateSync:!1});if(!t||s){this.isCommittingSyncTransactions=!0;let o=s?n.find(d=>d.truncate)?.optimisticSnapshot:null,a=new Set;for(let d of n)for(let p of d.operations)a.add(p.key);let c=this.preSyncVisibleState;if(c.size===0){c=new Map;for(let d of a){let p=this.get(d);p!==void 0&&c.set(d,p)}}let l=[],f=this.config.sync.rowUpdateMode||"partial";for(let d of n){if(d.truncate){let p=new Set([...this.syncedData.keys(),...o?.upserts.keys()||[]]);for(let h of p){if(o?.deletes.has(h))continue;let m=o?.upserts.get(h)||this.syncedData.get(h);m!==void 0&&l.push({type:"delete",key:h,value:m})}this.syncedData.clear(),this.syncedMetadata.clear(),this.syncedKeys.clear();for(let h of a)c.delete(h)}for(let p of d.operations){let h=p.key;switch(this.syncedKeys.add(h),p.type){case"insert":this.syncedMetadata.set(h,p.metadata);break;case"update":this.syncedMetadata.set(h,Object.assign({},this.syncedMetadata.get(h),p.metadata));break;case"delete":this.syncedMetadata.delete(h);break}switch(p.type){case"insert":this.syncedData.set(h,p.value);break;case"update":{if(f==="partial"){let m=Object.assign({},this.syncedData.get(h),p.value);this.syncedData.set(h,m)}else this.syncedData.set(h,p.value);break}case"delete":this.syncedData.delete(h);break}}}if(s){let d=new Set;for(let m of n)for(let y of m.operations)(y.type==="insert"||y.type==="update")&&d.add(y.key);let p=new Map(o.upserts),h=new Set(o.deletes);for(let[m,y]of p)if(!h.has(m))if(d.has(m)){let v=!1;for(let g=l.length-1;g>=0;g--){let S=l[g];if(S.key===m&&S.type==="insert"){S.value=y,v=!0;break}}v||l.push({type:"insert",key:m,value:y})}else l.push({type:"insert",key:m,value:y});if(l.length>0&&h.size>0){let m=[];for(let y of l)y.type==="insert"&&h.has(y.key)||m.push(y);l.length=0,l.push(...m)}this.lifecycle.status!=="ready"&&this.lifecycle.markReady()}if(this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.isCommittingSyncTransactions=!1,s&&o){for(let[d,p]of o.upserts)this.optimisticUpserts.set(d,p);for(let d of o.deletes)this.optimisticDeletes.add(d)}for(let d of this.transactions.values())if(!["completed","failed"].includes(d.state)){for(let p of d.mutations)if(this.isThisCollection(p.collection)&&p.optimistic)switch(p.type){case"insert":case"update":this.optimisticUpserts.set(p.key,p.modified),this.optimisticDeletes.delete(p.key);break;case"delete":this.optimisticUpserts.delete(p.key),this.optimisticDeletes.add(p.key);break}}let u=new Map;for(let d of this.transactions.values())if(d.state==="completed")for(let p of d.mutations)p.optimistic&&this.isThisCollection(p.collection)&&a.has(p.key)&&u.set(p.key,{type:p.type,value:p.modified});for(let d of a){let p=c.get(d),h=this.get(d),m=u.get(d),y=!1;m&&(m.type==="delete"&&p!==void 0&&h===void 0&&Y(m.value,p)||h!==void 0&&Y(m.value,h))&&(y=!0),y||(p===void 0&&h!==void 0?l.push({type:"insert",key:d,value:h}):p!==void 0&&h===void 0?l.push({type:"delete",key:d,value:p}):p!==void 0&&h!==void 0&&!Y(p,h)&&l.push({type:"update",key:d,value:h,previousValue:p}))}this.size=this.calculateSize(),l.length>0&&this.indexes.updateIndexes(l),this.changes.emitEvents(l,!0),this.pendingSyncedTransactions=i,this.preSyncVisibleState.clear(),Promise.resolve().then(()=>{this.recentlySyncedKeys.clear()}),this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0)}},this.config=e,this.transactions=new je((t,n)=>t.compareCreatedAt(n)),e.compare?this.syncedData=new je(e.compare):this.syncedData=new Map}setDeps(e){this.collection=e.collection,this.lifecycle=e.lifecycle,this.changes=e.changes,this.indexes=e.indexes}get(e){let{optimisticDeletes:t,optimisticUpserts:n,syncedData:i}=this;if(!t.has(e))return n.has(e)?n.get(e):i.get(e)}has(e){let{optimisticDeletes:t,optimisticUpserts:n,syncedData:i}=this;return t.has(e)?!1:n.has(e)?!0:i.has(e)}*keys(){let{syncedData:e,optimisticDeletes:t,optimisticUpserts:n}=this;for(let i of e.keys())t.has(i)||(yield i);for(let i of n.keys())!e.has(i)&&!t.has(i)&&(yield i)}*values(){for(let e of this.keys()){let t=this.get(e);t!==void 0&&(yield t)}}*entries(){for(let e of this.keys()){let t=this.get(e);t!==void 0&&(yield[e,t])}}*[Symbol.iterator](){for(let[e,t]of this.entries())yield[e,t]}forEach(e){let t=0;for(let[n,i]of this.entries())e(i,n,t++)}map(e){let t=[],n=0;for(let[i,s]of this.entries())t.push(e(s,i,n++));return t}isThisCollection(e){return e===this.collection}recomputeOptimisticState(e=!1){if(this.isCommittingSyncTransactions&&!e)return;let t=new Map(this.optimisticUpserts),n=new Set(this.optimisticDeletes);this.optimisticUpserts.clear(),this.optimisticDeletes.clear();let i=[];for(let a of this.transactions.values())["completed","failed"].includes(a.state)||i.push(a);for(let a of i)for(let c of a.mutations)if(this.isThisCollection(c.collection)&&c.optimistic)switch(c.type){case"insert":case"update":this.optimisticUpserts.set(c.key,c.modified),this.optimisticDeletes.delete(c.key);break;case"delete":this.optimisticUpserts.delete(c.key),this.optimisticDeletes.add(c.key);break}this.size=this.calculateSize();let s=[];this.collectOptimisticChanges(t,n,s);let o=s.filter(a=>!!(!this.recentlySyncedKeys.has(a.key)||e));if(this.pendingSyncedTransactions.length>0&&!e){let a=new Set;for(let l of this.pendingSyncedTransactions)for(let f of l.operations)a.add(f.key);let c=o.filter(l=>!(l.type==="delete"&&a.has(l.key)&&!i.some(u=>u.mutations.some(d=>this.isThisCollection(d.collection)&&d.key===l.key))));c.length>0&&this.indexes.updateIndexes(c),this.changes.emitEvents(c,e)}else o.length>0&&this.indexes.updateIndexes(o),this.changes.emitEvents(o,e)}calculateSize(){let e=this.syncedData.size,t=Array.from(this.optimisticDeletes).filter(i=>this.syncedData.has(i)&&!this.optimisticUpserts.has(i)).length,n=Array.from(this.optimisticUpserts.keys()).filter(i=>!this.syncedData.has(i)).length;return e-t+n}collectOptimisticChanges(e,t,n){let i=new Set([...e.keys(),...this.optimisticUpserts.keys(),...t,...this.optimisticDeletes]);for(let s of i){let o=this.get(s),a=this.getPreviousValue(s,e,t);a!==void 0&&o===void 0?n.push({type:"delete",key:s,value:a}):a===void 0&&o!==void 0?n.push({type:"insert",key:s,value:o}):a!==void 0&&o!==void 0&&a!==o&&n.push({type:"update",key:s,value:o,previousValue:a})}}getPreviousValue(e,t,n){if(!n.has(e))return t.has(e)?t.get(e):this.syncedData.get(e)}scheduleTransactionCleanup(e){if(e.state==="completed"){this.transactions.delete(e.id);return}e.isPersisted.promise.then(()=>{this.transactions.delete(e.id)}).catch(()=>{})}capturePreSyncVisibleState(){if(this.pendingSyncedTransactions.length===0)return;let e=new Set;for(let t of this.pendingSyncedTransactions)for(let n of t.operations)e.add(n.key);for(let t of e)this.recentlySyncedKeys.add(t);for(let t of e)if(!this.preSyncVisibleState.has(t)){let n=this.get(t);n!==void 0&&this.preSyncVisibleState.set(t,n)}}onTransactionStateChange(){this.changes.shouldBatchEvents=this.pendingSyncedTransactions.length>0,this.capturePreSyncVisibleState(),this.recomputeOptimisticState(!1)}cleanup(){this.syncedData.clear(),this.syncedMetadata.clear(),this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.size=0,this.pendingSyncedTransactions=[],this.syncedKeys.clear(),this.hasReceivedFirstCommit=!1}};var ir=class{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{this.listeners.get(e)?.delete(t)}}once(e,t){let n=this.on(e,i=>{t(i),n()});return n}off(e,t){this.listeners.get(e)?.delete(t)}waitFor(e,t){return new Promise((n,i)=>{let s,o=this.on(e,a=>{s&&(clearTimeout(s),s=void 0),n(a),o()});t&&(s=setTimeout(()=>{s=void 0,o(),i(new Error(`Timeout waiting for event ${String(e)}`))},t))})}emitInner(e,t){this.listeners.get(e)?.forEach(n=>{try{n(t)}catch(i){queueMicrotask(()=>{throw i})}})}clearListeners(){this.listeners.clear()}};var hn=class extends ir{constructor(e,t,n){super(),this.collection=e,this.callback=t,this.options=n,this.loadedInitialState=!1,this.snapshotSent=!1,this.sentKeys=new Set,this._status="ready",this.pendingLoadSubsetPromises=new Set,n.onUnsubscribe&&this.on("unsubscribed",s=>n.onUnsubscribe(s)),n.whereExpression&&Ms(n.whereExpression,this.collection);let i=s=>{t(s),this.trackSentKeys(s)};this.callback=i,this.filteredCallback=n.whereExpression?ks(this.callback,n):this.callback}get status(){return this._status}setOrderByIndex(e){this.orderByIndex=e}setStatus(e){if(this._status===e)return;let t=this._status;this._status=e,this.emitInner("status:change",{type:"status:change",subscription:this,previousStatus:t,status:e});let n=`status:${e}`;this.emitInner(n,{type:n,subscription:this,previousStatus:t,status:e})}trackLoadSubsetPromise(e){e instanceof Promise&&(this.pendingLoadSubsetPromises.add(e),this.setStatus("loadingSubset"),e.finally(()=>{this.pendingLoadSubsetPromises.delete(e),this.pendingLoadSubsetPromises.size===0&&this.setStatus("ready")}))}hasLoadedInitialState(){return this.loadedInitialState}hasSentAtLeastOneSnapshot(){return this.snapshotSent}emitEvents(e){let t=this.filterAndFlipChanges(e);this.filteredCallback(t)}requestSnapshot(e){if(this.loadedInitialState)return!1;let t={where:this.options.whereExpression,optimizedOnly:e?.optimizedOnly??!1};if(e){if("where"in e){let o=e.where;if(t.where){let a=t.where,c=kr(a,o);t.where=c}else t.where=o}}else this.loadedInitialState=!0;let n=this.collection._sync.loadSubset({where:t.where,subscription:this});this.trackLoadSubsetPromise(n);let i=this.collection.currentStateAsChanges(t);if(i===void 0)return!1;let s=i.filter(o=>!this.sentKeys.has(o.key));return this.snapshotSent=!0,this.callback(s),!0}requestLimitedSnapshot({orderBy:e,limit:t,minValue:n}){if(!t)throw new Error("limit is required");if(!this.orderByIndex)throw new Error("Ordered snapshot was requested but no index was found. You have to call setOrderByIndex before requesting an ordered snapshot.");let i=this.orderByIndex,s=this.options.whereExpression,o=s?nr(s):void 0,a=m=>{if(this.sentKeys.has(m))return!1;let y=this.collection.get(m);return y===void 0?!1:o?.(y)??!0},c=n,l=[],f=i.take(t,n,a),u=()=>Math.max(t-l.length,0),d=()=>f.length===0;for(;u()>0&&!d();){for(let m of f){let y=this.collection.get(m);l.push({type:"insert",key:m,value:y}),c=y}f=i.take(u(),c,a)}this.callback(l);let p=s;if(typeof n<"u"){let{expression:m,compareOptions:y}=e[0],g=(y.direction==="asc"?un:fn)(m,new $(n));p=s?kr(s,g):g}let h=this.collection._sync.loadSubset({where:p,limit:t,orderBy:e,subscription:this});this.trackLoadSubsetPromise(h)}filterAndFlipChanges(e){if(this.loadedInitialState)return e;let t=[];for(let n of e){let i=n;if(!this.sentKeys.has(n.key)){if(n.type==="update")i={...n,type:"insert",previousValue:void 0};else if(n.type==="delete")continue;this.sentKeys.add(n.key)}t.push(i)}return t}trackSentKeys(e){if(!this.loadedInitialState)for(let t of e)this.sentKeys.add(t.key)}unsubscribe(){this.emitInner("unsubscribed",{type:"unsubscribed",subscription:this}),this.clearListeners()}};var mn=class{constructor(){this.activeSubscribersCount=0,this.changeSubscriptions=new Set,this.batchedEvents=[],this.shouldBatchEvents=!1}setDeps(e){this.lifecycle=e.lifecycle,this.sync=e.sync,this.events=e.events,this.collection=e.collection}emitEmptyReadyEvent(){for(let e of this.changeSubscriptions)e.emitEvents([])}emitEvents(e,t=!1){if(this.shouldBatchEvents&&!t){this.batchedEvents.push(...e);return}let n=e;if(t&&(this.batchedEvents.length>0&&(n=[...this.batchedEvents,...e]),this.batchedEvents=[],this.shouldBatchEvents=!1),n.length!==0)for(let i of this.changeSubscriptions)i.emitEvents(n)}subscribeChanges(e,t={}){this.addSubscriber();let n=new hn(this.collection,e,{...t,onUnsubscribe:()=>{this.removeSubscriber(),this.changeSubscriptions.delete(n)}});return t.includeInitialState&&n.requestSnapshot(),this.changeSubscriptions.add(n),n}addSubscriber(){let e=this.activeSubscribersCount;this.activeSubscribersCount++,this.lifecycle.cancelGCTimer(),(this.lifecycle.status==="cleaned-up"||this.lifecycle.status==="idle")&&this.sync.startSync(),this.events.emitSubscribersChange(this.activeSubscribersCount,e)}removeSubscriber(){let e=this.activeSubscribersCount;if(this.activeSubscribersCount--,this.activeSubscribersCount===0)this.lifecycle.startGCTimer();else if(this.activeSubscribersCount<0)throw new tt;this.events.emitSubscribersChange(this.activeSubscribersCount,e)}cleanup(){this.batchedEvents=[],this.shouldBatchEvents=!1}};var Da=r=>setTimeout(()=>{r({didTimeout:!0,timeRemaining:()=>50})},0),Fa=r=>{clearTimeout(r)},Cs=typeof window<"u"&&"requestIdleCallback"in window?(r,e)=>window.requestIdleCallback(r,e):(r,e)=>Da(r),yn=typeof window<"u"&&"cancelIdleCallback"in window?r=>window.cancelIdleCallback(r):Fa;var gn=class{constructor(e,t){this.status="idle",this.hasBeenReady=!1,this.hasReceivedFirstCommit=!1,this.onFirstReadyCallbacks=[],this.gcTimeoutId=null,this.idleCallbackId=null,this.config=e,this.id=t}setDeps(e){this.indexes=e.indexes,this.events=e.events,this.changes=e.changes,this.sync=e.sync,this.state=e.state}validateStatusTransition(e,t){if(e===t)return;if(!{idle:["loading","error","cleaned-up"],loading:["ready","error","cleaned-up"],ready:["cleaned-up","error"],error:["cleaned-up","idle"],"cleaned-up":["loading","error"]}[e].includes(t))throw new Ze(e,t,this.id)}setStatus(e,t=!1){if(e==="ready"&&!t)throw new le(`You can't directly call "setStatus('ready'). You must use markReady instead.`);this.validateStatusTransition(this.status,e);let n=this.status;this.status=e,e==="ready"&&!this.indexes.isIndexesResolved&&this.indexes.resolveAllIndexes().catch(i=>{console.warn(`${this.config.id?`[${this.config.id}] `:""}Failed to resolve indexes:`,i)}),this.events.emitStatusChange(e,n)}validateCollectionUsable(e){switch(this.status){case"error":throw new Xe(e,this.id);case"cleaned-up":this.sync.startSync();break}}markReady(){if(this.validateStatusTransition(this.status,"ready"),this.status==="loading"){if(this.setStatus("ready",!0),!this.hasBeenReady){this.hasBeenReady=!0,this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0);let e=[...this.onFirstReadyCallbacks];this.onFirstReadyCallbacks=[],e.forEach(t=>t())}this.changes.changeSubscriptions.size>0&&this.changes.emitEmptyReadyEvent()}}startGCTimer(){this.gcTimeoutId&&clearTimeout(this.gcTimeoutId);let e=this.config.gcTime??3e5;e!==0&&(this.gcTimeoutId=setTimeout(()=>{this.changes.activeSubscribersCount===0&&this.scheduleIdleCleanup()},e))}cancelGCTimer(){this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.idleCallbackId!==null&&(yn(this.idleCallbackId),this.idleCallbackId=null)}scheduleIdleCleanup(){this.idleCallbackId!==null&&yn(this.idleCallbackId),this.idleCallbackId=Cs(e=>{this.changes.activeSubscribersCount===0?this.performCleanup(e)&&(this.idleCallbackId=null):this.idleCallbackId=null},{timeout:1e3})}performCleanup(e){return!e||e.timeRemaining()>0||e.didTimeout?(this.sync.cleanup(),this.state.cleanup(),this.changes.cleanup(),this.indexes.cleanup(),this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.hasBeenReady=!1,this.onFirstReadyCallbacks=[],this.setStatus("cleaned-up"),this.events.cleanup(),!0):(this.scheduleIdleCleanup(),!1)}onFirstReady(e){if(this.hasBeenReady){e();return}this.onFirstReadyCallbacks.push(e)}cleanup(){this.idleCallbackId!==null&&(yn(this.idleCallbackId),this.idleCallbackId=null),this.performCleanup()}};var Tn=class{constructor(e,t){this.preloadPromise=null,this.syncCleanupFn=null,this.syncLoadSubsetFn=null,this.pendingLoadSubsetPromises=new Set,this.config=e,this.id=t,this.syncMode=e.syncMode??"eager"}setDeps(e){this.collection=e.collection,this.state=e.state,this.lifecycle=e.lifecycle,this._events=e.events}startSync(){if(!(this.lifecycle.status!=="idle"&&this.lifecycle.status!=="cleaned-up")){this.lifecycle.setStatus("loading");try{let e=ja(this.config.sync.sync({collection:this.collection,begin:()=>{this.state.pendingSyncedTransactions.push({committed:!1,operations:[],deletedKeys:new Set})},write:t=>{let n=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!n)throw new Ke;if(n.committed)throw new Ee;let i=this.config.getKey(t.value),s=t.type;if(t.type==="insert"){let a=this.state.syncedData.has(i),c=n.deletedKeys.has(i),l=n.truncate===!0;if(a&&!c&&!l){let f=this.state.syncedData.get(i);if(f!==void 0&&Y(f,t.value))s="update";else throw new it(i,this.id)}}let o={...t,type:s,key:i};n.operations.push(o),s==="delete"&&n.deletedKeys.add(i)},commit:()=>{let t=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!t)throw new Tt;if(t.committed)throw new wt;t.committed=!0,this.state.commitPendingTransactions()},markReady:()=>{this.lifecycle.markReady()},truncate:()=>{let t=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!t)throw new Ke;if(t.committed)throw new Ee;t.operations=[],t.deletedKeys.clear(),t.truncate=!0,t.optimisticSnapshot={upserts:new Map(this.state.optimisticUpserts),deletes:new Set(this.state.optimisticDeletes)}}}));if(this.syncCleanupFn=e?.cleanup??null,this.syncLoadSubsetFn=e?.loadSubset??null,this.syncMode==="on-demand"&&!this.syncLoadSubsetFn)throw new ce(`Collection "${this.id}" is configured with syncMode "on-demand" but the sync function did not return a loadSubset handler. Either provide a loadSubset handler or use syncMode "eager".`)}catch(e){throw this.lifecycle.setStatus("error"),e}}}preload(){return this.preloadPromise?this.preloadPromise:(this.preloadPromise=new Promise((e,t)=>{if(this.lifecycle.status==="ready"){e();return}if(this.lifecycle.status==="error"){t(new et);return}if(this.lifecycle.onFirstReady(()=>{e()}),this.lifecycle.status==="idle"||this.lifecycle.status==="cleaned-up")try{this.startSync()}catch(n){t(n);return}}),this.preloadPromise)}get isLoadingSubset(){return this.pendingLoadSubsetPromises.size>0}trackLoadPromise(e){let t=!this.isLoadingSubset;this.pendingLoadSubsetPromises.add(e),t&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!0,previousIsLoadingSubset:!1,loadingSubsetTransition:"start"}),e.finally(()=>{let n=this.pendingLoadSubsetPromises.size===1&&this.pendingLoadSubsetPromises.has(e);this.pendingLoadSubsetPromises.delete(e),n&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!1,previousIsLoadingSubset:!0,loadingSubsetTransition:"end"})})}loadSubset(e){if(this.syncMode==="eager")return!0;if(this.syncLoadSubsetFn){let t=this.syncLoadSubsetFn(e);if(t instanceof Promise)return this.trackLoadPromise(t),t}return!0}cleanup(){try{this.syncCleanupFn&&(this.syncCleanupFn(),this.syncCleanupFn=null)}catch(e){queueMicrotask(()=>{if(e instanceof Error){let t=new Ae(this.id,e);throw t.cause=e,t.stack=e.stack,t}else throw new Ae(this.id,e)})}this.preloadPromise=null}};function ja(r){if(typeof r=="function")return{cleanup:r};if(typeof r=="object")return r}function Ks(r){return typeof r=="function"&&r.prototype!==void 0&&r.prototype.constructor===r}async function za(r){return Ks(r)?r:await r()}var sr=class{constructor(e,t,n,i,s,o){this.id=e,this.expression=t,this.name=n,this.resolver=i,this.options=s,this.collectionEntries=o,this.indexPromise=null,this.resolvedIndex=null,Ks(this.resolver)&&(this.resolvedIndex=new this.resolver(this.id,this.expression,this.name,this.options),this.collectionEntries&&this.resolvedIndex.build(this.collectionEntries))}async resolve(){return this.resolvedIndex?this.resolvedIndex:(this.indexPromise||(this.indexPromise=this.createIndex()),this.resolvedIndex=await this.indexPromise,this.resolvedIndex)}isResolved(){return this.resolvedIndex!==null}getResolved(){if(!this.resolvedIndex)throw new Error(`Index ${this.id} has not been resolved yet. Ensure collection is synced.`);return this.resolvedIndex}getId(){return this.id}getName(){return this.name}getExpression(){return this.expression}async createIndex(){let e=await za(this.resolver);return new e(this.id,this.expression,this.name,this.options)}},or=class{constructor(e,t){this.indexId=e,this.lazyIndex=t}get index(){return this.lazyIndex.getResolved()}get isReady(){return this.lazyIndex.isResolved()}async whenReady(){return await this.lazyIndex.resolve()}get id(){return this.indexId}get name(){return this.isReady?this.index.name:this.lazyIndex.getName()}get expression(){return this.lazyIndex.getExpression()}supports(e){return this.index.supports(e)}getStats(){return this.index.getStats()}matchesField(e){let t=this.expression;return t.type==="ref"&&t.path.length===e.length&&t.path.every((n,i)=>n===e[i])}get keyCount(){return this.index.keyCount}get indexedKeysSet(){return this.index.indexedKeysSet}get orderedEntriesArray(){return this.index.orderedEntriesArray}get valueMapData(){return this.index.valueMapData}equalityLookup(e){return this.index.equalityLookup?.(e)??new Set}rangeQuery(e){return this.index.rangeQuery?.(e)??new Set}inArrayLookup(e){return this.index.inArrayLookup?.(e)??new Set}_getLazyWrapper(){return this.lazyIndex}};var wn=class{constructor(){this.lazyIndexes=new Map,this.resolvedIndexes=new Map,this.isIndexesResolved=!1,this.indexCounter=0}setDeps(e){this.state=e.state,this.lifecycle=e.lifecycle}createIndex(e,t={}){this.lifecycle.validateCollectionUsable("createIndex");let n=++this.indexCounter,i=rs(),s=e(i),o=b(s),a=t.indexType??me,c=new sr(n,o,t.name,a,t.options,this.state.entries());if(this.lazyIndexes.set(n,c),a===me)try{let l=c.getResolved();this.resolvedIndexes.set(n,l)}catch(l){console.warn("Failed to resolve BTreeIndex:",l)}else if(typeof a=="function"&&a.prototype)try{let l=c.getResolved();this.resolvedIndexes.set(n,l)}catch{this.resolveSingleIndex(n,c).catch(l=>{console.warn("Failed to resolve single index:",l)})}else this.isIndexesResolved&&this.resolveSingleIndex(n,c).catch(l=>{console.warn("Failed to resolve single index:",l)});return new or(n,c)}async resolveAllIndexes(){if(this.isIndexesResolved)return;let e=Array.from(this.lazyIndexes.entries()).map(async([t,n])=>{let i=await n.resolve();return i.build(this.state.entries()),this.resolvedIndexes.set(t,i),{indexId:t,resolvedIndex:i}});await Promise.all(e),this.isIndexesResolved=!0}async resolveSingleIndex(e,t){let n=await t.resolve();return n.build(this.state.entries()),this.resolvedIndexes.set(e,n),n}get indexes(){return this.resolvedIndexes}updateIndexes(e){for(let t of this.resolvedIndexes.values())for(let n of e)switch(n.type){case"insert":t.add(n.key,n.value);break;case"update":n.previousValue?t.update(n.key,n.previousValue,n.value):t.add(n.key,n.value);break;case"delete":t.remove(n.key,n.value);break}}cleanup(){this.lazyIndexes.clear(),this.resolvedIndexes.clear()}};function M(...r){let e=typeof window<"u"&&typeof localStorage<"u";e&&localStorage.getItem("DEBUG")==="true"?console.log("[proxy]",...r):!e&&typeof process<"u"&&process.env.DEBUG==="true"&&console.log("[proxy]",...r)}function ye(r,e=new WeakMap){if(r==null||typeof r!="object")return r;if(e.has(r))return e.get(r);if(r instanceof Date)return new Date(r.getTime());if(r instanceof RegExp)return new RegExp(r.source,r.flags);if(Array.isArray(r)){let i=[];return e.set(r,i),r.forEach((s,o)=>{i[o]=ye(s,e)}),i}if(ArrayBuffer.isView(r)&&!(r instanceof DataView)){let i=Object.getPrototypeOf(r).constructor,s=new i(r.length);e.set(r,s);for(let o=0;o<r.length;o++)s[o]=r[o];return s}if(r instanceof Map){let i=new Map;return e.set(r,i),r.forEach((s,o)=>{i.set(o,ye(s,e))}),i}if(r instanceof Set){let i=new Set;return e.set(r,i),r.forEach(s=>{i.add(ye(s,e))}),i}if(Pr(r))return r;let t={};e.set(r,t);for(let i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=ye(r[i],e));let n=Object.getOwnPropertySymbols(r);for(let i of n)t[i]=ye(r[i],e);return t}var Es=0;function Na(){return Es+=1,Es}function Cr(r,e){let t=new Map;function n(u,d){if(M("Object ID:",u.constructor.name),t.has(u))return t.get(u);{let p=Cr(u,d);return t.set(u,p),p}}let i=new Map,s={copy_:ye(r),originalObject:ye(r),proxyCount:Na(),modified:!1,assigned_:{},parent:e,target:r};M("createChangeProxy called for target",r,s.proxyCount);function o(u){u.modified||(u.modified=!0),u.parent&&(M("propagating change to parent"),"updateMap"in u.parent?u.parent.updateMap(u.copy_):"updateSet"in u.parent?u.parent.updateSet(u.copy_):(u.parent.tracker.copy_[u.parent.prop]=u.copy_,u.parent.tracker.assigned_[u.parent.prop]=!0),o(u.parent.tracker))}function a(u){if(M("checkIfReverted called with assigned keys:",Object.keys(u.assigned_)),Object.keys(u.assigned_).length===0&&Object.getOwnPropertySymbols(u.assigned_).length===0)return M("No assigned properties, returning true"),!0;for(let p in u.assigned_)if(u.assigned_[p]===!0){let h=u.copy_[p],m=u.originalObject[p];if(M(`Checking property ${String(p)}, current:`,h,"original:",m),!Y(h,m))return M(`Property ${String(p)} is different, returning false`),!1}else if(u.assigned_[p]===!1)return M(`Property ${String(p)} was deleted, returning false`),!1;let d=Object.getOwnPropertySymbols(u.assigned_);for(let p of d)if(u.assigned_[p]===!0){let h=u.copy_[p],m=u.originalObject[p];if(!Y(h,m))return M("Symbol property is different, returning false"),!1}else if(u.assigned_[p]===!1)return M("Symbol property was deleted, returning false"),!1;return M("All properties match original values, returning true"),!0}function c(u,d){M("checkParentStatus called for child prop:",d);let p=a(u);M("Parent checkIfReverted returned:",p),p&&(M("Parent is fully reverted, clearing tracking"),u.modified=!1,u.assigned_={},u.parent&&(M("Continuing up the parent chain"),c(u.parent.tracker,u.parent.prop)))}function l(u){if(M("createObjectProxy",u),i.has(u))return M("proxyCache found match"),i.get(u);let d=new Proxy(u,{get(p,h){M("get",p,h);let m=s.copy_[h]??s.originalObject[h],y=s.originalObject[h];if(M("value (at top of proxy get)",m),Object.getOwnPropertyDescriptor(p,h)?.get)return m;if(typeof m=="function"){if(Array.isArray(p)){let g=h.toString();if(new Set(["pop","push","shift","unshift","splice","sort","reverse","fill","copyWithin"]).has(g))return function(...O){let E=m.apply(s.copy_,O);return o(s),E}}if(p instanceof Map||p instanceof Set){let g=h.toString();if(new Set(["set","delete","clear","add","pop","push","shift","unshift","splice","sort","reverse"]).has(g))return function(...E){let V=m.apply(s.copy_,E);return o(s),V};if(new Set(["entries","keys","values","forEach",Symbol.iterator]).has(g)||h===Symbol.iterator)return function(...E){let V=m.apply(s.copy_,E);if(g==="forEach"){let I=E[0];if(typeof I=="function"){let x=function(T,w,P){let L=I.call(this,T,w,P);return o(s),L};return m.apply(p,[x,...E.slice(1)])}}if(g==="entries"||g==="values"||g===Symbol.iterator.toString()||h===Symbol.iterator){let I=V,x=new Map;if(g==="values"&&p instanceof Map)for(let[w,P]of s.copy_.entries())x.set(P,w);let T=new Map;if(p instanceof Set)for(let w of s.copy_.values())T.set(w,w);return{next(){let w=I.next();if(!w.done&&w.value&&typeof w.value=="object"){if(g==="entries"&&Array.isArray(w.value)&&w.value.length===2){if(w.value[1]&&typeof w.value[1]=="object"){let P=w.value[0],L={tracker:s,prop:P,updateMap:ae=>{s.copy_ instanceof Map&&s.copy_.set(P,ae)}},{proxy:de}=n(w.value[1],L);w.value[1]=de}}else if((g==="values"||g===Symbol.iterator.toString()||h===Symbol.iterator)&&typeof w.value=="object"&&w.value!==null)if(g==="values"&&p instanceof Map){let P=x.get(w.value);if(P!==void 0){let L={tracker:s,prop:P,updateMap:ae=>{s.copy_ instanceof Map&&s.copy_.set(P,ae)}},{proxy:de}=n(w.value,L);w.value=de}}else if(p instanceof Set){let P=w.value,L={tracker:s,prop:P,updateSet:ae=>{s.copy_ instanceof Set&&(s.copy_.delete(P),s.copy_.add(ae),T.set(P,ae))}},{proxy:de}=n(w.value,L);w.value=de}else{let P=Symbol("iterator-value"),{proxy:L}=n(w.value,{tracker:s,prop:P});w.value=L}}return w},[Symbol.iterator](){return this}}}return V}}return m.bind(p)}if(m&&typeof m=="object"&&!(m instanceof Date)&&!(m instanceof RegExp)&&!Pr(m)){let g={tracker:s,prop:String(h)},{proxy:S}=n(y,g);return i.set(m,S),S}return m},set(p,h,m){let y=s.copy_[h];if(M(`set called for property ${String(h)}, current:`,y,"new:",m),Y(y,m))M("Value unchanged, not tracking");else{let v=s.originalObject[h],g=Y(m,v);if(M("value:",m,"original:",v,"isRevertToOriginal:",g),g){M(`Reverting property ${String(h)} to original value`),delete s.assigned_[h.toString()],M(`Updating copy with original value for ${String(h)}`),s.copy_[h]=ye(v),M("Checking if all properties reverted");let S=a(s);M("All reverted:",S),S?(M("All properties reverted, clearing tracking"),s.modified=!1,s.assigned_={},e&&(M("Updating parent for property:",e.prop),c(e.tracker,e.prop))):(M("Some properties still changed, keeping modified flag"),s.modified=!0)}else M(`Setting new value for property ${String(h)}`),s.copy_[h]=m,s.assigned_[h.toString()]=!0,M("Marking object and ancestors as modified",s),o(s)}return!0},defineProperty(p,h,m){return"value"in m&&(s.copy_[h]=ye(m.value),s.assigned_[h.toString()]=!0,o(s)),!0},deleteProperty(p,h){M("deleteProperty",p,h);let m=typeof h=="symbol"?h.toString():h;if(m in p){let y=m in s.originalObject;delete s.copy_[h],y?(s.assigned_[m]=!1,s.copy_[m]=void 0,o(s)):(delete s.copy_[m],delete s.assigned_[m],Object.keys(s.assigned_).length===0&&Object.getOwnPropertySymbols(s.assigned_).length===0?s.modified=!1:s.modified=!0)}return!0}});return i.set(u,d),d}return{proxy:l(r),getChanges:()=>{if(M("getChanges called, modified:",s.modified),M(s),!s.modified)return M("Object not modified, returning empty object"),{};if(typeof s.copy_!="object"||Array.isArray(s.copy_)||Object.keys(s.assigned_).length===0)return s.copy_;let u={};for(let d in s.copy_)s.assigned_[d]===!0&&d in s.copy_&&(u[d]=s.copy_[d]);return M("Returning copy:",u),u}}}function hi(r){let e=r.map(t=>Cr(t));return{proxies:e.map(t=>t.proxy),getChanges:()=>e.map(t=>t.getChanges())}}function xn(r,e){let{proxy:t,getChanges:n}=Cr(r);return e(t),n()}function vn(r,e){let{proxies:t,getChanges:n}=hi(r);return e(t),n()}function Rs(){let r,e,t=!0;return{promise:new Promise((i,s)=>{r=o=>{t=!1,i(o)},e=o=>{t=!1,s(o)}}),resolve:r,reject:e,isPending:()=>t}}var mi=class{constructor(){this.contexts=new Map,this.clearListeners=new Set}getOrCreateContext(e){let t=this.contexts.get(e);return t||(t={queue:[],jobs:new Map,dependencies:new Map,completed:new Set},this.contexts.set(e,t)),t}schedule({contextId:e,jobId:t,dependencies:n,run:i}){if(typeof e>"u"){i();return}let s=this.getOrCreateContext(e);if(s.jobs.has(t)||s.queue.push(t),s.jobs.set(t,i),n){let o=new Set(n);o.delete(t),s.dependencies.set(t,o)}else s.dependencies.has(t)||s.dependencies.set(t,new Set);s.completed.delete(t)}flush(e){let t=this.contexts.get(e);if(!t)return;let{queue:n,jobs:i,dependencies:s,completed:o}=t;for(;n.length>0;){let a=!1,c=n.length;for(let l=0;l<c;l++){let f=n.shift(),u=i.get(f);if(!u){s.delete(f),o.delete(f);continue}let d=s.get(f),p=!d;if(d){p=!0;for(let h of d)if(h!==f&&!o.has(h)){p=!1;break}}p?(i.delete(f),s.delete(f),u(),o.add(f),a=!0):n.push(f)}if(!a)throw new Error(`Scheduler detected unresolved dependencies for context ${String(e)}.`)}this.contexts.delete(e)}flushAll(){for(let e of Array.from(this.contexts.keys()))this.flush(e)}clear(e){this.contexts.delete(e),this.clearListeners.forEach(t=>t(e))}onClear(e){return this.clearListeners.add(e),()=>this.clearListeners.delete(e)}hasPendingJobs(e){let t=this.contexts.get(e);return!!t&&t.jobs.size>0}clearJob(e,t){let n=this.contexts.get(e);n&&(n.jobs.delete(t),n.dependencies.delete(t),n.completed.delete(t),n.queue=n.queue.filter(i=>i!==t),n.jobs.size===0&&this.contexts.delete(e))}},ar=new mi;var Sn=[],Kr=[],Wa=0;function La(r,e){switch(`${r.type}-${e.type}`){case"insert-update":return{...r,type:"insert",original:{},modified:e.modified,changes:{...r.changes,...e.changes},key:r.key,globalKey:r.globalKey,metadata:e.metadata??r.metadata,syncMetadata:{...r.syncMetadata,...e.syncMetadata},mutationId:e.mutationId,updatedAt:e.updatedAt};case"insert-delete":return null;case"update-delete":return e;case"update-update":return{...e,original:r.original,changes:{...r.changes,...e.changes},metadata:e.metadata??r.metadata,syncMetadata:{...r.syncMetadata,...e.syncMetadata}};case"delete-delete":case"insert-insert":return e;default:{let t=`${r.type}-${e.type}`;throw new Error(`Unhandled mutation combination: ${t}`)}}}function ge(r){let e=new yi(r);return Sn.push(e),e}function ve(){if(Kr.length>0)return Kr.slice(-1)[0]}function Ua(r){ar.clear(r.id),Kr.push(r)}function $a(r){try{ar.flush(r.id)}finally{Kr=Kr.filter(e=>e.id!==r.id)}}function Ha(r){let e=Sn.findIndex(t=>t.id===r.id);e!==-1&&Sn.splice(e,1)}var yi=class{constructor(e){if(typeof e.mutationFn>"u")throw new ht;this.id=e.id??crypto.randomUUID(),this.mutationFn=e.mutationFn,this.state="pending",this.mutations=[],this.isPersisted=Rs(),this.autoCommit=e.autoCommit??!0,this.createdAt=new Date,this.sequenceNumber=Wa++,this.metadata=e.metadata??{}}setState(e){this.state=e,(e==="completed"||e==="failed")&&Ha(this)}mutate(e){if(this.state!=="pending")throw new mt;Ua(this);try{e()}finally{$a(this)}return this.autoCommit&&this.commit().catch(()=>{}),this}applyMutations(e){for(let t of e){let n=this.mutations.findIndex(i=>i.globalKey===t.globalKey);if(n>=0){let i=this.mutations[n],s=La(i,t);s===null?this.mutations.splice(n,1):this.mutations[n]=s}else this.mutations.push(t)}}rollback(e){let t=e?.isSecondaryRollback??!1;if(this.state==="completed")throw new yt;if(this.setState("failed"),!t){let n=new Set;this.mutations.forEach(i=>n.add(i.globalKey));for(let i of Sn)i.state==="pending"&&i.mutations.some(s=>n.has(s.globalKey))&&i.rollback({isSecondaryRollback:!0})}return this.isPersisted.reject(this.error?.error),this.touchCollection(),this}touchCollection(){let e=new Set;for(let t of this.mutations)e.has(t.collection.id)||(t.collection._state.onTransactionStateChange(),t.collection._state.pendingSyncedTransactions.length>0&&t.collection._state.commitPendingTransactions(),e.add(t.collection.id))}async commit(){if(this.state!=="pending")throw new gt;if(this.setState("persisting"),this.mutations.length===0)return this.setState("completed"),this.isPersisted.resolve(this),this;try{await this.mutationFn({transaction:this}),this.setState("completed"),this.touchCollection(),this.isPersisted.resolve(this)}catch(e){let t=e instanceof Error?e:new Error(String(e));throw this.error={message:t.message,error:t},this.rollback(),t}return this}compareCreatedAt(e){let t=this.createdAt.getTime()-e.createdAt.getTime();return t!==0?t:this.sequenceNumber-e.sequenceNumber}};var bn=class{constructor(e,t){this.insert=(n,i)=>{this.lifecycle.validateCollectionUsable("insert");let s=this.state,o=ve();if(!o&&!this.config.onInsert)throw new ft;let a=Array.isArray(n)?n:[n],c=[];if(a.forEach(l=>{let f=this.validateData(l,"insert"),u=this.config.getKey(f);if(this.state.has(u))throw new nt(u);let d=this.generateGlobalKey(u,l),p={mutationId:crypto.randomUUID(),original:{},modified:f,changes:Object.fromEntries(Object.keys(l).map(h=>[h,f[h]])),globalKey:d,key:u,metadata:i?.metadata,syncMetadata:this.config.sync.getSyncMetadata?.()||{},optimistic:i?.optimistic??!0,type:"insert",createdAt:new Date,updatedAt:new Date,collection:this.collection};c.push(p)}),o)return o.applyMutations(c),s.transactions.set(o.id,o),s.scheduleTransactionCleanup(o),s.recomputeOptimisticState(!0),o;{let l=ge({mutationFn:async f=>await this.config.onInsert({transaction:f.transaction,collection:this.collection})});return l.applyMutations(c),l.commit().catch(()=>{}),s.transactions.set(l.id,l),s.scheduleTransactionCleanup(l),s.recomputeOptimisticState(!0),l}},this.delete=(n,i)=>{let s=this.state;this.lifecycle.validateCollectionUsable("delete");let o=ve();if(!o&&!this.config.onDelete)throw new dt;if(Array.isArray(n)&&n.length===0)throw new lt;let a=Array.isArray(n)?n:[n],c=[];for(let f of a){if(!this.state.has(f))throw new ut(f);let u=this.generateGlobalKey(f,this.state.get(f)),d={mutationId:crypto.randomUUID(),original:this.state.get(f),modified:this.state.get(f),changes:this.state.get(f),globalKey:u,key:f,metadata:i?.metadata,syncMetadata:s.syncedMetadata.get(f)||{},optimistic:i?.optimistic??!0,type:"delete",createdAt:new Date,updatedAt:new Date,collection:this.collection};c.push(d)}if(o)return o.applyMutations(c),s.transactions.set(o.id,o),s.scheduleTransactionCleanup(o),s.recomputeOptimisticState(!0),o;let l=ge({autoCommit:!0,mutationFn:async f=>this.config.onDelete({transaction:f.transaction,collection:this.collection})});return l.applyMutations(c),l.commit().catch(()=>{}),s.transactions.set(l.id,l),s.scheduleTransactionCleanup(l),s.recomputeOptimisticState(!0),l},this.id=t,this.config=e}setDeps(e){this.lifecycle=e.lifecycle,this.state=e.state,this.collection=e.collection}ensureStandardSchema(e){if(e&&"~standard"in e)return e;throw new Ye}validateData(e,t,n){if(!this.config.schema)return e;let i=this.ensureStandardSchema(this.config.schema);if(t==="update"&&n){let o=this.state.get(n);if(o&&e&&typeof e=="object"&&typeof o=="object"){let a=Object.assign({},o,e),c=i["~standard"].validate(a);if(c instanceof Promise)throw new ke;if("issues"in c&&c.issues){let d=c.issues.map(p=>({message:p.message,path:p.path?.map(h=>String(h))}));throw new Pe(t,d)}let l=c.value,f=Object.keys(e);return Object.fromEntries(f.map(d=>[d,l[d]]))}}let s=i["~standard"].validate(e);if(s instanceof Promise)throw new ke;if("issues"in s&&s.issues){let o=s.issues.map(a=>({message:a.message,path:a.path?.map(c=>String(c))}));throw new Pe(t,o)}return s.value}generateGlobalKey(e,t){if(typeof e>"u")throw new rt(t);return`KEY::${this.id}/${e}`}update(e,t,n){if(typeof e>"u")throw new st;let i=this.state;this.lifecycle.validateCollectionUsable("update");let s=ve();if(!s&&!this.config.onUpdate)throw new pt;let o=Array.isArray(e),a=o?e:[e];if(o&&a.length===0)throw new ot;let c=typeof t=="function"?t:n,l=typeof t=="function"?{}:t,f=a.map(h=>{let m=this.state.get(h);if(!m)throw new at(h);return m}),u;o?u=vn(f,c):u=[xn(f[0],c)];let d=a.map((h,m)=>{let y=u[m];if(!y||Object.keys(y).length===0)return null;let v=f[m],g=this.validateData(y,"update",h),S=Object.assign({},v,g),O=this.config.getKey(v),E=this.config.getKey(S);if(O!==E)throw new ct(O,E);let V=this.generateGlobalKey(E,S);return{mutationId:crypto.randomUUID(),original:v,modified:S,changes:Object.fromEntries(Object.keys(y).map(I=>[I,S[I]])),globalKey:V,key:h,metadata:l.metadata,syncMetadata:i.syncedMetadata.get(h)||{},optimistic:l.optimistic??!0,type:"update",createdAt:new Date,updatedAt:new Date,collection:this.collection}}).filter(Boolean);if(d.length===0){let h=ge({mutationFn:async()=>{}});return h.commit().catch(()=>{}),i.scheduleTransactionCleanup(h),h}if(s)return s.applyMutations(d),i.transactions.set(s.id,s),i.scheduleTransactionCleanup(s),i.recomputeOptimisticState(!0),s;let p=ge({mutationFn:async h=>this.config.onUpdate({transaction:h.transaction,collection:this.collection})});return p.applyMutations(d),p.commit().catch(()=>{}),i.transactions.set(p.id,p),i.scheduleTransactionCleanup(p),i.recomputeOptimisticState(!0),p}};var On=class extends ir{constructor(){super()}setDeps(e){this.collection=e.collection}emit(e,t){this.emitInner(e,t)}emitStatusChange(e,t){this.emit("status:change",{type:"status:change",collection:this.collection,previousStatus:t,status:e});let n=`status:${e}`;this.emit(n,{type:n,collection:this.collection,previousStatus:t,status:e})}emitSubscribersChange(e,t){this.emit("subscribers:change",{type:"subscribers:change",collection:this.collection,previousSubscriberCount:t,subscriberCount:e})}cleanup(){this.clearListeners()}};function In(r){let e=new ze(r);return r.utils?e.utils={...r.utils}:e.utils={},e}var ze=class{constructor(e){if(this.utils={},this.insert=(t,n)=>this._mutations.insert(t,n),this.delete=(t,n)=>this._mutations.delete(t,n),!e)throw new Ge;if(!e.sync)throw new Qe;e.id?this.id=e.id:this.id=crypto.randomUUID(),this.config={...e,autoIndex:e.autoIndex??"eager"},this._changes=new mn,this._events=new On,this._indexes=new wn,this._lifecycle=new gn(e,this.id),this._mutations=new bn(e,this.id),this._state=new dn(e),this._sync=new Tn(e,this.id),this._changes.setDeps({collection:this,lifecycle:this._lifecycle,sync:this._sync,events:this._events}),this._events.setDeps({collection:this}),this._indexes.setDeps({state:this._state,lifecycle:this._lifecycle}),this._lifecycle.setDeps({changes:this._changes,events:this._events,indexes:this._indexes,state:this._state,sync:this._sync}),this._mutations.setDeps({collection:this,lifecycle:this._lifecycle,state:this._state}),this._state.setDeps({collection:this,lifecycle:this._lifecycle,changes:this._changes,indexes:this._indexes}),this._sync.setDeps({collection:this,state:this._state,lifecycle:this._lifecycle,events:this._events}),e.startSync===!0&&this._sync.startSync()}get status(){return this._lifecycle.status}get subscriberCount(){return this._changes.activeSubscribersCount}onFirstReady(e){return this._lifecycle.onFirstReady(e)}isReady(){return this._lifecycle.status==="ready"}get isLoadingSubset(){return this._sync.isLoadingSubset}startSyncImmediate(){this._sync.startSync()}preload(){return this._sync.preload()}get(e){return this._state.get(e)}has(e){return this._state.has(e)}get size(){return this._state.size}*keys(){yield*this._state.keys()}*values(){yield*this._state.values()}*entries(){yield*this._state.entries()}*[Symbol.iterator](){yield*this._state[Symbol.iterator]()}forEach(e){return this._state.forEach(e)}map(e){return this._state.map(e)}getKeyFromItem(e){return this.config.getKey(e)}createIndex(e,t={}){return this._indexes.createIndex(e,t)}get indexes(){return this._indexes.indexes}validateData(e,t,n){return this._mutations.validateData(e,t,n)}update(e,t,n){return this._mutations.update(e,t,n)}get state(){let e=new Map;for(let[t,n]of this.entries())e.set(t,n);return e}stateWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.state):this.preload().then(()=>this.state)}get toArray(){return Array.from(this.values())}toArrayWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.toArray):this.preload().then(()=>this.toArray)}currentStateAsChanges(e={}){return Ps(this,e)}subscribeChanges(e,t={}){return this._changes.subscribeChanges(e,t)}on(e,t){return this._events.on(e,t)}once(e,t){return this._events.once(e,t)}off(e,t){this._events.off(e,t)}waitFor(e,t){return this._events.waitFor(e,t)}async cleanup(){return this._lifecycle.cleanup(),Promise.resolve()}};function _s(r){let{mutationFn:e,onMutate:t,...n}=r;return i=>{let s=ge({...n,mutationFn:async o=>await e(i,o)});return s.mutate(()=>{t(i)}),s}}function As(r){let{initialData:e,onInsert:t,onUpdate:n,onDelete:i,...s}=r,o=Ja(e),a=async u=>{let d;return t&&(d=await t(u)??{}),o.confirmOperationsSync(u.transaction.mutations),d},c=async u=>{let d;return n&&(d=await n(u)??{}),o.confirmOperationsSync(u.transaction.mutations),d},l=async u=>{let d;return i&&(d=await i(u)??{}),o.confirmOperationsSync(u.transaction.mutations),d},f=u=>{let d=u.mutations.filter(p=>p.collection===o.collection);d.length!==0&&o.confirmOperationsSync(d)};return{...s,sync:o.sync,onInsert:a,onUpdate:c,onDelete:l,utils:{acceptMutations:f},startSync:!0,gcTime:0}}function Ja(r){let e=null,t=null,n=null,i=null;return{sync:{sync:a=>{let{begin:c,write:l,commit:f,markReady:u}=a;return e=c,t=l,n=f,i=a.collection,r&&r.length>0&&(c(),r.forEach(d=>{l({type:"insert",value:d})}),f()),u(),()=>{}},getSyncMetadata:()=>({})},confirmOperationsSync:a=>{!e||!t||!n||(e(),a.forEach(c=>{t&&t({type:c.type,value:c.modified})}),n())},collection:i}}function cr(r,e){try{JSON.stringify(r)}catch(t){throw new Ut(e,t instanceof Error?t.message:String(t))}}function gi(){return crypto.randomUUID()}function qa(){let r=new Map;return{getItem(e){return r.get(e)??null},setItem(e,t){r.set(e,t)},removeItem(e){r.delete(e)}}}function Ga(){return{addEventListener:()=>{},removeEventListener:()=>{}}}function Bs(r){if(!r.storageKey)throw new $t;let e=r.storage||(typeof window<"u"?window.localStorage:null)||qa(),t=r.storageEventApi||(typeof window<"u"?window:null)||Ga(),n=new Map,i=Qa(r.storageKey,e,t,r.getKey,n),s=()=>{i.manualTrigger&&i.manualTrigger()},o=V=>{try{let I={};V.forEach((T,w)=>{I[String(w)]=T});let x=JSON.stringify(I);e.setItem(r.storageKey,x)}catch(I){throw console.error(`[LocalStorageCollection] Error saving data to storage key "${r.storageKey}":`,I),I}},a=()=>{e.removeItem(r.storageKey)},c=()=>{let V=e.getItem(r.storageKey);return V?new Blob([V]).size:0},l=async V=>{V.transaction.mutations.forEach(T=>{cr(T.modified,"insert")});let I={};r.onInsert&&(I=await r.onInsert(V)??{});let x=lr(r.storageKey,e);return V.transaction.mutations.forEach(T=>{let w=r.getKey(T.modified),P={versionKey:gi(),data:T.modified};x.set(w,P)}),o(x),s(),I},f=async V=>{V.transaction.mutations.forEach(T=>{cr(T.modified,"update")});let I={};r.onUpdate&&(I=await r.onUpdate(V)??{});let x=lr(r.storageKey,e);return V.transaction.mutations.forEach(T=>{let w=r.getKey(T.modified),P={versionKey:gi(),data:T.modified};x.set(w,P)}),o(x),s(),I},u=async V=>{let I={};r.onDelete&&(I=await r.onDelete(V)??{});let x=lr(r.storageKey,e);return V.transaction.mutations.forEach(T=>{let w=r.getKey(T.original);x.delete(w)}),o(x),s(),I},{storageKey:d,storage:p,storageEventApi:h,onInsert:m,onUpdate:y,onDelete:v,id:g,...S}=r,O=g??`local-collection:${r.storageKey}`;return{...S,id:O,sync:i,onInsert:l,onUpdate:f,onDelete:u,utils:{clearStorage:a,getStorageSize:c,acceptMutations:V=>{let I=V.mutations.filter(T=>i.collection&&T.collection===i.collection?!0:T.collection.id===O);if(I.length===0)return;for(let T of I)switch(T.type){case"insert":case"update":cr(T.modified,T.type);break;case"delete":cr(T.original,T.type);break}let x=lr(r.storageKey,e);for(let T of I){let w=T.key;switch(T.type){case"insert":case"update":{let P={versionKey:gi(),data:T.modified};x.set(w,P);break}case"delete":{x.delete(w);break}}}o(x),i.confirmOperationsSync(I)}}}}function lr(r,e){try{let t=e.getItem(r);if(!t)return new Map;let n=JSON.parse(t),i=new Map;if(typeof n=="object"&&n!==null&&!Array.isArray(n))Object.entries(n).forEach(([s,o])=>{if(o&&typeof o=="object"&&"versionKey"in o&&"data"in o){let a=o;i.set(s,a)}else throw new Ht(r,s)});else throw new Jt(r);return i}catch(t){return console.warn(`[LocalStorageCollection] Error loading data from storage key "${r}":`,t),new Map}}function Qa(r,e,t,n,i){let s=null,o=null,a=(u,d)=>{let p=[];return u.forEach((h,m)=>{let y=d.get(m);y?h.versionKey!==y.versionKey&&p.push({type:"update",key:m,value:y.data}):p.push({type:"delete",key:m,value:h.data})}),d.forEach((h,m)=>{u.has(m)||p.push({type:"insert",key:m,value:h.data})}),p},c=()=>{if(!s)return;let{begin:u,write:d,commit:p}=s,h=lr(r,e),m=a(i,h);m.length>0&&(u(),m.forEach(({type:y,value:v})=>{v&&(cr(v,y),d({type:y,value:v}))}),p(),i.clear(),h.forEach((y,v)=>{i.set(v,y)}))};return{...{sync:u=>{let{begin:d,write:p,commit:h,markReady:m}=u;s=u,o=u.collection;let y=lr(r,e);y.size>0&&(d(),y.forEach(g=>{cr(g.data,"load"),p({type:"insert",value:g.data})}),h()),i.clear(),y.forEach((g,S)=>{i.set(S,g)}),m();let v=g=>{g.key!==r||g.storageArea!==e||c()};t.addEventListener("storage",v)},getSyncMetadata:()=>({storageKey:r,storageType:e===(typeof window<"u"?window.localStorage:null)?"localStorage":"custom"}),manualTrigger:c,collection:o},confirmOperationsSync:u=>{if(!s)return;let{begin:d,write:p,commit:h}=s;d(),u.forEach(m=>{p({type:m.type,value:m.type==="delete"?m.original:m.modified})}),h()}}}var ur=class r{constructor(e={}){this.query={},this.query={...e}}_createRefForSource(e,t){if(Object.keys(e).length!==1)throw new xt(t);let n=Object.keys(e)[0],i=e[n],s;if(i instanceof ze)s=new ne(i,n);else if(i instanceof r){let o=i._getQuery();if(!o.from)throw new vt(t);s=new U(o,n)}else throw new St(n);return[n,s]}from(e){let[,t]=this._createRefForSource(e,"from clause");return new r({...this.query,from:t})}join(e,t,n="left"){let[i,s]=this._createRefForSource(e,"join clause"),a=[...this._getCurrentAliases(),i],c=De(a),l=t(c),f,u;if(l.type==="func"&&l.name==="eq"&&l.args.length===2)f=l.args[0],u=l.args[1];else throw new bt;let d={from:s,type:n,left:f,right:u},p=this.query.join||[];return new r({...this.query,join:[...p,d]})}leftJoin(e,t){return this.join(e,t,"left")}rightJoin(e,t){return this.join(e,t,"right")}innerJoin(e,t){return this.join(e,t,"inner")}fullJoin(e,t){return this.join(e,t,"full")}where(e){let t=this._getCurrentAliases(),n=De(t),i=e(n),s=this.query.where||[];return new r({...this.query,where:[...s,i]})}having(e){let t=this._getCurrentAliases(),n=De(t),i=e(n),s=this.query.having||[];return new r({...this.query,having:[...s,i]})}select(e){let t=this._getCurrentAliases(),n=De(t),i=e(n),s=Ds(i);return new r({...this.query,select:s,fnSelect:void 0})}orderBy(e,t="asc"){let n=this._getCurrentAliases(),i=De(n),s=e(i),o=typeof t=="string"?{direction:t,nulls:"first",stringSort:"locale"}:{direction:t.direction??"asc",nulls:t.nulls??"first",stringSort:t.stringSort??"locale",locale:t.stringSort==="locale"?t.locale:void 0,localeOptions:t.stringSort==="locale"?t.localeOptions:void 0},a=f=>({expression:b(f),compareOptions:o}),c=Array.isArray(s)?s.map(f=>a(f)):[a(s)],l=this.query.orderBy||[];return new r({...this.query,orderBy:[...l,...c]})}groupBy(e){let t=this._getCurrentAliases(),n=De(t),i=e(n),s=Array.isArray(i)?i.map(a=>b(a)):[b(i)],o=this.query.groupBy||[];return new r({...this.query,groupBy:[...o,...s]})}limit(e){return new r({...this.query,limit:e})}offset(e){return new r({...this.query,offset:e})}distinct(){return new r({...this.query,distinct:!0})}findOne(){return new r({...this.query,singleResult:!0})}_getCurrentAliases(){let e=[];if(this.query.from&&e.push(this.query.from.alias),this.query.join)for(let t of this.query.join)e.push(t.from.alias);return e}get fn(){let e=this;return{select(t){return new r({...e.query,select:void 0,fnSelect:t})},where(t){return new r({...e.query,fnWhere:[...e.query.fnWhere||[],t]})},having(t){return new r({...e.query,fnHaving:[...e.query.fnHaving||[],t]})}}}_getQuery(){if(!this.query.from)throw new Ot;return this.query}};function Ya(r){return r===void 0?b(null):r instanceof te||r instanceof k||r instanceof R||r instanceof $?r:b(r)}function Xa(r){return r!==null&&typeof r=="object"&&!qe(r)&&!r.__refProxy}function Ds(r){if(!Xa(r))return Ya(r);let e={};for(let[t,n]of Object.entries(r)){if(typeof t=="string"&&t.startsWith("__SPREAD_SENTINEL__")){e[t]=n;continue}e[t]=Ds(n)}return e}function Fs(r){let e=r(new ur);return Ti(e)}function Ti(r){return r._getQuery()}var js=ur;var Vn=class extends Map{constructor(t,n){super(n);this.defaultValue=t}get(t){return this.has(t)?super.get(t):this.defaultValue()}update(t,n){let i=this.get(t),s=n(i);return this.set(t,s),s}},wi=3e4;function Pn(r,e){if(e.length<=wi)r.push(...e);else for(let t=0;t<e.length;t+=wi){let n=e.slice(t,t+wi);r.push(...n)}}function zs(r,e,t){let n=0,i=r.length;for(;n<i;){let s=Math.floor((n+i)/2),o=t(r[s],e);if(o<0)n=s+1;else if(o>0)i=s;else return s}return n}var xi=class{constructor(){this.objectIds=new WeakMap;this.nextId=0}getId(e){if(typeof e!="object"||e===null){let t=String(e),n=0;for(let i=0;i<t.length;i++){let s=t.charCodeAt(i);n=(n<<5)-n+s,n=n&n}return n}return this.objectIds.has(e)||this.objectIds.set(e,this.nextId++),this.objectIds.get(e)}getStringId(e){return e===null?"null":e===void 0?"undefined":typeof e!="object"?`str_${String(e)}`:`obj_${this.getId(e)}`}},fr=new xi;function Ns(r,e){let[t,n]=r,[i,s]=e,o=[...Mn(t,Math.min(n,i)),...Mn(Math.max(t,s),n)],a=[...Mn(i,Math.min(s,t)),...Mn(Math.max(i,n),s)];return{onlyInA:o,onlyInB:a}}function Mn(r,e){let t=[];for(let n=r;n<e;n++)t.push(n);return t}var Za=J(),ec=J(),tc=J(),rc=J(),nc=J();function J(){return Math.random()*(2**31-1)>>>0}var Ws=new ArrayBuffer(8),ic=new DataView(Ws),Se=new Uint8Array(Ws),pr=class{constructor(){this.hash=Za;this.length=0;this.carry=0;this.carryBytes=0}_mix(e){e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e,this.hash=this.hash<<13|this.hash>>>19,this.hash=Math.imul(this.hash,5)+3864292196}_writeByte(e){this.carry|=(e&255)<<8*this.carryBytes,this.carryBytes++,this.length++,this.carryBytes===4&&(this._mix(this.carry>>>0),this.carry=0,this.carryBytes=0)}update(e){switch(typeof e){case"symbol":{this.update(nc);let t=e.description;if(!t)return;for(let n=0;n<t.length;n++){let i=t.charCodeAt(n);this._writeByte(i&255),this._writeByte(i>>>8&255)}return}case"string":this.update(ec);for(let t=0;t<e.length;t++){let n=e.charCodeAt(t);this._writeByte(n&255),this._writeByte(n>>>8&255)}return;case"number":ic.setFloat64(0,e,!0),this._writeByte(Se[0]),this._writeByte(Se[1]),this._writeByte(Se[2]),this._writeByte(Se[3]),this._writeByte(Se[4]),this._writeByte(Se[5]),this._writeByte(Se[6]),this._writeByte(Se[7]);return;case"bigint":{let t=e;for(t<0n?(t=-t,this.update(rc)):this.update(tc);t>0n;)this._writeByte(Number(t&0xffn)),t>>=8n;e===0n&&this._writeByte(0);return}default:throw new TypeError(`Unsupported input type: ${typeof e}`)}}digest(){if(this.carryBytes>0){let e=this.carry>>>0;e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e}return this.hash^=this.length,this.hash^=this.hash>>>16,this.hash=Math.imul(this.hash,2246822507),this.hash^=this.hash>>>13,this.hash=Math.imul(this.hash,3266489909),this.hash^=this.hash>>>16,this.hash>>>0}};var sc=J(),oc=J(),ac=J(),cc=J(),lc=J(),uc=J(),fc=J(),pc=J(),dc=J(),hc=J(),mc=J(),Er=new WeakMap;function j(r){let e=new pr;return Us(e,r),e.digest()}function yc(r){let e=Er.get(r);if(e!==void 0)return e;let t;if(r instanceof Date)t=gc(r);else{let n=r,i=pc;if(r instanceof Array&&(i=dc),r instanceof Map&&(i=hc,n=[...r.entries()]),r instanceof Set&&(i=mc,n=[...r.entries()]),typeof Buffer<"u"&&r instanceof Buffer||r instanceof Uint8Array||r instanceof File)return $s(r);t=Tc(n,i)}return Er.set(r,t),t}function gc(r){let e=new pr;return e.update(fc),e.update(r.getTime()),e.digest()}function Tc(r,e){let t=new pr;t.update(e);let n=Object.keys(r);n.sort(xc);for(let i of n)t.update(lc),t.update(i),Us(t,r[i]);return t.digest()}function Us(r,e){if(e===null){r.update(ac);return}switch(typeof e){case"undefined":r.update(cc);return;case"boolean":r.update(e?sc:oc);return;case"number":r.update(isNaN(e)?NaN:e===0?0:e);return;case"bigint":case"string":case"symbol":r.update(e);return;case"object":r.update(wc(e));return;case"function":r.update($s(e));return;default:console.warn(`Ignored input during hashing because it is of type ${typeof e} which is not supported`)}}function wc(r){let e=Er.get(r);return e===void 0&&(e=yc(r)),e}var Ls=1;function $s(r){let e=Er.get(r);return e===void 0&&(e=Ls^uc,Ls++,Er.set(r,e)),e}function xc(r,e){return r.localeCompare(e)}var D=class r{#e;constructor(e=[]){this.#e=e}toString(e=!1){return`MultiSet(${JSON.stringify(this.#e,null,e?2:void 0)})`}toJSON(){return JSON.stringify(Array.from(this.getInner()))}static fromJSON(e){return new r(JSON.parse(e))}map(e){return new r(this.#e.map(([t,n])=>[e(t),n]))}filter(e){return new r(this.#e.filter(([t,n])=>e(t)))}negate(){return new r(this.#e.map(([e,t])=>[e,-t]))}concat(e){let t=[];return Pn(t,this.#e),Pn(t,e.getInner()),new r(t)}consolidate(){if(this.#e.length>0){let e=this.#e[0]?.[0];if(Array.isArray(e)&&e.length===2)return this.#t()}return this.#r()}#t(){let e=new Map,t=new Map,n=s=>{if(s.length!==2)throw new Error("Expected tuple of length 2");let[o,a]=s;return`${fr.getStringId(o)}|${fr.getStringId(a)}`};for(let[s,o]of this.#e){if(!Array.isArray(s)||s.length!==2)return this.#r();let[a,c]=s;if(typeof a!="string"&&typeof a!="number")return this.#r();let l;Array.isArray(c)&&c.length===2?l=n(c):l=fr.getStringId(c);let f=a+"|"+l;e.set(f,(e.get(f)||0)+o),t.has(f)||t.set(f,s)}let i=[];for(let[s,o]of e)o!==0&&i.push([t.get(s),o]);return new r(i)}#r(){let e=new Vn(()=>0),t=new Map,n=!1,i=!1,s=!1;for(let[c,l]of this.#e)if(typeof c=="string")n=!0;else if(typeof c=="number")i=!0;else{s=!0;break}let o=s||n&&i;for(let[c,l]of this.#e){let f=o?j(c):c;o&&!t.has(f)&&t.set(f,c),e.update(f,u=>u+l)}let a=[];for(let[c,l]of e.entries())if(l!==0){let f=o?t.get(c):c;a.push([f,l])}return new r(a)}extend(e){let t=e instanceof r?e.getInner():e;Pn(this.#e,t)}add(e,t){t!==0&&this.#e.push([e,t])}getInner(){return this.#e}};var vi=class{#e;constructor(e){this.#e=e}drain(){let e=[...this.#e].reverse();return this.#e.length=0,e}isEmpty(){return this.#e.length===0}},A=class{#e=[];sendData(e){e instanceof D||(e=new D(e));for(let t of this.#e)t.unshift(e)}newReader(){let e=[];return this.#e.push(e),new vi(e)}},kn=class{constructor(e,t,n){this.id=e;this.inputs=t,this.output=n}hasPendingWork(){return this.inputs.some(e=>!e.isEmpty())}},ee=class extends kn{constructor(t,n,i){super(t,[n],i);this.id=t}inputMessages(){return this.inputs[0].drain()}},Cn=class extends kn{constructor(t,n,i,s){super(t,[n,i],s);this.id=t}inputAMessages(){return this.inputs[0].drain()}inputBMessages(){return this.inputs[1].drain()}},be=class extends ee{run(){for(let e of this.inputMessages())this.output.sendData(this.inner(e))}};var Kn=class{#e=[];#t=0;#r=!1;constructor(){}#n(){if(this.#r)throw new Error("Graph already finalized")}getNextOperatorId(){return this.#n(),this.#t++}newInput(){this.#n();let e=new A;return new Si(this,e)}addOperator(e){this.#n(),this.#e.push(e)}finalize(){this.#n(),this.#r=!0}step(){if(!this.#r)throw new Error("Graph not finalized");for(let e of this.#e)e.run()}pendingWork(){return this.#e.some(e=>e.hasPendingWork())}run(){for(;this.pendingWork();)this.step()}},B=class{#e;#t;constructor(e,t){this.#e=e,this.#t=t}connectReader(){return this.#t.newReader()}get writer(){return this.#t}get graph(){return this.#e}pipe(...e){return e.reduce((t,n)=>n(t),this)}},Si=class extends B{sendData(e){this.writer.sendData(e)}};var bi=class extends be{#e;constructor(e,t,n,i){super(e,t,n),this.#e=i}inner(e){return e.map(this.#e)}};function F(r){return e=>{let t=new B(e.graph,new A),n=new bi(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Oi=class extends be{#e;constructor(e,t,n,i){super(e,t,n),this.#e=i}inner(e){return this.#e(e),e}};function Hs(r){return e=>{let t=new B(e.graph,new A),n=new Oi(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Ii=class extends be{#e;constructor(e,t,n,i){super(e,t,n),this.#e=i}inner(e){return e.filter(this.#e)}};function oe(r){return e=>{let t=new B(e.graph,new A),n=new Ii(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Mi=class extends ee{#e;constructor(e,t,n,i){super(e,t,n),this.#e=i}run(){for(let e of this.inputMessages())this.#e(e),this.output.sendData(e)}};function Js(r){return e=>{let t=new B(e.graph,new A),n=new Mi(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Vi=class extends ee{run(){let e=this.inputMessages();if(e.length===0)return;let t=new D;for(let i of e)t.extend(i);let n=t.consolidate();n.getInner().length>0&&this.output.sendData(n)}};function qs(){return r=>{let e=new B(r.graph,new A),t=new Vi(r.graph.getNextOperatorId(),r.connectReader(),e.writer);return r.graph.addOperator(t),e}}var Rr=Symbol("NO_PREFIX"),Rn=class extends Map{addValue(e,t){if(t===0)return this.size===0;let n=_r(e),i=this.get(n);if(En(i)){let[s,o]=i;if(_r(s)!==n)throw new Error("Mismatching prefixes, this should never happen");if(s===e||j(s)===j(e)){let c=o+t;c===0?this.delete(n):this.set(n,[e,c])}else{let c=new Ne;c.set(j(s),i),c.set(j(e),[e,t]),this.set(n,c)}}else i===void 0?this.set(n,[e,t]):i.addValue(e,t)&&this.delete(n);return this.size===0}},Ne=class extends Map{addValue(e,t){if(t===0)return this.size===0;let n=j(e),i=this.get(n);if(i){let[,s]=i,o=s+t;o===0?this.delete(n):this.set(n,[e,o])}else this.set(n,[e,t]);return this.size===0}},ue=class r{#e;#t=new Map;constructor(){this.#e=new Map}static fromMultiSets(e){let t=new r;for(let n of e)for(let[i,s]of n.getInner()){let[o,a]=i;t.addValue(o,[a,s])}return t}toString(e=!1){return`Index(${JSON.stringify([...this.entries()],void 0,e?2:void 0)})`}get size(){return this.#e.size}has(e){return this.#e.has(e)}hasPresence(e){return(this.#t.get(e)||0)!==0}getConsolidatedMultiplicity(e){return this.#t.get(e)||0}getPresenceKeys(){return this.#t.keys()}get(e){return[...this.getIterator(e)]}*getIterator(e){let t=this.#e.get(e);if(En(t))yield t;else{if(t===void 0)return;if(t instanceof Ne)for(let n of t.values())yield n;else for(let n of t.values())if(En(n))yield n;else for(let i of n.values())yield i}}*entries(){for(let e of this.#e.keys())for(let t of this.getIterator(e))yield[e,t]}*entriesIterators(){for(let e of this.#e.keys())yield[e,this.getIterator(e)]}addValue(e,t){let[n,i]=t;if(i===0)return;let s=(this.#t.get(e)||0)+i;s===0?this.#t.delete(e):this.#t.set(e,s);let o=this.#e.get(e);if(o===void 0){this.#e.set(e,t);return}if(En(o)){this.#r(e,o,n,i);return}if(o instanceof Ne){let a=_r(n);if(a!==Rr){let c=new Rn;c.set(Rr,o),c.set(a,t),this.#e.set(e,c)}else o.addValue(n,i)&&this.#e.delete(e)}else o.addValue(n,i)&&this.#e.delete(e)}#r(e,t,n,i){let[s,o]=t;if(s===n){let l=o+i;l===0?this.#e.delete(e):this.#e.set(e,[n,l]);return}let a=_r(n),c=_r(s);if(c===a&&(s===n||j(s)===j(n))){let l=o+i;l===0?this.#e.delete(e):this.#e.set(e,[n,l]);return}if(c===Rr&&a===Rr){let l=new Ne;l.set(j(s),t),l.set(j(n),[n,i]),this.#e.set(e,l)}else{let l=new Rn;if(c===a){let f=new Ne;f.set(j(s),t),f.set(j(n),[n,i]),l.set(c,f)}else l.set(c,t),l.set(a,[n,i]);this.#e.set(e,l)}}append(e){for(let[t,n]of e.entries())this.addValue(t,n)}join(e){let t=[];if(this.size<=e.size)for(let[n,i]of this.entriesIterators()){if(!e.has(n))continue;let s=e.get(n);for(let[o,a]of i)for(let[c,l]of s)a!==0&&l!==0&&t.push([[n,[o,c]],a*l])}else for(let[n,i]of e.entriesIterators()){if(!this.has(n))continue;let s=this.get(n);for(let[o,a]of i)for(let[c,l]of s)l!==0&&a!==0&&t.push([[n,[c,o]],l*a])}return new D(t)}};function _r(r){return Array.isArray(r)&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="bigint")?r[0]:Rr}function En(r){return Array.isArray(r)}var Pi=class extends Cn{#e=new ue;#t=new ue;#r;constructor(e,t,n,i,s="inner"){super(e,t,n,i),this.#r=s}run(){let e=ue.fromMultiSets(this.inputAMessages()),t=ue.fromMultiSets(this.inputBMessages());if(e.size===0&&t.size===0)return;let n=new D;this.#r!=="anti"&&this.emitInnerResults(e,t,n),(this.#r==="left"||this.#r==="full"||this.#r==="anti")&&this.emitLeftOuterResults(e,t,n),(this.#r==="right"||this.#r==="full")&&this.emitRightOuterResults(e,t,n),this.#e.append(e),this.#t.append(t),n.getInner().length>0&&this.output.sendData(n)}emitInnerResults(e,t,n){e.size>0&&n.extend(e.join(this.#t)),t.size>0&&n.extend(this.#e.join(t)),e.size>0&&t.size>0&&n.extend(e.join(t))}emitLeftOuterResults(e,t,n){if(e.size>0)for(let[i,s]of e.entriesIterators()){let o=this.#t.getConsolidatedMultiplicity(i),a=t.getConsolidatedMultiplicity(i);if(o+a===0)for(let[l,f]of s)f!==0&&n.add([i,[l,null]],f)}if(t.size>0)for(let i of t.getPresenceKeys()){let s=this.#t.getConsolidatedMultiplicity(i),o=t.getConsolidatedMultiplicity(i);if(o===0)continue;let a=s+o;if(s===0==(a===0))continue;let c=s===0;for(let[l,f]of this.#e.getIterator(i))f!==0&&n.add([i,[l,null]],c?-f:+f)}}emitRightOuterResults(e,t,n){if(t.size>0)for(let[i,s]of t.entriesIterators()){let o=this.#e.getConsolidatedMultiplicity(i),a=e.getConsolidatedMultiplicity(i);if(o+a===0)for(let[l,f]of s)f!==0&&n.add([i,[null,l]],f)}if(e.size>0)for(let i of e.getPresenceKeys()){let s=this.#e.getConsolidatedMultiplicity(i),o=e.getConsolidatedMultiplicity(i);if(o===0)continue;let a=s+o;if(s===0==(a===0))continue;let c=s===0;for(let[l,f]of this.#t.getIterator(i))f!==0&&n.add([i,[null,l]],c?-f:+f)}}};function Gs(r,e="inner"){return t=>{if(t.graph!==r.graph)throw new Error("Cannot join streams from different graphs");let n=new B(t.graph,new A),i=new Pi(t.graph.getNextOperatorId(),t.connectReader(),r.connectReader(),n.writer,e);return t.graph.addOperator(i),n}}var ki=class extends ee{#e=new ue;#t=new ue;#r;constructor(e,t,n,i){super(e,t,n),this.#r=i}run(){let e=new Set;for(let n of this.inputMessages())for(let[i,s]of n.getInner()){let[o,a]=i;this.#e.addValue(o,[a,s]),e.add(o)}let t=[];for(let n of e){let i=this.#e.get(n),s=this.#t.get(n),o=this.#r(i),a=new Map,c=new Map;for(let[l,f]of o){let u=a.get(l)??0;a.set(l,u+f)}for(let[l,f]of s){let u=c.get(l)??0;c.set(l,u+f)}for(let[l,f]of c)a.has(l)||(t.push([[n,l],-f]),this.#t.addValue(n,[l,-f]));for(let[l,f]of a)c.has(l)||f!==0&&(t.push([[n,l],f]),this.#t.addValue(n,[l,f]));for(let[l,f]of a){let u=c.get(l);if(u!==void 0){let d=f-u;d!==0&&(t.push([[n,l],d]),this.#t.addValue(n,[l,d]))}}}t.length>0&&this.output.sendData(new D(t))}};function Qs(r){return e=>{let t=new B(e.graph,new A),n=new ki(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Ci=class extends ee{#e;#t;constructor(e,t,n,i=s=>s){super(e,t,n),this.#e=i,this.#t=new Map}run(){let e=new Map;for(let n of this.inputMessages())for(let[i,s]of n.getInner()){let o=j(this.#e(i)),c=(e.get(o)?.[0]??this.#t.get(o)??0)+s;e.set(o,[c,i])}let t=[];for(let[n,[i,s]]of e.entries()){let o=this.#t.get(n)??0;i===0?this.#t.delete(n):this.#t.set(n,i),o<=0&&i>0?t.push([[j(this.#e(s)),s[1]],1]):o>0&&i<=0&&t.push([[j(this.#e(s)),s[1]],-1])}t.length>0&&this.output.sendData(new D(t))}};function Ys(r=e=>e){return e=>{let t=new B(e.graph,new A),n=new Ci(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var vc="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function dr(r,e,t){let n=t[0];if(e!=null&&r>=e)throw new Error(r+" >= "+e);if(r.slice(-1)===n||e&&e.slice(-1)===n)throw new Error("trailing zero");if(e){let o=0;for(;(r[o]||n)===e[o];)o++;if(o>0)return e.slice(0,o)+dr(r.slice(o),e.slice(o),t)}let i=r?t.indexOf(r[0]):0,s=e!=null?t.indexOf(e[0]):t.length;if(s-i>1){let o=Math.round(.5*(i+s));return t[o]}else return e&&e.length>1?e.slice(0,1):t[i]+dr(r.slice(1),null,t)}function eo(r){if(r.length!==to(r[0]))throw new Error("invalid integer part of order key: "+r)}function to(r){if(r>="a"&&r<="z")return r.charCodeAt(0)-97+2;if(r>="A"&&r<="Z")return 90-r.charCodeAt(0)+2;throw new Error("invalid order key head: "+r)}function Ar(r){let e=to(r[0]);if(e>r.length)throw new Error("invalid order key: "+r);return r.slice(0,e)}function Xs(r,e){if(r==="A"+e[0].repeat(26))throw new Error("invalid order key: "+r);let t=Ar(r);if(r.slice(t.length).slice(-1)===e[0])throw new Error("invalid order key: "+r)}function Zs(r,e){eo(r);let[t,...n]=r.split(""),i=!0;for(let s=n.length-1;i&&s>=0;s--){let o=e.indexOf(n[s])+1;o===e.length?n[s]=e[0]:(n[s]=e[o],i=!1)}if(i){if(t==="Z")return"a"+e[0];if(t==="z")return null;let s=String.fromCharCode(t.charCodeAt(0)+1);return s>"a"?n.push(e[0]):n.pop(),s+n.join("")}else return t+n.join("")}function Sc(r,e){eo(r);let[t,...n]=r.split(""),i=!0;for(let s=n.length-1;i&&s>=0;s--){let o=e.indexOf(n[s])-1;o===-1?n[s]=e.slice(-1):(n[s]=e[o],i=!1)}if(i){if(t==="a")return"Z"+e.slice(-1);if(t==="A")return null;let s=String.fromCharCode(t.charCodeAt(0)-1);return s<"Z"?n.push(e.slice(-1)):n.pop(),s+n.join("")}else return t+n.join("")}function _n(r,e,t=vc){if(r!=null&&Xs(r,t),e!=null&&Xs(e,t),r!=null&&e!=null&&r>=e)throw new Error(r+" >= "+e);if(r==null){if(e==null)return"a"+t[0];let c=Ar(e),l=e.slice(c.length);if(c==="A"+t[0].repeat(26))return c+dr("",l,t);if(c<e)return c;let f=Sc(c,t);if(f==null)throw new Error("cannot decrement any more");return f}if(e==null){let c=Ar(r),l=r.slice(c.length),f=Zs(c,t);return f??c+dr(l,null,t)}let n=Ar(r),i=r.slice(n.length),s=Ar(e),o=e.slice(s.length);if(n===s)return n+dr(i,o,t);let a=Zs(n,t);if(a==null)throw new Error("cannot increment any more");return a<e?a:n+dr(i,null,t)}var Bn=class{#e=[];#t;#r;#n;constructor(e,t,n){this.#r=e,this.#n=e+t,this.#t=n}get size(){let e=this.#r,t=this.#n-this.#r,n=this.#e.length-e;return Math.max(0,Math.min(t,n))}move({offset:e,limit:t}){let n=this.#r,i=this.#n-this.#r,s=[this.#r,this.#n===1/0?this.#r+this.size:this.#n];this.#r=e??n,this.#n=this.#r+(t??i);let o=[this.#r,this.#n===1/0?Math.max(this.#r+this.size,s[1]):this.#n],{onlyInA:a,onlyInB:c}=Ns(s,o),l=[];c.forEach(u=>{let d=this.#e[u];d&&l.push(d)});let f=[];return a.forEach(u=>{let d=this.#e[u];d&&f.push(d)}),{moveIns:l,moveOuts:f,changes:a.length+c.length>0}}insert(e){let t={moveIn:null,moveOut:null},n=this.#i(e),i=n===0?null:Fn(this.#e[n-1]),s=n===this.#e.length?null:Fn(this.#e[n]),o=_n(i,s),a=ro(e,o);if(this.#e.splice(n,0,a),n<this.#n){let c=Math.max(n,this.#r);c<this.#e.length&&(t.moveIn=this.#e[c],this.#n<this.#e.length&&(t.moveOut=this.#e[this.#n]))}return t}delete(e){let t={moveIn:null,moveOut:null},n=this.#i(e),[i]=this.#e.splice(n,1);if(n<this.#n){if(t.moveOut=i,n<this.#r){let o=this.#r-1;o<this.#e.length?t.moveOut=this.#e[o]:t.moveOut=null}let s=this.#n-1;s<this.#e.length&&(t.moveIn=this.#e[s])}return t}#i(e){return zs(this.#e,ro(e,""),(t,n)=>this.#t(Dn(t),Dn(n)))}},Ki=class extends ee{#e=new Map;#t;constructor(e,t,n,i,s){super(e,t,n);let o=s.limit??1/0,a=s.offset??0,c=(l,f)=>{let u=i(An(l),An(f));if(u!==0)return u;let d=so(l),p=so(f);return d-p};this.#t=this.createTopK(a,o,c),s.setSizeCallback?.(()=>this.#t.size),s.setWindowFn?.(this.moveTopK.bind(this))}createTopK(e,t,n){return new Bn(e,t,n)}moveTopK({offset:e,limit:t}){if(!(this.#t instanceof Bn))throw new Error("Cannot move B+-tree implementation of TopK with fractional index");let n=[],i=this.#t.move({offset:e,limit:t});i.moveIns.forEach(s=>this.handleMoveIn(s,n)),i.moveOuts.forEach(s=>this.handleMoveOut(s,n)),i.changes&&this.output.sendData(new D(n))}run(){let e=[];for(let t of this.inputMessages())for(let[n,i]of t.getInner()){let[s,o]=n;this.processElement(s,o,i,e)}e.length>0&&this.output.sendData(new D(e))}processElement(e,t,n,i){let{oldMultiplicity:s,newMultiplicity:o}=this.addKey(e,n),a={moveIn:null,moveOut:null};if(s<=0&&o>0){let c=no(e,t);a=this.#t.insert(c)}else if(s>0&&o<=0){let c=no(e,t);a=this.#t.delete(c)}this.handleMoveIn(a.moveIn,i),this.handleMoveOut(a.moveOut,i)}handleMoveIn(e,t){if(e){let n=Fn(e),i=Dn(e),s=io(i),o=An(i);t.push([[s,[o,n]],1])}}handleMoveOut(e,t){if(e){let n=Fn(e),i=Dn(e),s=io(i),o=An(i);t.push([[s,[o,n]],-1])}}getMultiplicity(e){return this.#e.get(e)??0}addKey(e,t){let n=this.getMultiplicity(e),i=n+t;return i===0?this.#e.delete(e):this.#e.set(e,i),{oldMultiplicity:n,newMultiplicity:i}}};function oo(r,e){let t=e||{};return n=>{let i=new B(n.graph,new A),s=new Ki(n.graph.getNextOperatorId(),n.connectReader(),i.writer,r,t);return n.graph.addOperator(s),i}}function ro(r,e){return[r,e]}function Dn(r){return r[0]}function Fn(r){return r[1]}function no(r,e){return[r,e,fr.getId(r)]}function io(r){return r[0]}function An(r){return r[1]}function so(r){return r[2]}function bc(r,e,t){let n=t?.limit??1/0,i=t?.offset??0,s=t?.setSizeCallback,o=t?.setWindowFn,a=t?.comparator??((c,l)=>c===l?0:c<l?-1:1);return c=>c.pipe(r((l,f)=>a(e(l),e(f)),{limit:n,offset:i,setSizeCallback:s,setWindowFn:o}),qs())}function ao(r,e){return bc(oo,r,e)}function co(r){return"pipe"in r}function jn(r,e={}){let t=Object.fromEntries(Object.entries(e).filter(([i,s])=>!co(s))),n=Object.fromEntries(Object.entries(e).filter(([i,s])=>co(s)));return i=>{let s="__original_key__";return i.pipe(F(c=>{let l=r(c),f=JSON.stringify(l),u={};u[s]=l;for(let[d,p]of Object.entries(t))u[d]=p.preMap(c);return[f,u]})).pipe(Qs(c=>{let l=0;for(let[d,p]of c)l+=p;if(l<=0)return[];let f={},u=c[0]?.[0]?.[s];f[s]=u;for(let[d,p]of Object.entries(t)){let h=c.map(([m,y])=>[m[d],y]);f[d]=p.reduce(h)}return[[f,1]]})).pipe(F(([c,l])=>{let f=l[s],u={};Object.assign(u,f);for(let[d,p]of Object.entries(t))p.postMap?u[d]=p.postMap(l[d]):u[d]=l[d];return[c,u]}))}}function Oc(r=e=>e){return{preMap:e=>r(e),reduce:e=>{let t=0;for(let[n,i]of e)t+=n*i;return t}}}function Ic(r=e=>e){return{preMap:e=>r(e)==null?0:1,reduce:e=>{let t=0;for(let[n,i]of e)t+=n*i;return t}}}function Mc(r=e=>e){return{preMap:e=>({sum:r(e),count:0}),reduce:e=>{let t=0,n=0;for(let[i,s]of e)t+=i.sum*s,n+=s;return{sum:t,count:n}},postMap:e=>e.sum/e.count}}function Vc(r){let e=r??(t=>t);return{preMap:t=>e(t),reduce:t=>{let n;for(let[i,s]of t)(!n||i&&i<n)&&(n=i);return n}}}function Pc(r){let e=r??(t=>t);return{preMap:t=>e(t),reduce:t=>{let n;for(let[i,s]of t)(!n||i&&i>n)&&(n=i);return n}}}function kc(r=e=>e){return{preMap:e=>[r(e)],reduce:e=>{let t=[];for(let[n,i]of e)for(let s of n)for(let o=0;o<i;o++)t.push(s);return t.length===0?[]:(t.sort((n,i)=>n-i),t)},postMap:e=>{if(e.length===0)return 0;let t=Math.floor(e.length/2);return e.length%2===0?(e[t-1]+e[t])/2:e[t]}}}function Cc(r=e=>e){return{preMap:e=>{let t=r(e),n=new Map;return n.set(t,1),n},reduce:e=>{let t=new Map;for(let[n,i]of e)for(let[s,o]of n.entries()){let a=t.get(s)||0;t.set(s,a+o*i)}return t},postMap:e=>{if(e.size===0)return 0;let t=0,n=0;for(let[i,s]of e.entries())s>n&&(n=s,t=i);return t}}}var Ei={sum:Oc,count:Ic,avg:Mc,min:Vc,max:Pc,median:kc,mode:Cc};var lo=new Set(["eq","gt","lt","gte","lte","and","or","in"]);function Ri(r){let e=r.type;return e==="func"?lo.has(r.name)?r.args.every(t=>Ri(t)):!1:["val","ref"].includes(e)}function zn(r,e){let t=r.type;if(t==="val")return new $(r.value);if(t==="ref"){let n=r.path;if(Array.isArray(n)){if(n[0]===e&&n.length>1)return new R(n.slice(1));if(n.length===1&&n[0]!==void 0)return new R([n[0]])}return new R(Array.isArray(n)?n:[String(n)])}else{if(!lo.has(r.name))return null;let n=[];for(let i of r.args){let s=zn(i,e);if(s==null)return null;n.push(s)}return new k(r.name,n)}}function _i(r,e){return r.map(n=>{let i=zn(n.expression,e);if(!i)throw new Error(`Failed to convert orderBy expression to a basic expression: ${n.expression}`);return{...n,expression:i}})}function po(r){let e=Kc(r),t=r,n,i=0,s=10;for(;i<s&&!Y(t,n);)n=t,t=Ai(t),i++;return{optimizedQuery:ho(t),sourceWhereClauses:e}}function Kc(r){let e=new Map;if(!r.where||r.where.length===0)return e;let n=mo(r.where).map(s=>go(s)),i=To(n);for(let[s,o]of i.singleSource)Ec(r,s)&&Ri(o)&&e.set(s,o);return e}function Ec(r,e){if(r.from.alias===e)return r.from.type==="collectionRef";if(r.join){for(let t of r.join)if(t.from.alias===e)return t.from.type==="collectionRef"}return!1}function Ai(r){let e={...r,from:r.from.type==="queryRef"?new U(Ai(r.from.query),r.from.alias):r.from,join:r.join?.map(t=>({...t,from:t.from.type==="queryRef"?new U(Ai(t.from.query),t.from.alias):t.from}))};return Rc(e)}function Rc(r){if(!r.where||r.where.length===0||!r.join||r.join.length===0)return r;let e=r.where.filter(a=>!rn(a)),n=mo(e).map(a=>go(a)),i=To(n),s=Ac(r,i),o=r.where.filter(a=>rn(a));return o.length>0&&(s.where=[...s.where||[],...o]),s}function ho(r){return{...r,from:Bi(r.from),join:r.join?.map(e=>({...e,from:Bi(e.from)}))}}function Bi(r){if(r.type==="collectionRef")return r;let e=ho(r.query);if(_c(e)){let t=Bi(e.from);return t.type==="collectionRef"?new ne(t.collection,r.alias):new U(t.query,r.alias)}return new U(e,r.alias)}function _c(r){return(!r.where||r.where.length===0)&&!r.select&&(!r.groupBy||r.groupBy.length===0)&&(!r.having||r.having.length===0)&&(!r.orderBy||r.orderBy.length===0)&&(!r.join||r.join.length===0)&&r.limit===void 0&&r.offset===void 0&&!r.fnSelect&&(!r.fnWhere||r.fnWhere.length===0)&&(!r.fnHaving||r.fnHaving.length===0)}function mo(r){let e=[];for(let t of r){let n=Ir(t);e.push(...yo(n))}return e}function yo(r){if(r.type==="func"&&r.name==="and"){let e=[];for(let t of r.args)e.push(...yo(t));return e}else return[r]}function go(r){let e=new Set,t=!1;function n(i){switch(i.type){case"ref":if(i.path&&i.path.length>0){let s=i.path[0];s&&(e.add(s),i.path.length===1&&(t=!0))}break;case"func":i.args&&i.args.forEach(n);break;case"val":break;case"agg":i.args&&i.args.forEach(n);break}}return n(r),{expression:r,touchedSources:e,hasNamespaceOnlyRef:t}}function To(r){let e=new Map,t=[];for(let s of r)if(s.touchedSources.size===1&&!s.hasNamespaceOnlyRef){let o=Array.from(s.touchedSources)[0];e.has(o)||e.set(o,[]),e.get(o).push(s.expression)}else(s.touchedSources.size>1||s.hasNamespaceOnlyRef)&&t.push(s.expression);let n=new Map;for(let[s,o]of e)n.set(s,fo(o));let i=t.length>0?fo(t):void 0;return{singleSource:n,multiSource:i}}function Ac(r,e){let t=new Set,n=uo(r.from,e.singleSource,t),i=r.join?r.join.map(c=>({...c,from:uo(c.from,e.singleSource,t)})):void 0,s=[];e.multiSource&&s.push(e.multiSource);let o=r.join&&r.join.some(c=>c.type==="left"||c.type==="right"||c.type==="full");for(let[c,l]of e.singleSource)t.has(c)?o&&s.push(si(l)):s.push(l);return{select:r.select,groupBy:r.groupBy?[...r.groupBy]:void 0,having:r.having?[...r.having]:void 0,orderBy:r.orderBy?[...r.orderBy]:void 0,limit:r.limit,offset:r.offset,distinct:r.distinct,fnSelect:r.fnSelect,fnWhere:r.fnWhere?[...r.fnWhere]:void 0,fnHaving:r.fnHaving?[...r.fnHaving]:void 0,from:n,join:i,where:s.length>0?s:[]}}function hr(r){return{from:r.from.type==="collectionRef"?new ne(r.from.collection,r.from.alias):new U(hr(r.from.query),r.from.alias),select:r.select,join:r.join?r.join.map(e=>({type:e.type,left:e.left,right:e.right,from:e.from.type==="collectionRef"?new ne(e.from.collection,e.from.alias):new U(hr(e.from.query),e.from.alias)})):void 0,where:r.where?[...r.where]:void 0,groupBy:r.groupBy?[...r.groupBy]:void 0,having:r.having?[...r.having]:void 0,orderBy:r.orderBy?[...r.orderBy]:void 0,limit:r.limit,offset:r.offset,fnSelect:r.fnSelect,fnWhere:r.fnWhere?[...r.fnWhere]:void 0,fnHaving:r.fnHaving?[...r.fnHaving]:void 0}}function uo(r,e,t){let n=e.get(r.alias);if(!n)return r.type==="collectionRef"?new ne(r.collection,r.alias):new U(hr(r.query),r.alias);if(r.type==="collectionRef"){let o={from:new ne(r.collection,r.alias),where:[n]};return t.add(r.alias),new U(o,r.alias)}if(!Nc(r.query,n,r.alias))return new U(hr(r.query),r.alias);if(Lc(r.query,n,r.alias))return new U(hr(r.query),r.alias);let i=r.query.where||[],s={...hr(r.query),where:[...i,n]};return t.add(r.alias),new U(s,r.alias)}function Bc(r,e,t){return r.select?wo(r.select)||Wc(r.select,e,t):!1}function Dc(r){return r.groupBy&&r.groupBy.length>0}function Fc(r){return r.having&&r.having.length>0}function jc(r){return r.orderBy&&r.orderBy.length>0&&(r.limit!==void 0||r.offset!==void 0)}function zc(r){return r.fnSelect||r.fnWhere&&r.fnWhere.length>0||r.fnHaving&&r.fnHaving.length>0}function Nc(r,e,t){return!(Bc(r,e,t)||Dc(r)||Fc(r)||jc(r)||zc(r))}function wo(r){for(let e of Object.values(r))if(typeof e=="object"){let t=e;if(t.type==="agg"||!("type"in t)&&wo(t))return!0}return!1}function Di(r){let e=[];if(r==null||typeof r!="object")return e;switch(r.type){case"ref":e.push(r);break;case"func":case"agg":for(let t of r.args??[])e.push(...Di(t));break}return e}function Wc(r,e,t){let n=new Set;for(let[s,o]of Object.entries(r))s.startsWith("__SPREAD_SENTINEL__")||o instanceof R||n.add(s);let i=Di(e);for(let s of i){let o=s.path;if(!Array.isArray(o)||o.length<2)continue;let a=o[0],c=o[1];if(a===t&&n.has(c))return!0}return!1}function Lc(r,e,t){let n=Di(e);if(n.every(s=>s.path[0]!==t))return!1;if(r.fnSelect)return!0;let i=r.select;if(!i)return!1;for(let s of n){let o=s.path;if(o.length<2||o[0]!==t)continue;let a=i[o[1]];if(!a)continue;if(!(a instanceof R)||a.path.length<2)return!0;let[c,l]=a.path;if(c!==t&&c!==r.from.alias||l!==o[1])return!0}return!1}function fo(r){if(r.length===0)throw new Gt;return r.length===1?r[0]:new k("and",r)}function xo(r,e,t,n,i,s,o,a,c,l,f,u,d,p,h,m,y,v){let g=r;for(let S of e)g=Uc(g,S,t,n,i,s,o,a,c,l,f,u,d,p,h,m,y,v);return g}function Uc(r,e,t,n,i,s,o,a,c,l,f,u,d,p,h,m,y,v){let g=e.from.type==="collectionRef",{alias:S,input:O,collectionId:E}=Hc(e.from,s,c,l,f,u,d,p,o,a,m,y,v);t[S]=O,g&&(y[S]=E);let V=c[n],I=c[E];if(!V)throw new Re(n);if(!I)throw new Re(E);let{activeSource:x,lazySource:T}=qc(e.type,V,I),w=Object.keys(t),{mainExpr:P,joinedExpr:L}=$c(e.left,e.right,w,S),de=G(P),ae=G(L),vr=r.pipe(F(([Me,Je])=>[de(Je),[Me,Je]])),Sr=O.pipe(F(([Me,Je])=>{let br={[S]:Je};return[ae(br),[Me,br]]}));if(!["inner","left","right","full"].includes(e.type))throw new Et(e.type);if(x){let Me=x==="main"?e.from:h.from,Je=Me.type==="queryRef"&&(Me.query.limit||Me.query.offset),br=P.type==="func"||L.type==="func";if(!Je&&!br){let Or=x==="main"?S:i;u.add(Or);let ua=x==="main"?vr:Sr,Zr=Ve(h,x==="main"?L:P,T),fa=Zr.collection,Gi=Zr.path[0];Gi&&Fe(Gi,Zr.path,fa);let Qi=ua.pipe(Hs(pa=>{let Yi=v[Or]||Or,en=l[Yi];if(!en)throw new Yt(Yi,Or,T.id,Object.keys(l));if(en.hasLoadedInitialState())return;let da=pa.getInner().map(([[ma]])=>ma),ha=new R(Zr.path);en.requestSnapshot({where:pn(ha,da),optimizedOnly:!0})||en.requestSnapshot()}));x==="main"?vr=Qi:Sr=Qi}}return vr.pipe(Gs(Sr,e.type),Jc(e.type))}function $c(r,e,t,n){let i=t.filter(a=>a!==n),s=Fi(r),o=Fi(e);if(s&&i.includes(s)&&o===n)return{mainExpr:r,joinedExpr:e};if(s===n&&o&&i.includes(o))return{mainExpr:e,joinedExpr:r};throw!s||!o?new _t:s===o?new Rt(s):i.includes(s)?o!==n?new Bt(n):new Dt:new At(s)}function Fi(r){switch(r.type){case"ref":return r.path[0]||null;case"func":{let e=new Set;for(let t of r.args){let n=Fi(t);n&&e.add(n)}return e.size===1?Array.from(e)[0]:null}default:return null}}function Hc(r,e,t,n,i,s,o,a,c,l,f,u,d){switch(r.type){case"collectionRef":{let p=e[r.alias];if(!p)throw new we(r.alias,r.collection.id,Object.keys(e));return u[r.alias]=r.collection.id,{alias:r.alias,input:p,collectionId:r.collection.id}}case"queryRef":{let p=l.get(r.query)||r.query,h=f(p,e,t,n,i,s,o,a,c,l);Object.assign(u,h.aliasToCollectionId),Object.assign(d,h.aliasRemapping);let m=Object.keys(h.aliasToCollectionId).find(g=>h.aliasToCollectionId[g]===h.collectionId);m&&m!==r.alias&&(d[r.alias]=m);let v=h.pipeline.pipe(F(g=>{let[S,[O,E]]=g;return[S,O]}));return{alias:r.alias,input:v,collectionId:h.collectionId}}default:throw new Ft(r.type)}}function Jc(r){return function(e){return e.pipe(oe(t=>{let[n,[i,s]]=t,o=i?.[1],a=s?.[1];return r==="inner"?!!(o&&a):r==="left"?!!o:r==="right"?!!a:!0}),F(t=>{let[n,[i,s]]=t,o=i?.[0],a=i?.[1],c=s?.[0],l=s?.[1],f={};return a&&Object.assign(f,a),l&&Object.assign(f,l),[`[${o},${c}]`,f]}))}}function qc(r,e,t){switch(r){case"left":return{activeSource:"main",lazySource:t};case"right":return{activeSource:"joined",lazySource:e};case"inner":return e.size<t.size?{activeSource:"main",lazySource:t}:{activeSource:"joined",lazySource:e};default:return{activeSource:void 0,lazySource:void 0}}}var{sum:Gc,count:Qc,avg:Yc,min:Xc,max:Zc}=Ei;function el(r,e){let t=new Map,n=[...r];if(!e)return{selectToGroupByIndex:t,groupByExpressions:n};for(let[i,s]of Object.entries(e)){if(s.type==="agg")continue;let o=n.findIndex(a=>Nn(s,a));if(o===-1)throw new jt(i);t.set(i,o)}return{selectToGroupByIndex:t,groupByExpressions:n}}function ji(r,e,t,n,i){if(e.length===0){let l={};if(n){for(let[u,d]of Object.entries(n))if(d.type==="agg"){let p=d;l[u]=vo(p)}}let f=()=>({__singleGroup:!0});if(r=r.pipe(jn(f,l)),r=r.pipe(F(([,u])=>{let p={...u.__select_results||{}};if(n)for(let[h,m]of Object.entries(n))m.type==="agg"&&(p[h]=u[h]);return["single_group",{...u,__select_results:p}]})),t&&t.length>0)for(let u of t){let d=tn(u),p=Br(d,n||{}),h=G(p);r=r.pipe(oe(([,m])=>{let y={result:m.__select_results};return h(y)}))}if(i&&i.length>0)for(let u of i)r=r.pipe(oe(([,d])=>{let p={result:d.__select_results};return u(p)}));return r}let s=el(e,n),o=e.map(l=>G(l)),a=([,l])=>{let f={...l};delete f.__select_results;let u={};for(let d=0;d<e.length;d++){let p=o[d],h=p(f);u[`__key_${d}`]=h}return u},c={};if(n){for(let[l,f]of Object.entries(n))if(f.type==="agg"){let u=f;c[l]=vo(u)}}if(r=r.pipe(jn(a,c)),r=r.pipe(F(([,l])=>{let f=l.__select_results||{},u={};if(n)for(let[p,h]of Object.entries(n))if(h.type!=="agg"){let m=s.selectToGroupByIndex.get(p);m!==void 0?u[p]=l[`__key_${m}`]:u[p]=f[p]}else u[p]=l[p];else for(let p=0;p<e.length;p++)u[`__key_${p}`]=l[`__key_${p}`];let d;if(e.length===1)d=l.__key_0;else{let p=[];for(let h=0;h<e.length;h++)p.push(l[`__key_${h}`]);d=JSON.stringify(p)}return[d,{...l,__select_results:u}]})),t&&t.length>0)for(let l of t){let f=tn(l),u=Br(f,n||{}),d=G(u);r=r.pipe(oe(([,p])=>{let h={result:p.__select_results};return d(h)}))}if(i&&i.length>0)for(let l of i)r=r.pipe(oe(([,f])=>{let u={result:f.__select_results};return l(u)}));return r}function Nn(r,e){if(!r||!e||r.type!==e.type)return!1;switch(r.type){case"ref":return!r.path||!e.path||r.path.length!==e.path.length?!1:r.path.every((t,n)=>t===e.path[n]);case"val":return r.value===e.value;case"func":return r.name===e.name&&r.args?.length===e.args?.length&&(r.args||[]).every((t,n)=>Nn(t,e.args[n]));case"agg":return r.name===e.name&&r.args?.length===e.args?.length&&(r.args||[]).every((t,n)=>Nn(t,e.args[n]));default:return!1}}function vo(r){let e=G(r.args[0]),t=([,s])=>{let o=e(s);return typeof o=="number"?o:o!=null?Number(o):0},n=([,s])=>{let o=e(s);return typeof o=="number"||o instanceof Date?o:o!=null?Number(o):0},i=([,s])=>e(s);switch(r.name.toLowerCase()){case"sum":return Gc(t);case"count":return Qc(i);case"avg":return Yc(t);case"min":return Xc(n);case"max":return Zc(n);default:throw new zt(r.name)}}function Br(r,e,t="result"){switch(r.type){case"agg":{let n=r;for(let[i,s]of Object.entries(e))if(s.type==="agg"&&tl(n,s))return new R([t,i]);throw new Nt(n.name)}case"func":{let n=r,i=n.args.map(s=>Br(s,e));return new k(n.name,i)}case"ref":return r;case"val":return r;default:throw new Wt(r.type)}}function tl(r,e){return r.name===e.name&&r.args.length===e.args.length&&r.args.every((t,n)=>Nn(t,e.args[n]))}function So(r,e,t,n,i,s,o,a,c){let l=t.map(h=>{let m=Br(h.expression,n,"__select_results");return{compiledExpression:G(m),compareOptions:h.compareOptions}}),f=h=>{let m=h;return t.length>1?l.map(y=>y.compiledExpression(m)):t.length===1?l[0].compiledExpression(m):null},u=(h,m)=>{if(t.length>1){let y=h,v=m;for(let g=0;g<t.length;g++){let S=t[g],E=er(S.compareOptions)(y[g],v[g]);if(E!==0)return E}return y.length-v.length}if(t.length===1){let y=t[0];return er(y.compareOptions)(h,m)}return Mr(h,m)},d,p;if(a&&t.length===1){let h=t[0],m=h.expression;if(m.type==="ref"){let y=Ve(r,m,i),v=y.collection,g=y.path[0];g&&Fe(g,y.path,v,h.compareOptions,u);let S=G(new R(y.path),!0),O=(V,I)=>{let x=V&&S(V),T=I&&S(I);return u(x,T)},E=Be(v.indexes,y.path,h.compareOptions);E&&E.supports("gt")&&(p={alias:m.path.length>1?String(m.path[0]):r.from.alias,offset:c??0,limit:a,comparator:O,valueExtractorForRawRow:S,index:E,orderBy:t},s[v.id]=p,d=I=>{s[v.id]={...s[v.id],dataNeeded:()=>{let x=I();return Math.max(0,p.limit-x)}}})}}return e.pipe(ao(f,{limit:a,offset:c,comparator:u,setSizeCallback:d,setWindowFn:h=>{o(m=>{h(m),p&&(p.offset=m.offset??p.offset,p.limit=m.limit??p.limit)})}}))}function zi(r){return r instanceof $?r.value:r}function rl(r,e,t){let n=r.source(e);if(n&&typeof n=="object"){let i=t,s=r.targetPath;if(s.length===0)for(let[o,a]of Object.entries(n))t[o]=zi(a);else for(let o=0;o<s.length;o++){let a=s[o];if(o===s.length-1){let c=i[a]??={};if(typeof c=="object")for(let[l,f]of Object.entries(n))c[l]=zi(f)}else{let c=i[a];(c==null||typeof c!="object")&&(i[a]={}),i=i[a]}}}}function nl(r,e,t){let n=r.alias.split(".");if(n.length===1)t[r.alias]=r.compiled(e);else{let i=t;for(let s=0;s<n.length-1;s++){let o=n[s],a=i[o];(a==null||typeof a!="object")&&(i[o]={}),i=i[o]}i[n[n.length-1]]=zi(r.compiled(e))}}function il([r,e],t){let n={};for(let i of t)i.kind==="merge"?rl(i,e,n):nl(i,e,n);return[r,{...e,__select_results:n}]}function bo(r,e,t){let n=[];return Oo([],e,n),r.pipe(F(i=>il(i,n)))}function sl(r){return r.type==="agg"}function ol(r){return r&&typeof r=="object"&&!qe(r)}function Oo(r,e,t){for(let[n,i]of Object.entries(e)){if(n.startsWith("__SPREAD_SENTINEL__")){let o=n.slice(19),a=o.lastIndexOf("__"),c=a>=0?o.slice(0,a):o,l=i&&typeof i=="object"&&"type"in i&&i.type==="ref";if(c.includes(".")||l){let f=[...r],u=l?i:new R(c.split(".")),d=G(u);t.push({kind:"merge",targetPath:f,source:d})}else{let f=c,u=[...r];t.push({kind:"merge",targetPath:u,source:d=>d[f]})}continue}let s=i;if(ol(s)){Oo([...r,n],s,t);continue}if(sl(s))t.push({kind:"field",alias:[...r,n].join("."),compiled:()=>null});else{if(s===void 0||!qe(s)){t.push({kind:"field",alias:[...r,n].join("."),compiled:()=>s});continue}if(s instanceof $){let o=s.value;t.push({kind:"field",alias:[...r,n].join("."),compiled:()=>o})}else t.push({kind:"field",alias:[...r,n].join("."),compiled:G(s)})}}}function mr(r,e,t,n,i,s,o,a,c=new WeakMap,l=new WeakMap){let f=c.get(r);if(f)return f;let{optimizedQuery:u,sourceWhereClauses:d}=po(r);l.set(u,r),Wi(u,r,l);let p={...e},h={},m={},y={},{alias:v,input:g,collectionId:S}=al(u.from,p,t,n,i,s,o,a,c,l,h,m);y[v]=g;let O=g.pipe(F(([x,T])=>[x,{[v]:T}]));if(u.join&&u.join.length>0&&(O=xo(O,u.join,y,S,v,p,c,l,t,n,i,s,o,a,r,mr,h,m)),u.where&&u.where.length>0)for(let x of u.where){let T=Ir(x),w=G(T);O=O.pipe(oe(([P,L])=>w(L)))}if(u.fnWhere&&u.fnWhere.length>0)for(let x of u.fnWhere)O=O.pipe(oe(([T,w])=>x(w)));if(u.distinct&&!u.fnSelect&&!u.select)throw new It;if(u.fnSelect?O=O.pipe(F(([x,T])=>{let w=u.fnSelect(T);return[x,{...T,__select_results:w}]})):u.select?O=bo(O,u.select):O=O.pipe(F(([x,T])=>{let w=!u.join&&!u.groupBy?T[v]:T;return[x,{...T,__select_results:w}]})),u.groupBy&&u.groupBy.length>0?O=ji(O,u.groupBy,u.having,u.select,u.fnHaving):u.select&&Object.values(u.select).some(T=>T.type==="agg")&&(O=ji(O,[],u.having,u.select,u.fnHaving)),u.having&&(!u.groupBy||u.groupBy.length===0)&&!(u.select?Object.values(u.select).some(T=>T.type==="agg"):!1))throw new Mt;if(u.fnHaving&&u.fnHaving.length>0&&(!u.groupBy||u.groupBy.length===0))for(let x of u.fnHaving)O=O.pipe(oe(([T,w])=>x(w)));if(u.distinct&&(O=O.pipe(Ys(([x,T])=>T.__select_results))),u.orderBy&&u.orderBy.length>0){let w=So(r,O,u.orderBy,u.select||{},t[S],o,a,u.limit,u.offset).pipe(F(([L,[de,ae]])=>{let vr=de.__select_results,Sr=Ni(vr);return[L,[Sr,ae]]})),P={collectionId:S,pipeline:w,sourceWhereClauses:d,aliasToCollectionId:h,aliasRemapping:m};return c.set(r,P),P}else if(u.limit!==void 0||u.offset!==void 0)throw new Vt;let V=O.pipe(F(([x,T])=>{let w=T.__select_results,P=Ni(w);return[x,[P,void 0]]})),I={collectionId:S,pipeline:V,sourceWhereClauses:d,aliasToCollectionId:h,aliasRemapping:m};return c.set(r,I),I}function al(r,e,t,n,i,s,o,a,c,l,f,u){switch(r.type){case"collectionRef":{let d=e[r.alias];if(!d)throw new we(r.alias,r.collection.id,Object.keys(e));return f[r.alias]=r.collection.id,{alias:r.alias,input:d,collectionId:r.collection.id}}case"queryRef":{let d=l.get(r.query)||r.query,p=mr(d,e,t,n,i,s,o,a,c,l);Object.assign(f,p.aliasToCollectionId),Object.assign(u,p.aliasRemapping);let h=Object.keys(p.aliasToCollectionId).find(v=>p.aliasToCollectionId[v]===p.collectionId);h&&h!==r.alias&&(u[r.alias]=h);let y=p.pipeline.pipe(F(v=>{let[g,[S,O]]=v,E=Ni(S);return[g,E]}));return{alias:r.alias,input:y,collectionId:p.collectionId}}default:throw new Pt(r.type)}}function cl(r){return r instanceof $||r&&typeof r=="object"&&"type"in r&&r.type==="val"}function Ni(r){return cl(r)?r.value:r}function Wi(r,e,t){if(r.from.type==="queryRef"&&e.from.type==="queryRef"&&(t.set(r.from.query,e.from.query),Wi(r.from.query,e.from.query,t)),r.join&&e.join)for(let n=0;n<r.join.length&&n<e.join.length;n++){let i=r.join[n],s=e.join[n];i.from.type==="queryRef"&&s.from.type==="queryRef"&&(t.set(i.from.query,s.from.query),Wi(i.from.query,s.from.query,t))}}var Io=Symbol.for("@tanstack/db.collection-config-builder"),Wn=class{constructor(e,t,n,i){this.alias=e,this.collectionId=t,this.collection=n,this.collectionConfigBuilder=i,this.biggest=void 0,this.subscriptionLoadingPromises=new Map}subscribe(){let e=this.getWhereClauseForAlias();if(e){let t=zn(e,this.alias);if(t)return this.subscribeToChanges(t);throw new Qt(this.collectionId,this.alias)}return this.subscribeToChanges()}subscribeToChanges(e){let t,n=this.getOrderByInfo();if(n)t=this.subscribeToOrderedChanges(e,n);else{let o=!this.collectionConfigBuilder.isLazyAlias(this.alias);t=this.subscribeToMatchingChanges(e,o)}let i=t.on("status:change",o=>{if(o.status==="loadingSubset"){if(!this.subscriptionLoadingPromises.has(t)){let a,c=new Promise(l=>{a=l});this.subscriptionLoadingPromises.set(t,{resolve:a}),this.collectionConfigBuilder.liveQueryCollection._sync.trackLoadPromise(c)}}else{let a=this.subscriptionLoadingPromises.get(t);a&&(this.subscriptionLoadingPromises.delete(t),a.resolve())}}),s=()=>{let o=this.subscriptionLoadingPromises.get(t);o&&(this.subscriptionLoadingPromises.delete(t),o.resolve()),i(),t.unsubscribe()};return this.collectionConfigBuilder.currentSyncState.unsubscribeCallbacks.add(s),t}sendChangesToPipeline(e,t){let n=this.collectionConfigBuilder.currentSyncState.inputs[this.alias],s=ll(n,e,this.collection.config.getKey)>0?t:void 0;this.collectionConfigBuilder.scheduleGraphRun(s,{alias:this.alias})}subscribeToMatchingChanges(e,t=!1){let n=s=>{this.sendChangesToPipeline(s)};return this.collection.subscribeChanges(n,{includeInitialState:t,whereExpression:e})}subscribeToOrderedChanges(e,t){let{orderBy:n,offset:i,limit:s,comparator:o,dataNeeded:a,index:c}=t,l=d=>{let p=ul(d),h=p;a&&a()===0&&(h=pl(p,o,this.biggest)),this.sendChangesToPipelineWithTracking(h,f)},f=this.collection.subscribeChanges(l,{whereExpression:e});f.setOrderByIndex(c);let u=_i(n,this.alias);return f.requestLimitedSnapshot({limit:i+s,orderBy:u}),f}loadMoreIfNeeded(e){let t=this.getOrderByInfo();if(!t)return!0;let{dataNeeded:n}=t;if(!n)throw new Error(`Missing dataNeeded callback for collection ${this.collectionId}`);let i=n();return i>0&&this.loadNextItems(i,e),!0}sendChangesToPipelineWithTracking(e,t){let n=this.getOrderByInfo();if(!n){this.sendChangesToPipeline(e);return}let i=this.trackSentValues(e,n.comparator),s=t;s[Io]??=this.loadMoreIfNeeded.bind(this,t),this.sendChangesToPipeline(i,s[Io])}loadNextItems(e,t){let n=this.getOrderByInfo();if(!n)return;let{orderBy:i,valueExtractorForRawRow:s}=n,o=this.biggest,a=o&&s(o),c=_i(i,this.alias);t.requestLimitedSnapshot({orderBy:c,limit:e,minValue:a})}getWhereClauseForAlias(){let e=this.collectionConfigBuilder.sourceWhereClausesCache;if(e)return e.get(this.alias)}getOrderByInfo(){let e=this.collectionConfigBuilder.optimizableOrderByCollections[this.collectionId];if(e&&e.alias===this.alias)return e}*trackSentValues(e,t){for(let n of e)this.biggest?t(this.biggest,n.value)<0&&(this.biggest=n.value):this.biggest=n.value,yield n}};function ll(r,e,t){let n=[];for(let i of e){let s=t(i.value);i.type==="insert"?n.push([[s,i.value],1]):i.type==="update"?(n.push([[s,i.previousValue],-1]),n.push([[s,i.value],1])):n.push([[s,i.value],-1])}return n.length!==0&&r.sendData(new D(n)),n.length}function*ul(r){for(let e of r)e.type==="update"?(yield{type:"delete",key:e.key,value:e.previousValue},yield{type:"insert",key:e.key,value:e.value}):yield e}function*fl(r,e){for(let t of r)e(t)&&(yield t)}function*pl(r,e,t){yield*fl(r,n=>!t||e(n.value,t)<=0)}var Mo=new WeakMap;function Vo(r){return r.utils?.getBuilder?.()}function Po(r,e){Mo.set(r,e)}function ko(r){return Mo.get(r)}var dl=0,Ln=class{constructor(e){this.config=e,this.compiledAliasToCollectionId={},this.resultKeys=new WeakMap,this.orderByIndices=new WeakMap,this.isGraphRunning=!1,this.runCount=0,this.isInErrorState=!1,this.aliasDependencies={},this.builderDependencies=new Set,this.pendingGraphRuns=new Map,this.subscriptions={},this.lazySourcesCallbacks={},this.lazySources=new Set,this.optimizableOrderByCollections={},this.id=e.id||`live-query-${++dl}`,this.query=hl(e),this.collections=yl(this.query);let t=gl(this.query);this.collectionByAlias={};for(let[n,i]of t.entries()){let s=this.collections[n];if(s)for(let o of i)this.collectionByAlias[o]=s}this.query.orderBy&&this.query.orderBy.length>0&&(this.compare=ml(this.orderByIndices)),this.compileBasePipeline()}getConfig(){return{id:this.id,getKey:this.config.getKey||(e=>this.resultKeys.get(e)),sync:this.getSyncConfig(),compare:this.compare,gcTime:this.config.gcTime||5e3,schema:this.config.schema,onInsert:this.config.onInsert,onUpdate:this.config.onUpdate,onDelete:this.config.onDelete,startSync:this.config.startSync,singleResult:this.query.singleResult,utils:{getRunCount:this.getRunCount.bind(this),getBuilder:()=>this,setWindow:this.setWindow.bind(this),getWindow:this.getWindow.bind(this)}}}setWindow(e){if(!this.windowFn)throw new Zt;return this.currentWindow=e,this.windowFn(e),this.maybeRunGraphFn?.(),this.liveQueryCollection?.isLoadingSubset?new Promise(t=>{let n=this.liveQueryCollection.on("loadingSubset:change",i=>{i.isLoadingSubset||(n(),t())})}):!0}getWindow(){if(!(!this.windowFn||!this.currentWindow))return{offset:this.currentWindow.offset??0,limit:this.currentWindow.limit??0}}getCollectionIdForAlias(e){let t=this.compiledAliasToCollectionId[e];if(t)return t;let n=this.collectionByAlias[e];if(n)return n.id;throw new Error(`Unknown source alias "${e}"`)}isLazyAlias(e){return this.lazySources.has(e)}maybeRunGraph(e){if(!this.isGraphRunning){if(!this.currentSyncConfig||!this.currentSyncState)throw new Error("maybeRunGraph called without active sync session. This should not happen.");this.isGraphRunning=!0;try{let{begin:t,commit:n}=this.currentSyncConfig,i=this.currentSyncState;if(this.isInErrorState)return;if(i.subscribedToAllCollections){for(;i.graph.pendingWork();)i.graph.run(),e?.();i.messagesCount===0&&(t(),n(),this.updateLiveQueryStatus(this.currentSyncConfig))}}finally{this.isGraphRunning=!1}}}scheduleGraphRun(e,t){let n=t?.contextId??ve()?.id,i=t?.jobId??this,s=(()=>{if(t?.dependencies)return t.dependencies;let c=new Set(this.builderDependencies);if(t?.alias){let l=this.aliasDependencies[t.alias];if(l)for(let f of l)c.add(f)}return c.delete(this),Array.from(c)})();if(!this.currentSyncConfig||!this.currentSyncState)throw new Error("scheduleGraphRun called without active sync session. This should not happen.");let o=n?this.pendingGraphRuns.get(n):void 0;o||(o={loadCallbacks:new Set},n&&this.pendingGraphRuns.set(n,o)),e&&o.loadCallbacks.add(e);let a=n?void 0:o;ar.schedule({contextId:n,jobId:i,dependencies:s,run:()=>this.executeGraphRun(n,a)})}clearPendingGraphRun(e){this.pendingGraphRuns.delete(e)}executeGraphRun(e,t){let n=t??(e?this.pendingGraphRuns.get(e):void 0);if(e&&this.pendingGraphRuns.delete(e),!n||!this.currentSyncConfig||!this.currentSyncState)return;this.incrementRunCount();let i=()=>{let s=!0,o;if(n.loadCallbacks.forEach(a=>{try{s=a()&&s}catch(c){s=!1,o??=c}}),o)throw o;return s};this.maybeRunGraph(i)}getSyncConfig(){return{rowUpdateMode:"full",sync:this.syncFn.bind(this)}}incrementRunCount(){this.runCount++}getRunCount(){return this.runCount}syncFn(e){this.liveQueryCollection=e.collection,this.currentSyncConfig=e;let t={messagesCount:0,subscribedToAllCollections:!1,unsubscribeCallbacks:new Set},n=this.extendPipelineWithChangeProcessing(e,t);this.currentSyncState=n,this.unsubscribeFromSchedulerClears=ar.onClear(s=>{this.clearPendingGraphRun(s)});let i=this.subscribeToAllCollections(e,n);return this.maybeRunGraphFn=()=>this.scheduleGraphRun(i),this.scheduleGraphRun(i),()=>{t.unsubscribeCallbacks.forEach(s=>s()),this.currentSyncConfig=void 0,this.currentSyncState=void 0,this.pendingGraphRuns.clear(),this.graphCache=void 0,this.inputsCache=void 0,this.pipelineCache=void 0,this.sourceWhereClausesCache=void 0,this.lazySources.clear(),this.optimizableOrderByCollections={},this.lazySourcesCallbacks={},Object.keys(this.subscriptions).forEach(s=>delete this.subscriptions[s]),this.compiledAliasToCollectionId={},this.unsubscribeFromSchedulerClears?.(),this.unsubscribeFromSchedulerClears=void 0}}compileBasePipeline(){this.graphCache=new Kn,this.inputsCache=Object.fromEntries(Object.keys(this.collectionByAlias).map(n=>[n,this.graphCache.newInput()]));let e=mr(this.query,this.inputsCache,this.collections,this.subscriptions,this.lazySourcesCallbacks,this.lazySources,this.optimizableOrderByCollections,n=>{this.windowFn=n});this.pipelineCache=e.pipeline,this.sourceWhereClausesCache=e.sourceWhereClauses,this.compiledAliasToCollectionId=e.aliasToCollectionId;let t=Object.keys(this.compiledAliasToCollectionId).filter(n=>!Object.hasOwn(this.inputsCache,n));if(t.length>0)throw new Xt(t)}maybeCompileBasePipeline(){return(!this.graphCache||!this.inputsCache||!this.pipelineCache)&&this.compileBasePipeline(),{graph:this.graphCache,inputs:this.inputsCache,pipeline:this.pipelineCache}}extendPipelineWithChangeProcessing(e,t){let{begin:n,commit:i}=e,{graph:s,inputs:o,pipeline:a}=this.maybeCompileBasePipeline();return a.pipe(Js(c=>{let l=c.getInner();t.messagesCount+=l.length,n(),l.reduce(Tl,new Map).forEach(this.applyChanges.bind(this,e)),i()})),s.finalize(),t.graph=s,t.inputs=o,t.pipeline=a,t}applyChanges(e,t,n){let{write:i,collection:s}=e,{deletes:o,inserts:a,value:c,orderByIndex:l}=t;if(this.resultKeys.set(c,n),l!==void 0&&this.orderByIndices.set(c,l),a&&o===0)i({value:c,type:"insert"});else if(a>o||a===o&&s.has(s.getKeyFromItem(c)))i({value:c,type:"update"});else if(o>0)i({value:c,type:"delete"});else throw new Error(`Could not apply changes: ${JSON.stringify(t)}. This should never happen.`)}handleSourceStatusChange(e,t,n){let{status:i}=n;if(i==="error"){this.transitionToError(`Source collection '${t}' entered error state`);return}if(i==="cleaned-up"){this.transitionToError(`Source collection '${t}' was manually cleaned up while live query '${this.id}' depends on it. Live queries prevent automatic GC, so this was likely a manual cleanup() call.`);return}this.updateLiveQueryStatus(e)}updateLiveQueryStatus(e){let{markReady:t}=e;this.isInErrorState||this.allCollectionsReady()&&t()}transitionToError(e){this.isInErrorState=!0,console.error(`[Live Query Error] ${e}`),this.liveQueryCollection?._lifecycle.setStatus("error")}allCollectionsReady(){return Object.values(this.collections).every(e=>e.isReady())}subscribeToAllCollections(e,t){let n=Object.entries(this.compiledAliasToCollectionId);if(n.length===0)throw new Error(`Compiler returned no alias metadata for query '${this.id}'. This should not happen; please report.`);let i=n.map(([o,a])=>{let c=this.collectionByAlias[o]??this.collections[a],l=ko(c);l&&l!==this?(this.aliasDependencies[o]=[l],this.builderDependencies.add(l)):this.aliasDependencies[o]=[];let f=new Wn(o,a,c,this),u=c.on("status:change",h=>{this.handleSourceStatusChange(e,a,h)});t.unsubscribeCallbacks.add(u);let d=f.subscribe();return this.subscriptions[o]=d,f.loadMoreIfNeeded.bind(f,d)}),s=()=>(i.map(o=>o()),!0);return t.subscribedToAllCollections=!0,this.updateLiveQueryStatus(e),s}};function hl(r){return typeof r.query=="function"?Fs(r.query):Ti(r.query)}function ml(r){return(e,t)=>{let n=r.get(e),i=r.get(t);return n&&i?n<i?-1:n>i?1:0:0}}function yl(r){let e={};function t(i){i.type==="collectionRef"?e[i.collection.id]=i.collection:i.type==="queryRef"&&n(i.query)}function n(i){if(i.from&&t(i.from),i.join&&Array.isArray(i.join))for(let s of i.join)s.from&&t(s.from)}return n(r),e}function gl(r){let e=new Map;function t(i){if(i)if(i.type==="collectionRef"){let{id:s}=i.collection,o=e.get(s);o?o.add(i.alias):e.set(s,new Set([i.alias]))}else i.type==="queryRef"&&n(i.query)}function n(i){if(i&&(t(i.from),i.join))for(let s of i.join)t(s.from)}return n(r),e}function Tl(r,[[e,t],n]){let[i,s]=t,o=r.get(e)||{deletes:0,inserts:0,value:i,orderByIndex:s};return n<0?o.deletes+=Math.abs(n):n>0&&(o.inserts+=n,o.value=i,o.orderByIndex=s),r.set(e,o),r}function Un(r){return new Ln(r).getConfig()}function Ko(r){if(typeof r=="function"){let t=Un({query:r});return Co(t)}else{let e=r,t=Un(e);return e.utils&&(t.utils={...t.utils,...e.utils}),Co(t)}}function Co(r){let e=In(r),t=Vo(r);return t&&Po(e,t),e}var qi={};ii(qi,{ConcatOperator:()=>$r,ConsolidateOperator:()=>qr,CountOperator:()=>Qr,D2:()=>Gn,DebugOperator:()=>Hr,DistinctOperator:()=>Yr,FilterOperator:()=>Lr,JoinOperator:()=>Gr,MapOperator:()=>jr,MultiSet:()=>_,NegateOperator:()=>Ur,OutputOperator:()=>Jr,ReduceOperator:()=>Le,RootStreamBuilder:()=>Fr,StreamBuilder:()=>C,TapOperator:()=>Wr,TopKWithFractionalIndexOperator:()=>Xr,antiJoin:()=>qo,concat:()=>$o,consolidate:()=>Ie,count:()=>Xo,debug:()=>Ho,distinct:()=>Zo,filter:()=>Lo,filterBy:()=>la,fullJoin:()=>Yo,getIndex:()=>xr,getValue:()=>wr,groupBy:()=>jo,groupByOperators:()=>zo,indexedValue:()=>ri,innerJoin:()=>He,join:()=>$e,keyBy:()=>ea,leftJoin:()=>Go,map:()=>z,negate:()=>Uo,orderBy:()=>oa,orderByWithFractionalIndex:()=>ca,orderByWithFractionalIndexBase:()=>Ji,orderByWithIndex:()=>aa,output:()=>Jo,pipe:()=>No,reduce:()=>Ue,rekey:()=>ra,rightJoin:()=>Qo,tap:()=>Wo,topK:()=>Xn,topKWithFractionalIndex:()=>ni,topKWithIndex:()=>Zn,unkey:()=>ta});var Hn=class extends Map{constructor(e,t){super(t),this.defaultValue=e}get(e){return this.has(e)?super.get(e):this.defaultValue()}update(e,t){let n=this.get(e),i=t(n);return this.set(e,i),i}},Ui=3e4;function Jn(r,e){if(e.length<=Ui)r.push(...e);else for(let t=0;t<e.length;t+=Ui){let n=e.slice(t,t+Ui);r.push(...n)}}function Eo(r,e,t){let n=0,i=r.length;for(;n<i;){let s=Math.floor((n+i)/2),o=t(r[s],e);if(o<0)n=s+1;else if(o>0)i=s;else return s}return n}var $i=class{constructor(){this.objectIds=new WeakMap,this.nextId=0}getId(e){if(typeof e!="object"||e===null){let t=String(e),n=0;for(let i=0;i<t.length;i++){let s=t.charCodeAt(i);n=(n<<5)-n+s,n=n&n}return n}return this.objectIds.has(e)||this.objectIds.set(e,this.nextId++),this.objectIds.get(e)}getStringId(e){return e===null?"null":e===void 0?"undefined":typeof e!="object"?`str_${String(e)}`:`obj_${this.getId(e)}`}},yr=new $i;function Ro(r,e){let[t,n]=r,[i,s]=e,o=[...$n(t,Math.min(n,i)),...$n(Math.max(t,s),n)],a=[...$n(i,Math.min(s,t)),...$n(Math.max(i,n),s)];return{onlyInA:o,onlyInB:a}}function $n(r,e){let t=[];for(let n=r;n<e;n++)t.push(n);return t}var wl=q(),xl=q(),vl=q(),Sl=q(),bl=q();function q(){return Math.random()*(2**31-1)>>>0}var _o=new ArrayBuffer(8),Ol=new DataView(_o),Oe=new Uint8Array(_o),gr=class{constructor(){this.hash=wl,this.length=0,this.carry=0,this.carryBytes=0}_mix(e){e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e,this.hash=this.hash<<13|this.hash>>>19,this.hash=Math.imul(this.hash,5)+3864292196}_writeByte(e){this.carry|=(e&255)<<8*this.carryBytes,this.carryBytes++,this.length++,this.carryBytes===4&&(this._mix(this.carry>>>0),this.carry=0,this.carryBytes=0)}update(e){switch(typeof e){case"symbol":{this.update(bl);let t=e.description;if(!t)return;for(let n=0;n<t.length;n++){let i=t.charCodeAt(n);this._writeByte(i&255),this._writeByte(i>>>8&255)}return}case"string":this.update(xl);for(let t=0;t<e.length;t++){let n=e.charCodeAt(t);this._writeByte(n&255),this._writeByte(n>>>8&255)}return;case"number":Ol.setFloat64(0,e,!0),this._writeByte(Oe[0]),this._writeByte(Oe[1]),this._writeByte(Oe[2]),this._writeByte(Oe[3]),this._writeByte(Oe[4]),this._writeByte(Oe[5]),this._writeByte(Oe[6]),this._writeByte(Oe[7]);return;case"bigint":{let t=e;for(t<0n?(t=-t,this.update(Sl)):this.update(vl);t>0n;)this._writeByte(Number(t&0xffn)),t>>=8n;e===0n&&this._writeByte(0);return}default:throw new TypeError(`Unsupported input type: ${typeof e}`)}}digest(){if(this.carryBytes>0){let e=this.carry>>>0;e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e}return this.hash^=this.length,this.hash^=this.hash>>>16,this.hash=Math.imul(this.hash,2246822507),this.hash^=this.hash>>>13,this.hash=Math.imul(this.hash,3266489909),this.hash^=this.hash>>>16,this.hash>>>0}};var Il=q(),Ml=q(),Vl=q(),Pl=q(),kl=q(),Cl=q(),Kl=q(),El=q(),Rl=q(),_l=q(),Al=q(),Dr=new WeakMap;function W(r){let e=new gr;return Bo(e,r),e.digest()}function Bl(r){let e=Dr.get(r);if(e!==void 0)return e;let t;if(r instanceof Date)t=Dl(r);else{let n=r,i=El;if(r instanceof Array&&(i=Rl),r instanceof Map&&(i=_l,n=[...r.entries()]),r instanceof Set&&(i=Al,n=[...r.entries()]),typeof Buffer<"u"&&r instanceof Buffer||r instanceof Uint8Array||r instanceof File)return Do(r);t=Fl(n,i)}return Dr.set(r,t),t}function Dl(r){let e=new gr;return e.update(Kl),e.update(r.getTime()),e.digest()}function Fl(r,e){let t=new gr;t.update(e);let n=Object.keys(r);n.sort(zl);for(let i of n)t.update(kl),t.update(i),Bo(t,r[i]);return t.digest()}function Bo(r,e){if(e===null){r.update(Vl);return}switch(typeof e){case"undefined":r.update(Pl);return;case"boolean":r.update(e?Il:Ml);return;case"number":r.update(isNaN(e)?NaN:e===0?0:e);return;case"bigint":case"string":case"symbol":r.update(e);return;case"object":r.update(jl(e));return;case"function":r.update(Do(e));return;default:console.warn(`Ignored input during hashing because it is of type ${typeof e} which is not supported`)}}function jl(r){let e=Dr.get(r);return e===void 0&&(e=Bl(r)),e}var Ao=1;function Do(r){let e=Dr.get(r);return e===void 0&&(e=Ao^Cl,Ao++,Dr.set(r,e)),e}function zl(r,e){return r.localeCompare(e)}var _=class r{#e;constructor(e=[]){this.#e=e}toString(e=!1){return`MultiSet(${JSON.stringify(this.#e,null,e?2:void 0)})`}toJSON(){return JSON.stringify(Array.from(this.getInner()))}static fromJSON(e){return new r(JSON.parse(e))}map(e){return new r(this.#e.map(([t,n])=>[e(t),n]))}filter(e){return new r(this.#e.filter(([t,n])=>e(t)))}negate(){return new r(this.#e.map(([e,t])=>[e,-t]))}concat(e){let t=[];return Jn(t,this.#e),Jn(t,e.getInner()),new r(t)}consolidate(){if(this.#e.length>0){let e=this.#e[0]?.[0];if(Array.isArray(e)&&e.length===2)return this.#t()}return this.#r()}#t(){let e=new Map,t=new Map,n=s=>{if(s.length!==2)throw new Error("Expected tuple of length 2");let[o,a]=s;return`${yr.getStringId(o)}|${yr.getStringId(a)}`};for(let[s,o]of this.#e){if(!Array.isArray(s)||s.length!==2)return this.#r();let[a,c]=s;if(typeof a!="string"&&typeof a!="number")return this.#r();let l;Array.isArray(c)&&c.length===2?l=n(c):l=yr.getStringId(c);let f=a+"|"+l;e.set(f,(e.get(f)||0)+o),t.has(f)||t.set(f,s)}let i=[];for(let[s,o]of e)o!==0&&i.push([t.get(s),o]);return new r(i)}#r(){let e=new Hn(()=>0),t=new Map,n=!1,i=!1,s=!1;for(let[c,l]of this.#e)if(typeof c=="string")n=!0;else if(typeof c=="number")i=!0;else{s=!0;break}let o=s||n&&i;for(let[c,l]of this.#e){let f=o?W(c):c;o&&!t.has(f)&&t.set(f,c),e.update(f,u=>u+l)}let a=[];for(let[c,l]of e.entries())if(l!==0){let f=o?t.get(c):c;a.push([f,l])}return new r(a)}extend(e){let t=e instanceof r?e.getInner():e;Jn(this.#e,t)}add(e,t){t!==0&&this.#e.push([e,t])}getInner(){return this.#e}};var Hi=class{#e;constructor(e){this.#e=e}drain(){let e=[...this.#e].reverse();return this.#e.length=0,e}isEmpty(){return this.#e.length===0}},K=class{#e=[];sendData(e){e instanceof _||(e=new _(e));for(let t of this.#e)t.unshift(e)}newReader(){let e=[];return this.#e.push(e),new Hi(e)}},qn=class{constructor(e,t,n){this.id=e,this.inputs=t,this.output=n}hasPendingWork(){return this.inputs.some(e=>!e.isEmpty())}},X=class extends qn{constructor(e,t,n){super(e,[t],n),this.id=e}inputMessages(){return this.inputs[0].drain()}},Tr=class extends qn{constructor(e,t,n,i){super(e,[t,n],i),this.id=e}inputAMessages(){return this.inputs[0].drain()}inputBMessages(){return this.inputs[1].drain()}},fe=class extends X{run(){for(let e of this.inputMessages())this.output.sendData(this.inner(e))}};var Gn=class{#e=[];#t=0;#r=!1;constructor(){}#n(){if(this.#r)throw new Error("Graph already finalized")}getNextOperatorId(){return this.#n(),this.#t++}newInput(){this.#n();let e=new K;return new Fr(this,e)}addOperator(e){this.#n(),this.#e.push(e)}finalize(){this.#n(),this.#r=!0}step(){if(!this.#r)throw new Error("Graph not finalized");for(let e of this.#e)e.run()}pendingWork(){return this.#e.some(e=>e.hasPendingWork())}run(){for(;this.pendingWork();)this.step()}},C=class{#e;#t;constructor(e,t){this.#e=e,this.#t=t}connectReader(){return this.#t.newReader()}get writer(){return this.#t}get graph(){return this.#e}pipe(...e){return e.reduce((t,n)=>n(t),this)}},Fr=class extends C{sendData(e){this.writer.sendData(e)}};var jr=class extends fe{#e;constructor(e,t,n,i){super(e,t,n),this.#e=i}inner(e){return e.map(this.#e)}};function z(r){return e=>{let t=new C(e.graph,new K),n=new jr(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var zr=Symbol("NO_PREFIX"),Yn=class extends Map{addValue(e,t){if(t===0)return this.size===0;let n=Nr(e),i=this.get(n);if(Qn(i)){let[s,o]=i;if(Nr(s)!==n)throw new Error("Mismatching prefixes, this should never happen");if(s===e||W(s)===W(e)){let c=o+t;c===0?this.delete(n):this.set(n,[e,c])}else{let c=new We;c.set(W(s),i),c.set(W(e),[e,t]),this.set(n,c)}}else i===void 0?this.set(n,[e,t]):i.addValue(e,t)&&this.delete(n);return this.size===0}},We=class extends Map{addValue(e,t){if(t===0)return this.size===0;let n=W(e),i=this.get(n);if(i){let[,s]=i,o=s+t;o===0?this.delete(n):this.set(n,[e,o])}else this.set(n,[e,t]);return this.size===0}},pe=class r{#e;#t=new Map;constructor(){this.#e=new Map}static fromMultiSets(e){let t=new r;for(let n of e)for(let[i,s]of n.getInner()){let[o,a]=i;t.addValue(o,[a,s])}return t}toString(e=!1){return`Index(${JSON.stringify([...this.entries()],void 0,e?2:void 0)})`}get size(){return this.#e.size}has(e){return this.#e.has(e)}hasPresence(e){return(this.#t.get(e)||0)!==0}getConsolidatedMultiplicity(e){return this.#t.get(e)||0}getPresenceKeys(){return this.#t.keys()}get(e){return[...this.getIterator(e)]}*getIterator(e){let t=this.#e.get(e);if(Qn(t))yield t;else{if(t===void 0)return;if(t instanceof We)for(let n of t.values())yield n;else for(let n of t.values())if(Qn(n))yield n;else for(let i of n.values())yield i}}*entries(){for(let e of this.#e.keys())for(let t of this.getIterator(e))yield[e,t]}*entriesIterators(){for(let e of this.#e.keys())yield[e,this.getIterator(e)]}addValue(e,t){let[n,i]=t;if(i===0)return;let s=(this.#t.get(e)||0)+i;s===0?this.#t.delete(e):this.#t.set(e,s);let o=this.#e.get(e);if(o===void 0){this.#e.set(e,t);return}if(Qn(o)){this.#r(e,o,n,i);return}if(o instanceof We){let a=Nr(n);if(a!==zr){let c=new Yn;c.set(zr,o),c.set(a,t),this.#e.set(e,c)}else o.addValue(n,i)&&this.#e.delete(e)}else o.addValue(n,i)&&this.#e.delete(e)}#r(e,t,n,i){let[s,o]=t;if(s===n){let l=o+i;l===0?this.#e.delete(e):this.#e.set(e,[n,l]);return}let a=Nr(n),c=Nr(s);if(c===a&&(s===n||W(s)===W(n))){let l=o+i;l===0?this.#e.delete(e):this.#e.set(e,[n,l]);return}if(c===zr&&a===zr){let l=new We;l.set(W(s),t),l.set(W(n),[n,i]),this.#e.set(e,l)}else{let l=new Yn;if(c===a){let f=new We;f.set(W(s),t),f.set(W(n),[n,i]),l.set(c,f)}else l.set(c,t),l.set(a,[n,i]);this.#e.set(e,l)}}append(e){for(let[t,n]of e.entries())this.addValue(t,n)}join(e){let t=[];if(this.size<=e.size)for(let[n,i]of this.entriesIterators()){if(!e.has(n))continue;let s=e.get(n);for(let[o,a]of i)for(let[c,l]of s)a!==0&&l!==0&&t.push([[n,[o,c]],a*l])}else for(let[n,i]of e.entriesIterators()){if(!this.has(n))continue;let s=this.get(n);for(let[o,a]of i)for(let[c,l]of s)l!==0&&a!==0&&t.push([[n,[c,o]],l*a])}return new _(t)}};function Nr(r){return Array.isArray(r)&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="bigint")?r[0]:zr}function Qn(r){return Array.isArray(r)}var Le=class extends X{#e=new pe;#t=new pe;#r;constructor(e,t,n,i){super(e,t,n),this.#r=i}run(){let e=new Set;for(let n of this.inputMessages())for(let[i,s]of n.getInner()){let[o,a]=i;this.#e.addValue(o,[a,s]),e.add(o)}let t=[];for(let n of e){let i=this.#e.get(n),s=this.#t.get(n),o=this.#r(i),a=new Map,c=new Map;for(let[l,f]of o){let u=a.get(l)??0;a.set(l,u+f)}for(let[l,f]of s){let u=c.get(l)??0;c.set(l,u+f)}for(let[l,f]of c)a.has(l)||(t.push([[n,l],-f]),this.#t.addValue(n,[l,-f]));for(let[l,f]of a)c.has(l)||f!==0&&(t.push([[n,l],f]),this.#t.addValue(n,[l,f]));for(let[l,f]of a){let u=c.get(l);if(u!==void 0){let d=f-u;d!==0&&(t.push([[n,l],d]),this.#t.addValue(n,[l,d]))}}}t.length>0&&this.output.sendData(new _(t))}};function Ue(r){return e=>{let t=new C(e.graph,new K),n=new Le(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}function Fo(r){return"pipe"in r}function jo(r,e={}){let t=Object.fromEntries(Object.entries(e).filter(([n,i])=>!Fo(i)));return Object.fromEntries(Object.entries(e).filter(([n,i])=>Fo(i))),n=>{let i="__original_key__";return n.pipe(z(a=>{let c=r(a),l=JSON.stringify(c),f={};f[i]=c;for(let[u,d]of Object.entries(t))f[u]=d.preMap(a);return[l,f]})).pipe(Ue(a=>{let c=0;for(let[u,d]of a)c+=d;if(c<=0)return[];let l={},f=a[0]?.[0]?.[i];l[i]=f;for(let[u,d]of Object.entries(t)){let p=a.map(([h,m])=>[h[u],m]);l[u]=d.reduce(p)}return[[l,1]]})).pipe(z(([a,c])=>{let l=c[i],f={};Object.assign(f,l);for(let[u,d]of Object.entries(t))d.postMap?f[u]=d.postMap(c[u]):f[u]=c[u];return[a,f]}))}}function Nl(r=e=>e){return{preMap:e=>r(e),reduce:e=>{let t=0;for(let[n,i]of e)t+=n*i;return t}}}function Wl(r=e=>e){return{preMap:e=>r(e)==null?0:1,reduce:e=>{let t=0;for(let[n,i]of e)t+=n*i;return t}}}function Ll(r=e=>e){return{preMap:e=>({sum:r(e),count:0}),reduce:e=>{let t=0,n=0;for(let[i,s]of e)t+=i.sum*s,n+=s;return{sum:t,count:n}},postMap:e=>e.sum/e.count}}function Ul(r){let e=r??(t=>t);return{preMap:t=>e(t),reduce:t=>{let n;for(let[i,s]of t)(!n||i&&i<n)&&(n=i);return n}}}function $l(r){let e=r??(t=>t);return{preMap:t=>e(t),reduce:t=>{let n;for(let[i,s]of t)(!n||i&&i>n)&&(n=i);return n}}}function Hl(r=e=>e){return{preMap:e=>[r(e)],reduce:e=>{let t=[];for(let[n,i]of e)for(let s of n)for(let o=0;o<i;o++)t.push(s);return t.length===0?[]:(t.sort((n,i)=>n-i),t)},postMap:e=>{if(e.length===0)return 0;let t=Math.floor(e.length/2);return e.length%2===0?(e[t-1]+e[t])/2:e[t]}}}function Jl(r=e=>e){return{preMap:e=>{let t=r(e),n=new Map;return n.set(t,1),n},reduce:e=>{let t=new Map;for(let[n,i]of e)for(let[s,o]of n.entries()){let a=t.get(s)||0;t.set(s,a+o*i)}return t},postMap:e=>{if(e.size===0)return 0;let t=0,n=0;for(let[i,s]of e.entries())s>n&&(n=s,t=i);return t}}}var zo={sum:Nl,count:Wl,avg:Ll,min:Ul,max:$l,median:Hl,mode:Jl};function No(...r){return e=>e.pipe(...r)}var Wr=class extends fe{#e;constructor(e,t,n,i){super(e,t,n),this.#e=i}inner(e){return this.#e(e),e}};function Wo(r){return e=>{let t=new C(e.graph,new K),n=new Wr(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Lr=class extends fe{#e;constructor(e,t,n,i){super(e,t,n),this.#e=i}inner(e){return e.filter(this.#e)}};function Lo(r){return e=>{let t=new C(e.graph,new K),n=new Lr(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var Ur=class extends fe{inner(e){return e.negate()}};function Uo(){return r=>{let e=new C(r.graph,new K),t=new Ur(r.graph.getNextOperatorId(),r.connectReader(),e.writer);return r.graph.addOperator(t),e}}var $r=class extends Tr{run(){for(let e of this.inputAMessages())this.output.sendData(e);for(let e of this.inputBMessages())this.output.sendData(e)}};function $o(r){return e=>{if(e.graph!==r.graph)throw new Error("Cannot concat streams from different graphs");let t=new C(e.graph,new K),n=new $r(e.graph.getNextOperatorId(),e.connectReader(),r.connectReader(),t.writer);return e.graph.addOperator(n),t}}var Hr=class extends X{#e;#t;constructor(e,t,n,i,s=!1){super(e,t,n),this.#e=i,this.#t=s}run(){for(let e of this.inputMessages())console.log(`debug ${this.#e} data: ${e.toString(this.#t)}`),this.output.sendData(e)}};function Ho(r,e=!1){return t=>{let n=new C(t.graph,new K),i=new Hr(t.graph.getNextOperatorId(),t.connectReader(),n.writer,r,e);return t.graph.addOperator(i),n}}var Jr=class extends X{#e;constructor(e,t,n,i){super(e,t,n),this.#e=i}run(){for(let e of this.inputMessages())this.#e(e),this.output.sendData(e)}};function Jo(r){return e=>{let t=new C(e.graph,new K),n=new Jr(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}var qr=class extends X{run(){let e=this.inputMessages();if(e.length===0)return;let t=new _;for(let i of e)t.extend(i);let n=t.consolidate();n.getInner().length>0&&this.output.sendData(n)}};function Ie(){return r=>{let e=new C(r.graph,new K),t=new qr(r.graph.getNextOperatorId(),r.connectReader(),e.writer);return r.graph.addOperator(t),e}}var Gr=class extends Tr{#e=new pe;#t=new pe;#r;constructor(e,t,n,i,s="inner"){super(e,t,n,i),this.#r=s}run(){let e=pe.fromMultiSets(this.inputAMessages()),t=pe.fromMultiSets(this.inputBMessages());if(e.size===0&&t.size===0)return;let n=new _;this.#r!=="anti"&&this.emitInnerResults(e,t,n),(this.#r==="left"||this.#r==="full"||this.#r==="anti")&&this.emitLeftOuterResults(e,t,n),(this.#r==="right"||this.#r==="full")&&this.emitRightOuterResults(e,t,n),this.#e.append(e),this.#t.append(t),n.getInner().length>0&&this.output.sendData(n)}emitInnerResults(e,t,n){e.size>0&&n.extend(e.join(this.#t)),t.size>0&&n.extend(this.#e.join(t)),e.size>0&&t.size>0&&n.extend(e.join(t))}emitLeftOuterResults(e,t,n){if(e.size>0)for(let[i,s]of e.entriesIterators()){let o=this.#t.getConsolidatedMultiplicity(i),a=t.getConsolidatedMultiplicity(i);if(o+a===0)for(let[l,f]of s)f!==0&&n.add([i,[l,null]],f)}if(t.size>0)for(let i of t.getPresenceKeys()){let s=this.#t.getConsolidatedMultiplicity(i),o=t.getConsolidatedMultiplicity(i);if(o===0)continue;let a=s+o;if(s===0==(a===0))continue;let c=s===0;for(let[l,f]of this.#e.getIterator(i))f!==0&&n.add([i,[l,null]],c?-f:+f)}}emitRightOuterResults(e,t,n){if(t.size>0)for(let[i,s]of t.entriesIterators()){let o=this.#e.getConsolidatedMultiplicity(i),a=e.getConsolidatedMultiplicity(i);if(o+a===0)for(let[l,f]of s)f!==0&&n.add([i,[null,l]],f)}if(e.size>0)for(let i of e.getPresenceKeys()){let s=this.#e.getConsolidatedMultiplicity(i),o=e.getConsolidatedMultiplicity(i);if(o===0)continue;let a=s+o;if(s===0==(a===0))continue;let c=s===0;for(let[l,f]of this.#t.getIterator(i))f!==0&&n.add([i,[null,l]],c?-f:+f)}}};function $e(r,e="inner"){return t=>{if(t.graph!==r.graph)throw new Error("Cannot join streams from different graphs");let n=new C(t.graph,new K),i=new Gr(t.graph.getNextOperatorId(),t.connectReader(),r.connectReader(),n.writer,e);return t.graph.addOperator(i),n}}function He(r){return $e(r,"inner")}function qo(r){return $e(r,"anti")}function Go(r){return $e(r,"left")}function Qo(r){return $e(r,"right")}function Yo(r){return $e(r,"full")}var Qr=class extends Le{constructor(e,t,n){let i=s=>{let o=0;for(let[a,c]of s)o+=c;return[[o,1]]};super(e,t,n,i)}};function Xo(){return r=>{let e=new C(r.graph,new K),t=new Qr(r.graph.getNextOperatorId(),r.connectReader(),e.writer);return r.graph.addOperator(t),e}}var Yr=class extends X{#e;#t;constructor(e,t,n,i=s=>s){super(e,t,n),this.#e=i,this.#t=new Map}run(){let e=new Map;for(let n of this.inputMessages())for(let[i,s]of n.getInner()){let o=W(this.#e(i)),c=(e.get(o)?.[0]??this.#t.get(o)??0)+s;e.set(o,[c,i])}let t=[];for(let[n,[i,s]]of e.entries()){let o=this.#t.get(n)??0;i===0?this.#t.delete(n):this.#t.set(n,i),o<=0&&i>0?t.push([[W(this.#e(s)),s[1]],1]):o>0&&i<=0&&t.push([[W(this.#e(s)),s[1]],-1])}t.length>0&&this.output.sendData(new _(t))}};function Zo(r=e=>e){return e=>{let t=new C(e.graph,new K),n=new Yr(e.graph.getNextOperatorId(),e.connectReader(),t.writer,r);return e.graph.addOperator(n),t}}function ea(r){return z(e=>[r(e),e])}function ta(){return z(([r,e])=>e)}function ra(r){return z(([e,t])=>[r(t),t])}function Xn(r,e){let t=e?.limit??1/0,n=e?.offset??0;return i=>i.pipe(Ue(o=>new _(o).consolidate().getInner().sort((l,f)=>r(l[0],f[0])).slice(n,n+t)))}function Zn(r,e){let t=e?.limit??1/0,n=e?.offset??0;return i=>i.pipe(Ue(o=>{let a=new _(o).consolidate(),c=n;return a.getInner().sort((f,u)=>r(f[0],u[0])).slice(n,n+t).map(([f,u])=>[[f,c++],u])}))}var ti=class{#e=[];#t;#r;#n;constructor(e,t,n){this.#r=e,this.#n=e+t,this.#t=n}get size(){let e=this.#r,t=this.#n-this.#r,n=this.#e.length-e;return Math.max(0,Math.min(t,n))}move({offset:e,limit:t}){let n=this.#r,i=this.#n-this.#r,s=[this.#r,this.#n===1/0?this.#r+this.size:this.#n];this.#r=e??n,this.#n=this.#r+(t??i);let o=[this.#r,this.#n===1/0?Math.max(this.#r+this.size,s[1]):this.#n],{onlyInA:a,onlyInB:c}=Ro(s,o),l=[];c.forEach(u=>{let d=this.#e[u];d&&l.push(d)});let f=[];return a.forEach(u=>{let d=this.#e[u];d&&f.push(d)}),{moveIns:l,moveOuts:f,changes:a.length+c.length>0}}insert(e){let t={moveIn:null,moveOut:null},n=this.#i(e),i=n===0?null:xr(this.#e[n-1]),s=n===this.#e.length?null:xr(this.#e[n]),o=_n(i,s),a=ri(e,o);if(this.#e.splice(n,0,a),n<this.#n){let c=Math.max(n,this.#r);c<this.#e.length&&(t.moveIn=this.#e[c],this.#n<this.#e.length&&(t.moveOut=this.#e[this.#n]))}return t}delete(e){let t={moveIn:null,moveOut:null},n=this.#i(e),[i]=this.#e.splice(n,1);if(n<this.#n){if(t.moveOut=i,n<this.#r){let o=this.#r-1;o<this.#e.length?t.moveOut=this.#e[o]:t.moveOut=null}let s=this.#n-1;s<this.#e.length&&(t.moveIn=this.#e[s])}return t}#i(e){return Eo(this.#e,ri(e,""),(t,n)=>this.#t(wr(t),wr(n)))}},Xr=class extends X{#e=new Map;#t;constructor(e,t,n,i,s){super(e,t,n);let o=s.limit??1/0,a=s.offset??0,c=(l,f)=>{let u=i(ei(l),ei(f));if(u!==0)return u;let d=sa(l),p=sa(f);return d-p};this.#t=this.createTopK(a,o,c),s.setSizeCallback?.(()=>this.#t.size),s.setWindowFn?.(this.moveTopK.bind(this))}createTopK(e,t,n){return new ti(e,t,n)}moveTopK({offset:e,limit:t}){if(!(this.#t instanceof ti))throw new Error("Cannot move B+-tree implementation of TopK with fractional index");let n=[],i=this.#t.move({offset:e,limit:t});i.moveIns.forEach(s=>this.handleMoveIn(s,n)),i.moveOuts.forEach(s=>this.handleMoveOut(s,n)),i.changes&&this.output.sendData(new _(n))}run(){let e=[];for(let t of this.inputMessages())for(let[n,i]of t.getInner()){let[s,o]=n;this.processElement(s,o,i,e)}e.length>0&&this.output.sendData(new _(e))}processElement(e,t,n,i){let{oldMultiplicity:s,newMultiplicity:o}=this.addKey(e,n),a={moveIn:null,moveOut:null};if(s<=0&&o>0){let c=na(e,t);a=this.#t.insert(c)}else if(s>0&&o<=0){let c=na(e,t);a=this.#t.delete(c)}this.handleMoveIn(a.moveIn,i),this.handleMoveOut(a.moveOut,i)}handleMoveIn(e,t){if(e){let n=xr(e),i=wr(e),s=ia(i),o=ei(i);t.push([[s,[o,n]],1])}}handleMoveOut(e,t){if(e){let n=xr(e),i=wr(e),s=ia(i),o=ei(i);t.push([[s,[o,n]],-1])}}getMultiplicity(e){return this.#e.get(e)??0}addKey(e,t){let n=this.getMultiplicity(e),i=n+t;return i===0?this.#e.delete(e):this.#e.set(e,i),{oldMultiplicity:n,newMultiplicity:i}}};function ni(r,e){let t=e||{};return n=>{let i=new C(n.graph,new K),s=new Xr(n.graph.getNextOperatorId(),n.connectReader(),i.writer,r,t);return n.graph.addOperator(s),i}}function ri(r,e){return[r,e]}function wr(r){return r[0]}function xr(r){return r[1]}function na(r,e){return[r,e,yr.getId(r)]}function ia(r){return r[0]}function ei(r){return r[1]}function sa(r){return r[2]}function oa(r,e){let t=e?.limit??1/0,n=e?.offset??0,i=e?.comparator??((s,o)=>s===o?0:s<o?-1:1);return s=>s.pipe(z(([o,a])=>[null,[o,r(a)]]),Xn((o,a)=>i(o[1],a[1]),{limit:t,offset:n}),z(([o,[a]])=>[a,null]),He(s),z(([o,a])=>[o,a[1]]),Ie())}function aa(r,e){let t=e?.limit??1/0,n=e?.offset??0,i=e?.comparator??((s,o)=>s===o?0:s<o?-1:1);return s=>s.pipe(z(([o,a])=>[null,[o,r(a)]]),Zn((o,a)=>i(o[1],a[1]),{limit:t,offset:n}),z(([o,[[a],c]])=>[a,c]),He(s),z(([o,[a,c]])=>[o,[c,a]]),Ie())}function Ji(r,e,t){let n=t?.limit??1/0,i=t?.offset??0,s=t?.setSizeCallback,o=t?.setWindowFn,a=t?.comparator??((c,l)=>c===l?0:c<l?-1:1);return c=>c.pipe(r((l,f)=>a(e(l),e(f)),{limit:n,offset:i,setSizeCallback:s,setWindowFn:o}),Ie())}function ca(r,e){return Ji(ni,r,e)}function la(r){return e=>{let t=r.pipe(z(([n,i])=>[n,null]));return e.pipe(He(t),z(([n,[i,s]])=>[n,i]),Ie())}}console.log(Li,qi);

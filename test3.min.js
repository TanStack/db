var D=class{},fe=class extends D{constructor(e,t){super(),this.collection=e,this.alias=t,this.type="collectionRef"}},pe=class extends D{constructor(e,t){super(),this.query=e,this.alias=t,this.type="queryRef"}},q=class extends D{constructor(e){super(),this.path=e,this.type="ref"}},A=class extends D{constructor(e){super(),this.value=e,this.type="val"}},K=class extends D{constructor(e,t){super(),this.name=e,this.args=t,this.type="func"}},B=class extends D{constructor(e,t){super(),this.name=e,this.args=t,this.type="agg"}};function Pt(n){return n instanceof B||n instanceof K||n instanceof q||n instanceof A}var E=class extends Error{constructor(e){super(e),this.name="TanStackDBError"}};var Z=class extends E{constructor(e,t,s){let i=`${e==="insert"?"Insert":"Update"} validation failed: ${t.map(r=>`
- ${r.message} - path: ${r.path}`).join("")}`;super(s||i),this.name="SchemaValidationError",this.type=e,this.issues=t}},F=class extends E{constructor(e){super(e),this.name="CollectionConfigurationError"}},ye=class extends F{constructor(){super("Collection requires a config")}},me=class extends F{constructor(){super("Collection requires a sync config")}},ge=class extends F{constructor(){super("Schema must implement the standard-schema interface")}},X=class extends F{constructor(){super("Schema validation must be synchronous")}},z=class extends E{constructor(e){super(e),this.name="CollectionStateError"}},xe=class extends z{constructor(e,t){super(`Cannot perform ${e} on collection "${t}" - collection is in error state. Try calling cleanup() and restarting the collection.`)}},ve=class extends z{constructor(e,t,s){super(`Invalid collection status transition from "${e}" to "${t}" for collection "${s}"`)}},we=class extends z{constructor(){super("Collection is in error state")}},Se=class extends z{constructor(){super("Active subscribers count is negative - this should never happen")}},O=class extends E{constructor(e){super(e),this.name="CollectionOperationError"}},be=class extends O{constructor(e){super(`An object was created without a defined key: ${JSON.stringify(e)}`)}},ke=class extends O{constructor(e){super(`Cannot insert document with ID "${e}" because it already exists in the collection`)}},Ce=class extends O{constructor(e,t){super(`Cannot insert document with key "${e}" from sync because it already exists in the collection "${t}"`)}},_e=class extends O{constructor(){super("The first argument to update is missing")}},Ie=class extends O{constructor(){super("No keys were passed to update")}},Ee=class extends O{constructor(e){super(`The key "${e}" was passed to update but an object for this key was not found in the collection`)}},Oe=class extends O{constructor(e,t){super(`Updating the key of an item is not allowed. Original key: "${e}", Attempted new key: "${t}". Please delete the old item and create a new one if a key change is necessary.`)}},Pe=class extends O{constructor(){super("No keys were passed to delete")}},Te=class extends O{constructor(e){super(`Collection.delete was called with key '${e}' but there is no item in the collection with this key`)}},ee=class extends E{constructor(e){super(e),this.name="MissingHandlerError"}},Re=class extends ee{constructor(){super("Collection.insert called directly (not within an explicit transaction) but no 'onInsert' handler is configured.")}},Ae=class extends ee{constructor(){super("Collection.update called directly (not within an explicit transaction) but no 'onUpdate' handler is configured.")}},Ke=class extends ee{constructor(){super("Collection.delete called directly (not within an explicit transaction) but no 'onDelete' handler is configured.")}},T=class extends E{constructor(e){super(e),this.name="TransactionError"}},Me=class extends T{constructor(){super("mutationFn is required when creating a transaction")}},De=class extends T{constructor(){super("You can no longer call .mutate() as the transaction is no longer pending")}},Fe=class extends T{constructor(){super("You can no longer call .rollback() as the transaction is already completed")}},ze=class extends T{constructor(){super("You can no longer call .commit() as the transaction is no longer pending")}},te=class extends T{constructor(){super("No pending sync transaction to write to")}},se=class extends T{constructor(){super("The pending sync transaction is already committed, you can't still write to it.")}},Le=class extends T{constructor(){super("No pending sync transaction to commit")}},qe=class extends T{constructor(){super("The pending sync transaction is already committed, you can't commit it again.")}},$=class extends E{constructor(e){super(e),this.name="QueryBuilderError"}},$e=class extends ${constructor(e){super(`Only one source is allowed in the ${e}`)}},Ve=class extends ${constructor(e){super(`A sub query passed to a ${e} must have a from clause itself`)}},Ue=class extends ${constructor(e){super(`Invalid source for live query: The value provided for alias "${e}" is not a Collection or subquery. Live queries only accept Collection instances or subqueries. Please ensure you're passing a valid Collection or QueryBuilder, not a plain array or other data type.`)}},je=class extends ${constructor(){super("Join condition must be an equality expression")}},Ne=class extends ${constructor(){super("Query must have a from clause")}},ne=class extends E{constructor(e){super(e),this.name="QueryCompilationError"}};var Be=class extends ne{constructor(e){super(`Unknown expression type: ${e}`)}},Qe=class extends ne{constructor(){super("Reference path cannot be empty")}},We=class extends ne{constructor(e){super(`Unknown function: ${e}`)}};var re=class extends E{constructor(e,t){let s=t instanceof Error?t.message:String(t);super(`Collection "${e}" sync cleanup function threw an error: ${s}`),this.name="SyncCleanupError"}};var ft=new WeakMap,Jt=1;function Tt(n){if(ft.has(n))return ft.get(n);let e=Jt++;return ft.set(n,e),e}var pt=(n,e,t)=>{let{nulls:s}=t;if(n==null&&e==null)return 0;if(n==null)return s==="first"?-1:1;if(e==null)return s==="first"?1:-1;if(typeof n=="string"&&typeof e=="string"&&t.stringSort==="locale")return n.localeCompare(e,t.locale,t.localeOptions);if(Array.isArray(n)&&Array.isArray(e)){for(let o=0;o<Math.min(n.length,e.length);o++){let a=pt(n[o],e[o],t);if(a!==0)return a}return n.length-e.length}if(n instanceof Date&&e instanceof Date)return n.getTime()-e.getTime();let i=typeof n=="object",r=typeof e=="object";if(i||r){if(i&&r){let o=Tt(n),a=Tt(e);return o-a}if(i)return 1;if(r)return-1}return n<e?-1:n>e?1:0},Yt=(n,e,t)=>pt(e,n,{...t,nulls:t.nulls==="first"?"last":"first"});function yt(n){return(e,t)=>n.direction==="asc"?pt(e,t,n):Yt(e,t,n)}var mt=yt({direction:"asc",nulls:"first",stringSort:"locale"});function P(n){return n instanceof Date?n.getTime():n}function ie(n){return At(n,!0)}function At(n,e){switch(n.type){case"val":{let t=n.value;return()=>t}case"ref":return e?Xt(n):Zt(n);case"func":return es(n,e);default:throw new Be(n.type)}}function Zt(n){let[e,...t]=n.path;if(!e)throw new Qe;if(t.length===0)return s=>s[e];if(t.length===1){let s=t[0];return i=>i[e]?.[s]}else return s=>{let i=s[e];if(i===void 0)return;let r=i;for(let o of t){if(r==null)return r;r=r[o]}return r}}function Xt(n){let e=n.path;return t=>{let s=t;for(let i of e){if(s==null)return s;s=s[i]}return s}}function es(n,e){let t=n.args.map(s=>At(s,e));switch(n.name){case"eq":{let s=t[0],i=t[1];return r=>{let o=P(s(r)),a=P(i(r));return o===a}}case"gt":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return o>a}}case"gte":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return o>=a}}case"lt":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return o<a}}case"lte":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return o<=a}}case"and":return s=>{for(let i of t)if(!i(s))return!1;return!0};case"or":return s=>{for(let i of t)if(i(s))return!0;return!1};case"not":{let s=t[0];return i=>!s(i)}case"in":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return Array.isArray(a)?a.includes(o):!1}}case"like":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return Rt(o,a,!1)}}case"ilike":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return Rt(o,a,!0)}}case"upper":{let s=t[0];return i=>{let r=s(i);return typeof r=="string"?r.toUpperCase():r}}case"lower":{let s=t[0];return i=>{let r=s(i);return typeof r=="string"?r.toLowerCase():r}}case"length":{let s=t[0];return i=>{let r=s(i);return typeof r=="string"||Array.isArray(r)?r.length:0}}case"concat":return s=>t.map(i=>{let r=i(s);try{return String(r??"")}catch{try{return JSON.stringify(r)||""}catch{return"[object]"}}}).join("");case"coalesce":return s=>{for(let i of t){let r=i(s);if(r!=null)return r}return null};case"add":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return(o??0)+(a??0)}}case"subtract":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return(o??0)-(a??0)}}case"multiply":{let s=t[0],i=t[1];return r=>{let o=s(r),a=i(r);return(o??0)*(a??0)}}case"divide":{let s=t[0],i=t[1];return r=>{let o=s(r),c=i(r)??0;return c!==0?(o??0)/c:null}}case"isUndefined":{let s=t[0];return i=>s(i)===void 0}case"isNull":{let s=t[0];return i=>s(i)===null}default:throw new We(n.name)}}function Rt(n,e,t){if(typeof n!="string"||typeof e!="string")return!1;let s=t?n.toLowerCase():n,r=(t?e.toLowerCase():e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return r=r.replace(/%/g,".*"),r=r.replace(/_/g,"."),new RegExp(`^${r}$`).test(s)}function C(n,e){return He(n,e,new Map)}function He(n,e,t){if(n===e)return!0;if(n==null||e==null||typeof n!=typeof e)return!1;if(n instanceof Date)return e instanceof Date?n.getTime()===e.getTime():!1;if(n instanceof RegExp)return e instanceof RegExp?n.source===e.source&&n.flags===e.flags:!1;if(n instanceof Map){if(!(e instanceof Map)||n.size!==e.size)return!1;if(t.has(n))return t.get(n)===e;t.set(n,e);let i=Array.from(n.entries()).every(([r,o])=>e.has(r)&&He(o,e.get(r),t));return t.delete(n),i}if(n instanceof Set){if(!(e instanceof Set)||n.size!==e.size)return!1;if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Array.from(n),i=Array.from(e);if(s.every(o=>typeof o!="object"))return t.delete(n),s.every(o=>e.has(o));let r=s.length===i.length;return t.delete(n),r}if(ArrayBuffer.isView(n)&&ArrayBuffer.isView(e)&&!(n instanceof DataView)&&!(e instanceof DataView)){let s=n,i=e;if(s.length!==i.length)return!1;for(let r=0;r<s.length;r++)if(s[r]!==i[r])return!1;return!0}if(oe(n)&&oe(e)){let s=gt(n),i=gt(e);return s!==i?!1:typeof n.equals=="function"?n.equals(e):n.toString()===e.toString()}if(Array.isArray(n)){if(!Array.isArray(e)||n.length!==e.length)return!1;if(t.has(n))return t.get(n)===e;t.set(n,e);let s=n.every((i,r)=>He(i,e[r],t));return t.delete(n),s}if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);if(s.length!==i.length)return t.delete(n),!1;let r=s.every(o=>o in e&&He(n[o],e[o],t));return t.delete(n),r}return!1}var ts=["Temporal.Duration","Temporal.Instant","Temporal.PlainDate","Temporal.PlainDateTime","Temporal.PlainMonthDay","Temporal.PlainTime","Temporal.PlainYearMonth","Temporal.ZonedDateTime"];function gt(n){return n[Symbol.toStringTag]}function oe(n){let e=gt(n);return typeof e=="string"&&ts.includes(e)}var Q={direction:"asc",nulls:"first",stringSort:"locale"};var Ge=class{constructor(e){this.originalIndex=e}lookup(e,t){let s=e==="gt"?"lt":e==="gte"?"lte":e==="lt"?"gt":e==="lte"?"gte":e;return this.originalIndex.lookup(s,t)}rangeQuery(e={}){return this.originalIndex.rangeQueryReversed(e)}rangeQueryReversed(e={}){return this.originalIndex.rangeQuery(e)}take(e,t,s){return this.originalIndex.takeReversed(e,t,s)}takeReversed(e,t,s){return this.originalIndex.take(e,t,s)}get orderedEntriesArray(){return this.originalIndex.orderedEntriesArrayReversed}get orderedEntriesArrayReversed(){return this.originalIndex.orderedEntriesArray}supports(e){return this.originalIndex.supports(e)}matchesField(e){return this.originalIndex.matchesField(e)}matchesCompareOptions(e){return this.originalIndex.matchesCompareOptions(e)}matchesDirection(e){return this.originalIndex.matchesDirection(e)}getStats(){return this.originalIndex.getStats()}add(e,t){this.originalIndex.add(e,t)}remove(e,t){this.originalIndex.remove(e,t)}update(e,t,s){this.originalIndex.update(e,t,s)}build(e){this.originalIndex.build(e)}clear(){this.originalIndex.clear()}get keyCount(){return this.originalIndex.keyCount}equalityLookup(e){return this.originalIndex.equalityLookup(e)}inArrayLookup(e){return this.originalIndex.inArrayLookup(e)}get indexedKeysSet(){return this.originalIndex.indexedKeysSet}get valueMapData(){return this.originalIndex.valueMapData}};function ae(n,e,t=Q){for(let s of n.values())if(s.matchesField(e)&&s.matchesCompareOptions(t))return s.matchesDirection(t.direction)?s:new Ge(s)}function ss(n){if(n.length===0)return new Set;if(n.length===1)return new Set(n[0]);let e=new Set(n[0]);for(let t=1;t<n.length;t++){let s=new Set;for(let i of e)n[t].has(i)&&s.add(i);e=s}return e}function ns(n){let e=new Set;for(let t of n)for(let s of t)e.add(s);return e}function Kt(n,e){return xt(n,e)}function xt(n,e){if(n.type==="func")switch(n.name){case"eq":case"gt":case"gte":case"lt":case"lte":return is(n,e);case"and":return os(n,e);case"or":return as(n,e);case"in":return cs(n,e)}return{canOptimize:!1,matchingKeys:new Set}}function rs(n,e){if(n.type!=="func"||n.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=new Map;for(let s of n.args)if(s.type==="func"&&["gt","gte","lt","lte"].includes(s.name)){let i=s;if(i.args.length===2){let r=i.args[0],o=i.args[1],a=null,c=null,l=i.name;if(r.type==="ref"&&o.type==="val")a=r,c=o;else if(r.type==="val"&&o.type==="ref")switch(a=o,c=r,l){case"gt":l="lt";break;case"gte":l="lte";break;case"lt":l="gt";break;case"lte":l="gte";break}if(a&&c){let h=a.path.join("."),f=c.value;t.has(h)||t.set(h,[]),t.get(h).push({operation:l,value:f})}}}for(let[s,i]of t)if(i.length>=2){let r=s.split("."),o=ae(e,r);if(o&&o.supports("gt")&&o.supports("lt")){let a,c,l=!0,p=!0;for(let{operation:f,value:u}of i)switch(f){case"gt":(a===void 0||u>a)&&(a=u,l=!1);break;case"gte":(a===void 0||u>a)&&(a=u,l=!0);break;case"lt":(c===void 0||u<c)&&(c=u,p=!1);break;case"lte":(c===void 0||u<c)&&(c=u,p=!0);break}return{canOptimize:!0,matchingKeys:o.rangeQuery({from:a,to:c,fromInclusive:l,toInclusive:p})}}}return{canOptimize:!1,matchingKeys:new Set}}function is(n,e){if(n.type!=="func"||n.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let t=n.args[0],s=n.args[1],i=null,r=null,o=n.name;if(t.type==="ref"&&s.type==="val")i=t,r=s;else if(t.type==="val"&&s.type==="ref")switch(i=s,r=t,o){case"gt":o="lt";break;case"gte":o="lte";break;case"lt":o="gt";break;case"lte":o="gte";break}if(i&&r){let a=i.path,c=ae(e,a);if(c){let l=r.value,p=o;return c.supports(p)?{canOptimize:!0,matchingKeys:c.lookup(p,l)}:{canOptimize:!1,matchingKeys:new Set}}}return{canOptimize:!1,matchingKeys:new Set}}function os(n,e){if(n.type!=="func"||n.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=rs(n,e);if(t.canOptimize)return t;let s=[];for(let i of n.args){let r=xt(i,e);r.canOptimize&&s.push(r)}if(s.length>0){let i=s.map(o=>o.matchingKeys);return{canOptimize:!0,matchingKeys:ss(i)}}return{canOptimize:!1,matchingKeys:new Set}}function as(n,e){if(n.type!=="func"||n.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let t=[];for(let s of n.args){let i=xt(s,e);i.canOptimize&&t.push(i)}if(t.length>0){let s=t.map(r=>r.matchingKeys);return{canOptimize:!0,matchingKeys:ns(s)}}return{canOptimize:!1,matchingKeys:new Set}}function cs(n,e){if(n.type!=="func"||n.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let t=n.args[0],s=n.args[1];if(t.type==="ref"&&s.type==="val"&&Array.isArray(s.value)){let i=t.path,r=s.value,o=ae(e,i);if(o){if(o.supports("in"))return{canOptimize:!0,matchingKeys:o.lookup("in",r)};if(o.supports("eq")){let a=new Set;for(let c of r){let l=o.lookup("eq",c);for(let p of l)a.add(p)}return{canOptimize:!0,matchingKeys:a}}}}return{canOptimize:!1,matchingKeys:new Set}}var Je=class{constructor(e,t,s){this._root=vt,this._size=0,this._maxNodeSize=s>=4?Math.min(s,256):32,this._compare=e,t&&this.setPairs(t)}get size(){return this._size}get length(){return this._size}get isEmpty(){return this._size===0}clear(){this._root=vt,this._size=0}get(e,t){return this._root.get(e,t,this)}set(e,t,s){this._root.isShared&&(this._root=this._root.clone());let i=this._root.set(e,t,s,this);return i===!0||i===!1?i:(this._root=new wt([this._root,i]),!0)}has(e){return this.forRange(e,e,!0,void 0)!==0}delete(e){return this.editRange(e,e,!0,us)!==0}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}keysArray(){let e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(t,s)=>{e.push(t)}),e}nextHigherPair(e,t){return t=t||[],e===void 0?this._root.minPair(t):this._root.getPairOrNextHigher(e,this._compare,!1,t)}nextHigherKey(e){let t=this.nextHigherPair(e,Mt);return t&&t[0]}nextLowerPair(e,t){return t=t||[],e===void 0?this._root.maxPair(t):this._root.getPairOrNextLower(e,this._compare,!1,t)}nextLowerKey(e){let t=this.nextLowerPair(e,Mt);return t&&t[0]}setPairs(e,t){let s=0;for(let i of e)this.set(i[0],i[1],t)&&s++;return s}forRange(e,t,s,i,r){let o=this._root.forRange(e,t,s,!1,this,r||0,i);return typeof o=="number"?o:o.break}editRange(e,t,s,i,r){let o=this._root;o.isShared&&(this._root=o=o.clone());try{let a=o.forRange(e,t,s,!0,this,r||0,i);return typeof a=="number"?a:a.break}finally{let a;for(;o.keys.length<=1&&!o.isLeaf;)a||=o.isShared,this._root=o=o.keys.length===0?vt:o.children[0];a&&(o.isShared=!0)}}},Ye=class n{get isLeaf(){return this.children===void 0}constructor(e=[],t){this.keys=e,this.values=t||b,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,t,s){let i=this.keys,r=0,o=i.length,a=o>>1;for(;r<o;){let c=s(i[a],e);if(c<0)r=a+1;else if(c>0)o=a;else{if(c===0)return a;if(e===e)return i.length;throw new Error("BTree: NaN was used as a key")}a=r+o>>1}return a^t}minKey(){return this.keys[0]}minPair(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(this.keys.length===0)return;let t=this.keys.length-1;return e[0]=this.keys[t],e[1]=this.values[t],e}clone(){let e=this.values;return new n(this.keys.slice(0),e===b?e:e.slice(0))}get(e,t,s){let i=this.indexOf(e,-1,s._compare);return i<0?t:this.values[i]}getPairOrNextLower(e,t,s,i){let r=this.indexOf(e,-1,t),o=r<0?~r-1:s?r:r-1;if(o>=0)return i[0]=this.keys[o],i[1]=this.values[o],i}getPairOrNextHigher(e,t,s,i){let r=this.indexOf(e,-1,t),o=r<0?~r:s?r:r+1,a=this.keys;if(o<a.length)return i[0]=a[o],i[1]=this.values[o],i}set(e,t,s,i){let r=this.indexOf(e,-1,i._compare);if(r<0){if(r=~r,i._size++,this.keys.length<i._maxNodeSize)return this.insertInLeaf(r,e,t,i);{let o=this.splitOffRightSide(),a=this;return r>this.keys.length&&(r-=this.keys.length,a=o),a.insertInLeaf(r,e,t,i),o}}else return s!==!1&&(t!==void 0&&this.reifyValues(),this.keys[r]=e,this.values[r]=t),!1}reifyValues(){return this.values===b?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,t,s,i){if(this.keys.splice(e,0,t),this.values===b){for(;b.length<i._maxNodeSize;)b.push(void 0);if(s===void 0)return!0;this.values=b.slice(0,this.keys.length-1)}return this.values.splice(e,0,s),!0}takeFromRight(e){let t=this.values;e.values===b?t!==b&&t.push(void 0):(t=this.reifyValues(),t.push(e.values.shift())),this.keys.push(e.keys.shift())}takeFromLeft(e){let t=this.values;e.values===b?t!==b&&t.unshift(void 0):(t=this.reifyValues(),t.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())}splitOffRightSide(){let e=this.keys.length>>1,t=this.keys.splice(e),s=this.values===b?b:this.values.splice(e);return new n(t,s)}forRange(e,t,s,i,r,o,a){let c=r._compare,l,p;if(t===e){if(!s||(p=(l=this.indexOf(e,-1,c))+1,l<0))return o}else l=this.indexOf(e,0,c),p=this.indexOf(t,-1,c),p<0?p=~p:s===!0&&p++;let h=this.keys,f=this.values;if(a!==void 0)for(let u=l;u<p;u++){let d=h[u],y=a(d,f[u],o++);if(y!==void 0){if(i===!0){if(d!==h[u]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");y.delete?(this.keys.splice(u,1),this.values!==b&&this.values.splice(u,1),r._size--,u--,p--):y.hasOwnProperty("value")&&(f[u]=y.value)}if(y.break!==void 0)return y}}else o+=p-l;return o}mergeSibling(e,t){if(this.keys.push.apply(this.keys,e.keys),this.values===b){if(e.values===b)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}},wt=class n extends Ye{constructor(e,t){if(!t){t=[];for(let s=0;s<e.length;s++)t[s]=e[s].maxKey()}super(t),this.children=e}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,t,s){let i=this.indexOf(e,0,s._compare),r=this.children;return i<r.length?r[i].get(e,t,s):void 0}getPairOrNextLower(e,t,s,i){let r=this.indexOf(e,0,t),o=this.children;if(r>=o.length)return this.maxPair(i);let a=o[r].getPairOrNextLower(e,t,s,i);return a===void 0&&r>0?o[r-1].maxPair(i):a}getPairOrNextHigher(e,t,s,i){let r=this.indexOf(e,0,t),o=this.children,a=o.length;if(r>=a)return;let c=o[r].getPairOrNextHigher(e,t,s,i);return c===void 0&&r<a-1?o[r+1].minPair(i):c}set(e,t,s,i){let r=this.children,o=i._maxNodeSize,a=i._compare,c=Math.min(this.indexOf(e,0,a),r.length-1),l=r[c];if(l.isShared&&(r[c]=l=l.clone()),l.keys.length>=o){let h;c>0&&(h=r[c-1]).keys.length<o&&a(l.keys[0],e)<0?(h.isShared&&(r[c-1]=h=h.clone()),h.takeFromRight(l),this.keys[c-1]=h.maxKey()):(h=r[c+1])!==void 0&&h.keys.length<o&&a(l.maxKey(),e)<0&&(h.isShared&&(r[c+1]=h=h.clone()),h.takeFromLeft(l),this.keys[c]=r[c].maxKey())}let p=l.set(e,t,s,i);if(p===!1)return!1;if(this.keys[c]=l.maxKey(),p===!0)return!0;if(this.keys.length<o)return this.insert(c+1,p),!0;{let h=this.splitOffRightSide(),f=this;return a(p.maxKey(),this.maxKey())>0&&(f=h,c-=this.keys.length),f.insert(c+1,p),h}}insert(e,t){this.children.splice(e,0,t),this.keys.splice(e,0,t.maxKey())}splitOffRightSide(){let e=this.children.length>>1;return new n(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,t,s,i,r,o,a){let c=r._compare,l=this.keys,p=this.children,h=this.indexOf(e,0,c),f=h,u=Math.min(t===e?h:this.indexOf(t,0,c),l.length-1);if(i){if(f<=u)try{for(;f<=u;f++){p[f].isShared&&(p[f]=p[f].clone());let d=p[f].forRange(e,t,s,i,r,o,a);if(l[f]=p[f].maxKey(),typeof d!="number")return d;o=d}}finally{let d=r._maxNodeSize>>1;for(h>0&&h--,f=u;f>=h;f--)p[f].keys.length<=d&&(p[f].keys.length!==0?this.tryMerge(f,r._maxNodeSize):(l.splice(f,1),p.splice(f,1)));p.length!==0&&p[0].keys.length===0&&hs(!1,"emptiness bug")}}else for(;f<=u;f++){let d=p[f].forRange(e,t,s,i,r,o,a);if(typeof d!="number")return d;o=d}return o}tryMerge(e,t){let s=this.children;return e>=0&&e+1<s.length&&s[e].keys.length+s[e+1].keys.length<=t?(s[e].isShared&&(s[e]=s[e].clone()),s[e].mergeSibling(s[e+1],t),s.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=s[e].maxKey(),!0):!1}mergeSibling(e,t){let s=this.keys.length;this.keys.push.apply(this.keys,e.keys);let i=e.children;if(this.children.push.apply(this.children,i),e.isShared&&!this.isShared)for(let r of i)r.isShared=!0;this.tryMerge(s-1,t)}},b=[],ls={delete:!0},us=()=>ls,vt=(function(){let n=new Ye;return n.isShared=!0,n})(),Mt=[];function hs(n,...e){throw e.unshift("B+ tree"),new Error(e.join(" "))}function Dt(){let n=new Map;function e(t){let s=t.join(".");if(n.has(s))return n.get(s);let i=new Proxy({},{get(r,o,a){if(o==="__refProxy")return!0;if(o==="__path")return t;if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(r,o,a);let c=[...t,String(o)];return e(c)},has(r,o){return o==="__refProxy"||o==="__path"||o==="__type"?!0:Reflect.has(r,o)},ownKeys(r){return Reflect.ownKeys(r)},getOwnPropertyDescriptor(r,o){return o==="__refProxy"||o==="__path"||o==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(r,o)}});return n.set(s,i),i}return e([])}function V(n){let e=new Map,t=0;function s(r){let o=r.join(".");if(e.has(o))return e.get(o);let a=new Proxy({},{get(c,l,p){if(l==="__refProxy")return!0;if(l==="__path")return r;if(l==="__type")return;if(typeof l=="symbol")return Reflect.get(c,l,p);let h=[...r,String(l)];return s(h)},has(c,l){return l==="__refProxy"||l==="__path"||l==="__type"?!0:Reflect.has(c,l)},ownKeys(c){let l=++t,p=`__SPREAD_SENTINEL__${r.join(".")}__${l}`;return Object.prototype.hasOwnProperty.call(c,p)||Object.defineProperty(c,p,{enumerable:!0,configurable:!0,value:!0}),Reflect.ownKeys(c)},getOwnPropertyDescriptor(c,l){return l==="__refProxy"||l==="__path"||l==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(c,l)}});return e.set(o,a),a}return new Proxy({},{get(r,o,a){if(o==="__refProxy")return!0;if(o==="__path")return[];if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(r,o,a);let c=String(o);if(n.includes(c))return s([c])},has(r,o){return o==="__refProxy"||o==="__path"||o==="__type"||typeof o=="string"&&n.includes(o)?!0:Reflect.has(r,o)},ownKeys(r){return[...n,"__refProxy","__path","__type"]},getOwnPropertyDescriptor(r,o){if(o==="__refProxy"||o==="__path"||o==="__type")return{enumerable:!1,configurable:!0};if(typeof o=="string"&&n.includes(o))return{enumerable:!0,configurable:!0}}})}function k(n){return ds(n)?new q(n.__path):n&&typeof n=="object"&&"type"in n&&(n.type==="func"||n.type==="ref"||n.type==="val"||n.type==="agg")?n:new A(n)}function ds(n){return n&&typeof n=="object"&&n.__refProxy===!0}function Ft(n,e){return new K("gt",[k(n),k(e)])}function zt(n,e){return new K("lt",[k(n),k(e)])}function St(n,e,...t){let s=[n,e,...t];return new K("and",s.map(i=>k(i)))}var Ze=class{constructor(e,t,s,i){this.lookupCount=0,this.totalLookupTime=0,this.lastUpdated=new Date,this.id=e,this.expression=t,this.compareOptions=Q,this.name=s,this.initialize(i)}supports(e){return this.supportedOperations.has(e)}matchesField(e){return this.expression.type==="ref"&&this.expression.path.length===e.length&&this.expression.path.every((t,s)=>t===e[s])}matchesCompareOptions(e){let t={...this.compareOptions,direction:void 0},s={...e,direction:void 0};return C(t,s)}matchesDirection(e){return this.compareOptions.direction===e}getStats(){return{entryCount:this.keyCount,lookupCount:this.lookupCount,averageLookupTime:this.lookupCount>0?this.totalLookupTime/this.lookupCount:0,lastUpdated:this.lastUpdated}}evaluateIndexExpression(e){return ie(this.expression)(e)}trackLookup(e){let t=performance.now()-e;this.lookupCount++,this.totalLookupTime+=t}updateTimestamp(){this.lastUpdated=new Date}};var U=class extends Ze{constructor(e,t,s,i){super(e,t,s,i),this.supportedOperations=new Set(["eq","gt","gte","lt","lte","in"]),this.valueMap=new Map,this.indexedKeys=new Set,this.compareFn=mt,this.compareFn=i?.compareFn??mt,i?.compareOptions&&(this.compareOptions=i.compareOptions),this.orderedEntries=new Je(this.compareFn)}initialize(e){}add(e,t){let s;try{s=this.evaluateIndexExpression(t)}catch(r){throw new Error(`Failed to evaluate index expression for key ${e}: ${r}`)}let i=P(s);if(this.valueMap.has(i))this.valueMap.get(i).add(e);else{let r=new Set([e]);this.valueMap.set(i,r),this.orderedEntries.set(i,void 0)}this.indexedKeys.add(e),this.updateTimestamp()}remove(e,t){let s;try{s=this.evaluateIndexExpression(t)}catch(r){console.warn(`Failed to evaluate index expression for key ${e} during removal:`,r);return}let i=P(s);if(this.valueMap.has(i)){let r=this.valueMap.get(i);r.delete(e),r.size===0&&(this.valueMap.delete(i),this.orderedEntries.delete(i))}this.indexedKeys.delete(e),this.updateTimestamp()}update(e,t,s){this.remove(e,t),this.add(e,s)}build(e){this.clear();for(let[t,s]of e)this.add(t,s)}clear(){this.orderedEntries.clear(),this.valueMap.clear(),this.indexedKeys.clear(),this.updateTimestamp()}lookup(e,t){let s=performance.now(),i;switch(e){case"eq":i=this.equalityLookup(t);break;case"gt":i=this.rangeQuery({from:t,fromInclusive:!1});break;case"gte":i=this.rangeQuery({from:t,fromInclusive:!0});break;case"lt":i=this.rangeQuery({to:t,toInclusive:!1});break;case"lte":i=this.rangeQuery({to:t,toInclusive:!0});break;case"in":i=this.inArrayLookup(t);break;default:throw new Error(`Operation ${e} not supported by BTreeIndex`)}return this.trackLookup(s),i}get keyCount(){return this.indexedKeys.size}equalityLookup(e){let t=P(e);return new Set(this.valueMap.get(t)??[])}rangeQuery(e={}){let{from:t,to:s,fromInclusive:i=!0,toInclusive:r=!0}=e,o=new Set,a=P(t),c=P(s),l=a??this.orderedEntries.minKey(),p=c??this.orderedEntries.maxKey();return this.orderedEntries.forRange(l,p,r,(h,f)=>{if(!i&&this.compareFn(h,t)===0)return;let u=this.valueMap.get(h);u&&u.forEach(d=>o.add(d))}),o}rangeQueryReversed(e={}){let{from:t,to:s,fromInclusive:i=!0,toInclusive:r=!0}=e;return this.rangeQuery({from:s??this.orderedEntries.maxKey(),to:t??this.orderedEntries.minKey(),fromInclusive:r,toInclusive:i})}takeInternal(e,t,s,i){let r=new Set,o=[],a,c=P(s);for(;(a=t(c))!==void 0&&o.length<e;){c=a[0];let l=this.valueMap.get(c);if(l){let p=l.values(),h;for(;o.length<e&&(h=p.next().value);)!r.has(h)&&(i?.(h)??!0)&&(o.push(h),r.add(h))}}return o}take(e,t,s){let i=r=>this.orderedEntries.nextHigherPair(r);return this.takeInternal(e,i,t,s)}takeReversed(e,t,s){let i=r=>this.orderedEntries.nextLowerPair(r);return this.takeInternal(e,i,t,s)}inArrayLookup(e){let t=new Set;for(let s of e){let i=P(s),r=this.valueMap.get(i);r&&r.forEach(o=>t.add(o))}return t}get indexedKeysSet(){return this.indexedKeys}get orderedEntriesArray(){return this.orderedEntries.keysArray().map(e=>[e,this.valueMap.get(e)??new Set])}get orderedEntriesArrayReversed(){return this.takeReversed(this.orderedEntries.size).map(e=>[e,this.valueMap.get(e)??new Set])}get valueMapData(){return this.valueMap}};function Lt(n){return n.config.autoIndex==="eager"}function bt(n,e,t,s=Q,i){if(!(!Lt(t)||Array.from(t.indexes.values()).find(o=>o.matchesField(e)&&o.matchesCompareOptions(s))))try{t.createIndex(o=>o[n],{name:`auto_${n}`,indexType:U,options:i?{compareFn:i,compareOptions:s}:{}})}catch(o){console.warn(`${t.id?`[${t.id}] `:""}Failed to create auto-index for field "${n}":`,o)}}function qt(n,e){if(!Lt(e))return;let t=fs(n);for(let{fieldName:s,fieldPath:i}of t)bt(s,i,e)}function fs(n){let e=[];function t(s){if(s.type!=="func")return;let i=s;if(i.name==="and"){for(let l of i.args)t(l);return}if(!["eq","gt","gte","lt","lte","in"].includes(i.name)||i.args.length<1||i.args[0].type!=="ref")return;let a=i.args[0].path;if(a.length!==1)return;let c=a[0];e.push({fieldName:c,fieldPath:a})}return t(n),e}function Vt(n,e={}){let t=s=>{let i=[];for(let[r,o]of n.entries())(s?.(o)??!0)&&i.push({type:"insert",key:r,value:o});return i};if(e.limit!==void 0&&!e.orderBy)throw new Error("limit cannot be used without orderBy");if(e.orderBy){let s=e.where?W(e.where):void 0,i=ps(n,e.orderBy,e.limit,s,e.optimizedOnly);if(i===void 0)return;let r=[];for(let o of i){let a=n.get(o);a!==void 0&&r.push({type:"insert",key:o,value:a})}return r}if(!e.where)return t();try{let s=e.where,i=Kt(s,n.indexes);if(i.canOptimize){let r=[];for(let o of i.matchingKeys){let a=n.get(o);a!==void 0&&r.push({type:"insert",key:o,value:a})}return r}else{if(e.optimizedOnly)return;let r=W(s);return t(r)}}catch(s){console.warn(`${n.id?`[${n.id}] `:""}Error processing where clause, falling back to full scan:`,s);let i=W(e.where);return e.optimizedOnly?void 0:t(i)}}function W(n){return e=>{try{return!!ie(n)(e)}catch{return!1}}}function Ut(n,e){let t=W(e.whereExpression);return s=>{let i=[];for(let r of s)if(r.type==="insert")t(r.value)&&i.push(r);else if(r.type==="update"){let o=t(r.value),a=r.previousValue?t(r.previousValue):!1;o&&a?i.push(r):o&&!a?i.push({...r,type:"insert"}):!o&&a&&i.push({...r,type:"delete",value:r.previousValue})}else t(r.value)&&i.push(r);(i.length>0||s.length===0)&&n(i)}}function ps(n,e,t,s,i){if(e.length===1){let c=e[0],l=c.expression;if(l.type==="ref"){let h=l.path;bt(h[0],h,n,c.compareOptions);let f=ae(n.indexes,h,c.compareOptions);if(f&&f.supports("gt")){let u=d=>{let y=n.get(d);return y===void 0?!1:s?.(y)??!0};return f.take(t??f.keyCount,void 0,u)}}}if(i)return;let r=[];for(let[c,l]of n.entries())(s?.(l)??!0)&&r.push({key:c,value:l});let o=(c,l)=>{for(let p of e){let h=yt(p.compareOptions),f=$t(c.value,p.expression),u=$t(l.value,p.expression),d=h(f,u);if(d!==0)return d}return 0};r.sort(o);let a=r.map(c=>c.key);return t!==void 0?a.slice(0,t):a}function $t(n,e){if(e.type==="ref"){let t=e,s=n;for(let i of t.path)s=s?.[i];return s}else return e.type==="val"?e.value:ie(e)(n)}var ce=class{constructor(e){this.map=new Map,this.sortedKeys=[],this.comparator=e||this.defaultComparator}defaultComparator(e,t){return e<t?-1:e>t?1:0}indexOf(e){let t=0,s=this.sortedKeys.length;for(;t<s;){let i=Math.floor((t+s)/2),r=this.sortedKeys[i],o=this.map.get(r),a=this.comparator(e,o);if(a<0)s=i;else if(a>0)t=i+1;else return i}return t}set(e,t){if(this.map.has(e)){let i=this.map.get(e),r=this.indexOf(i);this.sortedKeys.splice(r,1)}let s=this.indexOf(t);return this.sortedKeys.splice(s,0,e),this.map.set(e,t),this}get(e){return this.map.get(e)}delete(e){if(this.map.has(e)){let t=this.map.get(e),s=this.indexOf(t);return this.sortedKeys.splice(s,1),this.map.delete(e)}return!1}has(e){return this.map.has(e)}clear(){this.map.clear(),this.sortedKeys=[]}get size(){return this.map.size}*[Symbol.iterator](){for(let e of this.sortedKeys)yield[e,this.map.get(e)]}entries(){return this[Symbol.iterator]()}keys(){return this.sortedKeys[Symbol.iterator]()}values(){return(function*(){for(let e of this.sortedKeys)yield this.map.get(e)}).call(this)}forEach(e){for(let t of this.sortedKeys)e(this.map.get(t),t,this.map)}};var Xe=class{constructor(e){this.pendingSyncedTransactions=[],this.syncedMetadata=new Map,this.optimisticUpserts=new Map,this.optimisticDeletes=new Set,this.size=0,this.syncedKeys=new Set,this.preSyncVisibleState=new Map,this.recentlySyncedKeys=new Set,this.hasReceivedFirstCommit=!1,this.isCommittingSyncTransactions=!1,this.commitPendingTransactions=()=>{let t=!1;for(let o of this.transactions.values())if(o.state==="persisting"){t=!0;break}let{committedSyncedTransactions:s,uncommittedSyncedTransactions:i,hasTruncateSync:r}=this.pendingSyncedTransactions.reduce((o,a)=>(a.committed?(o.committedSyncedTransactions.push(a),a.truncate===!0&&(o.hasTruncateSync=!0)):o.uncommittedSyncedTransactions.push(a),o),{committedSyncedTransactions:[],uncommittedSyncedTransactions:[],hasTruncateSync:!1});if(!t||r){this.isCommittingSyncTransactions=!0;let o=r?s.find(f=>f.truncate)?.optimisticSnapshot:null,a=new Set;for(let f of s)for(let u of f.operations)a.add(u.key);let c=this.preSyncVisibleState;if(c.size===0){c=new Map;for(let f of a){let u=this.get(f);u!==void 0&&c.set(f,u)}}let l=[],p=this.config.sync.rowUpdateMode||"partial";for(let f of s){if(f.truncate){let u=new Set([...this.syncedData.keys(),...o?.upserts.keys()||[]]);for(let d of u){if(o?.deletes.has(d))continue;let y=o?.upserts.get(d)||this.syncedData.get(d);y!==void 0&&l.push({type:"delete",key:d,value:y})}this.syncedData.clear(),this.syncedMetadata.clear(),this.syncedKeys.clear();for(let d of a)c.delete(d)}for(let u of f.operations){let d=u.key;switch(this.syncedKeys.add(d),u.type){case"insert":this.syncedMetadata.set(d,u.metadata);break;case"update":this.syncedMetadata.set(d,Object.assign({},this.syncedMetadata.get(d),u.metadata));break;case"delete":this.syncedMetadata.delete(d);break}switch(u.type){case"insert":this.syncedData.set(d,u.value);break;case"update":{if(p==="partial"){let y=Object.assign({},this.syncedData.get(d),u.value);this.syncedData.set(d,y)}else this.syncedData.set(d,u.value);break}case"delete":this.syncedData.delete(d);break}}}if(r){let f=new Set;for(let y of s)for(let g of y.operations)(g.type==="insert"||g.type==="update")&&f.add(g.key);let u=new Map(o.upserts),d=new Set(o.deletes);for(let[y,g]of u)if(!d.has(y))if(f.has(y)){let _=!1;for(let v=l.length-1;v>=0;v--){let w=l[v];if(w.key===y&&w.type==="insert"){w.value=g,_=!0;break}}_||l.push({type:"insert",key:y,value:g})}else l.push({type:"insert",key:y,value:g});if(l.length>0&&d.size>0){let y=[];for(let g of l)g.type==="insert"&&d.has(g.key)||y.push(g);l.length=0,l.push(...y)}this.lifecycle.status!=="ready"&&this.lifecycle.markReady()}if(this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.isCommittingSyncTransactions=!1,r&&o){for(let[f,u]of o.upserts)this.optimisticUpserts.set(f,u);for(let f of o.deletes)this.optimisticDeletes.add(f)}for(let f of this.transactions.values())if(!["completed","failed"].includes(f.state)){for(let u of f.mutations)if(this.isThisCollection(u.collection)&&u.optimistic)switch(u.type){case"insert":case"update":this.optimisticUpserts.set(u.key,u.modified),this.optimisticDeletes.delete(u.key);break;case"delete":this.optimisticUpserts.delete(u.key),this.optimisticDeletes.add(u.key);break}}let h=new Map;for(let f of this.transactions.values())if(f.state==="completed")for(let u of f.mutations)u.optimistic&&this.isThisCollection(u.collection)&&a.has(u.key)&&h.set(u.key,{type:u.type,value:u.modified});for(let f of a){let u=c.get(f),d=this.get(f),y=h.get(f),g=!1;y&&(y.type==="delete"&&u!==void 0&&d===void 0&&C(y.value,u)||d!==void 0&&C(y.value,d))&&(g=!0),g||(u===void 0&&d!==void 0?l.push({type:"insert",key:f,value:d}):u!==void 0&&d===void 0?l.push({type:"delete",key:f,value:u}):u!==void 0&&d!==void 0&&!C(u,d)&&l.push({type:"update",key:f,value:d,previousValue:u}))}this.size=this.calculateSize(),l.length>0&&this.indexes.updateIndexes(l),this.changes.emitEvents(l,!0),this.pendingSyncedTransactions=i,this.preSyncVisibleState.clear(),Promise.resolve().then(()=>{this.recentlySyncedKeys.clear()}),this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0)}},this.config=e,this.transactions=new ce((t,s)=>t.compareCreatedAt(s)),e.compare?this.syncedData=new ce(e.compare):this.syncedData=new Map}setDeps(e){this.collection=e.collection,this.lifecycle=e.lifecycle,this.changes=e.changes,this.indexes=e.indexes}get(e){let{optimisticDeletes:t,optimisticUpserts:s,syncedData:i}=this;if(!t.has(e))return s.has(e)?s.get(e):i.get(e)}has(e){let{optimisticDeletes:t,optimisticUpserts:s,syncedData:i}=this;return t.has(e)?!1:s.has(e)?!0:i.has(e)}*keys(){let{syncedData:e,optimisticDeletes:t,optimisticUpserts:s}=this;for(let i of e.keys())t.has(i)||(yield i);for(let i of s.keys())!e.has(i)&&!t.has(i)&&(yield i)}*values(){for(let e of this.keys()){let t=this.get(e);t!==void 0&&(yield t)}}*entries(){for(let e of this.keys()){let t=this.get(e);t!==void 0&&(yield[e,t])}}*[Symbol.iterator](){for(let[e,t]of this.entries())yield[e,t]}forEach(e){let t=0;for(let[s,i]of this.entries())e(i,s,t++)}map(e){let t=[],s=0;for(let[i,r]of this.entries())t.push(e(r,i,s++));return t}isThisCollection(e){return e===this.collection}recomputeOptimisticState(e=!1){if(this.isCommittingSyncTransactions&&!e)return;let t=new Map(this.optimisticUpserts),s=new Set(this.optimisticDeletes);this.optimisticUpserts.clear(),this.optimisticDeletes.clear();let i=[];for(let a of this.transactions.values())["completed","failed"].includes(a.state)||i.push(a);for(let a of i)for(let c of a.mutations)if(this.isThisCollection(c.collection)&&c.optimistic)switch(c.type){case"insert":case"update":this.optimisticUpserts.set(c.key,c.modified),this.optimisticDeletes.delete(c.key);break;case"delete":this.optimisticUpserts.delete(c.key),this.optimisticDeletes.add(c.key);break}this.size=this.calculateSize();let r=[];this.collectOptimisticChanges(t,s,r);let o=r.filter(a=>!!(!this.recentlySyncedKeys.has(a.key)||e));if(this.pendingSyncedTransactions.length>0&&!e){let a=new Set;for(let l of this.pendingSyncedTransactions)for(let p of l.operations)a.add(p.key);let c=o.filter(l=>!(l.type==="delete"&&a.has(l.key)&&!i.some(h=>h.mutations.some(f=>this.isThisCollection(f.collection)&&f.key===l.key))));c.length>0&&this.indexes.updateIndexes(c),this.changes.emitEvents(c,e)}else o.length>0&&this.indexes.updateIndexes(o),this.changes.emitEvents(o,e)}calculateSize(){let e=this.syncedData.size,t=Array.from(this.optimisticDeletes).filter(i=>this.syncedData.has(i)&&!this.optimisticUpserts.has(i)).length,s=Array.from(this.optimisticUpserts.keys()).filter(i=>!this.syncedData.has(i)).length;return e-t+s}collectOptimisticChanges(e,t,s){let i=new Set([...e.keys(),...this.optimisticUpserts.keys(),...t,...this.optimisticDeletes]);for(let r of i){let o=this.get(r),a=this.getPreviousValue(r,e,t);a!==void 0&&o===void 0?s.push({type:"delete",key:r,value:a}):a===void 0&&o!==void 0?s.push({type:"insert",key:r,value:o}):a!==void 0&&o!==void 0&&a!==o&&s.push({type:"update",key:r,value:o,previousValue:a})}}getPreviousValue(e,t,s){if(!s.has(e))return t.has(e)?t.get(e):this.syncedData.get(e)}scheduleTransactionCleanup(e){if(e.state==="completed"){this.transactions.delete(e.id);return}e.isPersisted.promise.then(()=>{this.transactions.delete(e.id)}).catch(()=>{})}capturePreSyncVisibleState(){if(this.pendingSyncedTransactions.length===0)return;let e=new Set;for(let t of this.pendingSyncedTransactions)for(let s of t.operations)e.add(s.key);for(let t of e)this.recentlySyncedKeys.add(t);for(let t of e)if(!this.preSyncVisibleState.has(t)){let s=this.get(t);s!==void 0&&this.preSyncVisibleState.set(t,s)}}onTransactionStateChange(){this.changes.shouldBatchEvents=this.pendingSyncedTransactions.length>0,this.capturePreSyncVisibleState(),this.recomputeOptimisticState(!1)}cleanup(){this.syncedData.clear(),this.syncedMetadata.clear(),this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.size=0,this.pendingSyncedTransactions=[],this.syncedKeys.clear(),this.hasReceivedFirstCommit=!1}};var H=class{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{this.listeners.get(e)?.delete(t)}}once(e,t){let s=this.on(e,i=>{t(i),s()});return s}off(e,t){this.listeners.get(e)?.delete(t)}waitFor(e,t){return new Promise((s,i)=>{let r,o=this.on(e,a=>{r&&(clearTimeout(r),r=void 0),s(a),o()});t&&(r=setTimeout(()=>{r=void 0,o(),i(new Error(`Timeout waiting for event ${String(e)}`))},t))})}emitInner(e,t){this.listeners.get(e)?.forEach(s=>{try{s(t)}catch(i){queueMicrotask(()=>{throw i})}})}clearListeners(){this.listeners.clear()}};var et=class extends H{constructor(e,t,s){super(),this.collection=e,this.callback=t,this.options=s,this.loadedInitialState=!1,this.snapshotSent=!1,this.sentKeys=new Set,this._status="ready",this.pendingLoadSubsetPromises=new Set,s.onUnsubscribe&&this.on("unsubscribed",r=>s.onUnsubscribe(r)),s.whereExpression&&qt(s.whereExpression,this.collection);let i=r=>{t(r),this.trackSentKeys(r)};this.callback=i,this.filteredCallback=s.whereExpression?Ut(this.callback,s):this.callback}get status(){return this._status}setOrderByIndex(e){this.orderByIndex=e}setStatus(e){if(this._status===e)return;let t=this._status;this._status=e,this.emitInner("status:change",{type:"status:change",subscription:this,previousStatus:t,status:e});let s=`status:${e}`;this.emitInner(s,{type:s,subscription:this,previousStatus:t,status:e})}trackLoadSubsetPromise(e){e instanceof Promise&&(this.pendingLoadSubsetPromises.add(e),this.setStatus("loadingSubset"),e.finally(()=>{this.pendingLoadSubsetPromises.delete(e),this.pendingLoadSubsetPromises.size===0&&this.setStatus("ready")}))}hasLoadedInitialState(){return this.loadedInitialState}hasSentAtLeastOneSnapshot(){return this.snapshotSent}emitEvents(e){let t=this.filterAndFlipChanges(e);this.filteredCallback(t)}requestSnapshot(e){if(this.loadedInitialState)return!1;let t={where:this.options.whereExpression,optimizedOnly:e?.optimizedOnly??!1};if(e){if("where"in e){let o=e.where;if(t.where){let a=t.where,c=St(a,o);t.where=c}else t.where=o}}else this.loadedInitialState=!0;let s=this.collection._sync.loadSubset({where:t.where,subscription:this});this.trackLoadSubsetPromise(s);let i=this.collection.currentStateAsChanges(t);if(i===void 0)return!1;let r=i.filter(o=>!this.sentKeys.has(o.key));return this.snapshotSent=!0,this.callback(r),!0}requestLimitedSnapshot({orderBy:e,limit:t,minValue:s}){if(!t)throw new Error("limit is required");if(!this.orderByIndex)throw new Error("Ordered snapshot was requested but no index was found. You have to call setOrderByIndex before requesting an ordered snapshot.");let i=this.orderByIndex,r=this.options.whereExpression,o=r?W(r):void 0,a=y=>{if(this.sentKeys.has(y))return!1;let g=this.collection.get(y);return g===void 0?!1:o?.(g)??!0},c=s,l=[],p=i.take(t,s,a),h=()=>Math.max(t-l.length,0),f=()=>p.length===0;for(;h()>0&&!f();){for(let y of p){let g=this.collection.get(y);l.push({type:"insert",key:y,value:g}),c=g}p=i.take(h(),c,a)}this.callback(l);let u=r;if(typeof s<"u"){let{expression:y,compareOptions:g}=e[0],v=(g.direction==="asc"?Ft:zt)(y,new A(s));u=r?St(r,v):v}let d=this.collection._sync.loadSubset({where:u,limit:t,orderBy:e,subscription:this});this.trackLoadSubsetPromise(d)}filterAndFlipChanges(e){if(this.loadedInitialState)return e;let t=[];for(let s of e){let i=s;if(!this.sentKeys.has(s.key)){if(s.type==="update")i={...s,type:"insert",previousValue:void 0};else if(s.type==="delete")continue;this.sentKeys.add(s.key)}t.push(i)}return t}trackSentKeys(e){if(!this.loadedInitialState)for(let t of e)this.sentKeys.add(t.key)}unsubscribe(){this.emitInner("unsubscribed",{type:"unsubscribed",subscription:this}),this.clearListeners()}};var tt=class{constructor(){this.activeSubscribersCount=0,this.changeSubscriptions=new Set,this.batchedEvents=[],this.shouldBatchEvents=!1}setDeps(e){this.lifecycle=e.lifecycle,this.sync=e.sync,this.events=e.events,this.collection=e.collection}emitEmptyReadyEvent(){for(let e of this.changeSubscriptions)e.emitEvents([])}emitEvents(e,t=!1){if(this.shouldBatchEvents&&!t){this.batchedEvents.push(...e);return}let s=e;if(t&&(this.batchedEvents.length>0&&(s=[...this.batchedEvents,...e]),this.batchedEvents=[],this.shouldBatchEvents=!1),s.length!==0)for(let i of this.changeSubscriptions)i.emitEvents(s)}subscribeChanges(e,t={}){this.addSubscriber();let s=new et(this.collection,e,{...t,onUnsubscribe:()=>{this.removeSubscriber(),this.changeSubscriptions.delete(s)}});return t.includeInitialState&&s.requestSnapshot(),this.changeSubscriptions.add(s),s}addSubscriber(){let e=this.activeSubscribersCount;this.activeSubscribersCount++,this.lifecycle.cancelGCTimer(),(this.lifecycle.status==="cleaned-up"||this.lifecycle.status==="idle")&&this.sync.startSync(),this.events.emitSubscribersChange(this.activeSubscribersCount,e)}removeSubscriber(){let e=this.activeSubscribersCount;if(this.activeSubscribersCount--,this.activeSubscribersCount===0)this.lifecycle.startGCTimer();else if(this.activeSubscribersCount<0)throw new Se;this.events.emitSubscribersChange(this.activeSubscribersCount,e)}cleanup(){this.batchedEvents=[],this.shouldBatchEvents=!1}};var ys=n=>setTimeout(()=>{n({didTimeout:!0,timeRemaining:()=>50})},0),ms=n=>{clearTimeout(n)},jt=typeof window<"u"&&"requestIdleCallback"in window?(n,e)=>window.requestIdleCallback(n,e):(n,e)=>ys(n),st=typeof window<"u"&&"cancelIdleCallback"in window?n=>window.cancelIdleCallback(n):ms;var nt=class{constructor(e,t){this.status="idle",this.hasBeenReady=!1,this.hasReceivedFirstCommit=!1,this.onFirstReadyCallbacks=[],this.gcTimeoutId=null,this.idleCallbackId=null,this.config=e,this.id=t}setDeps(e){this.indexes=e.indexes,this.events=e.events,this.changes=e.changes,this.sync=e.sync,this.state=e.state}validateStatusTransition(e,t){if(e===t)return;if(!{idle:["loading","error","cleaned-up"],loading:["ready","error","cleaned-up"],ready:["cleaned-up","error"],error:["cleaned-up","idle"],"cleaned-up":["loading","error"]}[e].includes(t))throw new ve(e,t,this.id)}setStatus(e,t=!1){if(e==="ready"&&!t)throw new z(`You can't directly call "setStatus('ready'). You must use markReady instead.`);this.validateStatusTransition(this.status,e);let s=this.status;this.status=e,e==="ready"&&!this.indexes.isIndexesResolved&&this.indexes.resolveAllIndexes().catch(i=>{console.warn(`${this.config.id?`[${this.config.id}] `:""}Failed to resolve indexes:`,i)}),this.events.emitStatusChange(e,s)}validateCollectionUsable(e){switch(this.status){case"error":throw new xe(e,this.id);case"cleaned-up":this.sync.startSync();break}}markReady(){if(this.validateStatusTransition(this.status,"ready"),this.status==="loading"){if(this.setStatus("ready",!0),!this.hasBeenReady){this.hasBeenReady=!0,this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0);let e=[...this.onFirstReadyCallbacks];this.onFirstReadyCallbacks=[],e.forEach(t=>t())}this.changes.changeSubscriptions.size>0&&this.changes.emitEmptyReadyEvent()}}startGCTimer(){this.gcTimeoutId&&clearTimeout(this.gcTimeoutId);let e=this.config.gcTime??3e5;e!==0&&(this.gcTimeoutId=setTimeout(()=>{this.changes.activeSubscribersCount===0&&this.scheduleIdleCleanup()},e))}cancelGCTimer(){this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.idleCallbackId!==null&&(st(this.idleCallbackId),this.idleCallbackId=null)}scheduleIdleCleanup(){this.idleCallbackId!==null&&st(this.idleCallbackId),this.idleCallbackId=jt(e=>{this.changes.activeSubscribersCount===0?this.performCleanup(e)&&(this.idleCallbackId=null):this.idleCallbackId=null},{timeout:1e3})}performCleanup(e){return!e||e.timeRemaining()>0||e.didTimeout?(this.sync.cleanup(),this.state.cleanup(),this.changes.cleanup(),this.indexes.cleanup(),this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.hasBeenReady=!1,this.onFirstReadyCallbacks=[],this.setStatus("cleaned-up"),this.events.cleanup(),!0):(this.scheduleIdleCleanup(),!1)}onFirstReady(e){if(this.hasBeenReady){e();return}this.onFirstReadyCallbacks.push(e)}cleanup(){this.idleCallbackId!==null&&(st(this.idleCallbackId),this.idleCallbackId=null),this.performCleanup()}};var rt=class{constructor(e,t){this.preloadPromise=null,this.syncCleanupFn=null,this.syncLoadSubsetFn=null,this.pendingLoadSubsetPromises=new Set,this.config=e,this.id=t,this.syncMode=e.syncMode??"eager"}setDeps(e){this.collection=e.collection,this.state=e.state,this.lifecycle=e.lifecycle,this._events=e.events}startSync(){if(!(this.lifecycle.status!=="idle"&&this.lifecycle.status!=="cleaned-up")){this.lifecycle.setStatus("loading");try{let e=gs(this.config.sync.sync({collection:this.collection,begin:()=>{this.state.pendingSyncedTransactions.push({committed:!1,operations:[],deletedKeys:new Set})},write:t=>{let s=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!s)throw new te;if(s.committed)throw new se;let i=this.config.getKey(t.value),r=t.type;if(t.type==="insert"){let a=this.state.syncedData.has(i),c=s.deletedKeys.has(i),l=s.truncate===!0;if(a&&!c&&!l){let p=this.state.syncedData.get(i);if(p!==void 0&&C(p,t.value))r="update";else throw new Ce(i,this.id)}}let o={...t,type:r,key:i};s.operations.push(o),r==="delete"&&s.deletedKeys.add(i)},commit:()=>{let t=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!t)throw new Le;if(t.committed)throw new qe;t.committed=!0,this.state.commitPendingTransactions()},markReady:()=>{this.lifecycle.markReady()},truncate:()=>{let t=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!t)throw new te;if(t.committed)throw new se;t.operations=[],t.deletedKeys.clear(),t.truncate=!0,t.optimisticSnapshot={upserts:new Map(this.state.optimisticUpserts),deletes:new Set(this.state.optimisticDeletes)}}}));if(this.syncCleanupFn=e?.cleanup??null,this.syncLoadSubsetFn=e?.loadSubset??null,this.syncMode==="on-demand"&&!this.syncLoadSubsetFn)throw new F(`Collection "${this.id}" is configured with syncMode "on-demand" but the sync function did not return a loadSubset handler. Either provide a loadSubset handler or use syncMode "eager".`)}catch(e){throw this.lifecycle.setStatus("error"),e}}}preload(){return this.preloadPromise?this.preloadPromise:(this.preloadPromise=new Promise((e,t)=>{if(this.lifecycle.status==="ready"){e();return}if(this.lifecycle.status==="error"){t(new we);return}if(this.lifecycle.onFirstReady(()=>{e()}),this.lifecycle.status==="idle"||this.lifecycle.status==="cleaned-up")try{this.startSync()}catch(s){t(s);return}}),this.preloadPromise)}get isLoadingSubset(){return this.pendingLoadSubsetPromises.size>0}trackLoadPromise(e){let t=!this.isLoadingSubset;this.pendingLoadSubsetPromises.add(e),t&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!0,previousIsLoadingSubset:!1,loadingSubsetTransition:"start"}),e.finally(()=>{let s=this.pendingLoadSubsetPromises.size===1&&this.pendingLoadSubsetPromises.has(e);this.pendingLoadSubsetPromises.delete(e),s&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!1,previousIsLoadingSubset:!0,loadingSubsetTransition:"end"})})}loadSubset(e){if(this.syncMode==="eager")return!0;if(this.syncLoadSubsetFn){let t=this.syncLoadSubsetFn(e);if(t instanceof Promise)return this.trackLoadPromise(t),t}return!0}cleanup(){try{this.syncCleanupFn&&(this.syncCleanupFn(),this.syncCleanupFn=null)}catch(e){queueMicrotask(()=>{if(e instanceof Error){let t=new re(this.id,e);throw t.cause=e,t.stack=e.stack,t}else throw new re(this.id,e)})}this.preloadPromise=null}};function gs(n){if(typeof n=="function")return{cleanup:n};if(typeof n=="object")return n}function Nt(n){return typeof n=="function"&&n.prototype!==void 0&&n.prototype.constructor===n}async function xs(n){return Nt(n)?n:await n()}var it=class{constructor(e,t,s,i,r,o){this.id=e,this.expression=t,this.name=s,this.resolver=i,this.options=r,this.collectionEntries=o,this.indexPromise=null,this.resolvedIndex=null,Nt(this.resolver)&&(this.resolvedIndex=new this.resolver(this.id,this.expression,this.name,this.options),this.collectionEntries&&this.resolvedIndex.build(this.collectionEntries))}async resolve(){return this.resolvedIndex?this.resolvedIndex:(this.indexPromise||(this.indexPromise=this.createIndex()),this.resolvedIndex=await this.indexPromise,this.resolvedIndex)}isResolved(){return this.resolvedIndex!==null}getResolved(){if(!this.resolvedIndex)throw new Error(`Index ${this.id} has not been resolved yet. Ensure collection is synced.`);return this.resolvedIndex}getId(){return this.id}getName(){return this.name}getExpression(){return this.expression}async createIndex(){let e=await xs(this.resolver);return new e(this.id,this.expression,this.name,this.options)}},ot=class{constructor(e,t){this.indexId=e,this.lazyIndex=t}get index(){return this.lazyIndex.getResolved()}get isReady(){return this.lazyIndex.isResolved()}async whenReady(){return await this.lazyIndex.resolve()}get id(){return this.indexId}get name(){return this.isReady?this.index.name:this.lazyIndex.getName()}get expression(){return this.lazyIndex.getExpression()}supports(e){return this.index.supports(e)}getStats(){return this.index.getStats()}matchesField(e){let t=this.expression;return t.type==="ref"&&t.path.length===e.length&&t.path.every((s,i)=>s===e[i])}get keyCount(){return this.index.keyCount}get indexedKeysSet(){return this.index.indexedKeysSet}get orderedEntriesArray(){return this.index.orderedEntriesArray}get valueMapData(){return this.index.valueMapData}equalityLookup(e){return this.index.equalityLookup?.(e)??new Set}rangeQuery(e){return this.index.rangeQuery?.(e)??new Set}inArrayLookup(e){return this.index.inArrayLookup?.(e)??new Set}_getLazyWrapper(){return this.lazyIndex}};var at=class{constructor(){this.lazyIndexes=new Map,this.resolvedIndexes=new Map,this.isIndexesResolved=!1,this.indexCounter=0}setDeps(e){this.state=e.state,this.lifecycle=e.lifecycle}createIndex(e,t={}){this.lifecycle.validateCollectionUsable("createIndex");let s=++this.indexCounter,i=Dt(),r=e(i),o=k(r),a=t.indexType??U,c=new it(s,o,t.name,a,t.options,this.state.entries());if(this.lazyIndexes.set(s,c),a===U)try{let l=c.getResolved();this.resolvedIndexes.set(s,l)}catch(l){console.warn("Failed to resolve BTreeIndex:",l)}else if(typeof a=="function"&&a.prototype)try{let l=c.getResolved();this.resolvedIndexes.set(s,l)}catch{this.resolveSingleIndex(s,c).catch(l=>{console.warn("Failed to resolve single index:",l)})}else this.isIndexesResolved&&this.resolveSingleIndex(s,c).catch(l=>{console.warn("Failed to resolve single index:",l)});return new ot(s,c)}async resolveAllIndexes(){if(this.isIndexesResolved)return;let e=Array.from(this.lazyIndexes.entries()).map(async([t,s])=>{let i=await s.resolve();return i.build(this.state.entries()),this.resolvedIndexes.set(t,i),{indexId:t,resolvedIndex:i}});await Promise.all(e),this.isIndexesResolved=!0}async resolveSingleIndex(e,t){let s=await t.resolve();return s.build(this.state.entries()),this.resolvedIndexes.set(e,s),s}get indexes(){return this.resolvedIndexes}updateIndexes(e){for(let t of this.resolvedIndexes.values())for(let s of e)switch(s.type){case"insert":t.add(s.key,s.value);break;case"update":s.previousValue?t.update(s.key,s.previousValue,s.value):t.add(s.key,s.value);break;case"delete":t.remove(s.key,s.value);break}}cleanup(){this.lazyIndexes.clear(),this.resolvedIndexes.clear()}};function m(...n){let e=typeof window<"u"&&typeof localStorage<"u";e&&localStorage.getItem("DEBUG")==="true"?console.log("[proxy]",...n):!e&&typeof process<"u"&&process.env.DEBUG==="true"&&console.log("[proxy]",...n)}function M(n,e=new WeakMap){if(n==null||typeof n!="object")return n;if(e.has(n))return e.get(n);if(n instanceof Date)return new Date(n.getTime());if(n instanceof RegExp)return new RegExp(n.source,n.flags);if(Array.isArray(n)){let i=[];return e.set(n,i),n.forEach((r,o)=>{i[o]=M(r,e)}),i}if(ArrayBuffer.isView(n)&&!(n instanceof DataView)){let i=Object.getPrototypeOf(n).constructor,r=new i(n.length);e.set(n,r);for(let o=0;o<n.length;o++)r[o]=n[o];return r}if(n instanceof Map){let i=new Map;return e.set(n,i),n.forEach((r,o)=>{i.set(o,M(r,e))}),i}if(n instanceof Set){let i=new Set;return e.set(n,i),n.forEach(r=>{i.add(M(r,e))}),i}if(oe(n))return n;let t={};e.set(n,t);for(let i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=M(n[i],e));let s=Object.getOwnPropertySymbols(n);for(let i of s)t[i]=M(n[i],e);return t}var Bt=0;function vs(){return Bt+=1,Bt}function kt(n,e){let t=new Map;function s(h,f){if(m("Object ID:",h.constructor.name),t.has(h))return t.get(h);{let u=kt(h,f);return t.set(h,u),u}}let i=new Map,r={copy_:M(n),originalObject:M(n),proxyCount:vs(),modified:!1,assigned_:{},parent:e,target:n};m("createChangeProxy called for target",n,r.proxyCount);function o(h){h.modified||(h.modified=!0),h.parent&&(m("propagating change to parent"),"updateMap"in h.parent?h.parent.updateMap(h.copy_):"updateSet"in h.parent?h.parent.updateSet(h.copy_):(h.parent.tracker.copy_[h.parent.prop]=h.copy_,h.parent.tracker.assigned_[h.parent.prop]=!0),o(h.parent.tracker))}function a(h){if(m("checkIfReverted called with assigned keys:",Object.keys(h.assigned_)),Object.keys(h.assigned_).length===0&&Object.getOwnPropertySymbols(h.assigned_).length===0)return m("No assigned properties, returning true"),!0;for(let u in h.assigned_)if(h.assigned_[u]===!0){let d=h.copy_[u],y=h.originalObject[u];if(m(`Checking property ${String(u)}, current:`,d,"original:",y),!C(d,y))return m(`Property ${String(u)} is different, returning false`),!1}else if(h.assigned_[u]===!1)return m(`Property ${String(u)} was deleted, returning false`),!1;let f=Object.getOwnPropertySymbols(h.assigned_);for(let u of f)if(h.assigned_[u]===!0){let d=h.copy_[u],y=h.originalObject[u];if(!C(d,y))return m("Symbol property is different, returning false"),!1}else if(h.assigned_[u]===!1)return m("Symbol property was deleted, returning false"),!1;return m("All properties match original values, returning true"),!0}function c(h,f){m("checkParentStatus called for child prop:",f);let u=a(h);m("Parent checkIfReverted returned:",u),u&&(m("Parent is fully reverted, clearing tracking"),h.modified=!1,h.assigned_={},h.parent&&(m("Continuing up the parent chain"),c(h.parent.tracker,h.parent.prop)))}function l(h){if(m("createObjectProxy",h),i.has(h))return m("proxyCache found match"),i.get(h);let f=new Proxy(h,{get(u,d){m("get",u,d);let y=r.copy_[d]??r.originalObject[d],g=r.originalObject[d];if(m("value (at top of proxy get)",y),Object.getOwnPropertyDescriptor(u,d)?.get)return y;if(typeof y=="function"){if(Array.isArray(u)){let v=d.toString();if(new Set(["pop","push","shift","unshift","splice","sort","reverse","fill","copyWithin"]).has(v))return function(...J){let I=y.apply(r.copy_,J);return o(r),I}}if(u instanceof Map||u instanceof Set){let v=d.toString();if(new Set(["set","delete","clear","add","pop","push","shift","unshift","splice","sort","reverse"]).has(v))return function(...I){let j=y.apply(r.copy_,I);return o(r),j};if(new Set(["entries","keys","values","forEach",Symbol.iterator]).has(v)||d===Symbol.iterator)return function(...I){let j=y.apply(r.copy_,I);if(v==="forEach"){let L=I[0];if(typeof L=="function"){let he=function(de,x,S){let R=L.call(this,de,x,S);return o(r),R};return y.apply(u,[he,...I.slice(1)])}}if(v==="entries"||v==="values"||v===Symbol.iterator.toString()||d===Symbol.iterator){let L=j,he=new Map;if(v==="values"&&u instanceof Map)for(let[x,S]of r.copy_.entries())he.set(S,x);let de=new Map;if(u instanceof Set)for(let x of r.copy_.values())de.set(x,x);return{next(){let x=L.next();if(!x.done&&x.value&&typeof x.value=="object"){if(v==="entries"&&Array.isArray(x.value)&&x.value.length===2){if(x.value[1]&&typeof x.value[1]=="object"){let S=x.value[0],R={tracker:r,prop:S,updateMap:N=>{r.copy_ instanceof Map&&r.copy_.set(S,N)}},{proxy:Y}=s(x.value[1],R);x.value[1]=Y}}else if((v==="values"||v===Symbol.iterator.toString()||d===Symbol.iterator)&&typeof x.value=="object"&&x.value!==null)if(v==="values"&&u instanceof Map){let S=he.get(x.value);if(S!==void 0){let R={tracker:r,prop:S,updateMap:N=>{r.copy_ instanceof Map&&r.copy_.set(S,N)}},{proxy:Y}=s(x.value,R);x.value=Y}}else if(u instanceof Set){let S=x.value,R={tracker:r,prop:S,updateSet:N=>{r.copy_ instanceof Set&&(r.copy_.delete(S),r.copy_.add(N),de.set(S,N))}},{proxy:Y}=s(x.value,R);x.value=Y}else{let S=Symbol("iterator-value"),{proxy:R}=s(x.value,{tracker:r,prop:S});x.value=R}}return x},[Symbol.iterator](){return this}}}return j}}return y.bind(u)}if(y&&typeof y=="object"&&!(y instanceof Date)&&!(y instanceof RegExp)&&!oe(y)){let v={tracker:r,prop:String(d)},{proxy:w}=s(g,v);return i.set(y,w),w}return y},set(u,d,y){let g=r.copy_[d];if(m(`set called for property ${String(d)}, current:`,g,"new:",y),C(g,y))m("Value unchanged, not tracking");else{let _=r.originalObject[d],v=C(y,_);if(m("value:",y,"original:",_,"isRevertToOriginal:",v),v){m(`Reverting property ${String(d)} to original value`),delete r.assigned_[d.toString()],m(`Updating copy with original value for ${String(d)}`),r.copy_[d]=M(_),m("Checking if all properties reverted");let w=a(r);m("All reverted:",w),w?(m("All properties reverted, clearing tracking"),r.modified=!1,r.assigned_={},e&&(m("Updating parent for property:",e.prop),c(e.tracker,e.prop))):(m("Some properties still changed, keeping modified flag"),r.modified=!0)}else m(`Setting new value for property ${String(d)}`),r.copy_[d]=y,r.assigned_[d.toString()]=!0,m("Marking object and ancestors as modified",r),o(r)}return!0},defineProperty(u,d,y){return"value"in y&&(r.copy_[d]=M(y.value),r.assigned_[d.toString()]=!0,o(r)),!0},deleteProperty(u,d){m("deleteProperty",u,d);let y=typeof d=="symbol"?d.toString():d;if(y in u){let g=y in r.originalObject;delete r.copy_[d],g?(r.assigned_[y]=!1,r.copy_[y]=void 0,o(r)):(delete r.copy_[y],delete r.assigned_[y],Object.keys(r.assigned_).length===0&&Object.getOwnPropertySymbols(r.assigned_).length===0?r.modified=!1:r.modified=!0)}return!0}});return i.set(h,f),f}return{proxy:l(n),getChanges:()=>{if(m("getChanges called, modified:",r.modified),m(r),!r.modified)return m("Object not modified, returning empty object"),{};if(typeof r.copy_!="object"||Array.isArray(r.copy_)||Object.keys(r.assigned_).length===0)return r.copy_;let h={};for(let f in r.copy_)r.assigned_[f]===!0&&f in r.copy_&&(h[f]=r.copy_[f]);return m("Returning copy:",h),h}}}function ws(n){let e=n.map(t=>kt(t));return{proxies:e.map(t=>t.proxy),getChanges:()=>e.map(t=>t.getChanges())}}function Qt(n,e){let{proxy:t,getChanges:s}=kt(n);return e(t),s()}function Wt(n,e){let{proxies:t,getChanges:s}=ws(n);return e(t),s()}function Ht(){let n,e,t=!0;return{promise:new Promise((i,r)=>{n=o=>{t=!1,i(o)},e=o=>{t=!1,r(o)}}),resolve:n,reject:e,isPending:()=>t}}var Ct=class{constructor(){this.contexts=new Map,this.clearListeners=new Set}getOrCreateContext(e){let t=this.contexts.get(e);return t||(t={queue:[],jobs:new Map,dependencies:new Map,completed:new Set},this.contexts.set(e,t)),t}schedule({contextId:e,jobId:t,dependencies:s,run:i}){if(typeof e>"u"){i();return}let r=this.getOrCreateContext(e);if(r.jobs.has(t)||r.queue.push(t),r.jobs.set(t,i),s){let o=new Set(s);o.delete(t),r.dependencies.set(t,o)}else r.dependencies.has(t)||r.dependencies.set(t,new Set);r.completed.delete(t)}flush(e){let t=this.contexts.get(e);if(!t)return;let{queue:s,jobs:i,dependencies:r,completed:o}=t;for(;s.length>0;){let a=!1,c=s.length;for(let l=0;l<c;l++){let p=s.shift(),h=i.get(p);if(!h){r.delete(p),o.delete(p);continue}let f=r.get(p),u=!f;if(f){u=!0;for(let d of f)if(d!==p&&!o.has(d)){u=!1;break}}u?(i.delete(p),r.delete(p),h(),o.add(p),a=!0):s.push(p)}if(!a)throw new Error(`Scheduler detected unresolved dependencies for context ${String(e)}.`)}this.contexts.delete(e)}flushAll(){for(let e of Array.from(this.contexts.keys()))this.flush(e)}clear(e){this.contexts.delete(e),this.clearListeners.forEach(t=>t(e))}onClear(e){return this.clearListeners.add(e),()=>this.clearListeners.delete(e)}hasPendingJobs(e){let t=this.contexts.get(e);return!!t&&t.jobs.size>0}clearJob(e,t){let s=this.contexts.get(e);s&&(s.jobs.delete(t),s.dependencies.delete(t),s.completed.delete(t),s.queue=s.queue.filter(i=>i!==t),s.jobs.size===0&&this.contexts.delete(e))}},_t=new Ct;var ct=[],le=[],Ss=0;function bs(n,e){switch(`${n.type}-${e.type}`){case"insert-update":return{...n,type:"insert",original:{},modified:e.modified,changes:{...n.changes,...e.changes},key:n.key,globalKey:n.globalKey,metadata:e.metadata??n.metadata,syncMetadata:{...n.syncMetadata,...e.syncMetadata},mutationId:e.mutationId,updatedAt:e.updatedAt};case"insert-delete":return null;case"update-delete":return e;case"update-update":return{...e,original:n.original,changes:{...n.changes,...e.changes},metadata:e.metadata??n.metadata,syncMetadata:{...n.syncMetadata,...e.syncMetadata}};case"delete-delete":case"insert-insert":return e;default:{let t=`${n.type}-${e.type}`;throw new Error(`Unhandled mutation combination: ${t}`)}}}function ue(n){let e=new It(n);return ct.push(e),e}function lt(){if(le.length>0)return le.slice(-1)[0]}function ks(n){_t.clear(n.id),le.push(n)}function Cs(n){try{_t.flush(n.id)}finally{le=le.filter(e=>e.id!==n.id)}}function _s(n){let e=ct.findIndex(t=>t.id===n.id);e!==-1&&ct.splice(e,1)}var It=class{constructor(e){if(typeof e.mutationFn>"u")throw new Me;this.id=e.id??crypto.randomUUID(),this.mutationFn=e.mutationFn,this.state="pending",this.mutations=[],this.isPersisted=Ht(),this.autoCommit=e.autoCommit??!0,this.createdAt=new Date,this.sequenceNumber=Ss++,this.metadata=e.metadata??{}}setState(e){this.state=e,(e==="completed"||e==="failed")&&_s(this)}mutate(e){if(this.state!=="pending")throw new De;ks(this);try{e()}finally{Cs(this)}return this.autoCommit&&this.commit().catch(()=>{}),this}applyMutations(e){for(let t of e){let s=this.mutations.findIndex(i=>i.globalKey===t.globalKey);if(s>=0){let i=this.mutations[s],r=bs(i,t);r===null?this.mutations.splice(s,1):this.mutations[s]=r}else this.mutations.push(t)}}rollback(e){let t=e?.isSecondaryRollback??!1;if(this.state==="completed")throw new Fe;if(this.setState("failed"),!t){let s=new Set;this.mutations.forEach(i=>s.add(i.globalKey));for(let i of ct)i.state==="pending"&&i.mutations.some(r=>s.has(r.globalKey))&&i.rollback({isSecondaryRollback:!0})}return this.isPersisted.reject(this.error?.error),this.touchCollection(),this}touchCollection(){let e=new Set;for(let t of this.mutations)e.has(t.collection.id)||(t.collection._state.onTransactionStateChange(),t.collection._state.pendingSyncedTransactions.length>0&&t.collection._state.commitPendingTransactions(),e.add(t.collection.id))}async commit(){if(this.state!=="pending")throw new ze;if(this.setState("persisting"),this.mutations.length===0)return this.setState("completed"),this.isPersisted.resolve(this),this;try{await this.mutationFn({transaction:this}),this.setState("completed"),this.touchCollection(),this.isPersisted.resolve(this)}catch(e){let t=e instanceof Error?e:new Error(String(e));throw this.error={message:t.message,error:t},this.rollback(),t}return this}compareCreatedAt(e){let t=this.createdAt.getTime()-e.createdAt.getTime();return t!==0?t:this.sequenceNumber-e.sequenceNumber}};var ut=class{constructor(e,t){this.insert=(s,i)=>{this.lifecycle.validateCollectionUsable("insert");let r=this.state,o=lt();if(!o&&!this.config.onInsert)throw new Re;let a=Array.isArray(s)?s:[s],c=[];if(a.forEach(l=>{let p=this.validateData(l,"insert"),h=this.config.getKey(p);if(this.state.has(h))throw new ke(h);let f=this.generateGlobalKey(h,l),u={mutationId:crypto.randomUUID(),original:{},modified:p,changes:Object.fromEntries(Object.keys(l).map(d=>[d,p[d]])),globalKey:f,key:h,metadata:i?.metadata,syncMetadata:this.config.sync.getSyncMetadata?.()||{},optimistic:i?.optimistic??!0,type:"insert",createdAt:new Date,updatedAt:new Date,collection:this.collection};c.push(u)}),o)return o.applyMutations(c),r.transactions.set(o.id,o),r.scheduleTransactionCleanup(o),r.recomputeOptimisticState(!0),o;{let l=ue({mutationFn:async p=>await this.config.onInsert({transaction:p.transaction,collection:this.collection})});return l.applyMutations(c),l.commit().catch(()=>{}),r.transactions.set(l.id,l),r.scheduleTransactionCleanup(l),r.recomputeOptimisticState(!0),l}},this.delete=(s,i)=>{let r=this.state;this.lifecycle.validateCollectionUsable("delete");let o=lt();if(!o&&!this.config.onDelete)throw new Ke;if(Array.isArray(s)&&s.length===0)throw new Pe;let a=Array.isArray(s)?s:[s],c=[];for(let p of a){if(!this.state.has(p))throw new Te(p);let h=this.generateGlobalKey(p,this.state.get(p)),f={mutationId:crypto.randomUUID(),original:this.state.get(p),modified:this.state.get(p),changes:this.state.get(p),globalKey:h,key:p,metadata:i?.metadata,syncMetadata:r.syncedMetadata.get(p)||{},optimistic:i?.optimistic??!0,type:"delete",createdAt:new Date,updatedAt:new Date,collection:this.collection};c.push(f)}if(o)return o.applyMutations(c),r.transactions.set(o.id,o),r.scheduleTransactionCleanup(o),r.recomputeOptimisticState(!0),o;let l=ue({autoCommit:!0,mutationFn:async p=>this.config.onDelete({transaction:p.transaction,collection:this.collection})});return l.applyMutations(c),l.commit().catch(()=>{}),r.transactions.set(l.id,l),r.scheduleTransactionCleanup(l),r.recomputeOptimisticState(!0),l},this.id=t,this.config=e}setDeps(e){this.lifecycle=e.lifecycle,this.state=e.state,this.collection=e.collection}ensureStandardSchema(e){if(e&&"~standard"in e)return e;throw new ge}validateData(e,t,s){if(!this.config.schema)return e;let i=this.ensureStandardSchema(this.config.schema);if(t==="update"&&s){let o=this.state.get(s);if(o&&e&&typeof e=="object"&&typeof o=="object"){let a=Object.assign({},o,e),c=i["~standard"].validate(a);if(c instanceof Promise)throw new X;if("issues"in c&&c.issues){let f=c.issues.map(u=>({message:u.message,path:u.path?.map(d=>String(d))}));throw new Z(t,f)}let l=c.value,p=Object.keys(e);return Object.fromEntries(p.map(f=>[f,l[f]]))}}let r=i["~standard"].validate(e);if(r instanceof Promise)throw new X;if("issues"in r&&r.issues){let o=r.issues.map(a=>({message:a.message,path:a.path?.map(c=>String(c))}));throw new Z(t,o)}return r.value}generateGlobalKey(e,t){if(typeof e>"u")throw new be(t);return`KEY::${this.id}/${e}`}update(e,t,s){if(typeof e>"u")throw new _e;let i=this.state;this.lifecycle.validateCollectionUsable("update");let r=lt();if(!r&&!this.config.onUpdate)throw new Ae;let o=Array.isArray(e),a=o?e:[e];if(o&&a.length===0)throw new Ie;let c=typeof t=="function"?t:s,l=typeof t=="function"?{}:t,p=a.map(d=>{let y=this.state.get(d);if(!y)throw new Ee(d);return y}),h;o?h=Wt(p,c):h=[Qt(p[0],c)];let f=a.map((d,y)=>{let g=h[y];if(!g||Object.keys(g).length===0)return null;let _=p[y],v=this.validateData(g,"update",d),w=Object.assign({},_,v),J=this.config.getKey(_),I=this.config.getKey(w);if(J!==I)throw new Oe(J,I);let j=this.generateGlobalKey(I,w);return{mutationId:crypto.randomUUID(),original:_,modified:w,changes:Object.fromEntries(Object.keys(g).map(L=>[L,w[L]])),globalKey:j,key:d,metadata:l.metadata,syncMetadata:i.syncedMetadata.get(d)||{},optimistic:l.optimistic??!0,type:"update",createdAt:new Date,updatedAt:new Date,collection:this.collection}}).filter(Boolean);if(f.length===0){let d=ue({mutationFn:async()=>{}});return d.commit().catch(()=>{}),i.scheduleTransactionCleanup(d),d}if(r)return r.applyMutations(f),i.transactions.set(r.id,r),i.scheduleTransactionCleanup(r),i.recomputeOptimisticState(!0),r;let u=ue({mutationFn:async d=>this.config.onUpdate({transaction:d.transaction,collection:this.collection})});return u.applyMutations(f),u.commit().catch(()=>{}),i.transactions.set(u.id,u),i.scheduleTransactionCleanup(u),i.recomputeOptimisticState(!0),u}};var ht=class extends H{constructor(){super()}setDeps(e){this.collection=e.collection}emit(e,t){this.emitInner(e,t)}emitStatusChange(e,t){this.emit("status:change",{type:"status:change",collection:this.collection,previousStatus:t,status:e});let s=`status:${e}`;this.emit(s,{type:s,collection:this.collection,previousStatus:t,status:e})}emitSubscribersChange(e,t){this.emit("subscribers:change",{type:"subscribers:change",collection:this.collection,previousSubscriberCount:t,subscriberCount:e})}cleanup(){this.clearListeners()}};function Et(n){let e=new G(n);return n.utils?e.utils={...n.utils}:e.utils={},e}var G=class{constructor(e){if(this.utils={},this.insert=(t,s)=>this._mutations.insert(t,s),this.delete=(t,s)=>this._mutations.delete(t,s),!e)throw new ye;if(!e.sync)throw new me;e.id?this.id=e.id:this.id=crypto.randomUUID(),this.config={...e,autoIndex:e.autoIndex??"eager"},this._changes=new tt,this._events=new ht,this._indexes=new at,this._lifecycle=new nt(e,this.id),this._mutations=new ut(e,this.id),this._state=new Xe(e),this._sync=new rt(e,this.id),this._changes.setDeps({collection:this,lifecycle:this._lifecycle,sync:this._sync,events:this._events}),this._events.setDeps({collection:this}),this._indexes.setDeps({state:this._state,lifecycle:this._lifecycle}),this._lifecycle.setDeps({changes:this._changes,events:this._events,indexes:this._indexes,state:this._state,sync:this._sync}),this._mutations.setDeps({collection:this,lifecycle:this._lifecycle,state:this._state}),this._state.setDeps({collection:this,lifecycle:this._lifecycle,changes:this._changes,indexes:this._indexes}),this._sync.setDeps({collection:this,state:this._state,lifecycle:this._lifecycle,events:this._events}),e.startSync===!0&&this._sync.startSync()}get status(){return this._lifecycle.status}get subscriberCount(){return this._changes.activeSubscribersCount}onFirstReady(e){return this._lifecycle.onFirstReady(e)}isReady(){return this._lifecycle.status==="ready"}get isLoadingSubset(){return this._sync.isLoadingSubset}startSyncImmediate(){this._sync.startSync()}preload(){return this._sync.preload()}get(e){return this._state.get(e)}has(e){return this._state.has(e)}get size(){return this._state.size}*keys(){yield*this._state.keys()}*values(){yield*this._state.values()}*entries(){yield*this._state.entries()}*[Symbol.iterator](){yield*this._state[Symbol.iterator]()}forEach(e){return this._state.forEach(e)}map(e){return this._state.map(e)}getKeyFromItem(e){return this.config.getKey(e)}createIndex(e,t={}){return this._indexes.createIndex(e,t)}get indexes(){return this._indexes.indexes}validateData(e,t,s){return this._mutations.validateData(e,t,s)}update(e,t,s){return this._mutations.update(e,t,s)}get state(){let e=new Map;for(let[t,s]of this.entries())e.set(t,s);return e}stateWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.state):this.preload().then(()=>this.state)}get toArray(){return Array.from(this.values())}toArrayWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.toArray):this.preload().then(()=>this.toArray)}currentStateAsChanges(e={}){return Vt(this,e)}subscribeChanges(e,t={}){return this._changes.subscribeChanges(e,t)}on(e,t){return this._events.on(e,t)}once(e,t){return this._events.once(e,t)}off(e,t){this._events.off(e,t)}waitFor(e,t){return this._events.waitFor(e,t)}async cleanup(){return this._lifecycle.cleanup(),Promise.resolve()}};var dt=class n{constructor(e={}){this.query={},this.query={...e}}_createRefForSource(e,t){if(Object.keys(e).length!==1)throw new $e(t);let s=Object.keys(e)[0],i=e[s],r;if(i instanceof G)r=new fe(i,s);else if(i instanceof n){let o=i._getQuery();if(!o.from)throw new Ve(t);r=new pe(o,s)}else throw new Ue(s);return[s,r]}from(e){let[,t]=this._createRefForSource(e,"from clause");return new n({...this.query,from:t})}join(e,t,s="left"){let[i,r]=this._createRefForSource(e,"join clause"),a=[...this._getCurrentAliases(),i],c=V(a),l=t(c),p,h;if(l.type==="func"&&l.name==="eq"&&l.args.length===2)p=l.args[0],h=l.args[1];else throw new je;let f={from:r,type:s,left:p,right:h},u=this.query.join||[];return new n({...this.query,join:[...u,f]})}leftJoin(e,t){return this.join(e,t,"left")}rightJoin(e,t){return this.join(e,t,"right")}innerJoin(e,t){return this.join(e,t,"inner")}fullJoin(e,t){return this.join(e,t,"full")}where(e){let t=this._getCurrentAliases(),s=V(t),i=e(s),r=this.query.where||[];return new n({...this.query,where:[...r,i]})}having(e){let t=this._getCurrentAliases(),s=V(t),i=e(s),r=this.query.having||[];return new n({...this.query,having:[...r,i]})}select(e){let t=this._getCurrentAliases(),s=V(t),i=e(s),r=Gt(i);return new n({...this.query,select:r,fnSelect:void 0})}orderBy(e,t="asc"){let s=this._getCurrentAliases(),i=V(s),r=e(i),o=typeof t=="string"?{direction:t,nulls:"first",stringSort:"locale"}:{direction:t.direction??"asc",nulls:t.nulls??"first",stringSort:t.stringSort??"locale",locale:t.stringSort==="locale"?t.locale:void 0,localeOptions:t.stringSort==="locale"?t.localeOptions:void 0},a=p=>({expression:k(p),compareOptions:o}),c=Array.isArray(r)?r.map(p=>a(p)):[a(r)],l=this.query.orderBy||[];return new n({...this.query,orderBy:[...l,...c]})}groupBy(e){let t=this._getCurrentAliases(),s=V(t),i=e(s),r=Array.isArray(i)?i.map(a=>k(a)):[k(i)],o=this.query.groupBy||[];return new n({...this.query,groupBy:[...o,...r]})}limit(e){return new n({...this.query,limit:e})}offset(e){return new n({...this.query,offset:e})}distinct(){return new n({...this.query,distinct:!0})}findOne(){return new n({...this.query,singleResult:!0})}_getCurrentAliases(){let e=[];if(this.query.from&&e.push(this.query.from.alias),this.query.join)for(let t of this.query.join)e.push(t.from.alias);return e}get fn(){let e=this;return{select(t){return new n({...e.query,select:void 0,fnSelect:t})},where(t){return new n({...e.query,fnWhere:[...e.query.fnWhere||[],t]})},having(t){return new n({...e.query,fnHaving:[...e.query.fnHaving||[],t]})}}}_getQuery(){if(!this.query.from)throw new Ne;return this.query}};function Is(n){return n===void 0?k(null):n instanceof B||n instanceof K||n instanceof q||n instanceof A?n:k(n)}function Es(n){return n!==null&&typeof n=="object"&&!Pt(n)&&!n.__refProxy}function Gt(n){if(!Es(n))return Is(n);let e={};for(let[t,s]of Object.entries(n)){if(typeof t=="string"&&t.startsWith("__SPREAD_SENTINEL__")){e[t]=s;continue}e[t]=Gt(s)}return e}var Ot=dt;console.log(Et,Ot);

var Ir=Object.defineProperty;var an=(t,e)=>{for(var s in e)Ir(t,s,{get:e[s],enumerable:!0})};var sn={};an(sn,{AggregateFunctionNotInSelectError:()=>ft,AggregateNotSupportedError:()=>ns,BTreeIndex:()=>Y,BaseIndex:()=>Ot,BaseQueryBuilder:()=>Bt,CannotCombineEmptyExpressionListError:()=>xt,CollectionConfigurationError:()=>Q,CollectionImpl:()=>ve,CollectionInErrorStateError:()=>Ce,CollectionInputNotFoundError:()=>te,CollectionIsInErrorStateError:()=>Ie,CollectionOperationError:()=>j,CollectionRequiresConfigError:()=>xe,CollectionRequiresSyncConfigError:()=>be,CollectionStateError:()=>G,DeleteKeyNotFoundError:()=>Be,DistinctRequiresSelectError:()=>Ye,DuplicateKeyError:()=>Re,DuplicateKeySyncError:()=>Te,EmptyReferencePathError:()=>st,GroupByError:()=>se,HavingRequiresGroupByError:()=>Ze,IR:()=>As,IndexOperation:()=>Mn,IndexProxy:()=>At,InvalidCollectionStatusTransitionError:()=>Ee,InvalidJoinCondition:()=>lt,InvalidJoinConditionLeftSourceError:()=>at,InvalidJoinConditionRightSourceError:()=>ct,InvalidJoinConditionSameSourceError:()=>it,InvalidJoinConditionSourceMismatchError:()=>ot,InvalidSchemaError:()=>ke,InvalidSourceError:()=>Ge,InvalidStorageDataFormatError:()=>vt,InvalidStorageObjectFormatError:()=>wt,JoinCollectionNotFoundError:()=>he,JoinConditionMustBeEqualityError:()=>He,JoinError:()=>W,KeyUpdateNotAllowedError:()=>Me,LazyIndexWrapper:()=>Pt,LimitOffsetRequireOrderByError:()=>Xe,LocalStorageCollectionError:()=>de,MissingAliasInputsError:()=>Ct,MissingDeleteHandlerError:()=>Le,MissingHandlerError:()=>ce,MissingInsertHandlerError:()=>De,MissingMutationFunctionError:()=>je,MissingUpdateArgumentError:()=>Pe,MissingUpdateHandlerError:()=>ze,NegativeActiveSubscribersError:()=>_e,NoKeysPassedToDeleteError:()=>Ke,NoKeysPassedToUpdateError:()=>Ae,NoPendingSyncTransactionCommitError:()=>We,NoPendingSyncTransactionWriteError:()=>le,NonAggregateExpressionNotInGroupByError:()=>ht,NonRetriableError:()=>ss,OnlyOneSourceAllowedError:()=>qe,Query:()=>Hn,QueryBuilderError:()=>J,QueryCompilationError:()=>B,QueryMustHaveFromClauseError:()=>Je,QueryOptimizerError:()=>St,SchemaMustBeSynchronousError:()=>ae,SchemaValidationError:()=>oe,SerializationError:()=>gt,SetWindowRequiresOrderByError:()=>Et,SortedMap:()=>me,StorageError:()=>yt,StorageKeyRequiredError:()=>mt,SubQueryMustHaveFromClauseError:()=>Qe,SubscriptionNotFoundError:()=>kt,SyncCleanupError:()=>fe,SyncTransactionAlreadyCommittedError:()=>Ve,SyncTransactionAlreadyCommittedWriteError:()=>ue,TanStackDBError:()=>A,TransactionAlreadyCompletedRollbackError:()=>Ne,TransactionError:()=>N,TransactionNotPendingCommitError:()=>Ue,TransactionNotPendingMutateError:()=>$e,UndefinedKeyError:()=>Oe,UnknownExpressionTypeError:()=>tt,UnknownFunctionError:()=>nt,UnknownHavingExpressionTypeError:()=>pt,UnsupportedAggregateFunctionError:()=>dt,UnsupportedFromTypeError:()=>et,UnsupportedJoinSourceTypeError:()=>ut,UnsupportedJoinTypeError:()=>rt,UpdateKeyNotFoundError:()=>Fe,WhereClauseConversionError:()=>bt,add:()=>_n,and:()=>Gt,avg:()=>Rn,coalesce:()=>In,compileQuery:()=>Lt,concat:()=>En,count:()=>On,createArrayChangeProxy:()=>js,createChangeProxy:()=>Ht,createCollection:()=>ks,createLiveQueryCollection:()=>wr,createOptimisticAction:()=>Wn,createTransaction:()=>X,eq:()=>fn,getActiveTransaction:()=>ne,gt:()=>cs,gte:()=>pn,ilike:()=>xn,inArray:()=>us,isNull:()=>wn,isUndefined:()=>vn,length:()=>Cn,like:()=>Sn,liveQueryCollectionOptions:()=>Ts,localOnlyCollectionOptions:()=>Vn,localStorageCollectionOptions:()=>qn,lower:()=>kn,lt:()=>ls,lte:()=>yn,max:()=>An,min:()=>Pn,not:()=>mn,or:()=>gn,sum:()=>Tn,upper:()=>bn,withArrayChangeTracking:()=>ws,withChangeTracking:()=>vs});var As={};an(As,{Aggregate:()=>$,CollectionRef:()=>U,Func:()=>R,PropRef:()=>P,QueryRef:()=>M,Value:()=>K,createResidualWhere:()=>Ps,followRef:()=>ie,getHavingExpression:()=>es,getWhereExpression:()=>Wt,isExpressionLike:()=>Se,isResidualWhere:()=>ts});var ee=class{},U=class extends ee{constructor(e,s){super(),this.collection=e,this.alias=s,this.type="collectionRef"}},M=class extends ee{constructor(e,s){super(),this.query=e,this.alias=s,this.type="queryRef"}},P=class extends ee{constructor(e){super(),this.path=e,this.type="ref"}},K=class extends ee{constructor(e){super(),this.value=e,this.type="val"}},R=class extends ee{constructor(e,s){super(),this.name=e,this.args=s,this.type="func"}},$=class extends ee{constructor(e,s){super(),this.name=e,this.args=s,this.type="agg"}};function Se(t){return t instanceof $||t instanceof R||t instanceof P||t instanceof K}function Wt(t){return typeof t=="object"&&"expression"in t?t.expression:t}function es(t){return typeof t=="object"&&"expression"in t?t.expression:t}function ts(t){return typeof t=="object"&&"expression"in t&&t.residual===!0}function Ps(t){return{expression:t,residual:!0}}function _r(t,e){if(t.from.alias===e)return t.from;for(let s of t.join||[])if(s.from.alias===e)return s.from}function ie(t,e,s){if(e.path.length!==0){if(e.path.length===1){let n=e.path[0];if(t.select){let i=t.select[n];if(i&&i.type==="ref")return ie(t,i,s)}return{collection:s,path:[n]}}if(e.path.length>1){let[n,...i]=e.path,r=_r(t,n);return r?r.type==="queryRef"?ie(r.query,new P(i),s):{collection:r.collection,path:i}:void 0}}}var A=class extends Error{constructor(e){super(e),this.name="TanStackDBError"}},ss=class extends A{constructor(e){super(e),this.name="NonRetriableError"}},oe=class extends A{constructor(e,s,n){let i=`${e==="insert"?"Insert":"Update"} validation failed: ${s.map(r=>`
- ${r.message} - path: ${r.path}`).join("")}`;super(n||i),this.name="SchemaValidationError",this.type=e,this.issues=s}},Q=class extends A{constructor(e){super(e),this.name="CollectionConfigurationError"}},xe=class extends Q{constructor(){super("Collection requires a config")}},be=class extends Q{constructor(){super("Collection requires a sync config")}},ke=class extends Q{constructor(){super("Schema must implement the standard-schema interface")}},ae=class extends Q{constructor(){super("Schema validation must be synchronous")}},G=class extends A{constructor(e){super(e),this.name="CollectionStateError"}},Ce=class extends G{constructor(e,s){super(`Cannot perform ${e} on collection "${s}" - collection is in error state. Try calling cleanup() and restarting the collection.`)}},Ee=class extends G{constructor(e,s,n){super(`Invalid collection status transition from "${e}" to "${s}" for collection "${n}"`)}},Ie=class extends G{constructor(){super("Collection is in error state")}},_e=class extends G{constructor(){super("Active subscribers count is negative - this should never happen")}},j=class extends A{constructor(e){super(e),this.name="CollectionOperationError"}},Oe=class extends j{constructor(e){super(`An object was created without a defined key: ${JSON.stringify(e)}`)}},Re=class extends j{constructor(e){super(`Cannot insert document with ID "${e}" because it already exists in the collection`)}},Te=class extends j{constructor(e,s){super(`Cannot insert document with key "${e}" from sync because it already exists in the collection "${s}"`)}},Pe=class extends j{constructor(){super("The first argument to update is missing")}},Ae=class extends j{constructor(){super("No keys were passed to update")}},Fe=class extends j{constructor(e){super(`The key "${e}" was passed to update but an object for this key was not found in the collection`)}},Me=class extends j{constructor(e,s){super(`Updating the key of an item is not allowed. Original key: "${e}", Attempted new key: "${s}". Please delete the old item and create a new one if a key change is necessary.`)}},Ke=class extends j{constructor(){super("No keys were passed to delete")}},Be=class extends j{constructor(e){super(`Collection.delete was called with key '${e}' but there is no item in the collection with this key`)}},ce=class extends A{constructor(e){super(e),this.name="MissingHandlerError"}},De=class extends ce{constructor(){super("Collection.insert called directly (not within an explicit transaction) but no 'onInsert' handler is configured.")}},ze=class extends ce{constructor(){super("Collection.update called directly (not within an explicit transaction) but no 'onUpdate' handler is configured.")}},Le=class extends ce{constructor(){super("Collection.delete called directly (not within an explicit transaction) but no 'onDelete' handler is configured.")}},N=class extends A{constructor(e){super(e),this.name="TransactionError"}},je=class extends N{constructor(){super("mutationFn is required when creating a transaction")}},$e=class extends N{constructor(){super("You can no longer call .mutate() as the transaction is no longer pending")}},Ne=class extends N{constructor(){super("You can no longer call .rollback() as the transaction is already completed")}},Ue=class extends N{constructor(){super("You can no longer call .commit() as the transaction is no longer pending")}},le=class extends N{constructor(){super("No pending sync transaction to write to")}},ue=class extends N{constructor(){super("The pending sync transaction is already committed, you can't still write to it.")}},We=class extends N{constructor(){super("No pending sync transaction to commit")}},Ve=class extends N{constructor(){super("The pending sync transaction is already committed, you can't commit it again.")}},J=class extends A{constructor(e){super(e),this.name="QueryBuilderError"}},qe=class extends J{constructor(e){super(`Only one source is allowed in the ${e}`)}},Qe=class extends J{constructor(e){super(`A sub query passed to a ${e} must have a from clause itself`)}},Ge=class extends J{constructor(e){super(`Invalid source for live query: The value provided for alias "${e}" is not a Collection or subquery. Live queries only accept Collection instances or subqueries. Please ensure you're passing a valid Collection or QueryBuilder, not a plain array or other data type.`)}},He=class extends J{constructor(){super("Join condition must be an equality expression")}},Je=class extends J{constructor(){super("Query must have a from clause")}},B=class extends A{constructor(e){super(e),this.name="QueryCompilationError"}},Ye=class extends B{constructor(){super("DISTINCT requires a SELECT clause.")}},Ze=class extends B{constructor(){super("HAVING clause requires GROUP BY clause")}},Xe=class extends B{constructor(){super("LIMIT and OFFSET require an ORDER BY clause to ensure deterministic results")}},te=class extends B{constructor(e,s,n){let i=s?`alias "${e}" (collection "${s}")`:`collection "${e}"`,r=n?.length?`. Available keys: ${n.join(", ")}`:"";super(`Input for ${i} not found in inputs map${r}`)}},et=class extends B{constructor(e){super(`Unsupported FROM type: ${e}`)}},tt=class extends B{constructor(e){super(`Unknown expression type: ${e}`)}},st=class extends B{constructor(){super("Reference path cannot be empty")}},nt=class extends B{constructor(e){super(`Unknown function: ${e}`)}},he=class extends B{constructor(e){super(`Collection "${e}" not found during compilation of join`)}},W=class extends A{constructor(e){super(e),this.name="JoinError"}},rt=class extends W{constructor(e){super(`Unsupported join type: ${e}`)}},it=class extends W{constructor(e){super(`Invalid join condition: both expressions refer to the same source "${e}"`)}},ot=class extends W{constructor(){super("Invalid join condition: expressions must reference source aliases")}},at=class extends W{constructor(e){super(`Invalid join condition: left expression refers to an unavailable source "${e}"`)}},ct=class extends W{constructor(e){super(`Invalid join condition: right expression does not refer to the joined source "${e}"`)}},lt=class extends W{constructor(){super("Invalid join condition")}},ut=class extends W{constructor(e){super(`Unsupported join source type: ${e}`)}},se=class extends A{constructor(e){super(e),this.name="GroupByError"}},ht=class extends se{constructor(e){super(`Non-aggregate expression '${e}' in SELECT must also appear in GROUP BY clause`)}},dt=class extends se{constructor(e){super(`Unsupported aggregate function: ${e}`)}},ft=class extends se{constructor(e){super(`Aggregate function in HAVING clause must also be in SELECT clause: ${e}`)}},pt=class extends se{constructor(e){super(`Unknown expression type in HAVING clause: ${e}`)}},yt=class extends A{constructor(e){super(e),this.name="StorageError"}},gt=class extends yt{constructor(e,s){super(`Cannot ${e} item because it cannot be JSON serialized: ${s}`)}},de=class extends yt{constructor(e){super(e),this.name="LocalStorageCollectionError"}},mt=class extends de{constructor(){super("[LocalStorageCollection] storageKey must be provided.")}},vt=class extends de{constructor(e,s){super(`[LocalStorageCollection] Invalid data format in storage key "${e}" for key "${s}".`)}},wt=class extends de{constructor(e){super(`[LocalStorageCollection] Invalid data format in storage key "${e}". Expected object format.`)}},fe=class extends A{constructor(e,s){let n=s instanceof Error?s.message:String(s);super(`Collection "${e}" sync cleanup function threw an error: ${n}`),this.name="SyncCleanupError"}},St=class extends A{constructor(e){super(e),this.name="QueryOptimizerError"}},xt=class extends St{constructor(){super("Cannot combine empty expression list")}},bt=class extends St{constructor(e,s){super(`Failed to convert WHERE clause to collection filter for collection '${e}' alias '${s}'. This indicates a bug in the query optimization logic.`)}},kt=class extends B{constructor(e,s,n,i){super(`Internal error: subscription for alias '${e}' (remapped from '${s}', collection '${n}') is missing in join pipeline. Available aliases: ${i.join(", ")}. This indicates a bug in alias tracking.`)}},ns=class extends B{constructor(){super("Aggregate expressions are not supported in this context. Use GROUP BY clause for aggregates.")}},Ct=class extends B{constructor(e){super(`Internal error: compiler returned aliases without inputs: ${e.join(", ")}. This indicates a bug in query compilation. Please report this issue.`)}},Et=class extends B{constructor(){super("setWindow() can only be called on collections with an ORDER BY clause. Add .orderBy() to your query to enable window movement.")}};var Fs=new WeakMap,Or=1;function cn(t){if(Fs.has(t))return Fs.get(t);let e=Or++;return Fs.set(t,e),e}var Ms=(t,e,s)=>{let{nulls:n}=s;if(t==null&&e==null)return 0;if(t==null)return n==="first"?-1:1;if(e==null)return n==="first"?1:-1;if(typeof t=="string"&&typeof e=="string"&&s.stringSort==="locale")return t.localeCompare(e,s.locale,s.localeOptions);if(Array.isArray(t)&&Array.isArray(e)){for(let o=0;o<Math.min(t.length,e.length);o++){let a=Ms(t[o],e[o],s);if(a!==0)return a}return t.length-e.length}if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let i=typeof t=="object",r=typeof e=="object";if(i||r){if(i&&r){let o=cn(t),a=cn(e);return o-a}if(i)return 1;if(r)return-1}return t<e?-1:t>e?1:0},Rr=(t,e,s)=>Ms(e,t,{...s,nulls:s.nulls==="first"?"last":"first"});function It(t){return(e,s)=>t.direction==="asc"?Ms(e,s,t):Rr(e,s,t)}var Vt=It({direction:"asc",nulls:"first",stringSort:"locale"});function V(t){return t instanceof Date?t.getTime():t}function D(t,e=!1){return Ks(t,e)}function qt(t){return Ks(t,!0)}function Ks(t,e){switch(t.type){case"val":{let s=t.value;return()=>s}case"ref":return e?Pr(t):Tr(t);case"func":return Ar(t,e);default:throw new tt(t.type)}}function Tr(t){let[e,...s]=t.path;if(!e)throw new st;if(s.length===0)return n=>n[e];if(s.length===1){let n=s[0];return i=>i[e]?.[n]}else return n=>{let i=n[e];if(i===void 0)return;let r=i;for(let o of s){if(r==null)return r;r=r[o]}return r}}function Pr(t){let e=t.path;return s=>{let n=s;for(let i of e){if(n==null)return n;n=n[i]}return n}}function Ar(t,e){let s=t.args.map(n=>Ks(n,e));switch(t.name){case"eq":{let n=s[0],i=s[1];return r=>{let o=V(n(r)),a=V(i(r));return o===a}}case"gt":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return o>a}}case"gte":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return o>=a}}case"lt":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return o<a}}case"lte":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return o<=a}}case"and":return n=>{for(let i of s)if(!i(n))return!1;return!0};case"or":return n=>{for(let i of s)if(i(n))return!0;return!1};case"not":{let n=s[0];return i=>!n(i)}case"in":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return Array.isArray(a)?a.includes(o):!1}}case"like":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return ln(o,a,!1)}}case"ilike":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return ln(o,a,!0)}}case"upper":{let n=s[0];return i=>{let r=n(i);return typeof r=="string"?r.toUpperCase():r}}case"lower":{let n=s[0];return i=>{let r=n(i);return typeof r=="string"?r.toLowerCase():r}}case"length":{let n=s[0];return i=>{let r=n(i);return typeof r=="string"||Array.isArray(r)?r.length:0}}case"concat":return n=>s.map(i=>{let r=i(n);try{return String(r??"")}catch{try{return JSON.stringify(r)||""}catch{return"[object]"}}}).join("");case"coalesce":return n=>{for(let i of s){let r=i(n);if(r!=null)return r}return null};case"add":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return(o??0)+(a??0)}}case"subtract":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return(o??0)-(a??0)}}case"multiply":{let n=s[0],i=s[1];return r=>{let o=n(r),a=i(r);return(o??0)*(a??0)}}case"divide":{let n=s[0],i=s[1];return r=>{let o=n(r),l=i(r)??0;return l!==0?(o??0)/l:null}}case"isUndefined":{let n=s[0];return i=>n(i)===void 0}case"isNull":{let n=s[0];return i=>n(i)===null}default:throw new nt(t.name)}}function ln(t,e,s){if(typeof t!="string"||typeof e!="string")return!1;let n=s?t.toLowerCase():t,r=(s?e.toLowerCase():e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return r=r.replace(/%/g,".*"),r=r.replace(/_/g,"."),new RegExp(`^${r}$`).test(n)}function L(t,e){return rs(t,e,new Map)}function rs(t,e,s){if(t===e)return!0;if(t==null||e==null||typeof t!=typeof e)return!1;if(t instanceof Date)return e instanceof Date?t.getTime()===e.getTime():!1;if(t instanceof RegExp)return e instanceof RegExp?t.source===e.source&&t.flags===e.flags:!1;if(t instanceof Map){if(!(e instanceof Map)||t.size!==e.size)return!1;if(s.has(t))return s.get(t)===e;s.set(t,e);let i=Array.from(t.entries()).every(([r,o])=>e.has(r)&&rs(o,e.get(r),s));return s.delete(t),i}if(t instanceof Set){if(!(e instanceof Set)||t.size!==e.size)return!1;if(s.has(t))return s.get(t)===e;s.set(t,e);let n=Array.from(t),i=Array.from(e);if(n.every(o=>typeof o!="object"))return s.delete(t),n.every(o=>e.has(o));let r=n.length===i.length;return s.delete(t),r}if(ArrayBuffer.isView(t)&&ArrayBuffer.isView(e)&&!(t instanceof DataView)&&!(e instanceof DataView)){let n=t,i=e;if(n.length!==i.length)return!1;for(let r=0;r<n.length;r++)if(n[r]!==i[r])return!1;return!0}if(Qt(t)&&Qt(e)){let n=Bs(t),i=Bs(e);return n!==i?!1:typeof t.equals=="function"?t.equals(e):t.toString()===e.toString()}if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;if(s.has(t))return s.get(t)===e;s.set(t,e);let n=t.every((i,r)=>rs(i,e[r],s));return s.delete(t),n}if(typeof t=="object"){if(s.has(t))return s.get(t)===e;s.set(t,e);let n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return s.delete(t),!1;let r=n.every(o=>o in e&&rs(t[o],e[o],s));return s.delete(t),r}return!1}var Fr=["Temporal.Duration","Temporal.Instant","Temporal.PlainDate","Temporal.PlainDateTime","Temporal.PlainMonthDay","Temporal.PlainTime","Temporal.PlainYearMonth","Temporal.ZonedDateTime"];function Bs(t){return t[Symbol.toStringTag]}function Qt(t){let e=Bs(t);return typeof e=="string"&&Fr.includes(e)}var _t={direction:"asc",nulls:"first",stringSort:"locale"};var is=class{constructor(e){this.originalIndex=e}lookup(e,s){let n=e==="gt"?"lt":e==="gte"?"lte":e==="lt"?"gt":e==="lte"?"gte":e;return this.originalIndex.lookup(n,s)}rangeQuery(e={}){return this.originalIndex.rangeQueryReversed(e)}rangeQueryReversed(e={}){return this.originalIndex.rangeQuery(e)}take(e,s,n){return this.originalIndex.takeReversed(e,s,n)}takeReversed(e,s,n){return this.originalIndex.take(e,s,n)}get orderedEntriesArray(){return this.originalIndex.orderedEntriesArrayReversed}get orderedEntriesArrayReversed(){return this.originalIndex.orderedEntriesArray}supports(e){return this.originalIndex.supports(e)}matchesField(e){return this.originalIndex.matchesField(e)}matchesCompareOptions(e){return this.originalIndex.matchesCompareOptions(e)}matchesDirection(e){return this.originalIndex.matchesDirection(e)}getStats(){return this.originalIndex.getStats()}add(e,s){this.originalIndex.add(e,s)}remove(e,s){this.originalIndex.remove(e,s)}update(e,s,n){this.originalIndex.update(e,s,n)}build(e){this.originalIndex.build(e)}clear(){this.originalIndex.clear()}get keyCount(){return this.originalIndex.keyCount}equalityLookup(e){return this.originalIndex.equalityLookup(e)}inArrayLookup(e){return this.originalIndex.inArrayLookup(e)}get indexedKeysSet(){return this.originalIndex.indexedKeysSet}get valueMapData(){return this.originalIndex.valueMapData}};function pe(t,e,s=_t){for(let n of t.values())if(n.matchesField(e)&&n.matchesCompareOptions(s))return n.matchesDirection(s.direction)?n:new is(n)}function Mr(t){if(t.length===0)return new Set;if(t.length===1)return new Set(t[0]);let e=new Set(t[0]);for(let s=1;s<t.length;s++){let n=new Set;for(let i of e)t[s].has(i)&&n.add(i);e=n}return e}function Kr(t){let e=new Set;for(let s of t)for(let n of s)e.add(n);return e}function un(t,e){return Ds(t,e)}function Ds(t,e){if(t.type==="func")switch(t.name){case"eq":case"gt":case"gte":case"lt":case"lte":return Dr(t,e);case"and":return zr(t,e);case"or":return Lr(t,e);case"in":return jr(t,e)}return{canOptimize:!1,matchingKeys:new Set}}function Br(t,e){if(t.type!=="func"||t.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let s=new Map;for(let n of t.args)if(n.type==="func"&&["gt","gte","lt","lte"].includes(n.name)){let i=n;if(i.args.length===2){let r=i.args[0],o=i.args[1],a=null,l=null,u=i.name;if(r.type==="ref"&&o.type==="val")a=r,l=o;else if(r.type==="val"&&o.type==="ref")switch(a=o,l=r,u){case"gt":u="lt";break;case"gte":u="lte";break;case"lt":u="gt";break;case"lte":u="gte";break}if(a&&l){let c=a.path.join("."),f=l.value;s.has(c)||s.set(c,[]),s.get(c).push({operation:u,value:f})}}}for(let[n,i]of s)if(i.length>=2){let r=n.split("."),o=pe(e,r);if(o&&o.supports("gt")&&o.supports("lt")){let a,l,u=!0,p=!0;for(let{operation:f,value:h}of i)switch(f){case"gt":(a===void 0||h>a)&&(a=h,u=!1);break;case"gte":(a===void 0||h>a)&&(a=h,u=!0);break;case"lt":(l===void 0||h<l)&&(l=h,p=!1);break;case"lte":(l===void 0||h<l)&&(l=h,p=!0);break}return{canOptimize:!0,matchingKeys:o.rangeQuery({from:a,to:l,fromInclusive:u,toInclusive:p})}}}return{canOptimize:!1,matchingKeys:new Set}}function Dr(t,e){if(t.type!=="func"||t.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let s=t.args[0],n=t.args[1],i=null,r=null,o=t.name;if(s.type==="ref"&&n.type==="val")i=s,r=n;else if(s.type==="val"&&n.type==="ref")switch(i=n,r=s,o){case"gt":o="lt";break;case"gte":o="lte";break;case"lt":o="gt";break;case"lte":o="gte";break}if(i&&r){let a=i.path,l=pe(e,a);if(l){let u=r.value,p=o;return l.supports(p)?{canOptimize:!0,matchingKeys:l.lookup(p,u)}:{canOptimize:!1,matchingKeys:new Set}}}return{canOptimize:!1,matchingKeys:new Set}}function zr(t,e){if(t.type!=="func"||t.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let s=Br(t,e);if(s.canOptimize)return s;let n=[];for(let i of t.args){let r=Ds(i,e);r.canOptimize&&n.push(r)}if(n.length>0){let i=n.map(o=>o.matchingKeys);return{canOptimize:!0,matchingKeys:Mr(i)}}return{canOptimize:!1,matchingKeys:new Set}}function Lr(t,e){if(t.type!=="func"||t.args.length<2)return{canOptimize:!1,matchingKeys:new Set};let s=[];for(let n of t.args){let i=Ds(n,e);i.canOptimize&&s.push(i)}if(s.length>0){let n=s.map(r=>r.matchingKeys);return{canOptimize:!0,matchingKeys:Kr(n)}}return{canOptimize:!1,matchingKeys:new Set}}function jr(t,e){if(t.type!=="func"||t.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};let s=t.args[0],n=t.args[1];if(s.type==="ref"&&n.type==="val"&&Array.isArray(n.value)){let i=s.path,r=n.value,o=pe(e,i);if(o){if(o.supports("in"))return{canOptimize:!0,matchingKeys:o.lookup("in",r)};if(o.supports("eq")){let a=new Set;for(let l of r){let u=o.lookup("eq",l);for(let p of u)a.add(p)}return{canOptimize:!0,matchingKeys:a}}}}return{canOptimize:!1,matchingKeys:new Set}}var os=class{constructor(e,s,n){this._root=zs,this._size=0,this._maxNodeSize=n>=4?Math.min(n,256):32,this._compare=e,s&&this.setPairs(s)}get size(){return this._size}get length(){return this._size}get isEmpty(){return this._size===0}clear(){this._root=zs,this._size=0}get(e,s){return this._root.get(e,s,this)}set(e,s,n){this._root.isShared&&(this._root=this._root.clone());let i=this._root.set(e,s,n,this);return i===!0||i===!1?i:(this._root=new Ls([this._root,i]),!0)}has(e){return this.forRange(e,e,!0,void 0)!==0}delete(e){return this.editRange(e,e,!0,Nr)!==0}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}keysArray(){let e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(s,n)=>{e.push(s)}),e}nextHigherPair(e,s){return s=s||[],e===void 0?this._root.minPair(s):this._root.getPairOrNextHigher(e,this._compare,!1,s)}nextHigherKey(e){let s=this.nextHigherPair(e,hn);return s&&s[0]}nextLowerPair(e,s){return s=s||[],e===void 0?this._root.maxPair(s):this._root.getPairOrNextLower(e,this._compare,!1,s)}nextLowerKey(e){let s=this.nextLowerPair(e,hn);return s&&s[0]}setPairs(e,s){let n=0;for(let i of e)this.set(i[0],i[1],s)&&n++;return n}forRange(e,s,n,i,r){let o=this._root.forRange(e,s,n,!1,this,r||0,i);return typeof o=="number"?o:o.break}editRange(e,s,n,i,r){let o=this._root;o.isShared&&(this._root=o=o.clone());try{let a=o.forRange(e,s,n,!0,this,r||0,i);return typeof a=="number"?a:a.break}finally{let a;for(;o.keys.length<=1&&!o.isLeaf;)a||=o.isShared,this._root=o=o.keys.length===0?zs:o.children[0];a&&(o.isShared=!0)}}},as=class t{get isLeaf(){return this.children===void 0}constructor(e=[],s){this.keys=e,this.values=s||z,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,s,n){let i=this.keys,r=0,o=i.length,a=o>>1;for(;r<o;){let l=n(i[a],e);if(l<0)r=a+1;else if(l>0)o=a;else{if(l===0)return a;if(e===e)return i.length;throw new Error("BTree: NaN was used as a key")}a=r+o>>1}return a^s}minKey(){return this.keys[0]}minPair(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(this.keys.length===0)return;let s=this.keys.length-1;return e[0]=this.keys[s],e[1]=this.values[s],e}clone(){let e=this.values;return new t(this.keys.slice(0),e===z?e:e.slice(0))}get(e,s,n){let i=this.indexOf(e,-1,n._compare);return i<0?s:this.values[i]}getPairOrNextLower(e,s,n,i){let r=this.indexOf(e,-1,s),o=r<0?~r-1:n?r:r-1;if(o>=0)return i[0]=this.keys[o],i[1]=this.values[o],i}getPairOrNextHigher(e,s,n,i){let r=this.indexOf(e,-1,s),o=r<0?~r:n?r:r+1,a=this.keys;if(o<a.length)return i[0]=a[o],i[1]=this.values[o],i}set(e,s,n,i){let r=this.indexOf(e,-1,i._compare);if(r<0){if(r=~r,i._size++,this.keys.length<i._maxNodeSize)return this.insertInLeaf(r,e,s,i);{let o=this.splitOffRightSide(),a=this;return r>this.keys.length&&(r-=this.keys.length,a=o),a.insertInLeaf(r,e,s,i),o}}else return n!==!1&&(s!==void 0&&this.reifyValues(),this.keys[r]=e,this.values[r]=s),!1}reifyValues(){return this.values===z?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,s,n,i){if(this.keys.splice(e,0,s),this.values===z){for(;z.length<i._maxNodeSize;)z.push(void 0);if(n===void 0)return!0;this.values=z.slice(0,this.keys.length-1)}return this.values.splice(e,0,n),!0}takeFromRight(e){let s=this.values;e.values===z?s!==z&&s.push(void 0):(s=this.reifyValues(),s.push(e.values.shift())),this.keys.push(e.keys.shift())}takeFromLeft(e){let s=this.values;e.values===z?s!==z&&s.unshift(void 0):(s=this.reifyValues(),s.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())}splitOffRightSide(){let e=this.keys.length>>1,s=this.keys.splice(e),n=this.values===z?z:this.values.splice(e);return new t(s,n)}forRange(e,s,n,i,r,o,a){let l=r._compare,u,p;if(s===e){if(!n||(p=(u=this.indexOf(e,-1,l))+1,u<0))return o}else u=this.indexOf(e,0,l),p=this.indexOf(s,-1,l),p<0?p=~p:n===!0&&p++;let c=this.keys,f=this.values;if(a!==void 0)for(let h=u;h<p;h++){let d=c[h],y=a(d,f[h],o++);if(y!==void 0){if(i===!0){if(d!==c[h]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");y.delete?(this.keys.splice(h,1),this.values!==z&&this.values.splice(h,1),r._size--,h--,p--):y.hasOwnProperty("value")&&(f[h]=y.value)}if(y.break!==void 0)return y}}else o+=p-u;return o}mergeSibling(e,s){if(this.keys.push.apply(this.keys,e.keys),this.values===z){if(e.values===z)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}},Ls=class t extends as{constructor(e,s){if(!s){s=[];for(let n=0;n<e.length;n++)s[n]=e[n].maxKey()}super(s),this.children=e}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,s,n){let i=this.indexOf(e,0,n._compare),r=this.children;return i<r.length?r[i].get(e,s,n):void 0}getPairOrNextLower(e,s,n,i){let r=this.indexOf(e,0,s),o=this.children;if(r>=o.length)return this.maxPair(i);let a=o[r].getPairOrNextLower(e,s,n,i);return a===void 0&&r>0?o[r-1].maxPair(i):a}getPairOrNextHigher(e,s,n,i){let r=this.indexOf(e,0,s),o=this.children,a=o.length;if(r>=a)return;let l=o[r].getPairOrNextHigher(e,s,n,i);return l===void 0&&r<a-1?o[r+1].minPair(i):l}set(e,s,n,i){let r=this.children,o=i._maxNodeSize,a=i._compare,l=Math.min(this.indexOf(e,0,a),r.length-1),u=r[l];if(u.isShared&&(r[l]=u=u.clone()),u.keys.length>=o){let c;l>0&&(c=r[l-1]).keys.length<o&&a(u.keys[0],e)<0?(c.isShared&&(r[l-1]=c=c.clone()),c.takeFromRight(u),this.keys[l-1]=c.maxKey()):(c=r[l+1])!==void 0&&c.keys.length<o&&a(u.maxKey(),e)<0&&(c.isShared&&(r[l+1]=c=c.clone()),c.takeFromLeft(u),this.keys[l]=r[l].maxKey())}let p=u.set(e,s,n,i);if(p===!1)return!1;if(this.keys[l]=u.maxKey(),p===!0)return!0;if(this.keys.length<o)return this.insert(l+1,p),!0;{let c=this.splitOffRightSide(),f=this;return a(p.maxKey(),this.maxKey())>0&&(f=c,l-=this.keys.length),f.insert(l+1,p),c}}insert(e,s){this.children.splice(e,0,s),this.keys.splice(e,0,s.maxKey())}splitOffRightSide(){let e=this.children.length>>1;return new t(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,s,n,i,r,o,a){let l=r._compare,u=this.keys,p=this.children,c=this.indexOf(e,0,l),f=c,h=Math.min(s===e?c:this.indexOf(s,0,l),u.length-1);if(i){if(f<=h)try{for(;f<=h;f++){p[f].isShared&&(p[f]=p[f].clone());let d=p[f].forRange(e,s,n,i,r,o,a);if(u[f]=p[f].maxKey(),typeof d!="number")return d;o=d}}finally{let d=r._maxNodeSize>>1;for(c>0&&c--,f=h;f>=c;f--)p[f].keys.length<=d&&(p[f].keys.length!==0?this.tryMerge(f,r._maxNodeSize):(u.splice(f,1),p.splice(f,1)));p.length!==0&&p[0].keys.length===0&&Ur(!1,"emptiness bug")}}else for(;f<=h;f++){let d=p[f].forRange(e,s,n,i,r,o,a);if(typeof d!="number")return d;o=d}return o}tryMerge(e,s){let n=this.children;return e>=0&&e+1<n.length&&n[e].keys.length+n[e+1].keys.length<=s?(n[e].isShared&&(n[e]=n[e].clone()),n[e].mergeSibling(n[e+1],s),n.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=n[e].maxKey(),!0):!1}mergeSibling(e,s){let n=this.keys.length;this.keys.push.apply(this.keys,e.keys);let i=e.children;if(this.children.push.apply(this.children,i),e.isShared&&!this.isShared)for(let r of i)r.isShared=!0;this.tryMerge(n-1,s)}},z=[],$r={delete:!0},Nr=()=>$r,zs=(function(){let t=new as;return t.isShared=!0,t})(),hn=[];function Ur(t,...e){throw e.unshift("B+ tree"),new Error(e.join(" "))}function dn(){let t=new Map;function e(s){let n=s.join(".");if(t.has(n))return t.get(n);let i=new Proxy({},{get(r,o,a){if(o==="__refProxy")return!0;if(o==="__path")return s;if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(r,o,a);let l=[...s,String(o)];return e(l)},has(r,o){return o==="__refProxy"||o==="__path"||o==="__type"?!0:Reflect.has(r,o)},ownKeys(r){return Reflect.ownKeys(r)},getOwnPropertyDescriptor(r,o){return o==="__refProxy"||o==="__path"||o==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(r,o)}});return t.set(n,i),i}return e([])}function ye(t){let e=new Map,s=0;function n(r){let o=r.join(".");if(e.has(o))return e.get(o);let a=new Proxy({},{get(l,u,p){if(u==="__refProxy")return!0;if(u==="__path")return r;if(u==="__type")return;if(typeof u=="symbol")return Reflect.get(l,u,p);let c=[...r,String(u)];return n(c)},has(l,u){return u==="__refProxy"||u==="__path"||u==="__type"?!0:Reflect.has(l,u)},ownKeys(l){let u=++s,p=`__SPREAD_SENTINEL__${r.join(".")}__${u}`;return Object.prototype.hasOwnProperty.call(l,p)||Object.defineProperty(l,p,{enumerable:!0,configurable:!0,value:!0}),Reflect.ownKeys(l)},getOwnPropertyDescriptor(l,u){return u==="__refProxy"||u==="__path"||u==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(l,u)}});return e.set(o,a),a}return new Proxy({},{get(r,o,a){if(o==="__refProxy")return!0;if(o==="__path")return[];if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(r,o,a);let l=String(o);if(t.includes(l))return n([l])},has(r,o){return o==="__refProxy"||o==="__path"||o==="__type"||typeof o=="string"&&t.includes(o)?!0:Reflect.has(r,o)},ownKeys(r){return[...t,"__refProxy","__path","__type"]},getOwnPropertyDescriptor(r,o){if(o==="__refProxy"||o==="__path"||o==="__type")return{enumerable:!1,configurable:!0};if(typeof o=="string"&&t.includes(o))return{enumerable:!0,configurable:!0}}})}function k(t){return Wr(t)?new P(t.__path):t&&typeof t=="object"&&"type"in t&&(t.type==="func"||t.type==="ref"||t.type==="val"||t.type==="agg")?t:new K(t)}function Wr(t){return t&&typeof t=="object"&&t.__refProxy===!0}function fn(t,e){return new R("eq",[k(t),k(e)])}function cs(t,e){return new R("gt",[k(t),k(e)])}function pn(t,e){return new R("gte",[k(t),k(e)])}function ls(t,e){return new R("lt",[k(t),k(e)])}function yn(t,e){return new R("lte",[k(t),k(e)])}function Gt(t,e,...s){let n=[t,e,...s];return new R("and",n.map(i=>k(i)))}function gn(t,e,...s){let n=[t,e,...s];return new R("or",n.map(i=>k(i)))}function mn(t){return new R("not",[k(t)])}function vn(t){return new R("isUndefined",[k(t)])}function wn(t){return new R("isNull",[k(t)])}function us(t,e){return new R("in",[k(t),k(e)])}function Sn(t,e){return new R("like",[k(t),k(e)])}function xn(t,e){return new R("ilike",[k(t),k(e)])}function bn(t){return new R("upper",[k(t)])}function kn(t){return new R("lower",[k(t)])}function Cn(t){return new R("length",[k(t)])}function En(...t){return new R("concat",t.map(e=>k(e)))}function In(...t){return new R("coalesce",t.map(e=>k(e)))}function _n(t,e){return new R("add",[k(t),k(e)])}function On(t){return new $("count",[k(t)])}function Rn(t){return new $("avg",[k(t)])}function Tn(t){return new $("sum",[k(t)])}function Pn(t){return new $("min",[k(t)])}function An(t){return new $("max",[k(t)])}var Fn=["eq","gt","gte","lt","lte","in","like","ilike"];var Mn=Fn,Ot=class{constructor(e,s,n,i){this.lookupCount=0,this.totalLookupTime=0,this.lastUpdated=new Date,this.id=e,this.expression=s,this.compareOptions=_t,this.name=n,this.initialize(i)}supports(e){return this.supportedOperations.has(e)}matchesField(e){return this.expression.type==="ref"&&this.expression.path.length===e.length&&this.expression.path.every((s,n)=>s===e[n])}matchesCompareOptions(e){let s={...this.compareOptions,direction:void 0},n={...e,direction:void 0};return L(s,n)}matchesDirection(e){return this.compareOptions.direction===e}getStats(){return{entryCount:this.keyCount,lookupCount:this.lookupCount,averageLookupTime:this.lookupCount>0?this.totalLookupTime/this.lookupCount:0,lastUpdated:this.lastUpdated}}evaluateIndexExpression(e){return qt(this.expression)(e)}trackLookup(e){let s=performance.now()-e;this.lookupCount++,this.totalLookupTime+=s}updateTimestamp(){this.lastUpdated=new Date}};var Y=class extends Ot{constructor(e,s,n,i){super(e,s,n,i),this.supportedOperations=new Set(["eq","gt","gte","lt","lte","in"]),this.valueMap=new Map,this.indexedKeys=new Set,this.compareFn=Vt,this.compareFn=i?.compareFn??Vt,i?.compareOptions&&(this.compareOptions=i.compareOptions),this.orderedEntries=new os(this.compareFn)}initialize(e){}add(e,s){let n;try{n=this.evaluateIndexExpression(s)}catch(r){throw new Error(`Failed to evaluate index expression for key ${e}: ${r}`)}let i=V(n);if(this.valueMap.has(i))this.valueMap.get(i).add(e);else{let r=new Set([e]);this.valueMap.set(i,r),this.orderedEntries.set(i,void 0)}this.indexedKeys.add(e),this.updateTimestamp()}remove(e,s){let n;try{n=this.evaluateIndexExpression(s)}catch(r){console.warn(`Failed to evaluate index expression for key ${e} during removal:`,r);return}let i=V(n);if(this.valueMap.has(i)){let r=this.valueMap.get(i);r.delete(e),r.size===0&&(this.valueMap.delete(i),this.orderedEntries.delete(i))}this.indexedKeys.delete(e),this.updateTimestamp()}update(e,s,n){this.remove(e,s),this.add(e,n)}build(e){this.clear();for(let[s,n]of e)this.add(s,n)}clear(){this.orderedEntries.clear(),this.valueMap.clear(),this.indexedKeys.clear(),this.updateTimestamp()}lookup(e,s){let n=performance.now(),i;switch(e){case"eq":i=this.equalityLookup(s);break;case"gt":i=this.rangeQuery({from:s,fromInclusive:!1});break;case"gte":i=this.rangeQuery({from:s,fromInclusive:!0});break;case"lt":i=this.rangeQuery({to:s,toInclusive:!1});break;case"lte":i=this.rangeQuery({to:s,toInclusive:!0});break;case"in":i=this.inArrayLookup(s);break;default:throw new Error(`Operation ${e} not supported by BTreeIndex`)}return this.trackLookup(n),i}get keyCount(){return this.indexedKeys.size}equalityLookup(e){let s=V(e);return new Set(this.valueMap.get(s)??[])}rangeQuery(e={}){let{from:s,to:n,fromInclusive:i=!0,toInclusive:r=!0}=e,o=new Set,a=V(s),l=V(n),u=a??this.orderedEntries.minKey(),p=l??this.orderedEntries.maxKey();return this.orderedEntries.forRange(u,p,r,(c,f)=>{if(!i&&this.compareFn(c,s)===0)return;let h=this.valueMap.get(c);h&&h.forEach(d=>o.add(d))}),o}rangeQueryReversed(e={}){let{from:s,to:n,fromInclusive:i=!0,toInclusive:r=!0}=e;return this.rangeQuery({from:n??this.orderedEntries.maxKey(),to:s??this.orderedEntries.minKey(),fromInclusive:r,toInclusive:i})}takeInternal(e,s,n,i){let r=new Set,o=[],a,l=V(n);for(;(a=s(l))!==void 0&&o.length<e;){l=a[0];let u=this.valueMap.get(l);if(u){let p=u.values(),c;for(;o.length<e&&(c=p.next().value);)!r.has(c)&&(i?.(c)??!0)&&(o.push(c),r.add(c))}}return o}take(e,s,n){let i=r=>this.orderedEntries.nextHigherPair(r);return this.takeInternal(e,i,s,n)}takeReversed(e,s,n){let i=r=>this.orderedEntries.nextLowerPair(r);return this.takeInternal(e,i,s,n)}inArrayLookup(e){let s=new Set;for(let n of e){let i=V(n),r=this.valueMap.get(i);r&&r.forEach(o=>s.add(o))}return s}get indexedKeysSet(){return this.indexedKeys}get orderedEntriesArray(){return this.orderedEntries.keysArray().map(e=>[e,this.valueMap.get(e)??new Set])}get orderedEntriesArrayReversed(){return this.takeReversed(this.orderedEntries.size).map(e=>[e,this.valueMap.get(e)??new Set])}get valueMapData(){return this.valueMap}};function Kn(t){return t.config.autoIndex==="eager"}function ge(t,e,s,n=_t,i){if(!(!Kn(s)||Array.from(s.indexes.values()).find(o=>o.matchesField(e)&&o.matchesCompareOptions(n))))try{s.createIndex(o=>o[t],{name:`auto_${t}`,indexType:Y,options:i?{compareFn:i,compareOptions:n}:{}})}catch(o){console.warn(`${s.id?`[${s.id}] `:""}Failed to create auto-index for field "${t}":`,o)}}function Bn(t,e){if(!Kn(e))return;let s=Vr(t);for(let{fieldName:n,fieldPath:i}of s)ge(n,i,e)}function Vr(t){let e=[];function s(n){if(n.type!=="func")return;let i=n;if(i.name==="and"){for(let u of i.args)s(u);return}if(!["eq","gt","gte","lt","lte","in"].includes(i.name)||i.args.length<1||i.args[0].type!=="ref")return;let a=i.args[0].path;if(a.length!==1)return;let l=a[0];e.push({fieldName:l,fieldPath:a})}return s(t),e}function zn(t,e={}){let s=n=>{let i=[];for(let[r,o]of t.entries())(n?.(o)??!0)&&i.push({type:"insert",key:r,value:o});return i};if(e.limit!==void 0&&!e.orderBy)throw new Error("limit cannot be used without orderBy");if(e.orderBy){let n=e.where?Rt(e.where):void 0,i=qr(t,e.orderBy,e.limit,n,e.optimizedOnly);if(i===void 0)return;let r=[];for(let o of i){let a=t.get(o);a!==void 0&&r.push({type:"insert",key:o,value:a})}return r}if(!e.where)return s();try{let n=e.where,i=un(n,t.indexes);if(i.canOptimize){let r=[];for(let o of i.matchingKeys){let a=t.get(o);a!==void 0&&r.push({type:"insert",key:o,value:a})}return r}else{if(e.optimizedOnly)return;let r=Rt(n);return s(r)}}catch(n){console.warn(`${t.id?`[${t.id}] `:""}Error processing where clause, falling back to full scan:`,n);let i=Rt(e.where);return e.optimizedOnly?void 0:s(i)}}function Rt(t){return e=>{try{return!!qt(t)(e)}catch{return!1}}}function Ln(t,e){let s=Rt(e.whereExpression);return n=>{let i=[];for(let r of n)if(r.type==="insert")s(r.value)&&i.push(r);else if(r.type==="update"){let o=s(r.value),a=r.previousValue?s(r.previousValue):!1;o&&a?i.push(r):o&&!a?i.push({...r,type:"insert"}):!o&&a&&i.push({...r,type:"delete",value:r.previousValue})}else s(r.value)&&i.push(r);(i.length>0||n.length===0)&&t(i)}}function qr(t,e,s,n,i){if(e.length===1){let l=e[0],u=l.expression;if(u.type==="ref"){let c=u.path;ge(c[0],c,t,l.compareOptions);let f=pe(t.indexes,c,l.compareOptions);if(f&&f.supports("gt")){let h=d=>{let y=t.get(d);return y===void 0?!1:n?.(y)??!0};return f.take(s??f.keyCount,void 0,h)}}}if(i)return;let r=[];for(let[l,u]of t.entries())(n?.(u)??!0)&&r.push({key:l,value:u});let o=(l,u)=>{for(let p of e){let c=It(p.compareOptions),f=Dn(l.value,p.expression),h=Dn(u.value,p.expression),d=c(f,h);if(d!==0)return d}return 0};r.sort(o);let a=r.map(l=>l.key);return s!==void 0?a.slice(0,s):a}function Dn(t,e){if(e.type==="ref"){let s=e,n=t;for(let i of s.path)n=n?.[i];return n}else return e.type==="val"?e.value:qt(e)(t)}var me=class{constructor(e){this.map=new Map,this.sortedKeys=[],this.comparator=e||this.defaultComparator}defaultComparator(e,s){return e<s?-1:e>s?1:0}indexOf(e){let s=0,n=this.sortedKeys.length;for(;s<n;){let i=Math.floor((s+n)/2),r=this.sortedKeys[i],o=this.map.get(r),a=this.comparator(e,o);if(a<0)n=i;else if(a>0)s=i+1;else return i}return s}set(e,s){if(this.map.has(e)){let i=this.map.get(e),r=this.indexOf(i);this.sortedKeys.splice(r,1)}let n=this.indexOf(s);return this.sortedKeys.splice(n,0,e),this.map.set(e,s),this}get(e){return this.map.get(e)}delete(e){if(this.map.has(e)){let s=this.map.get(e),n=this.indexOf(s);return this.sortedKeys.splice(n,1),this.map.delete(e)}return!1}has(e){return this.map.has(e)}clear(){this.map.clear(),this.sortedKeys=[]}get size(){return this.map.size}*[Symbol.iterator](){for(let e of this.sortedKeys)yield[e,this.map.get(e)]}entries(){return this[Symbol.iterator]()}keys(){return this.sortedKeys[Symbol.iterator]()}values(){return(function*(){for(let e of this.sortedKeys)yield this.map.get(e)}).call(this)}forEach(e){for(let s of this.sortedKeys)e(this.map.get(s),s,this.map)}};var hs=class{constructor(e){this.pendingSyncedTransactions=[],this.syncedMetadata=new Map,this.optimisticUpserts=new Map,this.optimisticDeletes=new Set,this.size=0,this.syncedKeys=new Set,this.preSyncVisibleState=new Map,this.recentlySyncedKeys=new Set,this.hasReceivedFirstCommit=!1,this.isCommittingSyncTransactions=!1,this.commitPendingTransactions=()=>{let s=!1;for(let o of this.transactions.values())if(o.state==="persisting"){s=!0;break}let{committedSyncedTransactions:n,uncommittedSyncedTransactions:i,hasTruncateSync:r}=this.pendingSyncedTransactions.reduce((o,a)=>(a.committed?(o.committedSyncedTransactions.push(a),a.truncate===!0&&(o.hasTruncateSync=!0)):o.uncommittedSyncedTransactions.push(a),o),{committedSyncedTransactions:[],uncommittedSyncedTransactions:[],hasTruncateSync:!1});if(!s||r){this.isCommittingSyncTransactions=!0;let o=r?n.find(f=>f.truncate)?.optimisticSnapshot:null,a=new Set;for(let f of n)for(let h of f.operations)a.add(h.key);let l=this.preSyncVisibleState;if(l.size===0){l=new Map;for(let f of a){let h=this.get(f);h!==void 0&&l.set(f,h)}}let u=[],p=this.config.sync.rowUpdateMode||"partial";for(let f of n){if(f.truncate){let h=new Set([...this.syncedData.keys(),...o?.upserts.keys()||[]]);for(let d of h){if(o?.deletes.has(d))continue;let y=o?.upserts.get(d)||this.syncedData.get(d);y!==void 0&&u.push({type:"delete",key:d,value:y})}this.syncedData.clear(),this.syncedMetadata.clear(),this.syncedKeys.clear();for(let d of a)l.delete(d)}for(let h of f.operations){let d=h.key;switch(this.syncedKeys.add(d),h.type){case"insert":this.syncedMetadata.set(d,h.metadata);break;case"update":this.syncedMetadata.set(d,Object.assign({},this.syncedMetadata.get(d),h.metadata));break;case"delete":this.syncedMetadata.delete(d);break}switch(h.type){case"insert":this.syncedData.set(d,h.value);break;case"update":{if(p==="partial"){let y=Object.assign({},this.syncedData.get(d),h.value);this.syncedData.set(d,y)}else this.syncedData.set(d,h.value);break}case"delete":this.syncedData.delete(d);break}}}if(r){let f=new Set;for(let y of n)for(let g of y.operations)(g.type==="insert"||g.type==="update")&&f.add(g.key);let h=new Map(o.upserts),d=new Set(o.deletes);for(let[y,g]of h)if(!d.has(y))if(f.has(y)){let x=!1;for(let m=u.length-1;m>=0;m--){let b=u[m];if(b.key===y&&b.type==="insert"){b.value=g,x=!0;break}}x||u.push({type:"insert",key:y,value:g})}else u.push({type:"insert",key:y,value:g});if(u.length>0&&d.size>0){let y=[];for(let g of u)g.type==="insert"&&d.has(g.key)||y.push(g);u.length=0,u.push(...y)}this.lifecycle.status!=="ready"&&this.lifecycle.markReady()}if(this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.isCommittingSyncTransactions=!1,r&&o){for(let[f,h]of o.upserts)this.optimisticUpserts.set(f,h);for(let f of o.deletes)this.optimisticDeletes.add(f)}for(let f of this.transactions.values())if(!["completed","failed"].includes(f.state)){for(let h of f.mutations)if(this.isThisCollection(h.collection)&&h.optimistic)switch(h.type){case"insert":case"update":this.optimisticUpserts.set(h.key,h.modified),this.optimisticDeletes.delete(h.key);break;case"delete":this.optimisticUpserts.delete(h.key),this.optimisticDeletes.add(h.key);break}}let c=new Map;for(let f of this.transactions.values())if(f.state==="completed")for(let h of f.mutations)h.optimistic&&this.isThisCollection(h.collection)&&a.has(h.key)&&c.set(h.key,{type:h.type,value:h.modified});for(let f of a){let h=l.get(f),d=this.get(f),y=c.get(f),g=!1;y&&(y.type==="delete"&&h!==void 0&&d===void 0&&L(y.value,h)||d!==void 0&&L(y.value,d))&&(g=!0),g||(h===void 0&&d!==void 0?u.push({type:"insert",key:f,value:d}):h!==void 0&&d===void 0?u.push({type:"delete",key:f,value:h}):h!==void 0&&d!==void 0&&!L(h,d)&&u.push({type:"update",key:f,value:d,previousValue:h}))}this.size=this.calculateSize(),u.length>0&&this.indexes.updateIndexes(u),this.changes.emitEvents(u,!0),this.pendingSyncedTransactions=i,this.preSyncVisibleState.clear(),Promise.resolve().then(()=>{this.recentlySyncedKeys.clear()}),this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0)}},this.config=e,this.transactions=new me((s,n)=>s.compareCreatedAt(n)),e.compare?this.syncedData=new me(e.compare):this.syncedData=new Map}setDeps(e){this.collection=e.collection,this.lifecycle=e.lifecycle,this.changes=e.changes,this.indexes=e.indexes}get(e){let{optimisticDeletes:s,optimisticUpserts:n,syncedData:i}=this;if(!s.has(e))return n.has(e)?n.get(e):i.get(e)}has(e){let{optimisticDeletes:s,optimisticUpserts:n,syncedData:i}=this;return s.has(e)?!1:n.has(e)?!0:i.has(e)}*keys(){let{syncedData:e,optimisticDeletes:s,optimisticUpserts:n}=this;for(let i of e.keys())s.has(i)||(yield i);for(let i of n.keys())!e.has(i)&&!s.has(i)&&(yield i)}*values(){for(let e of this.keys()){let s=this.get(e);s!==void 0&&(yield s)}}*entries(){for(let e of this.keys()){let s=this.get(e);s!==void 0&&(yield[e,s])}}*[Symbol.iterator](){for(let[e,s]of this.entries())yield[e,s]}forEach(e){let s=0;for(let[n,i]of this.entries())e(i,n,s++)}map(e){let s=[],n=0;for(let[i,r]of this.entries())s.push(e(r,i,n++));return s}isThisCollection(e){return e===this.collection}recomputeOptimisticState(e=!1){if(this.isCommittingSyncTransactions&&!e)return;let s=new Map(this.optimisticUpserts),n=new Set(this.optimisticDeletes);this.optimisticUpserts.clear(),this.optimisticDeletes.clear();let i=[];for(let a of this.transactions.values())["completed","failed"].includes(a.state)||i.push(a);for(let a of i)for(let l of a.mutations)if(this.isThisCollection(l.collection)&&l.optimistic)switch(l.type){case"insert":case"update":this.optimisticUpserts.set(l.key,l.modified),this.optimisticDeletes.delete(l.key);break;case"delete":this.optimisticUpserts.delete(l.key),this.optimisticDeletes.add(l.key);break}this.size=this.calculateSize();let r=[];this.collectOptimisticChanges(s,n,r);let o=r.filter(a=>!!(!this.recentlySyncedKeys.has(a.key)||e));if(this.pendingSyncedTransactions.length>0&&!e){let a=new Set;for(let u of this.pendingSyncedTransactions)for(let p of u.operations)a.add(p.key);let l=o.filter(u=>!(u.type==="delete"&&a.has(u.key)&&!i.some(c=>c.mutations.some(f=>this.isThisCollection(f.collection)&&f.key===u.key))));l.length>0&&this.indexes.updateIndexes(l),this.changes.emitEvents(l,e)}else o.length>0&&this.indexes.updateIndexes(o),this.changes.emitEvents(o,e)}calculateSize(){let e=this.syncedData.size,s=Array.from(this.optimisticDeletes).filter(i=>this.syncedData.has(i)&&!this.optimisticUpserts.has(i)).length,n=Array.from(this.optimisticUpserts.keys()).filter(i=>!this.syncedData.has(i)).length;return e-s+n}collectOptimisticChanges(e,s,n){let i=new Set([...e.keys(),...this.optimisticUpserts.keys(),...s,...this.optimisticDeletes]);for(let r of i){let o=this.get(r),a=this.getPreviousValue(r,e,s);a!==void 0&&o===void 0?n.push({type:"delete",key:r,value:a}):a===void 0&&o!==void 0?n.push({type:"insert",key:r,value:o}):a!==void 0&&o!==void 0&&a!==o&&n.push({type:"update",key:r,value:o,previousValue:a})}}getPreviousValue(e,s,n){if(!n.has(e))return s.has(e)?s.get(e):this.syncedData.get(e)}scheduleTransactionCleanup(e){if(e.state==="completed"){this.transactions.delete(e.id);return}e.isPersisted.promise.then(()=>{this.transactions.delete(e.id)}).catch(()=>{})}capturePreSyncVisibleState(){if(this.pendingSyncedTransactions.length===0)return;let e=new Set;for(let s of this.pendingSyncedTransactions)for(let n of s.operations)e.add(n.key);for(let s of e)this.recentlySyncedKeys.add(s);for(let s of e)if(!this.preSyncVisibleState.has(s)){let n=this.get(s);n!==void 0&&this.preSyncVisibleState.set(s,n)}}onTransactionStateChange(){this.changes.shouldBatchEvents=this.pendingSyncedTransactions.length>0,this.capturePreSyncVisibleState(),this.recomputeOptimisticState(!1)}cleanup(){this.syncedData.clear(),this.syncedMetadata.clear(),this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.size=0,this.pendingSyncedTransactions=[],this.syncedKeys.clear(),this.hasReceivedFirstCommit=!1}};var Tt=class{constructor(){this.listeners=new Map}on(e,s){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(s),()=>{this.listeners.get(e)?.delete(s)}}once(e,s){let n=this.on(e,i=>{s(i),n()});return n}off(e,s){this.listeners.get(e)?.delete(s)}waitFor(e,s){return new Promise((n,i)=>{let r,o=this.on(e,a=>{r&&(clearTimeout(r),r=void 0),n(a),o()});s&&(r=setTimeout(()=>{r=void 0,o(),i(new Error(`Timeout waiting for event ${String(e)}`))},s))})}emitInner(e,s){this.listeners.get(e)?.forEach(n=>{try{n(s)}catch(i){queueMicrotask(()=>{throw i})}})}clearListeners(){this.listeners.clear()}};var ds=class extends Tt{constructor(e,s,n){super(),this.collection=e,this.callback=s,this.options=n,this.loadedInitialState=!1,this.snapshotSent=!1,this.sentKeys=new Set,this._status="ready",this.pendingLoadSubsetPromises=new Set,n.onUnsubscribe&&this.on("unsubscribed",r=>n.onUnsubscribe(r)),n.whereExpression&&Bn(n.whereExpression,this.collection);let i=r=>{s(r),this.trackSentKeys(r)};this.callback=i,this.filteredCallback=n.whereExpression?Ln(this.callback,n):this.callback}get status(){return this._status}setOrderByIndex(e){this.orderByIndex=e}setStatus(e){if(this._status===e)return;let s=this._status;this._status=e,this.emitInner("status:change",{type:"status:change",subscription:this,previousStatus:s,status:e});let n=`status:${e}`;this.emitInner(n,{type:n,subscription:this,previousStatus:s,status:e})}trackLoadSubsetPromise(e){e instanceof Promise&&(this.pendingLoadSubsetPromises.add(e),this.setStatus("loadingSubset"),e.finally(()=>{this.pendingLoadSubsetPromises.delete(e),this.pendingLoadSubsetPromises.size===0&&this.setStatus("ready")}))}hasLoadedInitialState(){return this.loadedInitialState}hasSentAtLeastOneSnapshot(){return this.snapshotSent}emitEvents(e){let s=this.filterAndFlipChanges(e);this.filteredCallback(s)}requestSnapshot(e){if(this.loadedInitialState)return!1;let s={where:this.options.whereExpression,optimizedOnly:e?.optimizedOnly??!1};if(e){if("where"in e){let o=e.where;if(s.where){let a=s.where,l=Gt(a,o);s.where=l}else s.where=o}}else this.loadedInitialState=!0;let n=this.collection._sync.loadSubset({where:s.where,subscription:this});this.trackLoadSubsetPromise(n);let i=this.collection.currentStateAsChanges(s);if(i===void 0)return!1;let r=i.filter(o=>!this.sentKeys.has(o.key));return this.snapshotSent=!0,this.callback(r),!0}requestLimitedSnapshot({orderBy:e,limit:s,minValue:n}){if(!s)throw new Error("limit is required");if(!this.orderByIndex)throw new Error("Ordered snapshot was requested but no index was found. You have to call setOrderByIndex before requesting an ordered snapshot.");let i=this.orderByIndex,r=this.options.whereExpression,o=r?Rt(r):void 0,a=y=>{if(this.sentKeys.has(y))return!1;let g=this.collection.get(y);return g===void 0?!1:o?.(g)??!0},l=n,u=[],p=i.take(s,n,a),c=()=>Math.max(s-u.length,0),f=()=>p.length===0;for(;c()>0&&!f();){for(let y of p){let g=this.collection.get(y);u.push({type:"insert",key:y,value:g}),l=g}p=i.take(c(),l,a)}this.callback(u);let h=r;if(typeof n<"u"){let{expression:y,compareOptions:g}=e[0],m=(g.direction==="asc"?cs:ls)(y,new K(n));h=r?Gt(r,m):m}let d=this.collection._sync.loadSubset({where:h,limit:s,orderBy:e,subscription:this});this.trackLoadSubsetPromise(d)}filterAndFlipChanges(e){if(this.loadedInitialState)return e;let s=[];for(let n of e){let i=n;if(!this.sentKeys.has(n.key)){if(n.type==="update")i={...n,type:"insert",previousValue:void 0};else if(n.type==="delete")continue;this.sentKeys.add(n.key)}s.push(i)}return s}trackSentKeys(e){if(!this.loadedInitialState)for(let s of e)this.sentKeys.add(s.key)}unsubscribe(){this.emitInner("unsubscribed",{type:"unsubscribed",subscription:this}),this.clearListeners()}};var fs=class{constructor(){this.activeSubscribersCount=0,this.changeSubscriptions=new Set,this.batchedEvents=[],this.shouldBatchEvents=!1}setDeps(e){this.lifecycle=e.lifecycle,this.sync=e.sync,this.events=e.events,this.collection=e.collection}emitEmptyReadyEvent(){for(let e of this.changeSubscriptions)e.emitEvents([])}emitEvents(e,s=!1){if(this.shouldBatchEvents&&!s){this.batchedEvents.push(...e);return}let n=e;if(s&&(this.batchedEvents.length>0&&(n=[...this.batchedEvents,...e]),this.batchedEvents=[],this.shouldBatchEvents=!1),n.length!==0)for(let i of this.changeSubscriptions)i.emitEvents(n)}subscribeChanges(e,s={}){this.addSubscriber();let n=new ds(this.collection,e,{...s,onUnsubscribe:()=>{this.removeSubscriber(),this.changeSubscriptions.delete(n)}});return s.includeInitialState&&n.requestSnapshot(),this.changeSubscriptions.add(n),n}addSubscriber(){let e=this.activeSubscribersCount;this.activeSubscribersCount++,this.lifecycle.cancelGCTimer(),(this.lifecycle.status==="cleaned-up"||this.lifecycle.status==="idle")&&this.sync.startSync(),this.events.emitSubscribersChange(this.activeSubscribersCount,e)}removeSubscriber(){let e=this.activeSubscribersCount;if(this.activeSubscribersCount--,this.activeSubscribersCount===0)this.lifecycle.startGCTimer();else if(this.activeSubscribersCount<0)throw new _e;this.events.emitSubscribersChange(this.activeSubscribersCount,e)}cleanup(){this.batchedEvents=[],this.shouldBatchEvents=!1}};var Qr=t=>setTimeout(()=>{t({didTimeout:!0,timeRemaining:()=>50})},0),Gr=t=>{clearTimeout(t)},jn=typeof window<"u"&&"requestIdleCallback"in window?(t,e)=>window.requestIdleCallback(t,e):(t,e)=>Qr(t),ps=typeof window<"u"&&"cancelIdleCallback"in window?t=>window.cancelIdleCallback(t):Gr;var ys=class{constructor(e,s){this.status="idle",this.hasBeenReady=!1,this.hasReceivedFirstCommit=!1,this.onFirstReadyCallbacks=[],this.gcTimeoutId=null,this.idleCallbackId=null,this.config=e,this.id=s}setDeps(e){this.indexes=e.indexes,this.events=e.events,this.changes=e.changes,this.sync=e.sync,this.state=e.state}validateStatusTransition(e,s){if(e===s)return;if(!{idle:["loading","error","cleaned-up"],loading:["ready","error","cleaned-up"],ready:["cleaned-up","error"],error:["cleaned-up","idle"],"cleaned-up":["loading","error"]}[e].includes(s))throw new Ee(e,s,this.id)}setStatus(e,s=!1){if(e==="ready"&&!s)throw new G(`You can't directly call "setStatus('ready'). You must use markReady instead.`);this.validateStatusTransition(this.status,e);let n=this.status;this.status=e,e==="ready"&&!this.indexes.isIndexesResolved&&this.indexes.resolveAllIndexes().catch(i=>{console.warn(`${this.config.id?`[${this.config.id}] `:""}Failed to resolve indexes:`,i)}),this.events.emitStatusChange(e,n)}validateCollectionUsable(e){switch(this.status){case"error":throw new Ce(e,this.id);case"cleaned-up":this.sync.startSync();break}}markReady(){if(this.validateStatusTransition(this.status,"ready"),this.status==="loading"){if(this.setStatus("ready",!0),!this.hasBeenReady){this.hasBeenReady=!0,this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0);let e=[...this.onFirstReadyCallbacks];this.onFirstReadyCallbacks=[],e.forEach(s=>s())}this.changes.changeSubscriptions.size>0&&this.changes.emitEmptyReadyEvent()}}startGCTimer(){this.gcTimeoutId&&clearTimeout(this.gcTimeoutId);let e=this.config.gcTime??3e5;e!==0&&(this.gcTimeoutId=setTimeout(()=>{this.changes.activeSubscribersCount===0&&this.scheduleIdleCleanup()},e))}cancelGCTimer(){this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.idleCallbackId!==null&&(ps(this.idleCallbackId),this.idleCallbackId=null)}scheduleIdleCleanup(){this.idleCallbackId!==null&&ps(this.idleCallbackId),this.idleCallbackId=jn(e=>{this.changes.activeSubscribersCount===0?this.performCleanup(e)&&(this.idleCallbackId=null):this.idleCallbackId=null},{timeout:1e3})}performCleanup(e){return!e||e.timeRemaining()>0||e.didTimeout?(this.sync.cleanup(),this.state.cleanup(),this.changes.cleanup(),this.indexes.cleanup(),this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.hasBeenReady=!1,this.onFirstReadyCallbacks=[],this.setStatus("cleaned-up"),this.events.cleanup(),!0):(this.scheduleIdleCleanup(),!1)}onFirstReady(e){if(this.hasBeenReady){e();return}this.onFirstReadyCallbacks.push(e)}cleanup(){this.idleCallbackId!==null&&(ps(this.idleCallbackId),this.idleCallbackId=null),this.performCleanup()}};var gs=class{constructor(e,s){this.preloadPromise=null,this.syncCleanupFn=null,this.syncLoadSubsetFn=null,this.pendingLoadSubsetPromises=new Set,this.config=e,this.id=s,this.syncMode=e.syncMode??"eager"}setDeps(e){this.collection=e.collection,this.state=e.state,this.lifecycle=e.lifecycle,this._events=e.events}startSync(){if(!(this.lifecycle.status!=="idle"&&this.lifecycle.status!=="cleaned-up")){this.lifecycle.setStatus("loading");try{let e=Hr(this.config.sync.sync({collection:this.collection,begin:()=>{this.state.pendingSyncedTransactions.push({committed:!1,operations:[],deletedKeys:new Set})},write:s=>{let n=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!n)throw new le;if(n.committed)throw new ue;let i=this.config.getKey(s.value),r=s.type;if(s.type==="insert"){let a=this.state.syncedData.has(i),l=n.deletedKeys.has(i),u=n.truncate===!0;if(a&&!l&&!u){let p=this.state.syncedData.get(i);if(p!==void 0&&L(p,s.value))r="update";else throw new Te(i,this.id)}}let o={...s,type:r,key:i};n.operations.push(o),r==="delete"&&n.deletedKeys.add(i)},commit:()=>{let s=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!s)throw new We;if(s.committed)throw new Ve;s.committed=!0,this.state.commitPendingTransactions()},markReady:()=>{this.lifecycle.markReady()},truncate:()=>{let s=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!s)throw new le;if(s.committed)throw new ue;s.operations=[],s.deletedKeys.clear(),s.truncate=!0,s.optimisticSnapshot={upserts:new Map(this.state.optimisticUpserts),deletes:new Set(this.state.optimisticDeletes)}}}));if(this.syncCleanupFn=e?.cleanup??null,this.syncLoadSubsetFn=e?.loadSubset??null,this.syncMode==="on-demand"&&!this.syncLoadSubsetFn)throw new Q(`Collection "${this.id}" is configured with syncMode "on-demand" but the sync function did not return a loadSubset handler. Either provide a loadSubset handler or use syncMode "eager".`)}catch(e){throw this.lifecycle.setStatus("error"),e}}}preload(){return this.preloadPromise?this.preloadPromise:(this.preloadPromise=new Promise((e,s)=>{if(this.lifecycle.status==="ready"){e();return}if(this.lifecycle.status==="error"){s(new Ie);return}if(this.lifecycle.onFirstReady(()=>{e()}),this.lifecycle.status==="idle"||this.lifecycle.status==="cleaned-up")try{this.startSync()}catch(n){s(n);return}}),this.preloadPromise)}get isLoadingSubset(){return this.pendingLoadSubsetPromises.size>0}trackLoadPromise(e){let s=!this.isLoadingSubset;this.pendingLoadSubsetPromises.add(e),s&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!0,previousIsLoadingSubset:!1,loadingSubsetTransition:"start"}),e.finally(()=>{let n=this.pendingLoadSubsetPromises.size===1&&this.pendingLoadSubsetPromises.has(e);this.pendingLoadSubsetPromises.delete(e),n&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!1,previousIsLoadingSubset:!0,loadingSubsetTransition:"end"})})}loadSubset(e){if(this.syncMode==="eager")return!0;if(this.syncLoadSubsetFn){let s=this.syncLoadSubsetFn(e);if(s instanceof Promise)return this.trackLoadPromise(s),s}return!0}cleanup(){try{this.syncCleanupFn&&(this.syncCleanupFn(),this.syncCleanupFn=null)}catch(e){queueMicrotask(()=>{if(e instanceof Error){let s=new fe(this.id,e);throw s.cause=e,s.stack=e.stack,s}else throw new fe(this.id,e)})}this.preloadPromise=null}};function Hr(t){if(typeof t=="function")return{cleanup:t};if(typeof t=="object")return t}function $n(t){return typeof t=="function"&&t.prototype!==void 0&&t.prototype.constructor===t}async function Jr(t){return $n(t)?t:await t()}var Pt=class{constructor(e,s,n,i,r,o){this.id=e,this.expression=s,this.name=n,this.resolver=i,this.options=r,this.collectionEntries=o,this.indexPromise=null,this.resolvedIndex=null,$n(this.resolver)&&(this.resolvedIndex=new this.resolver(this.id,this.expression,this.name,this.options),this.collectionEntries&&this.resolvedIndex.build(this.collectionEntries))}async resolve(){return this.resolvedIndex?this.resolvedIndex:(this.indexPromise||(this.indexPromise=this.createIndex()),this.resolvedIndex=await this.indexPromise,this.resolvedIndex)}isResolved(){return this.resolvedIndex!==null}getResolved(){if(!this.resolvedIndex)throw new Error(`Index ${this.id} has not been resolved yet. Ensure collection is synced.`);return this.resolvedIndex}getId(){return this.id}getName(){return this.name}getExpression(){return this.expression}async createIndex(){let e=await Jr(this.resolver);return new e(this.id,this.expression,this.name,this.options)}},At=class{constructor(e,s){this.indexId=e,this.lazyIndex=s}get index(){return this.lazyIndex.getResolved()}get isReady(){return this.lazyIndex.isResolved()}async whenReady(){return await this.lazyIndex.resolve()}get id(){return this.indexId}get name(){return this.isReady?this.index.name:this.lazyIndex.getName()}get expression(){return this.lazyIndex.getExpression()}supports(e){return this.index.supports(e)}getStats(){return this.index.getStats()}matchesField(e){let s=this.expression;return s.type==="ref"&&s.path.length===e.length&&s.path.every((n,i)=>n===e[i])}get keyCount(){return this.index.keyCount}get indexedKeysSet(){return this.index.indexedKeysSet}get orderedEntriesArray(){return this.index.orderedEntriesArray}get valueMapData(){return this.index.valueMapData}equalityLookup(e){return this.index.equalityLookup?.(e)??new Set}rangeQuery(e){return this.index.rangeQuery?.(e)??new Set}inArrayLookup(e){return this.index.inArrayLookup?.(e)??new Set}_getLazyWrapper(){return this.lazyIndex}};var ms=class{constructor(){this.lazyIndexes=new Map,this.resolvedIndexes=new Map,this.isIndexesResolved=!1,this.indexCounter=0}setDeps(e){this.state=e.state,this.lifecycle=e.lifecycle}createIndex(e,s={}){this.lifecycle.validateCollectionUsable("createIndex");let n=++this.indexCounter,i=dn(),r=e(i),o=k(r),a=s.indexType??Y,l=new Pt(n,o,s.name,a,s.options,this.state.entries());if(this.lazyIndexes.set(n,l),a===Y)try{let u=l.getResolved();this.resolvedIndexes.set(n,u)}catch(u){console.warn("Failed to resolve BTreeIndex:",u)}else if(typeof a=="function"&&a.prototype)try{let u=l.getResolved();this.resolvedIndexes.set(n,u)}catch{this.resolveSingleIndex(n,l).catch(u=>{console.warn("Failed to resolve single index:",u)})}else this.isIndexesResolved&&this.resolveSingleIndex(n,l).catch(u=>{console.warn("Failed to resolve single index:",u)});return new At(n,l)}async resolveAllIndexes(){if(this.isIndexesResolved)return;let e=Array.from(this.lazyIndexes.entries()).map(async([s,n])=>{let i=await n.resolve();return i.build(this.state.entries()),this.resolvedIndexes.set(s,i),{indexId:s,resolvedIndex:i}});await Promise.all(e),this.isIndexesResolved=!0}async resolveSingleIndex(e,s){let n=await s.resolve();return n.build(this.state.entries()),this.resolvedIndexes.set(e,n),n}get indexes(){return this.resolvedIndexes}updateIndexes(e){for(let s of this.resolvedIndexes.values())for(let n of e)switch(n.type){case"insert":s.add(n.key,n.value);break;case"update":n.previousValue?s.update(n.key,n.previousValue,n.value):s.add(n.key,n.value);break;case"delete":s.remove(n.key,n.value);break}}cleanup(){this.lazyIndexes.clear(),this.resolvedIndexes.clear()}};function I(...t){let e=typeof window<"u"&&typeof localStorage<"u";e&&localStorage.getItem("DEBUG")==="true"?console.log("[proxy]",...t):!e&&typeof process<"u"&&process.env.DEBUG==="true"&&console.log("[proxy]",...t)}function Z(t,e=new WeakMap){if(t==null||typeof t!="object")return t;if(e.has(t))return e.get(t);if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return new RegExp(t.source,t.flags);if(Array.isArray(t)){let i=[];return e.set(t,i),t.forEach((r,o)=>{i[o]=Z(r,e)}),i}if(ArrayBuffer.isView(t)&&!(t instanceof DataView)){let i=Object.getPrototypeOf(t).constructor,r=new i(t.length);e.set(t,r);for(let o=0;o<t.length;o++)r[o]=t[o];return r}if(t instanceof Map){let i=new Map;return e.set(t,i),t.forEach((r,o)=>{i.set(o,Z(r,e))}),i}if(t instanceof Set){let i=new Set;return e.set(t,i),t.forEach(r=>{i.add(Z(r,e))}),i}if(Qt(t))return t;let s={};e.set(t,s);for(let i in t)Object.prototype.hasOwnProperty.call(t,i)&&(s[i]=Z(t[i],e));let n=Object.getOwnPropertySymbols(t);for(let i of n)s[i]=Z(t[i],e);return s}var Nn=0;function Yr(){return Nn+=1,Nn}function Ht(t,e){let s=new Map;function n(c,f){if(I("Object ID:",c.constructor.name),s.has(c))return s.get(c);{let h=Ht(c,f);return s.set(c,h),h}}let i=new Map,r={copy_:Z(t),originalObject:Z(t),proxyCount:Yr(),modified:!1,assigned_:{},parent:e,target:t};I("createChangeProxy called for target",t,r.proxyCount);function o(c){c.modified||(c.modified=!0),c.parent&&(I("propagating change to parent"),"updateMap"in c.parent?c.parent.updateMap(c.copy_):"updateSet"in c.parent?c.parent.updateSet(c.copy_):(c.parent.tracker.copy_[c.parent.prop]=c.copy_,c.parent.tracker.assigned_[c.parent.prop]=!0),o(c.parent.tracker))}function a(c){if(I("checkIfReverted called with assigned keys:",Object.keys(c.assigned_)),Object.keys(c.assigned_).length===0&&Object.getOwnPropertySymbols(c.assigned_).length===0)return I("No assigned properties, returning true"),!0;for(let h in c.assigned_)if(c.assigned_[h]===!0){let d=c.copy_[h],y=c.originalObject[h];if(I(`Checking property ${String(h)}, current:`,d,"original:",y),!L(d,y))return I(`Property ${String(h)} is different, returning false`),!1}else if(c.assigned_[h]===!1)return I(`Property ${String(h)} was deleted, returning false`),!1;let f=Object.getOwnPropertySymbols(c.assigned_);for(let h of f)if(c.assigned_[h]===!0){let d=c.copy_[h],y=c.originalObject[h];if(!L(d,y))return I("Symbol property is different, returning false"),!1}else if(c.assigned_[h]===!1)return I("Symbol property was deleted, returning false"),!1;return I("All properties match original values, returning true"),!0}function l(c,f){I("checkParentStatus called for child prop:",f);let h=a(c);I("Parent checkIfReverted returned:",h),h&&(I("Parent is fully reverted, clearing tracking"),c.modified=!1,c.assigned_={},c.parent&&(I("Continuing up the parent chain"),l(c.parent.tracker,c.parent.prop)))}function u(c){if(I("createObjectProxy",c),i.has(c))return I("proxyCache found match"),i.get(c);let f=new Proxy(c,{get(h,d){I("get",h,d);let y=r.copy_[d]??r.originalObject[d],g=r.originalObject[d];if(I("value (at top of proxy get)",y),Object.getOwnPropertyDescriptor(h,d)?.get)return y;if(typeof y=="function"){if(Array.isArray(h)){let m=d.toString();if(new Set(["pop","push","shift","unshift","splice","sort","reverse","fill","copyWithin"]).has(m))return function(...C){let T=y.apply(r.copy_,C);return o(r),T}}if(h instanceof Map||h instanceof Set){let m=d.toString();if(new Set(["set","delete","clear","add","pop","push","shift","unshift","splice","sort","reverse"]).has(m))return function(...T){let _=y.apply(r.copy_,T);return o(r),_};if(new Set(["entries","keys","values","forEach",Symbol.iterator]).has(m)||d===Symbol.iterator)return function(...T){let _=y.apply(r.copy_,T);if(m==="forEach"){let E=T[0];if(typeof E=="function"){let S=function(v,w,O){let F=E.call(this,v,w,O);return o(r),F};return y.apply(h,[S,...T.slice(1)])}}if(m==="entries"||m==="values"||m===Symbol.iterator.toString()||d===Symbol.iterator){let E=_,S=new Map;if(m==="values"&&h instanceof Map)for(let[w,O]of r.copy_.entries())S.set(O,w);let v=new Map;if(h instanceof Set)for(let w of r.copy_.values())v.set(w,w);return{next(){let w=E.next();if(!w.done&&w.value&&typeof w.value=="object"){if(m==="entries"&&Array.isArray(w.value)&&w.value.length===2){if(w.value[1]&&typeof w.value[1]=="object"){let O=w.value[0],F={tracker:r,prop:O,updateMap:q=>{r.copy_ instanceof Map&&r.copy_.set(O,q)}},{proxy:H}=n(w.value[1],F);w.value[1]=H}}else if((m==="values"||m===Symbol.iterator.toString()||d===Symbol.iterator)&&typeof w.value=="object"&&w.value!==null)if(m==="values"&&h instanceof Map){let O=S.get(w.value);if(O!==void 0){let F={tracker:r,prop:O,updateMap:q=>{r.copy_ instanceof Map&&r.copy_.set(O,q)}},{proxy:H}=n(w.value,F);w.value=H}}else if(h instanceof Set){let O=w.value,F={tracker:r,prop:O,updateSet:q=>{r.copy_ instanceof Set&&(r.copy_.delete(O),r.copy_.add(q),v.set(O,q))}},{proxy:H}=n(w.value,F);w.value=H}else{let O=Symbol("iterator-value"),{proxy:F}=n(w.value,{tracker:r,prop:O});w.value=F}}return w},[Symbol.iterator](){return this}}}return _}}return y.bind(h)}if(y&&typeof y=="object"&&!(y instanceof Date)&&!(y instanceof RegExp)&&!Qt(y)){let m={tracker:r,prop:String(d)},{proxy:b}=n(g,m);return i.set(y,b),b}return y},set(h,d,y){let g=r.copy_[d];if(I(`set called for property ${String(d)}, current:`,g,"new:",y),L(g,y))I("Value unchanged, not tracking");else{let x=r.originalObject[d],m=L(y,x);if(I("value:",y,"original:",x,"isRevertToOriginal:",m),m){I(`Reverting property ${String(d)} to original value`),delete r.assigned_[d.toString()],I(`Updating copy with original value for ${String(d)}`),r.copy_[d]=Z(x),I("Checking if all properties reverted");let b=a(r);I("All reverted:",b),b?(I("All properties reverted, clearing tracking"),r.modified=!1,r.assigned_={},e&&(I("Updating parent for property:",e.prop),l(e.tracker,e.prop))):(I("Some properties still changed, keeping modified flag"),r.modified=!0)}else I(`Setting new value for property ${String(d)}`),r.copy_[d]=y,r.assigned_[d.toString()]=!0,I("Marking object and ancestors as modified",r),o(r)}return!0},defineProperty(h,d,y){return"value"in y&&(r.copy_[d]=Z(y.value),r.assigned_[d.toString()]=!0,o(r)),!0},deleteProperty(h,d){I("deleteProperty",h,d);let y=typeof d=="symbol"?d.toString():d;if(y in h){let g=y in r.originalObject;delete r.copy_[d],g?(r.assigned_[y]=!1,r.copy_[y]=void 0,o(r)):(delete r.copy_[y],delete r.assigned_[y],Object.keys(r.assigned_).length===0&&Object.getOwnPropertySymbols(r.assigned_).length===0?r.modified=!1:r.modified=!0)}return!0}});return i.set(c,f),f}return{proxy:u(t),getChanges:()=>{if(I("getChanges called, modified:",r.modified),I(r),!r.modified)return I("Object not modified, returning empty object"),{};if(typeof r.copy_!="object"||Array.isArray(r.copy_)||Object.keys(r.assigned_).length===0)return r.copy_;let c={};for(let f in r.copy_)r.assigned_[f]===!0&&f in r.copy_&&(c[f]=r.copy_[f]);return I("Returning copy:",c),c}}}function js(t){let e=t.map(s=>Ht(s));return{proxies:e.map(s=>s.proxy),getChanges:()=>e.map(s=>s.getChanges())}}function vs(t,e){let{proxy:s,getChanges:n}=Ht(t);return e(s),n()}function ws(t,e){let{proxies:s,getChanges:n}=js(t);return e(s),n()}function Un(){let t,e,s=!0;return{promise:new Promise((i,r)=>{t=o=>{s=!1,i(o)},e=o=>{s=!1,r(o)}}),resolve:t,reject:e,isPending:()=>s}}var $s=class{constructor(){this.contexts=new Map,this.clearListeners=new Set}getOrCreateContext(e){let s=this.contexts.get(e);return s||(s={queue:[],jobs:new Map,dependencies:new Map,completed:new Set},this.contexts.set(e,s)),s}schedule({contextId:e,jobId:s,dependencies:n,run:i}){if(typeof e>"u"){i();return}let r=this.getOrCreateContext(e);if(r.jobs.has(s)||r.queue.push(s),r.jobs.set(s,i),n){let o=new Set(n);o.delete(s),r.dependencies.set(s,o)}else r.dependencies.has(s)||r.dependencies.set(s,new Set);r.completed.delete(s)}flush(e){let s=this.contexts.get(e);if(!s)return;let{queue:n,jobs:i,dependencies:r,completed:o}=s;for(;n.length>0;){let a=!1,l=n.length;for(let u=0;u<l;u++){let p=n.shift(),c=i.get(p);if(!c){r.delete(p),o.delete(p);continue}let f=r.get(p),h=!f;if(f){h=!0;for(let d of f)if(d!==p&&!o.has(d)){h=!1;break}}h?(i.delete(p),r.delete(p),c(),o.add(p),a=!0):n.push(p)}if(!a)throw new Error(`Scheduler detected unresolved dependencies for context ${String(e)}.`)}this.contexts.delete(e)}flushAll(){for(let e of Array.from(this.contexts.keys()))this.flush(e)}clear(e){this.contexts.delete(e),this.clearListeners.forEach(s=>s(e))}onClear(e){return this.clearListeners.add(e),()=>this.clearListeners.delete(e)}hasPendingJobs(e){let s=this.contexts.get(e);return!!s&&s.jobs.size>0}clearJob(e,s){let n=this.contexts.get(e);n&&(n.jobs.delete(s),n.dependencies.delete(s),n.completed.delete(s),n.queue=n.queue.filter(i=>i!==s),n.jobs.size===0&&this.contexts.delete(e))}},Ft=new $s;var Ss=[],Jt=[],Zr=0;function Xr(t,e){switch(`${t.type}-${e.type}`){case"insert-update":return{...t,type:"insert",original:{},modified:e.modified,changes:{...t.changes,...e.changes},key:t.key,globalKey:t.globalKey,metadata:e.metadata??t.metadata,syncMetadata:{...t.syncMetadata,...e.syncMetadata},mutationId:e.mutationId,updatedAt:e.updatedAt};case"insert-delete":return null;case"update-delete":return e;case"update-update":return{...e,original:t.original,changes:{...t.changes,...e.changes},metadata:e.metadata??t.metadata,syncMetadata:{...t.syncMetadata,...e.syncMetadata}};case"delete-delete":case"insert-insert":return e;default:{let s=`${t.type}-${e.type}`;throw new Error(`Unhandled mutation combination: ${s}`)}}}function X(t){let e=new Ns(t);return Ss.push(e),e}function ne(){if(Jt.length>0)return Jt.slice(-1)[0]}function ei(t){Ft.clear(t.id),Jt.push(t)}function ti(t){try{Ft.flush(t.id)}finally{Jt=Jt.filter(e=>e.id!==t.id)}}function si(t){let e=Ss.findIndex(s=>s.id===t.id);e!==-1&&Ss.splice(e,1)}var Ns=class{constructor(e){if(typeof e.mutationFn>"u")throw new je;this.id=e.id??crypto.randomUUID(),this.mutationFn=e.mutationFn,this.state="pending",this.mutations=[],this.isPersisted=Un(),this.autoCommit=e.autoCommit??!0,this.createdAt=new Date,this.sequenceNumber=Zr++,this.metadata=e.metadata??{}}setState(e){this.state=e,(e==="completed"||e==="failed")&&si(this)}mutate(e){if(this.state!=="pending")throw new $e;ei(this);try{e()}finally{ti(this)}return this.autoCommit&&this.commit().catch(()=>{}),this}applyMutations(e){for(let s of e){let n=this.mutations.findIndex(i=>i.globalKey===s.globalKey);if(n>=0){let i=this.mutations[n],r=Xr(i,s);r===null?this.mutations.splice(n,1):this.mutations[n]=r}else this.mutations.push(s)}}rollback(e){let s=e?.isSecondaryRollback??!1;if(this.state==="completed")throw new Ne;if(this.setState("failed"),!s){let n=new Set;this.mutations.forEach(i=>n.add(i.globalKey));for(let i of Ss)i.state==="pending"&&i.mutations.some(r=>n.has(r.globalKey))&&i.rollback({isSecondaryRollback:!0})}return this.isPersisted.reject(this.error?.error),this.touchCollection(),this}touchCollection(){let e=new Set;for(let s of this.mutations)e.has(s.collection.id)||(s.collection._state.onTransactionStateChange(),s.collection._state.pendingSyncedTransactions.length>0&&s.collection._state.commitPendingTransactions(),e.add(s.collection.id))}async commit(){if(this.state!=="pending")throw new Ue;if(this.setState("persisting"),this.mutations.length===0)return this.setState("completed"),this.isPersisted.resolve(this),this;try{await this.mutationFn({transaction:this}),this.setState("completed"),this.touchCollection(),this.isPersisted.resolve(this)}catch(e){let s=e instanceof Error?e:new Error(String(e));throw this.error={message:s.message,error:s},this.rollback(),s}return this}compareCreatedAt(e){let s=this.createdAt.getTime()-e.createdAt.getTime();return s!==0?s:this.sequenceNumber-e.sequenceNumber}};var xs=class{constructor(e,s){this.insert=(n,i)=>{this.lifecycle.validateCollectionUsable("insert");let r=this.state,o=ne();if(!o&&!this.config.onInsert)throw new De;let a=Array.isArray(n)?n:[n],l=[];if(a.forEach(u=>{let p=this.validateData(u,"insert"),c=this.config.getKey(p);if(this.state.has(c))throw new Re(c);let f=this.generateGlobalKey(c,u),h={mutationId:crypto.randomUUID(),original:{},modified:p,changes:Object.fromEntries(Object.keys(u).map(d=>[d,p[d]])),globalKey:f,key:c,metadata:i?.metadata,syncMetadata:this.config.sync.getSyncMetadata?.()||{},optimistic:i?.optimistic??!0,type:"insert",createdAt:new Date,updatedAt:new Date,collection:this.collection};l.push(h)}),o)return o.applyMutations(l),r.transactions.set(o.id,o),r.scheduleTransactionCleanup(o),r.recomputeOptimisticState(!0),o;{let u=X({mutationFn:async p=>await this.config.onInsert({transaction:p.transaction,collection:this.collection})});return u.applyMutations(l),u.commit().catch(()=>{}),r.transactions.set(u.id,u),r.scheduleTransactionCleanup(u),r.recomputeOptimisticState(!0),u}},this.delete=(n,i)=>{let r=this.state;this.lifecycle.validateCollectionUsable("delete");let o=ne();if(!o&&!this.config.onDelete)throw new Le;if(Array.isArray(n)&&n.length===0)throw new Ke;let a=Array.isArray(n)?n:[n],l=[];for(let p of a){if(!this.state.has(p))throw new Be(p);let c=this.generateGlobalKey(p,this.state.get(p)),f={mutationId:crypto.randomUUID(),original:this.state.get(p),modified:this.state.get(p),changes:this.state.get(p),globalKey:c,key:p,metadata:i?.metadata,syncMetadata:r.syncedMetadata.get(p)||{},optimistic:i?.optimistic??!0,type:"delete",createdAt:new Date,updatedAt:new Date,collection:this.collection};l.push(f)}if(o)return o.applyMutations(l),r.transactions.set(o.id,o),r.scheduleTransactionCleanup(o),r.recomputeOptimisticState(!0),o;let u=X({autoCommit:!0,mutationFn:async p=>this.config.onDelete({transaction:p.transaction,collection:this.collection})});return u.applyMutations(l),u.commit().catch(()=>{}),r.transactions.set(u.id,u),r.scheduleTransactionCleanup(u),r.recomputeOptimisticState(!0),u},this.id=s,this.config=e}setDeps(e){this.lifecycle=e.lifecycle,this.state=e.state,this.collection=e.collection}ensureStandardSchema(e){if(e&&"~standard"in e)return e;throw new ke}validateData(e,s,n){if(!this.config.schema)return e;let i=this.ensureStandardSchema(this.config.schema);if(s==="update"&&n){let o=this.state.get(n);if(o&&e&&typeof e=="object"&&typeof o=="object"){let a=Object.assign({},o,e),l=i["~standard"].validate(a);if(l instanceof Promise)throw new ae;if("issues"in l&&l.issues){let f=l.issues.map(h=>({message:h.message,path:h.path?.map(d=>String(d))}));throw new oe(s,f)}let u=l.value,p=Object.keys(e);return Object.fromEntries(p.map(f=>[f,u[f]]))}}let r=i["~standard"].validate(e);if(r instanceof Promise)throw new ae;if("issues"in r&&r.issues){let o=r.issues.map(a=>({message:a.message,path:a.path?.map(l=>String(l))}));throw new oe(s,o)}return r.value}generateGlobalKey(e,s){if(typeof e>"u")throw new Oe(s);return`KEY::${this.id}/${e}`}update(e,s,n){if(typeof e>"u")throw new Pe;let i=this.state;this.lifecycle.validateCollectionUsable("update");let r=ne();if(!r&&!this.config.onUpdate)throw new ze;let o=Array.isArray(e),a=o?e:[e];if(o&&a.length===0)throw new Ae;let l=typeof s=="function"?s:n,u=typeof s=="function"?{}:s,p=a.map(d=>{let y=this.state.get(d);if(!y)throw new Fe(d);return y}),c;o?c=ws(p,l):c=[vs(p[0],l)];let f=a.map((d,y)=>{let g=c[y];if(!g||Object.keys(g).length===0)return null;let x=p[y],m=this.validateData(g,"update",d),b=Object.assign({},x,m),C=this.config.getKey(x),T=this.config.getKey(b);if(C!==T)throw new Me(C,T);let _=this.generateGlobalKey(T,b);return{mutationId:crypto.randomUUID(),original:x,modified:b,changes:Object.fromEntries(Object.keys(g).map(E=>[E,b[E]])),globalKey:_,key:d,metadata:u.metadata,syncMetadata:i.syncedMetadata.get(d)||{},optimistic:u.optimistic??!0,type:"update",createdAt:new Date,updatedAt:new Date,collection:this.collection}}).filter(Boolean);if(f.length===0){let d=X({mutationFn:async()=>{}});return d.commit().catch(()=>{}),i.scheduleTransactionCleanup(d),d}if(r)return r.applyMutations(f),i.transactions.set(r.id,r),i.scheduleTransactionCleanup(r),i.recomputeOptimisticState(!0),r;let h=X({mutationFn:async d=>this.config.onUpdate({transaction:d.transaction,collection:this.collection})});return h.applyMutations(f),h.commit().catch(()=>{}),i.transactions.set(h.id,h),i.scheduleTransactionCleanup(h),i.recomputeOptimisticState(!0),h}};var bs=class extends Tt{constructor(){super()}setDeps(e){this.collection=e.collection}emit(e,s){this.emitInner(e,s)}emitStatusChange(e,s){this.emit("status:change",{type:"status:change",collection:this.collection,previousStatus:s,status:e});let n=`status:${e}`;this.emit(n,{type:n,collection:this.collection,previousStatus:s,status:e})}emitSubscribersChange(e,s){this.emit("subscribers:change",{type:"subscribers:change",collection:this.collection,previousSubscriberCount:s,subscriberCount:e})}cleanup(){this.clearListeners()}};function ks(t){let e=new ve(t);return t.utils?e.utils={...t.utils}:e.utils={},e}var ve=class{constructor(e){if(this.utils={},this.insert=(s,n)=>this._mutations.insert(s,n),this.delete=(s,n)=>this._mutations.delete(s,n),!e)throw new xe;if(!e.sync)throw new be;e.id?this.id=e.id:this.id=crypto.randomUUID(),this.config={...e,autoIndex:e.autoIndex??"eager"},this._changes=new fs,this._events=new bs,this._indexes=new ms,this._lifecycle=new ys(e,this.id),this._mutations=new xs(e,this.id),this._state=new hs(e),this._sync=new gs(e,this.id),this._changes.setDeps({collection:this,lifecycle:this._lifecycle,sync:this._sync,events:this._events}),this._events.setDeps({collection:this}),this._indexes.setDeps({state:this._state,lifecycle:this._lifecycle}),this._lifecycle.setDeps({changes:this._changes,events:this._events,indexes:this._indexes,state:this._state,sync:this._sync}),this._mutations.setDeps({collection:this,lifecycle:this._lifecycle,state:this._state}),this._state.setDeps({collection:this,lifecycle:this._lifecycle,changes:this._changes,indexes:this._indexes}),this._sync.setDeps({collection:this,state:this._state,lifecycle:this._lifecycle,events:this._events}),e.startSync===!0&&this._sync.startSync()}get status(){return this._lifecycle.status}get subscriberCount(){return this._changes.activeSubscribersCount}onFirstReady(e){return this._lifecycle.onFirstReady(e)}isReady(){return this._lifecycle.status==="ready"}get isLoadingSubset(){return this._sync.isLoadingSubset}startSyncImmediate(){this._sync.startSync()}preload(){return this._sync.preload()}get(e){return this._state.get(e)}has(e){return this._state.has(e)}get size(){return this._state.size}*keys(){yield*this._state.keys()}*values(){yield*this._state.values()}*entries(){yield*this._state.entries()}*[Symbol.iterator](){yield*this._state[Symbol.iterator]()}forEach(e){return this._state.forEach(e)}map(e){return this._state.map(e)}getKeyFromItem(e){return this.config.getKey(e)}createIndex(e,s={}){return this._indexes.createIndex(e,s)}get indexes(){return this._indexes.indexes}validateData(e,s,n){return this._mutations.validateData(e,s,n)}update(e,s,n){return this._mutations.update(e,s,n)}get state(){let e=new Map;for(let[s,n]of this.entries())e.set(s,n);return e}stateWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.state):this.preload().then(()=>this.state)}get toArray(){return Array.from(this.values())}toArrayWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.toArray):this.preload().then(()=>this.toArray)}currentStateAsChanges(e={}){return zn(this,e)}subscribeChanges(e,s={}){return this._changes.subscribeChanges(e,s)}on(e,s){return this._events.on(e,s)}once(e,s){return this._events.once(e,s)}off(e,s){this._events.off(e,s)}waitFor(e,s){return this._events.waitFor(e,s)}async cleanup(){return this._lifecycle.cleanup(),Promise.resolve()}};function Wn(t){let{mutationFn:e,onMutate:s,...n}=t;return i=>{let r=X({...n,mutationFn:async o=>await e(i,o)});return r.mutate(()=>{s(i)}),r}}function Vn(t){let{initialData:e,onInsert:s,onUpdate:n,onDelete:i,...r}=t,o=ni(e),a=async c=>{let f;return s&&(f=await s(c)??{}),o.confirmOperationsSync(c.transaction.mutations),f},l=async c=>{let f;return n&&(f=await n(c)??{}),o.confirmOperationsSync(c.transaction.mutations),f},u=async c=>{let f;return i&&(f=await i(c)??{}),o.confirmOperationsSync(c.transaction.mutations),f},p=c=>{let f=c.mutations.filter(h=>h.collection===o.collection);f.length!==0&&o.confirmOperationsSync(f)};return{...r,sync:o.sync,onInsert:a,onUpdate:l,onDelete:u,utils:{acceptMutations:p},startSync:!0,gcTime:0}}function ni(t){let e=null,s=null,n=null,i=null;return{sync:{sync:a=>{let{begin:l,write:u,commit:p,markReady:c}=a;return e=l,s=u,n=p,i=a.collection,t&&t.length>0&&(l(),t.forEach(f=>{u({type:"insert",value:f})}),p()),c(),()=>{}},getSyncMetadata:()=>({})},confirmOperationsSync:a=>{!e||!s||!n||(e(),a.forEach(l=>{s&&s({type:l.type,value:l.modified})}),n())},collection:i}}function Mt(t,e){try{JSON.stringify(t)}catch(s){throw new gt(e,s instanceof Error?s.message:String(s))}}function Us(){return crypto.randomUUID()}function ri(){let t=new Map;return{getItem(e){return t.get(e)??null},setItem(e,s){t.set(e,s)},removeItem(e){t.delete(e)}}}function ii(){return{addEventListener:()=>{},removeEventListener:()=>{}}}function qn(t){if(!t.storageKey)throw new mt;let e=t.storage||(typeof window<"u"?window.localStorage:null)||ri(),s=t.storageEventApi||(typeof window<"u"?window:null)||ii(),n=new Map,i=oi(t.storageKey,e,s,t.getKey,n),r=()=>{i.manualTrigger&&i.manualTrigger()},o=_=>{try{let E={};_.forEach((v,w)=>{E[String(w)]=v});let S=JSON.stringify(E);e.setItem(t.storageKey,S)}catch(E){throw console.error(`[LocalStorageCollection] Error saving data to storage key "${t.storageKey}":`,E),E}},a=()=>{e.removeItem(t.storageKey)},l=()=>{let _=e.getItem(t.storageKey);return _?new Blob([_]).size:0},u=async _=>{_.transaction.mutations.forEach(v=>{Mt(v.modified,"insert")});let E={};t.onInsert&&(E=await t.onInsert(_)??{});let S=Kt(t.storageKey,e);return _.transaction.mutations.forEach(v=>{let w=t.getKey(v.modified),O={versionKey:Us(),data:v.modified};S.set(w,O)}),o(S),r(),E},p=async _=>{_.transaction.mutations.forEach(v=>{Mt(v.modified,"update")});let E={};t.onUpdate&&(E=await t.onUpdate(_)??{});let S=Kt(t.storageKey,e);return _.transaction.mutations.forEach(v=>{let w=t.getKey(v.modified),O={versionKey:Us(),data:v.modified};S.set(w,O)}),o(S),r(),E},c=async _=>{let E={};t.onDelete&&(E=await t.onDelete(_)??{});let S=Kt(t.storageKey,e);return _.transaction.mutations.forEach(v=>{let w=t.getKey(v.original);S.delete(w)}),o(S),r(),E},{storageKey:f,storage:h,storageEventApi:d,onInsert:y,onUpdate:g,onDelete:x,id:m,...b}=t,C=m??`local-collection:${t.storageKey}`;return{...b,id:C,sync:i,onInsert:u,onUpdate:p,onDelete:c,utils:{clearStorage:a,getStorageSize:l,acceptMutations:_=>{let E=_.mutations.filter(v=>i.collection&&v.collection===i.collection?!0:v.collection.id===C);if(E.length===0)return;for(let v of E)switch(v.type){case"insert":case"update":Mt(v.modified,v.type);break;case"delete":Mt(v.original,v.type);break}let S=Kt(t.storageKey,e);for(let v of E){let w=v.key;switch(v.type){case"insert":case"update":{let O={versionKey:Us(),data:v.modified};S.set(w,O);break}case"delete":{S.delete(w);break}}}o(S),i.confirmOperationsSync(E)}}}}function Kt(t,e){try{let s=e.getItem(t);if(!s)return new Map;let n=JSON.parse(s),i=new Map;if(typeof n=="object"&&n!==null&&!Array.isArray(n))Object.entries(n).forEach(([r,o])=>{if(o&&typeof o=="object"&&"versionKey"in o&&"data"in o){let a=o;i.set(r,a)}else throw new vt(t,r)});else throw new wt(t);return i}catch(s){return console.warn(`[LocalStorageCollection] Error loading data from storage key "${t}":`,s),new Map}}function oi(t,e,s,n,i){let r=null,o=null,a=(c,f)=>{let h=[];return c.forEach((d,y)=>{let g=f.get(y);g?d.versionKey!==g.versionKey&&h.push({type:"update",key:y,value:g.data}):h.push({type:"delete",key:y,value:d.data})}),f.forEach((d,y)=>{c.has(y)||h.push({type:"insert",key:y,value:d.data})}),h},l=()=>{if(!r)return;let{begin:c,write:f,commit:h}=r,d=Kt(t,e),y=a(i,d);y.length>0&&(c(),y.forEach(({type:g,value:x})=>{x&&(Mt(x,g),f({type:g,value:x}))}),h(),i.clear(),d.forEach((g,x)=>{i.set(x,g)}))};return{...{sync:c=>{let{begin:f,write:h,commit:d,markReady:y}=c;r=c,o=c.collection;let g=Kt(t,e);g.size>0&&(f(),g.forEach(m=>{Mt(m.data,"load"),h({type:"insert",value:m.data})}),d()),i.clear(),g.forEach((m,b)=>{i.set(b,m)}),y();let x=m=>{m.key!==t||m.storageArea!==e||l()};s.addEventListener("storage",x)},getSyncMetadata:()=>({storageKey:t,storageType:e===(typeof window<"u"?window.localStorage:null)?"localStorage":"custom"}),manualTrigger:l,collection:o},confirmOperationsSync:c=>{if(!r)return;let{begin:f,write:h,commit:d}=r;f(),c.forEach(y=>{h({type:y.type,value:y.type==="delete"?y.original:y.modified})}),d()}}}var Bt=class t{constructor(e={}){this.query={},this.query={...e}}_createRefForSource(e,s){if(Object.keys(e).length!==1)throw new qe(s);let n=Object.keys(e)[0],i=e[n],r;if(i instanceof ve)r=new U(i,n);else if(i instanceof t){let o=i._getQuery();if(!o.from)throw new Qe(s);r=new M(o,n)}else throw new Ge(n);return[n,r]}from(e){let[,s]=this._createRefForSource(e,"from clause");return new t({...this.query,from:s})}join(e,s,n="left"){let[i,r]=this._createRefForSource(e,"join clause"),a=[...this._getCurrentAliases(),i],l=ye(a),u=s(l),p,c;if(u.type==="func"&&u.name==="eq"&&u.args.length===2)p=u.args[0],c=u.args[1];else throw new He;let f={from:r,type:n,left:p,right:c},h=this.query.join||[];return new t({...this.query,join:[...h,f]})}leftJoin(e,s){return this.join(e,s,"left")}rightJoin(e,s){return this.join(e,s,"right")}innerJoin(e,s){return this.join(e,s,"inner")}fullJoin(e,s){return this.join(e,s,"full")}where(e){let s=this._getCurrentAliases(),n=ye(s),i=e(n),r=this.query.where||[];return new t({...this.query,where:[...r,i]})}having(e){let s=this._getCurrentAliases(),n=ye(s),i=e(n),r=this.query.having||[];return new t({...this.query,having:[...r,i]})}select(e){let s=this._getCurrentAliases(),n=ye(s),i=e(n),r=Qn(i);return new t({...this.query,select:r,fnSelect:void 0})}orderBy(e,s="asc"){let n=this._getCurrentAliases(),i=ye(n),r=e(i),o=typeof s=="string"?{direction:s,nulls:"first",stringSort:"locale"}:{direction:s.direction??"asc",nulls:s.nulls??"first",stringSort:s.stringSort??"locale",locale:s.stringSort==="locale"?s.locale:void 0,localeOptions:s.stringSort==="locale"?s.localeOptions:void 0},a=p=>({expression:k(p),compareOptions:o}),l=Array.isArray(r)?r.map(p=>a(p)):[a(r)],u=this.query.orderBy||[];return new t({...this.query,orderBy:[...u,...l]})}groupBy(e){let s=this._getCurrentAliases(),n=ye(s),i=e(n),r=Array.isArray(i)?i.map(a=>k(a)):[k(i)],o=this.query.groupBy||[];return new t({...this.query,groupBy:[...o,...r]})}limit(e){return new t({...this.query,limit:e})}offset(e){return new t({...this.query,offset:e})}distinct(){return new t({...this.query,distinct:!0})}findOne(){return new t({...this.query,singleResult:!0})}_getCurrentAliases(){let e=[];if(this.query.from&&e.push(this.query.from.alias),this.query.join)for(let s of this.query.join)e.push(s.from.alias);return e}get fn(){let e=this;return{select(s){return new t({...e.query,select:void 0,fnSelect:s})},where(s){return new t({...e.query,fnWhere:[...e.query.fnWhere||[],s]})},having(s){return new t({...e.query,fnHaving:[...e.query.fnHaving||[],s]})}}}_getQuery(){if(!this.query.from)throw new Je;return this.query}};function ai(t){return t===void 0?k(null):t instanceof $||t instanceof R||t instanceof P||t instanceof K?t:k(t)}function ci(t){return t!==null&&typeof t=="object"&&!Se(t)&&!t.__refProxy}function Qn(t){if(!ci(t))return ai(t);let e={};for(let[s,n]of Object.entries(t)){if(typeof s=="string"&&s.startsWith("__SPREAD_SENTINEL__")){e[s]=n;continue}e[s]=Qn(n)}return e}function Gn(t){let e=t(new Bt);return Ws(e)}function Ws(t){return t._getQuery()}var Hn=Bt;import{map as zt,filter as Xs,distinct as Vi}from"@tanstack/db-ivm";var Jn=new Set(["eq","gt","lt","gte","lte","and","or","in"]);function Vs(t){let e=t.type;return e==="func"?Jn.has(t.name)?t.args.every(s=>Vs(s)):!1:["val","ref"].includes(e)}function Cs(t,e){let s=t.type;if(s==="val")return new K(t.value);if(s==="ref"){let n=t.path;if(Array.isArray(n)){if(n[0]===e&&n.length>1)return new P(n.slice(1));if(n.length===1&&n[0]!==void 0)return new P([n[0]])}return new P(Array.isArray(n)?n:[String(n)])}else{if(!Jn.has(t.name))return null;let n=[];for(let i of t.args){let r=Cs(i,e);if(r==null)return null;n.push(r)}return new R(t.name,n)}}function qs(t,e){return t.map(n=>{let i=Cs(n.expression,e);if(!i)throw new Error(`Failed to convert orderBy expression to a basic expression: ${n.expression}`);return{...n,expression:i}})}function Xn(t){let e=li(t),s=t,n,i=0,r=10;for(;i<r&&!L(s,n);)n=s,s=Qs(s),i++;return{optimizedQuery:er(s),sourceWhereClauses:e}}function li(t){let e=new Map;if(!t.where||t.where.length===0)return e;let n=tr(t.where).map(r=>nr(r)),i=rr(n);for(let[r,o]of i.singleSource)ui(t,r)&&Vs(o)&&e.set(r,o);return e}function ui(t,e){if(t.from.alias===e)return t.from.type==="collectionRef";if(t.join){for(let s of t.join)if(s.from.alias===e)return s.from.type==="collectionRef"}return!1}function Qs(t){let e={...t,from:t.from.type==="queryRef"?new M(Qs(t.from.query),t.from.alias):t.from,join:t.join?.map(s=>({...s,from:s.from.type==="queryRef"?new M(Qs(s.from.query),s.from.alias):s.from}))};return hi(e)}function hi(t){if(!t.where||t.where.length===0||!t.join||t.join.length===0)return t;let e=t.where.filter(a=>!ts(a)),n=tr(e).map(a=>nr(a)),i=rr(n),r=fi(t,i),o=t.where.filter(a=>ts(a));return o.length>0&&(r.where=[...r.where||[],...o]),r}function er(t){return{...t,from:Gs(t.from),join:t.join?.map(e=>({...e,from:Gs(e.from)}))}}function Gs(t){if(t.type==="collectionRef")return t;let e=er(t.query);if(di(e)){let s=Gs(e.from);return s.type==="collectionRef"?new U(s.collection,t.alias):new M(s.query,t.alias)}return new M(e,t.alias)}function di(t){return(!t.where||t.where.length===0)&&!t.select&&(!t.groupBy||t.groupBy.length===0)&&(!t.having||t.having.length===0)&&(!t.orderBy||t.orderBy.length===0)&&(!t.join||t.join.length===0)&&t.limit===void 0&&t.offset===void 0&&!t.fnSelect&&(!t.fnWhere||t.fnWhere.length===0)&&(!t.fnHaving||t.fnHaving.length===0)}function tr(t){let e=[];for(let s of t){let n=Wt(s);e.push(...sr(n))}return e}function sr(t){if(t.type==="func"&&t.name==="and"){let e=[];for(let s of t.args)e.push(...sr(s));return e}else return[t]}function nr(t){let e=new Set,s=!1;function n(i){switch(i.type){case"ref":if(i.path&&i.path.length>0){let r=i.path[0];r&&(e.add(r),i.path.length===1&&(s=!0))}break;case"func":i.args&&i.args.forEach(n);break;case"val":break;case"agg":i.args&&i.args.forEach(n);break}}return n(t),{expression:t,touchedSources:e,hasNamespaceOnlyRef:s}}function rr(t){let e=new Map,s=[];for(let r of t)if(r.touchedSources.size===1&&!r.hasNamespaceOnlyRef){let o=Array.from(r.touchedSources)[0];e.has(o)||e.set(o,[]),e.get(o).push(r.expression)}else(r.touchedSources.size>1||r.hasNamespaceOnlyRef)&&s.push(r.expression);let n=new Map;for(let[r,o]of e)n.set(r,Zn(o));let i=s.length>0?Zn(s):void 0;return{singleSource:n,multiSource:i}}function fi(t,e){let s=new Set,n=Yn(t.from,e.singleSource,s),i=t.join?t.join.map(l=>({...l,from:Yn(l.from,e.singleSource,s)})):void 0,r=[];e.multiSource&&r.push(e.multiSource);let o=t.join&&t.join.some(l=>l.type==="left"||l.type==="right"||l.type==="full");for(let[l,u]of e.singleSource)s.has(l)?o&&r.push(Ps(u)):r.push(u);return{select:t.select,groupBy:t.groupBy?[...t.groupBy]:void 0,having:t.having?[...t.having]:void 0,orderBy:t.orderBy?[...t.orderBy]:void 0,limit:t.limit,offset:t.offset,distinct:t.distinct,fnSelect:t.fnSelect,fnWhere:t.fnWhere?[...t.fnWhere]:void 0,fnHaving:t.fnHaving?[...t.fnHaving]:void 0,from:n,join:i,where:r.length>0?r:[]}}function Dt(t){return{from:t.from.type==="collectionRef"?new U(t.from.collection,t.from.alias):new M(Dt(t.from.query),t.from.alias),select:t.select,join:t.join?t.join.map(e=>({type:e.type,left:e.left,right:e.right,from:e.from.type==="collectionRef"?new U(e.from.collection,e.from.alias):new M(Dt(e.from.query),e.from.alias)})):void 0,where:t.where?[...t.where]:void 0,groupBy:t.groupBy?[...t.groupBy]:void 0,having:t.having?[...t.having]:void 0,orderBy:t.orderBy?[...t.orderBy]:void 0,limit:t.limit,offset:t.offset,fnSelect:t.fnSelect,fnWhere:t.fnWhere?[...t.fnWhere]:void 0,fnHaving:t.fnHaving?[...t.fnHaving]:void 0}}function Yn(t,e,s){let n=e.get(t.alias);if(!n)return t.type==="collectionRef"?new U(t.collection,t.alias):new M(Dt(t.query),t.alias);if(t.type==="collectionRef"){let o={from:new U(t.collection,t.alias),where:[n]};return s.add(t.alias),new M(o,t.alias)}if(!wi(t.query,n,t.alias))return new M(Dt(t.query),t.alias);if(xi(t.query,n,t.alias))return new M(Dt(t.query),t.alias);let i=t.query.where||[],r={...Dt(t.query),where:[...i,n]};return s.add(t.alias),new M(r,t.alias)}function pi(t,e,s){return t.select?ir(t.select)||Si(t.select,e,s):!1}function yi(t){return t.groupBy&&t.groupBy.length>0}function gi(t){return t.having&&t.having.length>0}function mi(t){return t.orderBy&&t.orderBy.length>0&&(t.limit!==void 0||t.offset!==void 0)}function vi(t){return t.fnSelect||t.fnWhere&&t.fnWhere.length>0||t.fnHaving&&t.fnHaving.length>0}function wi(t,e,s){return!(pi(t,e,s)||yi(t)||gi(t)||mi(t)||vi(t))}function ir(t){for(let e of Object.values(t))if(typeof e=="object"){let s=e;if(s.type==="agg"||!("type"in s)&&ir(s))return!0}return!1}function Hs(t){let e=[];if(t==null||typeof t!="object")return e;switch(t.type){case"ref":e.push(t);break;case"func":case"agg":for(let s of t.args??[])e.push(...Hs(s));break}return e}function Si(t,e,s){let n=new Set;for(let[r,o]of Object.entries(t))r.startsWith("__SPREAD_SENTINEL__")||o instanceof P||n.add(r);let i=Hs(e);for(let r of i){let o=r.path;if(!Array.isArray(o)||o.length<2)continue;let a=o[0],l=o[1];if(a===s&&n.has(l))return!0}return!1}function xi(t,e,s){let n=Hs(e);if(n.every(r=>r.path[0]!==s))return!1;if(t.fnSelect)return!0;let i=t.select;if(!i)return!1;for(let r of n){let o=r.path;if(o.length<2||o[0]!==s)continue;let a=i[o[1]];if(!a)continue;if(!(a instanceof P)||a.path.length<2)return!0;let[l,u]=a.path;if(l!==s&&l!==t.from.alias||u!==o[1])return!0}return!1}function Zn(t){if(t.length===0)throw new xt;return t.length===1?t[0]:new R("and",t)}import{map as Es,tap as bi,join as ki,filter as Ci}from"@tanstack/db-ivm";function or(t,e,s,n,i,r,o,a,l,u,p,c,f,h,d,y,g,x){let m=t;for(let b of e)m=Ei(m,b,s,n,i,r,o,a,l,u,p,c,f,h,d,y,g,x);return m}function Ei(t,e,s,n,i,r,o,a,l,u,p,c,f,h,d,y,g,x){let m=e.from.type==="collectionRef",{alias:b,input:C,collectionId:T}=_i(e.from,r,l,u,p,c,f,h,o,a,y,g,x);s[b]=C,m&&(g[b]=T);let _=l[n],E=l[T];if(!_)throw new he(n);if(!E)throw new he(T);let{activeSource:S,lazySource:v}=Ri(e.type,_,E),w=Object.keys(s),{mainExpr:O,joinedExpr:F}=Ii(e.left,e.right,w,b),H=D(O),q=D(F),jt=t.pipe(Es(([re,we])=>[H(we),[re,we]])),$t=C.pipe(Es(([re,we])=>{let Nt={[b]:we};return[q(Nt),[re,Nt]]}));if(!["inner","left","right","full"].includes(e.type))throw new rt(e.type);if(S){let re=S==="main"?e.from:d.from,we=re.type==="queryRef"&&(re.query.limit||re.query.offset),Nt=O.type==="func"||F.type==="func";if(!we&&!Nt){let Ut=S==="main"?b:i;c.add(Ut);let Sr=S==="main"?jt:$t,Zt=ie(d,S==="main"?F:O,v),xr=Zt.collection,nn=Zt.path[0];nn&&ge(nn,Zt.path,xr);let rn=Sr.pipe(bi(br=>{let on=x[Ut]||Ut,Xt=u[on];if(!Xt)throw new kt(on,Ut,v.id,Object.keys(u));if(Xt.hasLoadedInitialState())return;let kr=br.getInner().map(([[Er]])=>Er),Cr=new P(Zt.path);Xt.requestSnapshot({where:us(Cr,kr),optimizedOnly:!0})||Xt.requestSnapshot()}));S==="main"?jt=rn:$t=rn}}return jt.pipe(ki($t,e.type),Oi(e.type))}function Ii(t,e,s,n){let i=s.filter(a=>a!==n),r=Js(t),o=Js(e);if(r&&i.includes(r)&&o===n)return{mainExpr:t,joinedExpr:e};if(r===n&&o&&i.includes(o))return{mainExpr:e,joinedExpr:t};throw!r||!o?new ot:r===o?new it(r):i.includes(r)?o!==n?new ct(n):new lt:new at(r)}function Js(t){switch(t.type){case"ref":return t.path[0]||null;case"func":{let e=new Set;for(let s of t.args){let n=Js(s);n&&e.add(n)}return e.size===1?Array.from(e)[0]:null}default:return null}}function _i(t,e,s,n,i,r,o,a,l,u,p,c,f){switch(t.type){case"collectionRef":{let h=e[t.alias];if(!h)throw new te(t.alias,t.collection.id,Object.keys(e));return c[t.alias]=t.collection.id,{alias:t.alias,input:h,collectionId:t.collection.id}}case"queryRef":{let h=u.get(t.query)||t.query,d=p(h,e,s,n,i,r,o,a,l,u);Object.assign(c,d.aliasToCollectionId),Object.assign(f,d.aliasRemapping);let y=Object.keys(d.aliasToCollectionId).find(m=>d.aliasToCollectionId[m]===d.collectionId);y&&y!==t.alias&&(f[t.alias]=y);let x=d.pipeline.pipe(Es(m=>{let[b,[C,T]]=m;return[b,C]}));return{alias:t.alias,input:x,collectionId:d.collectionId}}default:throw new ut(t.type)}}function Oi(t){return function(e){return e.pipe(Ci(s=>{let[n,[i,r]]=s,o=i?.[1],a=r?.[1];return t==="inner"?!!(o&&a):t==="left"?!!o:t==="right"?!!a:!0}),Es(s=>{let[n,[i,r]]=s,o=i?.[0],a=i?.[1],l=r?.[0],u=r?.[1],p={};return a&&Object.assign(p,a),u&&Object.assign(p,u),[`[${o},${l}]`,p]}))}}function Ri(t,e,s){switch(t){case"left":return{activeSource:"main",lazySource:s};case"right":return{activeSource:"joined",lazySource:e};case"inner":return e.size<s.size?{activeSource:"main",lazySource:s}:{activeSource:"joined",lazySource:e};default:return{activeSource:void 0,lazySource:void 0}}}import{groupBy as ar,map as cr,filter as Is,groupByOperators as Ti}from"@tanstack/db-ivm";var{sum:Pi,count:Ai,avg:Fi,min:Mi,max:Ki}=Ti;function Bi(t,e){let s=new Map,n=[...t];if(!e)return{selectToGroupByIndex:s,groupByExpressions:n};for(let[i,r]of Object.entries(e)){if(r.type==="agg")continue;let o=n.findIndex(a=>_s(r,a));if(o===-1)throw new ht(i);s.set(i,o)}return{selectToGroupByIndex:s,groupByExpressions:n}}function Ys(t,e,s,n,i){if(e.length===0){let u={};if(n){for(let[c,f]of Object.entries(n))if(f.type==="agg"){let h=f;u[c]=lr(h)}}let p=()=>({__singleGroup:!0});if(t=t.pipe(ar(p,u)),t=t.pipe(cr(([,c])=>{let h={...c.__select_results||{}};if(n)for(let[d,y]of Object.entries(n))y.type==="agg"&&(h[d]=c[d]);return["single_group",{...c,__select_results:h}]})),s&&s.length>0)for(let c of s){let f=es(c),h=Yt(f,n||{}),d=D(h);t=t.pipe(Is(([,y])=>{let g={result:y.__select_results};return d(g)}))}if(i&&i.length>0)for(let c of i)t=t.pipe(Is(([,f])=>{let h={result:f.__select_results};return c(h)}));return t}let r=Bi(e,n),o=e.map(u=>D(u)),a=([,u])=>{let p={...u};delete p.__select_results;let c={};for(let f=0;f<e.length;f++){let h=o[f],d=h(p);c[`__key_${f}`]=d}return c},l={};if(n){for(let[u,p]of Object.entries(n))if(p.type==="agg"){let c=p;l[u]=lr(c)}}if(t=t.pipe(ar(a,l)),t=t.pipe(cr(([,u])=>{let p=u.__select_results||{},c={};if(n)for(let[h,d]of Object.entries(n))if(d.type!=="agg"){let y=r.selectToGroupByIndex.get(h);y!==void 0?c[h]=u[`__key_${y}`]:c[h]=p[h]}else c[h]=u[h];else for(let h=0;h<e.length;h++)c[`__key_${h}`]=u[`__key_${h}`];let f;if(e.length===1)f=u.__key_0;else{let h=[];for(let d=0;d<e.length;d++)h.push(u[`__key_${d}`]);f=JSON.stringify(h)}return[f,{...u,__select_results:c}]})),s&&s.length>0)for(let u of s){let p=es(u),c=Yt(p,n||{}),f=D(c);t=t.pipe(Is(([,h])=>{let d={result:h.__select_results};return f(d)}))}if(i&&i.length>0)for(let u of i)t=t.pipe(Is(([,p])=>{let c={result:p.__select_results};return u(c)}));return t}function _s(t,e){if(!t||!e||t.type!==e.type)return!1;switch(t.type){case"ref":return!t.path||!e.path||t.path.length!==e.path.length?!1:t.path.every((s,n)=>s===e.path[n]);case"val":return t.value===e.value;case"func":return t.name===e.name&&t.args?.length===e.args?.length&&(t.args||[]).every((s,n)=>_s(s,e.args[n]));case"agg":return t.name===e.name&&t.args?.length===e.args?.length&&(t.args||[]).every((s,n)=>_s(s,e.args[n]));default:return!1}}function lr(t){let e=D(t.args[0]),s=([,r])=>{let o=e(r);return typeof o=="number"?o:o!=null?Number(o):0},n=([,r])=>{let o=e(r);return typeof o=="number"||o instanceof Date?o:o!=null?Number(o):0},i=([,r])=>e(r);switch(t.name.toLowerCase()){case"sum":return Pi(s);case"count":return Ai(i);case"avg":return Fi(s);case"min":return Mi(n);case"max":return Ki(n);default:throw new dt(t.name)}}function Yt(t,e,s="result"){switch(t.type){case"agg":{let n=t;for(let[i,r]of Object.entries(e))if(r.type==="agg"&&Di(n,r))return new P([s,i]);throw new ft(n.name)}case"func":{let n=t,i=n.args.map(r=>Yt(r,e));return new R(n.name,i)}case"ref":return t;case"val":return t;default:throw new pt(t.type)}}function Di(t,e){return t.name===e.name&&t.args.length===e.args.length&&t.args.every((s,n)=>_s(s,e.args[n]))}import{orderByWithFractionalIndex as zi}from"@tanstack/db-ivm";function ur(t,e,s,n,i,r,o,a,l){let u=s.map(d=>{let y=Yt(d.expression,n,"__select_results");return{compiledExpression:D(y),compareOptions:d.compareOptions}}),p=d=>{let y=d;return s.length>1?u.map(g=>g.compiledExpression(y)):s.length===1?u[0].compiledExpression(y):null},c=(d,y)=>{if(s.length>1){let g=d,x=y;for(let m=0;m<s.length;m++){let b=s[m],T=It(b.compareOptions)(g[m],x[m]);if(T!==0)return T}return g.length-x.length}if(s.length===1){let g=s[0];return It(g.compareOptions)(d,y)}return Vt(d,y)},f,h;if(a&&s.length===1){let d=s[0],y=d.expression;if(y.type==="ref"){let g=ie(t,y,i),x=g.collection,m=g.path[0];m&&ge(m,g.path,x,d.compareOptions,c);let b=D(new P(g.path),!0),C=(_,E)=>{let S=_&&b(_),v=E&&b(E);return c(S,v)},T=pe(x.indexes,g.path,d.compareOptions);T&&T.supports("gt")&&(h={alias:y.path.length>1?String(y.path[0]):t.from.alias,offset:l??0,limit:a,comparator:C,valueExtractorForRawRow:b,index:T,orderBy:s},r[x.id]=h,f=E=>{r[x.id]={...r[x.id],dataNeeded:()=>{let S=E();return Math.max(0,h.limit-S)}}})}}return e.pipe(zi(p,{limit:a,offset:l,comparator:c,setSizeCallback:f,setWindowFn:d=>{o(y=>{d(y),h&&(h.offset=y.offset??h.offset,h.limit=y.limit??h.limit)})}}))}import{map as Li}from"@tanstack/db-ivm";function Zs(t){return t instanceof K?t.value:t}function ji(t,e,s){let n=t.source(e);if(n&&typeof n=="object"){let i=s,r=t.targetPath;if(r.length===0)for(let[o,a]of Object.entries(n))s[o]=Zs(a);else for(let o=0;o<r.length;o++){let a=r[o];if(o===r.length-1){let l=i[a]??={};if(typeof l=="object")for(let[u,p]of Object.entries(n))l[u]=Zs(p)}else{let l=i[a];(l==null||typeof l!="object")&&(i[a]={}),i=i[a]}}}}function $i(t,e,s){let n=t.alias.split(".");if(n.length===1)s[t.alias]=t.compiled(e);else{let i=s;for(let r=0;r<n.length-1;r++){let o=n[r],a=i[o];(a==null||typeof a!="object")&&(i[o]={}),i=i[o]}i[n[n.length-1]]=Zs(t.compiled(e))}}function Ni([t,e],s){let n={};for(let i of s)i.kind==="merge"?ji(i,e,n):$i(i,e,n);return[t,{...e,__select_results:n}]}function hr(t,e,s){let n=[];return dr([],e,n),t.pipe(Li(i=>Ni(i,n)))}function Ui(t){return t.type==="agg"}function Wi(t){return t&&typeof t=="object"&&!Se(t)}function dr(t,e,s){for(let[n,i]of Object.entries(e)){if(n.startsWith("__SPREAD_SENTINEL__")){let o=n.slice(19),a=o.lastIndexOf("__"),l=a>=0?o.slice(0,a):o,u=i&&typeof i=="object"&&"type"in i&&i.type==="ref";if(l.includes(".")||u){let p=[...t],c=u?i:new P(l.split(".")),f=D(c);s.push({kind:"merge",targetPath:p,source:f})}else{let p=l,c=[...t];s.push({kind:"merge",targetPath:c,source:f=>f[p]})}continue}let r=i;if(Wi(r)){dr([...t,n],r,s);continue}if(Ui(r))s.push({kind:"field",alias:[...t,n].join("."),compiled:()=>null});else{if(r===void 0||!Se(r)){s.push({kind:"field",alias:[...t,n].join("."),compiled:()=>r});continue}if(r instanceof K){let o=r.value;s.push({kind:"field",alias:[...t,n].join("."),compiled:()=>o})}else s.push({kind:"field",alias:[...t,n].join("."),compiled:D(r)})}}}function Lt(t,e,s,n,i,r,o,a,l=new WeakMap,u=new WeakMap){let p=l.get(t);if(p)return p;let{optimizedQuery:c,sourceWhereClauses:f}=Xn(t);u.set(c,t),tn(c,t,u);let h={...e},d={},y={},g={},{alias:x,input:m,collectionId:b}=qi(c.from,h,s,n,i,r,o,a,l,u,d,y);g[x]=m;let C=m.pipe(zt(([S,v])=>[S,{[x]:v}]));if(c.join&&c.join.length>0&&(C=or(C,c.join,g,b,x,h,l,u,s,n,i,r,o,a,t,Lt,d,y)),c.where&&c.where.length>0)for(let S of c.where){let v=Wt(S),w=D(v);C=C.pipe(Xs(([O,F])=>w(F)))}if(c.fnWhere&&c.fnWhere.length>0)for(let S of c.fnWhere)C=C.pipe(Xs(([v,w])=>S(w)));if(c.distinct&&!c.fnSelect&&!c.select)throw new Ye;if(c.fnSelect?C=C.pipe(zt(([S,v])=>{let w=c.fnSelect(v);return[S,{...v,__select_results:w}]})):c.select?C=hr(C,c.select):C=C.pipe(zt(([S,v])=>{let w=!c.join&&!c.groupBy?v[x]:v;return[S,{...v,__select_results:w}]})),c.groupBy&&c.groupBy.length>0?C=Ys(C,c.groupBy,c.having,c.select,c.fnHaving):c.select&&Object.values(c.select).some(v=>v.type==="agg")&&(C=Ys(C,[],c.having,c.select,c.fnHaving)),c.having&&(!c.groupBy||c.groupBy.length===0)&&!(c.select?Object.values(c.select).some(v=>v.type==="agg"):!1))throw new Ze;if(c.fnHaving&&c.fnHaving.length>0&&(!c.groupBy||c.groupBy.length===0))for(let S of c.fnHaving)C=C.pipe(Xs(([v,w])=>S(w)));if(c.distinct&&(C=C.pipe(Vi(([S,v])=>v.__select_results))),c.orderBy&&c.orderBy.length>0){let w=ur(t,C,c.orderBy,c.select||{},s[b],o,a,c.limit,c.offset).pipe(zt(([F,[H,q]])=>{let jt=H.__select_results,$t=en(jt);return[F,[$t,q]]})),O={collectionId:b,pipeline:w,sourceWhereClauses:f,aliasToCollectionId:d,aliasRemapping:y};return l.set(t,O),O}else if(c.limit!==void 0||c.offset!==void 0)throw new Xe;let _=C.pipe(zt(([S,v])=>{let w=v.__select_results,O=en(w);return[S,[O,void 0]]})),E={collectionId:b,pipeline:_,sourceWhereClauses:f,aliasToCollectionId:d,aliasRemapping:y};return l.set(t,E),E}function qi(t,e,s,n,i,r,o,a,l,u,p,c){switch(t.type){case"collectionRef":{let f=e[t.alias];if(!f)throw new te(t.alias,t.collection.id,Object.keys(e));return p[t.alias]=t.collection.id,{alias:t.alias,input:f,collectionId:t.collection.id}}case"queryRef":{let f=u.get(t.query)||t.query,h=Lt(f,e,s,n,i,r,o,a,l,u);Object.assign(p,h.aliasToCollectionId),Object.assign(c,h.aliasRemapping);let d=Object.keys(h.aliasToCollectionId).find(x=>h.aliasToCollectionId[x]===h.collectionId);d&&d!==t.alias&&(c[t.alias]=d);let g=h.pipeline.pipe(zt(x=>{let[m,[b,C]]=x,T=en(b);return[m,T]}));return{alias:t.alias,input:g,collectionId:h.collectionId}}default:throw new et(t.type)}}function Qi(t){return t instanceof K||t&&typeof t=="object"&&"type"in t&&t.type==="val"}function en(t){return Qi(t)?t.value:t}function tn(t,e,s){if(t.from.type==="queryRef"&&e.from.type==="queryRef"&&(s.set(t.from.query,e.from.query),tn(t.from.query,e.from.query,s)),t.join&&e.join)for(let n=0;n<t.join.length&&n<e.join.length;n++){let i=t.join[n],r=e.join[n];i.from.type==="queryRef"&&r.from.type==="queryRef"&&(s.set(i.from.query,r.from.query),tn(i.from.query,r.from.query,s))}}import{D2 as Xi,output as eo}from"@tanstack/db-ivm";import{MultiSet as Gi}from"@tanstack/db-ivm";var fr=Symbol.for("@tanstack/db.collection-config-builder"),Os=class{constructor(e,s,n,i){this.alias=e,this.collectionId=s,this.collection=n,this.collectionConfigBuilder=i,this.biggest=void 0,this.subscriptionLoadingPromises=new Map}subscribe(){let e=this.getWhereClauseForAlias();if(e){let s=Cs(e,this.alias);if(s)return this.subscribeToChanges(s);throw new bt(this.collectionId,this.alias)}return this.subscribeToChanges()}subscribeToChanges(e){let s,n=this.getOrderByInfo();if(n)s=this.subscribeToOrderedChanges(e,n);else{let o=!this.collectionConfigBuilder.isLazyAlias(this.alias);s=this.subscribeToMatchingChanges(e,o)}let i=s.on("status:change",o=>{if(o.status==="loadingSubset"){if(!this.subscriptionLoadingPromises.has(s)){let a,l=new Promise(u=>{a=u});this.subscriptionLoadingPromises.set(s,{resolve:a}),this.collectionConfigBuilder.liveQueryCollection._sync.trackLoadPromise(l)}}else{let a=this.subscriptionLoadingPromises.get(s);a&&(this.subscriptionLoadingPromises.delete(s),a.resolve())}}),r=()=>{let o=this.subscriptionLoadingPromises.get(s);o&&(this.subscriptionLoadingPromises.delete(s),o.resolve()),i(),s.unsubscribe()};return this.collectionConfigBuilder.currentSyncState.unsubscribeCallbacks.add(r),s}sendChangesToPipeline(e,s){let n=this.collectionConfigBuilder.currentSyncState.inputs[this.alias],r=Hi(n,e,this.collection.config.getKey)>0?s:void 0;this.collectionConfigBuilder.scheduleGraphRun(r,{alias:this.alias})}subscribeToMatchingChanges(e,s=!1){let n=r=>{this.sendChangesToPipeline(r)};return this.collection.subscribeChanges(n,{includeInitialState:s,whereExpression:e})}subscribeToOrderedChanges(e,s){let{orderBy:n,offset:i,limit:r,comparator:o,dataNeeded:a,index:l}=s,u=f=>{let h=Ji(f),d=h;a&&a()===0&&(d=Zi(h,o,this.biggest)),this.sendChangesToPipelineWithTracking(d,p)},p=this.collection.subscribeChanges(u,{whereExpression:e});p.setOrderByIndex(l);let c=qs(n,this.alias);return p.requestLimitedSnapshot({limit:i+r,orderBy:c}),p}loadMoreIfNeeded(e){let s=this.getOrderByInfo();if(!s)return!0;let{dataNeeded:n}=s;if(!n)throw new Error(`Missing dataNeeded callback for collection ${this.collectionId}`);let i=n();return i>0&&this.loadNextItems(i,e),!0}sendChangesToPipelineWithTracking(e,s){let n=this.getOrderByInfo();if(!n){this.sendChangesToPipeline(e);return}let i=this.trackSentValues(e,n.comparator),r=s;r[fr]??=this.loadMoreIfNeeded.bind(this,s),this.sendChangesToPipeline(i,r[fr])}loadNextItems(e,s){let n=this.getOrderByInfo();if(!n)return;let{orderBy:i,valueExtractorForRawRow:r}=n,o=this.biggest,a=o&&r(o),l=qs(i,this.alias);s.requestLimitedSnapshot({orderBy:l,limit:e,minValue:a})}getWhereClauseForAlias(){let e=this.collectionConfigBuilder.sourceWhereClausesCache;if(e)return e.get(this.alias)}getOrderByInfo(){let e=this.collectionConfigBuilder.optimizableOrderByCollections[this.collectionId];if(e&&e.alias===this.alias)return e}*trackSentValues(e,s){for(let n of e)this.biggest?s(this.biggest,n.value)<0&&(this.biggest=n.value):this.biggest=n.value,yield n}};function Hi(t,e,s){let n=[];for(let i of e){let r=s(i.value);i.type==="insert"?n.push([[r,i.value],1]):i.type==="update"?(n.push([[r,i.previousValue],-1]),n.push([[r,i.value],1])):n.push([[r,i.value],-1])}return n.length!==0&&t.sendData(new Gi(n)),n.length}function*Ji(t){for(let e of t)e.type==="update"?(yield{type:"delete",key:e.key,value:e.previousValue},yield{type:"insert",key:e.key,value:e.value}):yield e}function*Yi(t,e){for(let s of t)e(s)&&(yield s)}function*Zi(t,e,s){yield*Yi(t,n=>!s||e(n.value,s)<=0)}var pr=new WeakMap;function yr(t){return t.utils?.getBuilder?.()}function gr(t,e){pr.set(t,e)}function mr(t){return pr.get(t)}var to=0,Rs=class{constructor(e){this.config=e,this.compiledAliasToCollectionId={},this.resultKeys=new WeakMap,this.orderByIndices=new WeakMap,this.isGraphRunning=!1,this.runCount=0,this.isInErrorState=!1,this.aliasDependencies={},this.builderDependencies=new Set,this.pendingGraphRuns=new Map,this.subscriptions={},this.lazySourcesCallbacks={},this.lazySources=new Set,this.optimizableOrderByCollections={},this.id=e.id||`live-query-${++to}`,this.query=so(e),this.collections=ro(this.query);let s=io(this.query);this.collectionByAlias={};for(let[n,i]of s.entries()){let r=this.collections[n];if(r)for(let o of i)this.collectionByAlias[o]=r}this.query.orderBy&&this.query.orderBy.length>0&&(this.compare=no(this.orderByIndices)),this.compileBasePipeline()}getConfig(){return{id:this.id,getKey:this.config.getKey||(e=>this.resultKeys.get(e)),sync:this.getSyncConfig(),compare:this.compare,gcTime:this.config.gcTime||5e3,schema:this.config.schema,onInsert:this.config.onInsert,onUpdate:this.config.onUpdate,onDelete:this.config.onDelete,startSync:this.config.startSync,singleResult:this.query.singleResult,utils:{getRunCount:this.getRunCount.bind(this),getBuilder:()=>this,setWindow:this.setWindow.bind(this),getWindow:this.getWindow.bind(this)}}}setWindow(e){if(!this.windowFn)throw new Et;return this.currentWindow=e,this.windowFn(e),this.maybeRunGraphFn?.(),this.liveQueryCollection?.isLoadingSubset?new Promise(s=>{let n=this.liveQueryCollection.on("loadingSubset:change",i=>{i.isLoadingSubset||(n(),s())})}):!0}getWindow(){if(!(!this.windowFn||!this.currentWindow))return{offset:this.currentWindow.offset??0,limit:this.currentWindow.limit??0}}getCollectionIdForAlias(e){let s=this.compiledAliasToCollectionId[e];if(s)return s;let n=this.collectionByAlias[e];if(n)return n.id;throw new Error(`Unknown source alias "${e}"`)}isLazyAlias(e){return this.lazySources.has(e)}maybeRunGraph(e){if(!this.isGraphRunning){if(!this.currentSyncConfig||!this.currentSyncState)throw new Error("maybeRunGraph called without active sync session. This should not happen.");this.isGraphRunning=!0;try{let{begin:s,commit:n}=this.currentSyncConfig,i=this.currentSyncState;if(this.isInErrorState)return;if(i.subscribedToAllCollections){for(;i.graph.pendingWork();)i.graph.run(),e?.();i.messagesCount===0&&(s(),n(),this.updateLiveQueryStatus(this.currentSyncConfig))}}finally{this.isGraphRunning=!1}}}scheduleGraphRun(e,s){let n=s?.contextId??ne()?.id,i=s?.jobId??this,r=(()=>{if(s?.dependencies)return s.dependencies;let l=new Set(this.builderDependencies);if(s?.alias){let u=this.aliasDependencies[s.alias];if(u)for(let p of u)l.add(p)}return l.delete(this),Array.from(l)})();if(!this.currentSyncConfig||!this.currentSyncState)throw new Error("scheduleGraphRun called without active sync session. This should not happen.");let o=n?this.pendingGraphRuns.get(n):void 0;o||(o={loadCallbacks:new Set},n&&this.pendingGraphRuns.set(n,o)),e&&o.loadCallbacks.add(e);let a=n?void 0:o;Ft.schedule({contextId:n,jobId:i,dependencies:r,run:()=>this.executeGraphRun(n,a)})}clearPendingGraphRun(e){this.pendingGraphRuns.delete(e)}executeGraphRun(e,s){let n=s??(e?this.pendingGraphRuns.get(e):void 0);if(e&&this.pendingGraphRuns.delete(e),!n||!this.currentSyncConfig||!this.currentSyncState)return;this.incrementRunCount();let i=()=>{let r=!0,o;if(n.loadCallbacks.forEach(a=>{try{r=a()&&r}catch(l){r=!1,o??=l}}),o)throw o;return r};this.maybeRunGraph(i)}getSyncConfig(){return{rowUpdateMode:"full",sync:this.syncFn.bind(this)}}incrementRunCount(){this.runCount++}getRunCount(){return this.runCount}syncFn(e){this.liveQueryCollection=e.collection,this.currentSyncConfig=e;let s={messagesCount:0,subscribedToAllCollections:!1,unsubscribeCallbacks:new Set},n=this.extendPipelineWithChangeProcessing(e,s);this.currentSyncState=n,this.unsubscribeFromSchedulerClears=Ft.onClear(r=>{this.clearPendingGraphRun(r)});let i=this.subscribeToAllCollections(e,n);return this.maybeRunGraphFn=()=>this.scheduleGraphRun(i),this.scheduleGraphRun(i),()=>{s.unsubscribeCallbacks.forEach(r=>r()),this.currentSyncConfig=void 0,this.currentSyncState=void 0,this.pendingGraphRuns.clear(),this.graphCache=void 0,this.inputsCache=void 0,this.pipelineCache=void 0,this.sourceWhereClausesCache=void 0,this.lazySources.clear(),this.optimizableOrderByCollections={},this.lazySourcesCallbacks={},Object.keys(this.subscriptions).forEach(r=>delete this.subscriptions[r]),this.compiledAliasToCollectionId={},this.unsubscribeFromSchedulerClears?.(),this.unsubscribeFromSchedulerClears=void 0}}compileBasePipeline(){this.graphCache=new Xi,this.inputsCache=Object.fromEntries(Object.keys(this.collectionByAlias).map(n=>[n,this.graphCache.newInput()]));let e=Lt(this.query,this.inputsCache,this.collections,this.subscriptions,this.lazySourcesCallbacks,this.lazySources,this.optimizableOrderByCollections,n=>{this.windowFn=n});this.pipelineCache=e.pipeline,this.sourceWhereClausesCache=e.sourceWhereClauses,this.compiledAliasToCollectionId=e.aliasToCollectionId;let s=Object.keys(this.compiledAliasToCollectionId).filter(n=>!Object.hasOwn(this.inputsCache,n));if(s.length>0)throw new Ct(s)}maybeCompileBasePipeline(){return(!this.graphCache||!this.inputsCache||!this.pipelineCache)&&this.compileBasePipeline(),{graph:this.graphCache,inputs:this.inputsCache,pipeline:this.pipelineCache}}extendPipelineWithChangeProcessing(e,s){let{begin:n,commit:i}=e,{graph:r,inputs:o,pipeline:a}=this.maybeCompileBasePipeline();return a.pipe(eo(l=>{let u=l.getInner();s.messagesCount+=u.length,n(),u.reduce(oo,new Map).forEach(this.applyChanges.bind(this,e)),i()})),r.finalize(),s.graph=r,s.inputs=o,s.pipeline=a,s}applyChanges(e,s,n){let{write:i,collection:r}=e,{deletes:o,inserts:a,value:l,orderByIndex:u}=s;if(this.resultKeys.set(l,n),u!==void 0&&this.orderByIndices.set(l,u),a&&o===0)i({value:l,type:"insert"});else if(a>o||a===o&&r.has(r.getKeyFromItem(l)))i({value:l,type:"update"});else if(o>0)i({value:l,type:"delete"});else throw new Error(`Could not apply changes: ${JSON.stringify(s)}. This should never happen.`)}handleSourceStatusChange(e,s,n){let{status:i}=n;if(i==="error"){this.transitionToError(`Source collection '${s}' entered error state`);return}if(i==="cleaned-up"){this.transitionToError(`Source collection '${s}' was manually cleaned up while live query '${this.id}' depends on it. Live queries prevent automatic GC, so this was likely a manual cleanup() call.`);return}this.updateLiveQueryStatus(e)}updateLiveQueryStatus(e){let{markReady:s}=e;this.isInErrorState||this.allCollectionsReady()&&s()}transitionToError(e){this.isInErrorState=!0,console.error(`[Live Query Error] ${e}`),this.liveQueryCollection?._lifecycle.setStatus("error")}allCollectionsReady(){return Object.values(this.collections).every(e=>e.isReady())}subscribeToAllCollections(e,s){let n=Object.entries(this.compiledAliasToCollectionId);if(n.length===0)throw new Error(`Compiler returned no alias metadata for query '${this.id}'. This should not happen; please report.`);let i=n.map(([o,a])=>{let l=this.collectionByAlias[o]??this.collections[a],u=mr(l);u&&u!==this?(this.aliasDependencies[o]=[u],this.builderDependencies.add(u)):this.aliasDependencies[o]=[];let p=new Os(o,a,l,this),c=l.on("status:change",d=>{this.handleSourceStatusChange(e,a,d)});s.unsubscribeCallbacks.add(c);let f=p.subscribe();return this.subscriptions[o]=f,p.loadMoreIfNeeded.bind(p,f)}),r=()=>(i.map(o=>o()),!0);return s.subscribedToAllCollections=!0,this.updateLiveQueryStatus(e),r}};function so(t){return typeof t.query=="function"?Gn(t.query):Ws(t.query)}function no(t){return(e,s)=>{let n=t.get(e),i=t.get(s);return n&&i?n<i?-1:n>i?1:0:0}}function ro(t){let e={};function s(i){i.type==="collectionRef"?e[i.collection.id]=i.collection:i.type==="queryRef"&&n(i.query)}function n(i){if(i.from&&s(i.from),i.join&&Array.isArray(i.join))for(let r of i.join)r.from&&s(r.from)}return n(t),e}function io(t){let e=new Map;function s(i){if(i)if(i.type==="collectionRef"){let{id:r}=i.collection,o=e.get(r);o?o.add(i.alias):e.set(r,new Set([i.alias]))}else i.type==="queryRef"&&n(i.query)}function n(i){if(i&&(s(i.from),i.join))for(let r of i.join)s(r.from)}return n(t),e}function oo(t,[[e,s],n]){let[i,r]=s,o=t.get(e)||{deletes:0,inserts:0,value:i,orderByIndex:r};return n<0?o.deletes+=Math.abs(n):n>0&&(o.inserts+=n,o.value=i,o.orderByIndex=r),t.set(e,o),t}function Ts(t){return new Rs(t).getConfig()}function wr(t){if(typeof t=="function"){let s=Ts({query:t});return vr(s)}else{let e=t,s=Ts(e);return e.utils&&(s.utils={...s.utils,...e.utils}),vr(s)}}function vr(t){let e=ks(t),s=yr(t);return s&&gr(e,s),e}console.log(Object.keys(sn).length);
